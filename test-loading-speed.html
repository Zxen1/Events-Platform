<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FunMap Loading Speed Test</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background: #1a1a2e;
      color: #eee;
    }
    h1 { color: #00d4ff; margin-bottom: 5px; }
    h2 { color: #ff6b6b; margin-top: 30px; }
    .subtitle { color: #888; margin-bottom: 30px; }
    button {
      background: #00d4ff;
      color: #1a1a2e;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      margin: 5px;
      font-weight: bold;
    }
    button:hover { background: #00b8e6; }
    button:disabled { background: #555; color: #888; cursor: not-allowed; }
    button.danger { background: #ff6b6b; }
    button.danger:hover { background: #ff5252; }
    button.success { background: #4caf50; }
    button.success:hover { background: #45a049; }
    .result {
      background: #2a2a4a;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      border-left: 4px solid #00d4ff;
    }
    .result.success { border-left-color: #4caf50; }
    .result.warning { border-left-color: #ff9800; }
    .result.error { border-left-color: #ff6b6b; }
    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .result-name { font-weight: bold; color: #00d4ff; }
    .result-time { 
      font-size: 24px; 
      font-weight: bold;
    }
    .result-time.fast { color: #4caf50; }
    .result-time.medium { color: #ff9800; }
    .result-time.slow { color: #ff6b6b; }
    .result-details { color: #aaa; font-size: 14px; }
    .storage-info {
      background: #2a2a4a;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
    }
    .storage-item {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid #3a3a5a;
    }
    .storage-item:last-child { border-bottom: none; }
    .storage-key { color: #00d4ff; font-family: monospace; }
    .storage-value { color: #888; max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    #log {
      background: #111;
      color: #0f0;
      font-family: monospace;
      padding: 15px;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      margin: 20px 0;
      font-size: 13px;
    }
    .log-entry { margin: 3px 0; }
    .log-time { color: #888; }
    .log-warn { color: #ff9800; }
    .log-error { color: #ff6b6b; }
    .log-success { color: #4caf50; }
    .section { margin: 30px 0; }
    .summary {
      background: linear-gradient(135deg, #2a2a4a, #1a1a2e);
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      border: 2px solid #00d4ff;
    }
    .summary h3 { color: #00d4ff; margin-top: 0; }
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .summary-item {
      text-align: center;
      padding: 15px;
      background: #1a1a2e;
      border-radius: 8px;
    }
    .summary-label { color: #888; font-size: 12px; text-transform: uppercase; }
    .summary-value { font-size: 28px; font-weight: bold; margin-top: 5px; }
  </style>
</head>
<body>
  <h1>üöÄ FunMap Loading Speed Test</h1>
  <p class="subtitle">Test loading performance after clearing cache and localStorage</p>

  <div class="section">
    <h2>üì¶ LocalStorage Status</h2>
    <div id="storage-info" class="storage-info">Loading...</div>
    <button class="danger" onclick="clearLocalStorage()">üóëÔ∏è Clear All LocalStorage</button>
    <button onclick="showStorageItems()">üîç Show All Items</button>
  </div>

  <div class="section">
    <h2>‚ö° API Loading Tests</h2>
    <p>Tests each API endpoint to identify bottlenecks:</p>
    <button class="success" onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
    <button onclick="runSingleTest('get-admin-settings')">Test Admin Settings</button>
    <button onclick="runSingleTest('get-form')">Test Form Data</button>
    
    <div id="results"></div>
  </div>

  <div class="section">
    <h2>üìä Summary</h2>
    <div id="summary" class="summary" style="display:none;">
      <h3>Test Results</h3>
      <div class="summary-grid" id="summary-grid"></div>
    </div>
  </div>

  <div class="section">
    <h2>üìã Log</h2>
    <div id="log"></div>
    <button onclick="document.getElementById('log').innerHTML = ''">Clear Log</button>
  </div>

  <script>
    const log = (msg, type = '') => {
      const logDiv = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      const cls = type ? `log-${type}` : '';
      logDiv.innerHTML += `<div class="log-entry"><span class="log-time">[${time}]</span> <span class="${cls}">${msg}</span></div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    };

    const formatTime = (ms) => {
      if (ms < 1000) return `${Math.round(ms)}ms`;
      return `${(ms / 1000).toFixed(2)}s`;
    };

    const getTimeClass = (ms) => {
      if (ms < 500) return 'fast';
      if (ms < 2000) return 'medium';
      return 'slow';
    };

    const getResultClass = (ms) => {
      if (ms < 500) return 'success';
      if (ms < 2000) return 'warning';
      return 'error';
    };

    // Show localStorage summary
    function updateStorageInfo() {
      const keys = Object.keys(localStorage);
      const totalSize = keys.reduce((acc, key) => acc + localStorage.getItem(key).length, 0);
      const sizeKB = (totalSize / 1024).toFixed(2);
      
      document.getElementById('storage-info').innerHTML = `
        <div class="storage-item">
          <span>Total Items:</span>
          <span><strong>${keys.length}</strong></span>
        </div>
        <div class="storage-item">
          <span>Total Size:</span>
          <span><strong>${sizeKB} KB</strong></span>
        </div>
        <div class="storage-item">
          <span>Has Visited:</span>
          <span>${localStorage.getItem('hasVisited') || 'No'}</span>
        </div>
        <div class="storage-item">
          <span>Welcome Seen:</span>
          <span>${localStorage.getItem('welcome-seen') || 'No'}</span>
        </div>
        <div class="storage-item">
          <span>Mode:</span>
          <span>${localStorage.getItem('mode') || 'Not set'}</span>
        </div>
      `;
    }

    function showStorageItems() {
      const keys = Object.keys(localStorage).sort();
      let html = '';
      keys.forEach(key => {
        const value = localStorage.getItem(key);
        const shortValue = value.length > 50 ? value.substring(0, 50) + '...' : value;
        html += `<div class="storage-item">
          <span class="storage-key">${key}</span>
          <span class="storage-value" title="${value}">${shortValue}</span>
        </div>`;
      });
      document.getElementById('storage-info').innerHTML = html || '<em>No items in localStorage</em>';
    }

    function clearLocalStorage() {
      const count = Object.keys(localStorage).length;
      if (confirm(`Clear all ${count} localStorage items?`)) {
        localStorage.clear();
        log(`Cleared ${count} localStorage items`, 'success');
        updateStorageInfo();
      }
    }

    // API Testing
    const testResults = {};

    async function runSingleTest(action, showResult = true) {
      const resultsDiv = document.getElementById('results');
      
      log(`Testing: /gateway.php?action=${action}...`);
      
      const startTime = performance.now();
      
      try {
        // Add cache-busting parameter
        const url = `/gateway.php?action=${action}&_t=${Date.now()}`;
        
        const response = await fetch(url, {
          method: 'GET',
          headers: { 'Accept': 'application/json' },
          cache: 'no-store'
        });
        
        const endTime = performance.now();
        const duration = endTime - startTime;
        
        const text = await response.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch (e) {
          data = { parseError: true };
        }
        
        const size = new Blob([text]).size;
        const sizeKB = (size / 1024).toFixed(2);
        
        testResults[action] = { duration, size, success: response.ok && data.success };
        
        const timeClass = getTimeClass(duration);
        const resultClass = getResultClass(duration);
        
        log(`‚úì ${action}: ${formatTime(duration)} (${sizeKB} KB)`, duration < 2000 ? 'success' : 'warn');
        
        if (showResult) {
          const resultHTML = `
            <div class="result ${resultClass}">
              <div class="result-header">
                <span class="result-name">${action}</span>
                <span class="result-time ${timeClass}">${formatTime(duration)}</span>
              </div>
              <div class="result-details">
                Response size: ${sizeKB} KB | 
                HTTP ${response.status} | 
                Success: ${data.success ? '‚úì' : '‚úó'}
              </div>
            </div>
          `;
          resultsDiv.innerHTML += resultHTML;
        }
        
        return { action, duration, size, success: true, data };
        
      } catch (error) {
        const endTime = performance.now();
        const duration = endTime - startTime;
        
        log(`‚úó ${action}: ${error.message}`, 'error');
        
        testResults[action] = { duration, size: 0, success: false, error: error.message };
        
        if (showResult) {
          resultsDiv.innerHTML += `
            <div class="result error">
              <div class="result-header">
                <span class="result-name">${action}</span>
                <span class="result-time slow">ERROR</span>
              </div>
              <div class="result-details">${error.message}</div>
            </div>
          `;
        }
        
        return { action, duration, size: 0, success: false, error };
      }
    }

    async function runAllTests() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '<p>Running tests...</p>';
      
      log('=== Starting All API Tests ===', 'success');
      
      const tests = [
        'get-admin-settings',
        'get-form'
      ];
      
      const allResults = [];
      
      for (const test of tests) {
        const result = await runSingleTest(test, false);
        allResults.push(result);
      }
      
      // Display all results
      resultsDiv.innerHTML = '';
      allResults.forEach(result => {
        const timeClass = getTimeClass(result.duration);
        const resultClass = getResultClass(result.duration);
        const sizeKB = (result.size / 1024).toFixed(2);
        
        resultsDiv.innerHTML += `
          <div class="result ${resultClass}">
            <div class="result-header">
              <span class="result-name">${result.action}</span>
              <span class="result-time ${timeClass}">${formatTime(result.duration)}</span>
            </div>
            <div class="result-details">
              Response size: ${sizeKB} KB | 
              Success: ${result.success ? '‚úì' : '‚úó'}
            </div>
          </div>
        `;
      });
      
      // Show summary
      const totalTime = allResults.reduce((acc, r) => acc + r.duration, 0);
      const totalSize = allResults.reduce((acc, r) => acc + r.size, 0);
      const slowest = allResults.reduce((a, b) => a.duration > b.duration ? a : b);
      
      const summaryDiv = document.getElementById('summary');
      const summaryGrid = document.getElementById('summary-grid');
      
      summaryGrid.innerHTML = `
        <div class="summary-item">
          <div class="summary-label">Total API Time</div>
          <div class="summary-value ${getTimeClass(totalTime)}">${formatTime(totalTime)}</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Total Data Size</div>
          <div class="summary-value">${(totalSize / 1024).toFixed(1)} KB</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Slowest Endpoint</div>
          <div class="summary-value ${getTimeClass(slowest.duration)}">${slowest.action}</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">LocalStorage Items</div>
          <div class="summary-value">${Object.keys(localStorage).length}</div>
        </div>
      `;
      
      summaryDiv.style.display = 'block';
      
      log(`=== All Tests Complete: ${formatTime(totalTime)} total ===`, 'success');
    }

    // Initialize
    updateStorageInfo();
    log('Test page loaded. Click "Run All Tests" to measure API loading times.');
  </script>
</body>
</html>

