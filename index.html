<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Events Platform</title>
  <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
  <link rel="manifest" href="/favicons/site.webmanifest">
  <link rel="shortcut icon" href="/favicons/favicon.ico">
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <style>
    :root {
      --color-header: navy;
      --color-footer: #000;
      --color-background: #fff;
      --color-text: #000;
      --scrollbar-thumb: #888;
    }
    body {
      font-family: Verdana, sans-serif;
      font-size: 14px;
      margin: 0;
      padding-top: 80px;
      color: var(--color-text);
      background: var(--color-background);
      scrollbar-gutter: stable both-edges;
    }
    * {
      scrollbar-width: thin;
      scrollbar-color: var(--scrollbar-thumb) transparent;
    }
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background-color: var(--scrollbar-thumb);
      border-radius: 5px;
      border: 3px solid transparent;
      background-clip: content-box;
    }
    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 80px;
      background: var(--color-header);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    header button {
      position: absolute;
      top: 0;
      width: 80px;
      height: 80px;
      background: transparent;
      border: none;
      cursor: pointer;
    }
    #filter-button { left: 0; }
    #list-button { left: 80px; }
    #posts-button { left: 160px; }
    #settings-button { right: 0; }
    #admin-button { right: 80px; }
    #member-button { right: 160px; }
    #header-logo {
      height: 60px;
      cursor: pointer;
    }
    #map {
      position: absolute;
      top: 80px;
      bottom: 80px;
      width: 100%;
    }
    #fullscreen-button {
      position: absolute;
      right: 0;
      top: 80px;
      width: 80px;
      height: 80px;
      background: transparent;
      border: none;
      cursor: pointer;
      z-index: 1001;
    }
    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 80px;
      background: rgba(0, 0, 0, 0.5);
      padding: 10px;
      display: flex;
      align-items: center;
      overflow: hidden;
      z-index: 1000;
    }
    #recent-posts-container {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      height: 60px;
      width: 100%;
    }
    .recent-post-card {
      flex: 0 0 auto;
      height: 60px;
      display: flex;
      align-items: center;
      background: #fff;
      color: #000;
      padding: 0 5px;
      border-radius: 4px;
    }
    .recent-post-card img {
      height: 100%;
      width: auto;
      margin-right: 5px;
    }
    .recent-post-card .star {
      margin-left: auto;
    }
      #welcome-modal {
        width: 600px;
        margin: 0 auto;
        background: var(--color-background);
        color: var(--color-text);
        border: 1px solid #ccc;
        padding: 20px;
        box-shadow: 0 0 10px rgba(0,0,0,0.2);
      }
      .panel {
        position: absolute;
        top: 80px;
        left: 0;
        width: 420px;
        height: calc(100vh - 160px);
        background: #333;
        color: #fff;
        padding: 10px;
        box-sizing: border-box;
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transition: opacity 0.3s ease;
        z-index: 1002;
      }
      .panel.active {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
      }
      #member-panel {
        left: auto;
        right: 0;
      }
      #admin-panel {
        left: auto;
        right: 0;
      }
      #settings-panel {
        left: auto;
        right: 0;
      }
      .member-row {
        width: 400px;
        height: 40px;
        margin-bottom: 10px;
        background: #444;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 0 5px;
        box-sizing: border-box;
      }
      .panel-header {
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-family: Verdana, sans-serif;
        font-size: 24px;
        cursor: move;
      }
      .panel-header button {
        background: transparent;
        border: none;
        color: #fff;
        cursor: pointer;
        font-size: 24px;
      }
      .hidden {
        display: none;
      }
      #filter-panel { overflow-y: auto; }
      #sort-menu { margin-bottom: 10px; }
      #sort-menu-button {
        width: 100%;
        background: #444;
        color: #fff;
        border: none;
        padding: 8px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .menu-arrow { transition: transform 0.3s ease; }
      #sort-menu.open .menu-arrow { transform: rotate(180deg); }
      #sort-menu-items {
        list-style: none;
        margin: 0;
        padding: 0;
        background: #555;
        display: none;
      }
      #sort-menu.open #sort-menu-items { display: block; }
      #sort-menu-items li { padding: 5px; cursor: pointer; }
      #sort-menu-items li:hover { background: #666; }
      #map-controls-row {
        display: flex;
        gap: 5px;
        margin-bottom: 10px;
      }
      #map-controls-row input { flex: 1; }
      #map-controls-row button {
        background: #444;
        border: none;
        color: #fff;
        padding: 0 8px;
        cursor: pointer;
      }
      #filter-message { margin-bottom: 10px; min-height: 20px; }
      .row { display: flex; align-items: center; margin-bottom: 10px; }
      .row input[type="text"], .row input[type="date"] { flex: 1; }
      .clear-btn {
        margin-left: 5px;
        background: #444;
        border: none;
        color: #fff;
        cursor: pointer;
      }
      .clear-btn.active { background: red; }
      #expired-events-row label { display: flex; align-items: center; gap: 5px; }
      #filter-calendar-container {
        width: 400px;
        height: 200px;
        overflow-x: auto;
        background: #222;
        margin-bottom: 10px;
      }
      #calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        grid-auto-rows: 1fr;
        width: 800px;
      }
      .calendar-day {
        border: 1px solid #444;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #filter-categories-container {
        max-height: 200px;
        overflow-y: auto;
        margin-bottom: 10px;
      }
      .filter-category-row { border-top: 1px solid #444; }
      .filter-category-row button.category-toggle {
        width: 100%;
        text-align: left;
        background: #444;
        color: #fff;
        border: none;
        padding: 5px;
        cursor: pointer;
      }
      .subcategory-list { display: none; padding-left: 10px; }
      .filter-category-row.open .subcategory-list { display: block; }
      .subcategory-list label { display: flex; align-items: center; gap: 5px; padding: 2px 0; }
      #filter-reset-button {
        width: 100%;
        padding: 10px;
        background: #444;
        color: #fff;
        border: none;
        cursor: pointer;
      }
      #filter-reset-button.active { background: red; }
      #filter-button.active { background: red; }

      #admin-panel .tab-header {
        display: flex;
        gap: 5px;
        margin-bottom: 10px;
      }
      #admin-panel .tab-header button {
        flex: 1;
        background: #444;
        border: none;
        color: #fff;
        cursor: pointer;
        padding: 6px;
      }
      #admin-panel .tab-header button.active {
        background: #666;
      }
      #admin-panel .tab-content { display: none; }
      #admin-panel .tab-content.active { display: block; }
      #formbuilder-container .form-category { margin-bottom: 10px; }
      #formbuilder-container .category-toggle {
        width: 100%;
        text-align: left;
        background: #444;
        border: none;
        color: #fff;
        padding: 5px;
        cursor: pointer;
      }
      #formbuilder-container .subcategory-menu { display: none; padding-left: 10px; }
      #formbuilder-container .form-category.open .subcategory-menu { display: block; }
      #formbuilder-container .field {
        display: flex;
        align-items: center;
        gap: 5px;
        background: #555;
        padding: 5px;
        margin-bottom: 5px;
        cursor: move;
      }
      #formbuilder-container .delete-field {
        margin-left: auto;
        background: #666;
        border: none;
        color: #fff;
        cursor: pointer;
      }
      #list-panel {
        width: 520px;
        background: rgba(0,0,0,0.5);
        overflow-y: auto;
      }
      .list-card {
        width: 500px;
        padding: 10px;
        margin: 0 auto 10px;
        background: #444;
        display: flex;
        gap: 10px;
        box-sizing: border-box;
        position: relative;
      }
      .list-card img {
        width: 80px;
        height: 80px;
        object-fit: cover;
      }
      .list-card .list-content {
        flex: 1;
      }
      .list-title {
        font-size: 14px;
        font-weight: bold;
      }
      .list-category,
      .list-venue,
      .list-date {
        font-size: 12px;
      }
      .favorite-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 40px;
        height: 40px;
        background: transparent;
        border: none;
        color: #fff;
        cursor: pointer;
      }
      .list-card.highlight {
        outline: 2px solid yellow;
      }
      #posts-panel {
        width: auto;
        background: rgba(0,0,0,0.5);
        overflow-y: auto;
      }
      #posts-panel.with-ad { width: calc(100% - 400px); }
      #ad-panel {
        width: 400px;
        left: auto;
        right: 0;
        padding: 0;
        overflow: hidden;
        background: #000;
      }
      #ad-panel img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      #ad-panel .ad-info {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
      }
      #ad-panel .ad-info .list-card {
        width: 100%;
        margin: 0;
        background: rgba(0,0,0,0.7);
      }
      #ad-panel .ad-info .list-card img {
        width: 40px;
        height: 40px;
        object-fit: cover;
      }
      .ad-anim { animation: adZoom 20s linear forwards; }
      @keyframes adZoom {
        from { transform: scale(1); }
        to { transform: scale(1.1); }
      }
      .post-card {
        margin: 0 auto 10px;
        padding: 10px;
        background: #444;
        display: flex;
        gap: 10px;
        box-sizing: border-box;
        position: relative;
        cursor: pointer;
      }
      .post-card img {
        width: 80px;
        height: 80px;
        object-fit: cover;
      }
      .post-card .post-content { flex: 1; }
      .post-card .post-title {
        font-size: 14px;
        font-weight: bold;
      }
      .post-card .post-category,
      .post-card .post-venue,
      .post-card .post-date {
        font-size: 12px;
      }
      .post-card .favorite-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 40px;
        height: 40px;
        background: transparent;
        border: none;
        color: #fff;
        cursor: pointer;
      }
      .post-header {
        position: sticky;
        top: 0;
        background: #333;
        padding: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 1;
      }
      .post-header-info { display: flex; flex-direction: column; }
      .post-header button {
        background: transparent;
        border: none;
        color: #fff;
        cursor: pointer;
      }
      .post-header-actions button { font-size: 20px; margin-left: 5px; }
      .post-body {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        padding: 10px;
      }
      .post-section {
        background: #444;
        padding: 10px;
        box-sizing: border-box;
        flex: 1 1 300px;
      }
      .image-container .hero {
        width: 100%;
        max-width: 400px;
        height: 400px;
        object-fit: cover;
      }
      .thumbs {
        display: flex;
        gap: 5px;
        margin-top: 5px;
        overflow-x: auto;
      }
      .thumbs img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        cursor: pointer;
      }
      .venue-map,
      .session-calendar {
        width: 100%;
        height: 200px;
        background: #222;
        margin-bottom: 5px;
      }
      .session-menu li {
        list-style: none;
        padding: 5px;
        cursor: pointer;
      }
      .session-menu li.selected { background: #666; }
      #image-viewer {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
      }
      #image-viewer img {
        max-width: 90%;
        max-height: 90%;
      }
      #image-viewer.hidden { display: none; }
      #copy-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #222;
        color: #fff;
        padding: 20px;
      }
      #copy-modal.hidden { display: none; }
      @media (max-width: 900px) {
        .post-section { flex: 1 1 100%; }
      }
      @media (min-width: 901px) and (max-width: 1200px) {
        .post-section { flex: 1 1 45%; }
      }
      @media (min-width: 1201px) {
        .post-section { flex: 1 1 30%; }
      }
      @media (max-width: 600px) {
        .venue-map,
        .session-calendar { display: none; }
      }
    </style>
</head>
<body>
  <header id="header">
    <button id="filter-button" aria-label="Filter"></button>
    <button id="list-button" aria-label="List"></button>
    <button id="posts-button" aria-label="Posts"></button>
    <img id="header-logo" src="assets/funmap-logo-big.png" alt="FunMap logo">
    <button id="member-button" aria-label="Member"></button>
    <button id="admin-button" aria-label="Admin"></button>
    <button id="settings-button" aria-label="Settings"></button>
  </header>
  <div id="map"></div>
  <button id="fullscreen-button" aria-label="Fullscreen"></button>
  <div id="welcome-modal" class="hidden">
    <img src="assets/funmap-logo-big.png" alt="FunMap logo" style="max-width:100%;height:auto;">
    <p>Welcome to FunMap!</p>
  </div>
  <div id="copy-modal" class="hidden">Link copied!</div>
  <div id="image-viewer" class="hidden"><img id="viewer-image" alt="Full Image"></div>
  <div id="panels">
    <div id="filter-panel" class="panel">
      <div class="panel-header">
        <button class="panel-arrow-left" aria-label="Previous">&#9664;</button>
        <span>Filter</span>
        <div>
          <button class="panel-arrow-right" aria-label="Next">&#9654;</button>
          <button class="panel-close" aria-label="Close">&times;</button>
        </div>
      </div>
      <div id="sort-menu">
        <button id="sort-menu-button">Sort <span class="menu-arrow">&#9660;</span></button>
        <ul id="sort-menu-items">
          <li data-sort="newest">Newest</li>
          <li data-sort="oldest">Oldest</li>
          <li data-sort="popular">Most Popular</li>
          <li data-sort="nearby">Nearby</li>
        </ul>
      </div>
      <div id="map-controls-row">
        <input id="address-input" type="text" placeholder="Address">
        <button id="geolocate-btn">üìç</button>
        <button id="compass-btn">üß≠</button>
      </div>
      <div id="filter-message">No filters applied</div>
      <div id="keywords-row" class="row">
        <input id="keywords-input" type="text" placeholder="Keywords">
        <button id="keywords-clear" class="clear-btn">&#10006;</button>
      </div>
      <div id="daterange-row" class="row">
        <input id="start-date" type="date">
        <input id="end-date" type="date">
        <button id="date-clear" class="clear-btn">&#10006;</button>
      </div>
      <div id="expired-events-row" class="row">
        <label><input type="checkbox" id="include-expired">Include expired events</label>
      </div>
      <div id="filter-calendar-container">
        <div id="calendar-grid"></div>
      </div>
      <div id="filter-categories-container">
        <div class="filter-category-row">
          <button class="category-toggle">Category A</button>
          <div class="subcategory-list">
            <label><input type="checkbox" class="subcategory" value="SubA1">SubA1</label>
            <label><input type="checkbox" class="subcategory" value="SubA2">SubA2</label>
          </div>
        </div>
        <div class="filter-category-row">
          <button class="category-toggle">Category B</button>
          <div class="subcategory-list">
            <label><input type="checkbox" class="subcategory" value="SubB1">SubB1</label>
            <label><input type="checkbox" class="subcategory" value="SubB2">SubB2</label>
          </div>
        </div>
      </div>
      <button id="filter-reset-button">Reset Filters</button>
    </div>
    <div id="list-panel" class="panel">
      <div class="panel-header">
        <button class="panel-arrow-left" aria-label="Previous">&#9664;</button>
        <span>List</span>
        <div>
          <button class="panel-arrow-right" aria-label="Next">&#9654;</button>
          <button class="panel-close" aria-label="Close">&times;</button>
        </div>
      </div>
      <div id="list-container">
        <div class="list-card" data-id="1">
          <img src="assets/funmap-logo-big.png" alt="Event 1" class="thumbnail">
          <div class="list-content">
            <div class="list-title">Event 1</div>
            <div class="list-category">Category A / SubA1</div>
            <div class="list-venue">Venue 1</div>
            <div class="list-date">Jan 1 - Jan 2</div>
          </div>
          <button class="favorite-btn" aria-label="Favorite">&#9733;</button>
        </div>
        <div class="list-card" data-id="2">
          <img src="assets/funmap-logo-big.png" alt="Event 2" class="thumbnail">
          <div class="list-content">
            <div class="list-title">Event 2</div>
            <div class="list-category">Category B / SubB1</div>
            <div class="list-venue">Venue 2</div>
            <div class="list-date">Feb 1 - Feb 2</div>
          </div>
          <button class="favorite-btn" aria-label="Favorite">&#9733;</button>
        </div>
        <div class="list-card" data-id="3">
          <img src="assets/funmap-logo-big.png" alt="Event 3" class="thumbnail">
          <div class="list-content">
            <div class="list-title">Event 3</div>
            <div class="list-category">Category C / SubC1</div>
            <div class="list-venue">Venue 3</div>
            <div class="list-date">Mar 1 - Mar 2</div>
          </div>
          <button class="favorite-btn" aria-label="Favorite">&#9733;</button>
        </div>
      </div>
    </div>
    <div id="posts-panel" class="panel">
      <div class="panel-header">
        <button class="panel-arrow-left" aria-label="Previous">&#9664;</button>
        <span>Posts</span>
        <div>
          <button class="panel-arrow-right" aria-label="Next">&#9654;</button>
          <button class="panel-close" aria-label="Close">&times;</button>
        </div>
      </div>
      <div id="posts-container">
        <div class="post-card" data-id="1">
          <img src="assets/funmap-logo-big.png" alt="Post 1" class="thumbnail">
          <div class="post-content">
            <div class="post-title">Post 1</div>
            <div class="post-category">Category A / SubA1</div>
            <div class="post-venue">Venue 1</div>
            <div class="post-date">Jan 1 - Jan 2</div>
          </div>
          <button class="favorite-btn" aria-label="Favorite">&#9733;</button>
        </div>
        <div class="post-card" data-id="2">
          <img src="assets/funmap-logo-big.png" alt="Post 2" class="thumbnail">
          <div class="post-content">
            <div class="post-title">Post 2</div>
            <div class="post-category">Category B / SubB1</div>
            <div class="post-venue">Venue 2</div>
            <div class="post-date">Feb 1 - Feb 2</div>
          </div>
          <button class="favorite-btn" aria-label="Favorite">&#9733;</button>
        </div>
        <div class="post-card" data-id="3">
          <img src="assets/funmap-logo-big.png" alt="Post 3" class="thumbnail">
          <div class="post-content">
            <div class="post-title">Post 3</div>
            <div class="post-category">Category C / SubC1</div>
            <div class="post-venue">Venue 3</div>
            <div class="post-date">Mar 1 - Mar 2</div>
          </div>
          <button class="favorite-btn" aria-label="Favorite">&#9733;</button>
        </div>
      </div>
      <div id="post-view" class="hidden">
        <div class="post-header">
          <button id="close-post-btn" aria-label="Back">&#8592;</button>
          <div class="post-header-info">
            <div id="post-header-title"></div>
            <div id="post-header-category"></div>
          </div>
          <div class="post-header-actions">
            <button id="post-favorite" class="favorite-btn" aria-label="Favorite">&#9733;</button>
            <button id="copy-link-btn" aria-label="Copy Link">&#128279;</button>
          </div>
        </div>
        <div class="post-body">
          <div class="post-section image-container">
            <img id="hero-image" class="hero" src="assets/funmap-logo-big.png" alt="Hero">
            <div id="image-thumbnails" class="thumbs"></div>
          </div>
          <div class="post-section venue-container">
            <div id="venue-map" class="venue-map"></div>
            <div id="venue-menu"></div>
          </div>
          <div class="post-section session-container">
            <div id="session-calendar" class="session-calendar"></div>
            <ul id="session-menu" class="session-menu"></ul>
          </div>
          <div class="post-section post-description">
            <div id="post-author"></div>
            <div id="post-details"></div>
            <div id="post-text"></div>
          </div>
        </div>
      </div>
    </div>
    <div id="ad-panel" class="panel">
      <img id="ad-image" alt="Advertisement">
      <div class="ad-info">
        <div class="list-card">
          <img id="ad-thumb" alt="Ad thumbnail">
          <div class="list-content">
            <div class="list-title"></div>
            <div class="list-category"></div>
            <div class="list-venue"></div>
            <div class="list-date"></div>
          </div>
        </div>
      </div>
    </div>
    <div id="member-panel" class="panel">
      <div class="panel-header">
        <button class="panel-arrow-left" aria-label="Previous">&#9664;</button>
        <span>Member</span>
        <div>
          <button class="panel-arrow-right" aria-label="Next">&#9654;</button>
          <button class="panel-close" aria-label="Close">&times;</button>
        </div>
      </div>
      <div id="auth-row" class="member-row">
        <button id="login-btn">Login</button>
        <button id="register-btn">Register</button>
        <button id="logout-btn">Logout</button>
      </div>
      <div id="profile-row" class="member-row">
        <span id="username-display">Guest</span>
        <img id="avatar-display" src="" alt="Avatar" style="width:40px;height:40px;background:#666;">
      </div>
      <div id="password-row" class="member-row">
        <input id="password-input" type="password" placeholder="Password" style="flex:1;">
      </div>
      <div id="currency-row" class="member-row">
        <select id="currency-selector" style="flex:1;">
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
        </select>
      </div>
      <div id="language-row" class="member-row">
        <select id="language-selector" style="flex:1;">
          <option value="en">EN</option>
          <option value="es">ES</option>
        </select>
      </div>
      <div id="posts-list" class="member-row">Your Posts</div>
      <div id="new-post-form" class="member-row">
        <button id="new-post-btn">Create New Post</button>
      </div>
    </div>
    <div id="admin-panel" class="panel">
      <div class="panel-header">
        <button class="panel-arrow-left" aria-label="Previous">&#9664;</button>
        <span>Admin</span>
        <div>
          <button class="panel-arrow-right" aria-label="Next">&#9654;</button>
          <button class="panel-close" aria-label="Close">&times;</button>
        </div>
      </div>
      <div class="tab-header">
        <button data-tab="admin-settings" class="active">Settings</button>
        <button data-tab="admin-theme">Theme</button>
        <button data-tab="admin-map">Map</button>
        <button data-tab="admin-forms">Forms</button>
      </div>
      <div id="admin-settings" class="tab-content active">
        <div class="row"><label for="admin-username">Username</label><input id="admin-username" type="text"></div>
        <div class="row"><label for="admin-avatar">Avatar</label><input id="admin-avatar" type="file"><svg id="avatar-placeholder" width="40" height="40"><circle cx="20" cy="20" r="18" fill="#777"/></svg></div>
        <div class="row"><label for="site-name">Site Name</label><input id="site-name" type="text"></div>
        <div class="row"><label for="site-logo">Logo</label><input id="site-logo" type="file"></div>
        <div class="row"><label for="favicon-link">Favicon Link</label><input id="favicon-link" type="text"></div>
        <div class="row"><label for="welcome-message">Welcome Message</label><textarea id="welcome-message" placeholder="WYSIWYG editor placeholder"></textarea></div>
      </div>
      <div id="admin-theme" class="tab-content">
        <div class="row">
          <label for="theme-preset">Preset</label>
          <div style="flex:1;position:relative;">
            <select id="theme-preset" style="width:100%;">
              <option>Default</option>
            </select>
            <span class="menu-arrow" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);">&#9662;</span>
          </div>
          <button id="theme-refresh">&#8635;</button>
        </div>
      </div>
      <div id="admin-map" class="tab-content">
        <div id="map-settings-container">
          <div class="row"><label for="map-token">Token</label><input id="map-token" type="text"></div>
          <div class="row"><label for="map-theme">Theme</label><select id="map-theme"></select></div>
          <div class="row"><label for="map-sky">Sky</label><select id="map-sky"></select></div>
        </div>
        <div id="map-spin-container">
          <div class="row"><label for="spin-toggle">Spin Map</label><input id="spin-toggle" type="checkbox"></div>
          <div class="row"><label for="marker-spin-toggle">Spin Markers</label><input id="marker-spin-toggle" type="checkbox"></div>
          <div class="row"><label for="spin-speed">Speed</label><input id="spin-speed" type="range" min="0" max="10"></div>
          <div class="row"><label for="min-zoom">Min Zoom</label><input id="min-zoom" type="range" min="0" max="20"></div>
        </div>
        <div id="markercluster-container">
          <div class="row"><label for="cluster-style">Cluster Style</label><input id="cluster-style" type="text"></div>
        </div>
      </div>
      <div id="admin-forms" class="tab-content">
        <div id="formbuilder-container">
          <div class="form-category">
            <button class="category-toggle">General</button>
            <div class="subcategory-menu">
              <div class="field" draggable="true"><span>Title</span><input class="icon-input" type="text" placeholder="icon"><button class="delete-field">Delete</button></div>
              <div class="field" draggable="true"><span>Description</span><input class="icon-input" type="text" placeholder="icon"><button class="delete-field">Delete</button></div>
            </div>
          </div>
          <div class="form-category">
            <button class="category-toggle">Media</button>
            <div class="subcategory-menu">
              <div class="field" draggable="true"><span>Images</span><input class="icon-input" type="text" placeholder="icon"><button class="delete-field">Delete</button></div>
            </div>
          </div>
          <div class="form-category">
            <button class="category-toggle">Venues &amp; Sessions</button>
            <div class="subcategory-menu">
              <div class="field" draggable="true"><span>Venues</span><input class="icon-input" type="text" placeholder="icon"><button class="delete-field">Delete</button></div>
              <div class="field" draggable="true"><span>Sessions</span><input class="icon-input" type="text" placeholder="icon"><button class="delete-field">Delete</button></div>
            </div>
          </div>
          <div class="form-category">
            <button class="category-toggle">Pricing</button>
            <div class="subcategory-menu">
              <div class="field" draggable="true"><span>Pricing</span><input class="icon-input" type="text" placeholder="icon"><button class="delete-field">Delete</button></div>
            </div>
          </div>
          <div class="form-category">
            <button class="category-toggle">Contact</button>
            <div class="subcategory-menu">
              <div class="field" draggable="true"><span>Contact Info</span><input class="icon-input" type="text" placeholder="icon"><button class="delete-field">Delete</button></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="settings-panel" class="panel">
      <div class="panel-header">
        <button class="panel-arrow-left" aria-label="Previous">&#9664;</button>
        <span>Settings</span>
        <div>
          <button class="panel-arrow-right" aria-label="Next">&#9654;</button>
          <button class="panel-close" aria-label="Close">&times;</button>
        </div>
      </div>
      <p>Placeholder</p>
    </div>
  </div>
  <footer id="footer">
    <div id="recent-posts-container"></div>
  </footer>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.Xo14KJtnMhLy2RpQeyWNLw';
    const welcomeModal = document.getElementById('welcome-modal');
    const headerLogo = document.getElementById('header-logo');
  const recentPostsContainer = document.getElementById('recent-posts-container');
  const fullscreenButton = document.getElementById('fullscreen-button');
  const favorites = new Set(JSON.parse(localStorage.getItem('favorites') || '[]'));
  let recentPosts = JSON.parse(localStorage.getItem('recentPosts') || '[]');

  let activePanel = null;

  const sortMenu = document.getElementById('sort-menu');
  const sortMenuButton = document.getElementById('sort-menu-button');
  const sortMenuItems = document.querySelectorAll('#sort-menu-items li');
  const keywordsInput = document.getElementById('keywords-input');
  const keywordsClear = document.getElementById('keywords-clear');
  const startDateInput = document.getElementById('start-date');
  const endDateInput = document.getElementById('end-date');
  const dateClear = document.getElementById('date-clear');
  const expiredSwitch = document.getElementById('include-expired');
  const filterMessage = document.getElementById('filter-message');
  const filterResetButton = document.getElementById('filter-reset-button');
  const subcategoryCheckboxes = document.querySelectorAll('.subcategory');
  const categoryToggles = document.querySelectorAll('.category-toggle');
  const geolocateBtn = document.getElementById('geolocate-btn');
  const compassBtn = document.getElementById('compass-btn');
  const loginBtn = document.getElementById('login-btn');
  const registerBtn = document.getElementById('register-btn');
  const logoutBtn = document.getElementById('logout-btn');
  const currencySelector = document.getElementById('currency-selector');
  const languageSelector = document.getElementById('language-selector');
  const newPostBtn = document.getElementById('new-post-btn');
  const listButton = document.getElementById('list-button');
  const listPanel = document.getElementById('list-panel');
  const postsPanel = document.getElementById('posts-panel');
  const postsContainer = document.getElementById('posts-container');
  const postView = document.getElementById('post-view');
  const heroImage = document.getElementById('hero-image');
  const imageThumbnails = document.getElementById('image-thumbnails');
  const postHeaderTitle = document.getElementById('post-header-title');
  const postHeaderCategory = document.getElementById('post-header-category');
  const postFavorite = document.getElementById('post-favorite');
  const copyLinkBtn = document.getElementById('copy-link-btn');
  const sessionMenu = document.getElementById('session-menu');
  const copyModal = document.getElementById('copy-modal');
  const imageViewer = document.getElementById('image-viewer');
  const viewerImage = document.getElementById('viewer-image');
  const closePostBtn = document.getElementById('close-post-btn');

  const postsData = {
    1: { title: 'Event 1', category: 'Category A / SubA1', venue: 'Venue 1', date: 'Jan 1 - Jan 2', author: 'Author 1', description: 'Description for event 1', images: ['assets/funmap-logo-big.png','assets/funmap-logo-big.png'], sessions: ['Session 1','Session 2'], premium: true },
    2: { title: 'Event 2', category: 'Category B / SubB1', venue: 'Venue 2', date: 'Feb 1 - Feb 2', author: 'Author 2', description: 'Description for event 2', images: ['assets/funmap-logo-big.png','assets/funmap-logo-big.png'], sessions: ['Session 1','Session 2'], premium: true },
    3: { title: 'Event 3', category: 'Category C / SubC1', venue: 'Venue 3', date: 'Mar 1 - Mar 2', author: 'Author 3', description: 'Description for event 3', images: ['assets/funmap-logo-big.png','assets/funmap-logo-big.png'], sessions: ['Session 1','Session 2'], premium: true }
  };

  const adPanel = document.getElementById('ad-panel');
  const adImage = document.getElementById('ad-image');
  const adThumb = document.getElementById('ad-thumb');
  const adTitle = adPanel.querySelector('.list-title');
  const adCategory = adPanel.querySelector('.list-category');
  const adVenue = adPanel.querySelector('.list-venue');
  const adDate = adPanel.querySelector('.list-date');
  const premiumPosts = Object.entries(postsData)
    .filter(([id, data]) => data.premium)
    .map(([id, data]) => ({ id, ...data }));
  const adSources = premiumPosts.map(p => p.images[0]);
  adSources.slice(0, 3).forEach(src => { const img = new Image(); img.src = src; });
  let adIndex = 0;

  function updateAd() {
    if (!premiumPosts.length) return;
    const post = premiumPosts[adIndex];
    adPanel.dataset.postId = post.id;
    adImage.src = post.images[0];
    adImage.classList.remove('ad-anim');
    void adImage.offsetWidth;
    adImage.classList.add('ad-anim');
    adThumb.src = post.images[0];
    adTitle.textContent = post.title;
    adCategory.textContent = post.category;
    adVenue.textContent = post.venue;
    adDate.textContent = post.date;
  }
  updateAd();
  setInterval(() => {
    adIndex = (adIndex + 1) % premiumPosts.length;
    updateAd();
  }, 20000);

  function setMode(mode) {
    const m = mode === 'posts' ? 'posts' : 'map';
    if (m === 'map') {
      if (listPanel) listPanel.classList.remove('hidden');
      if (postsPanel) postsPanel.classList.add('hidden');
      if (adPanel) adPanel.classList.add('hidden');
    } else {
      if (listPanel) listPanel.classList.add('hidden');
      if (postsPanel) postsPanel.classList.remove('hidden');
      if (adPanel) adPanel.classList.remove('hidden');
    }
    localStorage.setItem('mode', m);
    adjustScrollbars();
  }
  setMode(localStorage.getItem('mode') || 'map');

  adPanel.addEventListener('click', () => {
    const id = adPanel.dataset.postId;
    if (!id) return;
    if (!postsPanel.classList.contains('active')) togglePanel('posts-panel');
    postsContainer.classList.remove('hidden');
    postView.classList.add('hidden');
    const card = document.querySelector(`#posts-container .post-card[data-id="${id}"]`);
    if (card) card.scrollIntoView({ behavior: 'smooth' });
  });

  function checkAdPanel() {
    if (postsPanel.classList.contains('active') && window.innerWidth >= 1200) {
      adPanel.classList.add('active');
      postsPanel.classList.add('with-ad');
    } else {
      adPanel.classList.remove('active');
      postsPanel.classList.remove('with-ad');
    }
  }


  let currentPostId = null;

  document.querySelectorAll('.list-card').forEach(card => {
    const id = card.dataset.id;
    const fav = card.querySelector('.favorite-btn');
    if (fav && favorites.has(id)) fav.classList.add('active');
    if (fav) fav.addEventListener('click', (e) => {
      e.stopPropagation();
      fav.classList.toggle('active');
      if (fav.classList.contains('active')) favorites.add(id); else favorites.delete(id);
      localStorage.setItem('favorites', JSON.stringify(Array.from(favorites)));
    });
    card.addEventListener('click', () => openPost(id));
  });

  document.querySelectorAll('#posts-container .post-card').forEach(card => {
    card.addEventListener('click', (e) => {
      if (e.target.classList.contains('favorite-btn')) return;
      openPost(card.dataset.id);
    });
    const fav = card.querySelector('.favorite-btn');
    const id = card.dataset.id;
    if (fav && favorites.has(id)) fav.classList.add('active');
    if (fav) fav.addEventListener('click', (e) => {
      e.stopPropagation();
      fav.classList.toggle('active');
      if (fav.classList.contains('active')) favorites.add(id); else favorites.delete(id);
      localStorage.setItem('favorites', JSON.stringify(Array.from(favorites)));
    });
  });

  if (postFavorite) postFavorite.addEventListener('click', () => {
    postFavorite.classList.toggle('active');
    if (currentPostId) {
      if (postFavorite.classList.contains('active')) favorites.add(currentPostId); else favorites.delete(currentPostId);
      localStorage.setItem('favorites', JSON.stringify(Array.from(favorites)));
    }
  });
  if (closePostBtn) closePostBtn.addEventListener('click', closePost);
  if (copyLinkBtn) copyLinkBtn.addEventListener('click', () => {
    if (!currentPostId) return;
    navigator.clipboard.writeText(window.location.href + '#post-' + currentPostId).then(() => {
      copyModal.classList.remove('hidden');
      setTimeout(() => copyModal.classList.add('hidden'), 2000);
    });
  });
  if (heroImage) heroImage.addEventListener('click', () => {
    viewerImage.src = heroImage.src;
    imageViewer.classList.remove('hidden');
  });
  if (imageViewer) imageViewer.addEventListener('click', () => imageViewer.classList.add('hidden'));
  if (sessionMenu) sessionMenu.addEventListener('click', (e) => {
    if (e.target.tagName === 'LI') {
      sessionMenu.querySelectorAll('li').forEach(li => li.classList.remove('selected'));
      e.target.classList.add('selected');
    }
  });

  const activeFilters = {
    keywords: '',
    startDate: '',
    endDate: '',
    includeExpired: false,
    categories: [],
    sort: ''
  };

  function adjustScrollbars() {
    const sw = window.innerWidth - document.documentElement.clientWidth;
    document.querySelectorAll('.panel').forEach(p => p.style.right = sw + 'px');
  }

  function handleViewport() {
    if (window.innerWidth < 450) {
      if (listButton) listButton.style.display = 'none';
      if (listPanel) listPanel.classList.remove('active');
    } else {
      if (listButton) listButton.style.display = '';
    }
    adjustScrollbars();
    checkAdPanel();
  }
  window.addEventListener('resize', handleViewport);
  handleViewport();

  function hasActiveFilters() {
    return activeFilters.keywords || activeFilters.startDate || activeFilters.endDate ||
           activeFilters.includeExpired || activeFilters.categories.length || activeFilters.sort;
  }

  function updateFilterButtonState() {
    const filterBtn = document.getElementById('filter-button');
    if (hasActiveFilters()) {
      filterBtn.classList.add('active');
      filterResetButton.classList.add('active');
    } else {
      filterBtn.classList.remove('active');
      filterResetButton.classList.remove('active');
    }
  }

  function updateFilterMessage() {
    const parts = [];
    if (activeFilters.keywords) parts.push(`Keywords: ${activeFilters.keywords}`);
    if (activeFilters.startDate || activeFilters.endDate) {
      const range = [activeFilters.startDate, activeFilters.endDate].filter(Boolean).join(' to ');
      parts.push(`Dates: ${range}`);
    }
    if (activeFilters.includeExpired) parts.push('Including expired');
    if (activeFilters.categories.length) parts.push(`Categories: ${activeFilters.categories.join(', ')}`);
    if (activeFilters.sort) parts.push(`Sort: ${activeFilters.sort}`);
    filterMessage.textContent = parts.length ? parts.join('; ') : 'No filters applied';
  }

  function updateFilters() {
    activeFilters.keywords = keywordsInput.value.trim();
    activeFilters.startDate = startDateInput.value;
    activeFilters.endDate = endDateInput.value;
    activeFilters.includeExpired = expiredSwitch.checked;
    activeFilters.categories = Array.from(subcategoryCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
    activeFilters.sort = sortMenu.dataset.sort || '';
    updateFilterButtonState();
    updateFilterMessage();
    localStorage.setItem('filters', JSON.stringify(activeFilters));
  }

  function toggleClear(btn, condition) {
    if (condition) btn.classList.add('active'); else btn.classList.remove('active');
  }

  function restoreFilters() {
    const saved = JSON.parse(localStorage.getItem('filters') || '{}');
    Object.assign(activeFilters, saved);
    keywordsInput.value = activeFilters.keywords || '';
    startDateInput.value = activeFilters.startDate || '';
    endDateInput.value = activeFilters.endDate || '';
    expiredSwitch.checked = !!activeFilters.includeExpired;
    subcategoryCheckboxes.forEach(cb => cb.checked = (activeFilters.categories || []).includes(cb.value));
    if (activeFilters.sort) {
      sortMenu.dataset.sort = activeFilters.sort;
      const selected = document.querySelector(`#sort-menu-items li[data-sort='${activeFilters.sort}']`);
      if (selected) sortMenuButton.innerHTML = selected.textContent + ' <span class="menu-arrow">&#9660;</span>';
    }
    toggleClear(keywordsClear, keywordsInput.value);
    toggleClear(dateClear, startDateInput.value || endDateInput.value);
    updateFilterButtonState();
    updateFilterMessage();
  }

  sortMenuButton.addEventListener('click', () => sortMenu.classList.toggle('open'));
  sortMenuItems.forEach(item => {
    item.addEventListener('click', () => {
      sortMenu.dataset.sort = item.dataset.sort;
      sortMenuButton.innerHTML = item.textContent + ' <span class="menu-arrow">&#9660;</span>';
      sortMenu.classList.remove('open');
      updateFilters();
    });
  });

  keywordsInput.addEventListener('input', () => {
    toggleClear(keywordsClear, keywordsInput.value);
    updateFilters();
  });
  keywordsClear.addEventListener('click', () => {
    keywordsInput.value = '';
    toggleClear(keywordsClear, '');
    updateFilters();
  });

  function handleDateChange() {
    toggleClear(dateClear, startDateInput.value || endDateInput.value);
    updateFilters();
  }
  startDateInput.addEventListener('change', handleDateChange);
  endDateInput.addEventListener('change', handleDateChange);
  dateClear.addEventListener('click', () => {
    startDateInput.value = '';
    endDateInput.value = '';
    toggleClear(dateClear, '');
    updateFilters();
  });

  expiredSwitch.addEventListener('change', updateFilters);

  categoryToggles.forEach(btn => {
    btn.addEventListener('click', () => btn.parentElement.classList.toggle('open'));
  });
  subcategoryCheckboxes.forEach(cb => cb.addEventListener('change', updateFilters));

  filterResetButton.addEventListener('click', () => {
    keywordsInput.value = '';
    startDateInput.value = '';
    endDateInput.value = '';
    expiredSwitch.checked = false;
    sortMenu.dataset.sort = '';
    sortMenuButton.innerHTML = 'Sort <span class="menu-arrow">&#9660;</span>';
    subcategoryCheckboxes.forEach(cb => cb.checked = false);
    toggleClear(keywordsClear, '');
    toggleClear(dateClear, '');
    updateFilters();
  });

  function populateCalendar(date) {
    const grid = document.getElementById('calendar-grid');
    if (!grid) return;
    grid.innerHTML = '';
    const year = date.getFullYear();
    const month = date.getMonth();
    const days = new Date(year, month + 1, 0).getDate();
    for (let d = 1; d <= days; d++) {
      const cell = document.createElement('div');
      cell.className = 'calendar-day';
      cell.textContent = d;
      grid.appendChild(cell);
    }
  }

  restoreFilters();
  populateCalendar(new Date());
  updateFilters();
  renderRecentPosts();

  function togglePanel(id) {
    const panel = document.getElementById(id);
    if (!panel) return;
    const isActive = panel.classList.contains('active');
    if (isActive) {
      panel.classList.remove('active');
      if (id === 'posts-panel') {
        closePost();
        setMode('map');
      }
      activePanel = null;
    } else {
      if (activePanel) {
        if (activePanel.id === 'posts-panel') closePost();
        activePanel.classList.remove('active');
      }
      panel.classList.add('active');
      activePanel = panel;
      if (id === 'posts-panel') setMode('posts'); else setMode('map');
    }
    checkAdPanel();
  }

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (welcomeModal && !welcomeModal.classList.contains('hidden')) {
        welcomeModal.classList.add('hidden');
        return;
      }
      if (activePanel) togglePanel(activePanel.id);
    }
  });

  function makePanelDraggable(panel) {
    const header = panel.querySelector('.panel-header');
    if (!header) return;
    let startX = 0, startY = 0, origX = 0, origY = 0, dragging = false;

    header.addEventListener('mousedown', (e) => {
      dragging = true;
      startX = e.clientX;
      startY = e.clientY;
      origX = panel.offsetLeft;
      origY = panel.offsetTop;
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
    });

    function onMouseMove(e) {
      if (!dragging) return;
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      let newLeft = origX + dx;
      let newTop = origY + dy;
      const maxLeft = window.innerWidth - panel.offsetWidth;
      const maxTop = window.innerHeight - header.offsetHeight;
      if (newLeft < 0) newLeft = 0;
      if (newTop < 0) newTop = 0;
      if (newLeft > maxLeft) newLeft = maxLeft;
      if (newTop > maxTop) newTop = maxTop;
      panel.style.left = newLeft + 'px';
      panel.style.top = newTop + 'px';
    }

    function onMouseUp() {
      dragging = false;
      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup', onMouseUp);
    }
  }

    fullscreenButton.addEventListener('click', () => {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    });

    function addRecentPost(post) {
      const existingIndex = recentPosts.findIndex(p => p.id === post.id);
      if (existingIndex !== -1) recentPosts.splice(existingIndex, 1);
      recentPosts.unshift(post);
      if (recentPosts.length > 100) recentPosts.pop();
      renderRecentPosts();
      localStorage.setItem('recentPosts', JSON.stringify(recentPosts));
    }

    function renderRecentPosts() {
      if (!recentPostsContainer) return;
      recentPostsContainer.innerHTML = '';
      recentPosts.forEach(post => {
        const card = document.createElement('div');
        card.className = 'recent-post-card';

        const img = document.createElement('img');
        img.src = post.thumbnail;
        img.alt = post.title;

        const title = document.createElement('span');
        title.textContent = post.title;

        const star = document.createElement('span');
        star.className = 'star';
        star.textContent = '‚òÜ';

        card.appendChild(img);
        card.appendChild(title);
        card.appendChild(star);
        recentPostsContainer.appendChild(card);
      });
    }

    function highlightListCard(id) {
      if (!listPanel) return;
      const cards = listPanel.querySelectorAll('.list-card');
      cards.forEach(c => c.classList.remove('highlight'));
      const target = listPanel.querySelector(`.list-card[data-id='${id}']`);
      if (target) {
        target.classList.add('highlight');
        listPanel.scrollTo({ top: target.offsetTop - 10, behavior: 'smooth' });
      }
    }

    function openPost(id) {
      const data = postsData[id];
      if (!data) return;
      currentPostId = id;
      highlightListCard(id);
      if (map && map.getSource('events')) {
        const src = map.getSource('events');
        const feature = src._data && src._data.features.find(f => f.properties.id == id);
        if (feature) map.flyTo({ center: feature.geometry.coordinates, zoom: 13 });
      }
      postsContainer.classList.add('hidden');
      postView.classList.remove('hidden');
      postHeaderTitle.textContent = data.title;
      postHeaderCategory.textContent = data.category;
      heroImage.src = data.images[0];
      imageThumbnails.innerHTML = '';
      data.images.forEach(src => {
        const img = document.createElement('img');
        img.src = src;
        img.alt = data.title;
        img.addEventListener('click', () => { heroImage.src = src; });
        imageThumbnails.appendChild(img);
      });
      sessionMenu.innerHTML = '';
      data.sessions.forEach(s => {
        const li = document.createElement('li');
        li.textContent = s;
        sessionMenu.appendChild(li);
      });
      document.getElementById('post-author').textContent = data.author;
      document.getElementById('post-details').textContent = `${data.venue} | ${data.date}`;
      document.getElementById('post-text').textContent = data.description;
      if (postFavorite) postFavorite.classList.toggle('active', favorites.has(id));
      addRecentPost({ id, title: data.title, thumbnail: data.images[0] });
      if (postsPanel && !postsPanel.classList.contains('active')) togglePanel('posts-panel');
      setMode('posts');
    }

    function closePost() {
      postView.classList.add('hidden');
      postsContainer.classList.remove('hidden');
      currentPostId = null;
      setMode('map');
    }

    function toggleModal() {
      if (welcomeModal) welcomeModal.classList.toggle('hidden');
    }
    if (welcomeModal) welcomeModal.addEventListener('click', toggleModal);
    window.addEventListener('load', () => {
      if (welcomeModal && !localStorage.getItem('welcomeShown')) {
        welcomeModal.classList.remove('hidden');
        localStorage.setItem('welcomeShown', 'true');
      }
    });

    if (headerLogo) headerLogo.addEventListener('click', toggleModal);

  const buttonPanelMap = {
    'filter-button': 'filter-panel',
    'list-button': 'list-panel',
    'posts-button': 'posts-panel',
    'member-button': 'member-panel',
    'admin-button': 'admin-panel',
    'settings-button': 'settings-panel'
  };

  Object.keys(buttonPanelMap).forEach(buttonId => {
    const btn = document.getElementById(buttonId);
    const panelId = buttonPanelMap[buttonId];
    btn.addEventListener('click', () => togglePanel(panelId));
  });

  document.querySelectorAll('.panel').forEach(panel => {
    const closeBtn = panel.querySelector('.panel-close');
    if (closeBtn) closeBtn.addEventListener('click', () => togglePanel(panel.id));
    makePanelDraggable(panel);
  });

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v11',
      center: [-122.447303, 37.753574],
      zoom: 10
    });

    geolocateBtn.addEventListener('click', () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          map.flyTo({ center: [pos.coords.longitude, pos.coords.latitude], zoom: 13 });
        });
      }
    });

    compassBtn.addEventListener('click', () => map.resetNorth());

    map.on('load', () => {
      const standardCanvas = document.createElement('canvas');
      standardCanvas.width = 40;
      standardCanvas.height = 40;
      const stdCtx = standardCanvas.getContext('2d');
      stdCtx.fillStyle = '#3FB1CE';
      stdCtx.beginPath();
      stdCtx.arc(20, 20, 20, 0, Math.PI * 2);
      stdCtx.fill();

      const premiumCanvas = document.createElement('canvas');
      premiumCanvas.width = 80;
      premiumCanvas.height = 80;
      const premCtx = premiumCanvas.getContext('2d');
      premCtx.fillStyle = '#fbb03b';
      premCtx.beginPath();
      premCtx.arc(40, 40, 40, 0, Math.PI * 2);
      premCtx.fill();

      map.addImage('standard-icon', standardCanvas, { pixelRatio: 1 });
      map.addImage('premium-icon', premiumCanvas, { pixelRatio: 1 });

      const geojson = {
        type: 'FeatureCollection',
        features: [
          { type: 'Feature', properties: { id: 1, premium: false }, geometry: { type: 'Point', coordinates: [-122.447303, 37.753574] } },
          { type: 'Feature', properties: { id: 2, premium: true }, geometry: { type: 'Point', coordinates: [-122.457303, 37.763574] } },
          { type: 'Feature', properties: { id: 3, premium: false }, geometry: { type: 'Point', coordinates: [-122.467303, 37.773574] } }
        ]
      };

      map.addSource('events', {
        type: 'geojson',
        data: geojson,
        cluster: true,
        clusterMaxZoom: 14,
        clusterRadius: 50
      });

      map.addLayer({
        id: 'clusters',
        type: 'circle',
        source: 'events',
        filter: ['has', 'point_count'],
        paint: {
          'circle-color': '#51bbd6',
          'circle-radius': ['step', ['get', 'point_count'], 20, 100, 30, 750, 40]
        }
      });

      map.addLayer({
        id: 'cluster-count',
        type: 'symbol',
        source: 'events',
        filter: ['has', 'point_count'],
        layout: {
          'text-field': ['get', 'point_count_abbreviated'],
          'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
          'text-size': 12
        }
      });

      map.addLayer({
        id: 'unclustered-point',
        type: 'symbol',
        source: 'events',
        filter: ['!', ['has', 'point_count']],
        layout: {
          'icon-image': ['case', ['==', ['get', 'premium'], true], 'premium-icon', 'standard-icon'],
          'icon-allow-overlap': true
        }
      });

      map.on('click', 'clusters', (e) => {
        const features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
        const clusterId = features[0].properties.cluster_id;
        map.getSource('events').getClusterExpansionZoom(clusterId, (err, zoom) => {
          if (err) return;
          map.easeTo({ center: features[0].geometry.coordinates, zoom, pitch: 45 });
        });
      });

      let lastMarkerTap = { id: null, time: 0 };
      map.on('click', 'unclustered-point', (e) => {
        const feature = e.features[0];
        const id = feature.properties.id;
        if ('ontouchstart' in window) {
          const now = Date.now();
          if (lastMarkerTap.id === id && now - lastMarkerTap.time < 300) {
            openPost(id);
            lastMarkerTap = { id: null, time: 0 };
          } else {
            highlightListCard(id);
            lastMarkerTap = { id, time: now };
          }
        } else {
          openPost(id);
        }
        if (listPanel && !listPanel.classList.contains('active') && window.innerWidth >= 450) togglePanel('list-panel');
      });

      map.on('mouseenter', 'clusters', () => { map.getCanvas().style.cursor = 'pointer'; });
      map.on('mouseleave', 'clusters', () => { map.getCanvas().style.cursor = ''; });
      map.on('mouseenter', 'unclustered-point', () => { map.getCanvas().style.cursor = 'pointer'; });
      map.on('mouseleave', 'unclustered-point', () => { map.getCanvas().style.cursor = ''; });
    });

  function handleLogin() {
    console.log('login');
  }

  function handleRegister() {
    console.log('register');
  }

  function handleLogout() {
    console.log('logout');
  }

  function handleCurrencyChange(e) {
    console.log('currency', e.target.value);
  }

  function handleLanguageChange(e) {
    console.log('language', e.target.value);
  }

  function handleCreatePost() {
    console.log('create post');
  }

  const adminTabButtons = document.querySelectorAll('#admin-panel .tab-header button');
  const adminTabContents = document.querySelectorAll('#admin-panel .tab-content');
  adminTabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      adminTabButtons.forEach(b => b.classList.remove('active'));
      adminTabContents.forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      const target = document.getElementById(btn.dataset.tab);
      if (target) target.classList.add('active');
    });
  });
  document.querySelectorAll('#formbuilder-container .category-toggle').forEach(btn => {
    btn.addEventListener('click', () => {
      btn.parentElement.classList.toggle('open');
    });
  });
  let dragSrcEl = null;
  document.querySelectorAll('#formbuilder-container .field').forEach(field => {
    field.addEventListener('dragstart', e => {
      dragSrcEl = field;
      e.dataTransfer.effectAllowed = 'move';
    });
    field.addEventListener('dragover', e => e.preventDefault());
    field.addEventListener('drop', e => {
      e.preventDefault();
      if (dragSrcEl && dragSrcEl !== field) {
        const parent = field.parentElement;
        const after = (dragSrcEl.compareDocumentPosition(field) & Node.DOCUMENT_POSITION_FOLLOWING) ? field.nextSibling : field;
        parent.insertBefore(dragSrcEl, after);
      }
    });
  });
  document.querySelectorAll('#formbuilder-container .delete-field').forEach(btn => {
    btn.addEventListener('click', () => {
      if (confirm('Delete this field?')) {
        btn.closest('.field').remove();
      }
    });
  });

  if (loginBtn) loginBtn.addEventListener('click', handleLogin);
  if (registerBtn) registerBtn.addEventListener('click', handleRegister);
  if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
  if (currencySelector) currencySelector.addEventListener('change', handleCurrencyChange);
  if (languageSelector) languageSelector.addEventListener('change', handleLanguageChange);
  if (newPostBtn) newPostBtn.addEventListener('click', handleCreatePost);
  </script>
</body>
</html>
