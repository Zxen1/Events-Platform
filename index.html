<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Events Platform</title>
  <link rel="apple-touch-icon" sizes="180x180" href="assets/favicons/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="assets/favicons/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="assets/favicons/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="assets/favicons/android-chrome-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="assets/favicons/android-chrome-512x512.png" />
  <link rel="manifest" href="assets/favicons/site.webmanifest" />
  <link rel="shortcut icon" href="assets/favicons/favicon.ico" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" />
  <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/bundle.js"></script>
  <style>:root{
  --header-h: 75px;
  --subheader-h: 75px;
  --panel-w: 260px;
  --results-w: 520px;
  --gap: 12px;
    --ink: #ffffff;
    --ink-d: #ececec;
    --gold: #ffc107;
    --muted: #777;
      --primary: #000000;
      --secondary: #000000;
      --accent: #000000;
      --background: rgba(41,41,41,1);
      --text: #ffffff;
      --button-text: #ffffff;
      --button-hover-text: #000000;
      --btn: rgba(74,74,74,0.9);
      --btn-hover: rgba(0,0,0,1);
      --btn-active: rgba(0,0,0,1);
      --btn-2: var(--btn-hover);
      --modal-bg: rgba(0,0,0,0.62);
      --modal-text: #000000;
      --footer-h: 70px;
      --list-background: rgba(0,0,0,0.37);
      --scrollbar-track: rgba(0,0,0,0);
      --scrollbar-thumb: rgba(0,0,0,0.3);
      --scrollbar-thumb-hover: rgba(0,0,0,0.5);
      --border: rgba(173,173,173,0.31);
      --border-hover: rgba(255,136,0,0.43);
      --border-active: rgba(255,200,0,0.45);
      --placeholder-text: #d1d1d1;
      --filter-placeholder-text: var(--placeholder-text);
      --filter-date-text: var(--text);
      --dropdown-title: #000000;
      --dropdown-selected-bg: rgba(224,224,224,1);
      --dropdown-selected-text: #000000;
      --dropdown-text: #000000;
      --dropdown-bg: rgba(255,255,255,1);
      --dropdown-hover-bg: rgba(224,224,224,1);
      --dropdown-hover-text: #000000;
      --dropdown-venue-text: #000000;
      --dropdown-radius: 6px;
      --session-available: #0000ff;
      --session-selected: #008000;
      --filter-btn-active: #8b0000;
}

*{
  box-sizing: border-box;
  scrollbar-width: thin;
  scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
  border-color: var(--border) !important;
}

*:active,
*[aria-pressed="true"],
*[aria-current="page"],
*[aria-selected="true"],
.selected,
.on{
  border-color: var(--border-active) !important;
}

*:hover{
  border-color: var(--border-hover) !important;
}

html,body{
  height: 100%;
}

*::-webkit-scrollbar{
  width:8px;
  height:8px;
}
*::-webkit-scrollbar-track{
  background:var(--scrollbar-track);
}
*::-webkit-scrollbar-thumb{
  background:var(--scrollbar-thumb);
  border-radius:4px;
}
*::-webkit-scrollbar-thumb:hover{
  background:var(--scrollbar-thumb-hover);
}

body{
  margin: 0;
  font-family: Verdana,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans","Liberation Sans",sans-serif;
  background: var(--background);
  color: var(--text);
  overflow: hidden;
  cursor: default;
  caret-color: transparent;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

input,
textarea{
  caret-color: auto;
}

button,
[role="button"]{
  background: var(--secondary);
  border: 1px solid var(--secondary);
  color: var(--button-text);
  padding: 6px 10px;
  border-radius: 6px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background .2s,border-color .2s,color .2s,transform .05s;
}

button:hover,
[role="button"]:hover{
  background: var(--accent);
  border-color: var(--accent);
  color: var(--button-hover-text);
}

a{
  color: var(--primary);
}

a:hover{
  color: var(--accent);
}
button:active,
[role="button"]:active{
  transform: scale(0.97);
}
button:focus-visible,
[role="button"]:focus-visible{
  outline:2px solid var(--ink-d);
  outline-offset:2px;
}

input::placeholder,
textarea::placeholder{
  color: var(--placeholder-text);
}
#kwInput::placeholder{ color: var(--filter-placeholder-text); }
#filterModal #dateInput{ color: var(--filter-date-text); }
#filterModal input[type="text"]{ background:var(--dropdown-bg); }
#adminModal .textpicker,
#filterModal .textpicker{ background:var(--dropdown-bg); }
#adminModal .textpicker .text-popup select,
#adminModal .textpicker .text-popup input[type=color]{ background:var(--dropdown-bg); }

.field label{
  color: var(--dropdown-title);
}

select{
  background: var(--dropdown-bg);
  color: var(--dropdown-text);
  border-radius: var(--dropdown-radius);
}
.venue-select{
  color: var(--dropdown-venue-text);
}
select option{
  background: var(--dropdown-bg);
  color: var(--dropdown-text);
}
select option:checked{
  background: var(--dropdown-selected-bg);
  color: var(--dropdown-selected-text);
}
select option:hover{
  background: var(--dropdown-hover-bg);
  color: var(--dropdown-hover-text);
}

  .header{
    height: var(--header-h);
    min-height: var(--header-h);
    max-height: var(--header-h);
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 20px;
    padding: 0 20px;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 20;
  }

  .logo{
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 800;
    letter-spacing: .4px;
    user-select: none;
    cursor: pointer;
    margin: 0 auto;
  }

.logo img{
  height: 48px;
  display: block;
}

.view-toggle{
  display: flex;
  gap: 8px;
}

.view-toggle button{
  border: 1px solid var(--btn);
  border-radius: 999px;
  padding: 10px 14px;
  background: var(--btn);
  color: var(--ink);
  font-weight: 600;
  cursor: pointer;
  transition: background .2s,border-color .2s;
}

#resultsToggle{
  position:absolute;
  left:20px;
  top:50%;
  transform:translateY(-50%);
  border:1px solid var(--btn);
  border-radius:999px;
  padding:10px 14px;
  background:var(--btn);
  color:var(--ink);
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:4px;
  transition:background .2s,border-color .2s;
}
#resultsToggle .btn-label{line-height:1;}
#resultsToggle svg{
  width:16px;
  height:16px;
  transition:transform .3s;
}
#resultsToggle[aria-pressed="false"] svg{
  transform:rotate(180deg);
}
@media (max-width:1000px){
  #resultsToggle{display:none;}
}

.view-toggle button[aria-current="page"],
.view-toggle button[aria-pressed="true"]{
}

/* Spin controls */
.range-wrap{
  display:flex;
  align-items:center;
  gap:8px;
}
#spinSpeedVal{
  min-width:40px;
  text-align:right;
}
  #spinType{
    display:flex;
    gap:10px;
    margin-top:6px;
  }
  #spinType label{
    display:flex;
    align-items:center;
    gap:4px;
    font-weight:600;
  }

.auth{
  display: flex;
  align-items: center;
  gap: 10px;
  margin-left: auto;
}

.auth button{
  border: 1px solid rgba(255,255,255,.6);
  border-radius: 999px;
  padding: 10px 14px;
  background: rgba(255,255,255,0.2);
  color: inherit;
  font-weight: 600;
  cursor: pointer;
  transition: background .2s;
}

.gear{
  width: 36px;
  height: 36px;
  border-radius: 10px;
  background: rgba(255,255,255,0.2);
  display: grid;
  place-items: center;
  border:1px solid rgba(255,255,255,0.4);
  color: #fff;
}

.gear svg{
  width: 18px;
  height: 18px;
  opacity: .9;
}

.modal{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:transparent;
  display:none;
  z-index:2000;
  pointer-events:none;
}
.modal.show{display:block;}
.modal-content{
  position:absolute;
  border-radius:8px;
  width:90%;
  max-width:600px;
  max-height:90%;
  display:flex;
  flex-direction:column;
  overflow:hidden;
  pointer-events:auto;
}
.modal-content .resizer{position:absolute;z-index:10;background:transparent;}
.modal-content .resizer.n{top:0;left:0;right:0;height:6px;cursor:n-resize;}
.modal-content .resizer.s{bottom:0;left:0;right:0;height:6px;cursor:s-resize;}
.modal-content .resizer.e{top:0;right:0;bottom:0;width:6px;cursor:e-resize;}
.modal-content .resizer.w{top:0;left:0;bottom:0;width:6px;cursor:w-resize;}
.modal-content .resizer.ne{top:0;right:0;width:10px;height:10px;cursor:ne-resize;}
.modal-content .resizer.nw{top:0;left:0;width:10px;height:10px;cursor:nw-resize;}
.modal-content .resizer.se{bottom:0;right:0;width:10px;height:10px;cursor:se-resize;}
.modal-content .resizer.sw{bottom:0;left:0;width:10px;height:10px;cursor:sw-resize;}
.modal-body{
  flex:1 1 auto;
  overflow:auto;
  padding:0 20px 20px;
  overscroll-behavior:contain;
}
.admin-fieldset{
  margin:10px 0;
  border:1px solid var(--btn);
  border-radius:8px;
  padding:10px;
}
.admin-fieldset legend{cursor:pointer;display:flex;align-items:center;justify-content:space-between;}
.admin-fieldset legend .fs-toggle{margin-left:8px;padding:2px 6px;font-size:12px;}
.admin-fieldset.collapsed > *:not(legend):not(.fieldset-actions){display:none;}
#adminModal #styleControls{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-start;}
#adminModal .admin-fieldset{
  flex:1 1 250px;
  min-width:250px;
  max-width:none;
}
  #adminModal .modal-content,
  #memberModal .modal-content{
    width:600px;
    max-width:90%;
    max-height:90%;
  }

  #memberModal .modal-content{
    background:rgba(0,0,0,0.7);
    color:#fff;
  }
#filterModal .modal-content{
  width:350px;
  max-width:600px;
  max-height:90%;
  background:rgba(0,0,0,0.7);
  color:#fff;
}

#filterModal button,
#filterModal .sq,
#filterModal .tiny,
#filterModal .btn,
#adminModal button,
#adminModal #spinType span,
#memberModal button{
  background: var(--btn);
  border: 1px solid var(--btn);
  color: var(--button-text);
}
#filterModal button:hover,
#filterModal .sq:hover,
#filterModal .tiny:hover,
#filterModal .btn:hover,
#adminModal button:hover,
#adminModal #spinType span:hover,
#memberModal button:hover{
  background: var(--btn-hover);
  border-color: var(--btn-hover);
  color: var(--button-hover-text);
}
#filterModal button:active,
#filterModal .sq:active,
#filterModal .tiny:active,
#filterModal .btn:active,
#adminModal button:active,
#adminModal #spinType span:active,
#memberModal button:active{
  background: var(--btn-active);
  border-color: var(--btn-active);
}
#filterModal input[type="text"]{
  background: var(--modal-bg);
  color: var(--modal-text);
}
#filterModal .litepicker [role="button"]{
  background: initial;
  color: initial;
  border: none;
}
#filterModal .litepicker [role="button"]:hover{
  background: initial;
  color: initial;
  border: none;
}
#memberModal #mLocation .mapboxgl-ctrl-geocoder{width:100%;}
#memberModal input[type=color]{
  border-radius:4px;
  padding:0;
  height:40px;
  display:block;
}
#welcomeBody{
  display:flex;
  flex-direction:column;
  align-items:center;
  text-align:center;
}
#welcomeBody img{
  max-width:400px;
  max-height:300px;
  width:auto;
  height:auto;
  margin-bottom:10px;
}
#memberModal .location-info{margin-top:4px;font-size:13px;}
  @media (max-width:600px){
  #adminModal .modal-content,
  #memberModal .modal-content,
  #filterModal .modal-content{
    width:95%;
    max-width:95%;
    max-height:95%;
  }
}
#adminModal legend{font-weight:600;padding:0 6px;display:flex;align-items:center;justify-content:flex-start;cursor:pointer;user-select:none;}
#adminModal .fieldset-actions{display:flex;gap:4px;margin:4px 6px;}
#adminModal .fieldset-actions .same-btn{flex:1 1 0;padding:6px;}
#adminModal .control-row{display:flex;align-items:center;gap:6px;margin-bottom:6px;}
#adminModal .control-row label{min-width:80px;font-size:12px;cursor:pointer;user-select:none;}
#adminModal .color-group{
  flex:1 1 220px;
  width:100%;
  max-width:220px;
  display:flex;
  flex-direction:column;
  align-items:stretch;
  position:relative;
  margin-left:auto;
}
#adminModal .shadow-group{
  flex:1 1 220px;
  width:100%;
  max-width:220px;
  display:flex;
  gap:4px;
  align-items:center;
}
#adminModal .shadow-group input[type=color]{
  width:40px;
  height:40px;
  padding:0;
  border-radius:4px;
}
#adminModal .shadow-group input[type=number]{
  flex:1 1 0;
}
#adminModal .textpicker{
  flex:1 1 220px;
  max-width:220px;
  position:relative;
}
#adminModal .textpicker .text-preview{
  width:100%;
  height:40px;
  border-radius:8px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}
#adminModal .textpicker .text-popup{
  display:none;
  position:absolute;
  top:44px;
  left:0;
  z-index:20;
  background:#fff;
  border:1px solid #ccc;
  border-radius:8px;
  padding:8px;
  width:220px;
}
#adminModal .textpicker.open .text-popup{display:block;}
#adminModal .textpicker .text-popup select,
#adminModal .textpicker .text-popup input[type=color]{
  width:100%;
  margin-top:4px;
  border-radius:var(--dropdown-radius);
  padding:4px;
  box-sizing:border-box;
}
#adminModal .textpicker .text-popup input[type=color]{height:40px;padding:0;}
#adminModal .textpicker .text-popup .shadow-group{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:4px;
  margin-top:4px;
}
#adminModal .textpicker .text-popup .shadow-group input[type=color],
#adminModal .textpicker .text-popup .shadow-group input[type=number]{
  width:100%;
  height:40px;
  border-radius:var(--dropdown-radius);
  padding:0;
  box-sizing:border-box;
}
#adminModal .admin-fieldset input,
#adminModal .admin-fieldset select{
  width:100%;
  max-width:220px;
}
#adminModal .control-row select{
  flex:1 1 220px;
  width:100%;
  max-width:220px;
  margin-left:auto;
  border-radius:var(--dropdown-radius);
  padding:4px;
}
#adminModal .color-group input[type=color],
#adminModal .color-group input[type=range]{
  width:100%;
}
#adminModal .color-group input[type=color]{
  border-radius:4px;
  padding:0;
  height:40px;
  display:block;
  cursor:pointer;
  pointer-events:auto;
}
#adminModal .tab-bar{display:flex;gap:6px;}
#adminModal .tab-bar button{
  flex:1;
  padding:6px 10px;
  border-radius:6px;
  background:var(--btn);
  border:1px solid var(--btn);
  color:var(--button-text);
  cursor:pointer;
}
#adminModal .tab-bar button[aria-selected="true"]{
  background:var(--btn-hover);
  border-color:var(--btn-hover);
  color:var(--button-hover-text);
  font-weight:600;
}
#adminModal .tab-panel{display:none;}
#adminModal .tab-panel.active{display:flex;flex-direction:column;align-items:flex-start;gap:12px;}
#adminModal .marker-grid{display:flex;flex-direction:column;gap:8px;}
#adminModal .marker-grid select{min-width:120px;}
#adminModal .marker-options{display:flex;gap:8px;align-items:center;}
#adminModal .marker-set{display:grid;grid-template-columns:repeat(10,max-content);gap:4px;}
#adminModal .marker-set svg.shadow{filter:drop-shadow(2px 2px 2px rgba(0,0,0,0.5));}
#adminModal .marker-set svg.outline *{stroke:#000;stroke-width:1;}
#adminModal input[type=range]{width:100%;}
#adminModal .preset-actions{display:flex;gap:6px;margin:6px 0;}
#adminModal .preset-actions input{flex:1;padding:6px;border-radius:4px;}
#adminModal .preset-actions button{padding:6px 10px;}
.modal-field{
  margin:8px 0;
  display:flex;
  flex-direction:column;
}
#adminModal .modal-field{margin:0;max-width:320px;}
#baseColorRow{
  flex-direction:row;
  align-items:center;
  gap:10px;
}
#baseColorRow .history-group{display:flex;gap:6px;}
.preset-select{
  display:flex;
  align-items:center;
  gap:6px;
}
.modal-field input,
.modal-field textarea,
.modal-field select{
  padding:8px;
  border-radius:var(--dropdown-radius);
  border:none;
  width:100%;
  max-width:100%;
}
.modal-actions{
  margin-top:10px;
  display:flex;
  gap:10px;
}
.modal-header{
  position:sticky;
  top:0;
  padding:10px 20px;
  border-top-left-radius:8px;
  border-top-right-radius:8px;
  z-index:1;
  cursor:move;
  display:flex;
  flex-direction:column;
  gap:10px;
  flex-shrink:0;
}
.modal-header .header-top{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.modal-header .modal-actions{
  margin-top:0;
}
.modal-header h2{
  margin:0;
}
.palette{
  display:flex;
  gap:10px;
  margin-bottom:10px;
}
.field-item,
.field-instance{
  padding:6px 10px;
  border:1px solid #ccc;
  border-radius:4px;
  background:#f9f9f9;
  cursor:move;
}
.builder-zone{
  min-height:100px;
  border:2px dashed #ccc;
  padding:10px;
}
.field-instance{margin:4px 0;}


.filters-col{
  display: flex;
  flex-direction: column;
  min-height: 0;
}

.left-tools{
  display: flex;
  gap: 8px;
  margin-bottom: 8px;
  padding-left: 2px;
}

.sq{
  width: 30px;
  height: 30px;
  border-radius: 8px;
  background: var(--btn);
  display: grid;
  place-items: center;
  border: 1px solid var(--btn);
}

.sq svg{
  width: 14px;
  height: 14px;
  opacity: .9;
}


.field{
  display: grid;
  grid-template-columns: 1fr 38px;
  gap: 8px;
  align-items: center;
  margin: 8px 0;
}

.field .input{
  position: relative;
  display: flex;
  align-items: center;
  gap: 6px;
}

.input input,.input select{
  flex: 1;
  width: 100%;
  height: 40px;
  border: none;
  padding: 0 12px;
  outline: 0;
}
.input input{
  border-radius: 12px;
  background: var(--btn);
  color: var(--ink);
}
.input select{
  border-radius: var(--dropdown-radius);
}

.input .x,.input .down{
  position: static;
  width: 26px;
  height: 26px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--btn);
  cursor: pointer;
  border: 1px solid var(--btn);
}
.input .x{
  margin-left: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
}
.input .x.active{
  background: red;
  border-color: red;
  color: #fff;
}

#filterModal .field label.t{
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  gap: 6px;
}

.tiny{
  display: grid;
  place-items: center;
  width: 38px;
  height: 40px;
  border-radius: 12px;
  background: var(--btn);
  cursor: pointer;
  border: 1px solid var(--btn);
}

.tiny svg{
  width: 18px;
  height: 18px;
}


.cats{
  margin-top: 10px;
}

.cat{
  display: grid;
  grid-template-columns: 1fr 38px;
  gap: 8px;
  align-items: center;
  margin: 8px 0;
}

.cat .bar{
  height: 36px;
  border-radius: 12px;
  padding-left: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--btn);
  border: 1px solid var(--btn);
  cursor: pointer;
}

.cat .bar .dot{
  width: 18px;
  height: 18px;
  border-radius: 50%;
  display: grid;
  place-items: center;
  background: var(--btn);
  border: 1px solid var(--btn);
}

.cat .bar .label{
  font-weight: 700;
  letter-spacing: .2px;
}

.cat .cfg{
  display: grid;
  place-items: center;
  width: 38px;
  height: 36px;
  border-radius: 12px;
  background: var(--btn);
  border: 1px solid var(--btn);
  cursor: pointer;
}

.sub{
  margin: 6px 0 0 6px;
  display: none;
  grid-template-columns: 1fr;
  gap: 6px;
}

.sub .chip{
  height: 28px;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 0 10px;
  border-radius: 999px;
  background: var(--btn);
  border: 1px solid var(--btn);
  font-size: 12px;
  color: var(--ink-d);
  width: max-content;
  cursor: pointer;
}


.cat[aria-expanded="true"] .sub{
  display: grid;
}

.reset-box{
  display: grid;
  grid-template-columns: 1fr 38px;
  gap: 8px;
  align-items: center;
  margin-top: 10px;
}

.reset-box .btn{
  height: 36px;
  border-radius: 999px;
  background: var(--btn);
  border: 1px solid var(--btn);
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 0 14px;
  font-weight: 700;
  letter-spacing: .2px;
  color: var(--ink);
  cursor: pointer;
}

.reset-box .btn svg{
  width: 16px;
  height: 16px;
}

.reset-box .arr{
  display: grid;
  place-items: center;
  width: 38px;
  height: 36px;
  border-radius: 12px;
  background: var(--btn);
  border: 1px solid var(--btn);
}

.results-col{
  position: fixed;
  top: calc(var(--header-h) + var(--subheader-h));
  bottom: var(--footer-h);
  left: 0;
  width: var(--results-w);
  display: flex;
  flex-direction: column;
  padding: 0;
  transition: width .3s ease, padding .3s ease;
  z-index: 2;
  pointer-events: auto;
}

body.hide-results .results-col{
  width: 0;
  padding: 0;
  overflow: hidden;
}

.subheader{
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: 8px;
  color: var(--ink-d);
  grid-column: 1 / -1;
  height: var(--subheader-h);
  min-height: var(--subheader-h);
  max-height: var(--subheader-h);
  padding: 14px 20px;
  position: fixed;
  top: var(--header-h);
  left: 0;
  right: 0;
  z-index: 3;
  pointer-events: auto;
}

#filterBtn{
  border-radius: var(--dropdown-radius);
  display:grid;
  place-items:center;
  height:32px;
  width:32px;
  padding:0;
}
#filterBtn svg{width:20px;height:20px;display:block;}
#optionsBtn{height:32px;}

#filterBtn.active{
  background:var(--filter-btn-active);
  border-color:var(--filter-btn-active);
  color:#fff;
}

.options-dropdown{ position:relative; }
.options-menu{ position:absolute; top:calc(100% + 4px); left:0; background:var(--dropdown-bg); color:var(--dropdown-text); border:1px solid var(--border); border-radius:var(--dropdown-radius); padding:10px; display:flex; flex-direction:column; gap:6px; box-shadow:0 2px 6px rgba(0,0,0,0.2); z-index:30; }
.options-menu[hidden]{ display:none; }
.options-menu label{ display:flex; align-items:center; gap:6px; white-space:nowrap; }

.res-list{
  overflow: auto;
  flex: 1;
  min-height: 0;
  scrollbar-gutter: stable;
  height: calc(100vh - var(--header-h) - var(--subheader-h) - var(--footer-h));
}

.card{
  display: grid;
  grid-template-columns:90px 1fr 36px;
  gap:12px;
  align-items: flex-start;
  background: var(--list-background);
  border: 1px solid var(--border);
  border-radius:16px;
  padding:12px;
  margin-bottom:12px;
  cursor:pointer;
}

.thumb{
  width: 90px;
  height: 70px;
  border-radius: 12px;
  object-fit: cover;
  display: block;
  background: var(--modal-bg);
}

.meta{
  display: flex;
  flex-direction: column;
  gap: 6px;
  min-width: 0;
}

.title{
  margin: 0;
  font-weight: 900;
  line-height: 1.2;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

.info{
  display: flex;
  gap: 16px;
  align-items: center;
  font-size: 13px;
  min-width: 0;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

.res-list .info{
  flex-direction: column;
  align-items: flex-start;
  gap: 4px;
}

.res-list .info > div{
  display: flex;
  align-items: center;
  gap: 4px;
}

.badge{
  width: 18px;
  height: 18px;
  border-radius: 50%;
  display: inline-grid;
  place-items: center;
  background: #0e2540;
  border: 1px solid rgba(255,255,255,.1);
  font-size: 11px;
}

.fav{
  width: 36px;
  height: 36px;
  border-radius: 12px;
  display: grid;
  place-items: center;
  background: var(--btn);
  border: 1px solid var(--btn);
}

.fav svg{
  width: 18px;
  height: 18px;
  fill: none;
  stroke: var(--gold);
  stroke-width: 1.5;
}

.fav[aria-pressed="true"] svg{
  fill: var(--gold);
  stroke: var(--gold);
}

#favToggle{
  display:flex;
  align-items:center;
  gap:6px;
  white-space:nowrap;
}
#favToggle svg{
  width:18px;
  height:18px;
  fill:none;
  stroke:var(--gold);
  stroke-width:1.5;
}
#favToggle[aria-pressed="true"] svg{
  fill:var(--gold);
  stroke:var(--gold);
}



#map{
  position: absolute;
  inset: 0;
}

.map-overlay{
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
  display: grid;
  place-items: center;
  color: #fff;
  font-weight: 700;
  letter-spacing: .5px;
  opacity: .15;
  pointer-events: none;
}

.geocoder{position:absolute;top:auto;left:50%;transform:translateX(-50%);z-index:10;min-width:240px;max-width:300px;width:100%;display:flex;gap:4px;pointer-events:auto;}
.geocoder .mapboxgl-ctrl-geocoder{flex:1;position:relative;height:32px;min-width:240px !important;padding:0;}
.geocoder .mapboxgl-ctrl-geocoder--suggestions,
.geocoder .mapboxgl-ctrl-geocoder .suggestions{top:32px;}
.geocoder .mapboxgl-ctrl-geocoder input{height:100%;line-height:32px;padding:0 30px;font-size:14px;}
.geocoder .mapboxgl-ctrl-geocoder--button,
.geocoder .mapboxgl-ctrl-geocoder--icon{color:var(--text);position:absolute;top:50%;transform:translateY(-50%);display:block;}
.geocoder .mapboxgl-ctrl-geocoder--icon{left:8px;}
.geocoder .mapboxgl-ctrl-geocoder--button{right:8px;}

.mapboxgl-ctrl-geocoder,
.mapboxgl-ctrl-geolocate,
.mapboxgl-ctrl-compass{
  background:#fff;
  border:1px solid #fff;
  padding:0;
}

.mapboxgl-ctrl-geolocate,
.mapboxgl-ctrl-compass{
  display:flex;
  align-items:center;
  justify-content:center;
}

.mapboxgl-ctrl-geolocate .mapboxgl-ctrl-icon,
.mapboxgl-ctrl-compass .mapboxgl-ctrl-compass-arrow{
  margin:0;
}
@media (max-width:1000px){.geocoder{position:static;left:auto;transform:none;margin-left:auto;flex:1;}}



.closed-posts{
  display:none;
  position: fixed;
  top: calc(var(--header-h) + var(--subheader-h));
  bottom: var(--footer-h);
  left: var(--results-w);
  right: 0;
  overflow:auto;
  padding:0;
  color:#000;
  background:rgba(0,0,0,0.7);
}
.closed-posts .card{background:var(--list-background);}
.closed-posts button{background:var(--btn);border-color:var(--btn);color:var(--ink);}
.closed-posts .open-posts{margin-top:0}

body.hide-results .closed-posts{
  left:0;
}

.mode-posts .closed-posts{
  display: block;
  z-index: 1;
  pointer-events: auto;
}

.mode-map .closed-posts{
  display: none;
}
.map-area{
  position: fixed;
  top: var(--header-h);
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 0;
}


.open-posts{
  border:1px solid var(--border);
  border-radius:18px;
  margin:0 0 12px 0;
  overflow:visible;
}

.open-posts .detail-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:8px 12px;
  border-top-left-radius:inherit;
  border-top-right-radius:inherit;
}
.open-posts-sticky-header .open-posts .detail-header{
  position:sticky;
  top:0;
  z-index:3;
  background:var(--list-background);
}

.open-posts .body{
  padding:14px;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:flex-start;
}

.open-posts .text{
  margin-top:0;
  flex:1 1 300px;
}

.open-posts .img-area{
  display:flex;
  flex-direction:column;
  gap:8px;
  flex:0 0 400px;
}

.open-posts-sticky-images .open-posts .img-area{
  position:sticky;
  top:calc(var(--header-h) + 8px);
  align-self:start;
}

.open-posts .img-box{
  width:400px;
  height:400px;
  overflow:hidden;
  border:1px solid var(--border);
  border-radius:18px;
  flex-shrink:0;
  cursor:pointer;
  background:var(--list-background);
}

.open-posts .img-box img{
  width:100%;
  height:100%;
  object-fit:contain;
  display:block;
}

.open-posts .thumb-column{
  display:flex;
  flex-direction:row;
  width:400px;
  height:auto;
  overflow-x:auto;
  gap:4px;
}

.open-posts .thumb-column img{
  width:50px;
  height:50px;
  object-fit:cover;
  border:1px solid var(--border);
  border-radius:8px;
  cursor:pointer;
}

.open-posts .detail-header .title{
  margin:0;
  font-size:20px;
  line-height:1.2;
}

.open-posts .detail-header .title-block{
  display:flex;
  flex-direction:column;
}

.open-posts .detail-header .cat-line{
  font-size:14px;
  margin-top:4px;
  display:flex;
  align-items:center;
  gap:4px;
}

.open-posts .meta{
  font-size:13px;
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}


.open-posts .location-section{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:0;
  margin-bottom:var(--gap);
}

.open-posts .location-section .map-container{
  display:flex;
  flex-direction:column;
  gap:4px;
  width:100%;
  max-width:400px;
}

.open-posts .post-map{
  width:100%;
  max-width:400px;
  border:1px solid var(--border);
  border-radius:8px;
}


.open-posts .venue-dropdown,
.open-posts .session-dropdown{
  position:relative;
  width:100%;
  max-width:400px;
}



.open-posts .venue-dropdown > button{
  width:100%;
  height:50px;
  background:var(--btn);
  border:1px solid var(--btn);
  border-radius:var(--dropdown-radius);
  text-align:left;
  padding:4px 8px;
  color:var(--button-text);
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  justify-content:center;
}

.open-posts .session-dropdown > button{
  width:100%;
  height:50px;
  background:var(--btn);
  border:1px solid var(--btn);
  border-radius:var(--dropdown-radius);
  text-align:left;
  padding:4px 8px;
  color:var(--button-text);
  display:flex;
  align-items:center;
}


.open-posts .venue-dropdown > button .venue-name{
  font-weight:bold;
  display:block;
}

.open-posts .venue-dropdown > button .venue-address{
  display:block;
}

.open-posts .venue-menu button .venue-name{
  font-weight:bold;
  display:block;
}

.open-posts .venue-menu button .venue-address{
  display:block;
}

.open-posts .venue-menu,
.open-posts .session-menu{
  position:absolute;
  top:calc(100% + 4px);
  left:0;
  width:100%;
  max-height:400px;
  overflow-y:auto;
  background:var(--dropdown-bg);
  border:1px solid var(--border);
  border-radius:var(--dropdown-radius);
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:6px;
  box-shadow:0 2px 6px rgba(0,0,0,0.2);
  z-index:30;
}

.open-posts .venue-menu[hidden],
.open-posts .session-menu[hidden]{display:none;}

.open-posts .venue-menu button{
  width:100%;
  height:50px;
  background:var(--btn);
  border:1px solid var(--btn);
  border-radius:var(--dropdown-radius);
  text-align:left;
  padding:4px 8px;
  color:var(--button-text);
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  justify-content:center;
}

.open-posts .session-menu button{
  width:100%;
  height:50px;
  background:var(--btn);
  border:1px solid var(--btn);
  border-radius:var(--dropdown-radius);
  text-align:left;
  padding:4px 8px;
  color:var(--button-text);
  display:flex;
  align-items:center;
}


.open-posts .venue-menu button.selected,
.open-posts .session-menu button.selected{
  background:var(--dropdown-selected-bg);
  color:var(--dropdown-selected-text);
}

.open-posts .venue-menu button:hover,
.open-posts .session-menu button:hover{
  background:var(--dropdown-hover-bg);
  color:var(--dropdown-hover-text);
}
.open-posts .session-menu button .session-time,
.open-posts .session-dropdown > button .session-time{
  margin-left:8px;
  padding-right:0;
}
.options-dropdown>button{
  position:relative;
  padding:10px;
}
.options-dropdown>button .dropdown-arrow{
  position:absolute;
  right:8px;
  top:50%;
  transform:translateY(-50%);
  transition:transform .2s;
}
.options-dropdown>button[aria-expanded="true"] .dropdown-arrow{
  transform:translateY(-50%) rotate(180deg);
}
.options-dropdown.single>button{
  padding-right:8px;
}
.options-dropdown.single>button .dropdown-arrow{
  display:none;
}


.open-posts .location-section .calendar-container{
  display:flex;
  flex-direction:column;
  gap:4px;
  width:100%;
  max-width:400px;
}


.open-posts .post-calendar{
  width:100%;
  overflow:hidden;
  position:relative;
  display:flex;
  justify-content:center;
}

.open-posts .post-calendar .litepicker{
  font-size:16px;
  width:100%;
  max-width:400px;
  margin:0 auto;
  box-sizing:border-box;
  display:block;
}

.open-posts .post-calendar .container__months{
  display:block;
}

.open-posts .post-calendar .container__months .month-item{
  width:100%;
}

.open-posts .post-calendar .litepicker-day.is-highlighted{
  background:var(--session-available);
  color:var(--button-hover-text);
  border-radius:4px;
}

.open-posts .post-calendar .litepicker-day.is-selected,
.open-posts .post-calendar .litepicker-day.is-start-date.is-end-date{
  background:var(--session-selected);
  color:var(--button-text);
  border-radius:4px;
}

.open-posts .post-calendar .selected-month-name{
  background:var(--accent);
  color:var(--button-hover-text);
  border-radius:4px;
  padding:0 4px;
}

.open-posts .post-calendar .time-popup{
  position:absolute;
  inset:0;
  background:var(--modal-bg);
  display:flex;
  align-items:center;
  justify-content:center;
}

.open-posts .post-calendar .time-popup .time-list{
  background:var(--dropdown-bg);
  color:var(--dropdown-text);
  padding:8px;
  border-radius:4px;
  display:flex;
  flex-direction:column;
  gap:4px;
}

.open-posts .post-calendar .time-popup .time-list button{
  background:var(--btn);
  border:1px solid var(--btn);
  color:var(--button-text);
  border-radius:4px;
  padding:6px 10px;
  cursor:pointer;
}

.open-posts .venue-info{margin-top:4px;font-size:inherit;}

.open-posts .session-info{margin-top:8px;font-size:inherit;}



.img-modal{
  position:fixed;
  inset:0;
  background:var(--modal-bg);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:1000;
}
.img-modal img{
  max-width:90vw;
  max-height:90vh;
  cursor:pointer;
}

.pill{
  border: 1px solid var(--btn);
  background: var(--btn);
  border-radius: 999px;
  padding: 8px 12px;
  font-weight: 700;
  cursor: pointer;
}

.close{
  border: 0;
  background: #16283f;
  border-radius: 10px;
  padding: 8px 12px;
  cursor: pointer;
}

.dates{
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 4px;
}

.date{
  background: var(--btn);
  border: 1px solid var(--btn);
  border-radius: 999px;
  padding: 6px 10px;
  font-size: 12px;
}

.desc{
  margin-top: 8px;
}

@media (max-width:1000px){
  .results-col{width:100%;}
  .closed-posts{left:0;}
}

@media (max-width:840px){
  .open-posts .body{
    flex-direction:column;
  }
  .open-posts .text .location-section{
    order:-1;
  }
  .open-posts .img-box,
  .open-posts .location-section .map-container,
  .open-posts .location-section .calendar-container,
  .open-posts .post-map,
  .open-posts .post-calendar,
  .open-posts .venue-dropdown,
  .open-posts .session-dropdown{
    max-width:100%;
    width:100%;
  }
  .open-posts .venue-dropdown,
  .open-posts .session-dropdown{
    display:block;
  }
}

footer{
  height: var(--footer-h);
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 14px;
  background: var(--list-background);
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 10;
}

.foot-row{
  overflow-x: auto;
  overflow-y: hidden;
  white-space: nowrap;
  display: flex;
  gap: 8px;
  width: 100%;
}


.chip-small{
  flex: 0 0 auto;
  max-width: 240px;
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--btn);
  border-radius: 12px;
  padding: 6px 10px;
  font-size: 12px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  cursor: pointer;
}

footer .foot-row .foot-item{
  background:var(--list-background);
  border:1px solid var(--border);
}

.chip-small img.mini{
  width: 26px;
  height: 20px;
  border-radius: 6px;
  object-fit: cover;
  flex: 0 0 auto;
  display: block;
  background: var(--btn);
}

.chip-small .t{
  overflow: hidden;
  text-overflow: ellipsis;
}

.card,
footer .foot-row .foot-item,
.mapboxgl-popup.hover-pop .hover-card{
  transition: filter .2s, box-shadow .2s;
}

.card:hover,
footer .foot-row .foot-item:hover,
.mapboxgl-popup.hover-pop .hover-card:hover{
  filter: brightness(1.05);
}

.card.selected,
.card[aria-selected="true"],
footer .foot-row .foot-item.selected,
footer .foot-row .foot-item[aria-selected="true"],
.mapboxgl-popup.hover-pop .hover-card.selected,
.mapboxgl-popup.hover-pop .hover-card[aria-selected="true"]{
  filter: brightness(0.95);
}

.card .thumb{
  flex: 0 0 90px;
  width: 90px;
  height: 70px;
  display: block;
  object-fit: cover;
  border-radius: 12px;
}

.closed-posts .card .thumb{
  flex-basis: 80px;
  width: 80px;
  height: 80px;
}

.card .meta{
  flex: 1 1 auto;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.card .fav{
  flex: 0 0 auto;
}

.hover-card{
  display: flex;
  gap: 10px;
  align-items: flex-start;
  max-width: 300px;
}

.hover-card img{
  width: 64px;
  height: 64px;
  object-fit: cover;
  border-radius: 8px;
  flex: 0 0 auto;
  display: block;
  background: var(--modal-bg);
}

.hover-card .t{
  font-weight: 800;
  font-size: 13px;
  line-height: 1.25;
  white-space: normal;
  word-break: break-word;
  overflow-wrap: anywhere;
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 3;
  overflow: hidden;
}

.hover-card .s{
  font-size: 12px;
  opacity: .8;
  margin-top: 2px;
  white-space: normal;
  word-break: break-word;
  overflow-wrap: anywhere;
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 1;
  overflow: hidden;
}

.mapboxgl-popup.hover-pop{
  pointer-events: auto;
}

.multi-hover h4{
  margin: 0 0 8px 0;
  font-size: 13px;
  color: var(--ink-d);
  font-weight: 700;
  letter-spacing: .3px;
}

.multi-list{
  max-height: 360px;
  overflow-y: auto;
  overflow-x: hidden;
  scrollbar-gutter: stable;
  padding: 2px 6px 2px 2px;
  box-sizing: border-box;
}

.multi-item{
  display: flex;
  gap: 8px;
  align-items: center;
  padding: 4px 6px;
  border-radius: 10px;
  cursor: pointer;
  min-width: 0;
}


.multi-item img{
  width: 64px;
  height: 44px;
  border-radius: 8px;
  object-fit: cover;
  display: block;
  background: var(--modal-bg);
  flex: 0 0 auto;
}

.multi-item .t{
  white-space: normal;
  overflow-wrap: anywhere;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  display: -webkit-box;
}

.multi-item .s{
  font-size: 12px;
  opacity: .8;
  margin-top: 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.multi-ctrls{
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  margin-top: 8px;
}

.multi-ctrls .hint{
  font-size: 12px;
  color: var(--ink-d);
}

.multi-ctrls .close{
  border: 0;
  background: #16283f;
  color: #fff;
  border-radius: 10px;
  padding: 6px 10px;
  cursor: pointer;
}

.multi-item > div{
  min-width: 0;
}

.multi-item .hover-card{
  width: 100%;
}

.hover-card > div{
  min-width: 0;
  flex: 1;
}

.multi-item .hover-card .t{
  max-width: none;
  white-space: nowrap;
  text-overflow: ellipsis;
  overflow: hidden;
}

.nowrap{
  white-space: nowrap;
}

.multi-hover .soonest{
  color: var(--ink-d);
  font-weight: 600;
}

.hero img.lqip{
  filter: blur(10px);
  transform: scale(1.02);
  transition: filter .22s ease, transform .22s ease;
}

.hero img.ready{
  filter: none;
  transform: none;
}

.hover-card img, .mapboxgl-popup .hover-card img{
  width: 64px;
  height: 64px;
  object-fit: cover;
  border-radius: 8px;
  flex: 0 0 auto;
  display: block;
  background: var(--modal-bg);
}

.foot-item img{
  width: 40px;
  height: 40px;
  object-fit: cover;
  border-radius: 8px;
}

img.thumb{
  width: 80px;
  height: 80px;
  object-fit: cover;
}

#results .card > img, #results .card img.thumb{
  width: 80px;
  height: 80px;
  aspect-ratio: 1/1;
  object-fit: cover;
  display: block;
}

footer .foot-row .foot-item > img, footer .foot-row .foot-item img{
  width: 40px;
  height: 40px;
  aspect-ratio: 1/1;
  object-fit: cover;
  display: block;
  border-radius: 8px;
}

footer .chip-small img.mini, footer .foot-row .foot-item img{
  width: 40px;
  height: 40px;
  object-fit: cover;
  border-radius: 8px;
}

} } .mapboxgl-popup.hover-pop.hover-multi-list{
  max-width: none;
}

.mapboxgl-popup.hover-pop.hover-multi-list .mapboxgl-popup-content{
  max-width: none;
  width: auto;
}

.mapboxgl-popup.hover-pop.hover-multi-list .multi-hover{
  width: auto;
  max-width: none;
}

.mapboxgl-popup.hover-pop:not(.hover-multi-list){
  max-width: 320px;
}

.multi-item .txt{
  min-width: 0;
}

.mapboxgl-popup.hover-pop .mapboxgl-popup-content{
  border-radius: 12px;
  padding: 6px 10px 6px 8px;
}

.mapboxgl-popup.hover-multi-list .mapboxgl-popup-content{
  width: auto;
  max-width: none;
}

.mapboxgl-popup.hover-multi-list .multi-hover{
  width: auto;
}

.mapboxgl-popup.hover-multi-list .multi-item .txt{
  min-width: 0;
}

.mapboxgl-popup.hover-multi-list .multi-item .t{
  white-space: normal;
  overflow-wrap: anywhere;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  display: -webkit-box;
}

.results-col .res-list{
  border-radius: inherit;
  padding-bottom: 0;
  margin-bottom: 0;
}

.post-panel{
  position: fixed;
  top: calc(var(--header-h) + var(--subheader-h));
  bottom: var(--footer-h);
  height: calc(100vh - var(--header-h) - var(--subheader-h) - var(--footer-h));
  left: 0;
  right: 0;
  z-index: 10;
  pointer-events: none;
}

.mode-posts #postsWide{
  border: none;
  background: transparent;
}

.mode-posts #postsWide .res-list{
  background: transparent;
}


</style>
<style id="theme-dark-transparency">
:root{--primary:#000000;--secondary:#000000;--accent:#000000;--button-hover-text:#000000;--btn:rgba(74,74,74,0.9);--btn-hover:rgba(0,0,0,1);--btn-active:rgba(0,0,0,1);--modal-bg:rgba(0,0,0,0.62);--modal-text:#000000;--scrollbar-track:rgba(0,0,0,0);--scrollbar-thumb:rgba(0,0,0,0.3);--scrollbar-thumb-hover:rgba(0,0,0,0.5);--list-background:rgba(0,0,0,0.37);--placeholder-text:#d1d1d1;--dropdown-title:#000000;--dropdown-selected-bg:rgba(224,224,224,1);--dropdown-selected-text:#000000;--dropdown-text:#000000;--dropdown-bg:rgba(255,255,255,1);--dropdown-hover-bg:rgba(224,224,224,1);--dropdown-hover-text:#000000;--border:rgba(173,173,173,0.31);--border-hover:rgba(255,136,0,0.43);--border-active:rgba(255,200,0,0.45);--session-available:#0000ff;--session-selected:#008000;}
.open-posts-sticky-header .open-posts .detail-header{position:sticky;top:0;z-index:3;background:var(--list-background);}
.header{background-color:rgba(41,41,41,1);}
.header{color:#ffffff;font-family:Verdana;font-size:16px;font-weight:normal;text-shadow:0px 0px 0px #000000;}
.header button{background-color:#292929;border-color:#292929;box-shadow:0 0 0px #000000;}
.header .gear{background-color:#292929;border-color:#292929;box-shadow:0 0 0px #000000;}
.header a{background-color:#292929;border-color:#292929;box-shadow:0 0 0px #000000;}
.header button{color:#ffffff;font-family:Verdana;font-size:12px;font-weight:normal;text-shadow:0px 0px 0px #000000;}
.header .gear{color:#ffffff;font-family:Verdana;font-size:12px;font-weight:normal;text-shadow:0px 0px 0px #000000;}
.header a{color:#ffffff;font-family:Verdana;font-size:12px;font-weight:normal;text-shadow:0px 0px 0px #000000;}
.subheader{background-color:rgba(0,0,0,0);}
.subheader{color:#ffffff;font-family:Verdana;font-size:12px;font-weight:normal;text-shadow:0px 0px 0px #000000;}
.subheader button{background-color:#292929;border-color:#292929;box-shadow:0 0 0px #000000;}
.subheader button{color:#ffffff;font-family:Verdana;font-size:14px;font-weight:normal;text-shadow:0px 0px 0px #000000;}
#main-tab-map[aria-selected="true"]{color:#ff0000;}
body{background-color:rgba(41,41,41,1);}
.results-col{position:fixed;top:calc(var(--header-h) + var(--subheader-h));bottom:var(--footer-h);left:0;width:var(--results-w);display:flex;flex-direction:column;padding:0;transition:width .3s ease, padding .3s ease;z-index:2;pointer-events:auto;}
body.hide-results .results-col{width:0;padding:0;overflow:hidden;}
.map-overlay{position:absolute;top:0;bottom:0;left:0;right:0;display:grid;place-items:center;color:#fff;font-weight:700;letter-spacing:.5px;opacity:.15;pointer-events:none;}
  .closed-posts{position:fixed;top:calc(var(--header-h) + var(--subheader-h));bottom:var(--footer-h);left:var(--results-w);right:0;display:none;overflow:auto;padding:0 6px 0 0;}
body.hide-results .closed-posts{left:0;}
.mode-posts .closed-posts{display:block;z-index:1;pointer-events:auto;}

  .post-panel{padding:0;pointer-events:none;}

.hide-map-calendar .open-posts .map-container,
.hide-map-calendar .open-posts .calendar-container{display:none;}
.hide-map-calendar .open-posts .venue-dropdown{margin-bottom:var(--gap);}
.res-list{background-color:rgba(0,0,0,0);}
.res-list .card{background-color:rgba(41,41,41,1);box-shadow:0 0 0px #000000;}
.res-list{color:#ffffff;font-family:Verdana;font-size:12px;font-weight:normal;text-shadow:0px 0px 0px #000000;}
.res-list .card .t{color:#ffffff;font-family:Verdana;font-size:16px;font-weight:bold;text-shadow:0px 0px 0px #000000;}
.res-list .card .title{color:#ffffff;font-family:Verdana;font-size:16px;font-weight:bold;text-shadow:0px 0px 0px #000000;}
.res-list button{background-color:#22343f;border-color:#22343f;box-shadow:0 0 0px #000000;}
.res-list .sq{background-color:#22343f;border-color:#22343f;box-shadow:0 0 0px #000000;}
.res-list .tiny{background-color:#22343f;border-color:#22343f;box-shadow:0 0 0px #000000;}
.res-list .btn{background-color:#22343f;border-color:#22343f;box-shadow:0 0 0px #000000;}
.res-list button{color:#ffffff;font-family:Verdana;font-size:14px;font-weight:normal;text-shadow:0px 0px 0px #000000;}
.res-list .sq{color:#ffffff;font-family:Verdana;font-size:14px;font-weight:normal;text-shadow:0px 0px 0px #000000;}
.res-list .tiny{color:#ffffff;font-family:Verdana;font-size:14px;font-weight:normal;text-shadow:0px 0px 0px #000000;}
.res-list .btn{color:#ffffff;font-family:Verdana;font-size:14px;font-weight:normal;text-shadow:0px 0px 0px #000000;}
.closed-posts{background-color:rgba(0,0,0,0);}
.closed-posts .card{background-color:rgba(0,0,0,0.52);box-shadow:0 0 0px #000000;}
.closed-posts .open-posts{background-color:rgba(0,0,0,0.52);box-shadow:0 0 0px #000000;}
.closed-posts{color:#ffffff;font-family:Verdana;font-size:12px;font-weight:normal;text-shadow:0px 0px 0px #000000;}
.closed-posts .res-list{color:#ffffff;font-family:Verdana;font-size:12px;font-weight:normal;text-shadow:0px 0px 0px #000000;}
.closed-posts .card .t{color:#ffffff;font-family:Verdana;font-size:16px;font-weight:bold;text-shadow:0px 0px 0px #000000;}
.closed-posts .card .title{color:#ffffff;font-family:Verdana;font-size:16px;font-weight:bold;text-shadow:0px 0px 0px #000000;}
.closed-posts .open-posts .t{color:#ffffff;font-family:Verdana;font-size:16px;font-weight:bold;text-shadow:0px 0px 0px #000000;}
.closed-posts .open-posts .title{color:#ffffff;font-family:Verdana;font-size:16px;font-weight:bold;text-shadow:0px 0px 0px #000000;}
.closed-posts button{background-color:#22343f;border-color:#22343f;box-shadow:0 0 0px #000000;}
.closed-posts button{color:#ffffff;font-family:Verdana;font-size:14px;font-weight:normal;text-shadow:0px 0px 0px #000000;}
.open-posts{background-color:rgba(0,0,0,0.52);box-shadow:0 0 0px #000000;}
.open-posts{color:#ffffff;font-family:Verdana;font-size:12px;font-weight:normal;text-shadow:0px 0px 0px #000000;}
.open-posts .t{color:#ffffff;font-family:Verdana;font-size:16px;font-weight:bold;text-shadow:0px 0px 0px #000000;}
.open-posts .title{color:#ffffff;font-family:Verdana;font-size:16px;font-weight:bold;text-shadow:0px 0px 0px #000000;margin:8px 0 4px;}
.open-posts button{background-color:#22343f;border-color:#22343f;box-shadow:0 0 0px #000000;}
.open-posts button{color:#ffffff;font-family:Verdana;font-size:14px;font-weight:normal;text-shadow:0px 0px 0px #000000;}
.open-posts .detail-header{background-color:#000000;}
.open-posts .img-box{background-color:#000000;}
footer{background-color:rgba(0,0,0,0);}
footer .foot-row .foot-item{background-color:rgba(0,0,0,0.32);box-shadow:0 0 0px #000000;}
footer{color:#ffffff;font-family:Verdana;font-size:12px;font-weight:normal;text-shadow:0px 0px 0px #000000;}
  .map-area{background-color:rgba(0,0,0,1);}
.mapboxgl-popup .mapboxgl-popup-content{background-color:rgba(0,0,0,1);box-shadow:0 0 0px #000000;}
.mapboxgl-popup .hover-card{background-color:rgba(0,0,0,1);box-shadow:0 0 0px #000000;}
.mapboxgl-popup .chip{background-color:rgba(0,0,0,1);box-shadow:0 0 0px #000000;}
.mapboxgl-popup .chip-small{background-color:rgba(0,0,0,1);box-shadow:0 0 0px #000000;}
.mapboxgl-popup .multi-item{background-color:rgba(0,0,0,1);box-shadow:0 0 0px #000000;}
.mapboxgl-popup .hover-card{color:#ffffff;font-family:Verdana;font-size:16px;font-weight:normal;text-shadow:0px 0px 0px #000000;}
.mapboxgl-popup .chip{color:#ffffff;font-family:Verdana;font-size:16px;font-weight:normal;text-shadow:0px 0px 0px #000000;}
.mapboxgl-popup .chip-small{color:#ffffff;font-family:Verdana;font-size:16px;font-weight:normal;text-shadow:0px 0px 0px #000000;}
.mapboxgl-popup .multi-item{color:#ffffff;font-family:Verdana;font-size:16px;font-weight:normal;text-shadow:0px 0px 0px #000000;}
.mapboxgl-popup .hover-card .t{color:#ffffff;font-family:Verdana;font-size:14px;font-weight:bold;text-shadow:0px 0px 0px #000000;}
.mapboxgl-popup .hover-card .title{color:#ffffff;font-family:Verdana;font-size:14px;font-weight:bold;text-shadow:0px 0px 0px #000000;}
.mapboxgl-popup .chip .t{color:#ffffff;font-family:Verdana;font-size:14px;font-weight:bold;text-shadow:0px 0px 0px #000000;}
.mapboxgl-popup .chip .title{color:#ffffff;font-family:Verdana;font-size:14px;font-weight:bold;text-shadow:0px 0px 0px #000000;}
.mapboxgl-popup .chip-small .t{color:#ffffff;font-family:Verdana;font-size:14px;font-weight:bold;text-shadow:0px 0px 0px #000000;}
.mapboxgl-popup .chip-small .title{color:#ffffff;font-family:Verdana;font-size:14px;font-weight:bold;text-shadow:0px 0px 0px #000000;}
.mapboxgl-popup .multi-item .t{color:#ffffff;font-family:Verdana;font-size:14px;font-weight:bold;text-shadow:0px 0px 0px #000000;}
.mapboxgl-popup .multi-item .title{color:#ffffff;font-family:Verdana;font-size:14px;font-weight:bold;text-shadow:0px 0px 0px #000000;}
#filterModal .modal-content{background-color:rgba(0,0,0,0.7);}
#filterModal .modal-content{color:#ffffff;font-family:Verdana;font-size:16px;font-weight:normal;text-shadow:0px 0px 0px #000000;}
#filterModal .modal-content .t{color:#ffffff;font-family:Verdana;font-size:10px;font-weight:normal;text-shadow:0px 0px 0px #000000;}
#filterModal .modal-content .title{color:#ffffff;font-family:Verdana;font-size:10px;font-weight:normal;text-shadow:0px 0px 0px #000000;}
#filterModal button{background-color:#601a7a;border-color:#601a7a;box-shadow:0 0 0px #000000;}
#filterModal .sq{background-color:#601a7a;border-color:#601a7a;box-shadow:0 0 0px #000000;}
#filterModal .tiny{background-color:#601a7a;border-color:#601a7a;box-shadow:0 0 0px #000000;}
#filterModal .btn{background-color:#601a7a;border-color:#601a7a;box-shadow:0 0 0px #000000;}
#filterModal button{color:#ffffff;font-family:Arial;font-weight:normal;text-shadow:0px 0px 0px #000000;}
#filterModal .sq{color:#ffffff;font-family:Arial;font-weight:normal;text-shadow:0px 0px 0px #000000;}
#filterModal .tiny{color:#ffffff;font-family:Arial;font-weight:normal;text-shadow:0px 0px 0px #000000;}
#filterModal .btn{color:#ffffff;font-family:Arial;font-weight:normal;text-shadow:0px 0px 0px #000000;}
#adminModal .modal-content{background-color:rgba(0,0,0,0.7);}
#adminModal .modal-content{color:#ffffff;font-family:Verdana;font-size:16px;font-weight:normal;text-shadow:0px 0px 0px #000000;}
#adminModal .modal-content .t{color:#ffffff;font-family:Verdana;font-size:10px;font-weight:normal;text-shadow:0px 0px 0px #000000;}
#adminModal .modal-content .title{color:#ffffff;font-family:Verdana;font-size:10px;font-weight:normal;text-shadow:0px 0px 0px #000000;}
#adminModal button{background-color:#165d6f;border-color:#165d6f;box-shadow:0 0 0px #000000;}
#adminModal #spinType span{background-color:#165d6f;border-color:#165d6f;box-shadow:0 0 0px #000000;}
#adminModal button{color:#ffffff;font-family:Arial;font-weight:normal;text-shadow:0px 0px 0px #000000;}
#adminModal #spinType span{color:#ffffff;font-family:Arial;font-weight:normal;text-shadow:0px 0px 0px #000000;}
#memberModal .modal-content{background-color:rgba(0,0,0,0.7);}
#memberModal .modal-content{color:#ffffff;font-family:Verdana;font-size:16px;font-weight:normal;text-shadow:0px 0px 0px #000000;}
#memberModal .modal-content .t{color:#ffffff;font-family:Verdana;font-size:10px;font-weight:normal;text-shadow:0px 0px 0px #000000;}
#memberModal .modal-content .title{color:#ffffff;font-family:Verdana;font-size:10px;font-weight:normal;text-shadow:0px 0px 0px #000000;}
#memberModal button{background-color:#16596a;border-color:#16596a;box-shadow:0 0 0px #000000;}
#memberModal button{color:#ffffff;font-family:Arial;font-weight:normal;text-shadow:0px 0px 0px #000000;}
.res-list{padding:12px;margin:0;}
.res-list .thumb{width:80px;height:80px;}
.closed-posts .res-list{height:100%;overflow:auto;padding:12px;margin:0;box-sizing:border-box;}
.closed-posts .thumb{width:80px;height:80px;}





</style>
<link id="theme-readable" rel="stylesheet" href="themes/readable.css" disabled>
</head>
<body class="mode-map" style="padding-bottom:var(--footer-h);">
  <header class="header" role="banner">
    <button id="resultsToggle" aria-pressed="true" aria-label="Toggle results list">
      <span class="btn-label">List</span>
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M15 6l-6 6 6 6" fill="none" stroke="currentColor" stroke-width="2"/></svg>
    </button>
    <div class="logo" aria-label="Site logo">
      <picture>
        <source media="(max-width:650px)" srcset="https://raw.githubusercontent.com/Zxen1/Events-Platform/refs/heads/main/assets/funmap%20logo%202011-09-30h.png">
        <img src="https://raw.githubusercontent.com/Zxen1/Events-Platform/refs/heads/main/assets/funmap-logo-2025-08-25.png" alt="FunMap.com logo" />
      </picture>
    </div>
    <nav class="view-toggle" aria-label="Primary" role="tablist"><button id="tab-posts" role="tab" aria-selected="false">Posts</button>
        <button id="main-tab-map" role="tab" aria-selected="true" aria-current="page">Map</button>
    </nav>
    <div class="auth">
      <button id="memberBtn" aria-label="Open members area">Members</button>
      <button id="adminBtn" aria-label="Open admin area">Admin</button>
    </div>
  </header>
  <div class="subheader">
    <button id="filterBtn" aria-label="Open filters modal"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 4h18l-7 8v6l-4 2v-8z" fill="currentColor"/></svg></button>
    <div class="options-dropdown">
      <button id="optionsBtn" aria-haspopup="true" aria-expanded="false">Title A - Z</button>
      <div id="optionsMenu" class="options-menu" hidden>
        <button id="favToggle" aria-pressed="false">Favourites on top<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 17.3 6.2 21l1.6-6.7L2 9.3l6.9-.6L12 2l3.1 6.7 6.9.6-5.8 4.9L17.8 21 12 17.3z"/></svg></button>
        <div class="sort-options" role="group" aria-label="Sort order" style="display:flex; flex-direction:column; gap:6px;">
          <button class="sort-option" data-sort="az" aria-pressed="true">Title A - Z</button>
          <button class="sort-option" data-sort="nearest" aria-pressed="false">Closest</button>
          <button class="sort-option" data-sort="soon" aria-pressed="false">Soonest</button>
        </div>
      </div>
    </div>
    <div id="resultCount" aria-live="polite"><strong>0</strong> Results</div>
    <div id="geocoder" class="geocoder"></div>
  </div>

  <section class="map-area" aria-label="Map">
    <div id="map"></div>
  </section>

  <section class="results-col" aria-label="Results">
    <div class="res-list" id="results"></div>
  </section>

  <section class="closed-posts" aria-label="Closed Posts">
    <div class="res-list" id="postsWide"></div>
  </section>

  <section class="post-panel" aria-label="Map Controls">
    <div class="map-overlay">Loading Map…</div>
  </section>

  <footer>
    <div id="footRow" class="foot-row" aria-label="Recently viewed posts"></div>
  </footer>

  <div id="filterModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div class="header-top">
          <h2>Filters</h2>
          <div class="modal-actions">
            <button type="button" class="move-left" aria-label="Move modal left">&lt;</button>
            <button type="button" class="move-right" aria-label="Move modal right">&gt;</button>
            <button type="button" class="close-modal">Close</button>
          </div>
        </div>
      </div>
      <div class="modal-body">
        <section class="filters-col" aria-label="Filters">
          <div>
            <h3>Keywords</h3>
            <div class="field">
              <div class="input"><input id="kwInput" type="text" placeholder="Search keywords" aria-label="Keywords" />
                <div class="x" role="button" aria-label="Clear keywords">X</div>
              </div>
            </div>

          <h3>Date Range</h3>
          <div class="field">
            <div class="input"><input id="dateInput" type="text" aria-label="Date range" readonly />
              <div class="x" role="button" aria-label="Clear date">X</div>
            </div>
          </div>
          <div class="field">
            <label class="t">Today Onwards <input id="todayToggle" type="checkbox" checked /></label>
          </div>
          <div id="datePicker"></div>

          <h3>Categories</h3>
          <div class="cats" id="cats"></div>

            <div class="reset-box">
              <div id="resetBtn" class="btn" role="button" aria-label="Reset all filters">
                Reset All Filters
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <div id="memberModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div class="header-top">
          <h2>Create Post</h2>
          <div class="modal-actions">
            <button type="submit" form="memberForm">Save</button>
            <button type="button" class="move-left" aria-label="Move modal left">&lt;</button>
            <button type="button" class="move-right" aria-label="Move modal right">&gt;</button>
            <button type="button" class="close-modal">Close</button>
          </div>
        </div>
      </div>
      <form id="memberForm" class="modal-body">
        <div class="modal-field">
          <label for="mTitle">Title</label>
          <input type="text" id="mTitle" required />
        </div>
        <div class="modal-field">
          <label for="mImage">Image</label>
          <input type="file" id="mImage" accept="image/*" />
        </div>
        <div class="modal-field">
          <label for="mDate">Date</label>
          <input type="date" id="mDate" />
        </div>
        <div class="modal-field">
          <label for="mLocation">Location</label>
          <div id="mLocation"></div>
          <div id="mLocationInfo" class="location-info"></div>
        </div>
        <div class="modal-field">
          <label for="mColor">Color</label>
          <input type="color" id="mColor" data-mode="hex" value="#000000" />
        </div>
      </form>
    </div>
  </div>

  <div id="adminModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div class="header-top">
          <h2>Admin Settings</h2>
          <div class="modal-actions">
            <button type="button" id="discardChanges">Discard Changes</button>
            <button type="button" id="saveNow">Save Now</button>
            <button type="button" class="move-left" aria-label="Move modal left">&lt;</button>
            <button type="button" class="move-right" aria-label="Move modal right">&gt;</button>
            <button type="button" class="close-modal">Close</button>
          </div>
        </div>
        <div class="tab-bar">
          <button type="button" class="tab-btn" data-tab="theme" aria-selected="true">Themes</button>
          <button type="button" class="tab-btn" data-tab="map">Map</button>
          <button type="button" class="tab-btn" data-tab="forms">Forms</button>
          <button type="button" class="tab-btn" data-tab="settings">Settings</button>
        </div>
      </div>
      <form id="adminForm" class="modal-body">
        <div id="tab-theme" class="tab-panel active">
          <div class="modal-field">
            <label for="themePreset">Preset Themes</label>
            <div class="preset-select">
              <select id="themePreset" style="width:250px"></select>
              <button type="button" id="refreshTheme">Refresh</button>
            </div>
          </div>
          <div class="preset-actions">
            <input id="newPresetName" type="text" placeholder="Name of your new theme" />
            <button type="button" id="savePreset">Save Theme</button>
            <button type="button" id="downloadCss">Download CSS</button>
          </div>
          <div class="modal-field" id="baseColorRow">
            <div class="history-group">
              <button type="button" id="undoBtn">Undo</button>
              <button type="button" id="redoBtn">Redo</button>
            </div>
            <div class="color-group">
              <input type="color" id="baseColor" value="#336699" />
            </div>
            <button type="button" id="autoBuildBtn">Auto Build</button>
          </div>
          <h3>Theme Builder</h3>
          <div id="styleControls"></div>
          <div class="modal-field">
            <label for="themeRestore">Restore Backup</label>
            <select id="themeRestore" style="width:250px"></select>
            <button type="button" data-restore="theme">Restore</button>
          </div>
        </div>
          <div id="tab-map" class="tab-panel">
            <div class="modal-field">
              <label for="mapTheme">Map Colour</label>
              <div style="display:flex;align-items:center;gap:4px;">
              <select id="mapTheme">
                <option value="mapbox://styles/mapbox/outdoors-v12">Outdoors</option>
                <option value="mapbox://styles/mapbox/streets-v12">Streets</option>
                <option value="mapbox://styles/mapbox/light-v11">Light</option>
                <option value="mapbox://styles/mapbox/dark-v11">Dark</option>
                <option value="mapbox://styles/mapbox/satellite-streets-v12">Satellite Streets</option>
                <option value="mapbox://styles/mapbox/satellite-v9">Satellite Only</option>
                <option value="mapbox://styles/mapbox/navigation-day-v1">Navigation Day</option>
                <option value="mapbox://styles/mapbox/navigation-night-v1">Navigation Night</option>
                  <option value="mapbox://styles/mapbox/standard" selected>Standard</option>
                  <option value="mapbox://styles/mapbox/satellite-streets-v12">Standard Satellite</option>
                <option value="mapbox://styles/mapbox/traffic-day-v2">Traffic Day</option>
                <option value="mapbox://styles/mapbox/traffic-night-v2">Traffic Night</option>
                  <option value="mapbox://styles/mapbox/terrain-v2">Terrain</option>
                  <option value="mapbox://styles/mapbox/light-v11">Standard Light</option>
                  <option value="mapbox://styles/mapbox/dark-v11">Standard Dark</option>
                <option value="mapbox://styles/mapbox/streets-v8">Streets Classic</option>
                <option value="mapbox://styles/mapbox/emerald-v8">Emerald</option>
                <option value="mapbox://styles/mapbox/wheatpaste-v9">Wheatpaste</option>
                <option value="mapbox://styles/mapbox/pencil-v2">Pencil</option>
                <option value="mapbox://styles/mapbox/vintage-v10">Vintage</option>
              </select>
              <button type="button" class="refresh-page-btn">Refresh</button>
              </div>
            </div>
            <div class="modal-field">
              <label for="skyTheme">Sky Colour</label>
              <div style="display:flex;align-items:center;gap:4px;">
              <select id="skyTheme">
                <option value="default">Default</option>
                <option value="sunset">Sunset</option>
                <option value="night" selected>Night</option>
                <option value="aurora">Aurora</option>
                <option value="dawn">Dawn</option>
                <option value="dusk">Dusk</option>
                <option value="space">Space</option>
                <option value="cloudy">Cloudy</option>
                <option value="storm">Storm</option>
                <option value="twilight">Twilight</option>
                <option value="sunrise">Sunrise</option>
                <option value="rainbow">Rainbow</option>
              </select>
              <button type="button" class="refresh-page-btn">Refresh</button>
              </div>
            </div>
            <div class="modal-field">
              <label for="spinSpeed">Spin speed</label>
              <div class="range-wrap">
                <input type="range" id="spinSpeed" min="0" max="1" step="0.01" />
                <span id="spinSpeedVal"></span>
                </div>
              </div>
              <div class="modal-field">
                <label for="mapPitch">Pitch</label>
                <div class="range-wrap">
                  <input type="range" id="mapPitch" min="0" max="85" step="1" />
                  <span id="pitchVal"></span>
                </div>
              </div>
              <div class="modal-field">
                <label for="mapBearing">Bearing</label>
                <div class="range-wrap">
                  <input type="range" id="mapBearing" min="-180" max="180" step="1" />
                  <span id="bearingVal"></span>
                </div>
              </div>
            <div class="modal-field">
              <div class="control-row">
                <label for="spinLoadStart">Spin on Load</label>
                <input type="checkbox" id="spinLoadStart" checked />
              </div>
              <div id="spinType">
                <label for="spinTypeAll"><input type="radio" id="spinTypeAll" name="spinType" value="all" checked /> Everyone</label>
                <label for="spinTypeNew"><input type="radio" id="spinTypeNew" name="spinType" value="new" /> New Users</label>
              </div>
            </div>
            <div class="modal-field">
              <div class="control-row">
                <label for="spinLogoClick">Spin on Logo</label>
                <input type="checkbox" id="spinLogoClick" checked />
              </div>
            </div>
            <div class="modal-field">
              <label for="mapRestore">Restore Backup</label>
              <select id="mapRestore"></select>
              <button type="button" data-restore="map">Restore</button>
            </div>
            <div class="modal-field" id="balloonField">
              <div id="balloonTool">
                <style>
                  #balloonField{max-width:none;width:100%;height:100%;}
                  #balloonTool { padding: 10px; width:100%; height:100%; max-width:none; max-height:none; }
                  #balloonTool .admin-fieldset{ flex:1 1 auto; width:100%; min-width:0; max-width:none; height:100%; }
                  #balloonTool .shape-buttons { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; }
                  #balloonTool .shape-button { display: flex; align-items: center; gap: 4px; padding: 4px; border: 1px solid var(--secondary); background: var(--secondary); color: var(--button-text); cursor: pointer; border-radius:6px; transition: background .2s,border-color .2s,color .2s; }
                  #balloonTool .shape-button:hover { background: var(--accent); border-color: var(--accent); color: var(--button-hover-text); }
                  #balloonTool .shape-button svg { width: 24px; height: 24px; }
                  #balloonTool .shape-button.active { outline: 2px solid var(--accent); }
                  #balloonTool .size-control { margin-bottom: 8px; }
                  #balloonTool .svg-output { display:flex; gap:8px; margin-bottom:8px; }
                  #balloonTool .svg-output textarea{ flex:1; }
                  #balloonTool #balloonIconsWrapper{ overflow:auto; height:100%; }
                  #balloonTool #balloonScrollTop,
                  #balloonTool #balloonScrollBottom{ overflow-x:auto; overflow-y:hidden; }
                  #balloonTool #balloonScrollTop{ margin-bottom:4px; height:8px; }
                  #balloonTool #balloonScrollTop div{ height:1px; }
                  #balloonTool #balloonIcons{ display:flex; flex-wrap:wrap; gap:4px; width:max-content; }
                  #balloonTool #balloonIcons svg{ cursor:pointer; width:40px; height:40px; }
                </style>
                <fieldset class="admin-fieldset">
                  <legend>Balloon Icon Generator</legend>
                  <div class="shape-buttons" id="balloonShapeButtons"></div>
                  <div class="size-control">
                    <label>Balloon size: <input type="range" id="balloonSize" min="40" max="120" value="40" /> <span id="balloonSizeValue">40</span>px</label>
                  </div>
                  <div class="svg-output">
                    <textarea id="balloonSvgCode" readonly></textarea>
                    <button type="button" id="copySvgCode">Copy SVG code</button>
                  </div>
                  <div id="balloonIconsWrapper">
                    <div id="balloonScrollTop"><div></div></div>
                    <div id="balloonScrollBottom">
                      <div id="balloonIcons"></div>
                    </div>
                  </div>
                </fieldset>
              </div>
            </div>
        </div>
        <div id="tab-forms" class="tab-panel">
          <style>
            #tab-forms .form-category{margin:10px 0;border:1px solid #ccc;padding:10px;}
            #tab-forms .category-header{display:flex;gap:6px;align-items:center;margin-bottom:8px;}
            #tab-forms .subcategory-table{border-collapse:collapse;}
            #tab-forms .subcategory-table td,#tab-forms .subcategory-table th{border:1px solid #999;padding:4px;}
          </style>
          <div id="formsControls">
            <button type="button" id="addCategory">Add Category</button>
            <div id="formsCategories"></div>
          </div>
        </div>
        <div id="tab-settings" class="tab-panel">
          <div class="modal-field">
            <label for="catList">Categories</label>
            <textarea id="catList" rows="3" placeholder="One category per line"></textarea>
          </div>
          <div class="modal-field">
            <label for="subList">Subcategories</label>
            <textarea id="subList" rows="3" placeholder="One subcategory per line"></textarea>
          </div>
          <div class="modal-field">
            <label for="aColor">Color</label>
            <input type="color" id="aColor" data-mode="hex" value="#000000" />
          </div>
          <div class="modal-field">
            <label for="welcomeMessage">Welcome Message</label>
            <textarea id="welcomeMessage" rows="4" placeholder="<p>Welcome!</p>"></textarea>
          </div>
          <div class="modal-field">
            <label for="settingsRestore">Restore Backup</label>
            <select id="settingsRestore" style="width:250px"></select>
            <button type="button" data-restore="settings">Restore</button>
          </div>
        </div>
      </form>
  </div>
  </div>

  <div id="welcomeModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-body" id="welcomeBody"></div>
    </div>
  </div>

  <script>
  let startPitch, startBearing;

  (function(){
    const MAPBOX_TOKEN = "pk.eyJ1IjoienhlbiIsImEiOiJjbWViaDRibXEwM2NrMm1wcDhjODg4em5iIn0.2A9teACgwpiCy33uO4WZJQ";

    let mode = 'map';
    const DEFAULT_SPIN_SPEED = 0.2;
    const DEFAULT_WELCOME = '<p>Welcome!</p>';
    const firstVisit = !localStorage.getItem('hasVisited');
    localStorage.setItem('hasVisited','1');
    const savedView = JSON.parse(localStorage.getItem('mapView') || 'null');
    const defaultCenter = [(Math.random()*360)-180,(Math.random()*140)-70];
    const startCenter = savedView?.center || defaultCenter;
    const startZoom = savedView?.zoom || 1.5;
    startPitch = window.startPitch = savedView?.pitch || 0;
    startBearing = window.startBearing = savedView?.bearing || 0;

    function normalizeMapStyle(style){
      switch(style){
        case 'mapbox://styles/mapbox/standard-dark':
          return 'mapbox://styles/mapbox/dark-v11';
        case 'mapbox://styles/mapbox/standard-light':
          return 'mapbox://styles/mapbox/light-v11';
        case 'mapbox://styles/mapbox/standard-satellite':
          return 'mapbox://styles/mapbox/satellite-streets-v12';
        default:
          return style;
      }
    }

      let map, geocoder, memberGeocoder, spinning = false, resultsWasHidden = null, datePicker, todayWasOn = false,
          spinLoadStart = JSON.parse(localStorage.getItem('spinLoadStart') ?? 'true'),
          spinLoadType = localStorage.getItem('spinLoadType') || 'all',
          spinLogoClick = JSON.parse(localStorage.getItem('spinLogoClick') || 'true'),
          spinSpeed = parseFloat(localStorage.getItem('spinSpeed') || String(DEFAULT_SPIN_SPEED)),
          spinEnabled = spinLoadStart && (spinLoadType === 'all' || (spinLoadType === 'new' && firstVisit)),
          mapStyle = window.mapStyle = normalizeMapStyle(localStorage.getItem('mapStyle')) || 'mapbox://styles/mapbox/standard',
          skyStyle = window.skyStyle = localStorage.getItem('skyStyle') || 'night';
      localStorage.setItem('spinGlobe', JSON.stringify(spinEnabled));
      const logoEl = document.querySelector('.logo');
      const filterBtn = document.getElementById('filterBtn');
      function updateLogoClickState(){
        if(logoEl){
          logoEl.style.cursor = 'pointer';
          logoEl.style.pointerEvents = 'auto';
        }
      }
      updateLogoClickState();

      function applySky(theme){
        if(!map || typeof map.setFog !== 'function'){
          console.warn('map.setFog is not available in this Mapbox GL JS version.');
          return;
        }
        const skyThemes = {
          default:{ 'color':'rgb(186,210,255)','high-color':'rgb(64,152,255)','space-color':'rgb(4,7,22)','horizon-blend':0.3 },
          sunset:{ 'color':'#ffcf70','high-color':'#ff8f70','space-color':'#020014','horizon-blend':0.5 },
          night:{ 'color':'#0b1d51','high-color':'#1a2849','space-color':'#000000','horizon-blend':0.1,'star-intensity':0.8 },
          aurora:{ 'color':'#03172f','high-color':'#5dd9c1','space-color':'#000000','horizon-blend':0.2,'star-intensity':0.6 },
          dawn:{ 'color':'#ffd1a1','high-color':'#ff9f85','space-color':'#4a1a74','horizon-blend':0.4 },
          dusk:{ 'color':'#8e4e9e','high-color':'#3b1a69','space-color':'#020024','horizon-blend':0.3 },
          space:{ 'color':'#000000','high-color':'#000000','space-color':'#000000','horizon-blend':0,'star-intensity':0.0 },
          cloudy:{ 'color':'#cdd2d7','high-color':'#e4e7eb','space-color':'#adb5bd','horizon-blend':0.2 },
          storm:{ 'color':'#5e5e5e','high-color':'#2a2a2a','space-color':'#000000','horizon-blend':0.1 },
          twilight:{ 'color':'#2e3358','high-color':'#75517d','space-color':'#141429','horizon-blend':0.3 },
          sunrise:{ 'color':'#ffd28c','high-color':'#ff6e7f','space-color':'#2c1055','horizon-blend':0.4 },
          rainbow:{ 'color':'#ffe29f','high-color':'#ffa99f','space-color':'#667eea','horizon-blend':0.3 }
        };
        map.setFog(skyThemes[theme] || skyThemes.default);
      }

      function openWelcome(){
        const body = document.getElementById('welcomeBody');
        const saved = JSON.parse(localStorage.getItem('admin-settings-current') || '{}');
        const msg = saved.welcomeMessage || DEFAULT_WELCOME;
        body.innerHTML = msg;
        if(!/\<img/i.test(msg)){
          const logoPath = window.matchMedia('(max-width:650px)').matches ?
            'https://raw.githubusercontent.com/Zxen1/Events-Platform/refs/heads/main/assets/funmap%20logo%202011-09-30h.png' :
            'https://raw.githubusercontent.com/Zxen1/Events-Platform/refs/heads/main/assets/funmap-logo-2025-08-25.png';
          body.insertAdjacentHTML('afterbegin', `<img src="${logoPath}" alt="FunMap logo" />`);
        }
        toggleModal(document.getElementById('welcomeModal'));
        body.style.padding = '20px';
        const content = document.querySelector('#welcomeModal .modal-content');
        const subHead = document.querySelector('.subheader');
        const topPos = subHead ? subHead.getBoundingClientRect().bottom : 0;
        if(content){
          content.style.left = '50%';
          content.style.transform = 'translateX(-50%)';
          content.style.top = `${topPos + 100}px`;
        }
      }

      logoEl?.addEventListener('click', (e) => {
        e.stopPropagation();
        if(spinning){
          openWelcome();
          return;
        }
        if(spinLogoClick && map && map.getZoom() <= 4){
          spinEnabled = true;
          localStorage.setItem('spinGlobe', 'true');
          startSpin(true);
        }
        openWelcome();
      });
    // 'Post Panel' is defined as the current map bounds
    let postPanel = null;
    let posts = [], filtered = [];
    let favToTop = false, currentSort = 'az';
    let selection = { cats: new Set(), subs: new Set() };
    let viewHistory = loadHistory();
    let hoverPopup = null, hoverId = null;
    let activePostId = null;

    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const clamp = (n, a, b)=> Math.max(a, Math.min(b, n));
    const toRad = d => d * Math.PI / 180;
    function distKm(a,b){ const dLat = toRad(b.lat - a.lat), dLng = toRad(b.lng - a.lng); const s = Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(Math.PI*(b.lng - a.lng)/360)**2; return 2 * 6371 * Math.asin(Math.sqrt(s)); }
    const sleep = ms => new Promise(r=>setTimeout(r,ms));
    const nextFrame = ()=> new Promise(r=> requestAnimationFrame(()=>r()));

    // Ensure result lists occupy space between the subheader and footer
    function adjustListHeight(){
      const rootStyles = getComputedStyle(document.documentElement);
      const headerH = parseFloat(rootStyles.getPropertyValue('--header-h')) || 0;
      const subH = parseFloat(rootStyles.getPropertyValue('--subheader-h')) || 0;
      const footerH = parseFloat(rootStyles.getPropertyValue('--footer-h')) || 0;
      const availableHeight = window.innerHeight - headerH - subH - footerH;
      document.querySelectorAll('.res-list').forEach(list=>{
        const style = getComputedStyle(list);
        const pad = parseFloat(style.paddingTop) + parseFloat(style.paddingBottom);
        list.style.maxHeight = `${Math.max(0, availableHeight - pad)}px`;
      });
    }
    window.adjustListHeight = adjustListHeight;

    function updateStickyImages(){
      const root = document.documentElement;
      const body = document.querySelector('.open-posts .body');
      const imgArea = body ? body.querySelector('.img-area') : null;
      const text = body ? body.querySelector('.text') : null;
      const isBelow = imgArea && text ? text.offsetTop > imgArea.offsetTop : false;
      root.classList.toggle('hide-map-calendar', isBelow);
      if(body && text){
        const venueDropdown = body.querySelector('.venue-dropdown');
        const sessionDropdown = body.querySelector('.session-dropdown');
        const mapContainer = body.querySelector('.map-container');
        const calContainer = body.querySelector('.calendar-container');
        const titleEl = text.querySelector('.title');
        if(isBelow){
          if(venueDropdown && venueDropdown.parentElement !== text && titleEl){
            text.insertBefore(venueDropdown, titleEl);
          }
          if(sessionDropdown && sessionDropdown.parentElement !== text && titleEl){
            text.insertBefore(sessionDropdown, titleEl);
          }
        } else {
          if(venueDropdown && mapContainer && venueDropdown.parentElement !== mapContainer){
            mapContainer.appendChild(venueDropdown);
          }
          if(sessionDropdown && calContainer && sessionDropdown.parentElement !== calContainer){
            calContainer.appendChild(sessionDropdown);
          }
        }
      }
      const stickyInput = document.getElementById('open-posts-sticky-images');
      if(!(stickyInput && stickyInput.checked) || !body || !imgArea || !text){
        root.classList.remove('open-posts-sticky-images');
        return;
      }
      root.classList.toggle('open-posts-sticky-images', !isBelow);
    }

    window.updateStickyImages = updateStickyImages;

    function updateLayoutVars(){
      const root = document.documentElement;
      const header = document.querySelector('.header');
      const subHead = document.querySelector('.subheader');
      if(header){
        root.style.setProperty('--header-h', `${header.offsetHeight}px`);
      }
      if(subHead){
        root.style.setProperty('--subheader-h', `${subHead.offsetHeight}px`);
      }
      if(typeof window.adjustListHeight === 'function'){
        window.adjustListHeight();
      }
      if(typeof renderLists === 'function' && filtered && filtered.length){
        const resEl = document.getElementById('results');
        if(resEl && resEl.children.length === 0){
          renderLists(filtered);
        }
      }
    }
    window.updateLayoutVars = updateLayoutVars;

    function updatePostPanel(){ if(map) postPanel = map.getBounds(); }

    // === 0528 helpers: cluster contextmenu list (robust positioning + locking) ===
    let listLocked = false;
    let lastListOpenAt = 0;
    function lockMap(lock){
      listLocked = lock;
      const fn = lock ? 'disable' : 'enable';
      try{ map.dragPan[fn](); }catch{}
      try{ map.scrollZoom[fn](); }catch{}
      try{ map.boxZoom[fn](); }catch{}
      try{ map.keyboard[fn](); }catch{}
      try{ map.doubleClickZoom[fn](); }catch{}
      try{ map.touchZoomRotate[fn](); }catch{}
    }
    function getClusterLeavesAll(sourceId, clusterId){
      return new Promise((resolve, reject)=>{
        const src = map.getSource(sourceId); if(!src) return resolve([]);
        const page = 50; const out = [];
        function step(offset){
          src.getClusterLeaves(clusterId, page, offset, (err, leaves)=>{
            if(err){ reject(err); return; }
            out.push(...leaves);
            if(leaves.length < page) resolve(out);
            else step(offset + page);
          });
        }
        step(0);
      });
    }
    
function buildClusterListHTML(items){
  const soonest = items.map(p=>p.dates[0]).sort()[0];
  const head = `<h4>${items.length} events here<br><span class="soonest">Soonest: <span class="nowrap">${soonest}</span></span></h4>`;
  const sort = currentSort;
  const arr = items.slice();
  if(sort==='az') arr.sort((a,b)=> a.title.localeCompare(b.title));
  if(sort==='soon') arr.sort((a,b)=> a.dates[0].localeCompare(b.dates[0]));
  if(sort==='nearest'){
    let ref = {lng:0,lat:0}; if(map){ const c = map.getCenter(); ref = {lng:c.lng,lat:c.lat}; }
    arr.sort((a,b)=> distKm({lng:a.lng,lat:a.lat}, ref) - distKm({lng:b.lng,lat:b.lat}, ref));
  }
  if(favToTop) arr.sort((a,b)=> (b.fav - a.fav));
  const list = arr.map(p => {
    return `
      <div class="multi-item" data-id="${p.id}">
        <div class="hover-card">
          <img src="${imgThumb(p)}" alt="" referrerpolicy="no-referrer"/>
          <div>
            <div class="t">${p.title}</div>
            <div class="s">${p.city}</div>
          </div>
        </div>
      </div>`;
  }).join('');
  return `<div class=\"multi-hover\">${head}<div class=\"multi-list\">${list}</div></div>`;
}
    // 0530: group posts at the same venue (by coordinate)
    function postsAtVenue(lng, lat){
      const list = (filtered.length ? filtered : posts);
      const eps = 1e-6; // ~0.1m at equator
      return list.filter(p => Math.abs(p.lng - lng) < eps && Math.abs(p.lat - lat) < eps);
    }

    function openListPopupAtPoint(point, htmlStr){
      // Remove previous
      if(hoverPopup){ hoverPopup.remove(); hoverPopup=null; }
      // Place popup at the pointer, then adjust to keep fully in view by moving the lngLat
      const lngLat = map.unproject(point);
      hoverPopup = new mapboxgl.Popup({maxWidth:'none', closeButton:false, closeOnClick:false, anchor:'top', className:'hover-pop hover-multi-list', offset:10}).setLngLat(lngLat).setHTML(htmlStr).addTo(map);
      registerPopup(hoverPopup);
      // Prevent the browser contextmenu while locked
      map.getCanvas().addEventListener('contextmenu', ev => ev.preventDefault(), {once:true});
      // Stop events inside from bubbling to map
      const el = hoverPopup.getElement();
      el.addEventListener('click', e => e.stopPropagation(), {capture:true});
      // After layout, ensure fully on-screen
      requestAnimationFrame(()=>{
        const rect = el.getBoundingClientRect();
        const cont = map.getContainer().getBoundingClientRect();
        let x = point.x, y = point.y;
        const pad = 12;
        const maxX = cont.width - pad;
        const maxY = cont.height - pad;
        // If overflowing right/left, clamp
        if(rect.right > cont.right - pad) x -= (rect.right - (cont.right - pad));
        if(rect.left  < cont.left + pad)  x += (cont.left + pad - rect.left);
        // If overflowing bottom/top, clamp
        if(rect.bottom > cont.bottom - pad) y -= (rect.bottom - (cont.bottom - pad));
        if(rect.top    < cont.top + pad)    y += (cont.top + pad - rect.top);
        hoverPopup.setLngLat(map.unproject({x,y}));
      });
    }


    function mulberry32(a){ return function(){var t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15, t|1); t^=t+Math.imul(t^t>>>7, t|61); return ((t^t>>>14)>>>0)/4294967296; }; }
    const rnd = mulberry32(42);

    const cities = [
      {n:"Melbourne, Australia", c:[144.9631,-37.8136]},
      {n:"Sydney, Australia", c:[151.2093,-33.8688]},
      {n:"London, UK", c:[-0.1276,51.5072]},
      {n:"New York, USA", c:[-74.0060,40.7128]},
      {n:"Tokyo, Japan", c:[139.6917,35.6895]},
      {n:"Paris, France", c:[2.3522,48.8566]},
      {n:"Rio de Janeiro, Brazil", c:[-43.1729,-22.9068]},
      {n:"Cape Town, South Africa", c:[18.4241,-33.9249]},
      {n:"Reykjavík, Iceland", c:[-21.8174,64.1265]},
      {n:"Mumbai, India", c:[72.8777,19.0760]}
    ];
    const categories = [
      { name:"Film",      subs:["Screenings","Festivals","Shorts","Indie"] },
      { name:"Theatre",   subs:["Plays","Musicals","Improv"] },
      { name:"Music",     subs:["Gigs","Open Mic","Classical","Jazz"] },
      { name:"Dance",     subs:["Ballet","Contemporary","Hip Hop"] },
      { name:"Photography",subs:["Exhibitions","Workshops"] },
      { name:"Gallery",   subs:["Openings","Talks"] },
      { name:"Auditions", subs:["Film","Theatre","Music"] },
      { name:"Talent",    subs:["Models","Actors","Crew"] }
    ];
    const subcategoryIcons = {
      "Screenings":"🎬",
      "Festivals":"🎉",
      "Shorts":"📽️",
      "Indie":"🎞️",
      "Plays":"🎭",
      "Musicals":"🎶",
      "Improv":"🤹",
      "Gigs":"🎤",
      "Open Mic":"🎙️",
      "Classical":"🎼",
      "Jazz":"🎷",
      "Ballet":"🩰",
      "Contemporary":"💃",
      "Hip Hop":"🕺",
      "Exhibitions":"🖼️",
      "Workshops":"🛠️",
      "Openings":"🚪",
      "Talks":"🗣️",
      "Film":"🎥",
      "Theatre":"🎭",
      "Music":"🎵",
      "Dance":"💃",
      "Photography":"📸",
      "Gallery":"🏛️",
      "Auditions":"🎬",
      "Talent":"⭐"
    };
// 0585: unique title generator (with location; no category prefix)
const __ADJ = ["Radiant","Indigo","Velvet","Silver","Crimson","Neon","Amber","Sapphire","Emerald","Electric","Roaring","Midnight","Sunlit","Ethereal","Urban","Astral","Analog","Digital","Windswept","Golden","Hidden","Avant","Cosmic","Garden","Quiet","Vivid","Obsidian","Scarlet","Cerulean","Lunar","Solar","Autumn","Verdant","Azure"];
const __NOUN = ["Symphony","Market","Carnival","Showcase","Assembly","Parade","Salon","Summit","Expo","Soirée","Revue","Collective","Fair","Gathering","Series","Retrospective","Circuit","Sessions","Weekender","Festival","Bazaar","Program","Tableau","Odyssey","Forum","Mosaic","Canvas","Relay","Drift","Workshop","Lab"];
const __HOOK = ["at Dusk","of Ideas","in Motion","for Everyone","Remix","Live","Reborn","MKII","Redux","Infinite","Prime","Pulse","Wave","Future","Now","Unlocked","Extended","Panorama","Unbound","Edition","Run","Sequence"];
function __rng(seed){ let s = seed|0; return ()=> (s = (s*1664525 + 1013904223)>>>0); }
const __USED_BIGRAMS = new Set();
function uniqueTitle(seed, cityName, idx){
  // Deterministic RNG with attempt salt for conflict resolution
  const base = (seed||0) ^ ((idx||0)*99991);

  const normalize = (s)=> s
    .replace(/[^\p{L}\p{N}]+/gu,' ')
    .trim()
    .split(/\s+/)
    .filter(Boolean);

  const lower = (ws)=> ws.map(w=> w.toLowerCase());

  const bigrams = (words)=> {
    const out = [];
    for(let i=0;i<words.length-1;i++) out.push(words[i]+" "+words[i+1]);
    return out;
  };

  const violates = (title)=> {
    const ws = normalize(title);
    const lc = lower(ws);
    if(!ws.length) return true;

    // no duplicate adjacent words inside one title
    for(let i=0;i<lc.length-1;i++){
      if(lc[i]===lc[i+1]) return true;
    }
    // any bigram seen before globally?
    const b = bigrams(lc);
    for(const bg of b){ if(__USED_BIGRAMS.has(bg)) return true; }

    return false;
  };

  const pickFrom = (r, arr)=> arr[r()%arr.length];

  // Word banks
  const A = __ADJ, N = __NOUN, H = __HOOK;
  const ARTISTS = [
    "The Silver Comets","Neon Parade","Paper Lanterns","Velvet Echoes","Indigo Quartet",
    "The Jet Set","Crimson Tide","Midnight Radio","Electric Hearts","Golden Hour",
    "The Amber Rooms","Violet Skyline","Satellite City","The Night Owls","Ivory Street Band",
    "Bluebird Company","Marble Garden","Velvet Undergrounders","Echo Park Players","Lantern Light",
    "Harbor & Co.","The Carousel Club","Kite & Canvas","Saffron Society","The Prairie Dogs"
  ];
  const PLAY_FORMS = [
    "Picture Show","Live on Stage","In Concert","Experience","Cabaret","Showcase",
    "Festival","Gala","Residency","Matinee","After Dark","Revue","Workshop"
  ];
  const STORY_OPENERS = [
    "Once Upon a Time","Into the Unknown","A Night to Remember","Between Two Worlds",
    "The Last Carousel","Dreams of Summer","Echoes in the Hall","Velvet Midnight",
    "The Paper Moon","Lanterns at Dusk","The Long Goodbye","Morning After Dark","Before the Storm"
  ];
  const TOUR_TAGS = ["Greatest Hits","Unplugged","Anniversary Tour","Acoustic Sessions","Late Night Set"];
  const PROMOS = ["One Night Only!","Two Nights Only!","One Weekend Only!","2 weeks only!!","Limited Season","Encore Performance"];

  const makeTitle = (r)=>{
    const templates = [
      ()=> `${pickFrom(r, ARTISTS)} Live on Stage`,
      ()=> `${pickFrom(r, ARTISTS)} — ${pickFrom(r, TOUR_TAGS)}`,
      ()=> `An Evening with ${pickFrom(r, ARTISTS)}`,
      ()=> `The ${pickFrom(r, N)} ${pickFrom(r, PLAY_FORMS)}`,
      ()=> `The ${pickFrom(r, A)} ${pickFrom(r, N)}`,
      ()=> `${pickFrom(r, A)} ${pickFrom(r, N)} ${pickFrom(r, H)}`,
      ()=> `${pickFrom(r, STORY_OPENERS)}`,
      ()=> `${pickFrom(r, A)} ${pickFrom(r, N)}: ${pickFrom(r, H)}`,
      ()=> `${pickFrom(r, A)} ${pickFrom(r, N)} ${pickFrom(r, PLAY_FORMS)}`,
      ()=> `${pickFrom(r, N)} ${pickFrom(r, PLAY_FORMS)}`
    ];
    let t = templates[r()%templates.length]();
    if ((r()%4)===0) t += ` — ${pickFrom(r, PROMOS)}`;
    return t.replace(/\s+/g,' ').trim();
  };

  // Try multiple deterministic attempts with salted RNG until constraints satisfied
  let attempt = 0, title = "";
  for(; attempt < 96; attempt++){
    const r = __rng(base ^ (attempt * 1315423911));
    const candidate = makeTitle(r);
    if(!violates(candidate)){
      title = candidate;
      break;
    }
  }
  if(!title){ title = makeTitle(__rng(base ^ 0x9e3779b9)); } // fallback

  // Commit global constraints
  const ws = lower(normalize(title));
  for(let i=0;i<ws.length-1;i++){ __USED_BIGRAMS.add(ws[i]+" "+ws[i+1]); }

  return title;
}function pick(arr){ return arr[Math.floor(rnd()*arr.length)]; }
    function jitter([lng,lat]){ return [lng + (rnd()-0.5)*8, clamp(lat + (rnd()-0.5)*8,-80,80)]; }
    
  function randomDates(){
    const count = 1 + Math.floor(rnd()*30);
    const now = new Date();
    return Array.from({length:count}, ()=>{
      const d = new Date(+now + Math.floor(rnd()*365)*86400000);
      return d.toISOString().slice(0,10);
    }).sort();
  }

  const VENUES = [
    "Grand Hall","City Theater","Riverside Arena","Skyline Lounge","Sunset Pavilion",
    "Maple Center","Harbor Stage","Old Mill Gallery","Crystal Ballroom","Garden Amphitheater"
  ];
  const STREETS = [
    "Main St","Oak Ave","Pine Rd","Maple Blvd","Cedar St",
    "Elm Rd","Birch Ave","Spruce St","Willow Ln","Ash Blvd"
  ];

  function randomSchedule(){
    const count = 1 + Math.floor(rnd()*20);
    const now = new Date();
    const cents = ()=> rnd() < 0.8 ? 0 : 0.5;
    return Array.from({length:count}, ()=>{
      const d = new Date(+now + Math.floor(rnd()*365)*86400000);
      const date = d.toLocaleDateString('en-GB',{weekday:'short', day:'numeric', month:'short'}).replace(/,/g,'');
      const time = `${String(Math.floor(rnd()*24)).padStart(2,'0')}:${String(Math.floor(rnd()*4)*15).padStart(2,'0')}`;
      const adult = 10 + Math.floor(rnd()*40) + cents();
      const kid = Math.max(0, adult - (5 + Math.floor(rnd()*6))) + cents();
      const pensioner = Math.max(0, adult - (2 + Math.floor(rnd()*6))) + cents();
      return {date, time, full: d.toISOString().slice(0,10), price:{adult, kid, pensioner}};
    });
  }

  function randomLocation(city, baseLng=0, baseLat=0){
    const venue = pick(VENUES);
    const address = `${Math.floor(rnd()*999)+1} ${pick(STREETS)}, ${city}`;
    const jitter = ()=> (rnd()-0.5) * 0.02;
    const lng = baseLng + jitter();
    const lat = baseLat + jitter();
    return { venue, address, lng, lat, dates: randomSchedule() };
  }

  function randomLocations(city, baseLng=0, baseLat=0){
    const count = 1 + Math.floor(rnd()*5);
    return Array.from({length:count}, ()=> randomLocation(city, baseLng, baseLat));
  }

  function randomImages(id){
    return Array.from({length:10},(_,i)=>`https://picsum.photos/seed/${encodeURIComponent(id)}-${i}/1200/800`);
  }

  function randomText(min=200,max=2000){
    const lorem = "lorem ipsum dolor sit amet consectetur adipiscing elit sed do eiusmod tempor incididunt ut labore et dolore magna aliqua".split(' ');
    const count = min + Math.floor(rnd()*(max-min+1));
    const words = [];
    for(let i=0;i<count;i++){ words.push(lorem[i%lorem.length]); }
    words[0] = words[0][0].toUpperCase() + words[0].slice(1);
    return words.join(' ') + '.';
  }


    

function makePosts(){
  const out = [];
  // ---- 100 posts at Federation Square (as before) ----
  const fsLng = 144.9695, fsLat = -37.8178;
  const fsCity = "Federation Square, Melbourne";
  for(let i=0;i<100;i++){
    const cat = pick(categories);
    const sub = pick(cat.subs);
    const id = 'FS'+i;
    out.push({
      id,
      title: `${id} ${uniqueTitle(i*7777+13, fsCity, i)}`,
      city: fsCity,
      lng: fsLng, lat: fsLat,
      category: cat.name,
      subcategory: sub,
      dates: randomDates(),
      fav:false,
      desc: randomText(),
      images: randomImages(id),
      locations: randomLocations(fsCity, fsLng, fsLat),
    });
  }

  // ---- Restore world-wide posts ----
  // A light list of hub cities for better realism
  const hubs = [
    {c:"New York, USA",      lng:-73.9857, lat:40.7484},
    {c:"Los Angeles, USA",   lng:-118.2437, lat:34.0522},
    {c:"London, UK",         lng:-0.1276, lat:51.5074},
    {c:"Paris, France",      lng:2.3522, lat:48.8566},
    {c:"Berlin, Germany",    lng:13.4050, lat:52.5200},
    {c:"Madrid, Spain",      lng:-3.7038, lat:40.4168},
    {c:"Rome, Italy",        lng:12.4964, lat:41.9028},
    {c:"Amsterdam, NL",      lng:4.9041, lat:52.3676},
    {c:"Dublin, Ireland",    lng:-6.2603, lat:53.3498},
    {c:"Stockholm, Sweden",  lng:18.0686, lat:59.3293},
    {c:"Copenhagen, Denmark",lng:12.5683, lat:55.6761},
    {c:"Helsinki, Finland",  lng:24.9384, lat:60.1699},
    {c:"Oslo, Norway",       lng:10.7522, lat:59.9139},
    {c:"Reykjavík, Iceland", lng:-21.8277, lat:64.1265},
    {c:"Moscow, Russia",     lng:37.6173, lat:55.7558},
    {c:"Istanbul, Türkiye",  lng:28.9784, lat:41.0082},
    {c:"Athens, Greece",     lng:23.7275, lat:37.9838},
    {c:"Cairo, Egypt",       lng:31.2357, lat:30.0444},
    {c:"Nairobi, Kenya",     lng:36.8219, lat:-1.2921},
    {c:"Lagos, Nigeria",     lng:3.3792, lat:6.5244},
    {c:"Johannesburg, SA",   lng:28.0473, lat:-26.2041},
    {c:"Cape Town, SA",      lng:18.4241, lat:-33.9249},
    {c:"Dubai, UAE",         lng:55.2708, lat:25.2048},
    {c:"Mumbai, India",      lng:72.8777, lat:19.0760},
    {c:"Delhi, India",       lng:77.1025, lat:28.7041},
    {c:"Bangkok, Thailand",  lng:100.5018, lat:13.7563},
    {c:"Singapore",          lng:103.8198, lat:1.3521},
    {c:"Hong Kong, China",   lng:114.1694, lat:22.3193},
    {c:"Tokyo, Japan",       lng:139.6917, lat:35.6895},
    {c:"Seoul, South Korea", lng:126.9780, lat:37.5665},
    {c:"Sydney, Australia",  lng:151.2093, lat:-33.8688},
    {c:"Brisbane, Australia",lng:153.0251, lat:-27.4698},
    {c:"Auckland, New Zealand", lng:174.7633, lat:-36.8485},
    {c:"Toronto, Canada",    lng:-79.3832, lat:43.6532},
    {c:"Vancouver, Canada",  lng:-123.1207, lat:49.2827},
    {c:"Mexico City, Mexico",lng:-99.1332, lat:19.4326},
    {c:"São Paulo, Brazil",  lng:-46.6333, lat:-23.5505},
    {c:"Rio de Janeiro, Brazil", lng:-43.1729, lat:-22.9068},
    {c:"Buenos Aires, Argentina", lng:-58.3816, lat:-34.6037},
    {c:"Santiago, Chile",    lng:-70.6693, lat:-33.4489}
  ];

  // Generate ~900 posts across hubs with small jitter to spread within cities
  const TOTAL_WORLD = 900;
  for(let i=0;i<TOTAL_WORLD;i++){
    const hub = hubs[Math.floor(rnd()*hubs.length)];
    const jitter = ()=> (rnd()-0.5) * 0.2; // ~0.2 degrees spread (~20km)
    const cat = pick(categories);
    const sub = pick(cat.subs);
    const id = 'WW'+i;
    out.push({
      id,
      title: `${id} ${uniqueTitle(i*9343+19, hub.c, i)}`,
      city: hub.c,
      lng: hub.lng + jitter(),
      lat: hub.lat + jitter(),
      category: cat.name,
      subcategory: sub,
      dates: randomDates(),
      fav:false,
      desc: randomText(),
      images: randomImages(id),
      locations: randomLocations(hub.c, hub.lng, hub.lat),
    });
  }
  return out;
}


    posts = makePosts();

    // Image helpers (unique per post)
    function imgThumb(pOrId){ const id = typeof pOrId==='string' ? pOrId : pOrId.id; return `https://picsum.photos/seed/${encodeURIComponent(id)}-t/300/200`; }
    function imgHero(pOrId){  const id = typeof pOrId==='string' ? pOrId : pOrId.id;  return `https://picsum.photos/seed/${encodeURIComponent(id)}-t/1200/800`; }

    function hoverHTML(p){
      return `<div class="hover-card"><img src="${imgThumb(p)}" alt="" referrerpolicy="no-referrer"/><div><div class="t">${p.title}</div><div class="s">${p.city}</div></div></div>`;
    }

    // Categories UI
    const catsEl = $('#cats');
    categories.forEach(c=>{
      const el = document.createElement('div'); el.className='cat'; el.setAttribute('role','group'); el.setAttribute('aria-expanded','false');
      const bar = document.createElement('div'); bar.className='bar';
      const dot = document.createElement('div'); dot.className='dot'; dot.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 5v14M5 12h14"/></svg>';
      const label = document.createElement('div'); label.className='label'; label.textContent=c.name;
      const cfg = document.createElement('div'); cfg.className='cfg'; cfg.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 7h16M7 12h10M10 17h4"/></svg>';
      const sub = document.createElement('div'); sub.className='sub';
      c.subs.forEach(s=>{ const chip=document.createElement('div'); chip.className='chip'; chip.innerHTML='<span class="badge"></span>'+s; chip.addEventListener('click',()=>{ chip.classList.toggle('on'); const key=c.name+'::'+s; if(selection.subs.has(key)) selection.subs.delete(key); else selection.subs.add(key); applyFilters(); }); sub.appendChild(chip); });
      bar.appendChild(dot); bar.appendChild(label);
      bar.addEventListener('click',()=>{ const ex = el.getAttribute('aria-expanded')==='true'; el.setAttribute('aria-expanded',ex?'false':'true'); if(ex){ selection.cats.delete(c.name); } else { selection.cats.add(c.name); } applyFilters(); });
      el.appendChild(bar); el.appendChild(cfg); el.appendChild(sub); catsEl.appendChild(el);
    });

    // Reset
    $('#resetBtn').addEventListener('click',()=>{
      selection.cats.clear(); selection.subs.clear();
      $$('.cat').forEach(el=>el.setAttribute('aria-expanded','false'));
      $$('.chip.on').forEach(ch=>ch.classList.remove('on'));
      $('#kwInput').value='';
      $('#dateInput').value='';
      $('#dateInput').dataset.range='';
      $('#todayToggle').checked = false;
      todayWasOn = false;
      if(datePicker) datePicker.clearSelection();
      if(geocoder) geocoder.clear();
      applyFilters();
      updateClearButtons();
    });

    function updateClearButtons(){
      const kw = $('#kwInput');
      const kwX = kw.parentElement.querySelector('.x');
      kwX && kwX.classList.toggle('active', kw.value.trim() !== '');
      const date = $('#dateInput');
      const dateX = date.parentElement.querySelector('.x');
      const hasDate = date.dataset.range || (date.value.trim() && date.value.trim() !== 'Today Onwards');
      dateX && dateX.classList.toggle('active', !!hasDate);
    }

    $('#kwInput').addEventListener('input', ()=>{ applyFilters(); updateClearButtons(); });
    $('#dateInput').addEventListener('input', ()=>{ applyFilters(); updateClearButtons(); });
    $('#dateInput').addEventListener('keydown', e=> e.preventDefault());
    datePicker = new Litepicker({
      element: $('#datePicker'),
      inlineMode: true,
      singleMode: false,
      format: 'ddd D MMM',
      setup: (picker) => {
        picker.on('selected', (start, end) => {
          const input = $('#dateInput');
          if(start && end){
            const sIso = start.format('YYYY-MM-DD');
            const eIso = end.format('YYYY-MM-DD');
            const sDisp = start.format('ddd D MMM');
            const eDisp = end.format('ddd D MMM');
            input.value = `${sDisp} to ${eDisp}`;
            input.dataset.range = `${sIso} to ${eIso}`;
            todayWasOn = todayToggle && todayToggle.checked;
            if(todayToggle) todayToggle.checked = false;
          } else {
            input.value = todayToggle && todayToggle.checked ? 'Today Onwards' : '';
            input.dataset.range = '';
          }
          applyFilters();
          updateClearButtons();
        });
        picker.on('clear:selection', () => {
          const input = $('#dateInput');
          if(todayWasOn && todayToggle) todayToggle.checked = true;
          input.value = todayToggle && todayToggle.checked ? 'Today Onwards' : '';
          input.dataset.range = '';
          applyFilters();
          updateClearButtons();
          todayWasOn = todayToggle && todayToggle.checked;
        });
      }
    });

    $$('.field .x').forEach(x=> x.addEventListener('click',()=>{
      const input = x.parentElement.querySelector('input');
      if(input){
        if(input.id==='dateInput'){
          input.dataset.range='';
          if(datePicker) datePicker.clearSelection();
        } else {
          input.value='';
        }
        input.focus();
        applyFilters();
        updateClearButtons();
      }
    }));

    const todayToggle = $('#todayToggle');
    todayWasOn = todayToggle && todayToggle.checked;
    if(todayToggle){
      todayToggle.addEventListener('change', ()=>{
        const input = $('#dateInput');
        if(todayToggle.checked){
          input.dataset.range='';
          if(datePicker) datePicker.clearSelection();
          input.value = 'Today Onwards';
        } else {
          if(input.value === 'Today Onwards') input.value = '';
        }
        todayWasOn = todayToggle.checked;
        applyFilters();
        updateClearButtons();
      });
      if(todayToggle.checked){
        $('#dateInput').value = 'Today Onwards';
      }
    }
    updateClearButtons();
    const optionsBtn = $('#optionsBtn');
    const optionsMenu = $('#optionsMenu');
    const favToggle = $('#favToggle');
    const sortButtons = $$('.sort-option');

    favToggle.addEventListener('click', ()=>{
      favToTop = !favToTop;
      favToggle.setAttribute('aria-pressed', favToTop);
      renderLists(filtered);
    });

    sortButtons.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        currentSort = btn.dataset.sort;
        sortButtons.forEach(b=> b.setAttribute('aria-pressed', b===btn ? 'true' : 'false'));
        optionsBtn.textContent = btn.textContent;
        renderLists(filtered);
      });
    });

    optionsBtn.addEventListener('click', e=>{
      e.stopPropagation();
      const open = !optionsMenu.hasAttribute('hidden');
      if(open){
        optionsMenu.setAttribute('hidden','');
        optionsBtn.setAttribute('aria-expanded','false');
      } else {
        optionsMenu.removeAttribute('hidden');
        optionsBtn.setAttribute('aria-expanded','true');
      }
    });
    optionsMenu.addEventListener('click', e=> e.stopPropagation());
      document.addEventListener('click', ()=>{
        optionsMenu.setAttribute('hidden','');
        optionsBtn.setAttribute('aria-expanded','false');
      });

      const resultsToggle = $('#resultsToggle');
      const resultsCol = $('.results-col');
      const filterModal = $('#filterModal');
      const storedHidden = JSON.parse(localStorage.getItem('resultsHidden') || 'false');
      const shouldHide = storedHidden || spinEnabled || window.matchMedia('(max-width:1000px)').matches;
      if(shouldHide){
        document.body.classList.add('hide-results');
        resultsToggle.setAttribute('aria-pressed','false');
        resultsCol.setAttribute('aria-hidden','true');
      } else {
        resultsToggle.setAttribute('aria-pressed','true');
        resultsCol.setAttribute('aria-hidden','false');
      }
      window.adjustListHeight();
        setTimeout(()=>{
          if(map && typeof map.resize === 'function'){
            map.resize();
            updatePostPanel();
            applyFilters();
          }
        }, 0);
      resultsToggle.addEventListener('click', ()=>{
        const hidden = document.body.classList.toggle('hide-results');
        resultsToggle.setAttribute('aria-pressed', hidden ? 'false' : 'true');
        resultsCol.setAttribute('aria-hidden', hidden ? 'true' : 'false');
        localStorage.setItem('resultsHidden', JSON.stringify(hidden));
        window.adjustListHeight();
        setTimeout(()=>{
          if(map && typeof map.resize === 'function'){
            map.resize();
            updatePostPanel();
            applyFilters();
          }
        }, 310);
      });

      const mq = window.matchMedia('(max-width:1000px)');
      mq.addEventListener('change', e=>{
        if(e.matches){
          document.body.classList.add('hide-results');
          resultsToggle.setAttribute('aria-pressed','false');
          resultsCol.setAttribute('aria-hidden','true');
          if(filterModal) requestCloseModal(filterModal);
        }
      });

      const resList = $('.res-list');
      resList && resList.addEventListener('click', e=>{
        if(e.target === resList){
          document.body.classList.add('hide-results');
          resultsToggle.setAttribute('aria-pressed','false');
          resultsCol.setAttribute('aria-hidden','true');
          localStorage.setItem('resultsHidden','true');
          setMode('map');
        }
      });

      function setMode(m){
        mode = m;
      document.body.classList.remove('mode-map','mode-posts');
      document.body.classList.add('mode-'+m);
      const panel = document.querySelector('.post-panel');
      if(panel){
        panel.style.pointerEvents = 'none';
      }
      $('#tab-posts').setAttribute('aria-current', m==='posts'?'page':'');
      $('#main-tab-map').setAttribute('aria-current', m==='map'?'page':'');
      $('#tab-posts').setAttribute('aria-selected', m==='posts');
      $('#main-tab-map').setAttribute('aria-selected', m==='map');
      if(map){
        if(typeof map.resize === 'function'){
          map.resize();
        }
        updatePostPanel();
      }
      if(m==='posts'){
        spinEnabled = false;
        localStorage.setItem('spinGlobe','false');
        stopSpin();
      }
      applyFilters();
    }
    $('#tab-posts').addEventListener('click',()=> setMode('posts'));
    $('#main-tab-map').addEventListener('click',()=> setMode('map'));

    $('.closed-posts').addEventListener('click', (e)=>{
      if(!e.target.closest('.card, .open-posts, .litepicker')) setMode('map');
    });

    // Mapbox
    function loadMapbox(cb){
      if(window.mapboxgl && window.MapboxGeocoder) return cb();
      const link = document.createElement('link');
      link.rel='stylesheet';
      link.href='https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.css';
      document.head.appendChild(link);
      const gLink = document.createElement('link');
      gLink.rel='stylesheet';
      gLink.href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.1/mapbox-gl-geocoder.css';
      gLink.onerror = ()=>{
        const alt = document.createElement('link');
        alt.rel='stylesheet';
        alt.href='https://unpkg.com/@mapbox/mapbox-gl-geocoder@5.0.1/dist/mapbox-gl-geocoder.css';
        document.head.appendChild(alt);
      };
      document.head.appendChild(gLink);
      const s = document.createElement('script');
      s.src='https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.js';
      s.onload = ()=>{
        const g = document.createElement('script');
        g.src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.1/mapbox-gl-geocoder.min.js';
        g.onload = cb;
        g.onerror = ()=>{
          const gf = document.createElement('script');
          gf.src='https://unpkg.com/@mapbox/mapbox-gl-geocoder@5.0.1/dist/mapbox-gl-geocoder.min.js';
          gf.onload = cb;
          gf.onerror = cb;
          document.head.appendChild(gf);
        };
        document.head.appendChild(g);
      };
      s.onerror = cb;
      document.head.appendChild(s);
    }
    loadMapbox(initMap);

    function addGeocoder(){
      if(typeof MapboxGeocoder !== 'undefined'){
        geocoder = new MapboxGeocoder({
          accessToken: mapboxgl.accessToken,
          mapboxgl,
          marker: false,
          placeholder: 'Search Location',
          reverseGeocode: true,
          collapsed: false
        });
        geocoder.on('result', ()=>{
          spinEnabled = false;
          localStorage.setItem('spinGlobe','false');
          stopSpin();
          setMode('map');
          if(map) map.once('moveend', () => { geocoder.clear(); applyFilters(); updatePostPanel(); });
        });
        const gc = document.getElementById('geocoder');
        if(gc) gc.appendChild(geocoder.onAdd(map));
      } else {
        const script = document.createElement('script');
        script.src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.1/mapbox-gl-geocoder.min.js';
        script.onload = addGeocoder;
        script.onerror = ()=> console.error('Mapbox Geocoder failed to load');
        document.head.appendChild(script);
      }
    }

    function addMemberGeocoder(){
      if(typeof MapboxGeocoder !== 'undefined'){
        memberGeocoder = new MapboxGeocoder({
          accessToken: mapboxgl.accessToken,
          mapboxgl,
          marker:false,
          placeholder:'Search Location'
        });
        memberGeocoder.on('result', e=>{
          const info = document.getElementById('mLocationInfo');
          if(info){
            const place = e.result;
            info.innerHTML = `<strong>${place.text}</strong><br>${place.place_name}`;
          }
          memberGeocoder.clear();
        });
        memberGeocoder.on('clear', ()=>{
          const info = document.getElementById('mLocationInfo');
          if(info) info.innerHTML='';
        });
        const container = document.getElementById('mLocation');
        if(container) container.appendChild(memberGeocoder.onAdd(map));
      }
    }

    function initMap(){
      if(typeof mapboxgl === 'undefined'){
        console.error('Mapbox GL failed to load');
        return;
      }
          mapboxgl.accessToken = MAPBOX_TOKEN;
          map = new mapboxgl.Map({
            container:'map',
            style: mapStyle,
            projection:'globe',
            center: startCenter,
            zoom: startZoom,
            pitch: startPitch,
            bearing: startBearing,
            attributionControl:true
          });
      addGeocoder();
      addMemberGeocoder();
      const geolocate = new mapboxgl.GeolocateControl({ positionOptions:{ enableHighAccuracy:true }, trackUserLocation:true });
      geolocate.on('geolocate', ()=>{ spinEnabled = false; localStorage.setItem('spinGlobe','false'); stopSpin(); setMode('map'); });
      const geoContainer = document.getElementById('geocoder');
      if(geoContainer){
        geoContainer.appendChild(geolocate.onAdd(map));
        const nav = new mapboxgl.NavigationControl({showZoom: false});
        geoContainer.appendChild(nav.onAdd(map));
      }
      try{
        map.scrollZoom.setWheelZoomRate(1/240);
        map.scrollZoom.setZoomRate(1/240);
      }catch{}
      map.on('style.load', () => {
        applySky(skyStyle);
      });
      map.on('load', ()=>{ $('.map-overlay').style.display='none'; addPostSource(); if(spinEnabled) startSpin(); updatePostPanel(); applyFilters(); });

        ['mousedown','wheel','touchstart','dragstart','pitchstart','rotatestart','zoomstart'].forEach(ev=> map.on(ev, haltSpin));
        map.on('pitch', () => {
          const pIn = document.getElementById('mapPitch');
          const pVal = document.getElementById('pitchVal');
          if(pIn) pIn.value = map.getPitch();
          if(pVal) pVal.textContent = map.getPitch().toFixed(0);
        });
        map.on('rotate', () => {
          const bIn = document.getElementById('mapBearing');
          const bVal = document.getElementById('bearingVal');
          if(bIn) bIn.value = map.getBearing();
          if(bVal) bVal.textContent = map.getBearing().toFixed(0);
        });
        map.on('moveend', () => {
          applyFilters();
          updatePostPanel();
          const center = map.getCenter().toArray();
          const zoom = map.getZoom();
          const pitch = map.getPitch();
          const bearing = map.getBearing();
          localStorage.setItem('mapView', JSON.stringify({center, zoom, pitch, bearing}));
        });
        map.on('click', () => {
          if(mode === 'posts') setMode('map');
        });
      }

    function startSpin(fromCurrent=false){
      if(mode!=='map') setMode('map');
      if(!spinEnabled || spinning || !map) return;
      if(map.getZoom() >= 5) return;
      if(typeof filterModal !== 'undefined' && filterModal) closeModal(filterModal);
      spinning = true;
      resultsWasHidden = document.body.classList.contains('hide-results');
      if(!resultsWasHidden){
        document.body.classList.add('hide-results');
        const resultsToggle = document.getElementById('resultsToggle');
        const resultsCol = document.querySelector('.results-col');
        if(resultsToggle) resultsToggle.setAttribute('aria-pressed','false');
        if(resultsCol) resultsCol.setAttribute('aria-hidden','true');
      }
      function step(){
        if(!spinning || !map) return;
        const c = map.getCenter();
        map.setCenter([c.lng + spinSpeed, c.lat]);
        requestAnimationFrame(step);
      }
      if(fromCurrent){
        requestAnimationFrame(step);
      }else{
        map.easeTo({center:[0,0], zoom:startZoom, pitch:0, essential:true});
        map.once('moveend', () => requestAnimationFrame(step));
      }
    }
    function stopSpin(){
      spinning = false;
      const wasHidden = resultsWasHidden;
      resultsWasHidden = null;
      if(wasHidden === false){
        const resultsToggle = document.getElementById('resultsToggle');
        const resultsCol = document.querySelector('.results-col');
        document.body.classList.remove('hide-results');
        if(resultsToggle) resultsToggle.setAttribute('aria-pressed','true');
        if(resultsCol) resultsCol.setAttribute('aria-hidden','false');
      }
      renderLists(filtered);
    }

    function haltSpin(){
      if(spinEnabled || spinning){
        spinEnabled = false;
        localStorage.setItem('spinGlobe','false');
        stopSpin();
      }
    }

    ['pointerdown','wheel','keydown','touchstart'].forEach(ev=>
      document.addEventListener(ev, haltSpin, {capture:true})
    );

    function updateSpinState(){
      const shouldSpin = spinLoadStart && (spinLoadType === 'all' || (spinLoadType === 'new' && firstVisit));
      if(shouldSpin !== spinEnabled){
        spinEnabled = shouldSpin;
        localStorage.setItem('spinGlobe', JSON.stringify(spinEnabled));
        if(spinEnabled) startSpin(); else stopSpin();
      }
    }

    window.spinGlobals = {
      get spinEnabled(){ return spinEnabled; },
      set spinEnabled(v){ spinEnabled = v; },
      get spinSpeed(){ return spinSpeed; },
      set spinSpeed(v){ spinSpeed = v; },
      get spinLoadStart(){ return spinLoadStart; },
      set spinLoadStart(v){ spinLoadStart = v; },
      get spinLoadType(){ return spinLoadType; },
      set spinLoadType(v){ spinLoadType = v; },
      get spinLogoClick(){ return spinLogoClick; },
      set spinLogoClick(v){ spinLogoClick = v; updateLogoClickState(); },
      startSpin,
      stopSpin,
      updateSpinState,
      updateLogoClickState
    };

    // Map layers
    function postsToGeoJSON(list){
      return { type:'FeatureCollection', features: list.map(p => ({ type:'Feature', properties:{id:p.id, title:p.title, city:p.city, cat:p.category}, geometry:{type:'Point', coordinates:[p.lng,p.lat]} })) };
    }

    function addPostSource(){
      if(!map) return;
      map.addSource('posts', { type:'geojson', data: postsToGeoJSON(posts), cluster:true, clusterRadius: 52 });
      map.addLayer({ id:'posts-heat', type:'heatmap', source:'posts', maxzoom:4, paint:{
        'heatmap-weight': 0.7, 'heatmap-intensity': 2.0, 'heatmap-radius': 40,
        'heatmap-color':[ 'interpolate',['linear'],['heatmap-density'], 0,'rgba(33,102,172,0)', 0.2,'rgba(103,169,207,.6)', 0.4,'rgba(209,229,240,.9)', 0.6,'rgba(253,219,146,.95)', 0.8,'rgba(239,138,98,.95)', 1,'rgba(178,24,43,.95)'] } });
      map.addLayer({ id:'clusters', type:'circle', source:'posts', filter:['has','point_count'], minzoom:3.5, paint:{
        'circle-color': ['step',['get','point_count'], '#24c6dc', 20, '#514a9d', 50, '#f7797d', 100, '#fbd786'],
        'circle-radius': ['step',['get','point_count'], 16, 20, 22, 50, 28, 100, 34],
        'circle-opacity': 0.85, 'circle-stroke-color':'#0b1623', 'circle-stroke-width':1 } });
      map.addLayer({ id:'cluster-count', type:'symbol', source:'posts', filter:['has','point_count'], minzoom:3.5, layout:{ 'text-field':['get','point_count_abbreviated'], 'text-size':12 }, paint:{'text-color':'#fff'} });
      // === 0528: Right‑click cluster -> open scrollable list (locks map) ===
      // Close list on outside click or ESC
      map.on('click', (e)=>{
        if(!listLocked) return; if(Date.now() - lastListOpenAt < 200) return;
        // ignore the click that just opened it
        if(Date.now() - lastListOpenAt < 200) return;
        const el = hoverPopup && hoverPopup.getElement();
        if(!el) { lockMap(false); return; }
        const within = el.contains(e.originalEvent.target);
        if(!within){ hoverPopup.remove(); hoverPopup=null; lockMap(false); }
      });
      window.addEventListener('keydown', (ev)=>{ if(ev.key==='Escape' && listLocked){ if(hoverPopup){ hoverPopup.remove(); hoverPopup=null; } lockMap(false); } });

      map.addLayer({ id:'unclustered', type:'circle', source:'posts', filter:['!', ['has','point_count']], paint:{
        'circle-color':[ 'match',['get','cat'], 'Film','#ff6b6b','Theatre','#ffd93d','Music','#38bdf8','Dance','#a78bfa','Photography','#34d399','Gallery','#f472b6','Auditions','#f59e0b','Talent','#22c55e','#ffce3a'],
        'circle-radius': 5, 'circle-stroke-width': 1, 'circle-stroke-color': '#0b1623', 'circle-blur': 0.2 } });
      // 0530: Right‑click a *venue marker* (unclustered point) -> show list of events at that venue
      map.on('contextmenu','unclustered', (e)=>{
        const f = e.features && e.features[0]; if(!f) return;
        if(e.preventDefault) e.preventDefault();
        const coords = f.geometry && f.geometry.coordinates; if(!coords || coords.length<2) return;
        const items = postsAtVenue(coords[0], coords[1]);
        if(!items || !items.length){ return; }
        openListPopupAtPoint(e.point, buildClusterListHTML(items));

        (function(){
          function consume(ev){ try{ ev.preventDefault(); }catch{} try{ ev.stopPropagation(); }catch{} }
          const _root = hoverPopup && hoverPopup.getElement ? hoverPopup.getElement() : null;
          if(_root){
            ['pointerdown','mousedown','mouseup','click'].forEach(t=> _root.addEventListener(t, consume, {capture:true}));
          }
        })();
    
        // Wire interactions
        const root = hoverPopup.getElement();
        const close = ()=>{ if(hoverPopup){ hoverPopup.remove(); hoverPopup=null; } lockMap(false); };
        root.addEventListener('click', (ev)=> ev.stopPropagation(), {capture:true});
        root.querySelectorAll('.multi-item').forEach(n => n.addEventListener('click', ()=>{
          const id = n.getAttribute('data-id'); close(); stopSpin(); openPost(id);
        }));
        const btn = root.querySelector('[data-act="close"]'); if(btn) btn.addEventListener('click', close);
        lockMap(true); lastListOpenAt = Date.now();
      });

      map.on('click','clusters', (e)=>{
        stopSpin();
        const features = map.queryRenderedFeatures(e.point, { layers:['clusters'] });
        const clusterId = features[0].properties.cluster_id;
        map.getSource('posts').getClusterExpansionZoom(clusterId, (err, zoom) => { if (err) return; map.easeTo({ center: features[0].geometry.coordinates, zoom }); });
      });
      
      map.on('click','unclustered', (e)=>{
        stopSpin();
        const f = e.features && e.features[0]; if(!f) return;
        const coords = f.geometry && f.geometry.coordinates;
        if(coords && coords.length>=2){
          const items = postsAtVenue(coords[0], coords[1]);
          if(items && items.length>1){
            if(e.preventDefault) e.preventDefault();
            if(e.originalEvent){ e.originalEvent.preventDefault(); e.originalEvent.stopPropagation(); }
            openListPopupAtPoint(e.point, buildClusterListHTML(items));
            const root = hoverPopup.getElement();
            const close = ()=>{ if(hoverPopup){ hoverPopup.remove(); hoverPopup=null; } lockMap(false); };
            root.addEventListener('click', (ev)=> ev.stopPropagation(), {capture:true});
            root.querySelectorAll('.multi-item').forEach(n => n.addEventListener('click', ()=>{ const id = n.getAttribute('data-id'); close(); stopSpin(); openPost(id); }));
            const btn = root.querySelector('[data-act="close"]'); if(btn) btn.addEventListener('click', close);
            lockMap(true);
            (function(){
              const __root = hoverPopup && hoverPopup.getElement ? hoverPopup.getElement() : null;
              if(__root){
                __root.addEventListener('click', function(ev){
                  ev.stopPropagation();
                  var row = (ev.target && ev.target.closest) ? ev.target.closest('.multi-item') : null;
                  if(row){
                    var pid = row.getAttribute('data-id');
                    if(pid){ if(hoverPopup){ hoverPopup.remove(); hoverPopup=null; } lockMap(false); stopSpin(); openPost(pid); return; }
                  }
                }, {capture:true});
              }
            })();
 lastListOpenAt = Date.now();
            return;
          }
        }
        const id = f.properties.id; openPost(id);
      });

      // Hover ring layer for individual points
      map.addLayer({ id:'hover-ring', type:'circle', source:'posts', filter:['==',['get','id'],'__none__'], paint:{
        'circle-color': '#ffffff', 'circle-opacity': 0, 'circle-stroke-color':'#fff', 'circle-stroke-opacity':0.95,
        'circle-stroke-width': 2, 'circle-radius': 12
      }});

      // Cursor + popup for unclustered points
      
      map.on('mouseenter','unclustered', (e)=>{
        map.getCanvas().style.cursor = 'pointer';
        const f = e.features && e.features[0]; if(!f) return;
        const id = f.properties.id; hoverId = id;
        map.setFilter('hover-ring', ['==',['get','id'], id]);
        const coords = f.geometry && f.geometry.coordinates;
        const multi = (coords && coords.length>=2) ? postsAtVenue(coords[0], coords[1]) : null;
        if(multi && multi.length>1){
          openListPopupAtPoint(e.point, buildClusterListHTML(multi));

        (function(){
          function consume(ev){ try{ ev.preventDefault(); }catch{} try{ ev.stopPropagation(); }catch{} }
          const _root = hoverPopup && hoverPopup.getElement ? hoverPopup.getElement() : null;
          if(_root){
            ['pointerdown','mousedown','mouseup','click'].forEach(t=> _root.addEventListener(t, consume, {capture:true}));
          }
        })();
    
          
        (function(){
          const __root = hoverPopup && hoverPopup.getElement ? hoverPopup.getElement() : null;
          if(__root){
            __root.addEventListener('click', function(ev){
              ev.stopPropagation();
              var row = (ev.target && ev.target.closest) ? ev.target.closest('.multi-item') : null;
              if(row){
                var pid = row.getAttribute('data-id');
                if(pid){ if(hoverPopup){ hoverPopup.remove(); hoverPopup=null; } stopSpin(); openPost(pid); return; }
              }
            }, {capture:true});
          }
        })();
// keep the hover popup alive when the pointer enters it
          const _el = hoverPopup && hoverPopup.getElement ? hoverPopup.getElement() : null;
          if(_el){
            _el.addEventListener('mouseenter', ()=>{ window.__overCard = true; });
            _el.addEventListener('mouseleave', ()=>{ window.__overCard = false; if(!listLocked && hoverPopup){ hoverPopup.remove(); hoverPopup=null; } });
          }
        } else {
          // single preview as usual
          const p = posts.find(x=>x.id===id); if(!p) return;
          if(hoverPopup) hoverPopup.remove();
          hoverPopup = new mapboxgl.Popup({closeButton:false, closeOnClick:false, className:'hover-pop'})
            .setLngLat(e.lngLat).setHTML(hoverHTML(p)).addTo(map);
          registerPopup(hoverPopup);

        (function(){
          function consume(ev){ try{ ev.preventDefault(); }catch{} try{ ev.stopPropagation(); }catch{} }
          const _root = hoverPopup && hoverPopup.getElement ? hoverPopup.getElement() : null;
          if(_root){
            ['pointerdown','mousedown','mouseup','click'].forEach(t=> _root.addEventListener(t, consume, {capture:true}));
          }
        })();
    
        
        (function(){
          const __el = hoverPopup && hoverPopup.getElement ? hoverPopup.getElement() : null;
          if(__el){
            __el.addEventListener('click', function(ev){
              ev.stopPropagation();
              try{ stopSpin(); openPost(id); }catch(e){ console.warn('openPost id missing', e); }
            }, {capture:true});
          }
        })();
}
      });
    
      map.on('mousemove','unclustered', (e)=>{ if(hoverPopup) hoverPopup.setLngLat(e.lngLat); });
      
      map.on('mouseleave','unclustered', ()=>{
        map.getCanvas().style.cursor = '';
        if(listLocked) return;
        setTimeout(()=>{
          if(!window.__overCard && hoverPopup){ hoverPopup.remove(); hoverPopup=null; }
        }, 180);
        hoverId = null; map.setFilter('hover-ring',['==',['get','id'],'__none__']);
      });


      // Popups for clusters (shows count)
      map.on('mouseenter','clusters', (e)=>{
        map.getCanvas().style.cursor='pointer';
        const f = e.features && e.features[0]; if(!f) return;
        const count = f.properties.point_count_abbreviated;
        if(hoverPopup) hoverPopup.remove();
        hoverPopup = new mapboxgl.Popup({closeButton:false, closeOnClick:false, className:'hover-pop'})
          .setLngLat(e.lngLat).setHTML(`<div class='hover-card'><div class='t'>${count} nearby posts</div></div>`).addTo(map);
        registerPopup(hoverPopup);
      });
      map.on('mousemove','clusters', (e)=>{ if(hoverPopup) hoverPopup.setLngLat(e.lngLat); });
      map.on('mouseleave','clusters', ()=>{ map.getCanvas().style.cursor=''; if(hoverPopup){ hoverPopup.remove(); hoverPopup=null; } });

    }

    const resultsEl = $('#results');
    const postsWideEl = $('#postsWide');
    const postsModeEl = $('.closed-posts');

    postsModeEl.addEventListener('scroll', () => {
      const last = postsWideEl.lastElementChild;
      if(!last) return;
      const limit = postsModeEl.getBoundingClientRect().top + 12;
      const lastTop = last.getBoundingClientRect().top;
      if(lastTop < limit){ postsModeEl.scrollTop -= (limit - lastTop); }
    });

    function renderLists(list){
      if(window.innerWidth < 1000){
        updateResultCount(list.length);
        return;
      }
      if(spinning) return;
      const sort = currentSort;
      const arr = list.slice();
      if(sort==='az') arr.sort((a,b)=> a.title.localeCompare(b.title));
      if(sort==='soon') arr.sort((a,b)=> a.dates[0].localeCompare(b.dates[0]));
      if(sort==='nearest'){
        let ref = {lng:0,lat:0}; if(map){ const c = map.getCenter(); ref = {lng:c.lng,lat:c.lat}; }
        arr.sort((a,b)=> distKm({lng:a.lng,lat:a.lat}, ref) - distKm({lng:b.lng,lat:b.lat}, ref));
      }
      if(favToTop) arr.sort((a,b)=> (b.fav - a.fav));

      let toRender = arr;
      if(spinning && arr.length){
        const sample = card(arr[0], true);
        sample.style.visibility = 'hidden';
        postsWideEl.appendChild(sample);
        const rect = sample.getBoundingClientRect();
        const style = getComputedStyle(sample);
        const cardHeight = rect.height + parseFloat(style.marginBottom || 0);
        postsWideEl.removeChild(sample);
        const max = Math.max(1, Math.floor(postsModeEl.clientHeight / cardHeight));
        toRender = arr.slice(0, max);
      }

      resultsEl.innerHTML = '';
      postsWideEl.innerHTML = '';
      toRender.forEach(p => { resultsEl.appendChild(card(p)); postsWideEl.appendChild(card(p, true)); });
      if(activePostId){
        const sel = resultsEl.querySelector(`[data-id="${activePostId}"]`);
        if(sel) sel.setAttribute('aria-selected','true');
      }
      updateResultCount(toRender.length);
      prioritizeVisibleImages();
    }
    function updateResultCount(n){ $('#resultCount').innerHTML = `<strong>${n}</strong> Results`; }
    function formatDates(d){
      if(!d || !d.length) return '';
      const fmt = iso => new Date(iso).toLocaleDateString('en-GB',{weekday:'short', day:'numeric', month:'short'}).replace(/,/g,'');
      if(d.length===1) return fmt(d[0]);
      return `${fmt(d[0])} + ${d.length-1} more`;
    }

    function prioritizeVisibleImages(){
      const roots = [resultsEl, postsWideEl];
      roots.forEach(root => {
        if(!root) return;
        const imgs = root.querySelectorAll('img.thumb');
        if(!imgs.length) return;
        if('IntersectionObserver' in window){
          const obs = new IntersectionObserver(entries => {
            entries.forEach(entry => {
              if(entry.isIntersecting){
                const img = entry.target;
                img.loading = 'eager';
                img.fetchPriority = 'high';
                obs.unobserve(img);
              }
            });
          }, {root});
          imgs.forEach(img => obs.observe(img));
        } else {
          imgs.forEach(img => img.loading = 'eager');
        }
      });
    }

    function card(p, wide=false){
      const el = document.createElement('article');
      el.className = 'card';
      el.dataset.id = p.id;
      if(wide) el.style.gridTemplateColumns='80px 1fr 36px';
      el.innerHTML = `
        <img class="thumb" src="${imgThumb(p)}" alt="" loading="lazy" referrerpolicy="no-referrer" />
        <div class="meta">
          <div class="title">${p.title}</div>
          <div class="info">
            <div class="cat-line"><span class="sub-icon">${subcategoryIcons[p.subcategory]||''}</span> ${p.category} &gt; ${p.subcategory}</div>
            <div class="loc-line"><span class="badge" title="Venue">📍</span><span>${p.city}</span></div>
            <div class="date-line"><span class="badge" title="Dates">📅</span><span>${formatDates(p.dates)}</span></div>
          </div>
        </div>
        <button class="fav" aria-pressed="${p.fav?'true':'false'}" aria-label="Toggle favourite">
          <svg viewBox="0 0 24 24"><path d="M12 17.3 6.2 21l1.6-6.7L2 9.3l6.9-.6L12 2l3.1 6.7 6.9.6-5.8 4.9L17.8 21 12 17.3z"/></svg>
        </button>
      `;
      el.addEventListener('click', (e)=>{ if(e.target.closest('.fav')) return; stopSpin(); openPost(p.id, wide); });
      el.querySelector('.fav').addEventListener('click', (e)=>{
        p.fav = !p.fav;
        document.querySelectorAll(`[data-id="${p.id}"] .fav`).forEach(btn=>{
          btn.setAttribute('aria-pressed', p.fav ? 'true' : 'false');
        });
        renderFooter();
      });
      return el;
    }

    // Footer history
    const footRow = $('#footRow');
    function loadHistory(){ try{ return JSON.parse(localStorage.getItem('openHistoryV2')||'[]'); }catch(e){ return []; } }
    function saveHistory(){ localStorage.setItem('openHistoryV2', JSON.stringify(viewHistory)); }

    function captureState(){
      return {
        bounds: map ? map.getBounds().toArray() : null,
        kw: $('#kwInput').value,
        date: $('#dateInput').value,
        range: $('#dateInput').dataset.range,
        today: $('#todayToggle').checked,
        cats: [...selection.cats],
        subs: [...selection.subs]
      };
    }

    function restoreState(st){
      if(!st) return;
      $('#kwInput').value = st.kw || '';
      $('#dateInput').value = st.date || '';
      $('#dateInput').dataset.range = st.range || '';
      $('#todayToggle').checked = st.today || false;
      if($('#todayToggle').checked){
        $('#dateInput').value = 'Today Onwards';
        $('#dateInput').dataset.range = '';
      }
      selection.cats = new Set(st.cats || []);
      selection.subs = new Set(st.subs || []);
      $$('.cat').forEach(el=>{
        const label = el.querySelector('.label').textContent;
        const expanded = selection.cats.has(label);
        el.setAttribute('aria-expanded', expanded?'true':'false');
        el.querySelectorAll('.sub .chip').forEach(ch=>{
          const subName = ch.textContent.trim();
          const key = label+'::'+subName;
          if(selection.subs.has(key)) ch.classList.add('on'); else ch.classList.remove('on');
        });
      });
      if(map && st.bounds){
        stopSpin();
        const bounds = new mapboxgl.LngLatBounds(st.bounds);
        map.fitBounds(bounds, {duration:0});
        postPanel = bounds;
      }
      applyFilters();
      updateClearButtons();
    }
    function renderFooter(){
      footRow.innerHTML='';
      if(!viewHistory.length){ return; }
      // render oldest -> newest so newest appears at the far right
      const items = viewHistory.slice().reverse(); // reverse because viewHistory is newest-first
        for(const v of items){
          const p = posts.find(x=>x.id===v.id);
          const el = document.createElement('div');
          el.className='chip-small foot-item';
          el.dataset.id = v.id;
          el.title=v.title+' — '+v.city;
          const favIcon = p && p.fav ? '<span class="fav-star" aria-hidden="true">★</span>' : '';
          el.innerHTML = `<img class="mini" src="${imgThumb(v.id)}" alt="" loading="lazy" referrerpolicy="no-referrer"/><div class="t">${v.title}</div>${favIcon}`;
          if(v.id===activePostId) el.setAttribute('aria-selected','true');
          el.addEventListener('click', ()=>{ stopSpin(); if(v.state) restoreState(v.state); openPost(v.id); });
          footRow.appendChild(el);
        }
      // scroll to the far right to reveal the newest
      footRow.scrollLeft = footRow.scrollWidth;
    }

    function buildDetail(p){
      const wrap = document.createElement('div');
      wrap.className = 'open-posts';
      wrap.dataset.id = p.id;
      wrap.innerHTML = `
        <div class="detail-header">
          <div class="title-block">
            <div class="t">${p.title}</div>
            <div class="cat-line"><span class="sub-icon">${subcategoryIcons[p.subcategory]||''}</span> ${p.category} &gt; ${p.subcategory}</div>
          </div>
          <button class="fav" aria-pressed="${p.fav?'true':'false'}" aria-label="Toggle favourite">
            <svg viewBox="0 0 24 24"><path d="M12 17.3 6.2 21l1.6-6.7L2 9.3l6.9-.6L12 2l3.1 6.7 6.9.6-5.8 4.9L17.8 21 12 17.3z"/></svg>
          </button>
        </div>
        <div class="body">
          <div class="img-area">
            <div class="img-box"><img id="hero-img" class="lqip" src="${thumbUrl(p)}" data-full="${heroUrl(p)}" alt="" loading="eager" fetchpriority="high" referrerpolicy="no-referrer" onerror="this.onerror=null; this.src='${imgThumb(p)}';"/></div>
            <div class="thumb-column"></div>
          </div>
          <div class="text">
            <div class="location-section">
              <div class="map-container">
                <div id="map-${p.id}" class="post-map"></div>
                <div id="venue-${p.id}" class="venue-dropdown options-dropdown ${p.locations.length>1?'':'single'}"><button class="venue-btn" aria-haspopup="true" aria-expanded="false"><span class="venue-name">${p.locations[0].venue}</span><span class="venue-address">${p.locations[0].address}</span>${p.locations.length>1?'<span class="dropdown-arrow">&#9662;</span>':''}</button><div class="venue-menu options-menu" hidden>${p.locations.map((loc,i)=>`<button data-index="${i}"><span class="venue-name">${loc.venue}</span><span class="venue-address">${loc.address}</span></button>`).join('')}</div></div>
              </div>
              <div class="calendar-container">
                <div id="cal-${p.id}" class="post-calendar"></div>
                <div id="sess-${p.id}" class="session-dropdown options-dropdown ${p.locations[0].dates.length>1?'':'single'}"><button class="sess-btn" aria-haspopup="true" aria-expanded="false"><span class="sess-label">Select Session</span>${p.locations[0].dates.length>1?'<span class="dropdown-arrow">&#9662;</span>':''}</button><div class="session-menu options-menu" hidden></div></div>
              </div>
            </div>
            <h2 class="title">${p.title}</h2>
            <div class="cat-line"><span class="sub-icon">${subcategoryIcons[p.subcategory]||''}</span> ${p.category} &gt; ${p.subcategory}</div>
            <div id="venue-info-${p.id}" class="venue-info"></div>
            <div id="session-info-${p.id}" class="session-info">
              <div class="placeholder">💲 Price range | 📅 Date range</div>
            </div>
            <div class="desc">${p.desc}</div>
          </div>
        </div>`;
        // progressive hero swap
        (function(){
          const img = wrap.querySelector('#hero-img');
          if(img){
            const full = img.getAttribute('data-full');
            const hi = new Image();
            hi.referrerPolicy = 'no-referrer';
            hi.fetchPriority = 'high';
            hi.onload = ()=>{
              const swap = ()=>{ img.src = full; img.classList.remove('lqip'); img.classList.add('ready'); };
              if(hi.decode){ hi.decode().then(swap).catch(swap); } else { swap(); }
            };
            hi.onerror = ()=>{};
            hi.src = full;
          }
        })();
        return wrap;
    }

    async function openPost(id, fromPosts=false){
      spinEnabled = false;
      localStorage.setItem('spinGlobe', 'false');
      stopSpin();
      const p = posts.find(x=>x.id===id); if(!p) return;
      activePostId = id;
      $$('.card[aria-selected="true"]').forEach(el=>el.removeAttribute('aria-selected'));
      $$('footer .foot-row .foot-item[aria-selected="true"]').forEach(el=>el.removeAttribute('aria-selected'));
      $$('.mapboxgl-popup .hover-card[aria-selected="true"]').forEach(el=>el.removeAttribute('aria-selected'));
      if(mode !== 'posts'){
        setMode('posts');
        await nextFrame(); await nextFrame();
      }

      if(!postsWideEl.children.length){ renderLists(filtered); await nextFrame(); }

      (function(){
        const ex = postsWideEl.querySelector('.open-posts');
        if(ex){
          const exId = ex.dataset && ex.dataset.id;
          const prev = posts.find(x=> x.id===exId);
          if(prev){ ex.replaceWith(card(prev, true)); } else { ex.remove(); }
        }
      })();

      let target = postsWideEl.querySelector(`[data-id="${id}"]`);
      if(!target){ renderLists(filtered); await nextFrame(); target = postsWideEl.querySelector(`[data-id="${id}"]`); }
      if(!target){ return; }
      const resCard = resultsEl.querySelector(`[data-id="${id}"]`);
      if(resCard) resCard.setAttribute('aria-selected','true');
      const mapCard = document.querySelector('.mapboxgl-popup .hover-card');
      if(mapCard) mapCard.setAttribute('aria-selected','true');

      const container = target.closest('.closed-posts');
      if(container){
        if(!fromPosts){
          const top = target.offsetTop - parseInt(getComputedStyle(container).paddingTop,10) - 12;
          container.scrollTop = Math.max(top, 0);
        }
      } else {
        target.scrollIntoView({block:'start', inline:'nearest', behavior:'auto'});
      }

      const detail = buildDetail(p);
      // class already applied in buildDetail
      target.replaceWith(detail);
      hookDetailActions(detail, p);
      if (typeof updateStickyImages === 'function') {
        updateStickyImages();
      }

      if(container){
        if(!fromPosts){
          const top = detail.offsetTop - parseInt(getComputedStyle(container).paddingTop,10) - 12;
          container.scrollTop = Math.max(top, 0);
        }
        ensureGap(container, detail);
      } else {
        detail.scrollIntoView({block:'start', inline:'nearest', behavior:'auto'});
      }


      // Update history on open (keep newest-first)
      viewHistory = viewHistory.filter(x=>x.id!==id);
      viewHistory.unshift({id:p.id, title:p.title, city:p.city, state:captureState()});
      if(viewHistory.length>100) viewHistory.length=100;
      saveHistory(); renderFooter();
    }

    function ensureGap(container, el){
      const pad = parseInt(getComputedStyle(container).paddingTop, 10) || 0;
      const desired = el.offsetTop - pad - 12;
      if(container.scrollTop > desired){ container.scrollTop = Math.max(desired, 0); }
    }

    function hookDetailActions(el, p){
      const favBtn = el.querySelector('.fav');
      if(favBtn){
        favBtn.addEventListener('click', (e)=>{
          e.stopPropagation();
          p.fav = !p.fav;
          document.querySelectorAll(`[data-id="${p.id}"] .fav`).forEach(btn=>{
            btn.setAttribute('aria-pressed', p.fav ? 'true' : 'false');
          });
          const detailEl = el;
          const container = detailEl.closest('.closed-posts');
          renderFooter();
          const replacement = postsWideEl.querySelector(`[data-id="${p.id}"]`);
          if(replacement){
            replacement.replaceWith(detailEl);
            if(container){
              ensureGap(container, detailEl);
            } else {
              detailEl.scrollIntoView({block:'start', inline:'nearest', behavior:'auto'});
            }
          }
        });
      }

      const imgs = p.images && p.images.length ? p.images : [imgHero(p)];
      const thumbCol = el.querySelector('.thumb-column');
      const mainImg = el.querySelector('.img-box img');
      imgs.forEach((url,i)=>{
        const t = document.createElement('img');
        t.src = url;
        t.dataset.full = url;
        t.dataset.index = i;
        t.tabIndex = 0;
        thumbCol.appendChild(t);
      });
      function show(idx){
        const t = thumbCol.querySelector(`img[data-index="${idx}"]`);
        if(!t) return;
        mainImg.src = t.src;
        mainImg.dataset.index = idx;
        const hi = new Image();
        const full = t.dataset.full;
        hi.onload = ()=>{ if(mainImg.dataset.index==idx) mainImg.src = full; };
        hi.src = full;
        thumbCol.querySelectorAll('img').forEach(im=> im.classList.toggle('selected', im===t));
      }
      show(0);
      thumbCol.addEventListener('click', e=>{
        const t = e.target.closest('img');
        if(t) show(parseInt(t.dataset.index,10));
      });
      thumbCol.addEventListener('keydown', e=>{
        const cur = parseInt(mainImg.dataset.index||'0',10);
        if(e.key==='ArrowDown'){
          e.preventDefault();
          const ni = Math.min(cur+1, imgs.length-1);
          show(ni);
          thumbCol.querySelector(`img[data-index="${ni}"]`).focus();
        } else if(e.key==='ArrowUp'){
          e.preventDefault();
          const ni = Math.max(cur-1,0);
          show(ni);
          thumbCol.querySelector(`img[data-index="${ni}"]`).focus();
        }
      });
      function openImageModal(start){
        const modal = document.createElement('div');
        modal.className = 'img-modal';
        const imgEl = document.createElement('img');
        let idx = start;
        imgEl.src = imgs[idx];
        imgEl.dataset.index = idx;
        modal.appendChild(imgEl);
        function next(){
          idx = (idx+1)%imgs.length;
          imgEl.src = imgs[idx];
          imgEl.dataset.index = idx;
        }
        const entry = {remove: ()=> modal.remove()};
        modal.addEventListener('click', e=>{
          if(e.target===modal){
            modal.remove();
            const i = modalStack.indexOf(entry);
            if(i!==-1) modalStack.splice(i,1);
          } else {
            next();
          }
        });
        imgEl.addEventListener('click', next);
        document.body.appendChild(modal);
        modalStack.push(entry);
      }
      mainImg.addEventListener('click', ()=> openImageModal(parseInt(mainImg.dataset.index||'0',10)));
      const venueDropdown = el.querySelector(`#venue-${p.id}`);
      const venueBtn = venueDropdown ? venueDropdown.querySelector('.venue-btn') : null;
      const venueMenu = venueDropdown ? venueDropdown.querySelector('.venue-menu') : null;
      const venueInfo = el.querySelector(`#venue-info-${p.id}`);
      const sessDropdown = el.querySelector(`#sess-${p.id}`);
      const sessBtn = sessDropdown ? sessDropdown.querySelector('.sess-btn') : null;
      const sessMenu = sessDropdown ? sessDropdown.querySelector('.session-menu') : null;
      const sessionInfo = el.querySelector(`#session-info-${p.id}`);
      const calendarEl = el.querySelector(`#cal-${p.id}`);
      const mapEl = el.querySelector(`#map-${p.id}`);
      let map, marker, picker;
      function updateVenue(idx){
        const loc = p.locations[idx];
        loc.dates.sort((a,b)=> a.full.localeCompare(b.full) || a.time.localeCompare(b.time));
        if(venueInfo) venueInfo.innerHTML = `<strong>${loc.venue}</strong><br>${loc.address}`;
        if(venueBtn) venueBtn.innerHTML = `<span class="venue-name">${loc.venue}</span><span class="venue-address">${loc.address}</span>${p.locations.length>1?'<span class="dropdown-arrow">&#9662;</span>':''}`;
        if(!map){
          map = new mapboxgl.Map({
            container: mapEl,
            style: mapStyle,
            center: [loc.lng, loc.lat],
            zoom: 10,
            interactive: false
          });
          marker = new mapboxgl.Marker().setLngLat([loc.lng, loc.lat]).addTo(map);
        } else {
          map.setCenter([loc.lng, loc.lat]);
          marker.setLngLat([loc.lng, loc.lat]);
        }
        if(picker){ picker.destroy(); }
        const dateStrings = Array.from(new Set(loc.dates.map(d=>d.full)));
        const allowedSet = new Set(dateStrings);
        const firstDate = dateStrings[0];
        const lastDate = dateStrings[dateStrings.length-1] || firstDate;
        picker = new Litepicker({
          element: calendarEl,
          container: calendarEl,
          inlineMode: true,
          selectMode: 'single',
          highlightedDates: dateStrings,
          startDate: firstDate,
          minDate: firstDate,
          maxDate: lastDate,
          numberOfMonths: 1,
          numberOfColumns: 1,
          lockDaysFilter: (date)=> !allowedSet.has(date.format('YYYY-MM-DD'))
        });
        const lp = calendarEl.querySelector('.litepicker');
        if(lp && mapEl) lp.style.width = mapEl.offsetWidth + 'px';
        if(lp && sessMenu && window.matchMedia('(min-width:1001px)').matches) sessMenu.style.width = lp.offsetWidth + 'px';
        calendarEl.addEventListener('click', e=> e.stopPropagation());
        let ignoreSelect = false;
        function highlightMonth(){
          calendarEl.querySelectorAll('.month-name').forEach(n=> n.classList.remove('selected-month-name'));
          const m = calendarEl.querySelector('.month-name');
          if(m) m.classList.add('selected-month-name');
        }
        highlightMonth();
        picker.on('render:month', highlightMonth);
        function selectSession(i){
          if(!sessMenu) return;
          sessMenu.querySelectorAll('button').forEach(b=> b.classList.remove('selected'));
          const btn = sessMenu.querySelector(`button[data-index="${i}"]`);
            if(btn) btn.classList.add('selected');
            const dt = loc.dates[i];
            if(dt){
              sessionInfo.innerHTML = `<div><strong>${dt.date} ${dt.time}</strong></div><div>Adults $${dt.price.adult.toFixed(2)}, Kids $${dt.price.kid.toFixed(2)}, Pensioners $${dt.price.pensioner.toFixed(2)}</div><div>🎫 Buy at venue | ♿ Accessible | 👶 Kid-friendly</div>`;
              if(sessBtn) sessBtn.innerHTML = `<span class="session-date">${dt.date}</span><span class="session-time">${dt.time}</span>${loc.dates.length>1?'<span class="dropdown-arrow">&#9662;</span>':''}`;
              ignoreSelect = true;
              picker.setDate(dt.full);
              picker.gotoDate(dt.full);
              ignoreSelect = false;
              picker.setOptions({ highlightedDates: dateStrings });
              highlightMonth();
            } else {
              const priceVals = loc.dates.flatMap(d=>[d.price.adult,d.price.kid,d.price.pensioner]);
              const minP = Math.min(...priceVals);
              const maxP = Math.max(...priceVals);
              const first = loc.dates[0]?.date;
              const last = loc.dates[loc.dates.length-1]?.date || first;
              sessionInfo.innerHTML = `<div>💲 $${minP.toFixed(2)} - $${maxP.toFixed(2)} | 📅 ${first} - ${last}</div>`;
              if(sessBtn) sessBtn.innerHTML = `<span class="sess-label">Select Session</span>${loc.dates.length>1?'<span class="dropdown-arrow">&#9662;</span>':''}`;
              picker.clearSelection();
              picker.setOptions({ highlightedDates: dateStrings });
              highlightMonth();
            }
            sessMenu.hidden = true;
            sessBtn && sessBtn.setAttribute('aria-expanded','false');
          }
        function showTimePopup(matches){
          const popup = document.createElement('div');
          popup.className = 'time-popup';
          popup.innerHTML = `<div class="time-list">${matches.map(m=>`<button data-index="${m.i}">${m.d.time}</button>`).join('')}</div>`;
          calendarEl.appendChild(popup);
          popup.querySelectorAll('button').forEach(b=> b.addEventListener('click',()=>{ selectSession(parseInt(b.dataset.index,10)); popup.remove(); }));
          popup.addEventListener('click', e=>{ if(e.target===popup) popup.remove(); });
        }
          picker.on('selected', (date)=>{
            if(ignoreSelect) return;
            const ds = date.format('YYYY-MM-DD');
            const matches = loc.dates.map((d,i)=>({i,d})).filter(o=> o.d.full===ds);
            if(matches.length===1){
              selectSession(matches[0].i);
            } else if(matches.length>1){
              showTimePopup(matches);
            } else {
              picker.clearSelection();
              highlightMonth();
            }
          });
        setTimeout(()=>{
          mapEl.style.height = calendarEl.offsetHeight + 'px';
          if(map && typeof map.resize === 'function') map.resize();
        },0);
          if(sessMenu){
            sessMenu.innerHTML = loc.dates.map((d,i)=> `<button data-index="${i}"><span class="session-date">${d.date}</span><span class="session-time">${d.time}</span></button>`).join('');
            sessMenu.scrollTop = 0;
            const hasMultipleSessions = loc.dates.length>1;
            sessDropdown.classList.toggle('single', !hasMultipleSessions);
            if(sessBtn){
              sessBtn.innerHTML = `<span class="sess-label">Select Session</span>${hasMultipleSessions?'<span class="dropdown-arrow">&#9662;</span>':''}`;
              sessBtn.setAttribute('aria-expanded','false');
            }
            const priceVals = loc.dates.flatMap(d=>[d.price.adult,d.price.kid,d.price.pensioner]);
            const minP = Math.min(...priceVals);
            const maxP = Math.max(...priceVals);
            const first = loc.dates[0]?.date;
            const last = loc.dates[loc.dates.length-1]?.date || first;
            if(sessionInfo) sessionInfo.innerHTML = `<div>💲 $${minP.toFixed(2)} - $${maxP.toFixed(2)} | 📅 ${first} - ${last}</div>`;
            sessMenu.querySelectorAll('button').forEach(btn=>{
              btn.addEventListener('click', ()=> selectSession(parseInt(btn.dataset.index,10)));
            });
            if(!hasMultipleSessions && loc.dates.length === 1){
              selectSession(0);
            }
          }
      }
      if(mapEl){
        setTimeout(()=>{
          updateVenue(0);
          if(venueMenu && venueBtn){
            venueMenu.querySelectorAll('button').forEach(btn=>{
              if(btn.dataset.index==='0') btn.classList.add('selected');
              btn.addEventListener('click', ()=>{
                venueMenu.querySelectorAll('button').forEach(b=> b.classList.remove('selected'));
                btn.classList.add('selected');
                updateVenue(parseInt(btn.dataset.index,10));
                venueMenu.hidden = true;
                venueBtn.setAttribute('aria-expanded','false');
              });
            });
            venueBtn.addEventListener('click', ()=>{
              const expanded = venueBtn.getAttribute('aria-expanded') === 'true';
              venueBtn.setAttribute('aria-expanded', String(!expanded));
              venueMenu.hidden = expanded;
            });
            document.addEventListener('click', e=>{ if(venueDropdown && !venueDropdown.contains(e.target)){ venueMenu.hidden = true; venueBtn.setAttribute('aria-expanded','false'); } });
          }
          if(sessBtn && sessMenu){
            sessBtn.addEventListener('click', ()=>{
              const expanded = sessBtn.getAttribute('aria-expanded') === 'true';
              sessBtn.setAttribute('aria-expanded', String(!expanded));
              sessMenu.hidden = expanded;
            });
            document.addEventListener('click', e=>{ if(sessDropdown && !sessDropdown.contains(e.target)){ sessMenu.hidden = true; sessBtn.setAttribute('aria-expanded','false'); } });
          }
          if(map && typeof map.resize === 'function') map.resize();
        },0);
      }
    }

    footRow.addEventListener('wheel', (e)=>{ if(Math.abs(e.deltaY) > Math.abs(e.deltaX)){ footRow.scrollLeft += e.deltaY; e.preventDefault(); } }, {passive:false});

    function inBounds(p){
      if(!postPanel) return true;
      return p.lng >= postPanel.getWest() && p.lng <= postPanel.getEast() &&
             p.lat >= postPanel.getSouth() && p.lat <= postPanel.getNorth();
    }
    function kwMatch(p){ const kw = $('#kwInput').value.trim().toLowerCase(); if(!kw) return true; return (p.title+' '+p.city+' '+p.category+' '+p.subcategory).toLowerCase().includes(kw); }
    function dateMatch(p){
      const todayChk = $('#todayToggle');
      if(todayChk && todayChk.checked){
        const today = new Date(); today.setHours(0,0,0,0);
        return p.dates.some(d => new Date(d) >= today);
      }
      const raw = $('#dateInput').dataset.range || $('#dateInput').value.trim();
      if(!raw){
        return true;
      }
      let start, end;
      const parts = raw.split(/to/i).map(s=>s.trim()).filter(Boolean);
      if(parts[0]) start = new Date(parts[0]);
      if(parts[1]) end = new Date(parts[1]);
      return p.dates.some(d => {
        const dt = new Date(d);
        if(start && dt < start) return false;
        if(end && dt > end) return false;
        return true;
      });
    }
    function catMatch(p){ if(selection.cats.size===0 && selection.subs.size===0) return true; const cOk = selection.cats.size===0 || selection.cats.has(p.category); const sOk = selection.subs.size===0 || selection.subs.has(p.category+'::'+p.subcategory); return cOk && sOk; }

    function applyFilters(){
      filtered = posts.filter(p => inBounds(p) && kwMatch(p) && dateMatch(p) && catMatch(p));
      renderLists(filtered);
      if(map && map.getSource('posts')){ map.getSource('posts').setData(postsToGeoJSON(filtered)); }
      const hasActiveFilters = $('#kwInput').value.trim() || $('#dateInput').value.trim() || $('#dateInput').dataset.range || selection.cats.size || selection.subs.size || $('#todayToggle').checked;
      if(filterBtn) filterBtn.classList.toggle('active', !!hasActiveFilters);
    }

    applyFilters();
    setMode('map');
    renderFooter();
  })();
  
// 0577 helpers (safety)
function heroUrl(p){ const id = (typeof p==='string')? p : p.id; return `https://picsum.photos/seed/${encodeURIComponent(id)}-t/1200/800`; }
function thumbUrl(p){ const id = (typeof p==='string')? p : p.id; return `https://picsum.photos/seed/${encodeURIComponent(id)}-t/300/200`; }
const modalStack = [];
function bringToTop(item){
  const idx = modalStack.indexOf(item);
  if(idx!==-1) modalStack.splice(idx,1);
  modalStack.push(item);
}
function registerPopup(p){
  bringToTop(p);
  if(typeof p.on==='function'){
    p.on('close',()=>{
      const i = modalStack.indexOf(p);
      if(i!==-1) modalStack.splice(i,1);
    });
  }
  const el = p.getElement && p.getElement();
  if(el){
    el.addEventListener('mousedown', ()=> bringToTop(p));
  }
}
function saveModalState(m){
  if(!m || !m.id || m.id === 'welcomeModal') return;
  const content = m.querySelector('.modal-content');
  if(!content) return;
  const state = {
    left: content.style.left,
    top: content.style.top,
    width: content.style.width,
    height: content.style.height
  };
  localStorage.setItem(`modal-${m.id}`, JSON.stringify(state));
}
function loadModalState(m){
  if(!m || !m.id) return;
  const content = m.querySelector('.modal-content');
  if(!content) return;
  const saved = JSON.parse(localStorage.getItem(`modal-${m.id}`) || 'null');
  if(saved){
    ['width','height','left','top'].forEach(prop=>{
      if(saved[prop]) content.style[prop] = saved[prop];
    });
    if(saved.left || saved.top) content.style.transform = 'none';
  }
}
function openModal(m){
  const content = m.querySelector('.modal-content');
  if(content){
    content.style.width = '';
    content.style.height = '';
    if(m.id !== 'welcomeModal') loadModalState(m);
    if(m.id === 'filterModal'){
      const subHead = document.querySelector('.subheader');
      const topPos = subHead ? subHead.getBoundingClientRect().bottom : parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--header-h')) || 0;
      const footerH = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--footer-h')) || 0;
      const availableHeight = window.innerHeight - footerH - topPos;
      if(!content.style.left) content.style.left = '0';
      if(!content.style.top) content.style.top = `${topPos}px`;
      content.style.maxHeight = `${availableHeight}px`;
      if(!content.style.transform) content.style.transform = '';
    } else if(m.id === 'welcomeModal'){
      const subHead = document.querySelector('.subheader');
      const topPos = (subHead ? subHead.getBoundingClientRect().bottom : parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--header-h')) || 0) + 20;
      if(!content.style.left) content.style.left = '50%';
      if(!content.style.top) content.style.top = `${topPos}px`;
      content.style.transform = 'translate(-50%, 0)';
    } else if(m.id === 'memberModal' || m.id === 'adminModal'){
      const header = document.querySelector('header');
      const topPos = header ? header.getBoundingClientRect().bottom : parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--header-h')) || 0;
      if(!content.style.left && !content.style.right){
        content.style.right = '0';
        content.style.left = '';
        content.style.top = `${topPos}px`;
        content.style.transform = 'none';
      }
    } else {
      if(!content.style.left){
        content.style.left = '50%';
        content.style.top = '50%';
        content.style.transform = 'translate(-50%, -50%)';
      }
    }
  }
  m.classList.add('show');
  m.removeAttribute('aria-hidden');
  localStorage.setItem(`modal-open-${m.id}`,'true');
  if(!m.__bringToTopAdded){
    m.addEventListener('mousedown', ()=> bringToTop(m));
    m.__bringToTopAdded = true;
  }
  bringToTop(m);
  if(map && typeof map.resize === 'function') setTimeout(()=> map.resize(),0);
}
function closeModal(m){
  saveModalState(m);
  m.classList.remove('show');
  m.setAttribute('aria-hidden','true');
  localStorage.setItem(`modal-open-${m.id}`,'false');
  if(m.id === 'welcomeModal') localStorage.setItem('welcomeSeen','true');
  const idx = modalStack.indexOf(m);
  if(idx!==-1) modalStack.splice(idx,1);
  if(map && typeof map.resize === 'function') setTimeout(()=> map.resize(),0);
}
function requestCloseModal(m){
  closeModal(m);
}
function toggleModal(m){
  if(m.classList.contains('show')){
    requestCloseModal(m);
  } else {
    openModal(m);
  }
}
function moveModalToEdge(modal, side){
  if(!modal) return;
  const content = modal.querySelector('.modal-content');
  if(!content) return;
  let topPos;
  if(modal.id === 'filterModal'){
    const subHead = document.querySelector('.subheader');
    topPos = subHead ? subHead.getBoundingClientRect().bottom : parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--header-h')) || 0;
  } else {
    const header = document.querySelector('header');
    topPos = header ? header.getBoundingClientRect().bottom : parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--header-h')) || 0;
  }
  content.style.top = `${topPos}px`;
  content.style.transform = 'none';
  if(side === 'left'){
    content.style.left = '0';
    content.style.right = '';
  } else {
    content.style.left = '';
    content.style.right = '0';
  }
  saveModalState(modal);
}
function handleEsc(){
  const top = modalStack[modalStack.length-1];
  if(!top) return;
  if(top instanceof Element){
    if(top.id === 'adminModal' && typeof window.saveAdminChanges === 'function'){
      window.saveAdminChanges();
    }
    requestCloseModal(top);
  } else if(typeof top.remove==='function'){
    modalStack.pop();
    top.remove();
  }
}
document.addEventListener('keydown', e=>{ if(e.key==='Escape') handleEsc(); });

// Modals and admin/member interactions
(function(){
  const memberBtn = document.getElementById('memberBtn');
  const adminBtn = document.getElementById('adminBtn');
  const filterBtn = document.getElementById('filterBtn');
  const memberModal = document.getElementById('memberModal');
  const adminModal = document.getElementById('adminModal');
  const filterModal = document.getElementById('filterModal');
  const sg = window.spinGlobals || {};

  memberBtn && memberBtn.addEventListener('click', ()=> toggleModal(memberModal));
    adminBtn && adminBtn.addEventListener('click', ()=>{
      syncAdminControls();
      toggleModal(adminModal);
    });
  filterBtn && filterBtn.addEventListener('click', ()=> toggleModal(filterModal));
  document.querySelectorAll('.modal .close-modal').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const modal = btn.closest('.modal');
      if(modal && modal.id === 'adminModal') return;
      requestCloseModal(modal);
    });
  });
  document.querySelectorAll('.modal .move-left').forEach(btn=>{
    btn.addEventListener('click', e=>{
      e.stopPropagation();
      const modal = btn.closest('.modal');
      moveModalToEdge(modal, 'left');
    });
  });
  document.querySelectorAll('.modal .move-right').forEach(btn=>{
    btn.addEventListener('click', e=>{
      e.stopPropagation();
      const modal = btn.closest('.modal');
      moveModalToEdge(modal, 'right');
    });
  });

  const welcomeModal = document.getElementById('welcomeModal');
  [filterModal, memberModal, adminModal, welcomeModal].forEach(m=>{
    if(m && localStorage.getItem(`modal-open-${m.id}`) === 'true'){
      if(m.id !== 'filterModal' || !window.matchMedia('(max-width:1000px)').matches){
        openModal(m);
      } else {
        localStorage.setItem(`modal-open-${m.id}`,'false');
      }
    }
  });
  if(welcomeModal){
    welcomeModal.addEventListener('click', e=>{
      if(e.target === welcomeModal) closeModal(welcomeModal);
    });
    document.addEventListener('click', e=>{
      if(welcomeModal.classList.contains('show') && !welcomeModal.querySelector('.modal-content').contains(e.target)){
        closeModal(welcomeModal);
      }
    });
    if(!localStorage.getItem('welcomeSeen')) openWelcome();
  }

  document.querySelectorAll('.modal').forEach(modal=>{
    const content = modal.querySelector('.modal-content');
    const header = modal.querySelector('.modal-header');
    if(!content || !header) return;
    let dragging = false;
    let offsetX = 0, offsetY = 0;
      header.addEventListener('mousedown', e=>{
        dragging = true;
        const rect = content.getBoundingClientRect();
        offsetX = e.clientX - rect.left;
        offsetY = e.clientY - rect.top;
        content.style.left = `${rect.left}px`;
        content.style.top = `${rect.top}px`;
        content.style.transform = 'none';
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
        e.preventDefault();
      });
      function onMouseMove(e){
        if(!dragging) return;
        let newLeft = e.clientX - offsetX;
        let newTop = e.clientY - offsetY;
        const rect = content.getBoundingClientRect();
        const maxLeft = window.innerWidth - rect.width;
        const maxTop = window.innerHeight - header.offsetHeight;
        newLeft = Math.min(Math.max(newLeft, 0), Math.max(maxLeft, 0));
        newTop = Math.min(Math.max(newTop, 0), Math.max(maxTop, 0));
        content.style.left = `${newLeft}px`;
        content.style.top = `${newTop}px`;
      }
      function onMouseUp(){
        dragging = false;
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        saveModalState(modal);
      }

    const handles = ['n','e','s','w','ne','nw','se','sw'];
    handles.forEach(dir=>{
      const h = document.createElement('div');
      h.className = 'resizer ' + dir;
      content.appendChild(h);
      h.addEventListener('mousedown', e=> initResize(e, dir));
    });
    let startX, startY, startW, startH, startL, startT, resizeDir;
    function initResize(e, dir){
      e.preventDefault();
      e.stopPropagation();
      resizeDir = dir;
      const rect = content.getBoundingClientRect();
      startX = e.clientX;
      startY = e.clientY;
      startW = rect.width;
      startH = rect.height;
      startL = rect.left;
      startT = rect.top;
      content.style.left = `${startL}px`;
      content.style.top = `${startT}px`;
      content.style.transform = 'none';
      document.addEventListener('mousemove', onResize);
      document.addEventListener('mouseup', stopResize);
    }
    const minW = 200, minH = 150;
    function onResize(e){
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      if(resizeDir.includes('e')){
        content.style.width = `${Math.max(minW, startW + dx)}px`;
      }
      if(resizeDir.includes('s')){
        content.style.height = `${Math.max(minH, startH + dy)}px`;
      }
      if(resizeDir.includes('w')){
        const newW = Math.max(minW, startW - dx);
        content.style.width = `${newW}px`;
        content.style.left = `${startL + dx}px`;
      }
      if(resizeDir.includes('n')){
        const newH = Math.max(minH, startH - dy);
        content.style.height = `${newH}px`;
        content.style.top = `${startT + dy}px`;
      }
    }
    function stopResize(){
      document.removeEventListener('mousemove', onResize);
      document.removeEventListener('mouseup', stopResize);
      saveModalState(modal);
    }
  });

  const adminTabs = document.querySelectorAll('#adminModal .tab-bar button');
  const adminPanels = document.querySelectorAll('#adminModal .tab-panel');
  adminTabs.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      adminTabs.forEach(b=>b.setAttribute('aria-selected','false'));
      adminPanels.forEach(p=>p.classList.remove('active'));
      btn.setAttribute('aria-selected','true');
      const panel = document.getElementById(`tab-${btn.dataset.tab}`);
      panel && panel.classList.add('active');
      localStorage.setItem('adminLastTab', btn.dataset.tab);
    });
  });
  const initialTab = localStorage.getItem('adminLastTab');
  const initBtn = initialTab ? document.querySelector(`#adminModal .tab-bar button[data-tab="${initialTab}"]`) : adminTabs[0];
  initBtn && initBtn.click();

  const colorAreas = [
    {key:'header', label:'Header', selectors:{bg:['.header'], text:['.header'], btn:['.header button','.header .gear','.header a'], btnText:['.header button','.header .gear','.header a']}},
    {key:'subheader', label:'Subheader', selectors:{bg:['.subheader'], text:['.subheader'], btn:['.subheader button'], btnText:['.subheader button'], optionsMenu:['.options-menu'], mapCtrl:['.mapboxgl-ctrl-geocoder','.mapboxgl-ctrl-geolocate','.mapboxgl-ctrl-compass']}},
    {key:'body', label:'Body', selectors:{bg:['body'], border:[], hoverBorder:[], activeBorder:[]}},
    {key:'list', label:'Results List', selectors:{bg:['.res-list'], text:['.res-list'], title:['.res-list .card .t','.res-list .card .title'], btn:['.res-list button','.res-list .sq','.res-list .tiny','.res-list .btn'], btnText:['.res-list button','.res-list .sq','.res-list .tiny','.res-list .btn'], card:['.res-list .card']}},
    {key:'closed-posts', label:'Closed Posts', selectors:{bg:['.closed-posts'], text:['.closed-posts','.closed-posts .res-list'], title:['.closed-posts .card .t','.closed-posts .card .title','.closed-posts .open-posts .t','.closed-posts .open-posts .title'], btn:['.closed-posts button'], btnText:['.closed-posts button'], card:['.closed-posts .card','.closed-posts .open-posts']}},
    {key:'open-posts', label:'Open Posts', selectors:{text:['.open-posts'], title:['.open-posts .t','.open-posts .title'], btn:['.open-posts button'], btnText:['.open-posts button'], card:['.open-posts'], header:['.open-posts .detail-header'], image:['.open-posts .img-box'], menu:['.open-posts .venue-menu button','.open-posts .session-menu button']}},
    {key:'footer', label:'Footer', selectors:{bg:['footer'], text:['footer'], card:['footer .foot-row .foot-item']}},
    {key:'map', label:'Map', selectors:{bg:['.map-area'], card:['.mapboxgl-popup .mapboxgl-popup-content','.mapboxgl-popup .hover-card','.mapboxgl-popup .chip','.mapboxgl-popup .chip-small','.mapboxgl-popup .multi-item'], text:['.mapboxgl-popup .hover-card','.mapboxgl-popup .chip','.mapboxgl-popup .chip-small','.mapboxgl-popup .multi-item'], title:['.mapboxgl-popup .hover-card .t','.mapboxgl-popup .hover-card .title','.mapboxgl-popup .chip .t','.mapboxgl-popup .chip .title','.mapboxgl-popup .chip-small .t','.mapboxgl-popup .chip-small .title','.mapboxgl-popup .multi-item .t','.mapboxgl-popup .multi-item .title']}},
    {key:'filter', label:'Filter Modal', selectors:{bg:['#filterModal .modal-content'], text:['#filterModal .modal-content'], title:['#filterModal .modal-content .t','#filterModal .modal-content .title'], btn:['#filterModal button','#filterModal .sq','#filterModal .tiny','#filterModal .btn'], btnText:['#filterModal button','#filterModal .sq','#filterModal .tiny','#filterModal .btn']}},
    {key:'adminModal', label:'Admin Modal', selectors:{bg:['#adminModal .modal-content'], text:['#adminModal .modal-content'], title:['#adminModal .modal-content .t','#adminModal .modal-content .title'], btn:['#adminModal button','#adminModal #spinType span'], btnText:['#adminModal button','#adminModal #spinType span']}},
    {key:'welcomeModal', label:'Welcome Modal', selectors:{bg:['#welcomeModal .modal-content'], text:['#welcomeModal .modal-content'], title:['#welcomeModal .modal-content .t','#welcomeModal .modal-content .title'], btn:['#welcomeModal button'], btnText:['#welcomeModal button']}},
    {key:'memberModal', label:'Member Modal', selectors:{bg:['#memberModal .modal-content'], text:['#memberModal .modal-content'], title:['#memberModal .modal-content .t','#memberModal .modal-content .title'], btn:['#memberModal button'], btnText:['#memberModal button']}}
  ];

  function storeTitleDefaults(){
    colorAreas.forEach(area=>{
      (area.selectors.title||[]).forEach(sel=>{
        document.querySelectorAll(sel).forEach(el=>{
          const cs = getComputedStyle(el);
          el.dataset.titleDefaultColor = cs.color;
          el.dataset.titleDefaultFont = cs.fontFamily;
          el.dataset.titleDefaultSize = cs.fontSize;
          el.dataset.titleDefaultWeight = cs.fontWeight;
          el.dataset.titleDefaultShadow = cs.textShadow;
        });
      });
    });
    const varMap = {primary:'--primary',secondary:'--secondary',accent:'--accent',buttonHoverText:'--button-hover-text'};
    Object.entries(varMap).forEach(([id,varName])=>{
      const el = document.getElementById(id);
      if(el){
        const val = getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
        if(val) el.value = val;
      }
    });
  }

  function restoreTitleDefaults(area){
    (area.selectors.title||[]).forEach(sel=>{
      document.querySelectorAll(sel).forEach(el=>{
        if(el.dataset.titleDefaultColor) el.style.color = el.dataset.titleDefaultColor;
        if(el.dataset.titleDefaultFont) el.style.fontFamily = el.dataset.titleDefaultFont;
        if(el.dataset.titleDefaultSize) el.style.fontSize = el.dataset.titleDefaultSize;
        if(el.dataset.titleDefaultWeight) el.style.fontWeight = el.dataset.titleDefaultWeight;
        if(el.dataset.titleDefaultShadow) el.style.textShadow = el.dataset.titleDefaultShadow;
      });
    });
  }

  storeTitleDefaults();

  let lastFieldsetKey = null;
  let undoStack = [];
  let redoStack = [];
  let currentState = {};
  let undoBtn, redoBtn;

  const COLOR_PICKER_MODE = 'hex';
  const FONT_OPTIONS = ['Verdana','Inter','Roboto','Montserrat','Arial','Helvetica','Georgia','Times New Roman','Courier New','Trebuchet MS','Tahoma','Comic Sans MS'];
  const FONT_SIZE_OPTIONS = ['10','12','14','16','18','20','24','32'];
  const TEXT_BG_MAP = {text:'bg', title:'card', btnText:'btn'};

  function updateTextPicker(areaKey, type){
    const picker = document.getElementById(`${areaKey}-${type}-picker`);
    if(!picker) return;
    const preview = picker.querySelector('.text-preview');
    const color = document.getElementById(`${areaKey}-${type}-c`).value;
    const font = document.getElementById(`${areaKey}-${type}-font`).value;
    const size = document.getElementById(`${areaKey}-${type}-size`).value;
    const weight = document.getElementById(`${areaKey}-${type}-weight`).value;
    const sc = document.getElementById(`${areaKey}-${type}-shadow-color`).value;
    const sx = document.getElementById(`${areaKey}-${type}-shadow-x`).value;
    const sy = document.getElementById(`${areaKey}-${type}-shadow-y`).value;
    const sb = document.getElementById(`${areaKey}-${type}-shadow-blur`).value;
    const bgInput = document.getElementById(picker.dataset.bgSource);
    preview.style.backgroundColor = bgInput ? bgInput.value : '#ffffff';
    preview.style.color = color;
    preview.style.fontFamily = font;
    preview.style.fontSize = size + 'px';
    preview.style.fontWeight = weight;
    preview.style.textShadow = `${sx}px ${sy}px ${sb}px ${sc}`;
  }

  function createTextPickerRow(id,label,bgSource){
    const row = document.createElement('div');
    row.className = 'control-row';
    const labelEl = document.createElement('label');
    labelEl.textContent = label;
    row.appendChild(labelEl);
    const picker = document.createElement('div');
    picker.className = 'textpicker';
    picker.id = `${id}-picker`;
    picker.dataset.bgSource = bgSource;
    const preview = document.createElement('div');
    preview.className = 'text-preview';
    preview.textContent = 'Text';
    picker.appendChild(preview);
    const popup = document.createElement('div');
    popup.className = 'text-popup';
    const colorInput = document.createElement('input');
    colorInput.type = 'color';
    colorInput.id = `${id}-c`;
    colorInput.setAttribute('data-mode', COLOR_PICKER_MODE);
    const fontSelect = document.createElement('select');
    fontSelect.id = `${id}-font`;
    FONT_OPTIONS.forEach(f=>{ const opt=document.createElement('option'); opt.value=f; opt.textContent=f; fontSelect.appendChild(opt); });
    const sizeSelect = document.createElement('select');
    sizeSelect.id = `${id}-size`;
    FONT_SIZE_OPTIONS.forEach(sz=>{ const opt=document.createElement('option'); opt.value=sz; opt.textContent=`${sz}px`; sizeSelect.appendChild(opt); });
    const weightSelect = document.createElement('select');
    weightSelect.id = `${id}-weight`;
    ['normal','bold'].forEach(w=>{ const opt=document.createElement('option'); opt.value=w; opt.textContent=w.charAt(0).toUpperCase()+w.slice(1); weightSelect.appendChild(opt); });
    const shadowGroup = document.createElement('div');
    shadowGroup.className = 'shadow-group';
    const sc = document.createElement('input'); sc.type='color'; sc.id = `${id}-shadow-color`; sc.setAttribute('data-mode', COLOR_PICKER_MODE);
    const sx = document.createElement('input'); sx.type='number'; sx.id = `${id}-shadow-x`; sx.value='0'; sx.step='1';
    const sy = document.createElement('input'); sy.type='number'; sy.id = `${id}-shadow-y`; sy.value='0'; sy.step='1';
    const sb = document.createElement('input'); sb.type='number'; sb.id = `${id}-shadow-blur`; sb.value='0'; sb.step='1';
    shadowGroup.append(sc, sx, sy, sb);
    popup.append(colorInput, fontSelect, sizeSelect, weightSelect, shadowGroup);
    picker.appendChild(popup);
    row.appendChild(picker);
    const update = ()=>{
      const bg = document.getElementById(picker.dataset.bgSource);
      preview.style.backgroundColor = bg ? bg.value : '#ffffff';
      preview.style.color = colorInput.value;
      preview.style.fontFamily = fontSelect.value;
      preview.style.fontSize = sizeSelect.value + 'px';
      preview.style.fontWeight = weightSelect.value;
      preview.style.textShadow = `${sx.value}px ${sy.value}px ${sb.value}px ${sc.value}`;
    };
    [colorInput,fontSelect,sizeSelect,weightSelect,sc,sx,sy,sb].forEach(el=> el.addEventListener('input', update));
    const bgInput = document.getElementById(picker.dataset.bgSource);
    bgInput && bgInput.addEventListener('input', update);
    preview.addEventListener('click', e=>{ e.stopPropagation(); picker.classList.toggle('open'); });
    popup.addEventListener('click', e=> e.stopPropagation());
    document.addEventListener('click', e=>{
      const active = document.activeElement;
      if(!picker.contains(e.target) && (!active || !picker.contains(active))){
        picker.classList.remove('open');
      }
    });
    update();
    return row;
  }

  function rgbToHex(r,g,b){
    return '#' + [r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('');
  }

  function hexToRgba(hex, alpha){
    const r = parseInt(hex.slice(1,3),16);
    const g = parseInt(hex.slice(3,5),16);
    const b = parseInt(hex.slice(5,7),16);
    return `rgba(${r},${g},${b},${alpha})`;
  }

  function hexToRgb(hex){
    const m = /^#?([\da-f]{2})([\da-f]{2})([\da-f]{2})$/i.exec(hex);
    return m ? { r: parseInt(m[1], 16), g: parseInt(m[2], 16), b: parseInt(m[3], 16) } : null;
  }

  function clamp(v){
    return Math.max(0, Math.min(255, v));
  }

  function adjust(hex, amt){
    const rgb = hexToRgb(hex);
    if(!rgb) return hex;
    return rgbToHex(clamp(rgb.r + amt), clamp(rgb.g + amt), clamp(rgb.b + amt));
  }

  function luminance(hex){
    const rgb = hexToRgb(hex);
    if(!rgb) return 0;
    const { r, g, b } = rgb;
    const a = [r, g, b].map(v => {
      v /= 255;
      return v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4);
    });
    return 0.2126 * a[0] + 0.7152 * a[1] + 0.0722 * a[2];
  }

  function generateTheme(baseColor){
    const primary = baseColor;
    const secondary = adjust(baseColor, 30);
    const accent = adjust(baseColor, -30);
    const background = adjust(baseColor, 60);
    const text = luminance(background) > 0.5 ? '#000000' : '#ffffff';
    const buttonText = luminance(secondary) > 0.5 ? '#000000' : '#ffffff';
    const buttonHoverText = luminance(accent) > 0.5 ? '#000000' : '#ffffff';
    return { primary, secondary, accent, background, text, buttonText, buttonHoverText };
  }

  function updateFields(theme){
    Object.entries(theme).forEach(([key,val])=>{
      const input = document.getElementById(key);
      if(input) input.value = val;
    });
  }

  function spreadTheme(theme){
    colorAreas.forEach(area=>{
      const set = (type,val)=>{
        const el = document.getElementById(`${area.key}-${type}-c`);
        if(el && val) el.value = val;
      };
      set('bg', theme.background);
      set('text', theme.text);
      set('card', theme.secondary);
      set('btn', theme.primary);
      set('btnText', theme.buttonText);
    });
    const b = document.getElementById('body-border-c');
    if(b) b.value = theme.primary;
    const hb = document.getElementById('body-hoverBorder-c');
    if(hb) hb.value = theme.accent;
    const ab = document.getElementById('body-activeBorder-c');
    if(ab) ab.value = theme.accent;
    ['primary','secondary','accent','buttonHoverText'].forEach(id=>{
      const inp = document.getElementById(id);
      if(inp && theme[id]) inp.value = theme[id];
    });
    applyAdmin();
  }


  function syncAdminControls(){
      const themeSelect = document.getElementById('mapTheme');
      if(themeSelect) themeSelect.value = mapStyle;
      const skySelect = document.getElementById('skyTheme');
      if(skySelect) skySelect.value = skyStyle;
      const pitchInput = document.getElementById('mapPitch');
      const pitchVal = document.getElementById('pitchVal');
        if(pitchInput){
          const p = (map && typeof map.getPitch === 'function')
            ? map.getPitch()
            : startPitch;
        pitchInput.value = p;
        if(pitchVal) pitchVal.textContent = p.toFixed(0);
      }
      const bearingInput = document.getElementById('mapBearing');
      const bearingVal = document.getElementById('bearingVal');
        if(bearingInput){
          const b = (map && typeof map.getBearing === 'function')
            ? map.getBearing()
            : startBearing;
        bearingInput.value = b;
        if(bearingVal) bearingVal.textContent = b.toFixed(0);
      }
    colorAreas.forEach(area=>{
      ['bg','card','text','title','btn','btnText','border','hoverBorder','activeBorder','header','image','optionsMenu','mapCtrl','menu'].forEach(type=>{
        const cInput = document.getElementById(`${area.key}-${type}-c`);
        const oInput = document.getElementById(`${area.key}-${type}-o`);
        const fontSel = document.getElementById(`${area.key}-${type}-font`);
        const sizeSel = document.getElementById(`${area.key}-${type}-size`);
        const weightSel = document.getElementById(`${area.key}-${type}-weight`);
        const shColor = document.getElementById(`${area.key}-${type}-shadow-color`);
        const shX = document.getElementById(`${area.key}-${type}-shadow-x`);
        const shY = document.getElementById(`${area.key}-${type}-shadow-y`);
        const shB = document.getElementById(`${area.key}-${type}-shadow-blur`);
        if(!cInput && !fontSel && !sizeSel && !weightSel && !shColor) return;
        let selectors = area.selectors[type] || [];
        if(area.key==='body' && ['border','hoverBorder','activeBorder'].includes(type)){
          const varMap = {border:'--border', hoverBorder:'--border-hover', activeBorder:'--border-active'};
          const val = getComputedStyle(document.documentElement).getPropertyValue(varMap[type]).trim();
          if(cInput && val){
            const match = val.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d*\.?\d+))?\)/);
            if(match){
              const r = parseInt(match[1],10);
              const g = parseInt(match[2],10);
              const bVal = parseInt(match[3],10);
              const alpha = match[4] !== undefined ? parseFloat(match[4]) : 1;
              cInput.value = rgbToHex(r,g,bVal);
              if(oInput) oInput.value = alpha;
            }
          }
          return;
        }
        if((type==='hoverBorder' || type==='activeBorder') && selectors.length===0){
          selectors = area.selectors.border || [];
        }
        let col = null, font = null, size = null, weight = null, shadow = null;
        selectors.some(sel=>{
          const cleanSel = sel.replace(/:hover|:active|\[.*?\]/g,'');
          const el = document.querySelector(cleanSel);
          if(!el) return false;
          const cs = getComputedStyle(el);
          if(cInput){
            if(type === 'bg' || type === 'btn' || type === 'card' || type === 'header' || type === 'image' || type === 'optionsMenu') col = cs.backgroundColor;
            else if(type === 'text' || type === 'btnText' || type === 'title') col = cs.color;
            else if(type === 'border' || type === 'hoverBorder' || type === 'activeBorder') col = cs.borderColor;
          }
          if(fontSel) font = cs.fontFamily.split(',')[0].replace(/"/g,'').trim();
          if(sizeSel) size = parseInt(cs.fontSize,10);
          if(weightSel) weight = cs.fontWeight;
          if(shColor){
            if(type==='text' || type==='title' || type==='btnText') shadow = cs.textShadow;
            else if(type==='card' || type==='btn') shadow = cs.boxShadow;
          }
          return true;
        });
        if(cInput && col){
          const match = col.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d*\.?\d+))?\)/);
          if(match){
            const r = parseInt(match[1],10);
            const g = parseInt(match[2],10);
            const bVal = parseInt(match[3],10);
            const alpha = match[4] !== undefined ? parseFloat(match[4]) : 1;
            cInput.value = rgbToHex(r,g,bVal);
            if((type==='bg' || type==='card' || type==='header' || type==='image' || type==='border' || type==='hoverBorder' || type==='activeBorder' || type==='optionsMenu') && oInput) oInput.value = alpha;
          }
        }
        if(fontSel && font){
          fontSel.value = FONT_OPTIONS.includes(font) ? font : FONT_OPTIONS[0];
        }
        if(sizeSel && size){
          sizeSel.value = String(size);
        }
        if(weightSel && weight){
          weightSel.value = parseInt(weight,10) >= 600 ? 'bold' : 'normal';
        }
        if(shColor && shadow && shadow !== 'none'){
          if(type==='text' || type==='title' || type==='btnText'){
            const m = shadow.match(/(-?\d+)px\s+(-?\d+)px\s+(-?\d+)px\s+rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d*\.?\d+))?\)/);
            if(m){
              shX.value = m[1];
              shY.value = m[2];
              shB.value = m[3];
              shColor.value = rgbToHex(parseInt(m[4],10),parseInt(m[5],10),parseInt(m[6],10));
            }
          } else {
            const m = shadow.match(/0px\s+0px\s+(\d+)px\s+rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d*\.?\d+))?\)/);
            if(m){
              shB.value = m[1];
              shColor.value = rgbToHex(parseInt(m[2],10),parseInt(m[3],10),parseInt(m[4],10));
            }
          }
        }
      });
      ['hoverAdjust','activeAdjust'].forEach(type=>{
        const v = document.getElementById(`${area.key}-${type}`);
        if(v && currentState[`${area.key}-${type}`]){
          v.value = currentState[`${area.key}-${type}`].value;
        }
      });
      ['text','title','btnText'].forEach(t=> updateTextPicker(area.key, t));
    });
    ['modalText','placeholder','filterPlaceholder','dateRangeText','dropdownSelectedText','dropdownText','dropdownHoverText','dropdownVenueText'].forEach(id=> updateTextPicker(id,'text'));
    ['list','closed-posts'].forEach(areaKey=>{
      const twInput = document.getElementById(`${areaKey}-thumbWidth`);
      const thInput = document.getElementById(`${areaKey}-thumbHeight`);
      if(twInput || thInput){
        const thumbSel = areaKey === 'list' ? '.res-list .thumb' : '.closed-posts .thumb';
        const elT = document.querySelector(thumbSel);
        if(elT){
          const cs = getComputedStyle(elT);
          if(twInput) twInput.value = parseInt(cs.width,10) || 0;
          if(thInput) thInput.value = parseInt(cs.height,10) || 0;
        }
      }
    });
    const varMap = {primary:'--primary',secondary:'--secondary',accent:'--accent',buttonHoverText:'--button-hover-text',btn:'--btn',btnHover:'--btn-hover',btnActive:'--btn-active',modalBg:'--modal-bg',modalText:'--modal-text',scrollbarTrack:'--scrollbar-track',scrollbarThumb:'--scrollbar-thumb',scrollbarThumbHover:'--scrollbar-thumb-hover',listBackground:'--list-background',placeholder:'--placeholder-text',filterPlaceholder:'--filter-placeholder-text',dateRangeText:'--filter-date-text',dropdownTitle:'--dropdown-title',dropdownSelectedBg:'--dropdown-selected-bg',dropdownSelectedText:'--dropdown-selected-text',dropdownText:'--dropdown-text',dropdownBg:'--dropdown-bg',dropdownHoverBg:'--dropdown-hover-bg',dropdownHoverText:'--dropdown-hover-text',dropdownVenueText:'--dropdown-venue-text',filterBtnActive:'--filter-btn-active'};
    Object.entries(varMap).forEach(([id,varName])=>{
      const cInput = document.getElementById(`${id}-c`) || document.getElementById(id);
      const oInput = document.getElementById(`${id}-o`);
      if(cInput){
        const val = getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
        if(val){
          const match = val.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d*\.?\d+))?\)/);
          if(match){
            cInput.value = rgbToHex(parseInt(match[1],10),parseInt(match[2],10),parseInt(match[3],10));
            if(oInput) oInput.value = match[4] !== undefined ? parseFloat(match[4]) : 1;
          }
        }
      }
    });
    const stickyHeaderInput = document.getElementById('open-posts-sticky-header');
    if(stickyHeaderInput){
      const state = currentState['open-posts-sticky-header'];
      stickyHeaderInput.checked = state ? state.value === '1' : true;
      document.documentElement.classList.toggle('open-posts-sticky-header', stickyHeaderInput.checked);
      stickyHeaderInput.addEventListener('change', () => {
        document.documentElement.classList.toggle('open-posts-sticky-header', stickyHeaderInput.checked);
        const data = collectThemeValues();
        currentState = JSON.parse(JSON.stringify(data));
        localStorage.setItem('currentTheme', JSON.stringify(data));
        updateHistoryButtons();
      });
    }
    const stickyImageInput = document.getElementById('open-posts-sticky-images');
    if(stickyImageInput){
      const state = currentState['open-posts-sticky-images'];
      stickyImageInput.checked = state ? state.value === '1' : true;
      if (typeof updateStickyImages === 'function') {
        updateStickyImages();
      }
      stickyImageInput.addEventListener('change', () => {
        if (typeof updateStickyImages === 'function') {
          updateStickyImages();
        }
        const data = collectThemeValues();
        currentState = JSON.parse(JSON.stringify(data));
        localStorage.setItem('currentTheme', JSON.stringify(data));
        updateHistoryButtons();
      });
    }
  }

  function buildStyleControls(){
    const wrap = document.getElementById('styleControls');
    if(!wrap) return;
    colorAreas.forEach(area=>{
      const fs = document.createElement('fieldset');
      fs.className = 'admin-fieldset collapsed';
      fs.dataset.key = area.key;
      fs.addEventListener('click',()=>{ lastFieldsetKey = area.key; });
      fs.addEventListener('input',()=>{ lastFieldsetKey = area.key; });
      const lg = document.createElement('legend');
      lg.textContent = area.label;
      lg.addEventListener('click',()=>{ lastFieldsetKey = area.key; });
      const toggleBtn = document.createElement('button');
      toggleBtn.type = 'button';
      toggleBtn.className = 'fs-toggle';
      toggleBtn.textContent = '+';
      toggleBtn.addEventListener('click', e=>{
        e.stopPropagation();
        fs.classList.toggle('collapsed');
        lastFieldsetKey = area.key;
        toggleBtn.textContent = fs.classList.contains('collapsed') ? '+' : '−';
      });
      lg.appendChild(toggleBtn);
      fs.appendChild(lg);
      const btnRow = document.createElement('div');
      btnRow.className = 'fieldset-actions';
      const colBtn = document.createElement('button');
      colBtn.type = 'button';
      colBtn.textContent = '=Col';
      colBtn.className = 'same-btn';
      colBtn.addEventListener('click', (e)=>{
        e.stopPropagation();
        if(!lastFieldsetKey || lastFieldsetKey === area.key) return;
        ['bg','card','btn','border','hoverBorder','activeBorder','header','image','optionsMenu'].forEach(type=>{
          const fromC = document.getElementById(`${lastFieldsetKey}-${type}-c`);
          const fromO = document.getElementById(`${lastFieldsetKey}-${type}-o`);
          const toC = document.getElementById(`${area.key}-${type}-c`);
          const toO = document.getElementById(`${area.key}-${type}-o`);
          if(fromC && toC){ toC.value = fromC.value; }
          if(fromO && toO){ toO.value = fromO.value; }
        });
        ['hoverAdjust','activeAdjust'].forEach(type=>{
          const fromV = document.getElementById(`${lastFieldsetKey}-${type}`);
          const toV = document.getElementById(`${area.key}-${type}`);
          if(fromV && toV){ toV.value = fromV.value; }
        });
        ['text','title','btnText'].forEach(t=> updateTextPicker(area.key, t));
        applyAdmin();
      });
      const txtBtn = document.createElement('button');
      txtBtn.type = 'button';
      txtBtn.textContent = '=Txt';
      txtBtn.className = 'same-btn';
      txtBtn.addEventListener('click', (e)=>{
        e.stopPropagation();
        if(!lastFieldsetKey || lastFieldsetKey === area.key) return;
        ['text','title','btnText'].forEach(type=>{
          const fields = ['c','font','size','weight','shadow-color','shadow-x','shadow-y','shadow-blur'];
          fields.forEach(suf=>{
            const from = document.getElementById(`${lastFieldsetKey}-${type}-${suf}`);
            const to = document.getElementById(`${area.key}-${type}-${suf}`);
            if(from && to){ to.value = from.value; }
          });
          updateTextPicker(area.key, type);
        });
        applyAdmin();
      });
      btnRow.appendChild(colBtn);
      btnRow.appendChild(txtBtn);
      fs.appendChild(btnRow);
      if(area.key === 'body'){
        const palette = [
          {id:'primary', label:'Primary'},
          {id:'secondary', label:'Secondary'},
          {id:'accent', label:'Accent'},
          {id:'buttonHoverText', label:'Button Hover Text'}
        ];
        palette.forEach(p=>{
          const row = document.createElement('div');
          row.className = 'control-row';
          row.innerHTML = `
              <label>${p.label}</label>
              <div class="color-group">
                <input id="${p.id}" type="color" data-mode="${COLOR_PICKER_MODE}" />
              </div>
            `;
          fs.appendChild(row);
        });
      }
      const types = [];
      if(area.selectors.bg) types.push('bg');
      if(area.selectors.card) types.push('card');
      if(area.selectors.text) types.push('text');
      if(area.selectors.title) types.push('title');
      if(area.selectors.btn) types.push('btn','btnText');
      if(area.selectors.border) types.push('border');
      if(area.selectors.hoverBorder) types.push('hoverAdjust','hoverBorder');
      if(area.selectors.activeBorder) types.push('activeAdjust','activeBorder');
      if(area.selectors.header) types.push('header');
      if(area.selectors.image) types.push('image');
      if(area.selectors.optionsMenu) types.push('optionsMenu');
      if(area.selectors.mapCtrl) types.push('mapCtrl');
      if(area.selectors.menu) types.push('menu');
        types.forEach(type=>{
          const labelMap = {
            bg: 'Background',
            card: 'Card',
            text: 'Text',
            title: 'Title',
            btn: 'Button',
            btnText: 'Button Text',
            border: 'Border',
            hoverBorder: 'Hover Border',
            activeBorder: 'Active Border',
            hoverAdjust: 'Hover Brightness',
            activeAdjust: 'Active Brightness',
            header: 'Header',
            image: 'Image Box',
            optionsMenu: 'Options Menu',
            mapCtrl: 'Map Controls',
            menu: 'Menu Background'
          };
          const label = labelMap[type] || type;
        if(type === 'text' || type === 'title' || type === 'btnText'){
          const row = document.createElement('div');
          row.className = 'control-row';
          const labelEl = document.createElement('label');
          labelEl.textContent = label;
          row.appendChild(labelEl);
          const picker = document.createElement('div');
          picker.className = 'textpicker';
          picker.id = `${area.key}-${type}-picker`;
          let bgKey = TEXT_BG_MAP[type];
          if(type === 'text' && ['list','closed-posts','open-posts','footer','map'].includes(area.key)){
            bgKey = 'card';
          }
          picker.dataset.bgSource = `${area.key}-${bgKey}-c`;
          const preview = document.createElement('div');
          preview.className = 'text-preview';
          preview.textContent = 'Text';
          picker.appendChild(preview);
          const popup = document.createElement('div');
          popup.className = 'text-popup';
          const colorInput = document.createElement('input');
          colorInput.type = 'color';
          colorInput.id = `${area.key}-${type}-c`;
          colorInput.setAttribute('data-mode', COLOR_PICKER_MODE);
          const fontSelect = document.createElement('select');
          fontSelect.className = 'font-select';
          fontSelect.id = `${area.key}-${type}-font`;
          FONT_OPTIONS.forEach(f=>{ const opt = document.createElement('option'); opt.value = f; opt.textContent = f; fontSelect.appendChild(opt); });
          const sizeSelect = document.createElement('select');
          sizeSelect.className = 'font-size-select';
          sizeSelect.id = `${area.key}-${type}-size`;
          FONT_SIZE_OPTIONS.forEach(sz=>{ const opt = document.createElement('option'); opt.value = sz; opt.textContent = `${sz}px`; sizeSelect.appendChild(opt); });
          const weightSelect = document.createElement('select');
          weightSelect.className = 'font-weight-select';
          weightSelect.id = `${area.key}-${type}-weight`;
          ['normal','bold'].forEach(w=>{ const opt = document.createElement('option'); opt.value = w; opt.textContent = w.charAt(0).toUpperCase()+w.slice(1); weightSelect.appendChild(opt); });
          const shadowGroup = document.createElement('div');
          shadowGroup.className = 'shadow-group';
          const sc = document.createElement('input'); sc.type='color'; sc.id = `${area.key}-${type}-shadow-color`; sc.setAttribute('data-mode', COLOR_PICKER_MODE);
          const sx = document.createElement('input'); sx.type='number'; sx.id = `${area.key}-${type}-shadow-x`; sx.value='0'; sx.step='1';
          const sy = document.createElement('input'); sy.type='number'; sy.id = `${area.key}-${type}-shadow-y`; sy.value='0'; sy.step='1';
          const sb = document.createElement('input'); sb.type='number'; sb.id = `${area.key}-${type}-shadow-blur`; sb.value='0'; sb.step='1';
          shadowGroup.append(sc, sx, sy, sb);
          popup.append(colorInput, fontSelect, sizeSelect, weightSelect, shadowGroup);
          picker.appendChild(popup);
          row.appendChild(picker);
          fs.appendChild(row);
          const update = ()=>updateTextPicker(area.key, type);
          [colorInput,fontSelect,sizeSelect,weightSelect,sc,sx,sy,sb].forEach(el=> el.addEventListener('input', update));
          const bgInput = document.getElementById(picker.dataset.bgSource);
          bgInput && bgInput.addEventListener('input', update);
          preview.addEventListener('click', e=>{ e.stopPropagation(); picker.classList.toggle('open'); });
          popup.addEventListener('click', e=> e.stopPropagation());
          document.addEventListener('click', e=>{
            const active = document.activeElement;
            if(!picker.contains(e.target) && (!active || !picker.contains(active))){
              picker.classList.remove('open');
            }
          });
          update();
          return;
        }
        const row = document.createElement('div');
        row.className = 'control-row';
        if(type === 'bg' || type === 'card' || type === 'border' || type === 'hoverBorder' || type === 'activeBorder' || type === 'header' || type === 'image' || type === 'optionsMenu' || type === 'menu'){
          row.innerHTML = `
              <label>${label}</label>
              <div class="color-group">
                <input id="${area.key}-${type}-c" type="color" data-mode="${COLOR_PICKER_MODE}" />
                <input id="${area.key}-${type}-o" type="range" min="0" max="1" step="0.01" value="1" />
              </div>
            `;
        } else if(type === 'hoverAdjust' || type === 'activeAdjust'){
          row.innerHTML = `
              <label>${label}</label>
              <div class="color-group">
                <input id="${area.key}-${type}" type="range" min="-50" max="50" step="1" value="0" />
              </div>
            `;
        } else {
          row.innerHTML = `
              <label>${label}</label>
              <div class="color-group">
                <input id="${area.key}-${type}-c" type="color" data-mode="${COLOR_PICKER_MODE}" />
              </div>
            `;
        }
        fs.appendChild(row);
        if(type === 'card' || type === 'btn'){
          const shadowRow = document.createElement('div');
          shadowRow.className = 'control-row';
          shadowRow.innerHTML = `
              <label>Shadow</label>
              <div class="color-group">
                <input id="${area.key}-${type}-shadow-color" type="color" data-mode="${COLOR_PICKER_MODE}" />
                <input id="${area.key}-${type}-shadow-blur" type="range" min="0" max="50" step="1" value="0" />
              </div>
            `;
          fs.appendChild(shadowRow);
        }
      });
      if(area.key === 'list' || area.key === 'closed-posts'){
        const thumbRow = document.createElement('div');
        thumbRow.className = 'control-row';
        thumbRow.innerHTML = `
            <label>Thumbnail</label>
            <div class="shadow-group">
              <input id="${area.key}-thumbWidth" type="number" step="1" placeholder="W" value="80" />
              <input id="${area.key}-thumbHeight" type="number" step="1" placeholder="H" value="80" />
            </div>
        `;
        fs.appendChild(thumbRow);
      }
      if(area.key === 'open-posts'){
        fs.appendChild(createTextPickerRow('dropdownVenueText','Venue Button Text','open-posts-menu-c'));
        const stickyRow = document.createElement('div');
        stickyRow.className = 'control-row';
        stickyRow.innerHTML = `
            <label>Sticky Header</label>
            <input id="open-posts-sticky-header" type="checkbox" checked />
            <label>Sticky Images</label>
            <input id="open-posts-sticky-images" type="checkbox" checked />
        `;
        fs.appendChild(stickyRow);
      }
      if(area.key === 'filter'){
        const bgRow = document.createElement('div');
        bgRow.className = 'control-row';
        bgRow.innerHTML = `
            <label>Input background</label>
            <div class="color-group">
              <input id="modalBg-c" type="color" data-mode="${COLOR_PICKER_MODE}" />
              <input id="modalBg-o" type="range" min="0" max="1" step="0.01" value="1" />
            </div>
        `;
        fs.appendChild(bgRow);
        fs.appendChild(createTextPickerRow('dateRangeText','Date Range Box Text','modalBg-c'));
        fs.appendChild(createTextPickerRow('filterPlaceholder','Keyword Placeholder','modalBg-c'));
      }
      if(area.key === 'subheader'){
        const activeRow = document.createElement('div');
        activeRow.className = 'control-row';
        activeRow.innerHTML = `
            <label>Active Filters Button</label>
            <div class="color-group">
              <input id="filterBtnActive-c" type="color" data-mode="${COLOR_PICKER_MODE}" value="#8b0000" />
            </div>
        `;
        fs.appendChild(activeRow);
      }
      wrap.appendChild(fs);
    });
    const misc = document.createElement('fieldset');
    misc.className = 'admin-fieldset collapsed';
    const miscLg = document.createElement('legend');
    miscLg.textContent = 'Miscellaneous';
    const miscToggle = document.createElement('button');
    miscToggle.type = 'button';
    miscToggle.className = 'fs-toggle';
    miscToggle.textContent = '+';
    miscToggle.addEventListener('click', e=>{
      e.stopPropagation();
      misc.classList.toggle('collapsed');
      miscToggle.textContent = misc.classList.contains('collapsed') ? '+' : '−';
    });
    miscLg.appendChild(miscToggle);
    misc.appendChild(miscLg);
    const miscColors = [
      {id:'btn', label:'Button Base'},
      {id:'btnHover', label:'Button Hover'},
      {id:'btnActive', label:'Button Active'},
      {id:'scrollbarTrack', label:'Scrollbar Track'},
      {id:'scrollbarThumb', label:'Scrollbar Thumb'},
      {id:'scrollbarThumbHover', label:'Scrollbar Thumb Hover'},
      {id:'listBackground', label:'List Background'}
    ];
    miscColors.forEach(p=>{
      const row = document.createElement('div');
      row.className = 'control-row';
      row.innerHTML = `
            <label>${p.label}</label>
            <div class="color-group">
              <input id="${p.id}-c" type="color" data-mode="${COLOR_PICKER_MODE}" />
              <input id="${p.id}-o" type="range" min="0" max="1" step="0.01" value="1" />
            </div>
          `;
      misc.appendChild(row);
    });
    misc.appendChild(createTextPickerRow('modalText','Image Modal Text','modalBg-c'));
    misc.appendChild(createTextPickerRow('placeholder','Placeholder Text','btn-c'));
    wrap.appendChild(misc);
    const dropdown = document.createElement('fieldset');
    dropdown.className = 'admin-fieldset collapsed';
    const ddLg = document.createElement('legend');
    ddLg.textContent = 'Dropdown Boxes';
    const ddToggle = document.createElement('button');
    ddToggle.type = 'button';
    ddToggle.className = 'fs-toggle';
    ddToggle.textContent = '+';
    ddToggle.addEventListener('click', e=>{
      e.stopPropagation();
      dropdown.classList.toggle('collapsed');
      ddToggle.textContent = dropdown.classList.contains('collapsed') ? '+' : '−';
    });
    ddLg.appendChild(ddToggle);
    dropdown.appendChild(ddLg);
    const ddColors = [
      {id:'dropdownTitle', label:'Title'},
      {id:'dropdownSelectedBg', label:'Selected Background', opacity:true},
      {id:'dropdownBg', label:'Background', opacity:true},
      {id:'dropdownHoverBg', label:'Hover Background', opacity:true}
    ];
    ddColors.forEach(f=>{
      const row = document.createElement('div');
      row.className = 'control-row';
      row.innerHTML = `
            <label>${f.label}</label>
            <div class="color-group">
              <input id="${f.id}-c" type="color" data-mode="${COLOR_PICKER_MODE}" />
              ${f.opacity ? `<input id="${f.id}-o" type="range" min="0" max="1" step="0.01" value="1" />` : ''}
            </div>
          `;
      dropdown.appendChild(row);
    });
    dropdown.appendChild(createTextPickerRow('dropdownSelectedText','Selected Text','dropdownSelectedBg-c'));
    dropdown.appendChild(createTextPickerRow('dropdownText','Text','dropdownBg-c'));
    dropdown.appendChild(createTextPickerRow('dropdownHoverText','Hover Text','dropdownHoverBg-c'));
    wrap.appendChild(dropdown);
  }

  function applyAdmin(targetInput){
    if(targetInput){
      undoStack.push(JSON.parse(JSON.stringify(currentState)));
      redoStack.length = 0;
    }
    if(targetInput && targetInput.id){
      const [areaKey, type] = targetInput.id.split('-');
      if(areaKey === 'body' && ['border','hoverBorder','activeBorder'].includes(type)){
        const colorInput = document.getElementById(`${areaKey}-${type}-c`);
        const opacityInput = document.getElementById(`${areaKey}-${type}-o`);
        const color = colorInput ? colorInput.value : '#ffffff';
        const opacity = opacityInput ? opacityInput.value : 1;
        const varMap = {border:'--border', hoverBorder:'--border-hover', activeBorder:'--border-active'};
        document.documentElement.style.setProperty(varMap[type], hexToRgba(color, opacity));
        const data = collectThemeValues();
        currentState = JSON.parse(JSON.stringify(data));
        localStorage.setItem('currentTheme', JSON.stringify(data));
        syncAdminControls();
        updateHistoryButtons();
        return;
      }
    }
    ['border','hoverBorder','activeBorder'].forEach(type=>{
      const c = document.getElementById(`body-${type}-c`);
      const o = document.getElementById(`body-${type}-o`);
      if(c){
        const rgba = hexToRgba(c.value, o ? o.value : 1);
        const varMap = {border:'--border', hoverBorder:'--border-hover', activeBorder:'--border-active'};
        document.documentElement.style.setProperty(varMap[type], rgba);
      }
    });
    const borderC = document.getElementById('body-border-c');
    const borderO = document.getElementById('body-border-o');
    const baseColor = borderC ? borderC.value : '#ffffff';
    const baseOpacity = borderO ? borderO.value : 1;
    const hoverAdj = document.getElementById('body-hoverAdjust');
    if(hoverAdj && (!document.getElementById('body-hoverBorder-c') || !document.getElementById('body-hoverBorder-c').value)){
      const col = adjust(baseColor, parseInt(hoverAdj.value,10)||0);
      document.documentElement.style.setProperty('--border-hover', hexToRgba(col, baseOpacity));
    }
    const activeAdj = document.getElementById('body-activeAdjust');
    if(activeAdj && (!document.getElementById('body-activeBorder-c') || !document.getElementById('body-activeBorder-c').value)){
      const col = adjust(baseColor, parseInt(activeAdj.value,10)||0);
      document.documentElement.style.setProperty('--border-active', hexToRgba(col, baseOpacity));
    }
    const varMap = {primary:'--primary',secondary:'--secondary',accent:'--accent',buttonHoverText:'--button-hover-text',btn:'--btn',btnHover:'--btn-hover',btnActive:'--btn-active',modalBg:'--modal-bg',modalText:'--modal-text',scrollbarTrack:'--scrollbar-track',scrollbarThumb:'--scrollbar-thumb',scrollbarThumbHover:'--scrollbar-thumb-hover',listBackground:'--list-background',placeholder:'--placeholder-text',filterPlaceholder:'--filter-placeholder-text',dateRangeText:'--filter-date-text',dropdownTitle:'--dropdown-title',dropdownSelectedBg:'--dropdown-selected-bg',dropdownSelectedText:'--dropdown-selected-text',dropdownText:'--dropdown-text',dropdownBg:'--dropdown-bg',dropdownHoverBg:'--dropdown-hover-bg',dropdownHoverText:'--dropdown-hover-text',dropdownVenueText:'--dropdown-venue-text',filterBtnActive:'--filter-btn-active'};
    Object.entries(varMap).forEach(([id,varName])=>{
      const c = document.getElementById(`${id}-c`) || document.getElementById(id);
      const o = document.getElementById(`${id}-o`);
      if(c){
        const color = c.value;
        const opacity = o ? o.value : 1;
        document.documentElement.style.setProperty(varName, hexToRgba(color, opacity));
      }
    });
    colorAreas.forEach(area=>{
      ['bg','card','text','title','btn','btnText','header','image','optionsMenu','mapCtrl','menu'].forEach(type=>{
        const c = document.getElementById(`${area.key}-${type}-c`);
        const o = document.getElementById(`${area.key}-${type}-o`);
        const f = document.getElementById(`${area.key}-${type}-font`);
        const s = document.getElementById(`${area.key}-${type}-size`);
        const w = document.getElementById(`${area.key}-${type}-weight`);
        const sc = document.getElementById(`${area.key}-${type}-shadow-color`);
        const sx = document.getElementById(`${area.key}-${type}-shadow-x`);
        const sy = document.getElementById(`${area.key}-${type}-shadow-y`);
        const sb = document.getElementById(`${area.key}-${type}-shadow-blur`);
        if(!c && !f && !s && !w && !sc) return;
        const color = c ? c.value : null;
        const opacity = o ? o.value : 1;
        const font = f ? f.value : null;
        const size = s ? s.value : null;
        const weight = w ? w.value : null;
        const targets = area.selectors[type] || [];
        targets.forEach(sel=>{
          document.querySelectorAll(sel).forEach(el=>{
            if(type==='bg' || type==='card' || type==='header' || type==='image' || type==='optionsMenu'){
              if(color) el.style.backgroundColor = hexToRgba(color, opacity);
              if(type==='card'){
                const shadowColor = sc ? sc.value : null;
                const blur = sb ? sb.value : 0;
                if(shadowColor) el.style.boxShadow = `0 0 ${blur}px ${shadowColor}`;
              }
            } else if(type==='text' || type==='btnText' || type==='title'){
              if(color) el.style.color = color;
              if(font) el.style.fontFamily = font;
              if(size) el.style.fontSize = `${size}px`;
              if(weight) el.style.fontWeight = weight;
              if(sc){
                const x = sx ? sx.value : 0;
                const y = sy ? sy.value : 0;
                const blur = sb ? sb.value : 0;
                el.style.textShadow = `${x}px ${y}px ${blur}px ${sc.value}`;
              }
            } else if(type==='btn' || type==='mapCtrl'){
              if(color){
                el.style.backgroundColor = color;
                el.style.borderColor = color;
              }
              const shadowColor = sc ? sc.value : null;
              const blur = sb ? sb.value : 0;
              if(shadowColor) el.style.boxShadow = `0 0 ${blur}px ${shadowColor}`;
            }
          });
        });
        if(type==='text'){
          restoreTitleDefaults(area);
        }
      });
    });
    ['list','closed-posts'].forEach(areaKey=>{
      const tw = document.getElementById(`${areaKey}-thumbWidth`);
      const th = document.getElementById(`${areaKey}-thumbHeight`);
      const thumbSel = areaKey === 'list' ? '.res-list .thumb' : '.closed-posts .thumb';
      document.querySelectorAll(thumbSel).forEach(el=>{
        if(areaKey === 'list' && el.closest('.closed-posts')) return;
        if(tw && tw.value !== '') el.style.width = `${tw.value}px`;
        if(th && th.value !== '') el.style.height = `${th.value}px`;
      });
    });
    const stickyHeader = document.getElementById('open-posts-sticky-header');
    document.documentElement.classList.toggle('open-posts-sticky-header', stickyHeader && stickyHeader.checked);
    const stickyImages = document.getElementById('open-posts-sticky-images');
    document.documentElement.classList.toggle('open-posts-sticky-images', stickyImages && stickyImages.checked);
    const data = collectThemeValues();
    currentState = JSON.parse(JSON.stringify(data));
    localStorage.setItem('currentTheme', JSON.stringify(data));
    syncAdminControls();
    updateHistoryButtons();
  }

  function collectThemeValues(){
    const data = {};
    colorAreas.forEach(area=>{
      ['bg','card','text','title','btn','btnText','border','hoverBorder','activeBorder','hoverAdjust','activeAdjust','header','image','optionsMenu','mapCtrl','menu'].forEach(type=>{
        const c = document.getElementById(`${area.key}-${type}-c`);
        const o = document.getElementById(`${area.key}-${type}-o`);
        const f = document.getElementById(`${area.key}-${type}-font`);
        const s = document.getElementById(`${area.key}-${type}-size`);
        const w = document.getElementById(`${area.key}-${type}-weight`);
        const sc = document.getElementById(`${area.key}-${type}-shadow-color`);
        const sx = document.getElementById(`${area.key}-${type}-shadow-x`);
        const sy = document.getElementById(`${area.key}-${type}-shadow-y`);
        const sb = document.getElementById(`${area.key}-${type}-shadow-blur`);
        const v = document.getElementById(`${area.key}-${type}`);
        if(c || f || s || v || w || sc){
          const entry = {};
          if(c){ entry.color = c.value; }
          if((['bg','card','border','hoverBorder','activeBorder','optionsMenu'].includes(type)) && o){ entry.opacity = o.value; }
          if(v){ entry.value = v.value; }
          if(f){ entry.font = f.value; }
          if(s){ entry.size = s.value; }
          if(w){ entry.weight = w.value; }
          if(sc){
            entry.shadow = { color: sc.value };
            if(sx) entry.shadow.x = sx.value;
            if(sy) entry.shadow.y = sy.value;
            if(sb) entry.shadow.blur = sb.value;
          }
          data[`${area.key}-${type}`] = entry;
        }
      });
    });
    const stickyHeader = document.getElementById('open-posts-sticky-header');
    if(stickyHeader){ data['open-posts-sticky-header'] = { value: stickyHeader.checked ? '1' : '0' }; }
    const stickyImages = document.getElementById('open-posts-sticky-images');
    if(stickyImages){ data['open-posts-sticky-images'] = { value: stickyImages.checked ? '1' : '0' }; }
    ['primary','secondary','accent','buttonHoverText'].forEach(id=>{
      const input = document.getElementById(id);
      if(input){
        data[id] = { color: input.value };
      }
    });
    ['btn','btnHover','btnActive','modalBg','scrollbarTrack','scrollbarThumb','scrollbarThumbHover','listBackground','dropdownBg','dropdownSelectedBg','dropdownHoverBg'].forEach(id=>{
      const c = document.getElementById(`${id}-c`);
      const o = document.getElementById(`${id}-o`);
      if(c){
        data[id] = { color: c.value };
        if(o) data[id].opacity = o.value;
      }
    });
    ['dropdownTitle','modalText','placeholder','filterPlaceholder','dateRangeText','dropdownSelectedText','dropdownText','dropdownHoverText','dropdownVenueText','filterBtnActive'].forEach(id=>{
      const c = document.getElementById(`${id}-c`);
      if(c){
        data[id] = { color: c.value };
      }
    });
    ['list','closed-posts'].forEach(areaKey=>{
      const tw = document.getElementById(`${areaKey}-thumbWidth`);
      if(tw){ data[`${areaKey}-thumbWidth`] = { value: tw.value }; }
      const th = document.getElementById(`${areaKey}-thumbHeight`);
      if(th){ data[`${areaKey}-thumbHeight`] = { value: th.value }; }
    });
    return data;
  }

  function generateCss(data){
    const varNames = {primary:'--primary',secondary:'--secondary',accent:'--accent',buttonHoverText:'--button-hover-text',btn:'--btn',btnHover:'--btn-hover',btnActive:'--btn-active',modalBg:'--modal-bg',modalText:'--modal-text',scrollbarTrack:'--scrollbar-track',scrollbarThumb:'--scrollbar-thumb',scrollbarThumbHover:'--scrollbar-thumb-hover',listBackground:'--list-background',placeholder:'--placeholder-text',filterPlaceholder:'--filter-placeholder-text',dateRangeText:'--filter-date-text',dropdownTitle:'--dropdown-title',dropdownSelectedBg:'--dropdown-selected-bg',dropdownSelectedText:'--dropdown-selected-text',dropdownText:'--dropdown-text',dropdownBg:'--dropdown-bg',dropdownHoverBg:'--dropdown-hover-bg',dropdownHoverText:'--dropdown-hover-text',dropdownVenueText:'--dropdown-venue-text',filterBtnActive:'--filter-btn-active',border:'--border',hoverBorder:'--border-hover',activeBorder:'--border-active'};
    let css = '';
    const rootVars = [];
    Object.entries(varNames).forEach(([key,varName])=>{
      if(['border','hoverBorder','activeBorder'].includes(key)) return;
      const entry = data[key];
      if(entry && entry.color){
        const color = entry.opacity!==undefined ? hexToRgba(entry.color, entry.opacity) : entry.color;
        rootVars.push(`${varName}:${color};`);
      }
    });
    ['border','hoverBorder','activeBorder'].forEach(type=>{
      const entry = data[`body-${type}`];
      if(entry && entry.color){
        const color = entry.opacity!==undefined ? hexToRgba(entry.color, entry.opacity) : entry.color;
        rootVars.push(`${varNames[type]}:${color};`);
      }
    });
    const baseBorder = data['body-border'];
    if(baseBorder){
      const hoverAdj = data['body-hoverAdjust'];
      if(hoverAdj && !data['body-hoverBorder']){
        const adj = adjust(baseBorder.color, parseInt(hoverAdj.value,10)||0);
        const col = baseBorder.opacity!==undefined ? hexToRgba(adj, baseBorder.opacity) : adj;
        rootVars.push(`--border-hover:${col};`);
      }
      const activeAdj = data['body-activeAdjust'];
      if(activeAdj && !data['body-activeBorder']){
        const adj = adjust(baseBorder.color, parseInt(activeAdj.value,10)||0);
        const col = baseBorder.opacity!==undefined ? hexToRgba(adj, baseBorder.opacity) : adj;
        rootVars.push(`--border-active:${col};`);
      }
    }
    if(rootVars.length){
      css += `:root{${rootVars.join('')}}\n`;
    }
    if(data['open-posts-sticky-header'] && data['open-posts-sticky-header'].value === '1'){
      css += '.open-posts-sticky-header .open-posts .detail-header{position:sticky;top:0;z-index:3;background:var(--list-background);}\n';
    }
    colorAreas.forEach(area=>{
      ['bg','card','text','title','btn','btnText','header','image','optionsMenu','mapCtrl','menu'].forEach(type=>{
        const entry = data[`${area.key}-${type}`];
        if(!entry) return;
        const selectors = area.selectors[type] || [];
        if(!selectors.length) return;
        const rules = [];
        if(type==='bg' || type==='card' || type==='header' || type==='image' || type==='optionsMenu' || type==='menu'){
          if(entry.color){
            const color = entry.opacity!==undefined ? hexToRgba(entry.color, entry.opacity) : entry.color;
            rules.push(`background-color:${color};`);
          }
          if(type==='card' && entry.shadow){
            const s = entry.shadow; const blur = s.blur || 0;
            rules.push(`box-shadow:0 0 ${blur}px ${s.color};`);
          }
        } else if(type==='text' || type==='title' || type==='btnText'){
          if(entry.color) rules.push(`color:${entry.color};`);
          if(entry.font) rules.push(`font-family:${entry.font};`);
          if(entry.size) rules.push(`font-size:${entry.size}px;`);
          if(entry.weight) rules.push(`font-weight:${entry.weight};`);
          if(entry.shadow){
            const s = entry.shadow; const x = s.x || 0; const y = s.y || 0; const blur = s.blur || 0;
            rules.push(`text-shadow:${x}px ${y}px ${blur}px ${s.color};`);
          }
        } else if(type==='btn' || type==='mapCtrl'){
          if(entry.color) rules.push(`background-color:${entry.color};border-color:${entry.color};`);
          if(entry.shadow){
            const s = entry.shadow; const blur = s.blur || 0;
            rules.push(`box-shadow:0 0 ${blur}px ${s.color};`);
          }
        }
        if(rules.length){
          css += selectors.map(sel=>`${sel}{${rules.join('')}}`).join('\n') + '\n';
        }
      });
    });
    ['list','closed-posts'].forEach(areaKey=>{
      const tw = data[`${areaKey}-thumbWidth`];
      const th = data[`${areaKey}-thumbHeight`];
      if(tw || th){
        const thumbSel = areaKey === 'list' ? '.res-list .thumb' : '.closed-posts .thumb';
        const tRules = [];
        if(tw) tRules.push(`width:${tw.value}px;`);
        if(th) tRules.push(`height:${th.value}px;`);
        if(tRules.length) css += `${thumbSel}{${tRules.join('')}}` + '\n';
      }
    });
    return css;
  }
  function updateHistoryButtons(){
    if(undoBtn) undoBtn.disabled = undoStack.length === 0;
    if(redoBtn) redoBtn.disabled = redoStack.length === 0;
  }

  let presets = [];
  let defaultTheme = {};

  function updatePresetOptions(){
    const sel = document.getElementById('themePreset');
    if(!sel) return;
    sel.innerHTML = '';
    presets.forEach((p,i)=>{
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = p.name;
      sel.appendChild(opt);
    });
    sel.selectedIndex = 0;
  }

  function loadPresets(){
    const stored = JSON.parse(localStorage.getItem('themePresets')||'[]');
    presets = [
      {name:'Dark Transparency', css:'theme-dark-transparency'},
      {name:'Readable', css:'theme-readable'},
      ...stored
    ];
    updatePresetOptions();
  }

  function applyPresetData(data){
      Object.entries(data).forEach(([key,val])=>{
        const parts = key.split('-');
        const areaKey = parts.shift();
        const type = parts.join('-');
        if(!type){
          const colorInput = document.getElementById(`${key}-c`) || document.getElementById(key);
          const opacityInput = document.getElementById(`${key}-o`);
          if(colorInput && val.color){ colorInput.value = val.color; }
          if(opacityInput && val.opacity!==undefined){ opacityInput.value = val.opacity; }
        const varMap = {primary:'--primary',secondary:'--secondary',accent:'--accent',buttonHoverText:'--button-hover-text',btn:'--btn',btnHover:'--btn-hover',btnActive:'--btn-active',modalBg:'--modal-bg',modalText:'--modal-text',scrollbarTrack:'--scrollbar-track',scrollbarThumb:'--scrollbar-thumb',scrollbarThumbHover:'--scrollbar-thumb-hover',listBackground:'--list-background',placeholder:'--placeholder-text',filterPlaceholder:'--filter-placeholder-text',dateRangeText:'--filter-date-text',dropdownTitle:'--dropdown-title',dropdownSelectedBg:'--dropdown-selected-bg',dropdownSelectedText:'--dropdown-selected-text',dropdownText:'--dropdown-text',dropdownBg:'--dropdown-bg',dropdownHoverBg:'--dropdown-hover-bg',dropdownHoverText:'--dropdown-hover-text',dropdownVenueText:'--dropdown-venue-text',filterBtnActive:'--filter-btn-active'};
          if(varMap[key]){
            const color = val.opacity!==undefined ? hexToRgba(val.color, val.opacity) : val.color;
            document.documentElement.style.setProperty(varMap[key], color);
          }
          return;
        }
        const direct = document.getElementById(`${areaKey}-${type}`);
        if(direct && val.value!==undefined){
          direct.value = val.value;
          return;
        }
        const c = document.getElementById(`${areaKey}-${type}-c`);
        const o = document.getElementById(`${areaKey}-${type}-o`);
        const f = document.getElementById(`${areaKey}-${type}-font`);
        const s = document.getElementById(`${areaKey}-${type}-size`);
        const w = document.getElementById(`${areaKey}-${type}-weight`);
        const sc = document.getElementById(`${areaKey}-${type}-shadow-color`);
        const sx = document.getElementById(`${areaKey}-${type}-shadow-x`);
        const sy = document.getElementById(`${areaKey}-${type}-shadow-y`);
        const sb = document.getElementById(`${areaKey}-${type}-shadow-blur`);
        const v = document.getElementById(`${areaKey}-${type}`);
        if(c && val.color){ c.value = val.color; }
        if((['bg','card','border','hoverBorder','activeBorder'].includes(type)) && o && val.opacity!==undefined){ o.value = val.opacity; }
        if(v && val.value!==undefined){ v.value = val.value; }
        if(f && val.font){ f.value = val.font; }
        if(s && val.size){ s.value = val.size; }
        if(w && val.weight){ w.value = val.weight; }
        if(sc && val.shadow){
          if(val.shadow.color) sc.value = val.shadow.color;
          if(sx && val.shadow.x!==undefined) sx.value = val.shadow.x;
          if(sy && val.shadow.y!==undefined) sy.value = val.shadow.y;
          if(sb && val.shadow.blur!==undefined) sb.value = val.shadow.blur;
        }
      });
      applyAdmin();
    }

  function applyPreset(p){
    document.querySelectorAll('[id^="theme-"]').forEach(el=>{ el.disabled = true; });
    if(!p) return;
    if(p.data){
      localStorage.removeItem('selectedCssTheme');
      applyPresetData(p.data);
    } else if(p.css){
      localStorage.setItem('selectedCssTheme', p.css);
      localStorage.removeItem('currentTheme');
      document.documentElement.removeAttribute('style');
      colorAreas.forEach(area=>{
        Object.values(area.selectors).flat().forEach(sel=>{
          document.querySelectorAll(sel).forEach(el=>{
            if(el === document.body){
              const pad = el.style.paddingBottom;
              el.removeAttribute('style');
              if(pad) el.style.paddingBottom = pad;
            } else {
              el.removeAttribute('style');
            }
          });
        });
      });
      document.querySelectorAll('.res-list .thumb,.closed-posts .thumb').forEach(el=> el.removeAttribute('style'));
      const styleEl = document.getElementById(p.css);
      if(styleEl) styleEl.disabled = false;
    }
  }

  function savePreset(name){
    const stored = JSON.parse(localStorage.getItem('themePresets')||'[]');
    stored.push({name,data: collectThemeValues()});
    localStorage.setItem('themePresets', JSON.stringify(stored));
    loadPresets();
  }

  function loadSavedTheme(){
    const saved = JSON.parse(localStorage.getItem('currentTheme')||'null');
    if(saved){
      localStorage.removeItem('selectedCssTheme');
      applyPresetData(saved);
      return true;
    }
    const cssTheme = localStorage.getItem('selectedCssTheme');
    if(cssTheme){
      const idx = presets.findIndex(p=>p.css===cssTheme);
      if(idx !== -1){
        const sel = document.getElementById('themePreset');
        if(sel) sel.value = idx;
        applyPreset(presets[idx]);
        return true;
      }
    }
    return false;
  }


  buildStyleControls();
  syncAdminControls();
  defaultTheme = collectThemeValues();
  loadPresets();
  const applied = loadSavedTheme();
  if(!applied) applyAdmin();
  currentState = collectThemeValues();
  updateHistoryButtons();

    const adminForm = document.getElementById('adminForm');
    if(adminForm){
          const speedInput = document.getElementById("spinSpeed");
          const speedVal = document.getElementById("spinSpeedVal");
          const loadStartChk = document.getElementById("spinLoadStart");
          const typeRadios = document.querySelectorAll("#spinType input");
          const logoClickChk = document.getElementById("spinLogoClick");
          const themeSelect = document.getElementById("mapTheme");
          const pitchInput = document.getElementById("mapPitch");
          const pitchVal = document.getElementById("pitchVal");
          const bearingInput = document.getElementById("mapBearing");
          const bearingVal = document.getElementById("bearingVal");
        if(themeSelect){
          themeSelect.value = mapStyle;
          themeSelect.addEventListener("change", ()=>{
              mapStyle = window.mapStyle = themeSelect.value;
              localStorage.setItem("mapStyle", mapStyle);
              if(map) map.setStyle(mapStyle);
          });
        }
        const skySelect = document.getElementById("skyTheme");
        if(skySelect){
          skySelect.value = skyStyle;
          skySelect.addEventListener("change", ()=>{
              skyStyle = window.skyStyle = skySelect.value;
              localStorage.setItem("skyStyle", skyStyle);
              if(map) applySky(skyStyle);
          });
        }
        adminForm.querySelectorAll('.refresh-page-btn').forEach(btn=>{
          btn.addEventListener('click', ()=> location.reload());
        });
        if(speedInput && speedVal){
        speedInput.value = sg.spinEnabled ? sg.spinSpeed : 0;
        speedVal.textContent = sg.spinEnabled ? sg.spinSpeed.toFixed(2) : "Off";
        speedInput.addEventListener("input", ()=>{
          const val = Math.max(0, parseFloat(speedInput.value) || 0);
          sg.spinEnabled = val > 0;
          sg.spinSpeed = val;
          speedVal.textContent = sg.spinEnabled ? val.toFixed(2) : "Off";
          localStorage.setItem("spinGlobe", JSON.stringify(sg.spinEnabled));
          localStorage.setItem("spinSpeed", String(sg.spinSpeed));
          if(sg.spinEnabled) sg.startSpin(); else sg.stopSpin();
        });
      }
      if(pitchInput && pitchVal){
        pitchInput.value = startPitch;
        pitchVal.textContent = startPitch.toFixed(0);
        pitchInput.addEventListener("input", ()=>{
          const val = parseFloat(pitchInput.value) || 0;
            if(map) map.setPitch(val);
          pitchVal.textContent = val.toFixed(0);
        });
      }
      if(bearingInput && bearingVal){
        bearingInput.value = startBearing;
        bearingVal.textContent = startBearing.toFixed(0);
        bearingInput.addEventListener("input", ()=>{
          const val = parseFloat(bearingInput.value) || 0;
            if(map) map.setBearing(val);
          bearingVal.textContent = val.toFixed(0);
        });
      }
      if(loadStartChk){
        loadStartChk.checked = sg.spinLoadStart;
        loadStartChk.addEventListener("change", ()=>{
          sg.spinLoadStart = loadStartChk.checked;
          localStorage.setItem("spinLoadStart", JSON.stringify(sg.spinLoadStart));
          sg.updateSpinState();
        });
      }
      if(typeRadios.length){
        typeRadios.forEach(radio=>{
          radio.checked = radio.value === sg.spinLoadType;
          radio.addEventListener("change", ()=>{
            if(!radio.checked) return;
            sg.spinLoadType = radio.value;
            localStorage.setItem("spinLoadType", sg.spinLoadType);
            sg.updateSpinState();
          });
        });
      }
      if(logoClickChk){
        logoClickChk.checked = sg.spinLogoClick;
        logoClickChk.addEventListener("change", ()=>{
          sg.spinLogoClick = logoClickChk.checked;
          localStorage.setItem("spinLogoClick", JSON.stringify(sg.spinLogoClick));
          sg.updateLogoClickState();
        });
      }
        adminForm.addEventListener("input", e=>{
          if(["spinSpeed","mapTheme","skyTheme","mapPitch","mapBearing"].includes(e.target.id)) return;
          applyAdmin(e.target);
        });
        adminForm.addEventListener("change", e=>{
          if(["spinSpeed","mapTheme","skyTheme","mapPitch","mapBearing"].includes(e.target.id)) return;
          applyAdmin(e.target);
        });
    }

    // Save/Discard/Restore logic
    const saveBtn = document.getElementById('saveNow');
    const discardBtn = document.getElementById('discardChanges');
    const adminClose = document.querySelector('#adminModal .close-modal');
    const tabPanels = ['theme','map','settings'];
    const savedData = {};

    function toHex(val){
      if(typeof val !== 'string') return val;
      const m = val.match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);
      if(!m) return val;
      let h = val.toUpperCase();
      if(h.length === 4){ h = '#' + h[1]+h[1]+h[2]+h[2]+h[3]+h[3]; }
      return h;
    }

    function snapshot(tab){
      const panel = document.getElementById(`tab-${tab}`);
      const inputs = panel.querySelectorAll('input,select,textarea,button.toggle-btn');
      const data = {};
      inputs.forEach(el=>{
        if(!el.id && el.name) el.id = el.name; // ensure key
        if(el.tagName === 'BUTTON'){
          data[el.id] = el.getAttribute('aria-pressed') === 'true';
        } else if(el.type === 'checkbox') data[el.id] = el.checked;
        else if(el.type === 'radio'){ if(el.checked) data[el.name] = el.value; }
        else {
          let v = el.value;
          if(typeof v === 'string' && v.startsWith('#')) v = toHex(v);
          data[el.id] = v;
        }
      });
      return data;
    }

    function applyData(tab,data){
      const panel = document.getElementById(`tab-${tab}`);
      Object.entries(data||{}).forEach(([id,val])=>{
        const el = panel.querySelector(`#${id}`);
        if(!el) return;
        if(el.tagName === 'BUTTON') el.setAttribute('aria-pressed', val);
        else if(el.type === 'checkbox') el.checked = !!val;
        else if(el.type === 'radio'){
          const r = panel.querySelector(`input[name="${id}"][value="${val}"]`);
          if(r) r.checked = true;
        } else {
          el.value = val;
        }
      });
    }

    function populateBackups(tab){
      const select = document.getElementById(`${tab}Restore`);
      if(!select) return;
      const backups = JSON.parse(localStorage.getItem(`admin-${tab}-backups`) || '[]');
      select.innerHTML = '';
      backups.slice().reverse().forEach((b,i)=>{
        const opt = document.createElement('option');
        opt.value = backups.length - 1 - i;
        opt.textContent = b.name;
        select.appendChild(opt);
      });
    }

    function loadSaved(){
      tabPanels.forEach(tab=>{
        const raw = localStorage.getItem(`admin-${tab}-current`);
        if(raw){
          savedData[tab] = JSON.parse(raw);
          applyData(tab, savedData[tab]);
        } else {
          savedData[tab] = snapshot(tab);
        }
        populateBackups(tab);
      });
    }

    function saveTab(tab){
      const data = snapshot(tab);
      if(JSON.stringify(data) === JSON.stringify(savedData[tab])) return false;
      savedData[tab] = data;
      localStorage.setItem(`admin-${tab}-current`, JSON.stringify(data));
      const backups = JSON.parse(localStorage.getItem(`admin-${tab}-backups`) || '[]');
      backups.push({ name:`ADMIN ${tab} Backup ${new Date().toISOString()}`, data });
      localStorage.setItem(`admin-${tab}-backups`, JSON.stringify(backups));
      populateBackups(tab);
      if(location.hostname !== 'zxen1.github.io'){
        fetch('/admin/save', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ tab, data })
        }).catch(()=>{});
      }
      return true;
    }

    function showSaveMessage(msg){
      let box = document.getElementById('saveStatus');
      if(!box){
        box = document.createElement('div');
        box.id = 'saveStatus';
        box.style.position = 'fixed';
        box.style.top = '50%';
        box.style.left = '50%';
        box.style.transform = 'translate(-50%, -50%)';
        box.style.fontFamily = 'Arial, sans-serif';
        box.style.fontSize = '32px';
        box.style.background = 'rgba(0,0,0,0.7)';
        box.style.color = '#fff';
        box.style.padding = '10px 20px';
        box.style.borderRadius = '4px';
        box.style.zIndex = '10000';
        box.style.display = 'none';
        document.body.appendChild(box);
      }
      box.textContent = msg;
      box.style.display = 'block';
      setTimeout(()=>{ box.style.display = 'none'; }, 1500);
    }

    function saveAllTabs(){
      let changed = false;
      tabPanels.forEach(tab=>{ if(saveTab(tab)) changed = true; });
      showSaveMessage(changed ? 'Saved' : 'No changes were made');
      return changed;
    }
    window.saveAdminChanges = saveAllTabs;

    saveBtn && saveBtn.addEventListener('click', saveAllTabs);

    discardBtn && discardBtn.addEventListener('click', ()=>{
      if(!confirm('Are you sure you want to Discard Your Changes? Y/N')) return;
      tabPanels.forEach(tab=> applyData(tab, savedData[tab]));
    });

    adminClose && adminClose.addEventListener('click', ()=>{
      saveAllTabs();
      requestCloseModal(adminClose.closest('.modal'));
    });

    document.querySelectorAll('button[data-restore]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const tab = btn.dataset.restore;
        const select = document.getElementById(`${tab}Restore`);
        const idx = parseInt(select.value,10);
        const backups = JSON.parse(localStorage.getItem(`admin-${tab}-backups`) || '[]');
        const backup = backups[idx];
        if(backup){
          applyData(tab, backup.data);
          saveTab(tab);
        }
      });
    });

    loadSaved();

  const presetSelect = document.getElementById('themePreset');
  presetSelect && presetSelect.addEventListener('change', e=>{
    const idx = parseInt(e.target.value, 10);
    applyPreset(presets[idx]);
  });
  const refreshBtn = document.getElementById('refreshTheme');
  refreshBtn && refreshBtn.addEventListener('click', ()=>{
    const idx = parseInt(presetSelect.value, 10);
    applyPreset(presets[idx]);
  });
  const savePresetBtn = document.getElementById('savePreset');
  savePresetBtn && savePresetBtn.addEventListener('click', ()=>{
    const name = document.getElementById('newPresetName').value.trim();
    if(name){
      savePreset(name);
      document.getElementById('newPresetName').value = '';
    }
  });

  const downloadCssBtn = document.getElementById('downloadCss');
  downloadCssBtn && downloadCssBtn.addEventListener('click', ()=>{
    const css = generateCss(collectThemeValues());
    const blob = new Blob([css], { type:'text/css' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'theme.css';
    a.click();
    URL.revokeObjectURL(url);
  });

  const baseColorInput = document.getElementById('baseColor');
  const autoBuildBtn = document.getElementById('autoBuildBtn');
  undoBtn = document.getElementById('undoBtn');
  redoBtn = document.getElementById('redoBtn');
  autoBuildBtn && autoBuildBtn.addEventListener('click', ()=>{
    undoStack.push(JSON.parse(JSON.stringify(currentState)));
    redoStack.length = 0;
    const base = baseColorInput.value;
    const theme = generateTheme(base);
    const root = document.documentElement;
    root.style.setProperty('--primary', theme.primary);
    root.style.setProperty('--secondary', theme.secondary);
    root.style.setProperty('--accent', theme.accent);
    root.style.setProperty('--background', theme.background);
    root.style.setProperty('--text', theme.text);
    root.style.setProperty('--btn', theme.secondary);
    root.style.setProperty('--btn-hover', theme.accent);
    root.style.setProperty('--btn-active', theme.accent);
    root.style.setProperty('--ink', theme.text);
    root.style.setProperty('--ink-d', theme.text);
    root.style.setProperty('--button-text', theme.buttonText);
    root.style.setProperty('--button-hover-text', theme.buttonHoverText);
    updateFields(theme);
    spreadTheme(theme);
    syncAdminControls();
    currentState = collectThemeValues();
    updateHistoryButtons();
    localStorage.setItem('currentTheme', JSON.stringify(currentState));
  });
  undoBtn && undoBtn.addEventListener('click', ()=>{
    if(!undoStack.length) return;
    redoStack.push(JSON.parse(JSON.stringify(currentState)));
    const prev = undoStack.pop();
    applyPresetData(prev);
    currentState = JSON.parse(JSON.stringify(prev));
    updateHistoryButtons();
  });
  redoBtn && redoBtn.addEventListener('click', ()=>{
    if(!redoStack.length) return;
    undoStack.push(JSON.parse(JSON.stringify(currentState)));
    const next = redoStack.pop();
    applyPresetData(next);
    currentState = JSON.parse(JSON.stringify(next));
    updateHistoryButtons();
  });

    const fieldBindings = {
      primary: '--primary',
      secondary: '--secondary',
      accent: '--accent',
      buttonHoverText: '--button-hover-text',
      btn: '--btn',
      btnHover: '--btn-hover',
      btnActive: '--btn-active',
      modalBg: '--modal-bg',
      modalText: '--modal-text',
      scrollbarTrack: '--scrollbar-track',
      scrollbarThumb: '--scrollbar-thumb',
      scrollbarThumbHover: '--scrollbar-thumb-hover',
      listBackground: '--list-background',
      placeholder: '--placeholder-text',
      filterPlaceholder: '--filter-placeholder-text',
      dateRangeText: '--filter-date-text',
      dropdownTitle: '--dropdown-title',
      dropdownSelectedBg: '--dropdown-selected-bg',
      dropdownSelectedText: '--dropdown-selected-text',
      dropdownText: '--dropdown-text',
      dropdownBg: '--dropdown-bg',
      dropdownHoverBg: '--dropdown-hover-bg',
      dropdownHoverText: '--dropdown-hover-text',
      dropdownVenueText: '--dropdown-venue-text'
    };
  Object.entries(fieldBindings).forEach(([id, varName])=>{
    const el = document.getElementById(`${id}-c`) || document.getElementById(id);
    const oEl = document.getElementById(`${id}-o`);
    if(el){
      const handler = ()=>{
        const color = oEl ? hexToRgba(el.value, oEl.value) : el.value;
        document.documentElement.style.setProperty(varName, color);
        updateFields({ [id]: el.value });
        currentState = collectThemeValues();
        updateHistoryButtons();
        localStorage.setItem('currentTheme', JSON.stringify(currentState));
      };
      el.addEventListener('input', handler);
      if(oEl) oEl.addEventListener('input', handler);
    }
  });

  window.addEventListener('resize', updateLayoutVars);
  window.addEventListener('resize', updateStickyImages);
  window.addEventListener('load', updateLayoutVars);
  updateLayoutVars();
  if (typeof updateStickyImages === 'function') {
    updateStickyImages();
  }
})();
</script>

<script>
  (function(){
    const ns = 'http://www.w3.org/2000/svg';
    const SHAPES = {
      circle(){ const c=document.createElementNS(ns,'circle'); c.setAttribute('cx','0'); c.setAttribute('cy','0'); c.setAttribute('r','50'); return c; },
      tallEllipse(){ const e=document.createElementNS(ns,'ellipse'); e.setAttribute('cx','0'); e.setAttribute('cy','0'); e.setAttribute('rx','40'); e.setAttribute('ry','55'); return e; },
      heart(){ const p=document.createElementNS(ns,'path'); p.setAttribute('d','M0,-30 C-30,-70 -70,-20 -35,15 Q0,55 35,15 C70,-20 30,-70 0,-30Z'); return p; },
      star(){ const p=document.createElementNS(ns,'path'); p.setAttribute('d','M0,-55 L14,-17 L47,-17 L23,5 L35,45 L0,25 L-35,45 L-23,5 L-47,-17 L-14,-17 Z'); return p; },
      triangle(){ const p=document.createElementNS(ns,'path'); p.setAttribute('d','M0,55 L50,-45 L-50,-45 Z'); return p; },
      rectangle(){ const r=document.createElementNS(ns,'rect'); r.setAttribute('x','-35'); r.setAttribute('y','-55'); r.setAttribute('width','70'); r.setAttribute('height','110'); r.setAttribute('rx','20'); r.setAttribute('ry','20'); return r; },
      square(){ const r=document.createElementNS(ns,'rect'); r.setAttribute('x','-45'); r.setAttribute('y','-45'); r.setAttribute('width','90'); r.setAttribute('height','90'); r.setAttribute('rx','20'); r.setAttribute('ry','20'); return r; },
      diamond(){ const p=document.createElementNS(ns,'path'); p.setAttribute('d','M0,-55 L45,0 0,55 -45,0 Z'); return p; },
      pentagon(){ const p=document.createElementNS(ns,'path'); p.setAttribute('d','M0,-55 L52,-17 L32,45 -32,45 -52,-17 Z'); return p; },
      hexagon(){ const p=document.createElementNS(ns,'path'); p.setAttribute('d','M0,-55 L47,-27 L47,27 0,55 -47,27 -47,-27 Z'); return p; }
    };

    function hslToHex(h, s, l){
      s/=100; l/=100;
      const k = n => (n + h/30) % 12;
      const a = s * Math.min(l, 1-l);
      const f = n => l - a * Math.max(-1, Math.min(k(n)-3, Math.min(9-k(n),1)));
      return '#' + [f(0),f(8),f(4)].map(x=>Math.round(x*255).toString(16).padStart(2,'0')).join('');
    }
    const COLORS = Array.from({length:100}, (_,i)=>hslToHex(i*3.6,100,50));

    function createBalloon(shapeName, color, size){
      const svg = document.createElementNS(ns,'svg');
      svg.setAttribute('viewBox','-60 -80 120 160');
      svg.setAttribute('width', size);
      svg.setAttribute('height', size);
      svg.dataset.color = color;
      svg.setAttribute('title', size + 'px ' + color);
      const body = SHAPES[shapeName]();
      body.setAttribute('fill', color);
      body.setAttribute('stroke', '#000');
      body.setAttribute('stroke-width', '1');
      svg.appendChild(body);
      const tie = document.createElementNS(ns,'path');
      tie.setAttribute('d','M-8,55 L0,60 L8,55 Z');
      tie.setAttribute('fill','#000');
      tie.setAttribute('stroke','#000');
      tie.setAttribute('stroke-width','1');
      svg.appendChild(tie);
      const string = document.createElementNS(ns,'line');
      string.setAttribute('x1','0'); string.setAttribute('y1','60');
      string.setAttribute('x2','0'); string.setAttribute('y2','80');
      string.setAttribute('stroke','#fff');
      string.setAttribute('stroke-width','2');
      svg.appendChild(string);
      const gleam = document.createElementNS(ns,'ellipse');
      gleam.setAttribute('cx','-20'); gleam.setAttribute('cy','-20');
      gleam.setAttribute('rx','10'); gleam.setAttribute('ry','6');
      gleam.setAttribute('fill','#fff');
      svg.appendChild(gleam);
      return svg;
    }

    const buttons = document.getElementById('balloonShapeButtons');
    const balloons = document.getElementById('balloonIcons');
    const scrollTop = document.getElementById('balloonScrollTop');
    const scrollBottom = document.getElementById('balloonScrollBottom');
    const scrollTopInner = scrollTop.firstElementChild;
    const sizeSlider = document.getElementById('balloonSize');
    const sizeValue = document.getElementById('balloonSizeValue');
    const svgCode = document.getElementById('balloonSvgCode');
    const copyBtn = document.getElementById('copySvgCode');
    let selectedBalloon = null;
    const storedSize = localStorage.getItem('balloonSize');
    if(storedSize) sizeSlider.value = storedSize;

    function syncScroll(e){
      if(e.target === scrollTop) scrollBottom.scrollLeft = scrollTop.scrollLeft;
      else scrollTop.scrollLeft = scrollBottom.scrollLeft;
    }
    scrollTop.addEventListener('scroll', syncScroll);
    scrollBottom.addEventListener('scroll', syncScroll);

    function updateScrollWidth(){
      scrollTopInner.style.width = balloons.scrollWidth + 'px';
    }

    sizeValue.textContent = sizeSlider.value;
    copyBtn.addEventListener('click', ()=>{ navigator.clipboard.writeText(svgCode.value); });

    sizeSlider.addEventListener('input', ()=>{
      sizeValue.textContent = sizeSlider.value;
      localStorage.setItem('balloonSize', sizeSlider.value);
      balloons.querySelectorAll('svg').forEach(svg=>{
        svg.setAttribute('width', sizeSlider.value);
        svg.setAttribute('height', sizeSlider.value);
        svg.setAttribute('title', sizeSlider.value + 'px ' + svg.dataset.color);
      });
      if(selectedBalloon) svgCode.value = selectedBalloon.outerHTML;
      updateScrollWidth();
    });

    function render(name){
      balloons.innerHTML='';
      COLORS.forEach(color=>{
        const svg = createBalloon(name, color, sizeSlider.value);
        svg.addEventListener('click', ()=>{ selectedBalloon = svg; svgCode.value = svg.outerHTML; });
        balloons.appendChild(svg);
      });
      updateScrollWidth();
    }

    const LABELS = {
      circle:'circle',
      tallEllipse:'tall ellipse',
      heart:'heart',
      star:'soft star',
      triangle:'soft triangle',
      rectangle:'tall rectangle',
      square:'square',
      diamond:'diamond',
      pentagon:'pentagon',
      hexagon:'hexagon'
    };

    Object.keys(SHAPES).forEach((name,idx)=>{
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'shape-button';
      btn.appendChild(createBalloon(name, '#000', 24));
      btn.appendChild(document.createTextNode(LABELS[name] || name));
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('#balloonTool .shape-button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        render(name);
      });
      if(idx===0) btn.classList.add('active');
      buttons.appendChild(btn);
    });

  render(Object.keys(SHAPES)[0]);
  })();
</script>

<script>
  (function(){
    const ICONS = {
      circle:'<svg viewBox="0 0 20 20"><circle cx="10" cy="10" r="8" fill="#000"/></svg>',
      square:'<svg viewBox="0 0 20 20"><rect x="2" y="2" width="16" height="16" fill="#000"/></svg>',
      triangle:'<svg viewBox="0 0 20 20"><polygon points="10,2 18,18 2,18" fill="#000"/></svg>'
    };
    const FIELD_TYPES = ['Text','Number','Date','Color'];
    function createIconSelect(){
      const s=document.createElement('select');
      Object.keys(ICONS).forEach(k=>{
        const o=document.createElement('option');
        o.value=k;
        o.innerHTML=ICONS[k];
        s.appendChild(o);
      });
      return s;
    }
    function createFieldSelect(){
      const s=document.createElement('select');
      FIELD_TYPES.forEach(t=>{
        const o=document.createElement('option');
        o.value=t.toLowerCase();
        o.textContent=t;
        s.appendChild(o);
      });
      return s;
    }
    function addSubcategory(table){
      const iconRow=table.querySelector('.icon-row');
      const nameRow=table.querySelector('.name-row');
      const iconCell=document.createElement('td'); iconCell.appendChild(createIconSelect()); iconRow.appendChild(iconCell);
      const nameCell=document.createElement('td'); const inp=document.createElement('input'); nameCell.appendChild(inp); nameRow.appendChild(nameCell);
      table.querySelectorAll('.field-row').forEach(row=>{
        const cell=document.createElement('td'); cell.appendChild(createFieldSelect()); row.appendChild(cell);
      });
    }
    function addFieldRow(table){
      const cols=table.querySelector('.icon-row').children.length;
      const row=document.createElement('tr'); row.className='field-row';
      for(let i=0;i<cols;i++){ const cell=document.createElement('td'); cell.appendChild(createFieldSelect()); row.appendChild(cell); }
      table.appendChild(row);
    }
    function wireCategory(cat){
      const table=cat.querySelector('table');
      cat.querySelector('.delete-category').addEventListener('click',()=>cat.remove());
      cat.querySelector('.copy-category').addEventListener('click',()=>{const clone=cat.cloneNode(true); wireCategory(clone); cat.after(clone);});
      cat.querySelector('.add-subcategory').addEventListener('click',()=>addSubcategory(table));
      cat.querySelector('.add-field').addEventListener('click',()=>addFieldRow(table));
    }
    function createCategory(){
      const cat=document.createElement('div'); cat.className='form-category';
      const header=document.createElement('div'); header.className='category-header';
      const name=document.createElement('input'); name.type='text'; name.placeholder='Category name';
      const icon=createIconSelect();
      const color=document.createElement('input'); color.type='color'; color.value='#000000';
      const copy=document.createElement('button'); copy.type='button'; copy.className='copy-category'; copy.textContent='Copy';
      const del=document.createElement('button'); del.type='button'; del.className='delete-category'; del.textContent='Delete';
      header.append(name,icon,color,copy,del);
      cat.appendChild(header);
      const table=document.createElement('table'); table.className='subcategory-table';
      const iconRow=document.createElement('tr'); iconRow.className='icon-row';
      const nameRow=document.createElement('tr'); nameRow.className='name-row';
      table.append(iconRow,nameRow);
      cat.appendChild(table);
      const addSub=document.createElement('button'); addSub.type='button'; addSub.className='add-subcategory'; addSub.textContent='Add Subcategory';
      const addField=document.createElement('button'); addField.type='button'; addField.className='add-field'; addField.textContent='Add Field';
      cat.append(addSub,addField);
      addSubcategory(table);
      addFieldRow(table);
      wireCategory(cat);
      return cat;
    }
    document.getElementById('addCategory').addEventListener('click',()=>{
      const cat=createCategory();
      document.getElementById('formsCategories').appendChild(cat);
    });
  })();
</script>

</body>
</html>
