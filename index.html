<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Events Platform</title>
  <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
  <link rel="manifest" href="/favicons/site.webmanifest">
  <link rel="shortcut icon" href="/favicons/favicon.ico">
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <style>
    :root {
      --color-header: navy;
      --color-footer: #000;
      --color-background: #fff;
      --color-text: #000;
      --scrollbar-thumb: #888;
    }
    body {
      font-family: Verdana, sans-serif;
      font-size: 14px;
      margin: 0;
      padding-top: 80px;
      color: var(--color-text);
      background: var(--color-background);
      scrollbar-gutter: stable both-edges;
    }
    * {
      scrollbar-width: thin;
      scrollbar-color: var(--scrollbar-thumb) transparent;
    }
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background-color: var(--scrollbar-thumb);
      border-radius: 5px;
      border: 3px solid transparent;
      background-clip: content-box;
    }
    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 80px;
      background: var(--color-header);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    header button {
      position: absolute;
      top: 0;
      width: 80px;
      height: 80px;
      background: transparent;
      border: none;
      cursor: pointer;
    }
    #filter-button { left: 0; }
    #list-button { left: 80px; }
    #posts-button { left: 160px; }
    #settings-button { right: 0; }
    #admin-button { right: 80px; }
    #member-button { right: 160px; }
    #header-logo {
      height: 60px;
      cursor: pointer;
    }
    #map {
      position: absolute;
      top: 80px;
      bottom: 80px;
      width: 100%;
    }
    #welcome-modal {
      width: 600px;
      margin: 0 auto;
      background: var(--color-background);
      color: var(--color-text);
      border: 1px solid #ccc;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <header id="header">
    <button id="filter-button" aria-label="Filter"></button>
    <button id="list-button" aria-label="List"></button>
    <button id="posts-button" aria-label="Posts"></button>
    <img id="header-logo" src="assets/funmap-logo-big.png" alt="FunMap logo">
    <button id="member-button" aria-label="Member"></button>
    <button id="admin-button" aria-label="Admin"></button>
    <button id="settings-button" aria-label="Settings"></button>
  </header>
  <div id="map"></div>
  <div id="welcome-modal" class="hidden">
    <img src="assets/funmap-logo-big.png" alt="FunMap logo" style="max-width:100%;height:auto;">
    <p>Welcome to FunMap!</p>
  </div>
  <div id="panels"></div>
  <footer id="footer"></footer>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.Xo14KJtnMhLy2RpQeyWNLw';
    const welcomeModal = document.getElementById('welcome-modal');
    const headerLogo = document.getElementById('header-logo');

    function toggleModal() {
      welcomeModal.classList.toggle('hidden');
    }

    window.addEventListener('load', () => {
      welcomeModal.classList.remove('hidden');
    });

    headerLogo.addEventListener('click', toggleModal);

    const buttonPanelMap = {
      'filter-button': 'filter-panel',
      'list-button': 'list-panel',
      'posts-button': 'posts-panel',
      'member-button': 'member-panel',
      'admin-button': 'admin-panel',
      'settings-button': 'settings-panel'
    };

    Object.keys(buttonPanelMap).forEach(buttonId => {
      const btn = document.getElementById(buttonId);
      const panelId = buttonPanelMap[buttonId];
      btn.addEventListener('click', () => {
        const panel = document.getElementById(panelId);
        if (panel) {
          panel.classList.toggle('hidden');
        }
      });
    });

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v11',
      center: [-122.447303, 37.753574],
      zoom: 10
    });

    map.on('load', () => {
      const standardCanvas = document.createElement('canvas');
      standardCanvas.width = 40;
      standardCanvas.height = 40;
      const stdCtx = standardCanvas.getContext('2d');
      stdCtx.fillStyle = '#3FB1CE';
      stdCtx.beginPath();
      stdCtx.arc(20, 20, 20, 0, Math.PI * 2);
      stdCtx.fill();

      const premiumCanvas = document.createElement('canvas');
      premiumCanvas.width = 80;
      premiumCanvas.height = 80;
      const premCtx = premiumCanvas.getContext('2d');
      premCtx.fillStyle = '#fbb03b';
      premCtx.beginPath();
      premCtx.arc(40, 40, 40, 0, Math.PI * 2);
      premCtx.fill();

      map.addImage('standard-icon', standardCanvas, { pixelRatio: 1 });
      map.addImage('premium-icon', premiumCanvas, { pixelRatio: 1 });

      const geojson = {
        type: 'FeatureCollection',
        features: [
          { type: 'Feature', properties: { id: 1, premium: false }, geometry: { type: 'Point', coordinates: [-122.447303, 37.753574] } },
          { type: 'Feature', properties: { id: 2, premium: true }, geometry: { type: 'Point', coordinates: [-122.457303, 37.763574] } },
          { type: 'Feature', properties: { id: 3, premium: false }, geometry: { type: 'Point', coordinates: [-122.467303, 37.773574] } }
        ]
      };

      map.addSource('events', {
        type: 'geojson',
        data: geojson,
        cluster: true,
        clusterMaxZoom: 14,
        clusterRadius: 50
      });

      map.addLayer({
        id: 'clusters',
        type: 'circle',
        source: 'events',
        filter: ['has', 'point_count'],
        paint: {
          'circle-color': '#51bbd6',
          'circle-radius': ['step', ['get', 'point_count'], 20, 100, 30, 750, 40]
        }
      });

      map.addLayer({
        id: 'cluster-count',
        type: 'symbol',
        source: 'events',
        filter: ['has', 'point_count'],
        layout: {
          'text-field': ['get', 'point_count_abbreviated'],
          'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
          'text-size': 12
        }
      });

      map.addLayer({
        id: 'unclustered-point',
        type: 'symbol',
        source: 'events',
        filter: ['!', ['has', 'point_count']],
        layout: {
          'icon-image': ['case', ['==', ['get', 'premium'], true], 'premium-icon', 'standard-icon'],
          'icon-allow-overlap': true
        }
      });

      map.on('click', 'clusters', (e) => {
        const features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
        const clusterId = features[0].properties.cluster_id;
        map.getSource('events').getClusterExpansionZoom(clusterId, (err, zoom) => {
          if (err) return;
          map.easeTo({ center: features[0].geometry.coordinates, zoom, pitch: 45 });
        });
      });

      map.on('click', 'unclustered-point', () => {
        const postsPanel = document.getElementById('posts-panel');
        if (postsPanel) postsPanel.classList.remove('hidden');
        const listPanel = document.getElementById('list-panel');
        if (listPanel) listPanel.scrollTo({ top: 0, behavior: 'smooth' });
      });

      map.on('mouseenter', 'clusters', () => { map.getCanvas().style.cursor = 'pointer'; });
      map.on('mouseleave', 'clusters', () => { map.getCanvas().style.cursor = ''; });
      map.on('mouseenter', 'unclustered-point', () => { map.getCanvas().style.cursor = 'pointer'; });
      map.on('mouseleave', 'unclustered-point', () => { map.getCanvas().style.cursor = ''; });
    });
  </script>
</body>
</html>
