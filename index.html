<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" id="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Events Platform</title>
  <link rel="apple-touch-icon" sizes="180x180" href="assets/favicons/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="assets/favicons/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="assets/favicons/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="assets/favicons/android-chrome-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="assets/favicons/android-chrome-512x512.png" />
  <link rel="manifest" href="assets/favicons/site.webmanifest" />
  <link rel="shortcut icon" href="assets/favicons/favicon.ico" />
  <style>:root{
  --header-h: 56px;
  --subheader-h: 0;
  --panel-w: 440px;
  --results-w: 440px;
  --gap: 10px;
    --media-h: 200px;
    --calendar-scale: 1;
    --ink: #ffffff;
    --ink-d: #ececec;
    --gold: #ffc107;
    --muted: #777;
      --primary: #3E5393;
      --secondary: #000000;
      --accent: #5C6FB1;
      --active: #2E3A72;
      --background: rgba(41,41,41,1);
      --text: #ffffff;
      --button-text: #ffffff;
      --button-hover-text: #ffffff;
      --button-active-text: #ffffff;
      --button-disabled-text: #666666;
      --btn: #333333;
      --btn-hover: #4d4d4d;
      --btn-active: #1a1a1a;
      --btn-selected: #2e3a72;
      --btn-selected-hover: #3c4b8a;
      --btn-selected-active: #232e59;
      --btn-disabled: #bbbbbb;
      --panel-bg: rgba(0,0,0,1);
      --panel-text: #000000;
      --footer-h: 0px;
      --list-background: rgba(0,0,0,0.37);
      --closed-card-bg: rgba(0,0,0,0.37);
      --scrollbar-track: rgba(0,0,0,0);
      --scrollbar-thumb: rgba(0,0,0,0.3);
      --scrollbar-thumb-hover: rgba(0,0,0,0.5);
      --scrollbar-h: 8px;
      --border: rgba(173,173,173,0.31);
      --border-hover: rgba(255,136,0,0.43);
      --border-active: rgba(255,200,0,0.45);
      --placeholder-text: gray;
      --filter-placeholder-text: var(--placeholder-text);
      --popup-bg: rgba(0,0,0,1);
      --popup-text: #ffffff;
      --dropdown-title: #000000;
      --dropdown-selected-bg: #2e3a72;
      --dropdown-selected-text: #ffffff;
      --dropdown-text: #000000;
      --dropdown-bg: rgba(255,255,255,1);
      --dropdown-hover-bg: rgba(224,224,224,1);
      --dropdown-hover-text: #000000;
        --dropdown-venue-text: #000000;
        --dropdown-radius: 8px;
        --calendar-width: 250px;
        --calendar-height: 200px;
        --calendar-cell-w: calc(var(--calendar-width) / 7);
        --calendar-header-h: 20px;
        --calendar-cell-h: calc((var(--calendar-height) - var(--calendar-header-h)) / 7);
        --calendar-past-bg: #f0f0f0;
        --calendar-future-bg: #ffffff;
        --session-available: #888888;
        --session-selected: #2e3a72;
        --today: #ff0000;
        --image-panel-bg: rgba(0,0,0,0.7);
        --filter-active-color: #ff0000;
      --keyword-bg: #FFFFFF;
      --date-range-bg: rgba(74,74,74,0.9);
      --date-range-text: rgba(255,255,255,1);
      --control-h: 35px;
      --geocoder-h: var(--control-h);
      --panel-label-font: system-ui, sans-serif;
      --panel-label-size: 14px;
      --panel-label-color: #ffffff;
      --panel-title-font: system-ui, sans-serif;
      --panel-title-size: 16px;
      --panel-title-color: #ffffff;
      --post-mode-bg-color: 0,0,0;
      --post-mode-bg-opacity: 0;
      --safe-top: env(safe-area-inset-top, 0px);
}

*:not([class*="mapboxgl-"]){
  box-sizing: border-box;
  scrollbar-width: thin;
  scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
  border-color: var(--border) !important;
}

fieldset{
  margin:0;
  padding:6px 0 0;
  border:0 !important;
}

*:not([class*="mapboxgl-"]):hover{
  border-color: var(--border-hover) !important;
}

*:not([class*="mapboxgl-"]):active{
  border-color: var(--border-active) !important;
}

*[aria-pressed="true"]:not([class*="mapboxgl-"]),
*[aria-current="page"]:not([class*="mapboxgl-"]),
.selected:not([class*="mapboxgl-"]),
.on:not([class*="mapboxgl-"]){
  border-color: var(--border-active) !important;
  color: var(--active);
}

*[aria-selected="true"]:not([class*="mapboxgl-"]){
  border-color: var(--border-active) !important;
}

html,body{
  height: 100%;
}

*:not([class*="mapboxgl-"])::-webkit-scrollbar{
  width:var(--scrollbar-h);
  height:var(--scrollbar-h);
}
*:not([class*="mapboxgl-"])::-webkit-scrollbar-track{
  background:var(--scrollbar-track);
}
*:not([class*="mapboxgl-"])::-webkit-scrollbar-thumb{
  background:var(--scrollbar-thumb);
  border-radius:0;
}
*:not([class*="mapboxgl-"])::-webkit-scrollbar-thumb:hover{
  background:var(--scrollbar-thumb-hover);
}

  body{
    margin: 0;
    font: 13px system-ui, sans-serif;
    background: var(--background);
    color: var(--text);
    overflow: hidden;
    cursor: default;
    caret-color: transparent;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    user-select: text;
    touch-action: manipulation;
  }

  body, .post-board, .second-post-column, .panel-content, .options-menu, .calendar-scroll{overscroll-behavior: contain;}

  h1, h2, h3, h4, h5, h6{
    font-size: 16px;
    font-weight: bold;
  }

input,
textarea,
.wysiwyg{
  caret-color: auto;
  user-select: text;
}

button:not([class*="mapboxgl-ctrl"]),
[role="button"]{
  background: var(--btn);
  border: 1px solid var(--btn);
  color: var(--button-text);
  font-size: 13px;
  padding: 0 10px;
  height: var(--control-h);
  min-width: 35px;
  border-radius: 8px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  cursor: pointer;
  transition: background .2s,border-color .2s,color .2s,transform .05s;
}


button:hover,
[role="button"]:hover{
  background: var(--btn-hover);
  border-color: var(--btn-hover);
  color: var(--button-hover-text);
}

button:active,
[role="button"]:active{
  background: var(--btn-active);
  border-color: var(--btn-active);
  color: var(--button-active-text);
}

button[aria-pressed="true"],
[role="button"][aria-pressed="true"],
button[aria-current="page"],
[role="button"][aria-current="page"],
button[aria-selected="true"],
[role="button"][aria-selected="true"],
button.selected,
[role="button"].selected,
button.on,
[role="button"].on{
  background: var(--btn-selected);
  border-color: var(--btn-selected) !important;
  color: var(--button-active-text) !important;
}

button[aria-pressed="true"]:hover,
[role="button"][aria-pressed="true"]:hover,
button[aria-current="page"]:hover,
[role="button"][aria-current="page"]:hover,
button[aria-selected="true"]:hover,
[role="button"][aria-selected="true"]:hover,
button.selected:hover,
[role="button"].selected:hover,
button.on:hover,
[role="button"].on:hover{
  background: var(--btn-selected-hover);
  border-color: var(--btn-selected-hover) !important;
  color: var(--button-active-text) !important;
}

button[aria-pressed="true"]:active,
[role="button"][aria-pressed="true"]:active,
button[aria-current="page"]:active,
[role="button"][aria-current="page"]:active,
button[aria-selected="true"]:active,
[role="button"][aria-selected="true"]:active,
button.selected:active,
[role="button"].selected:active,
button.on:active,
[role="button"].on:active{
  background: var(--btn-selected-active);
  border-color: var(--btn-selected-active) !important;
  color: var(--button-active-text) !important;
}


a{
  color: var(--primary);
}

a:hover{
  color: var(--accent);
}

a:active{
  color: var(--active);
}
button:active,
[role="button"]:active{
  transform: scale(0.97);
}
button:focus-visible,
[role="button"]:focus-visible{
  outline:2px solid #ffffff;
  outline-offset:2px;
}

button:disabled,
[role="button"][aria-disabled="true"],
button.disabled,
[role="button"].disabled{
  background: var(--btn-disabled);
  border-color: var(--btn-disabled);
  color: var(--button-disabled-text);
  cursor: not-allowed;
  opacity: 0.6;
}

button:disabled:hover,
[role="button"][aria-disabled="true"]:hover,
button.disabled:hover,
[role="button"].disabled:hover{
  background: var(--btn-disabled);
  border-color: var(--btn-disabled);
  color: var(--button-disabled-text);
}

input::placeholder,
textarea::placeholder{
  color: var(--placeholder-text);
  font-size: inherit;
}
#filterPanel #keyword-textbox::placeholder{
  color: var(--filter-placeholder-text);
  font-size: inherit;
}
#filterPanel #daterange-textbox::placeholder{
  color: var(--filter-placeholder-text);
  font-size: inherit;
}

.field label{
  color: var(--panel-label-color);
  font-size: var(--panel-label-size);
}

.panel-content .title,
.panel-content .t{
  color: var(--panel-title-color);
  font-size: var(--panel-title-size);
}

select{
  background: var(--dropdown-bg);
  color: var(--dropdown-text);
  border-radius: var(--dropdown-radius);
}
.venue-select{
  color: var(--dropdown-venue-text);
}
select option{
  background: var(--dropdown-bg);
  color: var(--dropdown-text);
}
select option:checked{
  background: var(--dropdown-selected-bg);
  color: var(--dropdown-selected-text);
}
select option:hover{
  background: var(--dropdown-hover-bg);
  color: var(--dropdown-hover-text);
}

input[type="text"],
input[type="email"],
input[type="password"],
input[type="search"],
input[type="tel"],
input[type="url"],
textarea,
select{
  height: var(--control-h);
  border-radius: 8px;
}
input[type="checkbox"]{
  width: var(--control-h);
  height: var(--control-h);
  border-radius: 8px;
}

  .header{
    height: calc(var(--header-h) + var(--safe-top));
    min-height: calc(var(--header-h) + var(--safe-top));
    max-height: calc(var(--header-h) + var(--safe-top));
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding: var(--safe-top) 10px 0 10px;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 20;
    background: rgba(0,0,0,0.7);
  }

  .logo{
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 800;
    letter-spacing: .4px;
    user-select: none;
    cursor: pointer;
  }

.logo img{
  width: 40px;
  height: 40px;
  display: block;
}

  .view-toggle{
  position: absolute;
  left: 68px;
  right: auto;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  height: 40px;
  gap: 10px;
  }

.view-toggle button{
  border: 1px solid var(--btn);
  border-radius: 8px;
  padding: 0 14px;
  background: var(--btn);
  color: var(--button-text);
  font-weight: 600;
  cursor: pointer;
  transition: background .2s,border-color .2s,color .2s;
}

.view-toggle button[aria-pressed="true"]{
  background: var(--btn-selected);
  border-color: var(--btn-selected) !important;
  color: var(--button-active-text) !important;
}


.header-buttons{display:flex;gap:10px;}

.header-buttons button{width:40px;}


.header button,
.options-menu button{
  height:40px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  line-height:1;
}
.header button{
  border-radius:4px;
}
.options-menu button{
  border-radius:0;
}
.header .gear,
.header a{
  border-radius:4px;
}


.results-arrow,
.dropdown-arrow{
  display:inline-block;
  width:8px;
  height:8px;
  border-style:solid;
  border-width:0 2px 2px 0;
  border-color:currentColor !important;
  color:inherit;
  transition:transform .3s;
}

.options-dropdown > button{
  position:relative;
  padding-right:30px;
}
.results-arrow{
  transform:rotate(45deg);
  transition:transform .3s;
  vertical-align:middle;
}

.options-dropdown .dropdown-arrow,
.options-dropdown .results-arrow{
  position:absolute;
  top:50%;
  right:10px;
  transform:translateY(-50%) rotate(45deg);
  margin-right:0;
}

button[aria-expanded="true"] .dropdown-arrow,
button[aria-expanded="true"] .results-arrow{
  transform:translateY(-50%) rotate(-135deg);
}





/* Spin controls */
#adminPanel .range-wrap{
  display:flex;
  align-items:center;
  gap:8px;
}
#adminPanel .range-wrap input[type="range"]{
  width:300px;
}
#adminPanel .range-wrap span{
  width:40px;
  text-align:right;
}
#adminPanel #balloonSize{
  width:300px;
}
#adminPanel #balloonSizeValue{
  display:inline-block;
  width:40px;
  text-align:right;
  margin-left:8px;
}
  #spinType{
    display:flex;
    gap:6px;
    margin-top:6px;
  }
  #spinType label{
    flex:1;
    border-radius:8px;
    overflow:hidden;
  }
  #spinType input{
    display:none;
  }
  #spinType span{
    display:block;
    padding:0 10px;
    height:35px;
    line-height:35px;
    background:var(--btn);
    color:var(--button-text);
    font-weight:600;
    cursor:pointer;
    text-align:center;
    transition:background .2s,border-color .2s,color .2s;
    border:1px solid var(--btn);
    border-radius:8px;
  }


.gear{
  width: 36px;
  height: 36px;
  border-radius: 8px;
  background: rgba(255,255,255,0.2);
  display: grid;
  place-items: center;
  border:1px solid rgba(255,255,255,0.4);
  color: #fff;
}

.gear svg{
  width: 18px;
  height: 18px;
  opacity: .9;
}

.panel{
  position:fixed;
  top:0;
  left:0;
  right:0;
  width:100%;
  height:100vh;
  background:transparent;
  display:none;
  z-index:2000;
  pointer-events:none;
}
.panel.show{
  display:block;
}
.modal{
  position:fixed;
  top:0;
  left:0;
  right:0;
  width:100%;
  height:100vh;
  background:transparent;
  display:none;
  z-index:2000;
  pointer-events:none;
}
.modal.show{
  display:block;
}
.panel-content{
  position:absolute;
  left:50%;
  top:var(--header-h);
  bottom:var(--footer-h);
  width:440px;
  max-width:440px;
  height:calc(100vh - var(--header-h) - var(--footer-h));
  border-radius:0;
  display:flex;
  flex-direction:column;
  overflow:hidden;
  pointer-events:auto;
  transition:transform 0.3s;
}
.panel-content.panel-visible{
}
.panel-content .resizer{position:absolute;z-index:10;background:transparent;display:none;}
.panel-content .resizer.n{top:0;left:0;right:0;height:6px;cursor:n-resize;}
.panel-content .resizer.s{bottom:0;left:0;right:0;height:6px;cursor:s-resize;}
.panel-content .resizer.e{top:0;right:0;bottom:0;width:6px;cursor:e-resize;}
.panel-content .resizer.w{top:0;left:0;bottom:0;width:6px;cursor:w-resize;}
.panel-content .resizer.ne{top:0;right:0;width:10px;height:10px;cursor:ne-resize;}
.panel-content .resizer.nw{top:0;left:0;width:10px;height:10px;cursor:nw-resize;}
.panel-content .resizer.se{bottom:0;right:0;width:10px;height:10px;cursor:se-resize;}
.panel-content .resizer.sw{bottom:0;left:0;width:10px;height:10px;cursor:sw-resize;}
.panel-body{
  flex:1 1 auto;
  overflow-y:auto;
  overflow-y:overlay;
  overflow-x:hidden;
  padding:0 0 20px;
  overscroll-behavior:contain;
  display:flex;
  flex-direction:column;
  align-items:center;
}
.panel-body > *{
  width:420px !important;
  max-width:420px !important;
  box-sizing:border-box;
  padding:0 10px 10px;
}
.panel-body > *:last-child{
  padding-bottom:0;
}
.panel-body > * > *{
  width:420px !important;
  max-width:420px !important;
}
#adminPanel #styleControls{
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  gap:12px;
}
#adminPanel #styleControls > *{
  width:440px;
}
#adminPanel .admin-fieldset,
.admin-fieldset{
  margin:0;
  border:0;
  border-radius:8px;
  padding:0;
  width:440px;
  box-sizing:border-box;
}
#adminPanel .admin-fieldset.collapsed{
  padding:0;
}
  #adminPanel .panel-content,
  #memberPanel .panel-content{
    width:440px;
    max-width:440px;
    max-height:90%;
  }

  #adminPanel .panel-content{
    background:#222222;
    color:#fff;
  }

  #memberPanel .panel-content{
    background:#222222;
    color:#fff;
  }
#filterPanel .panel-content{
  width:440px;
  max-width:440px;
  background:#222222;
  color:#fff;
  display:flex;
  flex-direction:column;
  overflow-y:auto;
  overflow-y:overlay;
  padding-bottom:10px;
}

#filterPanel button:not([class*="mapboxgl-"]),
#filterPanel .sq,
#filterPanel .tiny{
  background:#333333;
  border: none;
}
#adminPanel button,
#memberPanel button{
  background:#333333;
  color: var(--ink);
  border: none;
}
#adminPanel button{
  height:35px;
  line-height:35px;
}
#adminPanel input[type="color"]{
  width:35px;
  height:35px;
}
#filterPanel input[type="text"]{
  background: var(--panel-bg);
  color: var(--panel-text);
}
#filterPanel .calendar-container{
  background: var(--dropdown-bg);
  position:relative;
  overflow-x:auto;
  overflow-y:hidden;
  padding-bottom:0;
  box-sizing:content-box;
  width:auto;
  height:var(--calendar-height);
  border:1px solid var(--border);
  border-radius:8px;
}
#filterPanel .calendar-container .today-marker{
  position:absolute;
  bottom:0;
  width:8px;
  height:8px;
  border-radius:50%;
  background:var(--today);
  cursor:pointer;
}
#filterPanel #datePicker{
  width:var(--calendar-width);
}
#filterPanel .calendar{
  display:flex;
  width:max-content;
  transform:scale(var(--calendar-scale));
  transform-origin:top left;
  background:var(--dropdown-bg);
  color:var(--dropdown-text);
}
.calendar .month{
  flex:0 0 auto;
  width:var(--calendar-width);
  height:var(--calendar-height);
}
.calendar .month:not(:first-child){
  border-left:1px solid var(--calendar-past-bg);
}
.calendar .grid{
  width:100%;
  height:calc(var(--calendar-height) - var(--calendar-header-h));
  display:grid;
  grid-template-columns:repeat(7,var(--calendar-cell-w));
  grid-template-rows:repeat(7,var(--calendar-cell-h));
}
.calendar .calendar-header{
  height:var(--calendar-header-h);
  line-height:var(--calendar-header-h);
  text-align:center;
  font-size:inherit;
  color:#fff;
  background:#2e3a72;
}
.calendar .weekday,
.calendar .day{
  width:var(--calendar-cell-w);
  height:var(--calendar-cell-h);
  line-height:var(--calendar-cell-h);
  text-align:center;
  font-size:inherit;
}
.calendar .weekday{font-weight:bold;}
.calendar .day{cursor:pointer;}
.calendar .day.empty{cursor:default;background:var(--calendar-future-bg);}
.calendar .day.past{background:var(--calendar-past-bg);color:#b3b3b3;}
.calendar .day.future{background:var(--calendar-future-bg);}
.calendar .day.today{color:var(--today) !important;font-weight:bold;}
.calendar .day.in-range{background:var(--session-available);border-radius:0;}
.calendar .day.selected{background:var(--session-selected);color:#fff;}
.calendar .day.selected.today{color:var(--today) !important;}
.calendar .day.range-start{border-radius:8px 0 0 8px;}
.calendar .day.range-end{border-radius:0 8px 8px 0;}
.calendar .day.range-start.range-end{border-radius:8px;}
#memberPanel input[type=color]{
  border-radius:8px;
  padding:0;
  height:40px;
  display:block;
}
#welcomeBody{
  display:flex;
  flex-direction:column;
  align-items:center;
  text-align:center;
}
#welcomeBody img{
  max-width:600px;
  width:100%;
  max-height:300px;
  height:auto;
  margin-bottom:10px;
}
#welcome-modal{background:transparent;}
#welcome-modal .modal-content{
  position:absolute;
  width:600px;
  max-width:600px;
  background:rgba(0,0,0,0.7);
  border-radius:0;
  display:flex;
  flex-direction:column;
  overflow:hidden;
  pointer-events:auto;
}
  @media (max-width:600px){
  #adminPanel .panel-content,
  #memberPanel .panel-content,
  #filterPanel .panel-content{
    width:440px;
    max-width:440px;
    max-height:95%;
  }
}
#adminPanel legend{font-weight:600;padding:0 6px;display:flex;align-items:center;gap:6px;justify-content:space-between;cursor:pointer;user-select:none;width:440px;height:35px;background:var(--btn);border:1px solid var(--btn);border-radius:var(--dropdown-radius);box-sizing:border-box;}
#adminPanel legend::after{content:'\25BC';margin-left:auto;font-size:14px;}
#adminPanel fieldset.collapsed legend::after{content:'\25B6';}
#adminPanel fieldset.collapsed > :not(legend){display:none;}
#adminPanel .fieldset-actions{display:flex;gap:4px;margin:4px 6px;}
#adminPanel .fieldset-actions .same-btn{flex:1 1 0;padding:6px;}
#adminPanel .control-row{display:flex;align-items:center;justify-content:space-between;gap:6px;margin-bottom:0;padding:10px 0;width:440px;}
#adminPanel .control-row label:first-child{min-width:80px;font-size:14px;cursor:pointer;user-select:none;}
.control-row > *:last-child{margin-left:auto;width:200px;}
#post-mode-background-field{
  width:400px;
}
#post-mode-background-row{
  display:flex;
  align-items:center;
  width:380px;
  gap:8px;
  height:40px;
}
#post-mode-background-row input[type="color"]{
  width:40px;
  height:40px;
  padding:0;
  border-radius:8px;
}
#post-mode-background-row input[type="range"]{
  flex:0 0 300px;
  width:300px;
}
#post-mode-background-row span{
  width:40px;
  text-align:right;
}

.map-theme-container,
.map-balloon-container,
.map-spin-container{
  background:#444444;
  width:420px;
  padding:10px;
  border-radius:4px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.map-theme-container .panel-field,
.map-balloon-container .panel-field,
.map-spin-container .panel-field{
  width:100%;
}

.settings-style-container,
.settings-welcome-container{
  background:#444444;
  width:420px;
  padding:10px;
  border-radius:4px;
}

.sub-icon svg{
  width:20px;
  height:20px;
  vertical-align:middle;
}
#adminPanel .color-group{
  flex:0 0 200px;
  width:100%;
  max-width:200px;
  display:flex;
  flex-direction:column;
  align-items:stretch;
  position:relative;
}
#autoTheme-row{
  flex-direction:row;
  align-items:center;
  gap:8px;
  margin-left:0;
  width:440px;
  max-width:440px;
}
#autoTheme-row button{
  flex:0 0 auto;
  height:35px;
  padding:0 8px;
  min-width:0;
}
#autoTheme-row input[type=color]{
  flex:0 0 35px;
  width:35px;
  height:35px;
  padding:0;
}
#adminPanel .shadow-group{
  flex:0 0 200px;
  width:100%;
  max-width:200px;
  display:flex;
  gap:4px;
  align-items:center;
}
#adminPanel .shadow-group input[type=color]{
  width:40px;
  height:40px;
  padding:0;
  border-radius:8px;
}
#adminPanel .shadow-group input[type=number]{
  flex:1 1 0;
}
#adminPanel .textpicker{
  flex:0 0 200px;
  width:200px;
  position:relative;
}
#adminPanel .textpicker .text-preview{
  width:100%;
  height:35px;
  border-radius:8px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}
#adminPanel .textpicker .text-popup{
  display:none;
  position:absolute;
  top:44px;
  left:0;
  z-index:20;
  background:#fff;
  border:1px solid #ccc;
  border-radius:8px;
  padding:8px;
  width:200px;
}
#adminPanel .textpicker.open .text-popup{display:block;}
#adminPanel .textpicker .text-popup select,
#adminPanel .textpicker .text-popup input[type=color]{
  width:100%;
  margin-top:4px;
  border-radius:var(--dropdown-radius);
  padding:4px;
  box-sizing:border-box;
  height:35px;
}
#adminPanel .textpicker .text-popup input[type=color]{padding:0;}
#adminPanel .textpicker .text-popup .shadow-group{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:4px;
  margin-top:4px;
}
#adminPanel .textpicker .text-popup .shadow-group input[type=color],
#adminPanel .textpicker .text-popup .shadow-group input[type=number]{
  width:100%;
  height:40px;
  border-radius:var(--dropdown-radius);
  padding:0;
  box-sizing:border-box;
}
  width:35px;
  height:35px;
  padding:0;
}
#adminPanel .admin-fieldset input,
#adminPanel .admin-fieldset select,
#adminPanel .admin-fieldset textarea{
  max-width:200px;
  box-sizing:border-box;
}
#adminPanel .control-row select{
  flex:0 0 200px;
  width:200px;
  max-width:200px;
  margin-left:auto;
  border-radius:var(--dropdown-radius);
  padding:4px;
}
#adminPanel .color-group input[type=color],
#adminPanel .color-group input[type=range]{
  width:100%;
}
#adminPanel .color-group input[type=color]{
  border-radius:8px;
  padding:0;
  height:35px;
  display:block;
  cursor:pointer;
  pointer-events:auto;
}
#adminPanel .range-group{
  display:flex;
  align-items:center;
  gap:4px;
}
#adminPanel .range-group input[type=range]{
  flex:1;
  width:auto;
}
#adminPanel .range-group span{
  min-width:32px;
  text-align:right;
  font-size:14px;
}
#adminPanel .tab-bar{display:flex;gap:6px;}
#adminPanel .tab-bar button{
  flex:1;
  padding:6px 10px;
  border-radius:8px;
  background:var(--btn);
  border:1px solid var(--btn);
  color:var(--button-text);
  cursor:pointer;
}
#adminPanel .tab-panel{display:none;}
#adminPanel .tab-panel.active{display:flex;flex-direction:column;align-items:flex-start;gap:12px;}
#adminPanel .marker-grid{display:flex;flex-direction:column;gap:8px;}
#adminPanel .marker-grid select{min-width:120px;}
#adminPanel .marker-options{display:flex;gap:8px;align-items:center;}
#adminPanel .marker-set{display:grid;grid-template-columns:repeat(10,max-content);gap:4px;}
#adminPanel .marker-set svg.outline *{stroke:#000;stroke-width:1;}
#adminPanel input[type=range]{width:100%;}
.panel-field{
  margin:8px 0;
  display:flex;
  flex-direction:column;
  gap:8px;
  width:440px;
}
#adminPanel .panel-field{margin:0;}
#adminPanel h3{margin:0;}
.admin-section{display:flex;flex-direction:column;gap:var(--gap);}
#tab-forms .panel-field{max-width:none;}
.history-group,
.color-group{display:flex;align-items:center;gap:8px;}
.option-label{
  display:flex;
  align-items:center;
  gap:8px;
}
.option-group{
  display:flex;
  gap:10px;
}
.wysiwyg{
  border:1px solid #ccc;
  min-height:80px;
  padding:8px;
}
.wysiwyg:empty:before{
  content:attr(data-placeholder);
  color:#999;
}
.wysiwyg-toolbar{
  display:flex;
  gap:4px;
}
.wysiwyg-toolbar button{
  padding:4px 6px;
}
.panel-field input,
.panel-field textarea,
.panel-field select{
  padding:8px;
  border-radius:var(--dropdown-radius);
  border:none;
  width:100%;
  max-width:100%;
}
.panel-actions{
  margin-top:10px;
  display:flex;
  gap:10px;
}
.panel-header{
  position:sticky;
  top:0;
  padding:10px 20px;
  border-top-left-radius:0;
  border-top-right-radius:0;
  z-index:1;
  cursor:move;
  display:flex;
  flex-direction:column;
  gap:10px;
  flex-shrink:0;
}
.panel-header .header-top{
  display:flex;
  align-items:center;
}
.panel-header .panel-actions{
  margin-top:0;
  justify-content:center;
}
.panel-header h2{
  margin:0;
}
.palette{
  display:flex;
  gap:10px;
  margin-bottom:10px;
}
.field-item,
.field-instance{
  padding:6px 10px;
  border:1px solid #ccc;
  border-radius:8px;
  background:#f9f9f9;
  cursor:move;
}
.builder-zone{
  min-height:100px;
  border:2px dashed #ccc;
  padding:10px;
}
.field-instance{margin:4px 0;}



.left-tools{
  display: flex;
  gap: 8px;
  margin-bottom: 8px;
  padding-left: 2px;
}

.sq{
  width: 30px;
  height: 30px;
  border-radius: 8px;
  background: var(--btn);
  display: grid;
  place-items: center;
  border: 1px solid var(--btn);
}

.sq svg{
  width: 14px;
  height: 14px;
  opacity: .9;
}


.field{
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 0;
  margin:0;
}

.field .input{
  position: relative;
  display:flex;
  align-items:center;
  gap:6px;
  flex:1;
}

.field .options-dropdown{
  flex:1;
}

.field .options-dropdown > button{
  width:100%;
}

.input input,
.input select{
  flex: 1;
  width: 100%;
  height: 35px;
  line-height: 35px;
  border: none;
  padding: 0 12px;
  outline: 0;
  display: flex;
  align-items: center;
}
.input input{
  border-radius: 8px;
  background: var(--btn);
  color: var(--ink);
}
.input select{
  border-radius: var(--dropdown-radius);
}
#filterPanel #keyword-textbox{
  background: var(--keyword-bg);
}
#filterPanel #daterange-textbox{
  background: var(--date-range-bg);
  color: var(--date-range-text);
}

.input .down{
  position: static;
  width: 35px;
  height: 35px;
  border-radius: 8px;
  background: var(--btn);
  cursor: pointer;
  border: 1px solid var(--btn);
  line-height:35px;
  text-align:center;
}
.input .down svg{
  vertical-align:middle;
}
#filterPanel .keyword-clear-button,
#filterPanel .daterange-clear-button{
  position: static;
  width: 35px;
  height: 35px;
  border-radius: 8px;
  background: var(--dropdown-bg);
  cursor: pointer;
  border: 0;
  margin-left: 6px;
  line-height: 35px;
  text-align: center;
  color: var(--dropdown-text);
  opacity:1;
}
#filterPanel .keyword-clear-button.active,
#filterPanel .daterange-clear-button.active{
  background: var(--filter-active-color);
  color: var(--button-text);
  opacity:1;
}

#filterPanel .field label.t{
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  gap: 6px;
}

.expired-row{
  grid-template-columns:1fr auto;
  align-items:center;
  gap:8px;
}
.expired-text{
  color:#fff;
  font-size:14px;
}
.filter-summary{
  margin-bottom:8px;
}

#filterPanel .reset-box,
#filterPanel .sort-field,
#filterPanel .map-control-row,
#filterPanel #filterSummary{
  width:400px;
  max-width:400px;
}
#filterPanel .reset-box #resetBtn{
  width:100%;
}
#filterPanel .sort-field .options-menu{
  width:400px;
}
#filterPanel .filter-basics-container,
#filterPanel .filter-category-container{
  width:420px;
  background:#444444;
  border-radius:4px;
  padding:10px;
}
#filterPanel .keyword-row,
#filterPanel .daterange-row,
#filterPanel .expired-row,
#filterPanel #datePickerContainer{
  width:400px;
}
#filterPanel .filter-category-container .cats,
#filterPanel .filter-category-container .cat{
  width:400px;
}
.switch{
  position:relative;
  display:inline-block;
  width:48px;
  height:24px;
  flex:0 0 48px;
}
.switch input{
  opacity:0;
  width:0;
  height:0;
}
.switch .slider{
  position:absolute;
  cursor:pointer;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background:var(--btn);
  border-radius:24px;
  transition:.2s;
}
.switch .slider:before{
  position:absolute;
  content:'';
  height:20px;
  width:20px;
  left:2px;
  top:2px;
  background:var(--button-text);
  border-radius:50%;
  transition:.2s;
}
.switch input:checked + .slider{
  background:var(--session-selected);
}
#expiredToggle:checked + .slider{
  background:var(--filter-active-color);
}
.switch input:checked + .slider:before{
  transform:translateX(24px);
}

.tiny{
  display: grid;
  place-items: center;
  width: 38px;
  height: 40px;
  border-radius: 8px;
  background: var(--btn);
  cursor: pointer;
  border: 1px solid var(--btn);
}

.tiny svg{
  width: 18px;
  height: 18px;
}


.cats{
  margin:8px 0;
}

.cat{
  display: grid;
  grid-template-columns: 1fr 38px;
  gap: 8px;
  align-items: center;
  margin: 8px 0;
}

.cat .bar{
  height: 36px;
  border-radius: 8px;
  padding-left: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--btn);
  border: 1px solid var(--btn);
  cursor: pointer;
}

.cat .bar .dot{
  width: 18px;
  height: 18px;
  border-radius: 50%;
  display: grid;
  place-items: center;
  background: var(--btn);
  border: 1px solid var(--btn);
}

.cat .bar .label{
  font-weight: 700;
  letter-spacing: .2px;
}

.cat .cfg{
  display: grid;
  place-items: center;
  width: 38px;
  height: 36px;
  border-radius: 8px;
  background: var(--btn);
  border: 1px solid var(--btn);
  cursor: pointer;
}

.sub{
  margin: 6px 0 0 6px;
  display: none;
  grid-template-columns: 1fr;
  gap: 6px;
}

.sub .chip{
  height: 28px;
  display: inline-block;
  padding: 0 10px;
  border-radius: 999px;
  background: var(--btn);
  border: 1px solid var(--btn);
  font-size: 14px;
  color: var(--ink-d);
  width: max-content;
  cursor: pointer;
  line-height: 28px;
}
.sub .chip .badge{
  display: inline-block;
  vertical-align: middle;
  margin-right: 8px;
}


.cat[aria-expanded="true"] .sub{
  display: grid;
}

.reset-box{
  margin:8px 0;
}

.reset-box .btn{
  width:100%;
  height: 36px;
  border-radius: 4px;
  background: var(--btn);
  border: 1px solid var(--btn);
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 0 14px;
  font-weight: 700;
  letter-spacing: .2px;
  color: var(--ink);
  cursor: pointer;
}
.reset-box .btn.active{
  background: var(--filter-active-color);
  border-color: var(--filter-active-color);
}

.reset-box .btn svg{
  width: 16px;
  height: 16px;
}

.reset-box .arr{
  display: grid;
  place-items: center;
  width: 38px;
  height: 36px;
  border-radius: 8px;
  background: var(--btn);
  border: 1px solid var(--btn);
}

.post-mode-background{
  position:absolute;
  top:var(--header-h);
  bottom:var(--footer-h);
  left:0;
  right:0;
  background: rgba(var(--post-mode-bg-color), var(--post-mode-bg-opacity));
  z-index:1;
  pointer-events:none;
  display:none;
}

.mode-posts .post-mode-background{
  display:block;
}

.post-mode-boards{
  position:absolute;
  top:var(--header-h);
  bottom:var(--footer-h);
  left:0;
  right:0;
  padding-left:0;
  padding-right:0;
  display:flex;
  justify-content:center;
  gap:var(--gap);
  z-index:2;
  pointer-events:none;
  transition:padding 0.3s ease;
}

body.hide-ads .post-mode-boards{padding-right:0;}

.quick-list-board{
  position:fixed;
  top:var(--header-h);
  bottom:var(--footer-h);
  left:0;
  width:440px;
  padding:10px;
  overflow:auto;
  overflow:overlay;
  background:rgba(0,0,0,0);
  pointer-events:auto;
  z-index:2;
  transform:translateX(0);
  transition:transform 0.3s ease;
}


  .post-board{
    width:880px;
  flex-shrink:0;
  padding:0;
  margin:0;
  overflow:auto;
  overflow:overlay;
  display:flex;
  flex-direction:column;
  gap:0;
  background:rgba(0,0,0,0);
  pointer-events:auto;
  transition:margin 0.3s ease;
}
.post-board.two-columns{overflow:auto;overflow:overlay;}
.post-board .post-card{
  width:100%;
}

.post-board .post-body{
  display:flex;
  padding-bottom:10px;
  gap:0;
}
  @media (max-width:879px){
    .post-board{width:440px;}
    .post-board .post-body{flex-direction:column;}
  }
  @media (max-width:439px){
    .post-board{width:100%;min-width:360px;}
  }

.main-post-column{
  flex:0 0 440px;
  width:440px;
  max-width:440px;
  padding:0;
  display:flex;
  flex-direction:column;
}

.post-images{
  margin-top:0;
  padding-top:10px;
  width:100%;
  display:flex;
  flex-direction:column;
}

@media (max-width:439px){
  .main-post-column{
    flex:0 0 auto;
    width:100%;
    max-width:none;
  }
  .thumbnail-row{
    width:100%;
  }
}

.post-board .post-header{
  position:sticky;
  top:0;
  z-index:1;
}

.post-board.two-columns .main-post-column{
  position:sticky;
  top:var(--post-header-h,0px);
  align-self:flex-start;
}

.thumbnail-row{
  display:flex;
  width:440px;
  padding-left:0;
  padding-right:10px;
  box-sizing:border-box;
  gap:5px;
}

.thumbnail-row img{
  width:40px;
  height:40px;
  object-fit:cover;
}

.post-images .selected-image{
  width:100%;
  height:auto;
  background:#000;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}

.post-images .selected-image img{
  max-width:100%;
  max-height:100%;
  width:auto;
  height:auto;
  display:block;
}

.second-post-column{
  flex:0 0 440px;
  width:440px;
  max-width:440px;
  min-width:440px;
  padding:0;
  display:flex;
  flex-direction:column;
  overflow-y:auto;
  overflow-y:overlay;
  height:calc(100vh - var(--header-h) - var(--subheader-h) - var(--footer-h) - var(--post-header-h,0px));
}

.post-venue-selection-container,
.post-session-selection-container{
  width:100%;
  height:250px; /* 200px map/calendar + 50px menu */
}

.post-details-title-container,
.post-details-member-container,
.post-details-info-container,
.post-details-description-container{
  width:100%;
}

.ad-board{
  position:fixed;
  top:var(--header-h);
  bottom:var(--footer-h);
  right:0;
  width:440px;
  padding:10px;
  background:rgba(0,0,0,0);
  pointer-events:auto;
  z-index:2;
  transform:translateX(0);
  transition:transform 0.3s ease;
}

body.hide-ads .ad-board{
  transform:translateX(100%);
  pointer-events:none;
}

.ad-panel{
  width:100%;
  height:100%;
  position:relative;
  overflow:hidden;
  border-radius:4px;
}

.ad-panel .ad-slide{
  position:absolute;
  inset:0;
  opacity:0;
  transition:opacity 1.5s ease-in-out;
  cursor:pointer;
}

.ad-panel .ad-slide.active{opacity:1;}

.ad-panel .ad-slide img{
  width:100%;
  height:100%;
  object-fit:cover;
  animation:adZoom 20s linear forwards;
}

.ad-panel .ad-slide .info{
  position:absolute;
  left:0;
  right:0;
  bottom:0;
  background:rgba(0,0,0,0.5);
  color:#fff;
  padding:10px;
  text-shadow:0 0 4px #000;
}

@keyframes adZoom{
  from{transform:scale(1);}
  to{transform:scale(1.1);}
}



#filterBtn,
#postBtn,
#memberBtn,
#adminBtn{
  gap:4px;
}
.header .view-toggle #filterBtn{
  height:40px;
}
.icon-search{
  display:inline-block;
  vertical-align:middle;
  color: currentColor;
  width:20px; height:20px;
}
body.filters-active #filterBtn{
  background: red;
  border-color: red;
  }

.options-dropdown{ position:relative; }
.options-menu{ position:absolute; top:calc(100% + 4px); left:0; background:var(--dropdown-bg); color:var(--dropdown-text); border:1px solid var(--border); border-radius:var(--dropdown-radius); padding:10px; display:flex; flex-direction:column; gap:6px;  z-index:30; }
.options-menu[hidden]{ display:none; }
.options-menu label{ display:flex; align-items:center; gap:6px; white-space:nowrap; }


.card,
.quick-card,
.post-card{
  display: grid;
  grid-template-columns:90px 1fr 36px;
  gap:12px;
  align-items: flex-start;
  background-color: transparent;
  border: none;
  border-radius:8px;
  padding:12px;
  margin-bottom:12px;
  cursor:pointer;
}

.post-card{
  border:none;
  border-radius:4px;
  padding-top:10px;
  margin-top:10px;
}

.thumb{
  width: 90px;
  height: 70px;
  border-radius: 8px;
  object-fit: cover;
  display: block;
  background: var(--panel-bg);
  transition: filter .22s ease;
}

.thumb.lqip{
  filter: none;
}

.meta{
  display: flex;
  flex-direction: column;
  gap: 6px;
  min-width: 0;
}

.title{
  margin: 0;
  font-weight: bold;
  font-size: 16px;
  line-height: 1.2;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

.info{
  display: flex;
  gap: 16px;
  align-items: center;
  min-width: 0;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

.quick-list-board .info{
  flex-direction: column;
  align-items: flex-start;
  gap: 4px;
  font-size: 13px;
}

.post-board .info{
  flex-direction: column;
  align-items: flex-start;
  gap: 4px;
  font-size: 13px;
}

.quick-list-board .info > div{
  display: flex;
  align-items: center;
  gap: 4px;
}

.post-board .info > div{
  display: flex;
  align-items: center;
  gap: 4px;
}

.badge{
  width: 18px;
  height: 18px;
  border-radius: 50%;
  display: inline-grid;
  place-items: center;
  border: 1px solid rgba(255,255,255,.1);
  font-size: 14px;
}

.fav{
  width: 36px;
  height: 36px;
  border-radius: 8px;
  display: grid;
  place-items: center;
  background: var(--btn);
  border: 1px solid var(--btn);
}

.fav svg{
  width: 18px;
  height: 18px;
  fill: none;
  stroke: var(--gold);
  stroke-width: 1.5;
}

.fav[aria-pressed="true"] svg{
  fill: var(--gold);
  stroke: var(--gold);
}

.share{
  width: 36px;
  height: 36px;
  border-radius: 8px;
  display: grid;
  place-items: center;
  background: var(--btn);
  border: 1px solid var(--btn);
  margin-left: auto;
}

.share svg{
  width: 18px;
  height: 18px;
  fill: var(--button-text);
}

#favToggle{
  white-space:nowrap;
}
#favToggle svg{
  width:18px;
  height:18px;
  fill:none;
  stroke:var(--gold);
  stroke-width:1.5;
  vertical-align:middle;
  margin-left:6px;
}
#favToggle[aria-pressed="true"] svg{
  fill:var(--gold);
  stroke:var(--gold);
}



#map{
  position: absolute;
  inset: 0;
}

.map-overlay{
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
  display: grid;
  place-items: center;
  color: #fff;
  font-weight: 700;
  letter-spacing: .5px;
  opacity: .15;
  pointer-events: none;
}

.map-control-row{
  display:flex;
  align-items:center;
  gap:var(--gap);
}

.mode-posts .map-controls-map{display:none;}

.map-controls-map{
  position:absolute;
  left:50%;
  top:calc(var(--header-h) + 10px);
  transform:translateX(-50%);
  width:auto;
  z-index:1;
}

.map-control-row .geocoder{flex:1 1 auto;margin:0;}

.mapboxgl-ctrl-geolocate,
.mapboxgl-ctrl-compass{
  width:var(--control-h);
  height:var(--control-h);
}
.geolocate-btn .mapboxgl-ctrl-group,
.compass-btn .mapboxgl-ctrl-group{
  width:var(--control-h);
  height:var(--control-h);
}




.post-board .posts{overflow:auto;overflow:overlay;padding:0;margin:0;}
.post-board{color:#fff;}
.post-board .post-card,
.post-board .open-post{
  background-color:transparent;
  margin:10px 0 12px;
  border:none;
  border-radius:4px;
}
.post-board .post-card:last-child,
.post-board .open-post:last-child{border-bottom:none;}
.post-board .post-card .thumb{border-radius:0;}
.post-board button{background:var(--btn);border-color:var(--btn);color:var(--ink);}


.mode-posts .post-board{
  display: block;
  z-index: 1;
  pointer-events: auto;
}

.mode-map .post-board{
  display: none;
}
.map-area{
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 0;
}

.open-post{
  border:none;
  border-radius:4px;
  margin:10px 0 12px;
  padding-top:10px;
  overflow:visible;
  color:#fff;
  font-size:14px;
  display:flex;
  flex-direction:column;
  gap:0;
}

.open-post .post-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:6px 12px;
  opacity:1;
  border-top-left-radius:inherit;
  border-top-right-radius:inherit;
  position:sticky;
  top:0;
  z-index:3;
  background-color:transparent;
}
.post-card .post-header{
  background-color:transparent;
}
.open-post .post-header .share{margin-left:auto;margin-right:var(--gap);}

.open-post .post-body{
  padding:0 0 10px;
  display:flex;
  flex-wrap:wrap;
  gap:0;
  align-items:stretch;
  align-content:flex-start;
}

.open-post .post-details{
  margin-top:0;
  flex:1 1 400px;
  min-width:400px;
  display:flex;
  flex-direction:column;
  gap:var(--gap);
  padding:10px;
}

.open-post .post-details .info{
  color: inherit;
  font-size: inherit;
}

.open-post .post-images{
  display:flex;
  flex-direction:column;
  gap:var(--gap);
  width:100%;
  flex:0 0 100%;
}

.open-post-sticky-images .open-post .post-images{
  position:sticky;
  top:var(--open-post-header-h,0px);
  align-self:start;
}

.open-post .image-box{
  width:100%;
  height:auto;
  aspect-ratio:1/1;
  overflow:hidden;
  border:none;
  border-radius:0;
  flex-shrink:0;
  cursor:pointer;
  background: rgba(0,0,0,0);
}

.open-post .image-box img{
  width:100%;
  height:100%;
  object-fit:cover;
  object-position:center;
  display:block;
}
.open-post .image-box img.ready{
  object-fit:cover;
}

.open-post .thumbnail-row{
  display:flex;
  flex-direction:row;
  width:440px;
  padding:0 10px;
  box-sizing:border-box;
  height:auto;
  overflow-x:auto;
  gap:4px;
  position:relative;
}

.open-post .thumbnail-row img{
  width:50px;
  height:50px;
  object-fit:cover;
  object-position:center;
  aspect-ratio:1/1;
  border:1px solid var(--border);
  border-radius:8px;
  cursor:pointer;
  position:relative;
  z-index:1;
}

@media (max-width: 450px){
  .post-board .posts{padding:0;}
  .post-board .post-card{
    grid-template-columns:1fr;
    gap:0;
    padding:0;
    margin:10px 0 12px;
    border-radius:4px;
  }
  .post-board .post-card .thumb{
    width:100%;
    height:100vw;
    border-radius:0;
  }
  .post-board .post-card .meta{padding:12px;}
  .open-post{
    margin:10px 0 12px;
  }
  .open-post .post-body{
    padding:0;
  }
  .open-post .post-header{
    padding:6px 0;
  }
  .open-post .post-images,
  .open-post .venue-dropdown,
  .open-post .session-dropdown,
  .open-post .post-details{
    margin-bottom:6px;
  }
  .open-post .post-details{
    margin-bottom:0;
  }
  .open-post .post-images{
    flex:1 1 100%;
    width:100%;
  }
  .open-post .image-box{
    width:100%;
    height:100vw;
    margin:0;
    border-radius:0;
  }
  .open-post .image-box img{
    object-fit:cover;
    object-position:center;
  }
  .open-post .thumbnail-row{
    width:auto;
    padding:0;
  }
  .open-post .venue-dropdown,
  .open-post .session-dropdown{
    width:400px;
    padding:0;
  }
  .open-post .location-section .map-container,
  .open-post .venue-dropdown,
  .open-post .session-dropdown{
    min-width:250px;
    width:400px;
  }
}

.open-post .post-header .title{
  margin:0;
  font-size:16px;
  font-weight:bold;
  line-height:1.2;
  color:#fff;
}

.open-post .post-header .title-block{
  display:flex;
  flex-direction:column;
}

.open-post .post-header .cat-line{
  font-size:14px;
  margin-top:4px;
  display:flex;
  align-items:center;
  gap:4px;
}

.open-post .meta{
  font-size:14px;
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}

.open-post .member-avatar-row{
  display:flex;
  align-items:center;
  height:50px;
  gap:10px;
  margin:var(--gap) 0;
}
.open-post .member-avatar-row img{
  width:50px;
  height:50px;
  object-fit:cover;
}


.open-post .location-section{
  display:flex;
  flex-wrap:wrap;
  gap:var(--gap);
  margin-top:0;
  margin-bottom:6px;
}

.open-post .location-section .map-container{
  display:flex;
  flex-direction:column;
  gap:var(--gap);
  flex:1 1 250px;
  min-width:250px;
  width:auto;
  height:auto;
}
.open-post .map-container .venue-dropdown{
  width:100%;
}

.open-post .post-map{
  flex:0 0 200px;
  width:100%;
  height:200px;
  border:1px solid var(--border);
  border-radius:8px;
  min-width:250px;
}


.open-post .venue-dropdown,
.open-post .session-dropdown{
  position:relative;
  min-width:250px;
  width:400px;
}

.open-post .calendar-container .session-dropdown{
  margin-top:0;
  width:100%;
}



.open-post .venue-dropdown > button{
  height:50px;
  background:var(--btn);
  border:1px solid var(--btn);
  border-radius:var(--dropdown-radius);
  text-align:left;
  padding:2px 8px;
  color:var(--button-text);
  display:inline-flex;
  flex-direction:column;
  align-items:flex-start;
  justify-content:center;
  width:100%;
}

.open-post .session-dropdown > button{
  height:50px;
  background:var(--btn);
  border:1px solid var(--btn);
  border-radius:var(--dropdown-radius);
  text-align:left;
  padding:2px 8px;
  color:var(--button-text);
  display:inline-flex;
  align-items:center;
  justify-content:flex-start;
  width:100%;
}


.open-post .venue-dropdown > button .venue-name{
  font-weight:bold;
  display:block;
}

.open-post .venue-dropdown > button .venue-address{
  display:block;
}

.open-post .venue-menu button .venue-name{
  font-weight:bold;
  display:block;
}

.open-post .venue-menu button .venue-address{
  display:block;
}

.open-post .venue-dropdown > button .venue-name,
.open-post .venue-dropdown > button .venue-address,
.open-post .venue-menu button .venue-name,
.open-post .venue-menu button .venue-address{
  line-height:1.2;
}

.open-post .venue-menu,
.open-post .session-menu{
  position:absolute;
  top:calc(100% + 4px);
  left:0;
  width:100%;
  min-width:250px;
  box-sizing:border-box;
  max-height:250px;
  overflow-y:auto;
  overflow-y:overlay;
  background:var(--dropdown-bg);
  border:1px solid var(--border);
  border-radius:var(--dropdown-radius);
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:6px;
   z-index:30;
}

.open-post .venue-menu[hidden],
.open-post .session-menu[hidden]{display:none;}

.open-post .venue-menu button{
  height:50px;
  background:var(--btn);
  border:1px solid var(--btn);
  border-radius:var(--dropdown-radius);
  text-align:left;
  padding:4px 8px;
  color:var(--button-text);
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  justify-content:center;
  width:100%;
}

.open-post .session-menu button{
  height:50px;
  background:var(--btn);
  border:1px solid var(--btn);
  border-radius:var(--dropdown-radius);
  text-align:left;
  padding:4px 8px;
  color:var(--button-text);
  display:flex;
  align-items:center;
  justify-content:flex-start;
}


.open-post .venue-menu button.selected,
.open-post .session-menu button.selected{
  background:var(--dropdown-selected-bg);
  color:var(--dropdown-selected-text);
}

.open-post .session-menu button .session-time{
  margin-left:auto;
  padding-right:20px;
}
.open-post .session-dropdown > button .session-time{
  margin-left:auto;
  padding-right:20px;
}


.open-post .location-section .calendar-container{
    display:flex;
    flex-direction:column;
    gap:var(--gap);
    position:relative;
    align-items:flex-start;
    flex:1 1 auto;
    width:100%;
    height:auto;
  }
.open-post .location-section .options-menu{
  width:100%;
  box-sizing:border-box;
}

.hide-map-calendar .open-post .map-container,
.hide-map-calendar .open-post .calendar-container{
  display:none;
}

.open-post .post-calendar{
  width:var(--calendar-width);
  position:relative;
  font-size:14px;
}


.open-post .calendar-container .calendar-scroll{
  width:100%;
  overflow-x:auto;
  overflow-y:hidden;
  padding-bottom:0;
  box-sizing:content-box;
  background:var(--dropdown-bg);
  border:1px solid var(--border);
  border-radius:8px;
  flex:1 1 auto;
}
.open-post .post-calendar .calendar{
  margin:0;
  box-sizing:border-box;
  display:flex;
  width:max-content;
  transform:scale(var(--calendar-scale));
  transform-origin:top left;
  background:var(--dropdown-bg);
  color:var(--dropdown-text);
}
.open-post .post-calendar .month{
  flex:0 0 auto;
  width:var(--calendar-width);
  display:flex;
  flex-direction:column;
}
.open-post .post-calendar .grid{
  flex:1 1 auto;
  width:100%;
  height:calc(var(--calendar-height) - var(--calendar-header-h));
  display:grid;
  grid-template-columns:repeat(7,var(--calendar-cell-w));
  grid-template-rows:repeat(7,var(--calendar-cell-h));
}
.open-post .post-calendar .calendar-header{
  height:var(--calendar-header-h);
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  font-weight:bold;
  background:#2e3a72;
  color:#fff;
}
.open-post .post-calendar .weekday,
.open-post .post-calendar .day{
  width:var(--calendar-cell-w);
  height:var(--calendar-cell-h);
  display:flex;
  align-items:center;
  justify-content:center;
}
.open-post .post-calendar .weekday{
  font-size:10px;
  color:#555555;
}
.open-post .post-calendar .day{
  cursor:pointer;
  font-size:12px;
  border-radius:8px;
}
.open-post .post-calendar .day.available-day{
  background:var(--session-available);
  color:#fff;
}
.open-post .post-calendar .day.available-day.selected{
  background:#2e3a72;
  color:#fff;
}
.open-post .post-calendar .day.today{color:var(--today) !important;}
.open-post .post-calendar .day.available-day.today,
.open-post .post-calendar .day.available-day.selected.today,
.open-post .post-calendar .day.selected.today{color:var(--today) !important;}


.open-post .post-calendar .selected-month-name{
  background:var(--accent);
  color:var(--button-hover-text);
  border-radius:8px;
  padding:0 4px;
}

.open-post .calendar-container .time-popup{
  position:absolute;
  z-index:10;
}

.open-post .calendar-container .time-popup .time-list{
  background:var(--dropdown-bg);
  color:var(--dropdown-text);
  padding:8px;
  border-radius:8px;
  display:flex;
  flex-direction:column;
  gap:4px;
   }

.open-post .calendar-container .time-popup .time-list button{
  background:var(--btn);
  border:1px solid var(--btn);
  color:var(--button-text);
  border-radius:8px;
  padding:6px 10px;
  cursor:pointer;
}

.open-post .venue-info,
.open-post .session-info{
  color: inherit;
  font-size: inherit;
}
.open-post .venue-info{margin-top:4px;}
.open-post .session-info{margin-top:8px;}



.img-popup{
  position:fixed;
  inset:0;
  background:var(--image-panel-bg);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:4000;
  pointer-events:auto;
}
.img-popup img{
  max-width:90vw;
  max-height:90vh;
  cursor:pointer;
  pointer-events:auto;
}

.pill{
  border: 1px solid var(--btn);
  background: var(--btn);
  border-radius: 999px;
  padding: 8px 12px;
  font-weight: 700;
  cursor: pointer;
}

.close{
  border: 0;
  background: #16283f;
  border-radius: 8px;
  padding: 8px 12px;
  cursor: pointer;
}

.dates{
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 4px;
}

.date{
  background: var(--btn);
  border: 1px solid var(--btn);
  border-radius: 999px;
  padding: 6px 10px;
  font-size: 14px;
}

.desc{
  margin-top:8px;
  display:-webkit-box;
  -webkit-line-clamp:4;
  -webkit-box-orient:vertical;
  overflow:hidden;
  cursor:default;
}
.desc.expanded{
  display:block;
  -webkit-line-clamp:unset;
  overflow:visible;
}


@media (max-width:650px){
}


@media (max-width:650px){
  html{
    touch-action:pan-x pan-y;
  }
  .map-container{
    touch-action:auto;
  }
  .img-popup img{
    touch-action:pinch-zoom;
  }
}

@media (max-width:840px){
  .open-post .post-body{
    flex-direction:column;
  }
  .open-post .post-details .location-section{
    order:-1;
  }
  .open-post .image-box{
    max-width:100%;
    width:100%;
  }
  .open-post .post-calendar{
    display:none;
  }
  .open-post .venue-dropdown,
  .open-post .session-dropdown{
    display:block;
  }
}

  @media (max-width:450px){
    .post-board,
    .post-board .post-card,
    .open-post{
      width:100%;
      max-width:100%;
      border:none;
      border-radius:4px;
    }
    .open-post .image-box{
      width:100%;
      max-width:100%;
      border:none;
      border-radius:8px;
    }
    .open-post .image-box{
      height:auto;
      max-height:100vw;
      margin-left:0;
      margin-right:0;
      padding-left:0;
      padding-right:0;
    }
    .open-post .image-box img{
      width:100%;
      height:100%;
      object-fit:cover;
      margin-left:0;
      margin-right:0;
    }
    .open-post .post-body{
      padding:0;
      gap:0;
    }
    .open-post .post-details{
      padding:10px;
    }
  }

@media (max-width:450px){
  .open-post .venue-dropdown > button,
  .open-post .session-dropdown > button{
    height:50px;
  }
}

  .fullscreen-btn{
    width:35px;
    height:35px;
    padding:0;
    flex:0 0 auto;
  }

  .copy-msg{ 
    position:absolute;
    background:rgba(0,0,0,0.8);
    color:#fff;
    padding:4px 8px;
    border-radius:4px;
    opacity:0;
    transition:opacity .3s;
    pointer-events:none;
  }
  .copy-msg.show{opacity:1;}

  .image-modal-container{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.7);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:3000;
  }
  .image-modal-container.hidden{display:none;}
  .image-modal-container .image-modal img{
    max-width:90vw;
    max-height:90vh;
    display:block;
  }

  #post-modal-container{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.7);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:3000;
  }
  #post-modal-container.hidden{display:none;}
    #post-modal-container .post-modal{
      width:880px;
    max-width:100%;
    height:90%;
    overflow:auto;
    overflow:overlay;
    background:var(--list-background);
    border-radius:8px;
  }
    @media (max-width:879px){
      #post-modal-container .post-modal{width:440px;}
    }
    @media (max-width:439px){
      #post-modal-container .post-modal{width:100%;min-width:360px;}
    }


  .chip-small{
  flex: 0 0 auto;
  max-width: 240px;
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--btn);
  border-radius: 8px;
  padding: 6px 10px;
  font-size: 14px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  cursor: pointer;
}


.chip-small img.mini{
  width: 26px;
  height: 20px;
  border-radius: 8px;
  object-fit: cover;
  flex: 0 0 auto;
  display: block;
  background: var(--btn);
}

.chip-small .t{
  overflow: hidden;
  text-overflow: ellipsis;
}


.card .thumb,
.quick-card .thumb,
.post-card .thumb{
  flex: 0 0 90px;
  width: 90px;
  height: 70px;
  display: block;
  object-fit: cover;
  border-radius: 8px;
}

.post-board .post-card .thumb{
  flex-basis: 80px;
  width: 80px;
  height: 80px;
  padding:0;
}

.card .meta,
.quick-card .meta,
.post-card .meta{
  flex: 1 1 auto;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.post-card .meta, .post-card .meta *,
.quick-card .meta, .quick-card .meta *{
  cursor: default;
}

.card .fav,
.quick-card .fav,
.post-card .fav{
  flex: 0 0 auto;
}

.quick-card[aria-selected="true"]{
  position:relative;
  z-index:0;
  background:none;
}

.quick-card[aria-selected="true"]::before{
  content:"";
  position:absolute;
  inset:0;
  background-color:#2e3a72;
  border-radius:8px;
  z-index:-1;
}

.hover-card{
  display: flex;
  gap: 10px;
  align-items: flex-start;
  max-width: 400px;
}

.hover-card img{
  width: 64px;
  height: 64px;
  object-fit: cover;
  border-radius: 8px;
  flex: 0 0 auto;
  display: block;
  background: var(--panel-bg);
}

.hover-card .t{
  font-weight: bold;
  font-size: 16px;
  line-height: 1.25;
  white-space: normal;
  word-break: break-word;
  overflow-wrap: anywhere;
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 3;
  overflow: hidden;
}

.hover-card .s{
  font-size: 14px;
  opacity: .8;
  margin-top: 2px;
  white-space: normal;
  word-break: break-word;
  overflow-wrap: anywhere;
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 1;
  overflow: hidden;
}


.multi-hover h4{
  margin: 0 0 8px 0;
  font-size: 16px;
  color: var(--ink-d);
  font-weight: bold;
  letter-spacing: .3px;
}

.multi-list{
  max-height: 360px;
  overflow-y: auto;
  overflow-y: overlay;
  overflow-x: hidden;
  padding: 2px 6px 2px 2px;
  box-sizing: border-box;
}

.multi-item.map-card{
  display: flex;
  gap: 8px;
  align-items: center;
  padding: 4px 6px;
  border-radius: 8px;
  cursor: pointer;
  min-width: 0;
}


.multi-item.map-card img{
  width: 64px;
  height: 44px;
  border-radius: 8px;
  object-fit: cover;
  display: block;
  background: var(--panel-bg);
  flex: 0 0 auto;
}

.multi-item.map-card .t{
  white-space: normal;
  overflow-wrap: anywhere;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  display: -webkit-box;
}

.multi-item.map-card .s{
  font-size: 14px;
  opacity: .8;
  margin-top: 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.multi-ctrls{
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  margin-top: 8px;
}

.multi-ctrls .hint{
  font-size: 14px;
  color: var(--ink-d);
}

.multi-ctrls .close{
  border: 0;
  background: #16283f;
  color: #fff;
  border-radius: 8px;
  padding: 6px 10px;
  cursor: pointer;
}

.multi-item.map-card > div{
  min-width: 0;
}

.multi-item.map-card .hover-card{
  width: 100%;
}

.hover-card > div{
  min-width: 0;
  flex: 1;
}

.multi-item.map-card .hover-card .t{
  max-width: none;
  white-space: nowrap;
  text-overflow: ellipsis;
  overflow: hidden;
}

.nowrap{
  white-space: nowrap;
}

.multi-hover .soonest{
  color: var(--ink-d);
  font-weight: 600;
}

.hero img.lqip{
  filter: blur(10px);
  transform: scale(1.02);
  transition: filter .22s ease, transform .22s ease;
}

.hero img.ready{
  filter: none;
  transform: none;
}

.hover-card img{
  width: 64px;
  height: 64px;
  object-fit: cover;
  border-radius: 8px;
  flex: 0 0 auto;
  display: block;
  background: var(--panel-bg);
}

img.thumb{
  width: 80px;
  height: 80px;
  object-fit: cover;
}

#results .quick-card > img, #results .quick-card img.thumb{
  width: 80px;
  height: 80px;
  aspect-ratio: 1/1;
  object-fit: cover;
  display: block;
}







.mode-posts #postsWide{
  border: none;
  background: transparent;
}

.mode-posts #postsWide.posts{
  background: transparent;
}



@media (max-width:649px){
  #filterPanel .panel-content{
    top:calc(var(--header-h) + var(--safe-top));
    left:0;
    right:0;
    bottom:var(--footer-h);
    width:100%;
    max-width:none;
    max-height:none;
    border-radius:0;
    padding-bottom:10px;
  }
  #filterPanel .panel-content .resizer,
  #filterPanel .panel-actions .move-left,
  #filterPanel .panel-actions .move-right{
    display:none;
  }
}

@media (max-width:449px){
  .post-board .posts{
    padding:0;
    margin:0;
  }
  .post-board .post-card{
    width:100%;
    margin:10px 0 12px;
    border-radius:4px;
  }
  .post-board .open-post{
    margin:10px 0 12px;
  }
  .open-post{
    width:100%;
    border-radius:4px;
    margin:10px 0 12px;
  }
  .open-post .post-images{
    flex:0 0 100%;
    width:100%;
  }
  .open-post .image-box{
    width:100%;
    height:auto;
    flex:0 0 100%;
    border-radius:8px;
  }
  .open-post .image-box img{
    width:100%;
    height:100%;
    object-fit:cover;
  }
}

@media (max-width:450px){
  :root{
    --footer-h:0;
  }
  body.mode-map{
    --footer-h:0;
  }
  #filterPanel .panel-content{
    top:calc(var(--header-h) + var(--safe-top));
    left:0;
    right:0;
    transform:none;
  }
  .open-post .post-header{
    padding-bottom:0;
  }
  .open-post .post-body{
    padding:0;
  }
}

</style>
</head>
<body class="mode-map" style="padding-bottom:var(--footer-h);">
  <header class="header" role="banner">
    <div class="logo" aria-label="Site logo">
      <img src="assets/funmap-logo-small.png" alt="FunMap.com logo" />
    </div>
    <nav class="view-toggle" aria-label="Primary" role="tablist">
      <!-- <button id="quickBtn" aria-pressed="false" aria-label="Toggle results list">Quick List</button> -->
      <button id="historyBtn" aria-pressed="false">History</button>
      <button id="filterBtn" aria-pressed="false" aria-label="Open filters panel">
        <svg class="icon-search" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <span id="resultCount" aria-live="polite" style="display:none"></span>
      </button>
      <button id="postBtn" aria-pressed="false">Show Posts</button>
    </nav>
    <div class="header-buttons">
      <button id="memberBtn" aria-pressed="false" aria-label="Open members area">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 18.75a6 6 0 00-7.5 0"/>
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 15a3 3 0 100-6 3 3 0 000 6z"/>
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 3.75a8.25 8.25 0 100 16.5 8.25 8.25 0 000-16.5z"/>
        </svg>
      </button>
      <button id="adminBtn" aria-pressed="false" aria-label="Open admin area">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <circle cx="12" cy="12" r="3"/>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82 2 2 0 1 1-2.83 2.83 1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51 2 2 0 1 1-4 0 1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33 2 2 0 1 1-2.83-2.83 1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1A2 2 0 1 1 4 9a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82A2 2 0 1 1 8.01 3.35a1.65 1.65 0 0 0 1.82-.33 1.65 1.65 0 0 0 1-1.51A2 2 0 1 1 14 3a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33A2 2 0 1 1 19.65 8a1.65 1.65 0 0 0-.33 1.82 1.65 1.65 0 0 0 1.51 1A2 2 0 1 1 21 15a1.65 1.65 0 0 0-1.51 1z"/>
        </svg>
      </button>
      <button id="fullscreenBtn" type="button" class="fullscreen-btn" aria-label="Toggle fullscreen"></button>
    </div>
  </header>
  

  <section class="map-area" aria-label="Map">
    <div class="map-control-row map-controls-map">
      <div id="geocoder-map" class="geocoder"></div>
      <div id="geolocate-map" class="geolocate-btn"></div>
      <div id="compass-map" class="compass-btn"></div>
    </div>
    <div id="map"></div>
  </section>

  <div class="post-mode-background"></div>
  <div class="post-mode-boards">
    <!-- <section class="quick-list-board" id="results" aria-label="Quick List Board"></section> -->
    <section class="history-board quick-list-board" id="historyBoard" aria-label="History Board"></section>
    <section class="post-board" aria-label="Post Board">
      <div class="post-header"></div>
      <div class="post-body">
        <div class="main-post-column">
          <div class="post-images">
            <div class="selected-image"></div>
            <div class="thumbnail-row"></div>
          </div>
        </div>
        <div class="second-post-column">
          <div class="post-details">
            <div class="post-venue-selection-container"></div>
            <div class="post-session-selection-container"></div>
            <div class="post-details-title-container"></div>
            <div class="post-details-member-container"></div>
            <div class="post-details-info-container"></div>
            <div class="post-details-description-container"></div>
          </div>
        </div>
      </div>
    </section>
    <section class="ad-board" aria-label="Ad Board">
      <div class="ad-panel">
      </div>
    </section>
  </div>


  <div id="filterPanel" class="panel" role="dialog" aria-panel="true" aria-hidden="true">
    <div class="panel-content" style="top:calc(var(--header-h) + var(--safe-top));left:0;transform:none;">
      <div class="panel-header">
        <div class="header-top">
          <h2>Filters</h2>
          <div class="panel-actions">
            <button type="button" class="move-left" aria-label="Move panel left">&lt;</button>
            <button type="button" class="move-right" aria-label="Move panel right">&gt;</button>
            <button type="button" class="pin-panel" aria-pressed="true" aria-label="Pin filter panel"></button>
            <button type="button" class="close-panel">Close</button>
          </div>
        </div>
      </div>
      <div class="panel-body">
        <div class="reset-box">
          <div id="resetBtn" class="btn" role="button" aria-label="Reset all filters">
            Reset All Filters
          </div>
        </div>
        <div class="field sort-field">
          <div class="options-dropdown">
            <button id="optionsBtn" aria-haspopup="true" aria-expanded="false">Title A - Z</button>
            <div id="optionsMenu" class="options-menu" hidden>
              <button id="favToggle" aria-pressed="false">Favourites on top<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 17.3 6.2 21l1.6-6.7L2 9.3l6.9-.6L12 2l3.1 6.7 6.9.6-5.8 4.9L17.8 21 12 17.3z"/></svg></button>
              <div class="sort-options" role="group" aria-label="Sort order" style="display:flex; flex-direction:column; gap:6px;">
                <button class="sort-option" data-sort="az" aria-pressed="true">Title A - Z</button>
                <button class="sort-option" data-sort="nearest" aria-pressed="false">Closest</button>
                <button class="sort-option" data-sort="soon" aria-pressed="false">Soonest</button>
              </div>
            </div>
          </div>
        </div>
        <div class="map-control-row map-controls-filter">
          <div id="geocoder-filter" class="geocoder"></div>
          <div id="geolocate-filter" class="geolocate-btn"></div>
          <div id="compass-filter" class="compass-btn"></div>
        </div>
        <section aria-label="Filters">
          <div id="filterSummary" class="filter-summary"></div>
          <div class="filter-basics-container">
            <div class="field keyword-row">
              <div class="input"><input id="keyword-textbox" type="text" placeholder="Keywords" aria-label="Keywords" />
                <div class="keyword-clear-button" role="button" aria-label="Clear keywords">X</div>
              </div>
            </div>
            <div class="field daterange-row">
              <div class="input"><input id="daterange-textbox" type="text" aria-label="Date range" placeholder="Date Range" readonly />
                <div class="daterange-clear-button" role="button" aria-label="Clear date">X</div>
              </div>
            </div>
            <div class="field expired-row">
              <span class="expired-text">Show Expired Events</span>
              <label class="switch">
                <input id="expiredToggle" type="checkbox" />
                <span class="slider"></span>
              </label>
            </div>
            <div id="datePickerContainer" class="calendar-container">
              <div id="datePicker"></div>
            </div>
          </div>
          <div class="filter-category-container">
            <div class="cats" id="cats" aria-label="Categories"></div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <div id="memberPanel" class="panel" role="dialog" aria-panel="true" aria-hidden="true">
    <div class="panel-content" style="right:0;transform:none;">
      <div class="panel-header">
        <div class="header-top">
          <h2>Create Post</h2>
          <div class="panel-actions">
            <button type="submit" form="memberForm">Save</button>
            <button type="button" class="move-left" aria-label="Move panel left">&lt;</button>
            <button type="button" class="move-right" aria-label="Move panel right">&gt;</button>
            <button type="button" class="close-panel">Close</button>
          </div>
        </div>
      </div>
      <form id="memberForm" class="panel-body">
        <div class="map-control-row map-controls-member">
          <div id="geocoder-member" class="geocoder"></div>
          <div id="geolocate-member" class="geolocate-btn"></div>
          <div id="compass-member" class="compass-btn"></div>
        </div>
        <div class="panel-field">
          <label for="mTitle">Title</label>
          <input type="text" id="mTitle" required />
        </div>
        <div class="panel-field">
          <label for="mImage">Image</label>
          <input type="file" id="mImage" accept="image/*" />
        </div>
        <div class="panel-field">
          <label for="mDate">Date</label>
          <input type="date" id="mDate" />
        </div>
        <div class="panel-field">
          <label for="mColor">Color</label>
          <input type="color" id="mColor" data-mode="hex" value="#000000" />
        </div>
      </form>
    </div>
  </div>

  <div id="adminPanel" class="panel" role="dialog" aria-panel="true" aria-hidden="true">
    <div class="panel-content" style="top:calc(var(--header-h) + var(--safe-top));right:0;transform:none;">
      <div class="panel-header">
        <div class="header-top">
          <h2 class="title">Admin</h2>
          <div class="panel-actions">
            <button type="button" class="move-left" aria-label="Move panel left">&lt;</button>
            <button type="button" class="move-right" aria-label="Move panel right">&gt;</button>
            <button type="button" class="close-panel">Close</button>
          </div>
        </div>
        <div class="tab-bar">
          <button type="button" class="tab-btn" data-tab="map" aria-selected="true">Map</button>
          <button type="button" class="tab-btn" data-tab="settings">Settings</button>
          <button type="button" class="tab-btn" data-tab="forms">Forms</button>
        </div>
      </div>
      <form id="adminForm" class="panel-body">
        <div id="tab-map" class="tab-panel active">
          <div class="map-theme-container">
            <div class="panel-field">
              <label for="mapTheme">Theme</label>
              <select id="mapTheme">
                <option value="mapbox://styles/mapbox/outdoors-v12">Outdoors</option>
                <option value="mapbox://styles/mapbox/streets-v12">Streets</option>
                <option value="mapbox://styles/mapbox/light-v11">Light</option>
                <option value="mapbox://styles/mapbox/dark-v11">Dark</option>
                <option value="mapbox://styles/mapbox/satellite-streets-v12">Satellite Streets</option>
                <option value="mapbox://styles/mapbox/satellite-v9">Satellite Only</option>
                <option value="mapbox://styles/mapbox/navigation-day-v1">Navigation Day</option>
                <option value="mapbox://styles/mapbox/navigation-night-v1">Navigation Night</option>
                  <option value="mapbox://styles/mapbox/standard">Standard</option>
                  <option value="mapbox://styles/mapbox/satellite-streets-v12">Standard Satellite</option>
                <option value="mapbox://styles/mapbox/traffic-day-v2">Traffic Day</option>
                <option value="mapbox://styles/mapbox/traffic-night-v2">Traffic Night</option>
                  <option value="mapbox://styles/mapbox/terrain-v2">Terrain</option>
                  <option value="mapbox://styles/mapbox/light-v11">Standard Light</option>
                  <option value="mapbox://styles/mapbox/dark-v11">Standard Dark</option>
                <option value="mapbox://styles/mapbox/streets-v8">Streets Classic</option>
                <option value="mapbox://styles/mapbox/emerald-v8">Emerald</option>
                <option value="mapbox://styles/mapbox/wheatpaste-v9">Wheatpaste</option>
                <option value="mapbox://styles/mapbox/pencil-v2">Pencil</option>
                <option value="mapbox://styles/mapbox/vintage-v10">Vintage</option>
              </select>
            </div>
            <div class="panel-field">
              <label for="skyTheme">Sky</label>
              <select id="skyTheme">
                <option value="default">Default</option>
                <option value="sunset">Sunset</option>
                <option value="night">Night</option>
                <option value="aurora">Aurora</option>
                <option value="dawn">Dawn</option>
                <option value="dusk">Dusk</option>
                <option value="space">Space</option>
                <option value="cloudy">Cloudy</option>
                <option value="storm">Storm</option>
                <option value="twilight">Twilight</option>
                <option value="sunrise">Sunrise</option>
                <option value="rainbow">Rainbow</option>
              </select>
            </div>
          </div>
          <div class="map-spin-container">
            <div class="panel-field">
              <label for="spinSpeed">Spin speed</label>
              <div class="range-wrap">
                <input type="range" id="spinSpeed" min="0" max="1" step="0.01" />
                <span id="spinSpeedVal"></span>
              </div>
            </div>
            <div class="panel-field">
              <label for="mapPitch">Pitch</label>
              <div class="range-wrap">
                <input type="range" id="mapPitch" min="0" max="85" step="1" />
                <span id="pitchVal"></span>
              </div>
            </div>
            <div class="panel-field">
              <label for="mapBearing">Bearing</label>
              <div class="range-wrap">
                <input type="range" id="mapBearing" min="-180" max="180" step="1" />
                <span id="bearingVal"></span>
              </div>
            </div>
            <div class="panel-field">
              <div class="option-label">
                <span>Spin on Load</span>
                <label class="switch">
                  <input type="checkbox" id="spinLoadStart" />
                  <span class="slider"></span>
                </label>
              </div>
              <div id="spinType" class="option-group">
                <label class="option-label"><span>Everyone</span><input type="radio" name="spinType" value="all" /></label>
                <label class="option-label"><span>New Users</span><input type="radio" name="spinType" value="new" /></label>
              </div>
            </div>
            <div class="panel-field">
              <div class="option-label">
                <span>Spin on Logo</span>
                <label class="switch">
                  <input type="checkbox" id="spinLogoClick" checked />
                  <span class="slider"></span>
                </label>
              </div>
            </div>
          </div>
          <div id="map-balloon-container" class="map-balloon-container">
            <style>
              #map-balloon-container .t{font-size:16px;font-weight:bold;}
              #map-balloon-container .shape-dropdown{position:relative;width:400px;height:35px;margin-bottom:8px;}
              #map-balloon-container .shape-dropdown > button{width:400px;height:35px;background:var(--btn);border:1px solid var(--btn);border-radius:var(--dropdown-radius);text-align:left;padding:0;}
              #map-balloon-container .shape-menu{position:absolute;top:calc(100% + 4px);left:0;width:400px;max-height:400px;overflow-y:auto;overflow-y:overlay;background:var(--dropdown-bg);border:1px solid var(--border);border-radius:var(--dropdown-radius);padding:10px;display:flex;flex-direction:column;gap:6px;z-index:30;}
              #map-balloon-container .shape-menu[hidden]{display:none;}
              #map-balloon-container .shape-button{width:100%;height:35px;background:var(--btn);border:1px solid var(--btn);border-radius:var(--dropdown-radius);text-align:left;display:flex;align-items:center;gap:4px;padding:4px;cursor:pointer;}
              #map-balloon-container .shape-button svg{width:24px;height:24px;vertical-align:middle;}
              #map-balloon-container .shape-button.active{outline:2px solid var(--border);}
              #map-balloon-container .panel-field{width:400px;}
              #map-balloon-container #copySvgCode{width:400px;height:35px;padding:0;margin-bottom:8px;}
              #map-balloon-container #shapeMenuBtn{padding:0;}
              #map-balloon-container #balloonGrid{display:grid;grid-template-columns: repeat(10, 1fr); gap:4px;overflow-x:auto;margin-bottom:8px;}
              #map-balloon-container #balloonGrid svg{cursor:pointer;}
              #map-balloon-container #balloonSvgCode{width:400px;height:200px;}
            </style>
            <div class="t">Balloon Icon Generator</div>
            <div class="shape-dropdown">
              <button type="button" id="shapeMenuBtn" aria-expanded="false">Select Shape</button>
              <div class="shape-menu" id="balloonShapeButtons" hidden></div>
            </div>
            <div class="panel-field size-control">
              <label for="balloonSize">Balloon size</label>
              <div class="range-wrap">
                <input type="range" id="balloonSize" min="40" max="120" value="40" />
                <span id="balloonSizeValue">40</span>px
              </div>
            </div>
            <button type="button" id="copySvgCode">Copy SVG</button>
            <div id="balloonGrid"></div>
            <textarea id="balloonSvgCode"></textarea>
          </div>
        </div>
        <div id="tab-settings" class="tab-panel">
        <div id="post-mode-background-field" class="panel-field">
          <label for="postModeBgColor">Post Mode Background</label>
          <div class="settings-style-container">
            <div id="post-mode-background-row">
              <input type="color" id="postModeBgColor">
              <input type="range" id="postModeBgOpacity" min="0" max="1" step="0.01">
              <span id="postModeBgOpacityVal">0.00</span>
            </div>
          </div>
        </div>
        <div class="settings-welcome-container">
          <div id="welcome-message-panel" class="panel-field">
            <label for="welcomeMessageEditor">Welcome Message</label>
            <div class="wysiwyg-toolbar">
              <button type="button" data-command="bold"><b>B</b></button>
              <button type="button" data-command="italic"><i>I</i></button>
              <button type="button" data-command="underline"><u>U</u></button>
            </div>
            <div id="welcomeMessageEditor" class="wysiwyg" contenteditable="true" data-placeholder="<p>Welcome to Funmap!</p><p>Choose an area on the map to search for events and listings.</p><p>Click the Filters button to refine your search.</p>"></div>
            <textarea id="welcomeMessage" hidden></textarea>
          </div>
        </div>
        </div>
        <div id="tab-forms" class="tab-panel">
          <style>
            #tab-forms .form-category{margin:10px 0;border:1px solid #ccc;padding:0;}
            #tab-forms .category-header{display:flex;gap:6px;align-items:center;margin-bottom:8px;}
            #tab-forms .subcategory-table{border-collapse:collapse;}
            #tab-forms .subcategory-table td,#tab-forms .subcategory-table th{border:1px solid #999;padding:4px;}
          </style>
          <div id="formsControls">
            <div class="settings-style-container">
              <button type="button" id="addCategory">Add Category</button>
            </div>
            <div id="formsCategories"></div>
          </div>
        </div>
      </form>
  </div>
  </div>

  <div id="welcome-modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <!-- Welcome modal content (not a panel) -->
    <div class="modal-content">
      <div class="panel-body" id="welcomeBody">
        <img src="https://raw.githubusercontent.com/Zxen1/Events-Platform/refs/heads/main/assets/funmap-logo-big.png" alt="FunMap logo" />
        <div class="map-control-row map-controls-welcome">
          <div id="geocoder-welcome" class="geocoder"></div>
          <div id="geolocate-welcome" class="geolocate-btn"></div>
          <div id="compass-welcome" class="compass-btn"></div>
        </div>
        <div id="welcomeMessageBox"></div>
      </div>
    </div>
  </div>

  <script>
  let startPitch, startBearing, logoEls = [], geocoder;
  const geocoders = [];

  (function(){
    const MAPBOX_TOKEN = "pk.eyJ1IjoienhlbiIsImEiOiJjbWViaDRibXEwM2NrMm1wcDhjODg4em5iIn0.2A9teACgwpiCy33uO4WZJQ";

    let mode = 'map';
    const DEFAULT_SPIN_SPEED = 0.3;
    const DEFAULT_WELCOME = '<p>Welcome to Funmap!</p><p>Choose an area on the map to search for events and listings.</p><p>Click the Filters button to refine your search.</p>';
    const firstVisit = !localStorage.getItem('hasVisited');
    localStorage.setItem('hasVisited','1');
    const savedView = JSON.parse(localStorage.getItem('mapView') || 'null');
    const defaultCenter = [(Math.random()*360)-180,(Math.random()*140)-70];
    const startCenter = savedView?.center || defaultCenter;
    const startZoom = savedView?.zoom || 1.5;
    startPitch = window.startPitch = savedView?.pitch || 0;
    startBearing = window.startBearing = savedView?.bearing || 0;

    function normalizeMapStyle(style){
      switch(style){
        case 'mapbox://styles/mapbox/standard-dark':
          return 'mapbox://styles/mapbox/dark-v11';
        case 'mapbox://styles/mapbox/standard-light':
          return 'mapbox://styles/mapbox/light-v11';
        case 'mapbox://styles/mapbox/standard-satellite':
          return 'mapbox://styles/mapbox/satellite-streets-v12';
        default:
          return style;
      }
    }

      let map, spinning = false, historyWasActive = false, expiredWasOn = false, dateStart = null, dateEnd = null,
          spinLoadStart = JSON.parse(localStorage.getItem('spinLoadStart') ?? 'true'),
          spinLoadType = localStorage.getItem('spinLoadType') || 'all',
          spinLogoClick = localStorage.getItem('spinLogoClick') === 'false' ? false : true,
          spinSpeed = parseFloat(localStorage.getItem('spinSpeed') || String(DEFAULT_SPIN_SPEED)),
          spinEnabled = spinLoadStart && (spinLoadType === 'all' || (spinLoadType === 'new' && firstVisit)),
          mapStyle = window.mapStyle = normalizeMapStyle(localStorage.getItem('mapStyle')) || 'mapbox://styles/mapbox/streets-v12',
          skyStyle = window.skyStyle = localStorage.getItem('skyStyle') || 'night',
          clusterRadius = parseInt(localStorage.getItem('clusterRadius') || '52', 10),
          clusterMaxZoom = parseInt(localStorage.getItem('clusterMaxZoom') || '14', 10),
          clusterIconType = localStorage.getItem('clusterIconType') || 'circle',
          clusterSvg = localStorage.getItem('clusterSvg') || '';
        localStorage.setItem('spinGlobe', JSON.stringify(spinEnabled));
        logoEls = [document.querySelector('.logo')].filter(Boolean);
      function updateLogoClickState(){
        logoEls.forEach(el=>{
          el.style.cursor = 'pointer';
          el.style.pointerEvents = 'auto';
        });
      }
      updateLogoClickState();

      function applySky(theme){
        if(!map || typeof map.setFog !== 'function'){
          console.warn('map.setFog is not available in this Mapbox GL JS version.');
          return;
        }
        const skyThemes = {
          default:{ 'color':'rgb(186,210,255)','high-color':'rgb(64,152,255)','space-color':'rgb(4,7,22)','horizon-blend':0.3 },
          sunset:{ 'color':'#ffcf70','high-color':'#ff8f70','space-color':'#020014','horizon-blend':0.5 },
          night:{ 'color':'#0b1d51','high-color':'#1a2849','space-color':'#000000','horizon-blend':0.1,'star-intensity':0.8 },
          aurora:{ 'color':'#03172f','high-color':'#5dd9c1','space-color':'#000000','horizon-blend':0.2,'star-intensity':0.6 },
          dawn:{ 'color':'#ffd1a1','high-color':'#ff9f85','space-color':'#4a1a74','horizon-blend':0.4 },
          dusk:{ 'color':'#8e4e9e','high-color':'#3b1a69','space-color':'#020024','horizon-blend':0.3 },
          space:{ 'color':'#000000','high-color':'#000000','space-color':'#000000','horizon-blend':0,'star-intensity':0.0 },
          cloudy:{ 'color':'#cdd2d7','high-color':'#e4e7eb','space-color':'#adb5bd','horizon-blend':0.2 },
          storm:{ 'color':'#5e5e5e','high-color':'#2a2a2a','space-color':'#000000','horizon-blend':0.1 },
          twilight:{ 'color':'#2e3358','high-color':'#75517d','space-color':'#141429','horizon-blend':0.3 },
          sunrise:{ 'color':'#ffd28c','high-color':'#ff6e7f','space-color':'#2c1055','horizon-blend':0.4 },
          rainbow:{ 'color':'#ffe29f','high-color':'#ffa99f','space-color':'#667eea','horizon-blend':0.3 }
        };
        map.setFog(skyThemes[theme] || skyThemes.default);
      }

      function openWelcome(){
        const popup = document.getElementById('welcome-modal');
        const msgEl = document.getElementById('welcomeMessageBox');
        const saved = JSON.parse(localStorage.getItem('admin-settings-current') || '{}');
        msgEl.innerHTML = saved.welcomeMessage || DEFAULT_WELCOME;
        openPanel(popup);
        const body = document.getElementById('welcomeBody');
        body.style.padding = '20px';
      }
      window.openWelcome = openWelcome;

      function toggleWelcome(){
        const popup = document.getElementById('welcome-modal');
        if(popup.classList.contains('show')){
          closePanel(popup);
        } else {
          openWelcome();
        }
      }

      logoEls.forEach(el=>{
        el.addEventListener('click', (e) => {
          e.stopPropagation();
          if(spinning){
            toggleWelcome();
            return;
          }
          if(spinLogoClick && map && map.getZoom() <= 4){
            spinEnabled = true;
            localStorage.setItem('spinGlobe', 'true');
            startSpin(true);
          }
          toggleWelcome();
        });
      });
    // 'Post Panel' is defined as the current map bounds
    let postPanel = null;
    let posts = [], filtered = [], adPosts = [], adIndex = -1, adTimer = null, adPanel = null;
    let favToTop = false, currentSort = 'az';
    let selection = { cats: new Set(), subs: new Set() };
    let viewHistory = loadHistory();
    let hoverPopup = null, hoverId = null;
    let touchMarker = null;
    let activePostId = null;
    const BASE_URL = (()=>{ let b = location.origin + location.pathname.split('/post/')[0]; if(!b.endsWith('/')) b+='/'; return b; })();

    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const clamp = (n, a, b)=> Math.max(a, Math.min(b, n));
    const toRad = d => d * Math.PI / 180;
    function distKm(a,b){ const dLat = toRad(b.lat - a.lat), dLng = toRad(b.lng - a.lng); const s = Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(Math.PI*(b.lng - a.lng)/360)**2; return 2 * 6371 * Math.asin(Math.sqrt(s)); }
    const sleep = ms => new Promise(r=>setTimeout(r,ms));
    const nextFrame = ()=> new Promise(r=> requestAnimationFrame(()=>r()));

    // Ensure result lists occupy available space between the header and footer
    function adjustListHeight(){
      const rootStyles = getComputedStyle(document.documentElement);
      const headerH = parseFloat(rootStyles.getPropertyValue('--header-h')) || 0;
      const subH = parseFloat(rootStyles.getPropertyValue('--subheader-h')) || 0;
      const footerH = parseFloat(rootStyles.getPropertyValue('--footer-h')) || 0;
      const safeTop = parseFloat(rootStyles.getPropertyValue('--safe-top')) || 0;
      const availableHeight = window.innerHeight - headerH - subH - footerH - safeTop;
      document.querySelectorAll('.history-board, .posts').forEach(list=>{
        list.style.maxHeight = `${availableHeight}px`;
      });
    }
    window.adjustListHeight = adjustListHeight;

    let stickyScrollHandler = null;
    let venueDropdownEl = null;
    let sessionDropdownEl = null;
    let venueDropdownParent = null;
    let sessionDropdownParent = null;
      function updateStickyImages(){
        const root = document.documentElement;
        const body = document.querySelector('.open-post .post-body');
        if(!venueDropdownEl || !document.contains(venueDropdownEl)){
          const vd = document.querySelector('.venue-dropdown');
          if(vd){
            venueDropdownEl = vd;
            if(!venueDropdownParent && vd.parentElement){
              venueDropdownParent = vd.parentElement;
            }
          }
        }
        if(!sessionDropdownEl || !document.contains(sessionDropdownEl)){
          const sd = document.querySelector('.session-dropdown');
          if(sd){
            sessionDropdownEl = sd;
            if(!sessionDropdownParent && sd.parentElement){
              sessionDropdownParent = sd.parentElement;
            }
          }
        }
        const imgArea = body ? body.querySelector('.post-images') : null;
        const secondColumn = body ? body.querySelector('.second-post-column') : null;
        const header = document.querySelector('.open-post .post-header');
        const board = document.querySelector('.post-board');
        if(stickyScrollHandler && board){
          board.removeEventListener('scroll', stickyScrollHandler);
          stickyScrollHandler = null;
        }
        const isColumnBelow = imgArea && secondColumn ? secondColumn.offsetTop > imgArea.offsetTop : false;
        root.classList.toggle('hide-map-calendar', isColumnBelow);
        if(body){
          const venueContainer = body.querySelector('.post-venue-selection-container');
          const sessionContainer = body.querySelector('.post-session-selection-container');
          if(venueDropdownEl && venueContainer && venueDropdownEl.parentElement !== venueContainer){
            venueContainer.appendChild(venueDropdownEl);
          }
          if(sessionDropdownEl && sessionContainer && sessionDropdownEl.parentElement !== sessionContainer){
            sessionContainer.appendChild(sessionDropdownEl);
          }
        }else{
          if(venueDropdownEl && venueDropdownParent && venueDropdownEl.parentElement !== venueDropdownParent){
            venueDropdownParent.appendChild(venueDropdownEl);
          }
          if(sessionDropdownEl && sessionDropdownParent && sessionDropdownEl.parentElement !== sessionDropdownParent){
            sessionDropdownParent.appendChild(sessionDropdownEl);
          }
        }
        if(!body || !imgArea || !secondColumn || !header || !board){
          root.classList.remove('open-post-sticky-images');
          document.documentElement.style.removeProperty('--open-post-header-h');
          return;
        }
        const twoCols = !isColumnBelow;
        document.documentElement.style.setProperty('--open-post-header-h', header.offsetHeight + 'px');
        stickyScrollHandler = () => {
          root.classList.toggle('open-post-sticky-images', twoCols);
        };
        board.addEventListener('scroll', stickyScrollHandler);
        stickyScrollHandler();
      }

    window.updateStickyImages = updateStickyImages;

    function updateLayoutVars(){
      const root = document.documentElement;
      const header = document.querySelector('.header');
      if(header){
        root.style.setProperty('--header-h', `${header.offsetHeight}px`);
      }
      if(typeof window.adjustListHeight === 'function'){
        window.adjustListHeight();
      }
    }
    window.updateLayoutVars = updateLayoutVars;

    function updatePostPanel(){ if(map) postPanel = map.getBounds(); }

    // === 0528 helpers: cluster contextmenu list (robust positioning + locking) ===
    let listLocked = false;
    let lastListOpenAt = 0;
    function lockMap(lock){
      listLocked = lock;
      const fn = lock ? 'disable' : 'enable';
      try{ map.dragPan[fn](); }catch(e){}
      try{ map.scrollZoom[fn](); }catch(e){}
      try{ map.boxZoom[fn](); }catch(e){}
      try{ map.keyboard[fn](); }catch(e){}
      try{ map.doubleClickZoom[fn](); }catch(e){}
      try{ map.touchZoomRotate[fn](); }catch(e){}
    }
    function getClusterLeavesAll(sourceId, clusterId){
      return new Promise((resolve, reject)=>{
        const src = map.getSource(sourceId); if(!src) return resolve([]);
        const page = 50; const out = [];
        function step(offset){
          src.getClusterLeaves(clusterId, page, offset, (err, leaves)=>{
            if(err){ resolve([]); return; }
            out.push(...leaves);
            if(leaves.length < page) resolve(out);
            else step(offset + page);
          });
        }
        step(0);
      });
    }
    
function buildClusterListHTML(items){
  const allDates = items.flatMap(p=>p.dates).sort();
  const first = allDates[0];
  const last = allDates[allDates.length-1] || first;
  const fmt = iso => parseISODate(iso).toLocaleDateString('en-GB',{weekday:'short', day:'numeric', month:'short', year:'numeric'}).replace(',', '').replace(/ (\d{4})$/, ', $1');
  const head = `<h4>${items.length} events here<br><span class="soonest"><span class="nowrap">${fmt(first)} - ${fmt(last)}</span></span></h4>`;
  const sort = currentSort;
  const arr = items.slice();
  if(sort==='az') arr.sort((a,b)=> a.title.localeCompare(b.title));
  if(sort==='soon') arr.sort((a,b)=> a.dates[0].localeCompare(b.dates[0]));
  if(sort==='nearest'){
    let ref = {lng:0,lat:0}; if(map){ const c = map.getCenter(); ref = {lng:c.lng,lat:c.lat}; }
    arr.sort((a,b)=> distKm({lng:a.lng,lat:a.lat}, ref) - distKm({lng:b.lng,lat:b.lat}, ref));
  }
  if(favToTop) arr.sort((a,b)=> (b.fav - a.fav));
  const list = arr.map(p => {
    return `
      <div class="multi-item map-card" data-id="${p.id}">
        <div class="hover-card">
          <img src="${imgThumb(p)}" alt="" referrerpolicy="no-referrer"/>
          <div>
            <div class="t">${p.title}</div>
            <div class="s">${p.city}</div>
          </div>
        </div>
      </div>`;
  }).join('');
  return `<div class=\"multi-hover\">${head}<div class=\"multi-list\">${list}</div></div>`;
}
    // 0530: group posts at the same venue (by coordinate)
    function postsAtVenue(lng, lat){
      const list = (filtered.length ? filtered : posts);
      const eps = 1e-6; // ~0.1m at equator
      return list.filter(p => Math.abs(p.lng - lng) < eps && Math.abs(p.lat - lat) < eps);
    }

    function openListPopupAtPoint(point, htmlStr){
      // Remove previous
      if(hoverPopup){ hoverPopup.remove(); hoverPopup=null; }
      // Place popup at the pointer, then adjust to keep fully in view by moving the lngLat
      const lngLat = map.unproject(point);
      hoverPopup = new mapboxgl.Popup({maxWidth:'none', closeButton:false, closeOnClick:false, anchor:'top', className:'hover-pop hover-multi-list map-card', offset:10}).setLngLat(lngLat).setHTML(htmlStr).addTo(map);
      registerPopup(hoverPopup);
      // Prevent the browser contextmenu while locked
      map.getCanvas().addEventListener('contextmenu', ev => ev.preventDefault(), {once:true});
      // Stop events inside from bubbling to map
      const el = hoverPopup.getElement();
      el.addEventListener('click', e => e.stopPropagation(), {capture:true});
      // After layout, ensure fully on-screen
      requestAnimationFrame(()=>{
        const rect = el.getBoundingClientRect();
        const cont = map.getContainer().getBoundingClientRect();
        let x = point.x, y = point.y;
        const pad = 12;
        const maxX = cont.width - pad;
        const maxY = cont.height - pad;
        // If overflowing right/left, clamp
        if(rect.right > cont.right - pad) x -= (rect.right - (cont.right - pad));
        if(rect.left  < cont.left + pad)  x += (cont.left + pad - rect.left);
        // If overflowing bottom/top, clamp
        if(rect.bottom > cont.bottom - pad) y -= (rect.bottom - (cont.bottom - pad));
        if(rect.top    < cont.top + pad)    y += (cont.top + pad - rect.top);
        hoverPopup.setLngLat(map.unproject({x,y}));
      });
    }


    function mulberry32(a){ return function(){var t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15, t|1); t^=t+Math.imul(t^t>>>7, t|61); return ((t^t>>>14)>>>0)/4294967296; }; }
    const rnd = mulberry32(42);

    const cities = [
      {n:"Melbourne, Australia", c:[144.9631,-37.8136]},
      {n:"Sydney, Australia", c:[151.2093,-33.8688]},
      {n:"London, UK", c:[-0.1276,51.5072]},
      {n:"New York, USA", c:[-74.0060,40.7128]},
      {n:"Tokyo, Japan", c:[139.6917,35.6895]},
      {n:"Paris, France", c:[2.3522,48.8566]},
      {n:"Rio de Janeiro, Brazil", c:[-43.1729,-22.9068]},
      {n:"Cape Town, South Africa", c:[18.4241,-33.9249]},
      {n:"Reykjavk, Iceland", c:[-21.8174,64.1265]},
      {n:"Mumbai, India", c:[72.8777,19.0760]}
    ];
    const categories = window.categories = [
      { name:"Film",      subs:["Screenings","Festivals","Shorts","Indie"] },
      { name:"Theatre",   subs:["Plays","Musicals","Improv"] },
      { name:"Music",     subs:["Gigs","Open Mic","Classical","Jazz"] },
      { name:"Dance",     subs:["Ballet","Contemporary","Hip Hop"] },
      { name:"Photography",subs:["Exhibitions","Workshops"] },
      { name:"Gallery",   subs:["Openings","Talks"] },
      { name:"Auditions", subs:["Film","Theatre","Music"] },
      { name:"Talent",    subs:["Models","Actors","Crew"] }
    ];
    const subcategorySvgs = window.subcategorySvgs = {
      'actors': `<svg viewBox="-60 -80 120 160" width="40" height="40"><g fill="#adff00" stroke="#000" stroke-width="1"><path d="M0,-55 L45,0 0,55 -45,0 Z"/></g><path d="M-8,55 L0,60 L8,55 Z" fill="#000" stroke="#000" stroke-width="1"/><line x1="0" y1="60" x2="0" y2="80" stroke="#fff" stroke-width="2"/><ellipse cx="-20" cy="-20" rx="10" ry="6" fill="#fff"/></svg>`,
      'ballet': `<svg viewBox="-60 -80 120 160" width="40" height="40"><g fill="#ffa800" stroke="#000" stroke-width="1"><path d="M0,-55 L14,-17 L47,-17 L23,5 L35,45 L0,25 L-35,45 L-23,5 L-47,-17 L-14,-17 Z"/></g><path d="M-8,55 L0,60 L8,55 Z" fill="#000" stroke="#000" stroke-width="1"/><line x1="0" y1="60" x2="0" y2="80" stroke="#fff" stroke-width="2"/><ellipse cx="-20" cy="-20" rx="10" ry="6" fill="#fff"/></svg>`,
      'classical': `<svg viewBox="-60 -80 120 160" width="40" height="40"><g fill="#ff8a00" stroke="#000" stroke-width="1"><path d="M0,-30 C-30,-70 -70,-20 -35,15 Q0,55 35,15 C70,-20 30,-70 0,-30Z"/></g><path d="M-8,55 L0,60 L8,55 Z" fill="#000" stroke="#000" stroke-width="1"/><line x1="0" y1="60" x2="0" y2="80" stroke="#fff" stroke-width="2"/><ellipse cx="-20" cy="-20" rx="10" ry="6" fill="#fff"/></svg>`,
      'contemporary': `<svg viewBox="-60 -80 120 160" width="40" height="40"><g fill="#ffb800" stroke="#000" stroke-width="1"><path d="M0,-55 L14,-17 L47,-17 L23,5 L35,45 L0,25 L-35,45 L-23,5 L-47,-17 L-14,-17 Z"/></g><path d="M-8,55 L0,60 L8,55 Z" fill="#000" stroke="#000" stroke-width="1"/><line x1="0" y1="60" x2="0" y2="80" stroke="#fff" stroke-width="2"/><ellipse cx="-20" cy="-20" rx="10" ry="6" fill="#fff"/></svg>`,
      'crew': `<svg viewBox="-60 -80 120 160" width="40" height="40"><g fill="#9eff00" stroke="#000" stroke-width="1"><path d="M0,-55 L45,0 0,55 -45,0 Z"/></g><path d="M-8,55 L0,60 L8,55 Z" fill="#000" stroke="#000" stroke-width="1"/><line x1="0" y1="60" x2="0" y2="80" stroke="#fff" stroke-width="2"/><ellipse cx="-20" cy="-20" rx="10" ry="6" fill="#fff"/></svg>`,
      'exhibitions': `<svg viewBox="-60 -80 120 160" width="40" height="40"><g fill="#ffd600" stroke="#000" stroke-width="1"><path d="M0,55 L50,-45 L-50,-45 Z"/></g><path d="M-8,55 L0,60 L8,55 Z" fill="#000" stroke="#000" stroke-width="1"/><line x1="0" y1="60" x2="0" y2="80" stroke="#fff" stroke-width="2"/><ellipse cx="-20" cy="-20" rx="10" ry="6" fill="#fff"/></svg>`,
      'festivals': `<svg viewBox="-60 -80 120 160" width="40" height="40"><g fill="#ff0f00" stroke="#000" stroke-width="1"><circle cx="0" cy="0" r="50"/></g><path d="M-8,55 L0,60 L8,55 Z" fill="#000" stroke="#000" stroke-width="1"/><line x1="0" y1="60" x2="0" y2="80" stroke="#fff" stroke-width="2"/><ellipse cx="-20" cy="-20" rx="10" ry="6" fill="#fff"/></svg>`,
      'film': `<svg viewBox="-60 -80 120 160" width="40" height="40"><g fill="#ebff00" stroke="#000" stroke-width="1"><rect x="-45" y="-45" width="90" height="90" rx="20" ry="20"/></g><path d="M-8,55 L0,60 L8,55 Z" fill="#000" stroke="#000" stroke-width="1"/><line x1="0" y1="60" x2="0" y2="80" stroke="#fff" stroke-width="2"/><ellipse cx="-20" cy="-20" rx="10" ry="6" fill="#fff"/></svg>`,
      'gigs': `<svg viewBox="-60 -80 120 160" width="40" height="40"><g fill="#ff6b00" stroke="#000" stroke-width="1"><path d="M0,-30 C-30,-70 -70,-20 -35,15 Q0,55 35,15 C70,-20 30,-70 0,-30Z"/></g><path d="M-8,55 L0,60 L8,55 Z" fill="#000" stroke="#000" stroke-width="1"/><line x1="0" y1="60" x2="0" y2="80" stroke="#fff" stroke-width="2"/><ellipse cx="-20" cy="-20" rx="10" ry="6" fill="#fff"/></svg>`,
      'hip-hop': `<svg viewBox="-60 -80 120 160" width="40" height="40"><g fill="#ffc700" stroke="#000" stroke-width="1"><path d="M0,-55 L14,-17 L47,-17 L23,5 L35,45 L0,25 L-35,45 L-23,5 L-47,-17 L-14,-17 Z"/></g><path d="M-8,55 L0,60 L8,55 Z" fill="#000" stroke="#000" stroke-width="1"/><line x1="0" y1="60" x2="0" y2="80" stroke="#fff" stroke-width="2"/><ellipse cx="-20" cy="-20" rx="10" ry="6" fill="#fff"/></svg>`,
      'improv': `<svg viewBox="-60 -80 120 160" width="40" height="40"><g fill="#ff5c00" stroke="#000" stroke-width="1"><ellipse cx="0" cy="0" rx="40" ry="55"/></g><path d="M-8,55 L0,60 L8,55 Z" fill="#000" stroke="#000" stroke-width="1"/><line x1="0" y1="60" x2="0" y2="80" stroke="#fff" stroke-width="2"/><ellipse cx="-20" cy="-20" rx="10" ry="6" fill="#fff"/></svg>`,
      'indie': `<svg viewBox="-60 -80 120 160" width="40" height="40"><g fill="#ff2e00" stroke="#000" stroke-width="1"><circle cx="0" cy="0" r="50"/></g><path d="M-8,55 L0,60 L8,55 Z" fill="#000" stroke="#000" stroke-width="1"/><line x1="0" y1="60" x2="0" y2="80" stroke="#fff" stroke-width="2"/><ellipse cx="-20" cy="-20" rx="10" ry="6" fill="#fff"/></svg>`,
      'jazz': `<svg viewBox="-60 -80 120 160" width="40" height="40"><g fill="#ff9900" stroke="#000" stroke-width="1"><path d="M0,-30 C-30,-70 -70,-20 -35,15 Q0,55 35,15 C70,-20 30,-70 0,-30Z"/></g><path d="M-8,55 L0,60 L8,55 Z" fill="#000" stroke="#000" stroke-width="1"/><line x1="0" y1="60" x2="0" y2="80" stroke="#fff" stroke-width="2"/><ellipse cx="-20" cy="-20" rx="10" ry="6" fill="#fff"/></svg>`,
      'models': `<svg viewBox="-60 -80 120 160" width="40" height="40"><g fill="#bdff00" stroke="#000" stroke-width="1"><path d="M0,-55 L45,0 0,55 -45,0 Z"/></g><path d="M-8,55 L0,60 L8,55 Z" fill="#000" stroke="#000" stroke-width="1"/><line x1="0" y1="60" x2="0" y2="80" stroke="#fff" stroke-width="2"/><ellipse cx="-20" cy="-20" rx="10" ry="6" fill="#fff"/></svg>`,
      'music': `<svg viewBox="-60 -80 120 160" width="40" height="40"><g fill="#ccff00" stroke="#000" stroke-width="1"><rect x="-45" y="-45" width="90" height="90" rx="20" ry="20"/></g><path d="M-8,55 L0,60 L8,55 Z" fill="#000" stroke="#000" stroke-width="1"/><line x1="0" y1="60" x2="0" y2="80" stroke="#fff" stroke-width="2"/><ellipse cx="-20" cy="-20" rx="10" ry="6" fill="#fff"/></svg>`,
      'musicals': `<svg viewBox="-60 -80 120 160" width="40" height="40"><g fill="#ff4c00" stroke="#000" stroke-width="1"><ellipse cx="0" cy="0" rx="40" ry="55"/></g><path d="M-8,55 L0,60 L8,55 Z" fill="#000" stroke="#000" stroke-width="1"/><line x1="0" y1="60" x2="0" y2="80" stroke="#fff" stroke-width="2"/><ellipse cx="-20" cy="-20" rx="10" ry="6" fill="#fff"/></svg>`,
      'open-mic': `<svg viewBox="-60 -80 120 160" width="40" height="40"><g fill="#ff7a00" stroke="#000" stroke-width="1"><path d="M0,-30 C-30,-70 -70,-20 -35,15 Q0,55 35,15 C70,-20 30,-70 0,-30Z"/></g><path d="M-8,55 L0,60 L8,55 Z" fill="#000" stroke="#000" stroke-width="1"/><line x1="0" y1="60" x2="0" y2="80" stroke="#fff" stroke-width="2"/><ellipse cx="-20" cy="-20" rx="10" ry="6" fill="#fff"/></svg>`,
      'openings': `<svg viewBox="-60 -80 120 160" width="40" height="40"><g fill="#fff500" stroke="#000" stroke-width="1"><rect x="-35" y="-55" width="70" height="110" rx="20" ry="20"/></g><path d="M-8,55 L0,60 L8,55 Z" fill="#000" stroke="#000" stroke-width="1"/><line x1="0" y1="60" x2="0" y2="80" stroke="#fff" stroke-width="2"/><ellipse cx="-20" cy="-20" rx="10" ry="6" fill="#fff"/></svg>`,
      'plays': `<svg viewBox="-60 -80 120 160" width="40" height="40"><g fill="#ff3d00" stroke="#000" stroke-width="1"><ellipse cx="0" cy="0" rx="40" ry="55"/></g><path d="M-8,55 L0,60 L8,55 Z" fill="#000" stroke="#000" stroke-width="1"/><line x1="0" y1="60" x2="0" y2="80" stroke="#fff" stroke-width="2"/><ellipse cx="-20" cy="-20" rx="10" ry="6" fill="#fff"/></svg>`,
      'screenings': `<svg viewBox="-60 -80 120 160" width="40" height="40"><g fill="#ff0000" stroke="#000" stroke-width="1"><circle cx="0" cy="0" r="50"/></g><path d="M-8,55 L0,60 L8,55 Z" fill="#000" stroke="#000" stroke-width="1"/><line x1="0" y1="60" x2="0" y2="80" stroke="#fff" stroke-width="2"/><ellipse cx="-20" cy="-20" rx="10" ry="6" fill="#fff"/></svg>`,
      'shorts': `<svg viewBox="-60 -80 120 160" width="40" height="40"><g fill="#ff1f00" stroke="#000" stroke-width="1"><circle cx="0" cy="0" r="50"/></g><path d="M-8,55 L0,60 L8,55 Z" fill="#000" stroke="#000" stroke-width="1"/><line x1="0" y1="60" x2="0" y2="80" stroke="#fff" stroke-width="2"/><ellipse cx="-20" cy="-20" rx="10" ry="6" fill="#fff"/></svg>`,
      'talks': `<svg viewBox="-60 -80 120 160" width="40" height="40"><g fill="#faff00" stroke="#000" stroke-width="1"><rect x="-35" y="-55" width="70" height="110" rx="20" ry="20"/></g><path d="M-8,55 L0,60 L8,55 Z" fill="#000" stroke="#000" stroke-width="1"/><line x1="0" y1="60" x2="0" y2="80" stroke="#fff" stroke-width="2"/><ellipse cx="-20" cy="-20" rx="10" ry="6" fill="#fff"/></svg>`,
      'theatre': `<svg viewBox="-60 -80 120 160" width="40" height="40"><g fill="#dbff00" stroke="#000" stroke-width="1"><rect x="-45" y="-45" width="90" height="90" rx="20" ry="20"/></g><path d="M-8,55 L0,60 L8,55 Z" fill="#000" stroke="#000" stroke-width="1"/><line x1="0" y1="60" x2="0" y2="80" stroke="#fff" stroke-width="2"/><ellipse cx="-20" cy="-20" rx="10" ry="6" fill="#fff"/></svg>`,
      'workshops': `<svg viewBox="-60 -80 120 160" width="40" height="40"><g fill="#ffe600" stroke="#000" stroke-width="1"><path d="M0,55 L50,-45 L-50,-45 Z"/></g><path d="M-8,55 L0,60 L8,55 Z" fill="#000" stroke="#000" stroke-width="1"/><line x1="0" y1="60" x2="0" y2="80" stroke="#fff" stroke-width="2"/><ellipse cx="-20" cy="-20" rx="10" ry="6" fill="#fff"/></svg>`
    };
    const subcategoryIcons = window.subcategoryIcons = {};
    const subcategoryMarkers = window.subcategoryMarkers = {};
    const subcategoryMarkerIds = window.subcategoryMarkerIds = {};
    const categoryShapes = window.categoryShapes = {};
// 0585: unique title generator (with location; no category prefix)
const __ADJ = ["Radiant","Indigo","Velvet","Silver","Crimson","Neon","Amber","Sapphire","Emerald","Electric","Roaring","Midnight","Sunlit","Ethereal","Urban","Astral","Analog","Digital","Windswept","Golden","Hidden","Avant","Cosmic","Garden","Quiet","Vivid","Obsidian","Scarlet","Cerulean","Lunar","Solar","Autumn","Verdant","Azure"];
const __NOUN = ["Symphony","Market","Carnival","Showcase","Assembly","Parade","Salon","Summit","Expo","Soire","Revue","Collective","Fair","Gathering","Series","Retrospective","Circuit","Sessions","Weekender","Festival","Bazaar","Program","Tableau","Odyssey","Forum","Mosaic","Canvas","Relay","Drift","Workshop","Lab"];
const __HOOK = ["at Dusk","of Ideas","in Motion","for Everyone","Remix","Live","Reborn","MKII","Redux","Infinite","Prime","Pulse","Wave","Future","Now","Unlocked","Extended","Panorama","Unbound","Edition","Run","Sequence"];
function __rng(seed){ let s = seed|0; return ()=> (s = (s*1664525 + 1013904223)>>>0); }
const __USED_BIGRAMS = new Set();
function uniqueTitle(seed, cityName, idx){
  // Deterministic RNG with attempt salt for conflict resolution
  const base = (seed||0) ^ ((idx||0)*99991);

  const normalize = (s)=> s
    .replace(/[^\p{L}\p{N}]+/gu,' ')
    .trim()
    .split(/\s+/)
    .filter(Boolean);

  const lower = (ws)=> ws.map(w=> w.toLowerCase());

  const bigrams = (words)=> {
    const out = [];
    for(let i=0;i<words.length-1;i++) out.push(words[i]+" "+words[i+1]);
    return out;
  };

  const violates = (title)=> {
    const ws = normalize(title);
    const lc = lower(ws);
    if(!ws.length) return true;

    // no duplicate adjacent words inside one title
    for(let i=0;i<lc.length-1;i++){
      if(lc[i]===lc[i+1]) return true;
    }
    // any bigram seen before globally?
    const b = bigrams(lc);
    for(const bg of b){ if(__USED_BIGRAMS.has(bg)) return true; }

    return false;
  };

  const pickFrom = (r, arr)=> arr[r()%arr.length];

  // Word banks
  const A = __ADJ, N = __NOUN, H = __HOOK;
  const ARTISTS = [
    "The Silver Comets","Neon Parade","Paper Lanterns","Velvet Echoes","Indigo Quartet",
    "The Jet Set","Crimson Tide","Midnight Radio","Electric Hearts","Golden Hour",
    "The Amber Rooms","Violet Skyline","Satellite City","The Night Owls","Ivory Street Band",
    "Bluebird Company","Marble Garden","Velvet Undergrounders","Echo Park Players","Lantern Light",
    "Harbor & Co.","The Carousel Club","Kite & Canvas","Saffron Society","The Prairie Dogs"
  ];
  const PLAY_FORMS = [
    "Picture Show","Live on Stage","In Concert","Experience","Cabaret","Showcase",
    "Festival","Gala","Residency","Matinee","After Dark","Revue","Workshop"
  ];
  const STORY_OPENERS = [
    "Once Upon a Time","Into the Unknown","A Night to Remember","Between Two Worlds",
    "The Last Carousel","Dreams of Summer","Echoes in the Hall","Velvet Midnight",
    "The Paper Moon","Lanterns at Dusk","The Long Goodbye","Morning After Dark","Before the Storm"
  ];
  const TOUR_TAGS = ["Greatest Hits","Unplugged","Anniversary Tour","Acoustic Sessions","Late Night Set"];
  const PROMOS = ["One Night Only!","Two Nights Only!","One Weekend Only!","2 weeks only!!","Limited Season","Encore Performance"];

  const makeTitle = (r)=>{
    const templates = [
      ()=> `${pickFrom(r, ARTISTS)} Live on Stage`,
      ()=> `${pickFrom(r, ARTISTS)}  ${pickFrom(r, TOUR_TAGS)}`,
      ()=> `An Evening with ${pickFrom(r, ARTISTS)}`,
      ()=> `The ${pickFrom(r, N)} ${pickFrom(r, PLAY_FORMS)}`,
      ()=> `The ${pickFrom(r, A)} ${pickFrom(r, N)}`,
      ()=> `${pickFrom(r, A)} ${pickFrom(r, N)} ${pickFrom(r, H)}`,
      ()=> `${pickFrom(r, STORY_OPENERS)}`,
      ()=> `${pickFrom(r, A)} ${pickFrom(r, N)}: ${pickFrom(r, H)}`,
      ()=> `${pickFrom(r, A)} ${pickFrom(r, N)} ${pickFrom(r, PLAY_FORMS)}`,
      ()=> `${pickFrom(r, N)} ${pickFrom(r, PLAY_FORMS)}`
    ];
    let t = templates[r()%templates.length]();
    if ((r()%4)===0) t += `  ${pickFrom(r, PROMOS)}`;
    return t.replace(/\s+/g,' ').trim();
  };

  // Try multiple deterministic attempts with salted RNG until constraints satisfied
  let attempt = 0, title = "";
  for(; attempt < 96; attempt++){
    const r = __rng(base ^ (attempt * 1315423911));
    const candidate = makeTitle(r);
    if(!violates(candidate)){
      title = candidate;
      break;
    }
  }
  if(!title){ title = makeTitle(__rng(base ^ 0x9e3779b9)); } // fallback

  // Commit global constraints
  const ws = lower(normalize(title));
  for(let i=0;i<ws.length-1;i++){ __USED_BIGRAMS.add(ws[i]+" "+ws[i+1]); }

  return title;
}function pick(arr){ return arr[Math.floor(rnd()*arr.length)]; }
    function jitter([lng,lat]){ return [lng + (rnd()-0.5)*8, clamp(lat + (rnd()-0.5)*8,-80,80)]; }

  function toISODate(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  function parseISODate(s){
    const [yy, mm, dd] = s.split('-').map(Number);
    return new Date(yy, mm - 1, dd);
  }

  function randomDates(){
    const count = 1 + Math.floor(rnd()*30);
    const now = new Date();
    return Array.from({length:count}, ()=>{
      const d = new Date(+now + Math.floor(rnd()*365)*86400000);
      return toISODate(d);
    }).sort();
  }

  const VENUES = [
    "Grand Hall","City Theater","Riverside Arena","Skyline Lounge","Sunset Pavilion",
    "Maple Center","Harbor Stage","Old Mill Gallery","Crystal Ballroom","Garden Amphitheater"
  ];
  const STREETS = [
    "Main St","Oak Ave","Pine Rd","Maple Blvd","Cedar St",
    "Elm Rd","Birch Ave","Spruce St","Willow Ln","Ash Blvd"
  ];

  function randomSchedule(){
    const count = 1 + Math.floor(rnd()*20);
    const now = new Date();
    return Array.from({length:count}, ()=>{
      const d = new Date(+now + Math.floor(rnd()*365)*86400000);
      const date = d.toLocaleDateString('en-GB',{weekday:'short', day:'numeric', month:'short'}).replace(/,/g,'');
      const time = `${String(Math.floor(rnd()*24)).padStart(2,'0')}:${String(Math.floor(rnd()*4)*15).padStart(2,'0')}`;
      const full = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      return {date, time, full};
    });
  }

  function randomLocation(city, baseLng=0, baseLat=0){
    const venue = pick(VENUES);
    const address = `${Math.floor(rnd()*999)+1} ${pick(STREETS)}, ${city}`;
    const jitter = ()=> (rnd()-0.5) * 0.02;
    const lng = baseLng + jitter();
    const lat = baseLat + jitter();
    return { venue, address, lng, lat, dates: randomSchedule(), price: randomPriceRange() };
  }

  function randomLocations(city, baseLng=0, baseLat=0){
    const count = 1 + Math.floor(rnd()*5);
    return Array.from({length:count}, ()=> randomLocation(city, baseLng, baseLat));
  }

  function randomImages(id){
    const hero = imgHero(id);
    const others = Array.from({length:9},(_,i)=>{
      const port = i % 2 === 0;
      return `https://picsum.photos/seed/${encodeURIComponent(id)}-${i}/${port?'800/1200':'1200/800'}`;
    });
    return [hero, ...others];
  }

  function randomText(min=100,max=500){
    const lorem = "lorem ipsum dolor sit amet consectetur adipiscing elit sed do eiusmod tempor incididunt ut labore et dolore magna aliqua".split(' ');
    const count = min + Math.floor(rnd()*(max-min+1));
    const words = [];
    for(let i=0;i<count;i++){ words.push(lorem[i%lorem.length]); }
    words[0] = words[0][0].toUpperCase() + words[0].slice(1);
    return words.join(' ') + '.';
  }

  function randomPriceRange(){
    const low = 10 + Math.floor(rnd()*90);
    const high = low + 10 + Math.floor(rnd()*90);
    return `$${low} - $${high}`;
  }

  function randomUsername(seed){
    const names = ['Aria','Blake','Casey','Drew','Evan','Finn','Gray','Harper','Indie','Jules'];
    let h = 0; for(let i=0;i<seed.length;i++){ h = (h<<5)-h+seed.charCodeAt(i); }
    const name = names[Math.abs(h)%names.length];
    const num = Math.abs(Math.floor(h/7))%1000;
    return name + num;
  }

  function randomAvatar(seed){
    return `https://picsum.photos/seed/${encodeURIComponent(seed)}-a/100/100`;
  }

  function slugify(str){
    return str.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'');
  }
  window.slugify = slugify;

  function postUrl(p){
    return `${BASE_URL}#/post/${p.slug}-${p.created}`;
  }

  function showCopyMsg(btn){
    const header = btn && btn.closest('.post-header');
    if(!header) return;
    const msg = document.createElement('div');
    msg.className='copy-msg';
    msg.textContent='Link Copied';
    header.appendChild(msg);
    const btnRect = btn.getBoundingClientRect();
    const headerRect = header.getBoundingClientRect();
    const msgRect = msg.getBoundingClientRect();
    msg.style.top = (btnRect.top - headerRect.top + (btnRect.height - msgRect.height)/2) + 'px';
    msg.style.left = (btnRect.left - headerRect.left - msgRect.width - 10) + 'px';
    requestAnimationFrame(()=>msg.classList.add('show'));
    setTimeout(()=>msg.remove(),1500);
  }


function makePosts(){
  const out = [];
  // ---- 100 posts at Federation Square (as before) ----
  const fsLng = 144.9695, fsLat = -37.8178;
  const fsCity = "Federation Square, Melbourne";
  for(let i=0;i<100;i++){
    const cat = pick(categories);
    const sub = pick(cat.subs);
    const id = 'FS'+i;
    const title = `${id} ${uniqueTitle(i*7777+13, fsCity, i)}`;
    const created = new Date().toISOString().replace(/[:.]/g,'-');
    out.push({
      id,
      title,
      slug: slugify(title),
      created,
      city: fsCity,
      lng: fsLng, lat: fsLat,
      category: cat.name,
      subcategory: sub,
      dates: randomDates(),
      sponsored: true, // All posts are sponsored for development
      fav:false,
      desc: randomText(),
      images: randomImages(id),
      locations: randomLocations(fsCity, fsLng, fsLat),
      member: { username: randomUsername(id), avatar: randomAvatar(id) },
    });
  }

  // ---- 100 posts in Tasmania ----
  const tasLng = 147.3272, tasLat = -42.8821;
  const tasCity = "Hobart, Tasmania";
  const todayTas = new Date(); todayTas.setHours(0,0,0,0);
  for(let i=0;i<100;i++){
    const cat = pick(categories);
    const sub = pick(cat.subs);
    const id = 'TAS'+i;
    const title = `${id} ${uniqueTitle(i*5311+23, tasCity, i)}`;
    const created = new Date().toISOString().replace(/[:.]/g,'-');
    const offset = 1 + i%30;
    const date = new Date(todayTas);
    date.setDate(date.getDate() + (i<50 ? -offset : offset));
    out.push({
      id,
      title,
      slug: slugify(title),
      created,
      city: tasCity,
      lng: tasLng + (rnd()-0.5)*0.2,
      lat: tasLat + (rnd()-0.5)*0.2,
      category: cat.name,
      subcategory: sub,
      dates: [toISODate(date)],
      sponsored: true, // All posts are sponsored for development
      fav:false,
      desc: randomText(),
      images: randomImages(id),
      locations: randomLocations(tasCity, tasLng, tasLat),
      member: { username: randomUsername(id), avatar: randomAvatar(id) },
    });
  }

  // ---- Restore world-wide posts ----
  // A light list of hub cities for better realism
  const hubs = [
    {c:"New York, USA",      lng:-73.9857, lat:40.7484},
    {c:"Los Angeles, USA",   lng:-118.2437, lat:34.0522},
    {c:"London, UK",         lng:-0.1276, lat:51.5074},
    {c:"Paris, France",      lng:2.3522, lat:48.8566},
    {c:"Berlin, Germany",    lng:13.4050, lat:52.5200},
    {c:"Madrid, Spain",      lng:-3.7038, lat:40.4168},
    {c:"Rome, Italy",        lng:12.4964, lat:41.9028},
    {c:"Amsterdam, NL",      lng:4.9041, lat:52.3676},
    {c:"Dublin, Ireland",    lng:-6.2603, lat:53.3498},
    {c:"Stockholm, Sweden",  lng:18.0686, lat:59.3293},
    {c:"Copenhagen, Denmark",lng:12.5683, lat:55.6761},
    {c:"Helsinki, Finland",  lng:24.9384, lat:60.1699},
    {c:"Oslo, Norway",       lng:10.7522, lat:59.9139},
    {c:"Reykjavk, Iceland", lng:-21.8277, lat:64.1265},
    {c:"Moscow, Russia",     lng:37.6173, lat:55.7558},
    {c:"Istanbul, Trkiye",  lng:28.9784, lat:41.0082},
    {c:"Athens, Greece",     lng:23.7275, lat:37.9838},
    {c:"Cairo, Egypt",       lng:31.2357, lat:30.0444},
    {c:"Nairobi, Kenya",     lng:36.8219, lat:-1.2921},
    {c:"Lagos, Nigeria",     lng:3.3792, lat:6.5244},
    {c:"Johannesburg, SA",   lng:28.0473, lat:-26.2041},
    {c:"Cape Town, SA",      lng:18.4241, lat:-33.9249},
    {c:"Dubai, UAE",         lng:55.2708, lat:25.2048},
    {c:"Mumbai, India",      lng:72.8777, lat:19.0760},
    {c:"Delhi, India",       lng:77.1025, lat:28.7041},
    {c:"Bangkok, Thailand",  lng:100.5018, lat:13.7563},
    {c:"Singapore",          lng:103.8198, lat:1.3521},
    {c:"Hong Kong, China",   lng:114.1694, lat:22.3193},
    {c:"Tokyo, Japan",       lng:139.6917, lat:35.6895},
    {c:"Seoul, South Korea", lng:126.9780, lat:37.5665},
    {c:"Sydney, Australia",  lng:151.2093, lat:-33.8688},
    {c:"Brisbane, Australia",lng:153.0251, lat:-27.4698},
    {c:"Auckland, New Zealand", lng:174.7633, lat:-36.8485},
    {c:"Toronto, Canada",    lng:-79.3832, lat:43.6532},
    {c:"Vancouver, Canada",  lng:-123.1207, lat:49.2827},
    {c:"Mexico City, Mexico",lng:-99.1332, lat:19.4326},
    {c:"So Paulo, Brazil",  lng:-46.6333, lat:-23.5505},
    {c:"Rio de Janeiro, Brazil", lng:-43.1729, lat:-22.9068},
    {c:"Buenos Aires, Argentina", lng:-58.3816, lat:-34.6037},
    {c:"Santiago, Chile",    lng:-70.6693, lat:-33.4489}
  ];

  // Generate ~900 posts across hubs with small jitter to spread within cities
  const TOTAL_WORLD = 900;
  for(let i=0;i<TOTAL_WORLD;i++){
    const hub = hubs[Math.floor(rnd()*hubs.length)];
    const jitter = ()=> (rnd()-0.5) * 0.2; // ~0.2 degrees spread (~20km)
    const cat = pick(categories);
    const sub = pick(cat.subs);
    const id = 'WW'+i;
    const title = `${id} ${uniqueTitle(i*9343+19, hub.c, i)}`;
    const created = new Date().toISOString().replace(/[:.]/g,'-');
    out.push({
      id,
      title,
      slug: slugify(title),
      created,
      city: hub.c,
      lng: hub.lng + jitter(),
      lat: hub.lat + jitter(),
      category: cat.name,
      subcategory: sub,
      dates: randomDates(),
      sponsored: true, // All posts are sponsored for development
      fav:false,
      desc: randomText(),
      images: randomImages(id),
      locations: randomLocations(hub.c, hub.lng, hub.lat),
      member: { username: randomUsername(id), avatar: randomAvatar(id) },
    });
  }
  return out;
}


    let postsLoaded = window.postsLoaded || false;
    window.postsLoaded = postsLoaded;
    function loadPosts(){
      if(postsLoaded) return;
      posts = makePosts().filter(p => Number.isFinite(p.lng) && Number.isFinite(p.lat));
      postsLoaded = true;
      window.postsLoaded = postsLoaded;
      if(Object.keys(subcategoryMarkers).length) addPostSource();
      initAdBoard();
      applyFilters();
    }

    function checkLoadPosts(){
      if(!map) return;
      if(!postsLoaded) loadPosts();
      if(postsLoaded && Object.keys(subcategoryMarkers).length) addPostSource();
      applyFilters();
    }

    const resultsEl = $('#results');
    const postsWideEl = $('.post-board');
    const postsModeEl = $('.post-board');

    let sortedPostList = [];
    let renderedPostCount = 0;
    let postBatchObserver = null;
    let postSentinel = null;
    const INITIAL_RENDER_COUNT = 50;
    const POST_BATCH_SIZE = 25;

    function appendPostBatch(count = POST_BATCH_SIZE){
      const slice = sortedPostList.slice(renderedPostCount, renderedPostCount + count);
      slice.forEach(p => {
        if(resultsEl){
          const rCard = card(p);
          if(activePostId && p.id === activePostId) rCard.setAttribute('aria-selected','true');
          resultsEl.appendChild(rCard);
        }
        const wCard = card(p, true);
        postsWideEl.insertBefore(wCard, postSentinel);
      });
      renderedPostCount += slice.length;
      if(renderedPostCount >= sortedPostList.length){
        if(postBatchObserver) postBatchObserver.disconnect();
        postsWideEl.removeEventListener('scroll', onPostBoardScroll);
      }
      prioritizeVisibleImages();
    }

    function onPostBoardScroll(){
      if(postsWideEl.scrollTop + postsWideEl.clientHeight >= postsWideEl.scrollHeight - 200){
        appendPostBatch();
      }
    }

    // Image helpers (unique per post)
    function isPortrait(id){ let h=0; for(let i=0;i<id.length;i++){ h=(h<<5)-h+id.charCodeAt(i); h|=0; } return Math.abs(h)%2===0; }
    function imgThumb(pOrId){ const id = typeof pOrId==='string' ? pOrId : pOrId.id; const port=isPortrait(id); return `https://picsum.photos/seed/${encodeURIComponent(id)}-t/${port?'200/300':'300/200'}`; }
    function imgHero(pOrId){  const id = typeof pOrId==='string' ? pOrId : pOrId.id;  const port=isPortrait(id); return `https://picsum.photos/seed/${encodeURIComponent(id)}-t/${port?'800/1200':'1200/800'}`; }

    function memberAvatarUrl(p){
      if(p.member && p.member.avatar){
        return p.member.avatar;
      }
      return 'assets/balloons/balloons-icon-16185.png';
    }

    function hoverHTML(p){
      return `<div class="hover-card" data-id="${p.id}"><img src="${imgThumb(p)}" alt="" referrerpolicy="no-referrer"/><div><div class="t">${p.title}</div><div class="s">${p.city}</div></div></div>`;
    }

    // Categories UI
    const catsEl = $('#cats');
    categories.forEach(c=>{
      const el = document.createElement('div'); el.className='cat'; el.setAttribute('role','group'); el.setAttribute('aria-expanded','false');
      const bar = document.createElement('div'); bar.className='bar';
      const dot = document.createElement('div'); dot.className='dot'; dot.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 5v14M5 12h14"/></svg>';
      const label = document.createElement('div'); label.className='label'; label.textContent=c.name;
      const cfg = document.createElement('div'); cfg.className='cfg'; cfg.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 7h16M7 12h10M10 17h4"/></svg>';
      const sub = document.createElement('div'); sub.className='sub';
      c.subs.forEach(s=>{ const chip=document.createElement('div'); chip.className='chip'; chip.innerHTML='<span class="badge"></span>'+s; chip.addEventListener('click',()=>{ chip.classList.toggle('on'); const key=c.name+'::'+s; if(selection.subs.has(key)) selection.subs.delete(key); else selection.subs.add(key); applyFilters(); }); sub.appendChild(chip); });
      bar.appendChild(dot); bar.appendChild(label);
      bar.addEventListener('click',()=>{ const ex = el.getAttribute('aria-expanded')==='true'; el.setAttribute('aria-expanded',ex?'false':'true'); if(ex){ selection.cats.delete(c.name); } else { selection.cats.add(c.name); } applyFilters(); });
      el.appendChild(bar); el.appendChild(cfg); el.appendChild(sub); catsEl.appendChild(el);
    });

    // Reset
    $('#resetBtn').addEventListener('click',()=>{
      selection.cats.clear(); selection.subs.clear();
      $$('.cat').forEach(el=>el.setAttribute('aria-expanded','false'));
      $$('.chip.on').forEach(ch=>ch.classList.remove('on'));
      $('#keyword-textbox').value='';
      $('#daterange-textbox').value='';
      const expired = $('#expiredToggle');
      if(expired){
        expired.checked = false;
        expiredWasOn = false;
      }
      dateStart = null;
      dateEnd = null;
      buildFilterCalendar(today, maxPickerDate);
      updateRangeClasses();
      updateInput();
      if(geocoder) geocoder.clear();
      applyFilters();
      updateClearButtons();
    });

    function updateClearButtons(){
      const kw = $('#keyword-textbox');
      const kwX = kw.parentElement.querySelector('.keyword-clear-button');
      kwX && kwX.classList.toggle('active', kw.value.trim() !== '');
      const date = $('#daterange-textbox');
      const dateX = date.parentElement.querySelector('.daterange-clear-button');
      const hasDate = (dateStart || dateEnd) || $('#expiredToggle').checked;
      dateX && dateX.classList.toggle('active', !!hasDate);
      updateResetBtn();
    }

    function nonLocationFiltersActive(){
      const kw = $('#keyword-textbox').value.trim() !== '';
      const raw = $('#daterange-textbox').value.trim();
      const hasDate = !!(dateStart || dateEnd || raw);
      const expired = $('#expiredToggle').checked;
      return kw || hasDate || expired;
    }

    function updateResetBtn(){
      const active = nonLocationFiltersActive() || selection.cats.size > 0 || selection.subs.size > 0;
      document.body.classList.toggle('filters-active', active);
      const reset = $('#resetBtn');
      reset && reset.classList.toggle('active', active);
    }

    function fmtShort(iso){
      return parseISODate(iso).toLocaleDateString('en-GB', {weekday:'short', day:'numeric', month:'short'}).replace(/,/g,'');
    }

    $('#keyword-textbox').addEventListener('input', ()=>{ applyFilters(); updateClearButtons(); });
    $('#daterange-textbox').addEventListener('input', ()=>{ applyFilters(); updateClearButtons(); });
    $('#daterange-textbox').addEventListener('keydown', e=>{
      const scroll = $('#datePickerContainer');
      if(e.key==='ArrowLeft' || e.key==='ArrowRight'){
        const month = scroll.querySelector('.month');
        const w = month ? month.offsetWidth : 0;
        scroll.scrollBy({left:e.key==='ArrowLeft'?-w:w, behavior:'smooth'});
      }
      e.preventDefault();
    });
    const today = new Date();
    today.setHours(0,0,0,0);
    const minPickerDate = new Date(today);
    minPickerDate.setMonth(minPickerDate.getMonth() - 12);
    const maxPickerDate = new Date(today);
    maxPickerDate.setFullYear(maxPickerDate.getFullYear() + 2);
    const expiredToggle = $('#expiredToggle');
    const calendarScroll = $('#datePickerContainer');

    function verticalCanScroll(el, delta){
      if(!el) return false;
      if(delta < 0) return el.scrollTop > 0;
      if(delta > 0) return el.scrollTop < el.scrollHeight - el.clientHeight;
      return false;
    }

    function setupHorizontalWheel(scroller){
      if(!scroller) return;
      scroller.addEventListener('wheel', e=>{
        const delta = Math.abs(e.deltaX) > Math.abs(e.deltaY) ? e.deltaX : e.deltaY;
        if(delta !== 0){
          scroller.scrollLeft += delta;
          e.preventDefault();
        }
      }, {passive:false});
    }

    function smoothScroll(el, to, duration=600){
      const start = el.scrollLeft;
      const change = to - start;
      const startTime = performance.now();
      function animate(time){
        const elapsed = time - startTime;
        const progress = Math.min(elapsed / duration, 1);
        el.scrollLeft = start + change * progress;
        if(progress < 1) requestAnimationFrame(animate);
      }
      requestAnimationFrame(animate);
    }

    function setupCalendarScroll(scroller){
      if(!scroller) return;
      scroller.setAttribute('tabindex','0');
      setupHorizontalWheel(scroller);
      const container = scroller.closest('.calendar-container');
      const adjustScale = () => {
        if(!container) return;
        const base = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--calendar-width')) || 0;
        const available = container.parentElement ? container.parentElement.clientWidth : container.clientWidth;
        const scale = base ? Math.min(1, available / base) : 1;
        container.style.setProperty('--calendar-scale', scale);
      };
      if('ResizeObserver' in window && container){
        const ro = new ResizeObserver(adjustScale);
        ro.observe(container);
      }
      adjustScale();
      scroller.addEventListener('keydown', e=>{
        if(e.key==='ArrowLeft' || e.key==='ArrowRight'){
          const m = scroller.querySelector('.month') || scroller.querySelector('.month-item');
          const w = m ? m.offsetWidth : 0;
          scroller.scrollLeft += e.key==='ArrowLeft'?-w:w;
          e.preventDefault();
        }
      });
      let t;
      scroller.addEventListener('scroll', ()=>{
        const marker = scroller.querySelector('.today-marker');
        if(marker){
          const base = parseFloat(marker.dataset.pos || '0');
          marker.style.left = `${base + Math.round(scroller.scrollLeft)}px`;
        }
        if(t) clearTimeout(t);
        t = setTimeout(()=>{
          const m = scroller.querySelector('.month') || scroller.querySelector('.month-item');
          const w = m ? m.offsetWidth : 0;
          if(w){
            const max = scroller.scrollWidth - scroller.clientWidth;
            let target;
            if(scroller.scrollLeft >= max - 1){
              target = max;
            } else {
              const i = Math.round(scroller.scrollLeft / w);
              target = w*i;
            }
            smoothScroll(scroller, target, 600);
          }
        },100);
      });
    }
    setupCalendarScroll(calendarScroll);
    expiredWasOn = expiredToggle && expiredToggle.checked;

    function scrollCalendarToToday(behavior='auto'){
      const calScroll = $('#datePickerContainer');
      if(!calScroll) return;
      const todayCell = calScroll.querySelector('.day.today');
      if(todayCell){
        const month = todayCell.closest('.month');
        const left = month ? month.offsetLeft : 0;
        calScroll.dataset.todayScroll = left;
        calScroll.scrollTo({left, behavior});
        const marker = calScroll.querySelector('.today-marker');
        if(marker){
          const base = parseFloat(marker.dataset.pos || '0');
          marker.style.left = `${base + left}px`;
        }
      }
    }
    window.scrollCalendarToToday = scrollCalendarToToday;

    function formatDisplay(date){
      const wd = date.toLocaleDateString('en-GB',{weekday:'short'});
      const day = date.getDate();
      const mon = date.toLocaleDateString('en-GB',{month:'short'});
      let str = `${wd} ${day} ${mon}`;
      if(date.getFullYear() !== today.getFullYear()) str += `, ${date.getFullYear()}`;
      return str;
    }

    function orderedRange(){
      if(dateStart && dateEnd){
        return dateStart <= dateEnd ? {start:dateStart,end:dateEnd} : {start:dateEnd,end:dateStart};
      }
      return {start:dateStart,end:dateEnd};
    }

    function sameDay(a,b){ return a.toDateString()===b.toDateString(); }
    function isToday(d){ return sameDay(d,today); }

    function updateRangeClasses(){
      const {start,end} = orderedRange();
      $('#datePicker').querySelectorAll('.day').forEach(day=>{
        const iso = day.dataset.iso;
        if(!iso) return;
        const [yy, mm, dd] = iso.split('-').map(Number);
        const d = new Date(yy, mm - 1, dd);
        day.classList.remove('selected','in-range','range-start','range-end');
        if(start && sameDay(d, start)) day.classList.add('selected','range-start');
        if(end && sameDay(d, end)) day.classList.add('selected','range-end');
        if(start && end && d>start && d<end) day.classList.add('in-range');
      });
    }

    function updateInput(){
      const input = $('#daterange-textbox');
      const {start,end} = orderedRange();
      if(start && end){
        input.value = `${formatDisplay(start)} - ${formatDisplay(end)}`;
      } else if(start){
        input.value = formatDisplay(start);
      } else {
        input.value = '';
      }
      applyFilters();
      updateClearButtons();
    }

    function selectRangeDate(date){
      if(!dateStart || dateEnd){ dateStart = date; dateEnd = null; }
      else { dateEnd = date; }
      updateRangeClasses();
      updateInput();
    }

    function buildFilterCalendar(minDate, maxDate){
      const container = $('#datePicker');
      container.innerHTML='';
      const cal = document.createElement('div');
      cal.className='calendar';
      let current = new Date(minDate.getFullYear(), minDate.getMonth(),1);
      const end = new Date(maxDate.getFullYear(), maxDate.getMonth(),1);
      const todayDate = new Date();
      todayDate.setHours(0,0,0,0);
      let monthIndex = 0;
      let currentMonthIndex = 0;
      while(current <= end){
        const monthEl = document.createElement('div');
        monthEl.className='month';
        const header = document.createElement('div');
        header.className='calendar-header';
        header.textContent=current.toLocaleDateString('en-GB',{month:'long',year:'numeric'});
        monthEl.appendChild(header);
        const grid = document.createElement('div');
        grid.className='grid';

        const weekdays=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        weekdays.forEach(wd=>{
          const w=document.createElement('div');
          w.className='weekday';
          w.textContent=wd;
          grid.appendChild(w);
        });

        const firstDay = new Date(current.getFullYear(), current.getMonth(),1);
        const startDow = firstDay.getDay();
        const daysInMonth = new Date(current.getFullYear(), current.getMonth()+1,0).getDate();
        const totalCells = 42;
        for(let i=0;i<totalCells;i++){
          const cell=document.createElement('div');
          cell.className='day';
          const dayNum=i-startDow+1;
          if(i<startDow || dayNum>daysInMonth){
            cell.classList.add('empty');
          }else{
            cell.textContent=dayNum;
            const date=new Date(current.getFullYear(), current.getMonth(), dayNum);
            cell.dataset.iso = toISODate(date);
            if(date < todayDate) cell.classList.add('past');
            else cell.classList.add('future');
            if(isToday(date)) cell.classList.add('today');
            if(date >= minDate) cell.addEventListener('click', ()=> selectRangeDate(date));
          }
          grid.appendChild(cell);
        }
        monthEl.appendChild(grid);
        cal.appendChild(monthEl);
        if(current.getFullYear() === todayDate.getFullYear() && current.getMonth() === todayDate.getMonth()){
          currentMonthIndex = monthIndex;
        }
        current.setMonth(current.getMonth()+1);
        monthIndex++;
      }
      container.appendChild(cal);
      updateRangeClasses();
      if(calendarScroll){
        const monthWidth = cal.querySelector('.month').offsetWidth;
        const scrollPos = monthWidth * currentMonthIndex;
        const maxScroll = calendarScroll.scrollWidth - calendarScroll.clientWidth;
        const track = calendarScroll.clientWidth - 20;
        const pos = maxScroll ? scrollPos / maxScroll * track + 10 : 10;
        calendarScroll.querySelector('.today-marker')?.remove();
        const marker = document.createElement('div');
        marker.className = 'today-marker';
        marker.dataset.pos = pos;
        calendarScroll.appendChild(marker);
        marker.addEventListener('click', ()=> scrollCalendarToToday('smooth'));
      }
    }

    buildFilterCalendar(today, maxPickerDate);

    $$('#filterPanel .keyword-clear-button, #filterPanel .daterange-clear-button').forEach(btn=> btn.addEventListener('click',()=>{
      const input = btn.parentElement.querySelector('input');
      if(input){
        if(input.id==='daterange-textbox'){
          dateStart = null;
          dateEnd = null;
          updateRangeClasses();
          updateInput();
        } else {
          input.value='';
        }
        input.focus();
        applyFilters();
        updateClearButtons();
      }
    }));
    if(expiredToggle){
      expiredToggle.addEventListener('change', ()=>{
        const input = $('#daterange-textbox');
        const todayDate = new Date();
        todayDate.setHours(0,0,0,0);
        dateStart = null;
        dateEnd = null;
        if(expiredToggle.checked){
          buildFilterCalendar(minPickerDate, maxPickerDate);
        } else {
          buildFilterCalendar(todayDate, maxPickerDate);
        }
        expiredWasOn = expiredToggle.checked;
        updateRangeClasses();
        updateInput();
      });
      if(expiredToggle.checked){
        expiredToggle.dispatchEvent(new Event('change'));
      }
    }
    updateClearButtons();
    updateResetBtn();
    const optionsBtn = $('#optionsBtn');
    const optionsMenu = $('#optionsMenu');
    const favToggle = $('#favToggle');
    const sortButtons = $$('.sort-option');

    function updateSortBtnLabel(text){
      const hasMultiple = optionsMenu.querySelectorAll('button').length > 1;
      if(hasMultiple){
        optionsBtn.innerHTML = `${text}<span class="results-arrow" aria-hidden="true"></span>`;
      } else {
        optionsBtn.textContent = text;
      }
    }

    updateSortBtnLabel(optionsBtn.textContent);

    favToggle.addEventListener('click', ()=>{
      favToTop = !favToTop;
      favToggle.setAttribute('aria-pressed', favToTop);
      renderLists(filtered);
    });

    sortButtons.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        currentSort = btn.dataset.sort;
        sortButtons.forEach(b=> b.setAttribute('aria-pressed', b===btn ? 'true' : 'false'));
        updateSortBtnLabel(btn.textContent);
        renderLists(filtered);
      });
    });

    optionsBtn.addEventListener('click', e=>{
      e.stopPropagation();
      const open = !optionsMenu.hasAttribute('hidden');
      if(open){
        optionsMenu.setAttribute('hidden','');
        optionsBtn.setAttribute('aria-expanded','false');
      } else {
        optionsMenu.removeAttribute('hidden');
        optionsBtn.setAttribute('aria-expanded','true');
      }
    });
    optionsMenu.addEventListener('click', e=> e.stopPropagation());
      document.addEventListener('click', ()=>{
        optionsMenu.setAttribute('hidden','');
        optionsBtn.setAttribute('aria-expanded','false');
      });

      const historyBtn = $('#historyBtn');
      const historyBoard = $('#historyBoard');
      const adBoard = $('.ad-board');
      const boardsContainer = $('.post-mode-boards');
      const postBoard = $('.post-board');
      function adjustBoards(){
        const small = window.innerWidth < 1200;
        const historyActive = document.body.classList.contains('show-history');
        if(small){
          document.body.classList.add('hide-ads');
          boardsContainer.style.justifyContent = 'center';
          postBoard.style.marginLeft = '';
          postBoard.style.marginRight = '';
        } else {
          if(document.body.classList.contains('mode-map')){
            document.body.classList.add('hide-ads');
          } else {
            document.body.classList.remove('hide-ads');
          }
          const adsHidden = document.body.classList.contains('hide-ads');
          boardsContainer.style.justifyContent = adsHidden ? 'flex-start' : 'center';
          postBoard.style.marginLeft = '';
          postBoard.style.marginRight = '';
        }
        if(historyBoard){
          historyBoard.style.display = historyActive ? '' : 'none';
          historyBoard.setAttribute('aria-hidden', historyActive ? 'false' : 'true');
        }
        adBoard.setAttribute('aria-hidden', document.body.classList.contains('hide-ads') ? 'true' : 'false');
        historyBtn && historyBtn.setAttribute('aria-pressed', historyActive ? 'true' : 'false');
      }
      adjustBoards();
      window.addEventListener('resize', adjustBoards);
      window.adjustListHeight();
        setTimeout(()=>{
          if(map && typeof map.resize === 'function'){
            map.resize();
            updatePostPanel();
            applyFilters();
          }
        }, 0);

      historyBtn && historyBtn.addEventListener('click', ()=>{
        const active = document.body.classList.toggle('show-history');
        if(active){
          renderHistoryBoard();
        }
        adjustBoards();
        window.adjustListHeight();
        setTimeout(()=>{
          if(map && typeof map.resize === 'function'){
            map.resize();
            updatePostPanel();
          }
        }, 310);
      });

      const resLists = $$('.history-board');
      resLists.forEach(list=>{
        list.addEventListener('click', e=>{
          const cardEl = e.target.closest('.quick-card');
          if(cardEl){
            const id = cardEl.getAttribute('data-id');
            if(id) { stopSpin(); openPost(id, true); }
          }
        });
      });

      const postsWide = $('.post-board');
      postsWide && postsWide.addEventListener('click', e=>{
        const cardEl = e.target.closest('.post-card');
        if(cardEl){
          const id = cardEl.getAttribute('data-id');
          if(id){ stopSpin(); openPost(id); }
          return;
        }
        if(e.target === postsWide && postsWide.querySelector('.open-post')){
          setMode('map');
        }
      });


      function setMode(m, skipFilters = false){
        mode = m;
        document.body.classList.remove('mode-map','mode-posts','hide-posts-ui');
        document.body.classList.add('mode-'+m);
          if(m==='map'){
            document.body.classList.add('hide-ads');
            document.body.classList.remove('show-history');
            const historyBoardEl = document.getElementById('historyBoard');
            if(historyBoardEl){
              historyBoardEl.style.display = 'none';
              historyBoardEl.setAttribute('aria-hidden','true');
            }
            const historyBtnEl = document.getElementById('historyBtn');
            if(historyBtnEl){
              historyBtnEl.setAttribute('aria-pressed','false');
            }
          } else {
            document.body.classList.remove('hide-ads');
          }
        adjustBoards();
        if(m === 'posts'){
          const boardEl = document.querySelector('.post-board');
          if(boardEl){
            boardEl.style.width = '';
          }
          if(window.adjust){
            window.adjust();
          }
        }
        const toggle = $('#postBtn');
        if(toggle){
          toggle.textContent = m === 'map' ? 'Show Posts' : 'Show Map';
          toggle.setAttribute('aria-pressed', m === 'posts');
        }
        if(map){
          if(typeof map.resize === 'function'){
            map.resize();
          }
          updatePostPanel();
        }
        if(m==='posts'){
          spinEnabled = false;
          localStorage.setItem('spinGlobe','false');
          stopSpin();
        }
        if(!skipFilters) applyFilters();
      }
    window.setMode = setMode;
    $('#postBtn').addEventListener('click',()=> setMode(mode === 'map' ? 'posts' : 'map'));

    // Mapbox
    function loadMapbox(cb){
      if(window.mapboxgl && window.MapboxGeocoder) return cb();

      let cssLoaded = 0;
      const onCss = () => { if(++cssLoaded === 2) loadScripts(); };

      function injectCleanCSS(url, fallback){
        fetch(url).then(r=>r.text()).then(css=>{
          css = css.replace(/-ms-high-contrast/g,'forced-colors');
          const style = document.createElement('style');
          style.textContent = css;
          document.head.appendChild(style);
          const link = document.createElement('link');
          link.rel='stylesheet';
          link.href = url;
          link.onload = onCss;
          link.onerror = ()=>{
            const lf = document.createElement('link');
            lf.rel='stylesheet';
            lf.href = fallback || url;
            lf.onload = onCss;
            lf.onerror = onCss;
            document.head.appendChild(lf);
          };
          document.head.appendChild(link);
        }).catch(()=>{
          const link = document.createElement('link');
          link.rel='stylesheet';
          link.href = fallback || url;
          link.onload = onCss;
          link.onerror = onCss;
          document.head.appendChild(link);
        });
      }

      injectCleanCSS('https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.css',
        'https://unpkg.com/mapbox-gl@3.14.0/dist/mapbox-gl.css');
      injectCleanCSS('https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css',
        'https://unpkg.com/@mapbox/mapbox-gl-geocoder@5.0.0/dist/mapbox-gl-geocoder.css');

      function loadScripts(){
        const s = document.createElement('script');
        s.src='https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.js';
        s.onload = ()=>{
          const g = document.createElement('script');
          g.src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js';
          g.onload = cb;
          g.onerror = ()=>{
            const gf = document.createElement('script');
            gf.src='https://unpkg.com/@mapbox/mapbox-gl-geocoder@5.0.0/dist/mapbox-gl-geocoder.min.js';
            gf.onload = cb;
            gf.onerror = cb;
            document.head.appendChild(gf);
          };
          document.head.appendChild(g);
        };
        s.onerror = cb;
        document.head.appendChild(s);
      }
    }
    loadMapbox(initMap);

    function addControls(){
      if(typeof MapboxGeocoder === 'undefined'){
        const script = document.createElement('script');
        script.src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js';
        script.onload = addControls;
    script.onerror = ()=> console.error('Mapbox Geocoder failed to load');
    document.head.appendChild(script);
    return;
  }
  const cssLink = document.querySelector('link[href*="mapbox-gl.css"], link[href*="mapbox-gl@"]');
  if(!cssLink || !cssLink.sheet){
    setTimeout(addControls, 50);
    return;
  }
  const sets = [
    {geo:'#geocoder-welcome', locate:'#geolocate-welcome', compass:'#compass-welcome'},
    {geo:'#geocoder-map', locate:'#geolocate-map', compass:'#compass-map'},
    {geo:'#geocoder-filter', locate:'#geolocate-filter', compass:'#compass-filter'},
    {geo:'#geocoder-member', locate:'#geolocate-member', compass:'#compass-member'}
      ];
      sets.forEach((sel, idx)=>{
        const gc = new MapboxGeocoder({
          accessToken: mapboxgl.accessToken,
          mapboxgl,
          marker:false,
          placeholder:'Location',
          reverseGeocode:true,
          collapsed:false,
          flyTo:false
        });
        gc.on('result', (e)=>{
          spinEnabled = false;
          localStorage.setItem('spinGlobe','false');
          stopSpin();
          if(mode!=='map') setMode('map');
          if(map){
            map.jumpTo({ center: e.result.center, zoom: Math.max(map.getZoom(), 12) });
          }
          gc.clear();
        });
        const gEl = document.querySelector(sel.geo);
        if(gEl){
          gEl.appendChild(gc.onAdd(map));
          const input = gEl.querySelector('input[type="text"]');
          if(input) input.setAttribute('autocomplete','street-address');
        }
        geocoders.push(gc);
        if(idx===1) geocoder = gc;
        const geolocate = new mapboxgl.GeolocateControl({ positionOptions:{ enableHighAccuracy:true }, trackUserLocation:false });
        geolocate.on('geolocate', (e)=>{
          spinEnabled = false; localStorage.setItem('spinGlobe','false'); stopSpin();
          if(mode!=='map') setMode('map');
          map.flyTo({
            center:[e.coords.longitude, e.coords.latitude],
            zoom: Math.max(map.getZoom(), 12),
            pitch:45,
            essential:true
          });
        });
        const geoHolder = document.querySelector(sel.locate);
        if(geoHolder) geoHolder.appendChild(geolocate.onAdd(map));
        const nav = new mapboxgl.NavigationControl({showZoom:false});
        const compassHolder = document.querySelector(sel.compass);
        if(compassHolder) compassHolder.appendChild(nav.onAdd(map));
      });
    }

    function initMap(){
      if(typeof mapboxgl === 'undefined'){
        console.error('Mapbox GL failed to load');
        return;
      }
          mapboxgl.accessToken = MAPBOX_TOKEN;
          map = new mapboxgl.Map({
            container:'map',
            style: mapStyle,
            projection:'globe',
            center: startCenter,
            zoom: startZoom,
            pitch: startPitch,
            bearing: startBearing,
            attributionControl:true
          });
        map.on('styleimagemissing', (e)=>{
          const svg = subcategoryMarkers[e.id];
          if(svg){
            const img = new Image();
            img.onload = () => { if(!map.hasImage(e.id)) map.addImage(e.id, img); };
            img.onerror = err => console.warn('load image failed', e.id, err);
            img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
          }else{
            console.warn('Unknown image ID:', e.id);
          }
        });
      map.on('zoomend', checkLoadPosts);
      addControls();
      try{
        map.scrollZoom.setWheelZoomRate(1/240);
        map.scrollZoom.setZoomRate(1/240);
      }catch(e){}
      map.on('style.load', () => {
            if(!map.getSource('terrain-dem')){
              map.addSource('terrain-dem', {
                type:'raster-dem',
                url:'mapbox://mapbox.terrain-rgb',
                tileSize:512,
                maxzoom:14
              });
            }
            map.setTerrain({source:'terrain-dem'});
            applySky(skyStyle);
          });
      map.on('load', ()=>{
        $$('.map-overlay').forEach(el=>el.remove());
        if(spinEnabled){
          startSpin(true);
        }
        updatePostPanel();
        applyFilters();
        checkLoadPosts();
      });

        ['mousedown','wheel','touchstart','dragstart','pitchstart','rotatestart','zoomstart'].forEach(ev=> map.on(ev, haltSpin));
        map.on('pitch', () => {
          const pIn = document.getElementById('mapPitch');
          const pVal = document.getElementById('pitchVal');
          if(pIn) pIn.value = map.getPitch();
          if(pVal) pVal.textContent = map.getPitch().toFixed(0);
        });
        map.on('rotate', () => {
          const bIn = document.getElementById('mapBearing');
          const bVal = document.getElementById('bearingVal');
          if(bIn) bIn.value = map.getBearing();
          if(bVal) bVal.textContent = map.getBearing().toFixed(0);
        });
        map.on('move', updateFilterCounts);
        const refreshMapView = () => {
          updateFilterCounts();
          refreshMarkers();
          updatePostPanel();
          const center = map.getCenter().toArray();
          const zoom = map.getZoom();
          const pitch = map.getPitch();
          const bearing = map.getBearing();
          localStorage.setItem('mapView', JSON.stringify({center, zoom, pitch, bearing}));
        };
        ['moveend','zoomend','rotateend','pitchend'].forEach(ev => map.on(ev, refreshMapView));
        map.on('dragend', () => { if(geocoder) geocoder.clear(); });
        map.on('click', () => {
          if(mode === 'posts') setMode('map');
        });
      }

    function startSpin(fromCurrent=false){
      if(mode!=='map') setMode('map');
      if(!spinEnabled || spinning || !map) return;
      if(map.getZoom() >= 3) return;
      if(typeof filterPanel !== 'undefined' && filterPanel) closePanel(filterPanel);
      spinning = true;
      historyWasActive = document.body.classList.contains('show-history');
      if(historyWasActive){
        document.body.classList.remove('show-history');
        const historyBtnEl = document.getElementById('historyBtn');
        const historyBoardEl = document.getElementById('historyBoard');
        if(historyBtnEl) historyBtnEl.setAttribute('aria-pressed','false');
        if(historyBoardEl) historyBoardEl.setAttribute('aria-hidden','true');
      }
      function step(){
        if(!spinning || !map) return;
        const c = map.getCenter();
        map.setCenter([c.lng + spinSpeed, c.lat]);
        requestAnimationFrame(step);
      }
      if(fromCurrent){
        requestAnimationFrame(step);
      }else{
        map.easeTo({center:[0,0], zoom:startZoom, pitch:0, essential:true});
        map.once('moveend', () => requestAnimationFrame(step));
      }
    }
    function stopSpin(){
      spinning = false;
      const wasHistory = historyWasActive;
      historyWasActive = false;
      if(wasHistory){
        document.body.classList.add('show-history');
        const historyBtnEl = document.getElementById('historyBtn');
        const historyBoardEl = document.getElementById('historyBoard');
        if(historyBtnEl) historyBtnEl.setAttribute('aria-pressed','true');
        if(historyBoardEl) historyBoardEl.setAttribute('aria-hidden','false');
      }
      applyFilters();
    }

    function haltSpin(e){
      const target = (e && e.originalEvent && e.originalEvent.target) || (e && e.target);
      if(target instanceof Node && logoEls.some(el=>el.contains(target))) return;
      if(spinEnabled || spinning){
        spinEnabled = false;
        localStorage.setItem('spinGlobe','false');
        stopSpin();
      }
    }

    ['pointerdown','wheel','keydown','touchstart'].forEach(ev=>
      document.addEventListener(ev, haltSpin, {capture:true})
    );

    function updateSpinState(){
      const shouldSpin = spinLoadStart && (spinLoadType === 'all' || (spinLoadType === 'new' && firstVisit));
      if(shouldSpin !== spinEnabled){
        spinEnabled = shouldSpin;
        localStorage.setItem('spinGlobe', JSON.stringify(spinEnabled));
        if(spinEnabled) startSpin(); else stopSpin();
      }
    }

    window.spinGlobals = {
      get spinEnabled(){ return spinEnabled; },
      set spinEnabled(v){ spinEnabled = v; },
      get spinSpeed(){ return spinSpeed; },
      set spinSpeed(v){ spinSpeed = v; },
      get spinLoadStart(){ return spinLoadStart; },
      set spinLoadStart(v){ spinLoadStart = v; },
      get spinLoadType(){ return spinLoadType; },
      set spinLoadType(v){ spinLoadType = v; },
      get spinLogoClick(){ return spinLogoClick; },
      set spinLogoClick(v){ spinLogoClick = v; updateLogoClickState(); },
      startSpin,
      stopSpin,
      updateSpinState,
      updateLogoClickState
    };

    // Map layers
    function postsToGeoJSON(list){
      return {
        type:'FeatureCollection',
          features: list
            .filter(p => Number.isFinite(p.lng) && Number.isFinite(p.lat))
            .map(p => ({
              type:'Feature',
              properties:{id:p.id, title:p.title, city:p.city, cat:p.category, sub:(subcategoryMarkerIds[p.subcategory] || slugify(p.subcategory)), layer:'poi', sizerank:1},
              geometry:{type:'Point', coordinates:[p.lng, p.lat]}
            }))
        };
      }

    let addingPostSource = false;
    async function addPostSource(){
      if(!map || addingPostSource) return;
      addingPostSource = true;
      try{
      const layerIds = ['cluster-count','clusters','unclustered','posts-heat','hover-ring','hover-fill'];
      layerIds.forEach(id=>{ if(map.getLayer(id)) map.removeLayer(id); });
      const geojson = postsToGeoJSON(posts);
      const shouldCluster = posts.length > 1 && clusterRadius > 0;
      const existing = map.getSource('posts');
      const opts = existing && typeof existing.serialize === 'function' ? existing.serialize() : null;
      if(existing && opts && opts.cluster === shouldCluster && opts.clusterRadius === clusterRadius && opts.clusterMaxZoom === clusterMaxZoom){
        existing.setData(geojson);
      } else {
        if(existing) map.removeSource('posts');
        map.addSource('posts', { type:'geojson', data: geojson, cluster: shouldCluster, clusterRadius: clusterRadius, clusterMaxZoom: clusterMaxZoom });
      }
        await Promise.all(Object.entries(subcategoryMarkers).map(([sub, svg])=> new Promise(res=>{
          if(map.hasImage(sub)) map.removeImage(sub);
          const img = new Image();
          img.onload = () => { if(!map.hasImage(sub)) map.addImage(sub, img); res(); };
          img.onerror = err => { console.warn('load image failed', sub, err); res(); };
          img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
        })));
        map.addLayer({ id:'posts-heat', type:'heatmap', source:'posts', maxzoom:4, paint:{
        'heatmap-weight': 0.7, 'heatmap-intensity': 2.0, 'heatmap-radius': 40,
        'heatmap-color':[ 'interpolate',['linear'],['heatmap-density'], 0,'rgba(33,102,172,0)', 0.2,'rgba(103,169,207,.6)', 0.4,'rgba(209,229,240,.9)', 0.6,'rgba(253,219,146,.95)', 0.8,'rgba(239,138,98,.95)', 1,'rgba(178,24,43,.95)'] } });
      if(shouldCluster && clusterIconType === 'svg' && clusterSvg){
        const imgId = 'cluster-svg';
        if(map.hasImage(imgId)) map.removeImage(imgId);
        await new Promise(res=>{
          const img = new Image();
          img.onload = ()=>{ if(!map.hasImage(imgId)) map.addImage(imgId, img); res(); };
          img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(clusterSvg);
        });
          map.addLayer({ id:'clusters', type:'symbol', source:'posts', filter:['has','point_count'], layout:{ 'icon-image': imgId }, paint:{} });
          map.addLayer({ id:'cluster-count', type:'symbol', source:'posts', filter:['has','point_count'], layout:{ 'text-field':['get','point_count_abbreviated'], 'text-size':12 }, paint:{'text-color':'#fff'} });
            map.addLayer({ id:'unclustered', type:'symbol', source:'posts', filter:['!', ['has','point_count']], layout:{ 'icon-image':['get','sub'] }, paint:{} });
        } else if(shouldCluster){
          map.addLayer({ id:'clusters', type:'circle', source:'posts', filter:['has','point_count'], paint:{
            'circle-color': ['step',['get','point_count'], '#24c6dc', 20, '#514a9d', 50, '#f7797d', 100, '#fbd786'],
            'circle-radius': ['step',['get','point_count'], 16, 20, 22, 50, 28, 100, 34],
            'circle-opacity': 0.85, 'circle-stroke-color':'#0b1623', 'circle-stroke-width':1 } });
        map.addLayer({ id:'cluster-count', type:'symbol', source:'posts', filter:['has','point_count'], layout:{ 'text-field':['get','point_count_abbreviated'], 'text-size':12 }, paint:{'text-color':'#fff'} });
            map.addLayer({ id:'unclustered', type:'symbol', source:'posts', filter:['!', ['has','point_count']], layout:{ 'icon-image':['get','sub'] }, paint:{} });
        } else {
            map.addLayer({ id:'unclustered', type:'symbol', source:'posts', layout:{ 'icon-image':['get','sub'] }, paint:{} });
        }
      // === 0528: Rightclick cluster -> open scrollable list (locks map) ===
      // Close list on outside click or ESC
      map.on('click', (e)=>{
        if(!listLocked) return; if(Date.now() - lastListOpenAt < 200) return;
        // ignore the click that just opened it
        if(Date.now() - lastListOpenAt < 200) return;
        const el = hoverPopup && hoverPopup.getElement();
        if(!el) { lockMap(false); return; }
        const within = el.contains(e.originalEvent.target);
        if(!within){ hoverPopup.remove(); hoverPopup=null; lockMap(false); }
      });
      window.addEventListener('keydown', (ev)=>{ if(ev.key==='Escape' && listLocked){ if(hoverPopup){ hoverPopup.remove(); hoverPopup=null; } lockMap(false); } });
      // 0530: Rightclick a *venue marker* (unclustered point) -> show list of events at that venue
      map.on('contextmenu','unclustered', (e)=>{
        const f = e.features && e.features[0]; if(!f) return;
        if(e.preventDefault) e.preventDefault();
        const coords = f.geometry && f.geometry.coordinates; if(!coords || coords.length<2) return;
        const items = postsAtVenue(coords[0], coords[1]);
        if(!items || !items.length){ return; }
        openListPopupAtPoint(e.point, buildClusterListHTML(items));

        (function(){
          function consume(ev){ try{ ev.preventDefault(); }catch(e){} try{ ev.stopPropagation(); }catch(e){} }
          const _root = hoverPopup && hoverPopup.getElement ? hoverPopup.getElement() : null;
          if(_root){
            ['pointerdown','mousedown','mouseup','click'].forEach(t=> _root.addEventListener(t, consume, {capture:true}));
          }
        })();
    
        // Wire interactions
        const root = hoverPopup.getElement();
        const close = ()=>{ if(hoverPopup){ hoverPopup.remove(); hoverPopup=null; } lockMap(false); };
        root.addEventListener('click', (ev)=> ev.stopPropagation(), {capture:true});
        root.querySelectorAll('.multi-item.map-card').forEach(n => n.addEventListener('click', ()=>{
          const id = n.getAttribute('data-id'); close(); stopSpin(); openPost(id, false, true);
        }));
        const btn = root.querySelector('[data-act="close"]'); if(btn) btn.addEventListener('click', close);
        lockMap(true); lastListOpenAt = Date.now();
      });

      map.on('click','clusters', async (e)=>{
        stopSpin();
        const features = map.queryRenderedFeatures(e.point, { layers:['clusters'] });
        const clusterId = features[0].properties.cluster_id;
        const leaves = await getClusterLeavesAll('posts', clusterId);
        if(!leaves.length) return;
        const bounds = leaves.reduce((b,f)=> b.extend(f.geometry.coordinates), new mapboxgl.LngLatBounds(leaves[0].geometry.coordinates, leaves[0].geometry.coordinates));
        map.fitBounds(bounds, { padding: 40, pitch: 45, maxZoom: 18, essential: true });
      });
      
      map.on('click','unclustered', (e)=>{
        stopSpin();
        const f = e.features && e.features[0]; if(!f) return;
        const coords = f.geometry && f.geometry.coordinates;
        if(coords && coords.length>=2){
          const items = postsAtVenue(coords[0], coords[1]);
          if(items && items.length>1){
            if(e.preventDefault) e.preventDefault();
            if(e.originalEvent){ e.originalEvent.preventDefault(); e.originalEvent.stopPropagation(); }
            openListPopupAtPoint(e.point, buildClusterListHTML(items));
            const root = hoverPopup.getElement();
            const close = ()=>{ if(hoverPopup){ hoverPopup.remove(); hoverPopup=null; } lockMap(false); };
            root.addEventListener('click', (ev)=> ev.stopPropagation(), {capture:true});
            root.querySelectorAll('.multi-item.map-card').forEach(n => n.addEventListener('click', (e)=>{ e.stopPropagation(); const id = n.getAttribute('data-id'); close(); stopSpin(); openPost(id, false, true); }));
            const btn = root.querySelector('[data-act="close"]'); if(btn) btn.addEventListener('click', close);
            lockMap(true);
            (function(){
              const __root = hoverPopup && hoverPopup.getElement ? hoverPopup.getElement() : null;
              if(__root){
                __root.addEventListener('click', function(ev){
                  ev.stopPropagation();
                  var row = (ev.target && ev.target.closest) ? ev.target.closest('.multi-item.map-card') : null;
                  if(row){
                    var pid = row.getAttribute('data-id');
                    if(pid){ if(hoverPopup){ hoverPopup.remove(); hoverPopup=null; } lockMap(false); stopSpin(); openPost(pid, false, true); return; }
                  }
                }, {capture:true});
              }
            })();
 lastListOpenAt = Date.now();
            return;
          }
        }
        const id = f.properties.id;
        const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
        if(isTouch){
          if(touchMarker === id){
            touchMarker = null;
            if(hoverPopup){ hoverPopup.remove(); hoverPopup=null; }
            openPost(id, false, true);
            return;
          } else {
            touchMarker = id;
            if(hoverPopup) hoverPopup.remove();
            const p = posts.find(x=>x.id===id);
            if(p){
              hoverPopup = new mapboxgl.Popup({closeButton:false, closeOnClick:false, className:'hover-pop map-card'})
                .setLngLat(e.lngLat).setHTML(hoverHTML(p)).addTo(map);
              registerPopup(hoverPopup);
              const cardEl = hoverPopup.getElement().querySelector('.hover-card');
              if(cardEl){
                cardEl.addEventListener('click', (e)=>{ e.stopPropagation(); touchMarker=null; openPost(id, false, true); });
              }
            }
          }
        } else {
          openPost(id, false, true);
        }
      });

      map.on('click', e=>{
        const feats = map.queryRenderedFeatures(e.point);
        if(!feats.length){
          if(hoverPopup){ hoverPopup.remove(); hoverPopup=null; }
          touchMarker = null;
        }
      });

      // Hover ring layer for individual points
      map.addLayer({ id:'hover-ring', type:'circle', source:'posts', filter:['==',['get','id'],'__none__'], paint:{
        'circle-color': '#ffffff', 'circle-opacity': 0, 'circle-stroke-color':'#fff', 'circle-stroke-opacity':0.95,
        'circle-stroke-width': 2, 'circle-radius': 12
      }});

      // Cursor + popup for unclustered points
      
      map.on('mouseenter','unclustered', (e)=>{
        map.getCanvas().style.cursor = 'pointer';
        const f = e.features && e.features[0]; if(!f) return;
        const id = f.properties.id; hoverId = id;
        map.setFilter('hover-ring', ['==',['get','id'], id]);
        const coords = f.geometry && f.geometry.coordinates;
        const multi = (coords && coords.length>=2) ? postsAtVenue(coords[0], coords[1]) : null;
        if(multi && multi.length>1){
          openListPopupAtPoint(e.point, buildClusterListHTML(multi));

        (function(){
          function consume(ev){ try{ ev.preventDefault(); }catch(e){} try{ ev.stopPropagation(); }catch(e){} }
          const _root = hoverPopup && hoverPopup.getElement ? hoverPopup.getElement() : null;
          if(_root){
            ['pointerdown','mousedown','mouseup','click'].forEach(t=> _root.addEventListener(t, consume, {capture:true}));
          }
        })();
    
          
        (function(){
          const __root = hoverPopup && hoverPopup.getElement ? hoverPopup.getElement() : null;
          if(__root){
            __root.addEventListener('click', function(ev){
              ev.stopPropagation();
              var row = (ev.target && ev.target.closest) ? ev.target.closest('.multi-item.map-card') : null;
              if(row){
                var pid = row.getAttribute('data-id');
                if(pid){ if(hoverPopup){ hoverPopup.remove(); hoverPopup=null; } stopSpin(); openPost(pid, false, true); return; }
              }
            }, {capture:true});
          }
        })();
// keep the hover popup alive when the pointer enters it
          const _el = hoverPopup && hoverPopup.getElement ? hoverPopup.getElement() : null;
          if(_el){
            _el.addEventListener('mouseenter', ()=>{ window.__overCard = true; });
            _el.addEventListener('mouseleave', ()=>{ window.__overCard = false; if(!listLocked && hoverPopup){ hoverPopup.remove(); hoverPopup=null; } });
          }
        } else {
          // single preview as usual
          const p = posts.find(x=>x.id===id); if(!p) return;
          if(hoverPopup) hoverPopup.remove();
          hoverPopup = new mapboxgl.Popup({closeButton:false, closeOnClick:false, className:'hover-pop map-card'})
            .setLngLat(e.lngLat).setHTML(hoverHTML(p)).addTo(map);
          registerPopup(hoverPopup);

        (function(){
          function consume(ev){ try{ ev.preventDefault(); }catch(e){} try{ ev.stopPropagation(); }catch(e){} }
          const _root = hoverPopup && hoverPopup.getElement ? hoverPopup.getElement() : null;
          if(_root){
            ['pointerdown','mousedown','mouseup','click'].forEach(t=> _root.addEventListener(t, consume, {capture:true}));
          }
        })();
    
        
        (function(){
          const __el = hoverPopup && hoverPopup.getElement ? hoverPopup.getElement() : null;
          if(__el){
            __el.addEventListener('click', function(ev){
              ev.stopPropagation();
              try{ stopSpin(); openPost(id, false, true); }catch(e){ console.warn('openPost id missing', e); }
            }, {capture:true});
          }
        })();
}
      });
    
      map.on('mousemove','unclustered', (e)=>{ if(hoverPopup) hoverPopup.setLngLat(e.lngLat); });
      
      map.on('mouseleave','unclustered', ()=>{
        map.getCanvas().style.cursor = '';
        if(listLocked) return;
        setTimeout(()=>{
          if(!window.__overCard && hoverPopup){ hoverPopup.remove(); hoverPopup=null; }
        }, 180);
        hoverId = null; map.setFilter('hover-ring',['==',['get','id'],'__none__']);
      });


      // Popups for clusters (shows count)
      map.on('mouseenter','clusters', (e)=>{
        map.getCanvas().style.cursor='pointer';
        const f = e.features && e.features[0]; if(!f) return;
        const count = f.properties.point_count_abbreviated;
        if(hoverPopup) hoverPopup.remove();
        hoverPopup = new mapboxgl.Popup({closeButton:false, closeOnClick:false, className:'hover-pop map-card', offset:15})
          .setLngLat(e.lngLat).setHTML(`<div class='hover-card'><div class='t'>${count} nearby posts</div></div>`).addTo(map);
        const _el = hoverPopup && hoverPopup.getElement ? hoverPopup.getElement() : null;
        if(_el){ _el.style.pointerEvents = 'none'; }
        registerPopup(hoverPopup);
      });
      map.on('mousemove','clusters', (e)=>{ if(hoverPopup) hoverPopup.setLngLat(e.lngLat); });
        map.on('mouseleave','clusters', ()=>{ map.getCanvas().style.cursor=''; if(hoverPopup){ hoverPopup.remove(); hoverPopup=null; } });
      } catch (err) {
        console.error('addPostSource failed', err);
      } finally {
        addingPostSource = false;
      }
      }
      window.addPostSource = addPostSource;
    function renderLists(list){
      if(spinning || !postsLoaded) return;
      const sort = currentSort;
      const arr = list.slice();
      if(sort==='az') arr.sort((a,b)=> a.title.localeCompare(b.title));
      if(sort==='soon') arr.sort((a,b)=> a.dates[0].localeCompare(b.dates[0]));
      if(sort==='nearest'){
        let ref = {lng:0,lat:0}; if(map){ const c = map.getCenter(); ref = {lng:c.lng,lat:c.lat}; }
        arr.sort((a,b)=> distKm({lng:a.lng,lat:a.lat}, ref) - distKm({lng:b.lng,lat:b.lat}, ref));
      }
      if(favToTop) arr.sort((a,b)=> (b.fav - a.fav));

      sortedPostList = arr;
      renderedPostCount = 0;

      if(postBatchObserver) postBatchObserver.disconnect();
      postsWideEl.removeEventListener('scroll', onPostBoardScroll);
      if(postSentinel) postSentinel.remove();

      if(resultsEl) resultsEl.innerHTML = '';
      postsWideEl.innerHTML = '';
      postSentinel = document.createElement('div');
      postSentinel.style.height = '1px';
      postsWideEl.appendChild(postSentinel);

      if(spinning && arr.length){
        const sample = card(arr[0], true);
        sample.style.visibility = 'hidden';
        postsWideEl.insertBefore(sample, postSentinel);
        const rect = sample.getBoundingClientRect();
        const style = getComputedStyle(sample);
        const cardHeight = rect.height + parseFloat(style.marginBottom || 0);
        postsWideEl.removeChild(sample);
        const max = Math.max(1, Math.floor(postsModeEl.clientHeight / cardHeight));
        appendPostBatch(max);
      } else {
        appendPostBatch(INITIAL_RENDER_COUNT);
      }

      updateResultCount(arr.length);

      if('IntersectionObserver' in window){
        postBatchObserver = new IntersectionObserver(entries => {
          entries.forEach(entry => {
            if(entry.isIntersecting){
              appendPostBatch();
            }
          });
        }, {root: postsWideEl, rootMargin:'0px 0px 200px 0px'});
        postBatchObserver.observe(postSentinel);
      } else {
        postsWideEl.addEventListener('scroll', onPostBoardScroll);
      }
    }
    function updateResultCount(n){
      const el = $('#resultCount');
      if(el){
        el.innerHTML = `<strong>${n}</strong> Results`;
        el.style.display = '';
      }
    }
    function formatDates(d){
      if(!d || !d.length) return '';
      const fmt = iso => parseISODate(iso).toLocaleDateString('en-GB',{weekday:'short', day:'numeric', month:'short'}).replace(/,/g,'');
      if(d.length===1) return fmt(d[0]);
      return `${fmt(d[0])} + ${d.length-1} more`;
    }

    function prioritizeVisibleImages(){
      const roots = [postsWideEl];
      if(resultsEl) roots.push(resultsEl);
      roots.forEach(root => {
        const imgs = root.querySelectorAll('img.thumb');
        if(!imgs.length) return;
        if('IntersectionObserver' in window){
          const observerRoot = root === postsWideEl ? root.closest('.post-board') : root;
          const obs = new IntersectionObserver(entries => {
            entries.forEach(entry => {
              if(entry.isIntersecting){
                const img = entry.target;
                if(img.dataset.src){
                  img.addEventListener('load', ()=> img.classList.remove('lqip'), {once:true});
                  img.src = img.dataset.src;
                  img.removeAttribute('data-src');
                }
                img.fetchPriority = 'high';
                obs.unobserve(img);
              }
            });
          }, {root: observerRoot});
          imgs.forEach(img => obs.observe(img));
        } else {
          imgs.forEach(img => {
            img.loading = 'lazy';
            if(img.dataset.src){
              img.addEventListener('load', ()=> img.classList.remove('lqip'), {once:true});
              img.src = img.dataset.src;
              img.removeAttribute('data-src');
            }
          });
        }
      });
    }

    function card(p, wide=false){
      const el = document.createElement('article');
      el.className = wide ? 'post-card' : 'quick-card';
      el.dataset.id = p.id;
      if(wide) el.style.gridTemplateColumns='80px 1fr 36px';
      const thumbSrc = imgThumb(p);
      const thumb = `<img class="thumb lqip" loading="lazy" src="${thumbSrc}" alt="" referrerpolicy="no-referrer" />`;
        el.innerHTML = `
          ${thumb}
        <div class="meta">
          <div class="title">${p.title}</div>
          <div class="info">
            <div class="cat-line"><span class="sub-icon">${subcategoryIcons[p.subcategory]||''}</span> ${p.category} &gt; ${p.subcategory}</div>
            <div class="loc-line"><span class="badge" title="Venue"></span><span>${p.city}</span></div>
            <div class="date-line"><span class="badge" title="Dates"></span><span>${formatDates(p.dates)}</span></div>
          </div>
        </div>
        <button class="fav" aria-pressed="${p.fav?'true':'false'}" aria-label="Toggle favourite">
          <svg viewBox="0 0 24 24"><path d="M12 17.3 6.2 21l1.6-6.7L2 9.3l6.9-.6L12 2l3.1 6.7 6.9.6-5.8 4.9L17.8 21 12 17.3z"/></svg>
        </button>
      `;
      el.style.background = 'linear-gradient(rgba(0,0,0,0.8),rgba(0,0,0,0.6))';
      el.querySelector('.fav').addEventListener('click', (e)=>{
        e.stopPropagation();
        p.fav = !p.fav;
        document.querySelectorAll(`[data-id="${p.id}"] .fav`).forEach(btn=>{
          btn.setAttribute('aria-pressed', p.fav ? 'true' : 'false');
        });
        renderHistoryBoard();
      });
      return el;
    }

    // History board
    function loadHistory(){ try{ return JSON.parse(localStorage.getItem('openHistoryV2')||'[]'); }catch(e){ return []; } }
    function saveHistory(){ localStorage.setItem('openHistoryV2', JSON.stringify(viewHistory)); }

    function captureState(){
      const {start,end} = orderedRange();
      return {
        bounds: map ? map.getBounds().toArray() : null,
        kw: $('#keyword-textbox').value,
        date: $('#daterange-textbox').value,
        start: start ? toISODate(start) : null,
        end: end ? toISODate(end) : null,
        expired: $('#expiredToggle').checked,
        cats: [...selection.cats],
        subs: [...selection.subs]
      };
    }

    function restoreState(st){
      if(!st) return;
      $('#keyword-textbox').value = st.kw || '';
      dateStart = st.start ? parseISODate(st.start) : null;
      dateEnd = st.end ? parseISODate(st.end) : null;
      if(!st.start && st.range){
        const parts = st.range.split(' to ').map(s=>s.trim());
        if(parts[0]) dateStart = parseISODate(parts[0]);
        if(parts[1]) dateEnd = parseISODate(parts[1]);
      }
      $('#expiredToggle').checked = st.expired || false;
      if($('#expiredToggle').checked){
        buildFilterCalendar(minPickerDate, maxPickerDate);
      } else {
        buildFilterCalendar(today, maxPickerDate);
      }
      if(dateStart){
        const sIso = toISODate(dateStart);
        const sDisp = fmtShort(sIso);
        if(dateEnd && dateEnd.getTime() !== dateStart.getTime()){
          const eIso = toISODate(dateEnd);
          const eDisp = fmtShort(eIso);
          $('#daterange-textbox').value = `${sDisp} - ${eDisp}`;
        } else {
          $('#daterange-textbox').value = sDisp;
        }
      } else {
        $('#daterange-textbox').value = '';
      }
      expiredWasOn = $('#expiredToggle').checked;
      updateRangeClasses();
      updateInput();
      selection.cats = new Set(st.cats || []);
      selection.subs = new Set(st.subs || []);
      $$('.cat').forEach(el=>{
        const label = el.querySelector('.label').textContent;
        const expanded = selection.cats.has(label);
        el.setAttribute('aria-expanded', expanded?'true':'false');
        el.querySelectorAll('.sub .chip').forEach(ch=>{
          const subName = ch.textContent.trim();
          const key = label+'::'+subName;
          if(selection.subs.has(key)) ch.classList.add('on'); else ch.classList.remove('on');
        });
      });
      if(map && st.bounds){
        stopSpin();
        const bounds = new mapboxgl.LngLatBounds(st.bounds);
        map.fitBounds(bounds, {duration:0});
        postPanel = bounds;
      }
      applyFilters();
      updateClearButtons();
    }
    function renderHistoryBoard(){
      if(!historyBoard) return;
      historyBoard.innerHTML='';
      viewHistory = viewHistory.filter(v => posts.some(p => p.id === v.id));
      saveHistory();
      const items = viewHistory.slice(0,100);
      for(const v of items){
        const p = posts.find(x=>x.id===v.id);
        if(!p) continue;
        const el = card(p);
        historyBoard.appendChild(el);
      }
    }

    renderHistoryBoard();

    function buildDetail(p){
      const wrap = document.createElement('div');
      wrap.className = 'open-post';
      wrap.dataset.id = p.id;
      const loc0 = p.locations[0];
      const dsorted = loc0.dates.slice().sort((a,b)=> a.full.localeCompare(b.full));
      const defaultInfo = ` ${loc0.price} |  ${dsorted[0].date} - ${dsorted[dsorted.length-1].date}<span style="display:inline-block;margin-left:10px;">(Select Session)</span>`;
      const thumbSrc = imgThumb(p);
      wrap.innerHTML = `
        <div class="post-header">
          <div class="title-block">
            <div class="title">${p.title}</div>
            <div class="cat-line"><span class="sub-icon">${subcategoryIcons[p.subcategory]||''}</span> ${p.category} &gt; ${p.subcategory}</div>
          </div>
          <button class="share" aria-label="Share post">
            <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.06-.23.09-.46.09-.7s-.03-.47-.09-.7l7.13-4.17A2.99 2.99 0 0 0 18 9a3 3 0 1 0-3-3c0 .24.03.47.09.7L7.96 10.87A3.003 3.003 0 0 0 6 10a3 3 0 1 0 3 3c0-.24-.03-.47-.09-.7l7.13 4.17c.53-.5 1.23-.81 1.96-.81a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/></svg>
          </button>
          <button class="fav" aria-pressed="${p.fav?'true':'false'}" aria-label="Toggle favourite">
            <svg viewBox="0 0 24 24"><path d="M12 17.3 6.2 21l1.6-6.7L2 9.3l6.9-.6L12 2l3.1 6.7 6.9.6-5.8 4.9L17.8 21 12 17.3z"/></svg>
          </button>
        </div>
        <div class="post-body">
          <div class="main-post-column">
            <div class="post-images">
              <div class="image-box"><img id="hero-img" class="lqip" src="${thumbSrc}" data-full="${heroUrl(p)}" alt="" loading="eager" fetchpriority="high" referrerpolicy="no-referrer" onerror="this.onerror=null; this.src='${thumbSrc}';"/></div>
              <div class="thumbnail-row"></div>
            </div>
          </div>
          <div class="second-post-column">
            <div class="post-details">
              <div class="post-venue-selection-container"></div>
              <div class="post-session-selection-container"></div>
              <div class="location-section">
                <div class="map-container">
                  <div id="map-${p.id}" class="post-map"></div>
                  <div id="venue-${p.id}" class="venue-dropdown options-dropdown"><button class="venue-btn" aria-haspopup="true" aria-expanded="false"><span class="venue-name">${p.locations[0].venue}</span><span class="venue-address">${p.locations[0].address}</span></button><div class="venue-menu options-menu" hidden>${p.locations.map((loc,i)=>`<button data-index="${i}"><span class="venue-name">${loc.venue}</span><span class="venue-address">${loc.address}</span></button>`).join('')}</div></div>
                </div>
                <div class="calendar-container">
                  <div class="calendar-scroll">
                    <div id="cal-${p.id}" class="post-calendar"></div>
                  </div>
                  <div id="sess-${p.id}" class="session-dropdown options-dropdown"><button class="sess-btn" aria-haspopup="true" aria-expanded="false">Select Session</button><div class="session-menu options-menu" hidden></div></div>
                </div>
              </div>
              <h2 class="title">${p.title}</h2>
              <div class="cat-line"><span class="sub-icon">${subcategoryIcons[p.subcategory]||''}</span> ${p.category} &gt; ${p.subcategory}</div>
              <div class="member-avatar-row"><img src="${memberAvatarUrl(p)}" alt="${p.member ? p.member.username : 'Anonymous'} avatar" width="50" height="50"/><span>Posted by ${p.member ? p.member.username : 'Anonymous'}</span></div>
              <div id="venue-info-${p.id}" class="venue-info"></div>
              <div id="session-info-${p.id}" class="session-info">
                <div>${defaultInfo}</div>
              </div>
              <div class="desc-wrap"><div class="desc">${p.desc}</div></div>
            </div>
          </div>
        </div>`;
      const header = wrap.querySelector('.post-header');
      if(header) header.style.background = 'linear-gradient(rgba(0,0,0,0.8),rgba(0,0,0,0.6))';
      wrap.style.background = 'linear-gradient(rgba(0,0,0,0.8),rgba(0,0,0,0.8))';
        // progressive hero swap
        (function(){
          const img = wrap.querySelector('#hero-img');
          if(img){
            const full = img.getAttribute('data-full');
            const hi = new Image();
            hi.referrerPolicy = 'no-referrer';
            hi.fetchPriority = 'high';
            hi.onload = ()=>{
              const swap = ()=>{ img.src = full; img.classList.remove('lqip'); img.classList.add('ready'); };
              if(hi.decode){ hi.decode().then(swap).catch(swap); } else { swap(); }
            };
            hi.onerror = ()=>{};
            hi.src = full;
          }
        })();
        return wrap;
    }

    async function openPost(id, fromQuick=false, fromMap=false){
      touchMarker = null;
      if(hoverPopup){ hoverPopup.remove(); hoverPopup = null; }
      spinEnabled = false;
      localStorage.setItem('spinGlobe', 'false');
      stopSpin();
      const p = posts.find(x=>x.id===id); if(!p) return;
      activePostId = id;
      $$('.quick-card[aria-selected="true"], .post-card[aria-selected="true"]').forEach(el=>el.removeAttribute('aria-selected'));
      $$('.mapboxgl-popup.map-card .hover-card[aria-selected="true"]').forEach(el=>el.removeAttribute('aria-selected'));
      if(mode !== 'posts'){
        setMode('posts', true);
        await nextFrame();
      }

      if(!postsWideEl.children.length){ postsWideEl.appendChild(card(p, true)); }

      const alreadyOpen = postsWideEl.querySelector(`.open-post[data-id="${id}"]`);
      if(alreadyOpen){
        const header = alreadyOpen.querySelector('.post-header');
        if(header){
          const hh = document.querySelector('.header').offsetHeight;
          const desired = hh + 10;
          const r = header.getBoundingClientRect();
          const container = postsWideEl.closest('.post-board');
          if(container) container.scrollBy({top: r.top - desired, behavior:'smooth'});
        }
        return;
      }

      let target = postsWideEl.querySelector(`[data-id="${id}"]`);
      const container = postsWideEl.closest('.post-board');
      const initialTop = target && container ? target.getBoundingClientRect().top : null;

      (function(){
        const ex = postsWideEl.querySelector('.open-post');
        if(ex){
          const exId = ex.dataset && ex.dataset.id;
          const prev = posts.find(x=> x.id===exId);
          if(prev){ ex.replaceWith(card(prev, true)); } else { ex.remove(); }
        }
      })();

      if(target && container && initialTop!==null){
        const newTarget = postsWideEl.querySelector(`[data-id="${id}"]`) || target;
        const newTop = newTarget.getBoundingClientRect().top;
        container.scrollTop += newTop - initialTop;
        target = newTarget;
      } else {
        target = postsWideEl.querySelector(`[data-id="${id}"]`);
      }

      if(!target){ target = card(p, true); postsWideEl.appendChild(target); }
      const resCard = resultsEl ? resultsEl.querySelector(`[data-id="${id}"]`) : null;
      if(resCard){
        resCard.setAttribute('aria-selected','true');
        if(fromMap){
          const qb = resCard.closest('.quick-list-board');
          if(qb){
            const hh = document.querySelector('.header').offsetHeight;
            const desired = hh + 10;
            const r = resCard.getBoundingClientRect();
            qb.scrollBy({top: r.top - desired, behavior:'smooth'});
          }
        }
      }
      const mapCard = document.querySelector('.mapboxgl-popup.map-card .hover-card');
      if(mapCard) mapCard.setAttribute('aria-selected','true');

      const detail = buildDetail(p);
      target.replaceWith(detail);
      hookDetailActions(detail, p);
      if (typeof updateStickyImages === 'function') {
        updateStickyImages();
      }

      await nextFrame();
      const header = detail.querySelector('.post-header');
      if(header){
        const h = header.offsetHeight;
        header.style.scrollMarginTop = h + 'px';
      }

      if(!container && window.innerWidth > 450){
        (header || detail).scrollIntoView({block:'start', inline:'nearest', behavior:'auto'});
      }
      if(container && header){
        const hh = document.querySelector('.header').offsetHeight;
        const desired = hh + 10;
        const r = header.getBoundingClientRect();
        container.scrollBy({top: r.top - desired, behavior:'smooth'});
      }


      // Update history on open (keep newest-first)
      viewHistory = viewHistory.filter(x=>x.id!==id);
      viewHistory.unshift({id:p.id, title:p.title, url:postUrl(p)});
      if(viewHistory.length>100) viewHistory.length=100;
      saveHistory(); renderHistoryBoard();
    }

    function openPostModal(id){
      const p = posts.find(x=>x.id===id);
      if(!p) return;
      activePostId = id;
      const container = document.getElementById('post-modal-container');
      if(!container) return;
      const modal = container.querySelector('.post-modal');
      modal.innerHTML='';
      const wrap = document.createElement('div');
      wrap.className = 'post-board';
      const detail = buildDetail(p);
      const headerEl = detail.querySelector('.post-header');
      const favBtn = headerEl && headerEl.querySelector('.fav');
      if(headerEl && favBtn){
        const closeBtn = document.createElement('button');
        closeBtn.type='button';
        closeBtn.className='close-post';
        closeBtn.setAttribute('aria-label','Close post');
        closeBtn.textContent='';
        closeBtn.style.marginLeft='10px';
        favBtn.after(closeBtn);
        closeBtn.addEventListener('click', e=>{ e.stopPropagation(); closePostModal(); });
      }
      wrap.appendChild(detail);
      modal.appendChild(wrap);
      hookDetailActions(detail, p);
      container.classList.remove('hidden');
      if(!panelStack.includes(container)) panelStack.push(container);
      bringToTop(container);
      requestAnimationFrame(()=>{
        const imgArea = detail.querySelector('.post-images');
      const text = detail.querySelector('.post-details');
        if(headerEl){
          headerEl.style.position='sticky';
          headerEl.style.top='0';
          headerEl.style.zIndex='2';
        }
        if(imgArea && text && text.offsetTop === imgArea.offsetTop){
          imgArea.style.position='sticky';
          imgArea.style.top = headerEl ? headerEl.offsetHeight + 'px' : '0';
        }
      });
      viewHistory = viewHistory.filter(x=>x.id!==id);
      viewHistory.unshift({id:p.id, title:p.title, url:postUrl(p)});
      if(viewHistory.length>100) viewHistory.length=100;
      saveHistory(); renderHistoryBoard();
      location.hash = `/post/${p.slug}-${p.created}`;
    }

    function closePostModal(){
      const container = document.getElementById('post-modal-container');
      if(!container) return;
      container.classList.add('hidden');
      const idx = panelStack.indexOf(container);
      if(idx!==-1) panelStack.splice(idx,1);
      const modal = container.querySelector('.post-modal');
      if(modal) modal.innerHTML='';
      location.hash = '';
    }
    window.closePostModal = closePostModal;

    function handleHash(){
      if(!location.hash){
        closePostModal();
        return;
      }
      const m = location.hash.match(/\/post\/([^\/]+)-([^\/]+)$/);
      if(!m || !(Array.isArray(posts) && posts.length)) return;
      const slug = decodeURIComponent(m[1]);
      const created = m[2];
      const post = posts.find(x=>x.slug===slug && x.created===created);
      if(post){ openPostModal(post.id); }
    }

    window.addEventListener('hashchange', handleHash);

    window.addEventListener('resize', ()=>{});

    document.addEventListener('DOMContentLoaded', ()=>{
      const container = document.getElementById('post-modal-container');
      if(container){
        container.addEventListener('click', e=>{ if(e.target===container) closePostModal(); });
      }
      handleHash();
    });

    document.addEventListener('click', (ev)=>{
      const card = ev.target.closest('.mapboxgl-popup.map-card .hover-card');
      if(card){
        const pid = card.getAttribute('data-id') || (card.closest('.multi-item.map-card') && card.closest('.multi-item.map-card').getAttribute('data-id'));
        if(pid){ touchMarker = null; stopSpin(); openPost(pid, false, true); }
      }
    });

    function hookDetailActions(el, p){
  const descWrap = el.querySelector(".desc-wrap");
  if(descWrap){
    const desc = descWrap.querySelector(".desc");
    if(desc){
      desc.addEventListener('click', ()=>{
        desc.classList.toggle('expanded');
      });
    }
  }
      const favBtn = el.querySelector('.fav');
      if(favBtn){
        favBtn.addEventListener('click', (e)=>{
          e.stopPropagation();
          p.fav = !p.fav;
          document.querySelectorAll(`[data-id="${p.id}"] .fav`).forEach(btn=>{
            btn.setAttribute('aria-pressed', p.fav ? 'true' : 'false');
          });
          const detailEl = el;
          renderHistoryBoard();
          const replacement = postsWideEl.querySelector(`[data-id="${p.id}"]`);
          if(replacement){
            replacement.replaceWith(detailEl);
          }
        });
      }

      const shareBtn = el.querySelector('.share');
      if(shareBtn){
        shareBtn.addEventListener('click', (e)=>{
          e.stopPropagation();
          const url = postUrl(p);
          navigator.clipboard.writeText(url).then(()=>{ showCopyMsg(shareBtn); });
        });
      }

      const imgs = p.images && p.images.length ? p.images : [imgHero(p)];
      const thumbCol = el.querySelector('.thumbnail-row');
      const mainImg = el.querySelector('.image-box img');
      imgs.forEach((url,i)=>{
        const t = document.createElement('img');
        t.src = url;
        t.dataset.full = url;
        t.dataset.index = i;
        t.tabIndex = 0;
        thumbCol.appendChild(t);
      });
      function show(idx){
        const t = thumbCol.querySelector(`img[data-index="${idx}"]`);
        if(!t) return;
        if(mainImg.dataset.index == idx && mainImg.classList.contains('ready')) return;
        mainImg.src = t.src;
        mainImg.dataset.index = idx;
        mainImg.classList.remove('ready');
        mainImg.classList.add('lqip');
        const hi = new Image();
        const full = t.dataset.full;
        hi.onload = ()=>{
          const swap = ()=>{
            if(mainImg.dataset.index==idx){
              mainImg.src = full;
              mainImg.classList.remove('lqip');
              mainImg.classList.add('ready');
            }
          };
          if(hi.decode){ hi.decode().then(swap).catch(swap); } else { swap(); }
        };
      hi.onerror = ()=>{};
      hi.src = full;
      thumbCol.querySelectorAll('img').forEach(im=> im.classList.toggle('selected', im===t));
    }
    show(0);
    setupHorizontalWheel(thumbCol);
    thumbCol.addEventListener('click', e=>{
      const t = e.target.closest('img');
      if(!t) return;
      const idx = parseInt(t.dataset.index,10);
      if(t.classList.contains('selected')){
        openImagePopup(idx);
      } else {
        show(idx);
      }
    });
      thumbCol.addEventListener('keydown', e=>{
        const cur = parseInt(mainImg.dataset.index||'0',10);
        if(e.key==='ArrowDown'){
          e.preventDefault();
          const ni = Math.min(cur+1, imgs.length-1);
          show(ni);
          thumbCol.querySelector(`img[data-index="${ni}"]`).focus();
        } else if(e.key==='ArrowUp'){
          e.preventDefault();
          const ni = Math.max(cur-1,0);
          show(ni);
          thumbCol.querySelector(`img[data-index="${ni}"]`).focus();
        }
      });
      function openImagePopup(start){
        const panel = document.createElement('div');
        panel.className = 'img-popup';
        const imgEl = document.createElement('img');
        let idx = start;
        imgEl.src = imgs[idx];
        imgEl.dataset.index = idx;
        panel.appendChild(imgEl);
        function next(){
          idx = (idx+1)%imgs.length;
          imgEl.src = imgs[idx];
          imgEl.dataset.index = idx;
        }
        function prev(){
          idx = (idx-1+imgs.length)%imgs.length;
          imgEl.src = imgs[idx];
          imgEl.dataset.index = idx;
        }
        const entry = {remove: ()=> panel.remove()};
        panel._entry = entry;
        imgEl.addEventListener('click', e=>{ e.stopPropagation(); next(); });
        let startX = null;
        imgEl.addEventListener('touchstart', e=>{ startX = e.touches[0].clientX; }, {passive:true});
        imgEl.addEventListener('touchend', e=>{
          if(startX===null) return;
          const diff = e.changedTouches[0].clientX - startX;
          if(Math.abs(diff) > 50){
            diff < 0 ? next() : prev();
          }
          startX = null;
        }, {passive:true});
        panel.addEventListener('click', ()=>{ const i = panelStack.indexOf(entry); if(i!==-1) panelStack.splice(i,1); panel.remove(); });
        document.body.appendChild(panel);
        panelStack.push(entry);
      }
      mainImg.addEventListener('click', e=>{ e.stopPropagation(); openImagePopup(parseInt(mainImg.dataset.index||'0',10)); });
      let startX = null;
      mainImg.addEventListener('touchstart', e=>{ startX = e.touches[0].clientX; }, {passive:true});
      mainImg.addEventListener('touchend', e=>{
        if(startX===null) return;
        const diff = e.changedTouches[0].clientX - startX;
        if(Math.abs(diff) > 50){
          const cur = parseInt(mainImg.dataset.index||'0',10);
          if(diff < 0 && cur < imgs.length-1){ show(cur+1); }
          else if(diff > 0 && cur > 0){ show(cur-1); }
        }
        startX = null;
      }, {passive:true});
      const venueDropdown = el.querySelector(`#venue-${p.id}`);
      const venueBtn = venueDropdown ? venueDropdown.querySelector('.venue-btn') : null;
      const venueMenu = venueDropdown ? venueDropdown.querySelector('.venue-menu') : null;
      const venueInfo = el.querySelector(`#venue-info-${p.id}`);
      const sessDropdown = el.querySelector(`#sess-${p.id}`);
      const sessBtn = sessDropdown ? sessDropdown.querySelector('.sess-btn') : null;
      const sessMenu = sessDropdown ? sessDropdown.querySelector('.session-menu') : null;
        const sessionInfo = el.querySelector(`#session-info-${p.id}`);
        const calendarEl = el.querySelector(`#cal-${p.id}`);
        const mapEl = el.querySelector(`#map-${p.id}`);
        const calContainer = el.querySelector('.calendar-container');
        const calScroll = calContainer ? calContainer.querySelector('.calendar-scroll') : null;
        if(calScroll){
          setupCalendarScroll(calScroll);
        }
        let map, marker, sessionHasMultiple = false, lastClickedCell = null;
      function updateVenue(idx){
        const loc = p.locations[idx];
        loc.dates.sort((a,b)=> a.full.localeCompare(b.full) || a.time.localeCompare(b.time));
        const currentYear = new Date().getFullYear();
        const parseDate = s => {
          const [yy, mm, dd] = s.split('-').map(Number);
          return new Date(yy, mm - 1, dd);
        };
        const formatDate = d => {
          const y = parseDate(d.full).getFullYear();
          return y !== currentYear ? `${d.date}, ${y}` : d.date;
        };
        let defaultInfoHTML = '';
        if(venueInfo) venueInfo.innerHTML = `<strong>${loc.venue}</strong><br>${loc.address}`;
        if(venueBtn) venueBtn.innerHTML = `<span class="venue-name">${loc.venue}</span><span class="venue-address">${loc.address}</span>${p.locations.length>1?'<span class="results-arrow" aria-hidden="true"></span>':''}`;
        sessionHasMultiple = loc.dates.length > 1;
        if(sessionInfo){
          const firstDate = loc.dates[0];
          const lastDate = loc.dates[loc.dates.length-1];
          const rangeText = `${formatDate(firstDate)} - ${formatDate(lastDate)}`;
          defaultInfoHTML = `<div> ${loc.price} |  ${rangeText}<span style="display:inline-block;margin-left:10px;">(Select Session)</span></div>`;
          sessionInfo.innerHTML = defaultInfoHTML;
        }
        if(!map){
          map = new mapboxgl.Map({
            container: mapEl,
            style: mapStyle,
            center: [loc.lng, loc.lat],
            zoom: 10,
            interactive: false
          });
            const subId = subcategoryMarkerIds[p.subcategory] || slugify(p.subcategory);
            const svg = subcategoryMarkers[subId];
            if(svg){
              const img = new Image();
              img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
              marker = new mapboxgl.Marker({element:img}).setLngLat([loc.lng, loc.lat]).addTo(map);
            } else {
              marker = new mapboxgl.Marker().setLngLat([loc.lng, loc.lat]).addTo(map);
            }
          setTimeout(()=> map && map.resize(),0);
          window.addEventListener('resize', ()=>{ if(map) map.resize(); });
        } else {
          map.setCenter([loc.lng, loc.lat]);
          marker.setLngLat([loc.lng, loc.lat]);
          setTimeout(()=> map && map.resize(),0);
        }
        const dateStrings = Array.from(new Set(loc.dates.map(d=>d.full)));
        const allowedSet = new Set(dateStrings);
        const minDate = parseDate(dateStrings[0]);
        const maxDate = parseDate(dateStrings[dateStrings.length-1]);
        calendarEl.innerHTML='';
        const cal = document.createElement('div');
        cal.className='calendar';
        let current = new Date(minDate.getFullYear(), minDate.getMonth(),1);
        const end = new Date(maxDate.getFullYear(), maxDate.getMonth(),1);
        while(current <= end){
          const monthEl = document.createElement('div');
          monthEl.className='month';
          const header = document.createElement('div');
          header.className='calendar-header';
          header.textContent = current.toLocaleDateString('en-GB',{month:'long',year:'numeric'});
          monthEl.appendChild(header);
          const grid = document.createElement('div');
          grid.className='grid';

          const weekdays=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
          weekdays.forEach(wd=>{
            const w=document.createElement('div');
            w.className='weekday';
            w.textContent=wd;
            grid.appendChild(w);
          });

          const firstDay = new Date(current.getFullYear(), current.getMonth(),1);
          const startDow = firstDay.getDay();
          const daysInMonth = new Date(current.getFullYear(), current.getMonth()+1,0).getDate();
          const totalCells = 42;
          for(let i=0;i<totalCells;i++){
            const cell=document.createElement('div');
            cell.className='day';
            const dayNum=i-startDow+1;
            if(i<startDow || dayNum>daysInMonth){
              cell.classList.add('empty');
            }else{
              cell.textContent=dayNum;
              const dateObj=new Date(current.getFullYear(), current.getMonth(), dayNum);
              const iso=toISODate(dateObj);
              cell.dataset.iso = iso;
              if(allowedSet.has(iso)){
                cell.classList.add('available-day');
                cell.addEventListener('mousedown',()=>{ lastClickedCell = cell; });
                cell.addEventListener('click',()=>{
                  const matches = loc.dates.map((dd,i)=>({i,d:dd})).filter(o=> o.d.full===iso);
                  if(matches.length===1){ selectSession(matches[0].i); }
                  else if(matches.length>1){ showTimePopup(matches); }
                });
              } else {
                cell.classList.add('empty');
              }
              if(isToday(dateObj)) cell.classList.add('today');
            }
            grid.appendChild(cell);
          }
          monthEl.appendChild(grid);
          cal.appendChild(monthEl);
          current.setMonth(current.getMonth()+1);
        }
        calendarEl.appendChild(cal);
        let selectedIndex = null;
        calendarEl.addEventListener('click', e=> e.stopPropagation());
        function markSelected(){
          calendarEl.querySelectorAll('.day').forEach(d=> d.classList.remove('selected'));
          if(selectedIndex!==null){
            const dt = loc.dates[selectedIndex];
            const cell = calendarEl.querySelector(`.day[data-iso="${dt.full}"]`);
            if(cell) cell.classList.add('selected');
          }
        }
        function selectSession(i){
          if(!sessMenu) return;
          selectedIndex = i;
          sessMenu.querySelectorAll('button').forEach(b=> b.classList.remove('selected'));
          const btn = sessMenu.querySelector(`button[data-index="${i}"]`);
          if(btn) btn.classList.add('selected');
          const dt = loc.dates[i];
          if(dt){
            sessionInfo.innerHTML = `<div><strong>${formatDate(dt)} ${dt.time}</strong></div><div>Adults $20, Kids $10, Pensioners $15</div><div> Buy at venue |  Accessible |  Kid-friendly</div>`;
            if(sessBtn) sessBtn.innerHTML = `<span class="session-date">${formatDate(dt)}</span><span class="session-time">${dt.time}</span>${sessionHasMultiple?'<span class="results-arrow" aria-hidden="true"></span>':''}`;
            markSelected();
            const cell = calendarEl.querySelector(`.day[data-iso="${dt.full}"]`);
            if(cell && calScroll){
              const monthEl = cell.closest('.month');
              if(monthEl) calScroll.scrollTo({left:monthEl.offsetLeft, behavior:'smooth'});
            }
          } else {
            sessionInfo.innerHTML = defaultInfoHTML;
            if(sessBtn) sessBtn.innerHTML = sessionHasMultiple ? 'Select Session<span class="results-arrow" aria-hidden="true"></span>' : 'Select Session';
            selectedIndex = null;
            markSelected();
          }
          sessMenu.hidden = true;
          sessBtn && sessBtn.setAttribute('aria-expanded','false');
        }
        function showTimePopup(matches){
          const existing = calContainer.querySelector('.time-popup');
          if(existing) existing.remove();
          const popup = document.createElement('div');
          popup.className = 'time-popup';
          popup.innerHTML = `<div class="time-list">${matches.map(m=>`<button data-index="${m.i}">${m.d.time}</button>`).join('')}</div>`;
          calContainer.appendChild(popup);
          if(lastClickedCell){
            const rect = lastClickedCell.getBoundingClientRect();
            const containerRect = calContainer.getBoundingClientRect();
            popup.style.left = (rect.left - containerRect.left) + 'px';
            popup.style.top = (rect.bottom - containerRect.top + 4) + 'px';
          }
          popup.querySelectorAll('button').forEach(b=> b.addEventListener('click',()=>{ selectSession(parseInt(b.dataset.index,10)); popup.remove(); }));
          setTimeout(()=> document.addEventListener('click', function handler(e){ if(!popup.contains(e.target)){ popup.remove(); document.removeEventListener('click', handler); } }),0);
        }
        setTimeout(()=>{
          if(map && typeof map.resize === 'function') map.resize();
        },0);
        if(sessMenu){
          sessMenu.innerHTML = loc.dates.map((d,i)=> `<button data-index="${i}"><span class="session-date">${formatDate(d)}</span><span class="session-time">${d.time}</span></button>`).join('');
          sessMenu.scrollTop = 0;
          if(sessionHasMultiple){
            sessionInfo.innerHTML = defaultInfoHTML;
            if(sessBtn){ sessBtn.innerHTML = 'Select Session<span class="results-arrow" aria-hidden="true"></span>'; sessBtn.setAttribute('aria-expanded','false'); }
          } else {
            if(loc.dates.length){
              selectSession(0);
            } else {
              sessionInfo.innerHTML = defaultInfoHTML;
              if(sessBtn){ sessBtn.textContent = 'Select Session'; sessBtn.setAttribute('aria-expanded','false'); }
            }
          }
          sessMenu.querySelectorAll('button').forEach(btn=>{
            btn.addEventListener('click', ()=> selectSession(parseInt(btn.dataset.index,10)));
          });
        }
      }
        if(mapEl){
          setTimeout(()=>{
            loadMapbox(()=>{
              updateVenue(0);
              if(venueMenu && venueBtn){
                venueMenu.querySelectorAll('button').forEach(btn=>{
                  if(btn.dataset.index==='0') btn.classList.add('selected');
                  btn.addEventListener('click', ()=>{
                    venueMenu.querySelectorAll('button').forEach(b=> b.classList.remove('selected'));
                    btn.classList.add('selected');
                    updateVenue(parseInt(btn.dataset.index,10));
                    venueMenu.hidden = true;
                    venueBtn.setAttribute('aria-expanded','false');
                  });
                });
                venueBtn.addEventListener('click', ()=>{
                  const expanded = venueBtn.getAttribute('aria-expanded') === 'true';
                  venueBtn.setAttribute('aria-expanded', String(!expanded));
                  venueMenu.hidden = expanded;
                });
                document.addEventListener('click', e=>{ if(venueDropdown && !venueDropdown.contains(e.target)){ venueMenu.hidden = true; venueBtn.setAttribute('aria-expanded','false'); } });
              }
              if(sessBtn && sessMenu){
                sessBtn.addEventListener('click', ()=>{
                  const expanded = sessBtn.getAttribute('aria-expanded') === 'true';
                  sessBtn.setAttribute('aria-expanded', String(!expanded));
                  sessMenu.hidden = expanded;
                });
                document.addEventListener('click', e=>{ if(sessDropdown && !sessDropdown.contains(e.target)){ sessMenu.hidden = true; sessBtn.setAttribute('aria-expanded','false'); } });
              }
              if(map && typeof map.resize === 'function') map.resize();
            });
          },0);
        }
    }


    function inBounds(p){
      if(!postPanel) return true;
      return p.lng >= postPanel.getWest() && p.lng <= postPanel.getEast() &&
             p.lat >= postPanel.getSouth() && p.lat <= postPanel.getNorth();
    }
    function kwMatch(p){ const kw = $('#keyword-textbox').value.trim().toLowerCase(); if(!kw) return true; return (p.title+' '+p.city+' '+p.category+' '+p.subcategory).toLowerCase().includes(kw); }
    function dateMatch(p){
      const {start,end} = orderedRange();
      const expiredChk = $('#expiredToggle');
      if(!start && !end){
        if(expiredChk && expiredChk.checked){
          return true;
        }
        const today = new Date(); today.setHours(0,0,0,0);
        return p.dates.some(d => parseISODate(d) >= today);
      }
      return p.dates.some(d => {
        const dt = parseISODate(d);
        if(start && dt < start) return false;
        if(end && dt > end) return false;
        return true;
      });
    }
    function catMatch(p){ if(selection.cats.size===0 && selection.subs.size===0) return true; const cOk = selection.cats.size===0 || selection.cats.has(p.category); const sOk = selection.subs.size===0 || selection.subs.has(p.category+'::'+p.subcategory); return cOk && sOk; }

    function updateFilterCounts(){
      if(!postsLoaded) return;
      filtered = posts.filter(p => (spinning || inBounds(p)) && kwMatch(p) && dateMatch(p) && catMatch(p));
      const today = new Date(); today.setHours(0,0,0,0);
      const total = posts.filter(p => (spinning || inBounds(p)) && p.dates.some(d => parseISODate(d) >= today)).length;
      const summary = $('#filterSummary');
      if(summary){ summary.textContent = `${filtered.length} results showing out of ${total} results in the area.`; }
      updateResetBtn();
    }

    function refreshMarkers(render = true){
      if(!postsLoaded) return;
      adPosts = filtered.filter(p => p.sponsored);
      if(adPanel){
        adPanel.innerHTML = '';
        adIndex = -1;
        if(adTimer){ clearInterval(adTimer); }
        if(adPosts.length){
          showNextAd();
          adTimer = setInterval(showNextAd,20000);
        } else {
          const img = document.createElement('img');
          img.src = 'assets/welcome%20001.jpg';
          img.alt = 'Welcome';
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.objectFit = 'cover';
          adPanel.appendChild(img);
        }
      }
      if(render) renderLists(filtered);
      if(map && map.getSource('posts')){ map.getSource('posts').setData(postsToGeoJSON(filtered)); }
    }

    function applyFilters(render = true){
      updateFilterCounts();
      refreshMarkers(render);
    }

    function showNextAd(){
      if(!adPanel || !adPosts.length) return;
      adIndex = (adIndex + 1) % adPosts.length;
      const p = adPosts[adIndex];
      const slide = document.createElement('a');
      slide.className = 'ad-slide';
      slide.dataset.id = p.id;
      slide.href = postUrl(p);
      const img = new Image();
      img.src = heroUrl(p);
      img.alt = '';
      img.decode().catch(()=>{}).then(()=>{
        slide.appendChild(img);
        const info = document.createElement('div');
        info.className = 'info';
        info.textContent = p.title;
        slide.appendChild(info);
        adPanel.appendChild(slide);
        requestAnimationFrame(()=> slide.classList.add('active'));
        const slides = adPanel.querySelectorAll('.ad-slide');
        if(slides.length > 1){
          const old = slides[0];
          old.classList.remove('active');
          setTimeout(()=> old.remove(),1500);
        }
      });
    }

    function initAdBoard(){
      adPanel = document.querySelector('.ad-panel');
      if(!adPanel) return;
      adPanel.addEventListener('click', async e => {
        const slide = e.target.closest('.ad-slide');
        if(!slide) return;
        e.preventDefault();
        const id = slide.dataset.id;
        await openPost(id);
        const openEl = document.querySelector(`.post-board .open-post[data-id="${id}"]`);
        if(openEl){ openEl.scrollIntoView({behavior:'smooth', block:'start'}); }
        document.querySelectorAll('.quick-card[aria-selected="true"]').forEach(el=>el.removeAttribute('aria-selected'));
        const quickCard = document.querySelector(`.history-board .quick-card[data-id="${id}"]`);
        if(quickCard){
          quickCard.setAttribute('aria-selected','true');
          quickCard.scrollIntoView({behavior:'smooth', block:'nearest'});
        }
      });
    }

    // applyFilters();
    setMode('map');
  })();
  
// 0577 helpers (safety)
function isPortrait(id){ let h=0; for(let i=0;i<id.length;i++){ h=(h<<5)-h+id.charCodeAt(i); h|=0; } return Math.abs(h)%2===0; }
function heroUrl(p){ const id = (typeof p==='string')? p : p.id; const port=isPortrait(id); return `https://picsum.photos/seed/${encodeURIComponent(id)}-t/${port?'800/1200':'1200/800'}`; }
function thumbUrl(p){ const id = (typeof p==='string')? p : p.id; const port=isPortrait(id); return `https://picsum.photos/seed/${encodeURIComponent(id)}-t/${port?'200/300':'300/200'}`; }
const panelStack = [];
function bringToTop(item){
  const idx = panelStack.indexOf(item);
  if(idx!==-1) panelStack.splice(idx,1);
  panelStack.push(item);
  panelStack.forEach((p,i)=>{
    if(p instanceof Element){ p.style.zIndex = 2000 + i; }
  });
}
function registerPopup(p){
  bringToTop(p);
  if(typeof p.on==='function'){
    p.on('close',()=>{
      const i = panelStack.indexOf(p);
      if(i!==-1) panelStack.splice(i,1);
    });
  }
  const el = p.getElement && p.getElement();
  if(el){
    el.addEventListener('mousedown', ()=> bringToTop(p));
  }
}
function savePanelState(m){
  if(!m || !m.id || m.id === 'welcome-modal') return;
  const content = m.querySelector('.panel-content');
  if(!content) return;
  const state = {
    left: content.style.left,
    top: content.style.top,
    width: content.style.width,
    height: content.style.height
  };
  localStorage.setItem(`panel-${m.id}`, JSON.stringify(state));
}
function loadPanelState(m){
  if(!m || !m.id) return false;
  const content = m.querySelector('.panel-content');
  if(!content) return false;
  const saved = JSON.parse(localStorage.getItem(`panel-${m.id}`) || 'null');
  if(saved){
    ['width','height','left','top'].forEach(prop=>{
      if(saved[prop]) content.style[prop] = saved[prop];
    });
    if(saved.left || saved.top) content.style.transform = 'none';
    return true;
  }
  return false;
}
const panelButtons = {
  filterPanel: 'filterBtn',
  memberPanel: 'memberBtn',
  adminPanel: 'adminBtn'
};
function openPanel(m){
  const content = m.querySelector('.panel-content') || m.querySelector('.modal-content');
  if(content && m.id !== 'welcome-modal'){
    content.style.width = '';
    content.style.height = '';
  }
  m.classList.add('show');
  m.removeAttribute('aria-hidden');
  m.removeAttribute('inert');
  const btnId = panelButtons[m && m.id];
  if(btnId){
    const btn = document.getElementById(btnId);
    btn && btn.setAttribute('aria-pressed','true');
  }
  localStorage.setItem(`panel-open-${m.id}`,'true');
  if(content){
    const rootStyles = getComputedStyle(document.documentElement);
    const headerH = parseFloat(rootStyles.getPropertyValue('--header-h')) || 0;
    const subH = parseFloat(rootStyles.getPropertyValue('--subheader-h')) || 0;
    const footerH = parseFloat(rootStyles.getPropertyValue('--footer-h')) || 0;
    const safeTop = parseFloat(rootStyles.getPropertyValue('--safe-top')) || 0;
    if(m.id==='adminPanel' || m.id==='memberPanel'){
      const topPos = headerH + safeTop;
      const availableHeight = window.innerHeight - footerH - topPos;
      content.style.left='auto';
      content.style.right='0';
      content.style.top=`${topPos}px`;
      content.style.bottom=`${footerH}px`;
      content.style.maxHeight=`${availableHeight}px`;
      content.dataset.side='right';
      content.classList.remove('panel-visible');
      content.style.transform='translateX(100%)';
      requestAnimationFrame(()=>{content.classList.add('panel-visible');content.style.transform='';});
    } else if(m.id==='filterPanel'){
      const topPos = headerH + subH + safeTop;
      let translate;
      if(window.innerWidth < 450){
        content.style.left='0';
        content.style.right='0';
        content.style.top=`${topPos}px`;
        content.style.bottom=`${footerH}px`;
        content.style.maxHeight='';
        content.dataset.side='left';
        translate = '-100%';
      } else {
        const availableHeight = window.innerHeight - footerH - topPos;
        content.style.left='0';
        content.style.right='';
        content.style.top=`${topPos}px`;
        content.style.bottom='';
        content.style.maxHeight=`${availableHeight}px`;
        content.dataset.side='left';
        translate = '-100%';
      }
      content.classList.remove('panel-visible');
      content.style.transform=`translateX(${translate})`;
      requestAnimationFrame(()=>{content.classList.add('panel-visible');content.style.transform='';});
    } else if(m.id==='welcome-modal'){
      const topPos = headerH + safeTop + 10;
      content.style.left='50%';
      content.style.top=`${topPos}px`;
      content.style.transform='translateX(-50%)';
    } else {
      content.style.left='50%';
      content.style.top='50%';
      content.style.transform='translate(-50%, -50%)';
    }
    if(m.id !== 'welcome-modal' && !['adminPanel','memberPanel','filterPanel'].includes(m.id)) loadPanelState(m);
  }
  if(!m.__bringToTopAdded){
    m.addEventListener('mousedown', ()=> bringToTop(m));
    m.__bringToTopAdded = true;
  }
  bringToTop(m);
  if(map && typeof map.resize === 'function') setTimeout(()=> map.resize(),0);
}
function closePanel(m){
  const btnId = panelButtons[m && m.id];
  if(btnId){
    const btn = document.getElementById(btnId);
    btn && btn.setAttribute('aria-pressed','false');
  }
  const content = m.querySelector('.panel-content') || m.querySelector('.modal-content');
  const active = document.activeElement;
  if(active && m.contains(active)) active.blur();
  m.setAttribute('inert','');
  if(content && content.dataset.side){
    content.classList.remove('panel-visible');
    content.style.transform = content.dataset.side === 'left' ? 'translateX(-100%)' : 'translateX(100%)';
    content.addEventListener('transitionend', function handler(){
      content.removeEventListener('transitionend', handler);
      m.classList.remove('show');
      m.setAttribute('aria-hidden','true');
      localStorage.setItem(`panel-open-${m.id}`,'false');
      const idx = panelStack.indexOf(m);
      if(idx!==-1) panelStack.splice(idx,1);
      if(map && typeof map.resize === 'function') setTimeout(()=> map.resize(),0);
    }, {once:true});
  } else {
    m.classList.remove('show');
    m.setAttribute('aria-hidden','true');
    localStorage.setItem(`panel-open-${m.id}`,'false');
    const idx = panelStack.indexOf(m);
    if(idx!==-1) panelStack.splice(idx,1);
    if(map && typeof map.resize === 'function') setTimeout(()=> map.resize(),0);
  }
}
const welcomeModalEl = document.getElementById('welcome-modal');
if(welcomeModalEl){
  welcomeModalEl.addEventListener('click', () => closePanel(welcomeModalEl));
}
function requestClosePanel(m){
  closePanel(m);
}
function togglePanel(m){
  if(m.classList.contains('show')){
    requestClosePanel(m);
  } else {
    openPanel(m);
  }
}
function movePanelToEdge(panel, side){
  if(!panel) return;
  const content = panel.querySelector('.panel-content') || panel.querySelector('.modal-content');
  if(!content) return;
  const header = document.querySelector('.header');
  const topPos = header ? header.getBoundingClientRect().bottom : 0;
  content.style.top = `${topPos}px`;
  content.classList.remove('panel-visible');
  if(side === 'left'){
    content.dataset.side='left';
    content.style.left = '0';
    content.style.right = 'auto';
    content.style.transform='translateX(-100%)';
  } else {
    content.dataset.side='right';
    content.style.left = 'auto';
    content.style.right = '0';
    content.style.transform='translateX(100%)';
  }
  requestAnimationFrame(()=>{content.classList.add('panel-visible');content.style.transform='';});
}
function repositionPanels(){
  ['adminPanel','memberPanel','filterPanel'].forEach(id=>{
    const panel = document.getElementById(id);
    if(panel && panel.classList.contains('show')){
      const content = panel.querySelector('.panel-content');
      if(!content) return;
      const w = content.style.width;
      const h = content.style.height;
      openPanel(panel);
      content.style.width = w;
      content.style.height = h;
    }
  });
}
function handleEsc(){
  const top = panelStack[panelStack.length-1];
  if(!top) return;
  if(top instanceof Element){
    if(top.id === 'adminPanel' && typeof window.saveAdminChanges === 'function'){
      window.saveAdminChanges();
    }
    if(top.id === 'post-modal-container'){
      closePostModal();
    } else {
      requestClosePanel(top);
    }
  } else if(typeof top.remove==='function'){
    panelStack.pop();
    top.remove();
  }
}
document.addEventListener('keydown', e=>{
  if(e.key==='Escape') handleEsc();
  else if(e.key==='ArrowLeft' || e.key==='ArrowRight'){
    const top = panelStack[panelStack.length-1];
    if(window.innerWidth >= 450 && top && (top.id==='adminPanel' || top.id==='memberPanel')){
      movePanelToEdge(top, e.key==='ArrowLeft' ? 'left' : 'right');
    }
  }
});

function handleDocInteract(e){
  if(e.target.closest('.img-popup')) return;
  if(logoEls.some(el => el.contains(e.target))) return;
  if(e.target.closest('#filterBtn')) return;
  const welcome = document.getElementById('welcome-modal');
  if(welcome && welcome.classList.contains('show')){
    const content = welcome.querySelector('.modal-content');
    if(content && !content.contains(e.target)){
      closePanel(welcome);
    }
  }
  const filterPanel = document.getElementById('filterPanel');
  if(filterPanel && filterPanel.classList.contains('show')){
    const content = filterPanel.querySelector('.panel-content');
    const pinBtn = filterPanel.querySelector('.pin-panel');
    const pinned = pinBtn && pinBtn.getAttribute('aria-pressed')==='true';
    if(content && !content.contains(e.target) && !pinned){
      closePanel(filterPanel);
    }
  }
  document.querySelectorAll('.img-popup').forEach(p=>{
    if(!p.contains(e.target)){
      p.remove();
      const entry = p._entry;
      if(entry){
        const i = panelStack.indexOf(entry);
        if(i!==-1) panelStack.splice(i,1);
      }
    }
  });
}

document.addEventListener('click', handleDocInteract);
document.addEventListener('pointerdown', handleDocInteract);

// Panels and admin/member interactions
(function(){
  const memberBtn = document.getElementById('memberBtn');
  const adminBtn = document.getElementById('adminBtn');
  const filterBtn = document.getElementById('filterBtn');
  const memberPanel = document.getElementById('memberPanel');
  const adminPanel = document.getElementById('adminPanel');
  const filterPanel = document.getElementById('filterPanel');
  const sg = window.spinGlobals || {};

  memberBtn && memberBtn.addEventListener('click', ()=> togglePanel(memberPanel));
    adminBtn && adminBtn.addEventListener('click', ()=>{
      togglePanel(adminPanel);
    });
  filterBtn && filterBtn.addEventListener('click', ()=> togglePanel(filterPanel));
  document.querySelectorAll('.panel .close-panel').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const panel = btn.closest('.panel');
      requestClosePanel(panel);
    });
  });
  document.querySelectorAll('.panel .move-left').forEach(btn=>{
    btn.addEventListener('click', e=>{
      e.stopPropagation();
      const panel = btn.closest('.panel');
      movePanelToEdge(panel, 'left');
    });
  });
  document.querySelectorAll('.panel .move-right').forEach(btn=>{
    btn.addEventListener('click', e=>{
      e.stopPropagation();
      const panel = btn.closest('.panel');
      movePanelToEdge(panel, 'right');
    });
  });

  document.querySelectorAll('#filterPanel .pin-panel').forEach(btn=>{
    btn.addEventListener('click', e=>{
      e.stopPropagation();
      const pressed = btn.getAttribute('aria-pressed')==='true';
      btn.setAttribute('aria-pressed', pressed ? 'false' : 'true');
    });
  });

  document.querySelectorAll('.panel .panel-header').forEach(header=>{
    header.addEventListener('mousedown', e=>{
      if(e.target.closest('button')) return;
      const panel = header.closest('.panel');
      const content = panel ? panel.querySelector('.panel-content') : null;
      if(!content) return;
      bringToTop(panel);
      const rect = content.getBoundingClientRect();
      const startX = e.clientX;
      const startLeft = rect.left;
      function onMove(ev){
        const dx = ev.clientX - startX;
        let newLeft = startLeft + dx;
        const maxLeft = window.innerWidth - rect.width;
        if(newLeft < 0) newLeft = 0;
        if(newLeft > maxLeft) newLeft = maxLeft;
        content.style.left = `${newLeft}px`;
        content.style.right = 'auto';
      }
      function onUp(){
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
      }
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    });
  });

    const welcomeModal = document.getElementById('welcome-modal');
    [memberPanel, adminPanel, welcomeModal].forEach(m=>{
      if(m && localStorage.getItem(`panel-open-${m.id}`) === 'true'){
        openPanel(m);
      }
    });
    if(welcomeModal && !localStorage.getItem('welcome-seen')){
      openWelcome();
      localStorage.setItem('welcome-seen','true');
    }
    const shouldOpenFilter = window.innerWidth >= 1300 && localStorage.getItem('panel-open-filterPanel') !== 'false';
    if(filterPanel && shouldOpenFilter){
      openPanel(filterPanel);
    }
  document.querySelectorAll('.panel').forEach(panel=>{
    const content = panel.querySelector('.panel-content');
    if(content){
      content.style.width = '440px';
      content.style.maxWidth = '440px';
      content.style.top = 'var(--header-h)';
      content.style.bottom = 'var(--footer-h)';
      content.style.height = 'calc(100vh - var(--header-h) - var(--footer-h))';
    }
  });

  const adminTabs = document.querySelectorAll('#adminPanel .tab-bar button');
  const adminPanels = document.querySelectorAll('#adminPanel .tab-panel');
  adminTabs.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      adminTabs.forEach(b=>b.setAttribute('aria-selected','false'));
      adminPanels.forEach(p=>p.classList.remove('active'));
      btn.setAttribute('aria-selected','true');
      const panel = document.getElementById(`tab-${btn.dataset.tab}`);
      panel && panel.classList.add('active');
    });
  });

  const colorAreas = [
    {key:'header', label:'Header', selectors:{bg:['.header'], text:['.header']}},
    {key:'body', label:'Body', selectors:{bg:['body'], border:[], hoverBorder:[], activeBorder:[]}},
    {key:'list', label:'List', selectors:{bg:['.quick-list-board'], text:['.quick-list-board'], title:['.quick-list-board .quick-card .t','.quick-list-board .quick-card .title'], btn:['.quick-list-board button','.quick-list-board .sq','.quick-list-board .tiny','.quick-list-board .btn'], btnText:['.quick-list-board button','.quick-list-board .sq','.quick-list-board .tiny','.quick-list-board .btn'], card:['.quick-list-board .quick-card']}},
    {key:'post-board', label:'Closed Posts', selectors:{bg:['.post-board'], text:['.post-board','.post-board .posts'], title:['.post-board .post-card .t','.post-board .post-card .title','.post-board .open-post .t','.post-board .open-post .title'], btn:['.post-board button'], btnText:['.post-board button'], card:['.post-board .post-card','.post-board .open-post']}},
    {key:'open-post', label:'Open Posts', selectors:{text:['.open-post','.open-post .venue-info','.open-post .session-info'], title:['.open-post .t','.open-post .title'], btn:['.open-post button'], btnText:['.open-post button'], card:['.open-post'], header:['.open-post .post-header'], image:['.open-post .image-box'], menu:['.open-post .venue-menu button','.open-post .session-menu button']}},
    {key:'map', label:'Map', selectors:{popupBg:['.mapboxgl-popup.map-card .mapboxgl-popup-content','.mapboxgl-popup.map-card .hover-card','.mapboxgl-popup.map-card .chip','.mapboxgl-popup.map-card .chip-small','.mapboxgl-popup.map-card .multi-item.map-card'], popupText:['.mapboxgl-popup.map-card .hover-card','.mapboxgl-popup.map-card .chip','.mapboxgl-popup.map-card .chip-small','.mapboxgl-popup.map-card .multi-item.map-card'], title:['.mapboxgl-popup.map-card .hover-card .t','.mapboxgl-popup.map-card .hover-card .title','.mapboxgl-popup.map-card .chip .t','.mapboxgl-popup.map-card .chip .title','.mapboxgl-popup.map-card .chip-small .t','.mapboxgl-popup.map-card .chip-small .title','.mapboxgl-popup.map-card .multi-item.map-card .t','.mapboxgl-popup.map-card .multi-item.map-card .title']}},
    {key:'filter', label:'Filter Panel', selectors:{bg:['#filterPanel .panel-content'], text:['#filterPanel .panel-content'], title:['#filterPanel .panel-content .t','#filterPanel .panel-content .title'], btn:['#filterPanel button:not([class*="mapboxgl-"])','#filterPanel .sq','#filterPanel .tiny'], btnText:['#filterPanel button:not([class*="mapboxgl-"])','#filterPanel .sq','#filterPanel .tiny']}},
    {key:'calendar', label:'Calendar', selectors:{bg:['.calendar'], text:['.calendar .day'], weekday:['.calendar .weekday'], title:['.calendar .calendar-header'], header:['.calendar .calendar-header']}},
  {key:'adminPanel', label:'Admin Panel', selectors:{bg:['#adminPanel .panel-content'], text:['#adminPanel .panel-content'], title:['#adminPanel .panel-content .t','#adminPanel .panel-content .title'], btn:['#adminPanel button','#adminPanel #spinType span'], btnText:['#adminPanel button','#adminPanel #spinType span']}},
  {key:'welcome-modal', label:'Welcome Modal', selectors:{bg:['#welcome-modal .modal-content'], text:['#welcome-modal .modal-content'], title:['#welcome-modal .modal-content .t','#welcome-modal .modal-content .title'], btn:['#welcome-modal button:not([class*"mapboxgl-"])'], btnText:['#welcome-modal button:not([class*"mapboxgl-"])']}},
  {key:'memberPanel', label:'Member Panel', selectors:{bg:['#memberPanel .panel-content'], text:['#memberPanel .panel-content'], title:['#memberPanel .panel-content .t','#memberPanel .panel-content .title'], btn:['#memberPanel button'], btnText:['#memberPanel button']}},
  {key:'imagePanel', label:'Image Popup', selectors:{bg:['.img-popup']}}
];

  function storeTitleDefaults(){
    colorAreas.forEach(area=>{
      (area.selectors.title||[]).forEach(sel=>{
        document.querySelectorAll(sel).forEach(el=>{
          const cs = getComputedStyle(el);
          el.dataset.titleDefaultColor = cs.color;
          el.dataset.titleDefaultFont = cs.fontFamily;
          el.dataset.titleDefaultSize = cs.fontSize;
          el.dataset.titleDefaultWeight = cs.fontWeight;
          el.dataset.titleDefaultShadow = cs.textShadow;
        });
      });
    });
    const varMap = {'today-c':'--today', 'sessionAvailable-c':'--session-available', 'sessionSelected-c':'--session-selected'};
    Object.entries(varMap).forEach(([id,varName])=>{
      const el = document.getElementById(id);
      if(el){
        const val = getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
        if(val) el.value = val;
      }
    });
  }

  function restoreTitleDefaults(area){
    (area.selectors.title||[]).forEach(sel=>{
      document.querySelectorAll(sel).forEach(el=>{
        if(el.dataset.titleDefaultColor) el.style.color = el.dataset.titleDefaultColor;
        if(el.dataset.titleDefaultFont) el.style.fontFamily = el.dataset.titleDefaultFont;
        if(el.dataset.titleDefaultSize) el.style.fontSize = el.dataset.titleDefaultSize;
        if(el.dataset.titleDefaultWeight) el.style.fontWeight = el.dataset.titleDefaultWeight;
        if(el.dataset.titleDefaultShadow) el.style.textShadow = el.dataset.titleDefaultShadow;
      });
    });
  }

  storeTitleDefaults();


  window.addEventListener('resize', updateLayoutVars);
  window.addEventListener('resize', updateStickyImages);
  window.addEventListener('load', updateLayoutVars);
  updateLayoutVars();
  if (typeof updateStickyImages === 'function') {
    updateStickyImages();
  }
})();
</script>

<div class="image-modal-container hidden">
  <div class="image-modal"></div>
</div>

<div id="post-modal-container" class="hidden">
  <div class="post-modal"></div>
</div>

<script>
  (function(){
    const ns = 'http://www.w3.org/2000/svg';
    const SHAPES = {
      circle(){ const c=document.createElementNS(ns,'circle'); c.setAttribute('cx','0'); c.setAttribute('cy','0'); c.setAttribute('r','50'); return c; },
      tallEllipse(){ const e=document.createElementNS(ns,'ellipse'); e.setAttribute('cx','0'); e.setAttribute('cy','0'); e.setAttribute('rx','40'); e.setAttribute('ry','55'); return e; },
      heart(){ const p=document.createElementNS(ns,'path'); p.setAttribute('d','M0,-30 C-30,-70 -70,-20 -35,15 Q0,55 35,15 C70,-20 30,-70 0,-30Z'); return p; },
      star(){ const p=document.createElementNS(ns,'path'); p.setAttribute('d','M0,-55 L14,-17 L47,-17 L23,5 L35,45 L0,25 L-35,45 L-23,5 L-47,-17 L-14,-17 Z'); return p; },
      triangle(){ const p=document.createElementNS(ns,'path'); p.setAttribute('d','M0,55 L50,-45 L-50,-45 Z'); return p; },
      rectangle(){ const r=document.createElementNS(ns,'rect'); r.setAttribute('x','-35'); r.setAttribute('y','-55'); r.setAttribute('width','70'); r.setAttribute('height','110'); r.setAttribute('rx','20'); r.setAttribute('ry','20'); return r; },
      square(){ const r=document.createElementNS(ns,'rect'); r.setAttribute('x','-45'); r.setAttribute('y','-45'); r.setAttribute('width','90'); r.setAttribute('height','90'); r.setAttribute('rx','20'); r.setAttribute('ry','20'); return r; },
      diamond(){ const p=document.createElementNS(ns,'path'); p.setAttribute('d','M0,-55 L45,0 0,55 -45,0 Z'); return p; },
      pentagon(){ const p=document.createElementNS(ns,'path'); p.setAttribute('d','M0,-55 L52,-17 L32,45 -32,45 -52,-17 Z'); return p; },
      hexagon(){ const p=document.createElementNS(ns,'path'); p.setAttribute('d','M0,-55 L47,-27 L47,27 0,55 -47,27 -47,-27 Z'); return p; }
    };

    function hslToHex(h, s, l){
      s/=100; l/=100;
      const k = n => (n + h/30) % 12;
      const a = s * Math.min(l, 1-l);
      const f = n => l - a * Math.max(-1, Math.min(k(n)-3, Math.min(9-k(n),1)));
      return '#' + [f(0),f(8),f(4)].map(x=>Math.round(x*255).toString(16).padStart(2,'0')).join('');
    }
    const COLORS = Array.from({length:100}, (_,i)=>hslToHex(i*3.6,100,50));

    function createBalloon(shapeName, color, size){
      const svg = document.createElementNS(ns,'svg');
      svg.setAttribute('viewBox','-60 -80 120 160');
      svg.setAttribute('width', size);
      svg.setAttribute('height', size);
      svg.dataset.color = color;
      svg.setAttribute('title', size + 'px ' + color);
      const body = SHAPES[shapeName]();
      body.setAttribute('fill', color);
      body.setAttribute('stroke', '#000');
      body.setAttribute('stroke-width', '1');
      svg.appendChild(body);
      const tie = document.createElementNS(ns,'path');
      tie.setAttribute('d','M-8,55 L0,60 L8,55 Z');
      tie.setAttribute('fill','#000');
      tie.setAttribute('stroke','#000');
      tie.setAttribute('stroke-width','1');
      svg.appendChild(tie);
      const string = document.createElementNS(ns,'line');
      string.setAttribute('x1','0'); string.setAttribute('y1','60');
      string.setAttribute('x2','0'); string.setAttribute('y2','80');
      string.setAttribute('stroke','#fff');
      string.setAttribute('stroke-width','2');
      svg.appendChild(string);
      const gleam = document.createElementNS(ns,'ellipse');
      gleam.setAttribute('cx','-20'); gleam.setAttribute('cy','-20');
      gleam.setAttribute('rx','10'); gleam.setAttribute('ry','6');
      gleam.setAttribute('fill','#fff');
      svg.appendChild(gleam);
      return svg;
    }

    window.SHAPES = SHAPES;
    window.COLORS = COLORS;
    window.createBalloon = createBalloon;

    const buttons = document.getElementById('balloonShapeButtons');
    const shapeMenuBtn = document.getElementById('shapeMenuBtn');
    const grid = document.getElementById('balloonGrid');
    const sizeSlider = document.getElementById('balloonSize');
    const sizeValue = document.getElementById('balloonSizeValue');
    const svgCode = document.getElementById('balloonSvgCode');
    const copyBtn = document.getElementById('copySvgCode');
    let currentTemplate = '';

    sizeValue.textContent = sizeSlider.value;
    copyBtn.addEventListener('click', ()=>{ navigator.clipboard.writeText(svgCode.value); });

    if(shapeMenuBtn){
      shapeMenuBtn.addEventListener('click', ()=>{
        const expanded = shapeMenuBtn.getAttribute('aria-expanded') === 'true';
        shapeMenuBtn.setAttribute('aria-expanded', String(!expanded));
        buttons.hidden = expanded;
      });
      document.addEventListener('click', e=>{
        if(!shapeMenuBtn.contains(e.target) && !buttons.contains(e.target)){
          buttons.hidden = true;
          shapeMenuBtn.setAttribute('aria-expanded','false');
        }
      });
    }

    sizeSlider.addEventListener('input', ()=>{
      sizeValue.textContent = sizeSlider.value;
      renderFromSvg(currentTemplate);
    });

    function selectSvg(svg){
      grid.querySelectorAll('svg').forEach(s=>s.classList.remove('selected'));
      svg.classList.add('selected');
      svgCode.value = svg.outerHTML;
      currentTemplate = svg.outerHTML;
      if(document.hasFocus()){
        try{
          navigator.clipboard.writeText(svg.outerHTML);
        }catch(e){
          console.error('clipboard write failed', e);
        }
      }
    }

    function renderFromSvg(template){
      if(!template){ return; }
      grid.innerHTML='';
      COLORS.forEach(color=>{
        const colored = template.replace(/fill="(?!#fff)[^"]*"/g, `fill="${color}"`);
        const doc = new DOMParser().parseFromString(colored,'image/svg+xml');
        const svg = doc.documentElement;
        svg.setAttribute('width', sizeSlider.value);
        svg.setAttribute('height', sizeSlider.value);
        svg.dataset.color = color;
        svg.setAttribute('title', sizeSlider.value + 'px ' + color);
        svg.addEventListener('click', ()=> selectSvg(svg));
        grid.appendChild(svg);
      });
      const first = grid.querySelector('svg');
      if(first){
        first.classList.add('selected');
        svgCode.value = first.outerHTML;
        currentTemplate = first.outerHTML;
      }
    }

    function render(name){
      grid.innerHTML='';
      COLORS.forEach(color=>{
        const svg = createBalloon(name, color, sizeSlider.value);
        svg.addEventListener('click', ()=> selectSvg(svg));
        grid.appendChild(svg);
      });
      const first = grid.querySelector('svg');
      if(first){
        first.classList.add('selected');
        svgCode.value = first.outerHTML;
        currentTemplate = first.outerHTML;
      }
    }

    svgCode.addEventListener('input', ()=>{
      currentTemplate = svgCode.value;
      renderFromSvg(currentTemplate);
    });

    const LABELS = {
      circle:'circle',
      tallEllipse:'tall ellipse',
      heart:'heart',
      star:'soft star',
      triangle:'soft triangle',
      rectangle:'tall rectangle',
      square:'square',
      diamond:'diamond',
      pentagon:'pentagon',
      hexagon:'hexagon'
    };

    Object.keys(SHAPES).forEach((name,idx)=>{
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'shape-button';
      btn.appendChild(createBalloon(name, '#000', 24));
      btn.appendChild(document.createTextNode(LABELS[name] || name));
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('#map-balloon-container .shape-button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        render(name);
        if(shapeMenuBtn){
          shapeMenuBtn.textContent = LABELS[name] || name;
          shapeMenuBtn.setAttribute('aria-expanded','false');
          buttons.hidden = true;
        }
      });
      if(idx===0) btn.classList.add('active');
      buttons.appendChild(btn);
    });

    const firstShape = Object.keys(SHAPES)[0];
    render(firstShape);
    if(shapeMenuBtn){ shapeMenuBtn.textContent = LABELS[firstShape] || firstShape; }
  })();
</script>
<script>
(function(){
  const shapeList = Object.keys(SHAPES);
  let colorIdx = 0;
  const cats = window.categories || [];
  cats.forEach((cat, idx) => {
    const shape = shapeList[idx % shapeList.length];
    categoryShapes[cat.name] = shape;
    cat.subs.forEach(sub => {
      const color = COLORS[colorIdx % COLORS.length];
      colorIdx++;
      const slug = slugify(sub);
        subcategoryIcons[sub] = subcategorySvgs[slug];
        subcategoryMarkerIds[sub] = slug;
        subcategoryMarkers[slug] = subcategorySvgs[slug];
    });
  });
  if(window.postsLoaded) addPostSource();
})();
</script>
<script>
(function(){
  const ICONS = {
    circle:'<svg viewBox="0 0 20 20"><circle cx="10" cy="10" r="8" fill="#000"/></svg>',
    square:'<svg viewBox="0 0 20 20"><rect x="2" y="2" width="16" height="16" fill="#000"/></svg>',
    triangle:'<svg viewBox="0 0 20 20"><polygon points="10,2 18,18 2,18" fill="#000"/></svg>'
  };
  const FIELD_TYPES = ['Text','Number','Date','Color'];
  function createIconSelect(){
    const s=document.createElement('select');
    Object.keys(ICONS).forEach(k=>{
      const o=document.createElement('option');
      o.value=k;
      o.innerHTML=ICONS[k];
      s.appendChild(o);
    });
    return s;
  }
  function createFieldSelect(){
    const s=document.createElement('select');
    FIELD_TYPES.forEach(t=>{
      const o=document.createElement('option');
      o.value=t.toLowerCase();
      o.textContent=t;
      s.appendChild(o);
    });
    return s;
  }
  function addSubcategory(table){
    const iconRow=table.querySelector('.icon-row');
    const nameRow=table.querySelector('.name-row');
    const iconCell=document.createElement('td'); iconCell.appendChild(createIconSelect()); iconRow.appendChild(iconCell);
    const nameCell=document.createElement('td'); const inp=document.createElement('input'); nameCell.appendChild(inp); nameRow.appendChild(nameCell);
    table.querySelectorAll('.field-row').forEach(row=>{
      const cell=document.createElement('td'); cell.appendChild(createFieldSelect()); row.appendChild(cell);
    });
  }
  function addFieldRow(table){
    const cols=table.querySelector('.icon-row').children.length;
    const row=document.createElement('tr'); row.className='field-row';
    for(let i=0;i<cols;i++){ const cell=document.createElement('td'); cell.appendChild(createFieldSelect()); row.appendChild(cell); }
    table.appendChild(row);
  }
  function wireCategory(cat){
    const table=cat.querySelector('table');
    cat.querySelector('.delete-category').addEventListener('click',()=>cat.remove());
    cat.querySelector('.copy-category').addEventListener('click',()=>{const clone=cat.cloneNode(true); wireCategory(clone); cat.after(clone);});
    cat.querySelector('.add-subcategory').addEventListener('click',()=>addSubcategory(table));
    cat.querySelector('.add-field').addEventListener('click',()=>addFieldRow(table));
  }
  function createCategory(){
    const cat=document.createElement('div'); cat.className='form-category';
    const header=document.createElement('div'); header.className='category-header';
    const name=document.createElement('input'); name.type='text'; name.placeholder='Category name';
    const icon=createIconSelect();
    const color=document.createElement('input'); color.type='color'; color.value='#000000';
    const copy=document.createElement('button'); copy.type='button'; copy.className='copy-category'; copy.textContent='Copy';
    const del=document.createElement('button'); del.type='button'; del.className='delete-category'; del.textContent='Delete';
    header.append(name,icon,color,copy,del);
    cat.appendChild(header);
    const table=document.createElement('table'); table.className='subcategory-table';
    const iconRow=document.createElement('tr'); iconRow.className='icon-row';
    const nameRow=document.createElement('tr'); nameRow.className='name-row';
    table.append(iconRow,nameRow);
    cat.appendChild(table);
    const addSub=document.createElement('button'); addSub.type='button'; addSub.className='add-subcategory'; addSub.textContent='Add Subcategory';
    const addField=document.createElement('button'); addField.type='button'; addField.className='add-field'; addField.textContent='Add Field';
    cat.append(addSub,addField);
    addSubcategory(table);
    addFieldRow(table);
    wireCategory(cat);
    return cat;
  }
  document.getElementById('addCategory').addEventListener('click',()=>{
    const cat=createCategory();
    document.getElementById('formsCategories').appendChild(cat);
  });
})();
</script>


<script>
document.addEventListener('DOMContentLoaded', () => {
  const editor = document.getElementById('welcomeMessageEditor');
  const hidden = document.getElementById('welcomeMessage');
  if(editor && hidden){
    const placeholder = editor.getAttribute('data-placeholder') || '';
    hidden.value = hidden.value || placeholder;
    editor.innerHTML = hidden.value;
    editor.addEventListener('input', () => hidden.value = editor.innerHTML);
document.querySelectorAll('.wysiwyg-toolbar button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.execCommand(btn.dataset.command, false, null);
        editor.focus();
      });
    });
  }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('#adminPanel input[type="checkbox"]').forEach(cb => {
    if (cb.closest('.switch')) return;
    const wrapper = document.createElement('label');
    wrapper.className = 'switch';
    cb.parentNode.insertBefore(wrapper, cb);
    wrapper.appendChild(cb);
    const slider = document.createElement('span');
    slider.className = 'slider';
    cb.after(slider);
  });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const colorInput = document.getElementById('postModeBgColor');
  const opacityInput = document.getElementById('postModeBgOpacity');
  const opacityVal = document.getElementById('postModeBgOpacityVal');
  const root = document.documentElement;
  const settings = JSON.parse(localStorage.getItem('admin-settings-current') || '{}');
  const themeSelect = document.getElementById('mapTheme');
  const skySelect = document.getElementById('skyTheme');
  if(themeSelect) themeSelect.value = window.mapStyle;
  if(skySelect) skySelect.value = window.skyStyle;

  function hexToRgb(hex){
    const r = parseInt(hex.slice(1,3),16);
    const g = parseInt(hex.slice(3,5),16);
    const b = parseInt(hex.slice(5,7),16);
    return `${r},${g},${b}`;
  }

  function apply(){
    const color = colorInput.value || '#000000';
    const opacity = opacityInput.value;
    root.style.setProperty('--post-mode-bg-color', hexToRgb(color));
    root.style.setProperty('--post-mode-bg-opacity', opacity);
    opacityVal.textContent = Number(opacity).toFixed(2);
  }

  if(colorInput && opacityInput && opacityVal){
    colorInput.value = settings.postModeBgColor || '#000000';
    opacityInput.value = settings.postModeBgOpacity ?? 0;
    apply();
    const save = () => {
      settings.postModeBgColor = colorInput.value;
      settings.postModeBgOpacity = opacityInput.value;
      localStorage.setItem('admin-settings-current', JSON.stringify(settings));
    };
    colorInput.addEventListener('input', () => { apply(); save(); });
    opacityInput.addEventListener('input', () => { apply(); save(); });
    const prev = window.saveAdminChanges;
    window.saveAdminChanges = () => { save(); if(typeof prev === 'function') prev(); };
  }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const vp = document.getElementById('viewport');
  const updateViewport = () => {
    if (!vp) return;
    if (window.innerWidth < 650) {
      vp.setAttribute('content','width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no');
    } else {
      vp.setAttribute('content','width=device-width, initial-scale=1');
    }
  };
  updateViewport();
  window.addEventListener('resize', updateViewport);
  window.addEventListener('orientationchange', updateViewport);

  const fsBtn = document.getElementById('fullscreenBtn');
  if (fsBtn) {
    const docEl = document.documentElement;
    const canFS = docEl.requestFullscreen || docEl.webkitRequestFullscreen || docEl.mozRequestFullScreen || docEl.msRequestFullscreen;
    const enabled = document.fullscreenEnabled || document.webkitFullscreenEnabled || document.mozFullScreenEnabled || document.msFullscreenEnabled;
    if (!canFS || enabled === false) {
      fsBtn.style.display = 'none';
    } else {
      fsBtn.addEventListener('click', () => {
        const isFull = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;
        if (!isFull) {
          const req = docEl.requestFullscreen || docEl.webkitRequestFullscreen || docEl.mozRequestFullScreen || docEl.msRequestFullscreen;
          if (req) req.call(docEl).catch(() => {});
        } else {
          const exit = document.exitFullscreen || document.webkitExitFullscreen || document.mozCancelFullScreen || document.msExitFullscreen;
          if (exit) exit.call(document);
        }
      });
    }
  }

  if (window.innerWidth >= 650) return;

  const posts = document.querySelector('.post-board');
  if (!posts) return;

  let defaultSize = parseFloat(getComputedStyle(posts).fontSize);
  let startDist = null;
  let enlarged = false;

  function distance(t1, t2){
    return Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
  }

  posts.addEventListener('touchstart', e => {
    if (e.target.tagName === 'IMG') return;
    if (e.touches.length === 2) {
      startDist = distance(e.touches[0], e.touches[1]);
    }
  }, { passive: true });

  posts.addEventListener('touchmove', e => {
    if (e.target.tagName === 'IMG') return;
    if (e.touches.length === 2 && startDist) {
      const scale = distance(e.touches[0], e.touches[1]) / startDist;
      if (!enlarged && scale > 1.2) {
        posts.style.fontSize = (defaultSize * 1.2) + 'px';
        enlarged = true;
      } else if (enlarged && scale < 0.8) {
        posts.style.fontSize = defaultSize + 'px';
        enlarged = false;
      }
      e.preventDefault();
    }
  }, { passive: false });

  posts.addEventListener('touchend', e => {
    if (e.touches.length < 2) startDist = null;
  });

  function openImagePopup(src){
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999;';
    const big = document.createElement('img');
    big.src = src;
    big.style.cssText = 'max-width:90%;max-height:90%;touch-action:pinch-zoom;';
    overlay.appendChild(big);
    overlay.addEventListener('click', () => overlay.remove());
    document.body.appendChild(overlay);
  }

posts.querySelectorAll('img').forEach(img => {
    img.addEventListener('click', e => { e.stopPropagation(); openImagePopup(img.src); });
    img.addEventListener('touchstart', e => {
      if (e.touches.length === 2) {
        e.preventDefault();
        e.stopPropagation();
        openImagePopup(img.src);
      }
    }, { passive: false });
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('input[type="color"]').forEach(el => {
    if(!el.value) el.value = '#000000';
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  document.addEventListener('wheel', e => {
    if(e.target.closest('.post-board, .panel-content, .options-menu, .calendar-scroll')){
      e.stopPropagation();
    }
  }, {passive:false});
  const postsPanel = document.querySelector('.post-board');
  if(postsPanel){
    postsPanel.addEventListener('click', e => {
      if(e.target === postsPanel) setMode('map');
    });
  }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const board = document.querySelector('.post-board');
  const mainCol = document.querySelector('.main-post-column');
  const secondCol = document.querySelector('.second-post-column');
  const details = document.querySelector('.post-details');
  const postImages = document.querySelector('.post-images');
  const postHeader = document.querySelector('.post-header');
  const thumbRow = document.querySelector('.thumbnail-row');
  const selectedImageBox = postImages ? postImages.querySelector('.selected-image') : null;
  const imageModalContainer = document.querySelector('.image-modal-container');
  const imageModal = imageModalContainer ? imageModalContainer.querySelector('.image-modal') : null;

  function adjust(){
      const boardStyles = getComputedStyle(board);
      const padding = parseFloat(boardStyles.paddingLeft) + parseFloat(boardStyles.paddingRight);
      const secondWidth = board.offsetWidth - mainCol.offsetWidth - padding;
        if(secondWidth < 440){
          if(secondCol.style.display !== 'none'){
            secondCol.style.display = 'none';
            postImages.insertAdjacentElement('afterend', details);
            details.style.padding = '0';
          }
          if(window.innerWidth < 440){
            board.style.width = '100%';
            board.style.minWidth = '360px';
          } else {
            board.style.width = '440px';
            board.style.removeProperty('min-width');
          }
          if(thumbRow && selectedImageBox){
            selectedImageBox.insertAdjacentElement('afterend', thumbRow);
          }
        } else {
          if(secondCol.style.display === 'none'){
            secondCol.style.display = '';
            secondCol.appendChild(details);
            details.style.padding = '';
          }
          board.style.width = '';
          board.style.removeProperty('min-width');
          if(thumbRow && selectedImageBox){
            postImages.appendChild(thumbRow);
          }
        }

      const twoCols = secondCol.style.display !== 'none';
      board.classList.toggle('two-columns', twoCols);
      if(twoCols){
        document.documentElement.style.setProperty('--post-header-h', postHeader.offsetHeight + 'px');
      } else {
      document.documentElement.style.removeProperty('--post-header-h');
      }
    }

  window.adjust = adjust;
  adjust();
  window.addEventListener('load', adjust);
  new ResizeObserver(() => adjust()).observe(board);
  window.addEventListener('resize', adjust);

  function openImageModal(src){
    if(!imageModalContainer || !imageModal) return;
    imageModal.innerHTML='';
    const img = document.createElement('img');
    img.src = src;
    imageModal.appendChild(img);
    imageModalContainer.classList.remove('hidden');
  }

  imageModalContainer.addEventListener('click', e => {
    if(e.target === imageModalContainer){
      imageModalContainer.classList.add('hidden');
      imageModal.innerHTML='';
    }
  });

  if(thumbRow){
    thumbRow.addEventListener('dblclick', e => {
      const img = e.target.closest('img');
      if(img) openImageModal(img.src);
    });
  }

  if(selectedImageBox){
    selectedImageBox.addEventListener('click', () => {
      const img = selectedImageBox.querySelector('img');
      if(img) openImageModal(img.src);
    });
  }
});
</script>
</body>
</html>
