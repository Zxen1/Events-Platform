<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Events Platform</title>
  <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
  <link rel="manifest" href="/favicons/site.webmanifest">
  <link rel="shortcut icon" href="/favicons/favicon.ico">
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <style>
    :root {
      --color-header: navy;
      --color-footer: #000;
      --color-background: #fff;
      --color-text: #000;
      --scrollbar-thumb: #888;
    }
    body {
      font-family: Verdana, sans-serif;
      font-size: 14px;
      margin: 0;
      padding-top: 80px;
      color: var(--color-text);
      background: var(--color-background);
      scrollbar-gutter: stable both-edges;
    }
    * {
      scrollbar-width: thin;
      scrollbar-color: var(--scrollbar-thumb) transparent;
    }
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background-color: var(--scrollbar-thumb);
      border-radius: 5px;
      border: 3px solid transparent;
      background-clip: content-box;
    }
    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 80px;
      background: var(--color-header);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    header button {
      position: absolute;
      top: 0;
      width: 80px;
      height: 80px;
      background: transparent;
      border: none;
      cursor: pointer;
    }
    #filter-button { left: 0; }
    #list-button { left: 80px; }
    #posts-button { left: 160px; }
    #settings-button { right: 0; }
    #admin-button { right: 80px; }
    #member-button { right: 160px; }
    #header-logo {
      height: 60px;
      cursor: pointer;
    }
    #map {
      position: absolute;
      top: 80px;
      bottom: 80px;
      width: 100%;
    }
    #fullscreen-button {
      position: absolute;
      right: 0;
      top: 80px;
      width: 80px;
      height: 80px;
      background: transparent;
      border: none;
      cursor: pointer;
      z-index: 1001;
    }
    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 80px;
      background: rgba(0, 0, 0, 0.5);
      padding: 10px;
      display: flex;
      align-items: center;
      overflow: hidden;
      z-index: 1000;
    }
    #recent-posts-container {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      height: 60px;
      width: 100%;
    }
    .recent-post-card {
      flex: 0 0 auto;
      height: 60px;
      display: flex;
      align-items: center;
      background: #fff;
      color: #000;
      padding: 0 5px;
      border-radius: 4px;
    }
    .recent-post-card img {
      height: 100%;
      width: auto;
      margin-right: 5px;
    }
    .recent-post-card .star {
      margin-left: auto;
    }
      #welcome-modal {
        width: 600px;
        margin: 0 auto;
        background: var(--color-background);
        color: var(--color-text);
        border: 1px solid #ccc;
        padding: 20px;
        box-shadow: 0 0 10px rgba(0,0,0,0.2);
      }
      .panel {
        position: absolute;
        top: 80px;
        left: 0;
        width: 420px;
        height: calc(100vh - 160px);
        background: #333;
        color: #fff;
        padding: 10px;
        box-sizing: border-box;
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transition: opacity 0.3s ease;
        z-index: 1002;
      }
      .panel.active {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
      }
      .panel-header {
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-family: Verdana, sans-serif;
        font-size: 24px;
        cursor: move;
      }
      .panel-header button {
        background: transparent;
        border: none;
        color: #fff;
        cursor: pointer;
        font-size: 24px;
      }
      .hidden {
        display: none;
      }
    </style>
</head>
<body>
  <header id="header">
    <button id="filter-button" aria-label="Filter"></button>
    <button id="list-button" aria-label="List"></button>
    <button id="posts-button" aria-label="Posts"></button>
    <img id="header-logo" src="assets/funmap-logo-big.png" alt="FunMap logo">
    <button id="member-button" aria-label="Member"></button>
    <button id="admin-button" aria-label="Admin"></button>
    <button id="settings-button" aria-label="Settings"></button>
  </header>
  <div id="map"></div>
  <button id="fullscreen-button" aria-label="Fullscreen"></button>
  <div id="welcome-modal" class="hidden">
    <img src="assets/funmap-logo-big.png" alt="FunMap logo" style="max-width:100%;height:auto;">
    <p>Welcome to FunMap!</p>
  </div>
  <div id="panels">
    <div id="filter-panel" class="panel">
      <div class="panel-header">
        <button class="panel-arrow-left" aria-label="Previous">&#9664;</button>
        <span>Filter</span>
        <div>
          <button class="panel-arrow-right" aria-label="Next">&#9654;</button>
          <button class="panel-close" aria-label="Close">&times;</button>
        </div>
      </div>
    </div>
    <div id="list-panel" class="panel">
      <div class="panel-header">
        <button class="panel-arrow-left" aria-label="Previous">&#9664;</button>
        <span>List</span>
        <div>
          <button class="panel-arrow-right" aria-label="Next">&#9654;</button>
          <button class="panel-close" aria-label="Close">&times;</button>
        </div>
      </div>
    </div>
    <div id="posts-panel" class="panel">
      <div class="panel-header">
        <button class="panel-arrow-left" aria-label="Previous">&#9664;</button>
        <span>Posts</span>
        <div>
          <button class="panel-arrow-right" aria-label="Next">&#9654;</button>
          <button class="panel-close" aria-label="Close">&times;</button>
        </div>
      </div>
    </div>
    <div id="member-panel" class="panel">
      <div class="panel-header">
        <button class="panel-arrow-left" aria-label="Previous">&#9664;</button>
        <span>Member</span>
        <div>
          <button class="panel-arrow-right" aria-label="Next">&#9654;</button>
          <button class="panel-close" aria-label="Close">&times;</button>
        </div>
      </div>
    </div>
    <div id="admin-panel" class="panel">
      <div class="panel-header">
        <button class="panel-arrow-left" aria-label="Previous">&#9664;</button>
        <span>Admin</span>
        <div>
          <button class="panel-arrow-right" aria-label="Next">&#9654;</button>
          <button class="panel-close" aria-label="Close">&times;</button>
        </div>
      </div>
    </div>
    <div id="settings-panel" class="panel">
      <div class="panel-header">
        <button class="panel-arrow-left" aria-label="Previous">&#9664;</button>
        <span>Settings</span>
        <div>
          <button class="panel-arrow-right" aria-label="Next">&#9654;</button>
          <button class="panel-close" aria-label="Close">&times;</button>
        </div>
      </div>
    </div>
  </div>
  <footer id="footer">
    <div id="recent-posts-container"></div>
  </footer>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.Xo14KJtnMhLy2RpQeyWNLw';
    const welcomeModal = document.getElementById('welcome-modal');
    const headerLogo = document.getElementById('header-logo');
  const recentPostsContainer = document.getElementById('recent-posts-container');
  const fullscreenButton = document.getElementById('fullscreen-button');
  const recentPosts = [];

  let activePanel = null;

  function togglePanel(id) {
    const panel = document.getElementById(id);
    if (!panel) return;
    const isActive = panel.classList.contains('active');
    if (isActive) {
      panel.classList.remove('active');
      activePanel = null;
    } else {
      if (activePanel) activePanel.classList.remove('active');
      panel.classList.add('active');
      activePanel = panel;
    }
  }

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && activePanel) {
      togglePanel(activePanel.id);
    }
  });

  function makePanelDraggable(panel) {
    const header = panel.querySelector('.panel-header');
    if (!header) return;
    let startX = 0, startY = 0, origX = 0, origY = 0, dragging = false;

    header.addEventListener('mousedown', (e) => {
      dragging = true;
      startX = e.clientX;
      startY = e.clientY;
      origX = panel.offsetLeft;
      origY = panel.offsetTop;
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
    });

    function onMouseMove(e) {
      if (!dragging) return;
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      let newLeft = origX + dx;
      let newTop = origY + dy;
      const maxLeft = window.innerWidth - panel.offsetWidth;
      const maxTop = window.innerHeight - header.offsetHeight;
      if (newLeft < 0) newLeft = 0;
      if (newTop < 0) newTop = 0;
      if (newLeft > maxLeft) newLeft = maxLeft;
      if (newTop > maxTop) newTop = maxTop;
      panel.style.left = newLeft + 'px';
      panel.style.top = newTop + 'px';
    }

    function onMouseUp() {
      dragging = false;
      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup', onMouseUp);
    }
  }

    fullscreenButton.addEventListener('click', () => {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    });

    function addRecentPost(post) {
      const existingIndex = recentPosts.findIndex(p => p.id === post.id);
      if (existingIndex !== -1) recentPosts.splice(existingIndex, 1);
      recentPosts.unshift(post);
      if (recentPosts.length > 100) recentPosts.pop();
      renderRecentPosts();
    }

    function renderRecentPosts() {
      if (!recentPostsContainer) return;
      recentPostsContainer.innerHTML = '';
      recentPosts.forEach(post => {
        const card = document.createElement('div');
        card.className = 'recent-post-card';

        const img = document.createElement('img');
        img.src = post.thumbnail;
        img.alt = post.title;

        const title = document.createElement('span');
        title.textContent = post.title;

        const star = document.createElement('span');
        star.className = 'star';
        star.textContent = '☆';

        card.appendChild(img);
        card.appendChild(title);
        card.appendChild(star);
        recentPostsContainer.appendChild(card);
      });
    }

    function toggleModal() {
      welcomeModal.classList.toggle('hidden');
    }

    window.addEventListener('load', () => {
      welcomeModal.classList.remove('hidden');
    });

    headerLogo.addEventListener('click', toggleModal);

  const buttonPanelMap = {
    'filter-button': 'filter-panel',
    'list-button': 'list-panel',
    'posts-button': 'posts-panel',
    'member-button': 'member-panel',
    'admin-button': 'admin-panel',
    'settings-button': 'settings-panel'
  };

  Object.keys(buttonPanelMap).forEach(buttonId => {
    const btn = document.getElementById(buttonId);
    const panelId = buttonPanelMap[buttonId];
    btn.addEventListener('click', () => togglePanel(panelId));
  });

  document.querySelectorAll('.panel').forEach(panel => {
    const closeBtn = panel.querySelector('.panel-close');
    if (closeBtn) closeBtn.addEventListener('click', () => togglePanel(panel.id));
    makePanelDraggable(panel);
  });

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v11',
      center: [-122.447303, 37.753574],
      zoom: 10
    });

    map.on('load', () => {
      const standardCanvas = document.createElement('canvas');
      standardCanvas.width = 40;
      standardCanvas.height = 40;
      const stdCtx = standardCanvas.getContext('2d');
      stdCtx.fillStyle = '#3FB1CE';
      stdCtx.beginPath();
      stdCtx.arc(20, 20, 20, 0, Math.PI * 2);
      stdCtx.fill();

      const premiumCanvas = document.createElement('canvas');
      premiumCanvas.width = 80;
      premiumCanvas.height = 80;
      const premCtx = premiumCanvas.getContext('2d');
      premCtx.fillStyle = '#fbb03b';
      premCtx.beginPath();
      premCtx.arc(40, 40, 40, 0, Math.PI * 2);
      premCtx.fill();

      map.addImage('standard-icon', standardCanvas, { pixelRatio: 1 });
      map.addImage('premium-icon', premiumCanvas, { pixelRatio: 1 });

      const geojson = {
        type: 'FeatureCollection',
        features: [
          { type: 'Feature', properties: { id: 1, premium: false }, geometry: { type: 'Point', coordinates: [-122.447303, 37.753574] } },
          { type: 'Feature', properties: { id: 2, premium: true }, geometry: { type: 'Point', coordinates: [-122.457303, 37.763574] } },
          { type: 'Feature', properties: { id: 3, premium: false }, geometry: { type: 'Point', coordinates: [-122.467303, 37.773574] } }
        ]
      };

      map.addSource('events', {
        type: 'geojson',
        data: geojson,
        cluster: true,
        clusterMaxZoom: 14,
        clusterRadius: 50
      });

      map.addLayer({
        id: 'clusters',
        type: 'circle',
        source: 'events',
        filter: ['has', 'point_count'],
        paint: {
          'circle-color': '#51bbd6',
          'circle-radius': ['step', ['get', 'point_count'], 20, 100, 30, 750, 40]
        }
      });

      map.addLayer({
        id: 'cluster-count',
        type: 'symbol',
        source: 'events',
        filter: ['has', 'point_count'],
        layout: {
          'text-field': ['get', 'point_count_abbreviated'],
          'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
          'text-size': 12
        }
      });

      map.addLayer({
        id: 'unclustered-point',
        type: 'symbol',
        source: 'events',
        filter: ['!', ['has', 'point_count']],
        layout: {
          'icon-image': ['case', ['==', ['get', 'premium'], true], 'premium-icon', 'standard-icon'],
          'icon-allow-overlap': true
        }
      });

      map.on('click', 'clusters', (e) => {
        const features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
        const clusterId = features[0].properties.cluster_id;
        map.getSource('events').getClusterExpansionZoom(clusterId, (err, zoom) => {
          if (err) return;
          map.easeTo({ center: features[0].geometry.coordinates, zoom, pitch: 45 });
        });
      });

      map.on('click', 'unclustered-point', (e) => {
      const postsPanel = document.getElementById('posts-panel');
      if (postsPanel && !postsPanel.classList.contains('active')) togglePanel('posts-panel');
        const listPanel = document.getElementById('list-panel');
        if (listPanel) listPanel.scrollTo({ top: 0, behavior: 'smooth' });
        const feature = e.features[0];
        addRecentPost({
          id: feature.properties.id,
          title: `Post ${feature.properties.id}`,
          thumbnail: 'assets/funmap-logo-big.png'
        });
      });

      map.on('mouseenter', 'clusters', () => { map.getCanvas().style.cursor = 'pointer'; });
      map.on('mouseleave', 'clusters', () => { map.getCanvas().style.cursor = ''; });
      map.on('mouseenter', 'unclustered-point', () => { map.getCanvas().style.cursor = 'pointer'; });
      map.on('mouseleave', 'unclustered-point', () => { map.getCanvas().style.cursor = ''; });
    });
  </script>
</body>
</html>
