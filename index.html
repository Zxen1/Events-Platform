<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Funmap</title>
<link rel="apple-touch-icon" sizes="180x180" href="assets/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="assets/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="assets/favicons/favicon-16x16.png">
<link rel="manifest" href="assets/favicons/site.webmanifest">
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/@mapbox/mapbox-gl-geocoder@5.0.1/dist/mapbox-gl-geocoder.css">
<style>
  *{border-radius:8px;box-sizing:border-box;}
  header,footer,#map,.panel{border-radius:0;}
  html,body{margin:0;height:100%;font-family:Verdana,sans-serif;font-size:14px;overflow:hidden;}
  body{position:relative;}
  :root{
    --btn-bg:#333;
    --btn-color:#fff;
    --btn-hover-bg:#444;
    --btn-active-bg:#222;
    --btn-selected-bg:#0066cc;
    --btn-selected-hover-bg:#0077ee;
    --btn-disabled-bg:#777;
    --btn-disabled-color:#ccc;
    --btn-focus-outline:2px solid #fff;
  }

  button{
    background:var(--btn-bg);
    color:var(--btn-color);
    border:none;
    cursor:pointer;
    transition:background 0.2s;
  }

  button:hover:not(.selected):not(:disabled){background:var(--btn-hover-bg);}
  button:active:not(.selected):not(:disabled){background:var(--btn-active-bg);}
  button.selected{background:var(--btn-selected-bg);}
  button.selected:hover:not(:disabled){background:var(--btn-selected-hover-bg);}
  button:disabled{background:var(--btn-disabled-bg);color:var(--btn-disabled-color);cursor:not-allowed;}
  button:focus-visible{outline:var(--btn-focus-outline);outline-offset:2px;}

  header{
    position:absolute;top:0;left:0;right:0;height:80px;background:#333;color:#fff;display:flex;align-items:center;justify-content:space-between;z-index:10;
  }
  header .group{display:flex;}
  header button{
    width:80px;height:80px;font-size:14px;position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;}
  header button .icon{width:24px;height:24px;fill:#fff;}
  #filter-button .count{font-size:12px;}
  header img.logo{height:60px;cursor:pointer;}
  .panel{
    position:absolute;top:80px;bottom:80px;background:#fff;overflow:auto;padding:10px;box-sizing:border-box;z-index:5;transition:transform 0.3s;
  }
  .left.panel{left:0;transform:translateX(-100%);}
  .right.panel{right:0;transform:translateX(100%);}
  .panel.open{transform:translateX(0);}
  #filter-panel{width:420px;}
  #list-panel{width:520px;}
  #posts-panel{width:auto;max-width:420px;}
  #member-panel,#admin-panel,#settings-panel{width:420px;}
  #map{position:absolute;top:80px;bottom:0;left:0;right:0;}
  footer{
    position:absolute;left:0;right:0;bottom:0;height:80px;background:rgba(0,0,0,0.5);z-index:10;box-sizing:border-box;}
  footer .cards{overflow-x:auto;white-space:nowrap;height:80px;margin-right:80px;}
  footer .card{display:inline-block;height:60px;width:200px;background:#222;color:#fff;margin-right:10px;padding:10px;box-sizing:border-box;}
  footer button#fullscreen-button{position:absolute;right:0;bottom:0;width:80px;height:80px;padding:0;display:flex;align-items:center;justify-content:center;}
  .modal{position:fixed;top:0;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;z-index:20;background:transparent;}
  .modal-content{background:rgba(0,0,0,0.5);color:#fff;width:600px;padding:20px;box-sizing:border-box;text-align:center;}
  .modal-content img{max-width:100%;height:auto;}
  .icon-inline{width:16px;height:16px;fill:#fff;vertical-align:middle;background:#000;border-radius:2px;}
  ::-webkit-scrollbar{width:10px;height:10px;}
  ::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.5);border-radius:5px;}
  ::-webkit-scrollbar-track{background:rgba(0,0,0,0.1);}

  /* Filter panel specific styles */
  #filter-panel{background:#444;color:#fff;width:420px;}
  #filter-panel .panel-header{height:60px;display:flex;align-items:center;justify-content:center;position:relative;font-size:24px;}
  #filter-panel .panel-header .title{flex:1;text-align:center;}
  #filter-panel .panel-header .header-right{position:absolute;right:10px;display:flex;gap:10px;}
  #filter-panel .panel-header .snap-left{position:absolute;left:10px;}
  #filter-panel .panel-header button{background:#333;color:#fff;width:40px;height:40px;padding:0;display:flex;align-items:center;justify-content:center;}
  #filter-panel .panel-header .close{width:auto;padding:0 10px;}
  #filter-panel .row{width:400px;height:40px;margin:10px 0;display:flex;align-items:center;justify-content:space-between;position:relative;}
  #filter-panel input{width:300px;height:40px;border:none;padding:0 10px;}
  #filter-panel input::placeholder{color:grey;}
  #filter-panel button.icon-button{width:40px;height:40px;padding:0;display:flex;align-items:center;justify-content:center;}
  #filter-panel #sort-menu{width:300px;height:40px;display:flex;align-items:center;justify-content:space-between;padding:0 10px;}
  #filter-panel .menu-arrow{transition:transform 0.3s;}
  #filter-panel .menu{display:flex;flex-direction:column;position:absolute;top:50px;left:0;background:#222;width:300px;z-index:10;max-height:0;overflow:hidden;opacity:0;pointer-events:none;transition:max-height 0.3s ease,opacity 0.3s ease;}
  #filter-panel .menu button{width:100%;height:40px;display:flex;align-items:center;justify-content:space-between;padding:10px;background:#333;color:#fff;}
  #filter-panel .menu.open{max-height:200px;opacity:1;pointer-events:auto;}
  #filter-panel .star{color:yellow;}
  #filter-panel #map-controls-row .mapboxgl-ctrl-geocoder{width:300px;}
  #map-controls-row .mapboxgl-ctrl-geolocate,#map-controls-row .mapboxgl-ctrl-compass,#map-controls-row .mapboxgl-ctrl-group{width:40px;height:40px;}
  #map-controls-row .mapboxgl-ctrl-compass{display:flex !important;}
  #filter-panel .mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--icon-search{display:none;}
  #filter-panel #clear-filters{width:400px;height:40px;}
  #date-range-input{background:#fff;cursor:pointer;}
  #daterange-row{gap:60px;}
  #expired-events-row{color:#fff;display:flex;align-items:center;gap:10px;}
  #expired-events-row label{cursor:pointer;}
  #expired-events-switch{width:40px;height:20px;appearance:none;background:grey;border-radius:10px;position:relative;cursor:pointer;}
  #expired-events-switch::before{content:'';position:absolute;top:2px;left:2px;width:16px;height:16px;background:#fff;border-radius:50%;transition:0.3s;}
  #expired-events-switch:checked{background:red;}
  #expired-events-switch:checked::before{left:22px;}
  #filter-calendar-container{width:400px;height:200px;overflow-x:auto;position:relative;background:#fff;color:#000;margin:10px 0;}
  #today-dot{position:absolute;bottom:0;width:6px;height:6px;background:red;border-radius:50%;cursor:pointer;}
  #filter-calendar{display:flex;height:194px;}
  .filter-month{width:250px;height:194px;display:grid;grid-template-columns:repeat(7,1fr);grid-template-rows:30px 20px repeat(6,1fr);}
  .filter-calendar-header{grid-column:1/8;background:navy;color:white;font-size:16px;text-align:center;line-height:30px;}
  .filter-calendar-weekdays{grid-column:1/8;display:grid;grid-template-columns:repeat(7,1fr);font-size:10px;color:lightgrey;text-align:center;line-height:20px;}
  .day{display:flex;align-items:center;justify-content:center;font-size:12px;}
  .past{background:#eee;}
  .start-date{background:navy;color:#fff;border-radius:4px 0 0 4px;}
  .end-date{background:navy;color:#fff;border-radius:0 4px 4px 0;}
  .in-range{background:#b0c4de;}
  .today{color:red;}
  .active-filter{background:red !important;}
</style>
</head>
<body>
<header>
  <div class="group left-buttons">
    <button id="filter-button"><svg class="icon" viewBox="0 0 24 24"><path d="M10 2a8 8 0 105.293 14.293l5.707 5.707-1.414 1.414-5.707-5.707A8 8 0 1010 2zm0 2a6 6 0 110 12 6 6 0 010-12z"/></svg><span class="count">1000</span></button>
    <button id="list-button">List</button>
    <button id="posts-button">Posts</button>
  </div>
  <img src="assets/funmap-logo-big.png" alt="Funmap" class="logo" id="logo">
  <div class="group right-buttons">
    <button id="member-button">Members</button>
    <button id="admin-button">Admin</button>
    <button id="settings-button"><svg class="icon" viewBox="0 0 24 24"><path d="M11.983 2c-.552 0-1.003.45-1.003 1v1.07a7.985 7.985 0 00-2.269.946l-.76-.76a1 1 0 00-1.414 0L5.293 5.5a1 1 0 000 1.414l.76.76A7.985 7.985 0 004.77 9.978H3.7c-.55 0-1 .451-1 1.003v2.038c0 .552.45 1.003 1 1.003h1.07a7.985 7.985 0 00.946 2.269l-.76.76a1 1 0 000 1.414l1.414 1.414a1 1 0 001.414 0l.76-.76a7.985 7.985 0 002.269.946V21c0 .55.451 1 1.003 1h2.038c.552 0 1.003-.45 1.003-1v-1.07a7.985 7.985 0 002.269-.946l.76.76a1 1 0 001.414 0l1.414-1.414a1 1 0 000-1.414l-.76-.76a7.985 7.985 0 00.946-2.269H20.3c.55 0 1-.451 1-1.003v-2.038c0-.552-.45-1.003-1-1.003h-1.07a7.985 7.985 0 00-.946-2.269l.76-.76a1 1 0 000-1.414L17.63 3.646a1 1 0 00-1.414 0l-.76.76a7.985 7.985 0 00-2.269-.946V3c0-.55-.451-1-1.003-1h-2.038zM12 15.5a3.5 3.5 0 110-7 3.5 3.5 0 010 7z"/></svg></button>
  </div>
</header>
<div id="map"></div>
<div id="filter-panel" class="panel left">
  <div class="panel-header">
    <button class="icon-button snap-left" aria-label="Snap left">◀</button>
    <div class="title">Filters</div>
    <div class="header-right">
      <button class="icon-button snap-right" aria-label="Snap right">▶</button>
      <button class="icon-button close" aria-label="Close">Close</button>
    </div>
  </div>
  <div class="row" id="sort-row">
    <button id="sort-menu">Title A-Z <span class="menu-arrow">▼</span></button>
    <div id="sort-options" class="menu">
      <button data-sort="favourites" id="favourites-option">Favourites on top <span class="star">☆</span></button>
      <button data-sort="title">Title A-Z</button>
      <button data-sort="closest">Closest</button>
      <button data-sort="soonest">Soonest</button>
    </div>
  </div>
  <div class="row" id="map-controls-row">
    <div id="geocoder"></div>
    <div style="display:flex;gap:10px;">
      <div id="geolocate-btn"></div>
      <div id="compass-btn"></div>
    </div>
  </div>
  <div class="row" id="filter-message">0 results showing out of 0 results in the area.</div>
  <div class="row" id="keywords-row">
    <input type="text" id="keywords-input" placeholder="Keywords">
    <button id="keywords-clear" class="icon-button">✕</button>
  </div>
  <div class="row" id="daterange-row">
    <input type="text" id="date-range-input" placeholder="Date Range" readonly>
    <button id="daterange-clear" class="icon-button">✕</button>
  </div>
  <div class="row" id="expired-events-row">
    <label for="expired-events-switch">Show Expired Events</label>
    <input type="checkbox" id="expired-events-switch">
  </div>
  <div id="filter-calendar-container">
    <div id="today-dot"></div>
    <div id="filter-calendar"></div>
  </div>
  <div class="row">
    <button id="clear-filters">Clear Filters</button>
  </div>
</div>
<div id="list-panel" class="panel left"></div>
<div id="posts-panel" class="panel left"></div>
<div id="member-panel" class="panel right"></div>
<div id="admin-panel" class="panel right"></div>
<div id="settings-panel" class="panel right"></div>
<footer>
  <div class="cards" id="recent-cards"></div>
  <button id="fullscreen-button"><svg class="icon" viewBox="0 0 24 24"><path d="M3 3h6v2H5v4H3V3zm18 0v6h-2V5h-4V3h6zm0 18h-6v-2h4v-4h2v6zM3 21v-6h2v4h4v2H3z"/></svg></button>
  </footer>
<div id="welcome-modal" class="modal" style="display:none;">
  <div class="modal-content">
    <img src="assets/funmap-logo-big.png" alt="Funmap">
    <p>Welcome to Funmap! Choose an area on the map to search for events and posts. Click <svg class="icon-inline" viewBox="0 0 24 24"><path d="M10 2a8 8 0 105.293 14.293l5.707 5.707-1.414 1.414-5.707-5.707A8 8 0 1010 2zm0 2a6 6 0 110 12 6 6 0 010-12z"/></svg> to refine your search.</p>
  </div>
</div>
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="https://unpkg.com/@mapbox/mapbox-gl-geocoder@5.0.1/dist/mapbox-gl-geocoder.min.js"></script>
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoienhlbiIsImEiOiJjbWViaDRibXEwM2NrMm1wcDhjODg4em5iIn0.2A9teACgwpiCy33uO4WZJQ';
const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/streets-v12',
  projection: 'globe',
  center: [0, 0],
  zoom: 1
});
if (typeof MapboxGeocoder !== 'undefined') {
  const geocoder = new MapboxGeocoder({
    accessToken: mapboxgl.accessToken,
    mapboxgl: mapboxgl,
    placeholder: 'Location'
  });
  document.getElementById('geocoder').appendChild(geocoder.onAdd(map));
  geocoder.on('result',e=>{map.easeTo({center:e.result.center,zoom:map.getZoom(),pitch:45});});
} else {
  console.warn('MapboxGeocoder is not available. Geocoding disabled.');
}
const geolocateControl = new mapboxgl.GeolocateControl({positionOptions:{enableHighAccuracy:true},trackUserLocation:true});
const geoContainer = geolocateControl.onAdd(map);
document.getElementById('geolocate-btn').appendChild(geoContainer);
geolocateControl.on('geolocate',e=>{map.easeTo({center:[e.coords.longitude,e.coords.latitude],zoom:14,pitch:45});});
const navControl = new mapboxgl.NavigationControl({showCompass:true,showZoom:false});
const navContainer = navControl.onAdd(map);
document.getElementById('compass-btn').appendChild(navContainer);
map.on('styleimagemissing',e=>{
  if(e.id==='marker-15'){
    map.loadImage('https://docs.mapbox.com/mapbox-gl-js/assets/custom_marker.png',(err,image)=>{
      if(!err && !map.hasImage('marker-15')){map.addImage('marker-15',image);}
    });
  }
});
map.on('load',()=>{
  map.setFog({
    'color': '#0b1d51',
    'high-color': '#1a2849',
    'space-color': '#000000',
    'horizon-blend': 0.1,
    'star-intensity': 0.8
  });
  map.addSource('points',{
    type:'geojson',
    data:{
      type:'FeatureCollection',
      features:[
        {type:'Feature',properties:{},geometry:{type:'Point',coordinates:[0,0]}},
        {type:'Feature',properties:{},geometry:{type:'Point',coordinates:[10,0]}},
        {type:'Feature',properties:{},geometry:{type:'Point',coordinates:[20,0]}}
      ]
    },
    cluster:true,
    clusterMaxZoom:14,
    clusterRadius:50
  });
  map.addLayer({id:'clusters',type:'circle',source:'points',filter:['has','point_count'],paint:{'circle-color':'#51bbd6','circle-radius':['step',['get','point_count'],20,100,30,750,40]}});
  map.addLayer({id:'cluster-count',type:'symbol',source:'points',filter:['has','point_count'],layout:{'text-field':['get','point_count_abbreviated'],'text-font':['DIN Offc Pro Medium','Arial Unicode MS Bold'],'text-size':12}});
  map.addLayer({id:'unclustered-point',type:'symbol',source:'points',filter:['!has','point_count'],layout:{'icon-image':'marker-15','icon-size':2}});
  map.on('click','clusters',function(e){const features=map.queryRenderedFeatures(e.point,{layers:['clusters']});const clusterId=features[0].properties.cluster_id;map.getSource('points').getClusterExpansionZoom(clusterId,function(err,zoom){if(err)return;map.easeTo({center:features[0].geometry.coordinates,zoom:zoom,pitch:45});});});
  map.on('click','unclustered-point',function(e){openPanel('posts');});
});
function togglePanel(btn,panel){
  btn.addEventListener('click',()=>{
    panel.classList.toggle('open');
    btn.classList.toggle('selected',panel.classList.contains('open'));
    if(btn.id==='posts-button'){
      btn.textContent=panel.classList.contains('open')?'Posts':'Map';
    }
  });
}
const filterBtn=document.getElementById('filter-button');
const listBtn=document.getElementById('list-button');
const postsBtn=document.getElementById('posts-button');
const memberBtn=document.getElementById('member-button');
const adminBtn=document.getElementById('admin-button');
const settingsBtn=document.getElementById('settings-button');
function openPanel(name){
  const panel=document.getElementById(name+'-panel');
  panel.classList.add('open');
  const btn=document.getElementById(name+'-button');
  if(btn) btn.classList.add('selected');
  if(name==='posts'){postsBtn.textContent='Posts';}
}
const filterPanel=document.getElementById('filter-panel');
const listPanel=document.getElementById('list-panel');
const postsPanel=document.getElementById('posts-panel');
const memberPanel=document.getElementById('member-panel');
const adminPanel=document.getElementById('admin-panel');
const settingsPanel=document.getElementById('settings-panel');
filterBtn.addEventListener('click',()=>{
  if(filterPanel.classList.contains('open')){
    closeFilterPanel();
  }else{
    filterPanel.classList.add('open');
    filterBtn.classList.add('selected');
  }
});
togglePanel(listBtn,listPanel);
togglePanel(postsBtn,postsPanel);
togglePanel(memberBtn,memberPanel);
togglePanel(adminBtn,adminPanel);
togglePanel(settingsBtn,settingsPanel);
const logo=document.getElementById('logo');
const modal=document.getElementById('welcome-modal');
logo.addEventListener('click',()=>{modal.style.display='flex';});
modal.addEventListener('click',e=>{if(e.target===modal)modal.style.display='none';});
if(!localStorage.getItem('welcomeShown')){modal.style.display='flex';localStorage.setItem('welcomeShown','true');}
const fsBtn=document.getElementById('fullscreen-button');
fsBtn.addEventListener('click',()=>{if(!document.fullscreenElement){document.documentElement.requestFullscreen();}else{document.exitFullscreen();}});

/* Filter panel interactions */
const sortMenu=document.getElementById('sort-menu');
const sortOptions=document.getElementById('sort-options');
const menuArrow=sortMenu.querySelector('.menu-arrow');
const favOption=document.getElementById('favourites-option');
let favouritesOnTop=false;
let sortOrder='Title A-Z';
sortMenu.addEventListener('click',e=>{
  e.stopPropagation();
  sortOptions.classList.toggle('open');
  menuArrow.style.transform=sortOptions.classList.contains('open')?'rotate(180deg)':'rotate(0deg)';
});
sortOptions.addEventListener('click',e=>e.stopPropagation());
document.addEventListener('click',()=>{
  sortOptions.classList.remove('open');
  menuArrow.style.transform='rotate(0deg)';
});
sortOptions.querySelectorAll('button').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const type=btn.dataset.sort;
    if(type==='favourites'){
      favouritesOnTop=!favouritesOnTop;
      favOption.querySelector('.star').textContent=favouritesOnTop?'★':'☆';
      return;
    }
    sortOrder=btn.textContent;
    sortMenu.firstChild.textContent=sortOrder+' ';
    sortOptions.classList.remove('open');
    menuArrow.style.transform='rotate(0deg)';
  });
});
const keywordsInput=document.getElementById('keywords-input');
const keywordsClear=document.getElementById('keywords-clear');
const dateRangeInput=document.getElementById('date-range-input');
const dateRangeClear=document.getElementById('daterange-clear');
const expiredSwitch=document.getElementById('expired-events-switch');
const filterCalendarContainer=document.getElementById('filter-calendar-container');
const filterCalendar=document.getElementById('filter-calendar');
const todayDot=document.getElementById('today-dot');
const clearFiltersBtn=document.getElementById('clear-filters');
let startDate=null,endDate=null;
generateCalendar(false);
updateFilterState();

function generateCalendar(includePast){
  filterCalendar.innerHTML='';
  const today=new Date();
  today.setHours(0,0,0,0);
  let start=new Date(today);
  if(includePast){start.setMonth(start.getMonth()-12);}
  const months=includePast?36:24;
  for(let i=0;i<months;i++){
    const monthDate=new Date(start);
    monthDate.setMonth(start.getMonth()+i);
    const month=monthDate.getMonth();
    const year=monthDate.getFullYear();
    const monthEl=document.createElement('div');
    monthEl.className='filter-month';
    const header=document.createElement('div');
    header.className='filter-calendar-header';
    header.textContent=monthDate.toLocaleString('en-US',{month:'long',year:'numeric'});
    monthEl.appendChild(header);
    const weekdays=document.createElement('div');
    weekdays.className='filter-calendar-weekdays';
    ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{const s=document.createElement('span');s.textContent=d;weekdays.appendChild(s);});
    monthEl.appendChild(weekdays);
    const firstDay=new Date(year,month,1).getDay();
    const daysInMonth=new Date(year,month+1,0).getDate();
    for(let j=0;j<firstDay;j++){monthEl.appendChild(document.createElement('div'));}
    for(let d=1;d<=daysInMonth;d++){
      const date=new Date(year,month,d);
      const dayEl=document.createElement('div');
      dayEl.className='day';
      dayEl.textContent=d;
      dayEl.dataset.date=date.toISOString();
      if(date<today)dayEl.classList.add('past');
      if(date.getTime()===today.getTime())dayEl.classList.add('today');
      dayEl.addEventListener('click',()=>selectDate(date));
      monthEl.appendChild(dayEl);
    }
    const totalCells=firstDay+daysInMonth;
    for(let k=totalCells;k<42;k++){monthEl.appendChild(document.createElement('div'));}
    filterCalendar.appendChild(monthEl);
  }
  todayDot.style.left=includePast?(filterCalendarContainer.clientWidth/3)+'px':'0';
  filterCalendarContainer.scrollLeft=(includePast?12:0)*250;
}

function selectDate(date){
  const time=date.getTime();
  if(!startDate || (startDate && endDate)){startDate=time;endDate=null;}
  else if(time<startDate){endDate=startDate;startDate=time;}
  else{endDate=time;}
  highlightRange();
  updateDateRangeInput();
  updateFilterState();
}

function highlightRange(){
  document.querySelectorAll('#filter-calendar .day').forEach(d=>{
    const t=new Date(d.dataset.date).getTime();
    d.classList.remove('start-date','end-date','in-range');
    if(startDate && t===startDate)d.classList.add('start-date');
    if(endDate && t===endDate)d.classList.add('end-date');
    if(startDate && endDate && t>startDate && t<endDate)d.classList.add('in-range');
  });
}

function formatDateRange(start,end){
  const opts={weekday:'short',day:'numeric',month:'short'};
  const startStr=start.toLocaleDateString('en-US',opts);
  const endStr=end.toLocaleDateString('en-US',opts);
  const currentYear=(new Date()).getFullYear();
  const startYear=start.getFullYear()!==currentYear?`, ${start.getFullYear()}`:'';
  const endYear=end.getFullYear()!==currentYear?`, ${end.getFullYear()}`:'';
  return `${startStr}${startYear} – ${endStr}${endYear}`;
}

function updateDateRangeInput(){
  if(startDate && endDate){
    const start=new Date(startDate);
    const end=new Date(endDate);
    dateRangeInput.value=formatDateRange(start,end);
  }else{
    dateRangeInput.value='';
  }
}

function updateFilterState(){
  const keywordActive=keywordsInput.value.trim()!=='';
  const dateActive=dateRangeInput.value.trim()!=='';
  const expiredActive=expiredSwitch.checked;
  filterBtn.classList.toggle('active-filter',keywordActive||dateActive||expiredActive);
  keywordsClear.classList.toggle('active-filter',keywordActive);
  dateRangeClear.classList.toggle('active-filter',dateActive);
  expiredSwitch.classList.toggle('active-filter',expiredActive);
  clearFiltersBtn.classList.toggle('active-filter',keywordActive||dateActive||expiredActive);
}

keywordsInput.addEventListener('input',updateFilterState);
keywordsClear.addEventListener('click',()=>{keywordsInput.value='';updateFilterState();});
dateRangeClear.addEventListener('click',()=>{startDate=endDate=null;updateDateRangeInput();highlightRange();updateFilterState();});
expiredSwitch.addEventListener('change',()=>{generateCalendar(expiredSwitch.checked);updateFilterState();});
todayDot.addEventListener('click',()=>{const idx=expiredSwitch.checked?12:0;filterCalendarContainer.scrollTo({left:idx*250,behavior:'smooth'});});
clearFiltersBtn.addEventListener('click',()=>{
  keywordsInput.value='';
  startDate=endDate=null;
  updateDateRangeInput();
  expiredSwitch.checked=false;
  generateCalendar(false);
  updateFilterState();
});
document.querySelector('#filter-panel .close').addEventListener('click',closeFilterPanel);
document.addEventListener('keydown',e=>{
  if(e.key==='Escape' && filterPanel.classList.contains('open')){
    closeFilterPanel();
  }
});
document.querySelector('#filter-panel .snap-left').addEventListener('click',()=>{
  filterPanel.classList.add('left');
  filterPanel.classList.remove('right');
  filterPanel.style.left='0';
  filterPanel.style.right='auto';
  });
document.querySelector('#filter-panel .snap-right').addEventListener('click',()=>{
  filterPanel.classList.add('right');
  filterPanel.classList.remove('left');
  filterPanel.style.right='0';
  filterPanel.style.left='auto';
  });
let dragging=false,offsetX=0;
const header=document.querySelector('#filter-panel .panel-header');
header.addEventListener('mousedown',e=>{dragging=true;offsetX=e.clientX-filterPanel.offsetLeft;});
document.addEventListener('mousemove',e=>{
  if(!dragging)return;
  let newLeft=e.clientX-offsetX;
  const maxLeft=window.innerWidth-filterPanel.offsetWidth;
  if(newLeft<0)newLeft=0; if(newLeft>maxLeft)newLeft=maxLeft;
  filterPanel.style.left=newLeft+'px';
  filterPanel.style.right='auto';
});
document.addEventListener('mouseup',()=>{dragging=false;});
window.addEventListener('resize',()=>{
  const maxLeft=window.innerWidth-filterPanel.offsetWidth;
  const left=parseInt(getComputedStyle(filterPanel).left)||0;
  if(left>maxLeft)filterPanel.style.left=maxLeft+'px';
});

function closeFilterPanel(){
  const left=filterPanel.getBoundingClientRect().left;
  const right=window.innerWidth-left-filterPanel.offsetWidth;
  if(left<=right){
    filterPanel.classList.add('left');
    filterPanel.classList.remove('right');
    filterPanel.style.left='0';
    filterPanel.style.right='auto';
  }else{
    filterPanel.classList.add('right');
    filterPanel.classList.remove('left');
    filterPanel.style.right='0';
    filterPanel.style.left='auto';
  }
  sortOptions.classList.remove('open');
  menuArrow.style.transform='rotate(0deg)';
  filterPanel.classList.remove('open');
  filterBtn.classList.remove('selected');
}
</script>
</body>
</html>
