<!DOCTYPE html>
<html>
<head>
    <title>Map Wallpaper Generator</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.9.4/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.9.4/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; padding: 20px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #1a1a1a; color: #eee; }
        .container { max-width: 800px; margin: 0 auto; }
        #status-box { background: #222; padding: 15px; border-radius: 8px; border: 1px solid #333; margin-bottom: 20px; }
        #log { height: 300px; overflow-y: auto; background: #000; color: #0f0; padding: 10px; font-family: monospace; font-size: 12px; border-radius: 4px; margin-bottom: 20px; }
        button { background: #0078d4; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600; }
        button:disabled { background: #444; cursor: not-allowed; }
        textarea { width: 100%; height: 200px; background: #222; color: #ccc; border: 1px solid #333; border-radius: 4px; padding: 10px; font-family: monospace; font-size: 12px; }
        .progress-bar { height: 10px; background: #333; border-radius: 5px; margin-top: 10px; overflow: hidden; }
        #progress-fill { height: 100%; background: #0078d4; width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Map Wallpaper Generator</h1>
        <div id="status-box">
            <div>Status: <span id="status-text">Ready</span></div>
            <div class="progress-bar"><div id="progress-fill"></div></div>
            <div style="margin-top: 5px; font-size: 12px; color: #888;" id="progress-text">0 / 0 locations</div>
        </div>

        <div style="margin-bottom: 20px; background: #333; padding: 15px; border-radius: 5px;">
            <label for="resumeIndex">Resume from Location #:</label>
            <input type="number" id="resumeIndex" value="1" min="1" style="width: 80px; padding: 5px; background: #444; color: white; border: 1px solid #555;">
            <span style="font-size: 12px; color: #888; margin-left: 10px;">(Check your log: if it stopped at 1381, enter 1381)</span>
        </div>

        <button id="btnStart">Initialize Map Engine</button>
        <button id="btnCapture" style="display:none;">Select Folder & Begin Capture</button>

        <div id="log"></div>

        <h3>SQL Import Data</h3>
        <textarea id="sql-output" readonly placeholder="SQL statements will appear here as images are saved..."></textarea>
    </div>

    <div id="map" style="width: 700px; height: 2500px; position: absolute; left: -9999px;"></div>

    <script>
        const ACCESS_TOKEN = 'pk.eyJ1IjoienhlbiIsImEiOiJjbWViaDRibXEwM2NrMm1wcDhjODg4em5iIn0.2A9teACgwpiCy33uO4WZJQ';
        const ZOOM = 18;
        const PITCH = 75;
        const WIDTH = 700;
        const HEIGHT = 2500;
        const BEARINGS = [0, 90, 180, 270]; // N, E, S, W
        const BEARING_NAMES = { 0: 'N', 90: 'E', 180: 'S', 270: 'W' };
        const MAP_STYLE = 'mapbox://styles/mapbox/standard';
        const LIGHT_PRESET = 'night';

        let locations = [];
        let map = null;
        let directoryHandle = null;

        function log(msg, isError = false) {
            const div = document.createElement('div');
            div.textContent = `${new Date().toLocaleTimeString()}: ${msg}`;
            if (isError) div.style.color = '#ff5555';
            const logEl = document.getElementById('log');
            logEl.appendChild(div);
            logEl.scrollTop = logEl.scrollHeight;
            console.log(msg);
        }

        function slugify(text) {
            return text.toString().toLowerCase()
                .replace(/\s+/g, '-')           // Replace spaces with -
                .replace(/[^\w\-]+/g, '')       // Remove all non-word chars
                .replace(/\-\-+/g, '-')         // Replace multiple - with single -
                .replace(/^-+/, '')             // Trim - from start
                .replace(/-+$/, '')             // Trim - from end
                .substring(0, 50);              // Limit to 50 chars
        }

        async function initMap() {
            mapboxgl.accessToken = ACCESS_TOKEN;
            return new Promise((resolve, reject) => {
                try {
                    map = new mapboxgl.Map({
                        container: 'map',
                        style: MAP_STYLE,
                        center: [0, 0],
                        zoom: ZOOM,
                        pitch: PITCH,
                        interactive: false,
                        preserveDrawingBuffer: true,
                        attributionControl: false
                    });

                    const timeout = setTimeout(() => {
                        reject(new Error("Map load timeout (15s)"));
                    }, 15000);

                    map.on('style.load', () => {
                        map.setConfigProperty('basemap', 'lightPreset', LIGHT_PRESET);
                    });

                    map.on('load', () => {
                        clearTimeout(timeout);
                        resolve();
                    });

                    map.on('error', (e) => {
                        log("Mapbox error: " + (e.error ? e.error.message : "Unknown"), true);
                    });
                } catch (e) {
                    reject(e);
                }
            });
        }

        async function captureImage(lat, lng, bearing, filename) {
            return new Promise((resolve, reject) => {
                map.jumpTo({
                    center: [lng, lat],
                    zoom: ZOOM,
                    pitch: PITCH,
                    bearing: bearing
                });

                const timeout = setTimeout(() => {
                    log(`Timeout waiting for map idle at ${lat}, ${lng} (Bearing ${bearing}). Skipping.`, true);
                    resolve(null); 
                }, 15000);

                map.once('idle', () => {
                    clearTimeout(timeout);
                    map.getCanvas().toBlob(async (blob) => {
                        try {
                            const fileHandle = await directoryHandle.getFileHandle(filename, { create: true });
                            const writable = await fileHandle.createWritable();
                            await writable.write(blob);
                            await writable.close();
                            resolve(true);
                        } catch (e) {
                            reject(e);
                        }
                    }, 'image/webp', 0.85);
                });
            });
        }

        document.getElementById('btnStart').addEventListener('click', async () => {
            const btn = document.getElementById('btnStart');
            btn.disabled = true;
            document.getElementById('status-text').textContent = "Initializing Map Engine...";
            
            try {
                log("Loading location list...");
                const response = await fetch('full_locations.json');
                if (!response.ok) throw new Error("Could not find full_locations.json");
                locations = await response.json();
                log(`Loaded ${locations.length} locations.`);

                log("Starting Mapbox engine...");
                await initMap();
                log("Map engine ready.");

                document.getElementById('status-text').textContent = "Ready to capture";
                document.getElementById('btnCapture').style.display = 'inline-block';
                btn.style.display = 'none';
            } catch (e) {
                log("FATAL ERROR: " + e.message, true);
                btn.disabled = false;
            }
        });

        document.getElementById('btnCapture').addEventListener('click', async () => {
            try {
                directoryHandle = await window.showDirectoryPicker();
                document.getElementById('btnCapture').disabled = true;
                
                const resumeIndex = parseInt(document.getElementById('resumeIndex').value) - 1;
                const total = locations.length;
                const sqlOutput = document.getElementById('sql-output');
                
                for (let i = resumeIndex; i < total; i++) {
                    const loc = locations[i];
                    const progress = Math.round(((i + 1) / total) * 100);
                    document.getElementById('progress-fill').style.width = `${progress}%`;
                    document.getElementById('progress-text').textContent = `${i + 1} / ${total} locations (${loc.name})`;
                    
                    log(`Processing #${i + 1}: ${loc.name}...`);
                    
                    const slug = slugify(loc.name);
                    const lat = loc.lat;
                    const lng = loc.lng;
                    
                    let sqlBatch = "";
                    
                    for (const bearing of BEARINGS) {
                        const bName = BEARING_NAMES[bearing];
                        const filename = `${slug}__${lat}_${lng}__Z${ZOOM}-P${PITCH}-${bName}.webp`;
                        
                        const success = await captureImage(lat, lng, bearing, filename);
                        
                        if (success) {
                            const url = `https://cdn.funmap.com/map-images/${filename}`;
                            sqlBatch += `(${lat}, ${lng}, 'venue', ${bearing}, ${PITCH}, ${ZOOM}, '${filename}', '${url}', ${WIDTH}, ${HEIGHT}),\n`;
                        }
                    }
                    
                    if (sqlBatch) {
                        sqlOutput.value += sqlBatch;
                    }
                }
                
                log("ALL TASKS COMPLETE.");
                document.getElementById('status-text').textContent = "Finished";
            } catch (e) {
                log("ERROR: " + e.message, true);
                document.getElementById('btnCapture').disabled = false;
            }
        });
    </script>
</body>
</html>
