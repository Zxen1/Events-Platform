<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallpaper Image Generator</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.9.2/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.9.2/mapbox-gl.css" rel="stylesheet" />
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px; 
            background: #1a1a1a; 
            color: #fff;
            margin: 0;
        }
        h1 { margin: 0 0 20px 0; }
        .controls { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        button {
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:disabled {
            background: #444;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
            background: #0055aa;
        }
        #status {
            padding: 15px;
            background: #2a2a2a;
            border-radius: 5px;
            margin-bottom: 20px;
            min-height: 100px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
        }
        #progress {
            margin-bottom: 20px;
        }
        #progress-bar {
            width: 100%;
            height: 30px;
            background: #333;
            border-radius: 5px;
            overflow: hidden;
        }
        #progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #0066cc, #00cc66);
            width: 0%;
            transition: width 0.3s;
        }
        #progress-text {
            text-align: center;
            margin-top: 5px;
            font-size: 14px;
        }
        .stats {
            display: flex;
            gap: 30px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .stat {
            background: #2a2a2a;
            padding: 15px 25px;
            border-radius: 5px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #0099ff;
        }
        .stat-label {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        #sql-output {
            display: none;
            margin-top: 20px;
        }
        #sql-output textarea {
            width: 100%;
            height: 300px;
            background: #1a1a1a;
            color: #0f0;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
        }
        #map-container {
            width: 700px;
            height: 2500px;
            position: fixed;
            right: 20px;
            top: 20px;
            border: 2px solid #0f0;
            z-index: 9999;
            transform: scale(0.15);
            transform-origin: top right;
        }
        .preview-label {
            position: fixed;
            right: 130px;
            top: 5px;
            background: #0f0;
            color: #000;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: bold;
            z-index: 10000;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>Wallpaper Image Generator</h1>
    
    <div class="stats">
        <div class="stat">
            <div class="stat-value" id="total-locations">-</div>
            <div class="stat-label">Unique Locations</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="total-images">-</div>
            <div class="stat-label">Images to Generate</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="completed-images">0</div>
            <div class="stat-label">Completed</div>
        </div>
    </div>
    
    <div class="controls">
        <button id="btn-load">1. Load Locations</button>
        <button id="btn-folder" disabled>2. Select Save Folder</button>
        <button id="btn-test" disabled>3. Test (5 locations)</button>
        <button id="btn-start" disabled>4. Generate All</button>
        <button id="btn-pause" disabled>Pause</button>
        <button id="btn-download-sql" disabled>5. Download SQL</button>
    </div>
    
    <div id="progress">
        <div id="progress-bar"><div id="progress-fill"></div></div>
        <div id="progress-text">Ready</div>
    </div>
    
    <div id="status">Click "Load Locations" to fetch coordinates from post_map_cards...</div>
    
    <div id="sql-output">
        <h3>Generated SQL</h3>
        <textarea id="sql-textarea" readonly></textarea>
    </div>

    <div class="preview-label">Live Preview</div>
    <div id="map-container"></div>

    <script>
        // ============================================================
        // CONFIGURATION
        // ============================================================
        const IMAGE_WIDTH = 700;
        const IMAGE_HEIGHT = 2500;
        const STYLE_URL = 'mapbox://styles/mapbox/standard';
        
        // Camera settings
        function getCameras(locationType, lat, lng) {
            const isCity = String(locationType || '').toLowerCase() === 'city';
            const zoom = isCity ? 11 : 16;
            const pitch = 70;
            return [
                { center: [lng, lat], zoom, pitch, bearing: 0, direction: 'n' },
                { center: [lng, lat], zoom, pitch, bearing: 90, direction: 'e' },
                { center: [lng, lat], zoom, pitch, bearing: 180, direction: 's' },
                { center: [lng, lat], zoom, pitch, bearing: 270, direction: 'w' }
            ];
        }
        
        // ============================================================
        // STATE
        // ============================================================
        let locations = [];
        let saveFolder = null;
        let map = null;
        let mapReady = false;
        let isPaused = false;
        let currentIndex = 0;
        let currentCameraIndex = 0;
        let completedCount = 0;
        let sqlStatements = [];
        let testMode = false;
        const testLimit = 5;
        
        // ============================================================
        // DOM
        // ============================================================
        const statusEl = document.getElementById('status');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        
        function log(msg) {
            const time = new Date().toLocaleTimeString();
            statusEl.textContent = `[${time}] ${msg}\n` + statusEl.textContent;
            console.log(msg);
        }
        
        function updateProgress() {
            const maxLocs = testMode ? Math.min(testLimit, locations.length) : locations.length;
            const total = maxLocs * 4;
            const pct = total > 0 ? (completedCount / total * 100).toFixed(1) : 0;
            progressFill.style.width = pct + '%';
            progressText.textContent = `${completedCount} / ${total} (${pct}%)`;
            document.getElementById('completed-images').textContent = completedCount;
        }
        
        // ============================================================
        // MAPBOX - Standalone implementation with proper tile detection
        // ============================================================
        function initMap(startLng, startLat) {
            return new Promise((resolve, reject) => {
                log('Creating Mapbox map...');
                
                try {
                    map = new mapboxgl.Map({
                        container: 'map-container',
                        style: STYLE_URL,
                        projection: 'globe',
                        center: [startLng, startLat],
                        zoom: 16,
                        pitch: 70,
                        bearing: 0,
                        interactive: false,
                        attributionControl: false,
                        preserveDrawingBuffer: true
                    });
                } catch (e) {
                    reject(new Error('Failed to create map: ' + e.message));
                    return;
                }
                
                map.once('style.load', function() {
                    log('Applying night style and hiding labels...');
                    try {
                        map.setConfigProperty('basemap', 'lightPreset', 'night');
                        map.setConfigProperty('basemap', 'showPointOfInterestLabels', false);
                        map.setConfigProperty('basemap', 'showPlaceLabels', false);
                        map.setConfigProperty('basemap', 'showRoadLabels', false);
                        map.setConfigProperty('basemap', 'showTransitLabels', false);
                    } catch (e) {
                        log('Warning: Could not set style properties');
                    }
                });
                
                map.once('idle', function() {
                    const canvas = map.getCanvas();
                    log(`Map ready: ${canvas.width}x${canvas.height}`);
                    log(`Initial position: ${startLat.toFixed(5)}, ${startLng.toFixed(5)}`);
                    mapReady = true;
                    resolve();
                });
                
                // Timeout fallback
                setTimeout(() => {
                    if (!mapReady) {
                        log('Warning: Map init timeout, proceeding anyway');
                        mapReady = true;
                        resolve();
                    }
                }, 15000);
            });
        }
        
        // Move to position and wait for ALL tiles to load
        function moveAndWaitForTiles(lng, lat, zoom, pitch, bearing) {
            return new Promise((resolve) => {
                // Move camera
                map.jumpTo({
                    center: [lng, lat],
                    zoom: zoom,
                    pitch: pitch,
                    bearing: bearing
                });
                
                // Track tile loading
                let tilesLoading = 0;
                let tilesLoaded = 0;
                let checkInterval = null;
                let resolved = false;
                
                function done() {
                    if (resolved) return;
                    resolved = true;
                    if (checkInterval) clearInterval(checkInterval);
                    map.off('sourcedataloading', onLoading);
                    map.off('sourcedata', onLoaded);
                    // Final delay to ensure render completes
                    setTimeout(resolve, 800);
                }
                
                function onLoading(e) {
                    if (e.tile) tilesLoading++;
                }
                
                function onLoaded(e) {
                    if (e.tile) {
                        tilesLoaded++;
                    }
                }
                
                map.on('sourcedataloading', onLoading);
                map.on('sourcedata', onLoaded);
                
                // Trigger repaint
                map.triggerRepaint();
                
                // Check periodically if map is idle and tiles are loaded
                let idleCount = 0;
                checkInterval = setInterval(() => {
                    const isIdle = map.areTilesLoaded() && !map.isMoving() && !map.isZooming();
                    if (isIdle) {
                        idleCount++;
                        // Require 3 consecutive idle checks (900ms of being idle)
                        if (idleCount >= 3) {
                            log(`  Tiles loaded (${tilesLoaded} tiles)`);
                            done();
                        }
                    } else {
                        idleCount = 0;
                    }
                }, 300);
                
                // Timeout fallback
                setTimeout(() => {
                    if (!resolved) {
                        log(`  Timeout - capturing anyway (${tilesLoaded} tiles loaded)`);
                        done();
                    }
                }, 12000);
            });
        }
        
        // Capture current view to blob
        function captureToBlob() {
            return new Promise((resolve) => {
                const canvas = map.getCanvas();
                
                // Try WebP first
                canvas.toBlob((blob) => {
                    if (blob && blob.size > 0) {
                        resolve({ blob, ext: 'webp' });
                    } else {
                        // Fallback to JPEG
                        canvas.toBlob((jpgBlob) => {
                            resolve({ blob: jpgBlob, ext: 'jpg' });
                        }, 'image/jpeg', 0.85);
                    }
                }, 'image/webp', 0.85);
            });
        }
        
        // ============================================================
        // FILENAME & SQL
        // ============================================================
        function generateFilename(lat, lng, direction, pitch, zoom, ext) {
            const latPrefix = lat < 0 ? 'n' : '';
            const lngPrefix = lng < 0 ? 'n' : '';
            const latStr = latPrefix + Math.abs(lat).toFixed(7);
            const lngStr = lngPrefix + Math.abs(lng).toFixed(7);
            return `${latStr}_${lngStr}_${direction}_p${pitch}_z${zoom}.${ext}`;
        }
        
        function generateSqlInsert(loc, cam, filename, fileSize) {
            const folderUrl = 'https://cdn.funmap.com/map-images';
            const fileUrl = `${folderUrl}/${filename}`;
            return `INSERT INTO map_images (latitude, longitude, location_type, bearing, pitch, zoom, file_name, file_url, file_size, width, height, created_at, updated_at) VALUES (${loc.latitude}, ${loc.longitude}, '${loc.location_type}', ${cam.bearing}, ${cam.pitch}, ${cam.zoom}, '${filename}', '${fileUrl}', ${fileSize}, ${IMAGE_WIDTH}, ${IMAGE_HEIGHT}, NOW(), NOW()) ON DUPLICATE KEY UPDATE file_url = VALUES(file_url), file_size = VALUES(file_size), updated_at = NOW());`;
        }
        
        // ============================================================
        // UI HANDLERS
        // ============================================================
        
        // Load locations
        document.getElementById('btn-load').addEventListener('click', async function() {
            this.disabled = true;
            log('Fetching locations from post_map_cards...');
            
            try {
                const response = await fetch('/gateway.php?action=get-map-card-locations');
                const data = await response.json();
                
                if (!data.success) throw new Error(data.message || 'Failed');
                
                locations = data.locations || [];
                document.getElementById('total-locations').textContent = locations.length;
                document.getElementById('total-images').textContent = locations.length * 4;
                
                log(`Loaded ${locations.length} locations (${locations.length * 4} images)`);
                
                // Show samples
                for (let i = 0; i < Math.min(3, locations.length); i++) {
                    const l = locations[i];
                    log(`  #${i+1}: ${l.latitude}, ${l.longitude} (${l.location_type})`);
                }
                
                if (locations.length > 0) {
                    // Set Mapbox token
                    if (!mapboxgl.accessToken) {
                        const token = prompt('Enter Mapbox Access Token:');
                        if (!token) { log('Token required'); return; }
                        mapboxgl.accessToken = token;
                    }
                    
                    // Initialize map at first location
                    await initMap(locations[0].longitude, locations[0].latitude);
                    
                    document.getElementById('btn-folder').disabled = false;
                }
            } catch (err) {
                log('Error: ' + err.message);
                this.disabled = false;
            }
        });
        
        // Select folder
        document.getElementById('btn-folder').addEventListener('click', async function() {
            try {
                if (!('showDirectoryPicker' in window)) {
                    log('ERROR: Use Chrome or Edge');
                    return;
                }
                saveFolder = await window.showDirectoryPicker({ mode: 'readwrite' });
                log(`Folder selected: ${saveFolder.name}`);
                document.getElementById('btn-test').disabled = false;
                document.getElementById('btn-start').disabled = false;
                this.textContent = '✓ Folder Selected';
            } catch (err) {
                if (err.name !== 'AbortError') log('Error: ' + err.message);
            }
        });
        
        // Test
        document.getElementById('btn-test').addEventListener('click', () => {
            testMode = true;
            startGeneration();
        });
        
        // Full run
        document.getElementById('btn-start').addEventListener('click', () => {
            testMode = false;
            startGeneration();
        });
        
        // Pause
        document.getElementById('btn-pause').addEventListener('click', function() {
            isPaused = !isPaused;
            this.textContent = isPaused ? 'Resume' : 'Pause';
            if (!isPaused) processNext();
            log(isPaused ? 'Paused' : 'Resuming...');
        });
        
        // Download SQL
        document.getElementById('btn-download-sql').addEventListener('click', function() {
            const blob = new Blob([sqlStatements.join('\n')], { type: 'text/sql' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'map_images_insert.sql';
            a.click();
            URL.revokeObjectURL(url);
            log('SQL downloaded');
        });
        
        // ============================================================
        // GENERATION LOOP
        // ============================================================
        function startGeneration() {
            document.getElementById('btn-test').disabled = true;
            document.getElementById('btn-start').disabled = true;
            document.getElementById('btn-folder').disabled = true;
            document.getElementById('btn-pause').disabled = false;
            
            isPaused = false;
            sqlStatements = [];
            completedCount = 0;
            currentIndex = 0;
            currentCameraIndex = 0;
            
            const maxLocs = testMode ? Math.min(testLimit, locations.length) : locations.length;
            log(`Starting: ${maxLocs} locations × 4 = ${maxLocs * 4} images`);
            
            processNext();
        }
        
        async function processNext() {
            if (isPaused) return;
            
            const maxLocs = testMode ? Math.min(testLimit, locations.length) : locations.length;
            if (currentIndex >= maxLocs) {
                finishGeneration();
                return;
            }
            
            const loc = locations[currentIndex];
            const cameras = getCameras(loc.location_type, loc.latitude, loc.longitude);
            const cam = cameras[currentCameraIndex];
            
            log(`[${currentIndex + 1}/${maxLocs}] ${cam.direction.toUpperCase()} @ ${loc.latitude.toFixed(5)}, ${loc.longitude.toFixed(5)}`);
            
            try {
                // Move and wait for tiles
                await moveAndWaitForTiles(cam.center[0], cam.center[1], cam.zoom, cam.pitch, cam.bearing);
                
                // Verify we're at the right place
                const center = map.getCenter();
                const expectedLat = loc.latitude;
                const expectedLng = loc.longitude;
                const latDiff = Math.abs(center.lat - expectedLat);
                const lngDiff = Math.abs(center.lng - expectedLng);
                
                if (latDiff > 0.0001 || lngDiff > 0.0001) {
                    log(`  WARNING: Position mismatch! Expected ${expectedLat},${expectedLng} got ${center.lat},${center.lng}`);
                }
                
                // Capture
                const { blob, ext } = await captureToBlob();
                
                if (!blob || blob.size < 1000) {
                    log('  ERROR: Capture failed or too small');
                } else {
                    const filename = generateFilename(loc.latitude, loc.longitude, cam.direction, cam.pitch, cam.zoom, ext);
                    
                    // Save
                    const fileHandle = await saveFolder.getFileHandle(filename, { create: true });
                    const writable = await fileHandle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                    
                    // SQL
                    sqlStatements.push(generateSqlInsert(loc, cam, filename, blob.size));
                    
                    completedCount++;
                    updateProgress();
                    log(`  ✓ ${filename} (${(blob.size/1024).toFixed(0)}KB)`);
                }
            } catch (err) {
                log(`  ERROR: ${err.message}`);
            }
            
            // Next
            currentCameraIndex++;
            if (currentCameraIndex >= 4) {
                currentCameraIndex = 0;
                currentIndex++;
            }
            
            // Small delay then continue
            setTimeout(processNext, 200);
        }
        
        function finishGeneration() {
            log('=' .repeat(50));
            log(`COMPLETE! ${completedCount} images saved`);
            if (testMode) {
                log('Check images, then click "Generate All"');
                document.getElementById('btn-test').disabled = false;
                document.getElementById('btn-start').disabled = false;
                document.getElementById('btn-folder').disabled = false;
            }
            log('='.repeat(50));
            
            document.getElementById('btn-pause').disabled = true;
            document.getElementById('btn-download-sql').disabled = false;
            document.getElementById('sql-output').style.display = 'block';
            document.getElementById('sql-textarea').value = sqlStatements.join('\n');
        }
    </script>
</body>
</html>
