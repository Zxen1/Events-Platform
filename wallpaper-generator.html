<!DOCTYPE html>
<html>
<head>
    <title>Map Wallpaper Generator (Final 5)</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.9.4/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.9.4/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; padding: 20px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #1a1a1a; color: #eee; }
        .container { max-width: 800px; margin: 0 auto; }
        #status-box { background: #222; padding: 15px; border-radius: 8px; border: 1px solid #333; margin-bottom: 20px; }
        #log { height: 350px; overflow-y: auto; background: #000; color: #0f0; padding: 10px; font-family: monospace; font-size: 12px; border-radius: 4px; margin-bottom: 20px; }
        button { background: #0078d4; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600; }
        button:disabled { background: #444; cursor: not-allowed; }
        textarea { width: 100%; height: 200px; background: #222; color: #ccc; border: 1px solid #333; border-radius: 4px; padding: 10px; font-family: monospace; font-size: 12px; }
        .progress-bar { height: 10px; background: #333; border-radius: 5px; margin-top: 10px; overflow: hidden; }
        #progress-fill { height: 100%; background: #0078d4; width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Map Wallpaper Generator (Final 5)</h1>
        <div id="status-box">
            <div>Status: <span id="status-text">Ready</span></div>
            <div class="progress-bar"><div id="progress-fill"></div></div>
            <div style="margin-top: 5px; font-size: 12px; color: #888;" id="progress-text">0 / 5 locations</div>
        </div>

        <button id="btnStart">1. Initialize Map Engine</button>
        <button id="btnCapture" style="display:none;">2. Select Folder & Begin Capture</button>

        <div id="log"></div>

        <h3>SQL Import Data</h3>
        <textarea id="sql-output" readonly placeholder="SQL statements will appear here..."></textarea>
    </div>

    <div id="map" style="width: 700px; height: 2500px; position: absolute; left: -9999px; top: 0;"></div>

    <script>
        const ACCESS_TOKEN = 'pk.eyJ1IjoienhlbiIsImEiOiJjbWViaDRibXEwM2NrMm1wcDhjODg4em5iIn0.2A9teACgwpiCy33uO4WZJQ';
        const ZOOM = 18;
        const PITCH = 75;
        const WIDTH = 700;
        const HEIGHT = 2500;
        const BEARINGS = [0, 90, 180, 270];
        const BEARING_NAMES = { 0: 'N', 90: 'E', 180: 'S', 270: 'W' };
        const MAP_STYLE = 'mapbox://styles/mapbox/standard';
        const LIGHT_PRESET = 'night';

        const locations = [
            { "name": "Larnach Castle", "lat": -45.8615691, "lng": 170.6272516 },
            { "name": "St Paul's Cathedral, Melbourne", "lat": -37.817029, "lng": 144.967687 },
            { "name": "Royal Botanic Gardens Victoria - Melbourne Gardens", "lat": -37.8302443, "lng": 144.9801496 },
            { "name": "Melbourne Zoo", "lat": -37.7841346, "lng": 144.9515473 },
            { "name": "Shrine of Remembrance", "lat": -37.8305164, "lng": 144.9734319 }
        ];

        let map = null;
        let directoryHandle = null;

        function log(msg, isError = false) {
            const div = document.createElement('div');
            div.textContent = `${new Date().toLocaleTimeString()}: ${msg}`;
            if (isError) div.style.color = '#ff5555';
            const logEl = document.getElementById('log');
            logEl.appendChild(div);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function slugify(text) {
            return text.toString().toLowerCase()
                .replace(/\s+/g, '-')
                .replace(/[^\w\-]+/g, '')
                .replace(/\-\-+/g, '-')
                .replace(/^-+/, '')
                .replace(/-+$/, '')
                .substring(0, 50);
        }

        async function initMap() {
            mapboxgl.accessToken = ACCESS_TOKEN;
            return new Promise((resolve, reject) => {
                map = new mapboxgl.Map({
                    container: 'map',
                    style: MAP_STYLE,
                    center: [locations[0].lng, locations[0].lat],
                    zoom: ZOOM,
                    pitch: PITCH,
                    interactive: false,
                    preserveDrawingBuffer: true,
                    attributionControl: false
                });
                map.on('style.load', () => map.setConfigProperty('basemap', 'lightPreset', LIGHT_PRESET));
                map.on('load', () => resolve());
                setTimeout(() => reject(new Error("Map engine failed to load within 15s")), 15000);
            });
        }

        async function captureImage(lat, lng, bearing, filename) {
            return new Promise((resolve) => {
                map.jumpTo({ center: [lng, lat], zoom: ZOOM, pitch: PITCH, bearing: bearing });
                
                const timeout = setTimeout(() => {
                    log(`TIMEOUT: Map didn't become idle for ${filename}`, true);
                    resolve(false);
                }, 20000);

                map.once('idle', () => {
                    clearTimeout(timeout);
                    setTimeout(() => { // Small delay to ensure render is flushed
                        map.getCanvas().toBlob(async (blob) => {
                            if (!blob) {
                                log(`ERROR: Could not generate blob for ${filename}`, true);
                                resolve(false);
                                return;
                            }
                            try {
                                const fileHandle = await directoryHandle.getFileHandle(filename, { create: true });
                                const writable = await fileHandle.createWritable();
                                await writable.write(blob);
                                await writable.close();
                                log(`SAVED: ${filename}`);
                                resolve(true);
                            } catch (e) {
                                log(`FILE ERROR: ${e.message} while saving ${filename}`, true);
                                resolve(false);
                            }
                        }, 'image/webp', 0.85);
                    }, 500);
                });
            });
        }

        document.getElementById('btnStart').addEventListener('click', async () => {
            document.getElementById('btnStart').disabled = true;
            log("Initializing Map Engine...");
            try {
                await initMap();
                log("Map engine ready.");
                document.getElementById('btnCapture').style.display = 'inline-block';
                document.getElementById('btnStart').style.display = 'none';
            } catch (e) {
                log("FATAL ERROR: " + e.message, true);
                document.getElementById('btnStart').disabled = false;
            }
        });

        document.getElementById('btnCapture').addEventListener('click', async () => {
            try {
                directoryHandle = await window.showDirectoryPicker({ mode: 'readwrite' });
                document.getElementById('btnCapture').disabled = true;
                const sqlOutput = document.getElementById('sql-output');
                
                for (let i = 0; i < locations.length; i++) {
                    const loc = locations[i];
                    document.getElementById('progress-fill').style.width = `${((i+1)/5)*100}%`;
                    document.getElementById('progress-text').textContent = `${i+1} / 5 locations (${loc.name})`;
                    log(`--- Starting Location: ${loc.name} ---`);
                    
                    for (const bearing of BEARINGS) {
                        const bName = BEARING_NAMES[bearing];
                        const filename = `${slugify(loc.name)}__${loc.lat}_${loc.lng}__Z${ZOOM}-P${PITCH}-${bName}.webp`;
                        
                        const success = await captureImage(loc.lat, loc.lng, bearing, filename);
                        
                        if (success) {
                            const url = `https://cdn.funmap.com/map-images/${filename}`;
                            const sql = `INSERT IGNORE INTO \`map_images\` (\`latitude\`, \`longitude\`, \`location_type\`, \`bearing\`, \`pitch\`, \`zoom\`, \`file_name\`, \`file_url\`, \`width\`, \`height\`) VALUES (${loc.lat}, ${loc.lng}, 'venue', ${bearing}, ${PITCH}, ${ZOOM}, '${filename}', '${url}', ${WIDTH}, ${HEIGHT});\n`;
                            sqlOutput.value += sql;
                        }
                        // Wait 1 second between captures to avoid file system lock
                        await new Promise(r => setTimeout(r, 1000));
                    }
                }
                log("ALL DONE. Copy the SQL and check your folder.");
                document.getElementById('status-text').textContent = "Finished";
            } catch (e) {
                log("PERMISSION ERROR: " + e.message, true);
                document.getElementById('btnCapture').disabled = false;
            }
        });
    </script>
</body>
</html>
