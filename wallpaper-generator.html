<!DOCTYPE html>
<html>
<head>
    <title>Map Wallpaper Generator</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.9.4/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.9.4/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; padding: 20px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #1a1a1a; color: #eee; }
        .container { max-width: 800px; margin: 0 auto; }
        #status-box { background: #222; padding: 15px; border-radius: 8px; border: 1px solid #333; margin-bottom: 20px; }
        #log { height: 300px; overflow-y: auto; background: #000; color: #0f0; padding: 10px; font-family: monospace; font-size: 12px; border-radius: 4px; margin-bottom: 20px; }
        button { background: #0078d4; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600; }
        button:disabled { background: #444; cursor: not-allowed; }
        textarea { width: 100%; height: 200px; background: #222; color: #ccc; border: 1px solid #333; border-radius: 4px; padding: 10px; font-family: monospace; font-size: 12px; }
        .progress-bar { height: 10px; background: #333; border-radius: 5px; margin-top: 10px; overflow: hidden; }
        #progress-fill { height: 100%; background: #0078d4; width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Map Wallpaper Generator (Final 5)</h1>
        <div id="status-box">
            <div>Status: <span id="status-text">Ready</span></div>
            <div class="progress-bar"><div id="progress-fill"></div></div>
            <div style="margin-top: 5px; font-size: 12px; color: #888;" id="progress-text">0 / 5 locations</div>
        </div>

        <button id="btnStart">Initialize Map Engine</button>
        <button id="btnCapture" style="display:none;">Select Folder & Begin Capture</button>

        <div id="log"></div>

        <h3>SQL Import Data</h3>
        <textarea id="sql-output" readonly placeholder="SQL statements will appear here..."></textarea>
    </div>

    <div id="map" style="width: 700px; height: 2500px; position: absolute; left: -9999px;"></div>

    <script>
        const ACCESS_TOKEN = 'pk.eyJ1IjoienhlbiIsImEiOiJjbWViaDRibXEwM2NrMm1wcDhjODg4em5iIn0.2A9teACgwpiCy33uO4WZJQ';
        const ZOOM = 18;
        const PITCH = 75;
        const WIDTH = 700;
        const HEIGHT = 2500;
        const BEARINGS = [0, 90, 180, 270];
        const BEARING_NAMES = { 0: 'N', 90: 'E', 180: 'S', 270: 'W' };
        const MAP_STYLE = 'mapbox://styles/mapbox/standard';
        const LIGHT_PRESET = 'night';

        // EMBEDDED LOCATIONS TO AVOID FETCH ERRORS
        const locations = [
            { "name": "Larnach Castle", "lat": -45.8615691, "lng": 170.6272516 },
            { "name": "St Paul's Cathedral, Melbourne", "lat": -37.817029, "lng": 144.967687 },
            { "name": "Royal Botanic Gardens Victoria - Melbourne Gardens", "lat": -37.8302443, "lng": 144.9801496 },
            { "name": "Melbourne Zoo", "lat": -37.7841346, "lng": 144.9515473 },
            { "name": "Shrine of Remembrance", "lat": -37.8305164, "lng": 144.9734319 }
        ];

        let map = null;
        let directoryHandle = null;

        function log(msg, isError = false) {
            const div = document.createElement('div');
            div.textContent = `${new Date().toLocaleTimeString()}: ${msg}`;
            if (isError) div.style.color = '#ff5555';
            const logEl = document.getElementById('log');
            logEl.appendChild(div);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function slugify(text) {
            return text.toString().toLowerCase()
                .replace(/\s+/g, '-')
                .replace(/[^\w\-]+/g, '')
                .replace(/\-\-+/g, '-')
                .replace(/^-+/, '')
                .replace(/-+$/, '')
                .substring(0, 50);
        }

        async function initMap() {
            mapboxgl.accessToken = ACCESS_TOKEN;
            return new Promise((resolve, reject) => {
                map = new mapboxgl.Map({
                    container: 'map',
                    style: MAP_STYLE,
                    center: [locations[0].lng, locations[0].lat],
                    zoom: ZOOM,
                    pitch: PITCH,
                    interactive: false,
                    preserveDrawingBuffer: true,
                    attributionControl: false
                });
                map.on('style.load', () => map.setConfigProperty('basemap', 'lightPreset', LIGHT_PRESET));
                map.on('load', () => resolve());
                setTimeout(() => reject(new Error("Map timeout")), 15000);
            });
        }

        async function captureImage(lat, lng, bearing, filename) {
            return new Promise((resolve) => {
                map.jumpTo({ center: [lng, lat], zoom: ZOOM, pitch: PITCH, bearing: bearing });
                const timeout = setTimeout(() => {
                    log(`Timeout at ${lat}, ${lng}. Skipping.`, true);
                    resolve(null);
                }, 15000);
                map.once('idle', () => {
                    clearTimeout(timeout);
                    map.getCanvas().toBlob(async (blob) => {
                        try {
                            const fileHandle = await directoryHandle.getFileHandle(filename, { create: true });
                            const writable = await fileHandle.createWritable();
                            await writable.write(blob);
                            await writable.close();
                            resolve(true);
                        } catch (e) { resolve(null); }
                    }, 'image/webp', 0.85);
                });
            });
        }

        document.getElementById('btnStart').addEventListener('click', async () => {
            document.getElementById('btnStart').disabled = true;
            log("Initializing Map Engine...");
            try {
                await initMap();
                log("Map engine ready.");
                document.getElementById('btnCapture').style.display = 'inline-block';
                document.getElementById('btnStart').style.display = 'none';
            } catch (e) { log("Error: " + e.message, true); }
        });

        document.getElementById('btnCapture').addEventListener('click', async () => {
            directoryHandle = await window.showDirectoryPicker();
            document.getElementById('btnCapture').disabled = true;
            const sqlOutput = document.getElementById('sql-output');
            
            for (let i = 0; i < locations.length; i++) {
                const loc = locations[i];
                document.getElementById('progress-fill').style.width = `${((i+1)/5)*100}%`;
                document.getElementById('progress-text').textContent = `${i+1} / 5 locations (${loc.name})`;
                log(`Processing: ${loc.name}...`);
                
                let sqlBatch = "";
                for (const bearing of BEARINGS) {
                    const filename = `${slugify(loc.name)}__${loc.lat}_${loc.lng}__Z${ZOOM}-P${PITCH}-${BEARING_NAMES[bearing]}.webp`;
                    if (await captureImage(loc.lat, loc.lng, bearing, filename)) {
                        const url = `https://cdn.funmap.com/map-images/${filename}`;
                        sqlBatch += `INSERT IGNORE INTO \`map_images\` (\`latitude\`, \`longitude\`, \`location_type\`, \`bearing\`, \`pitch\`, \`zoom\`, \`file_name\`, \`file_url\`, \`width\`, \`height\`) VALUES (${loc.lat}, ${loc.lng}, 'venue', ${bearing}, ${PITCH}, ${ZOOM}, '${filename}', '${url}', ${WIDTH}, ${HEIGHT});\n`;
                    }
                }
                sqlOutput.value += sqlBatch;
            }
            log("FINISHED. Copy the SQL below.");
        });
    </script>
</body>
</html>
