<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallpaper Image Generator</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.9.2/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.9.2/mapbox-gl.css" rel="stylesheet" />
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px; 
            background: #1a1a1a; 
            color: #fff;
            margin: 0;
        }
        h1 { margin: 0 0 20px 0; }
        .controls { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:disabled {
            background: #444;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
            background: #0055aa;
        }
        #status {
            padding: 15px;
            background: #2a2a2a;
            border-radius: 5px;
            margin-bottom: 20px;
            min-height: 100px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
        }
        #progress {
            margin-bottom: 20px;
        }
        #progress-bar {
            width: 100%;
            height: 30px;
            background: #333;
            border-radius: 5px;
            overflow: hidden;
        }
        #progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #0066cc, #00cc66);
            width: 0%;
            transition: width 0.3s;
        }
        #progress-text {
            text-align: center;
            margin-top: 5px;
            font-size: 14px;
        }
        .stats {
            display: flex;
            gap: 30px;
            margin-bottom: 20px;
        }
        .stat {
            background: #2a2a2a;
            padding: 15px 25px;
            border-radius: 5px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #0099ff;
        }
        .stat-label {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        #sql-output {
            display: none;
            margin-top: 20px;
        }
        #sql-output textarea {
            width: 100%;
            height: 300px;
            background: #1a1a1a;
            color: #0f0;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>Wallpaper Image Generator</h1>
    
    <div class="stats">
        <div class="stat">
            <div class="stat-value" id="total-locations">-</div>
            <div class="stat-label">Unique Locations</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="total-images">-</div>
            <div class="stat-label">Images to Generate</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="completed-images">0</div>
            <div class="stat-label">Completed</div>
        </div>
    </div>
    
    <div class="controls">
        <button id="btn-load">1. Load Locations</button>
        <button id="btn-folder" disabled>2. Select Save Folder</button>
        <button id="btn-test" disabled>3. Test (5 locations)</button>
        <button id="btn-start" disabled>4. Generate All</button>
        <button id="btn-pause" disabled>Pause</button>
        <button id="btn-download-sql" disabled>5. Download SQL</button>
    </div>
    
    <div id="progress">
        <div id="progress-bar"><div id="progress-fill"></div></div>
        <div id="progress-text">Ready</div>
    </div>
    
    <div id="status">Click "Load Locations" to fetch coordinates from post_map_cards...</div>
    
    <div id="sql-output">
        <h3>Generated SQL</h3>
        <textarea id="sql-textarea" readonly></textarea>
    </div>

    <!-- Load the actual SecondaryMap from components-new.js -->
    <script src="components-new.js"></script>
    
    <script>
        // Image dimensions - must match components-new.js
        const IMAGE_WIDTH = 700;
        const IMAGE_HEIGHT = 2500;
        
        // Camera settings by location type - matches getBasicModeCameras() 
        function getCameras(locationType, lat, lng) {
            const t = String(locationType || '').toLowerCase();
            const isCity = (t === 'city');
            const zoom = isCity ? 11 : 18;
            const pitch = 75;
            return [
                { center: [lng, lat], zoom: zoom, pitch: pitch, bearing: 0, direction: 'n' },
                { center: [lng, lat], zoom: zoom, pitch: pitch, bearing: 90, direction: 'e' },
                { center: [lng, lat], zoom: zoom, pitch: pitch, bearing: 180, direction: 's' },
                { center: [lng, lat], zoom: zoom, pitch: pitch, bearing: 270, direction: 'w' }
            ];
        }
        
        // State
        let locations = [];
        let saveFolder = null;
        let isPaused = false;
        let currentIndex = 0;
        let currentCameraIndex = 0;
        let completedCount = 0;
        let sqlStatements = [];
        let testMode = false;
        const testLimit = 5;
        
        // DOM elements
        const statusEl = document.getElementById('status');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const btnLoad = document.getElementById('btn-load');
        const btnFolder = document.getElementById('btn-folder');
        const btnTest = document.getElementById('btn-test');
        const btnStart = document.getElementById('btn-start');
        const btnPause = document.getElementById('btn-pause');
        const btnDownloadSql = document.getElementById('btn-download-sql');
        
        function log(msg) {
            const time = new Date().toLocaleTimeString();
            statusEl.textContent = `[${time}] ${msg}\n` + statusEl.textContent;
            console.log(msg);
        }
        
        function updateProgress() {
            const maxLocs = testMode ? Math.min(testLimit, locations.length) : locations.length;
            const total = maxLocs * 4;
            const pct = total > 0 ? (completedCount / total * 100).toFixed(1) : 0;
            progressFill.style.width = pct + '%';
            progressText.textContent = `${completedCount} / ${total} (${pct}%)`;
            document.getElementById('completed-images').textContent = completedCount;
        }
        
        function generateFilename(lat, lng, direction, pitch, zoom) {
            const latPrefix = lat < 0 ? 'n' : '';
            const lngPrefix = lng < 0 ? 'n' : '';
            const latStr = latPrefix + Math.abs(lat).toFixed(7);
            const lngStr = lngPrefix + Math.abs(lng).toFixed(7);
            return `${latStr}_${lngStr}_${direction}_p${pitch}_z${zoom}`;
        }
        
        function generateSqlInsert(loc, cam, filename, fileSize) {
            const folderUrl = 'https://cdn.funmap.com/map-images';
            const fileUrl = `${folderUrl}/${filename}`;
            return `INSERT INTO map_images (latitude, longitude, location_type, bearing, pitch, zoom, file_name, file_url, file_size, width, height, created_at, updated_at) VALUES (${loc.latitude}, ${loc.longitude}, '${loc.location_type}', ${cam.bearing}, ${cam.pitch}, ${cam.zoom}, '${filename}', '${fileUrl}', ${fileSize}, ${IMAGE_WIDTH}, ${IMAGE_HEIGHT}, NOW(), NOW()) ON DUPLICATE KEY UPDATE file_url = VALUES(file_url), file_size = VALUES(file_size), updated_at = NOW());`;
        }
        
        // Load locations from database
        btnLoad.addEventListener('click', async function() {
            btnLoad.disabled = true;
            log('Fetching locations from post_map_cards...');
            
            try {
                const response = await fetch('/gateway.php?action=get-map-card-locations');
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'Failed to load locations');
                }
                
                locations = data.locations || [];
                
                document.getElementById('total-locations').textContent = locations.length;
                document.getElementById('total-images').textContent = locations.length * 4;
                
                log(`Loaded ${locations.length} unique locations`);
                log(`Will generate ${locations.length * 4} images`);
                
                // Show first 3 locations for verification
                for (let i = 0; i < Math.min(3, locations.length); i++) {
                    const l = locations[i];
                    log(`  Sample ${i+1}: lat=${l.latitude}, lng=${l.longitude}, type=${l.location_type}`);
                }
                
                if (locations.length > 0) {
                    btnFolder.disabled = false;
                    
                    // Set Mapbox token
                    if (!mapboxgl.accessToken) {
                        const token = prompt('Enter Mapbox Access Token:');
                        if (token) {
                            mapboxgl.accessToken = token;
                            log('Mapbox token set');
                        }
                    }
                }
            } catch (err) {
                log('Error: ' + err.message);
                btnLoad.disabled = false;
            }
        });
        
        // Select save folder
        btnFolder.addEventListener('click', async function() {
            try {
                if (!('showDirectoryPicker' in window)) {
                    log('ERROR: Use Chrome or Edge (File System Access API required)');
                    return;
                }
                
                saveFolder = await window.showDirectoryPicker({ mode: 'readwrite' });
                log(`Save folder: ${saveFolder.name}`);
                btnTest.disabled = false;
                btnStart.disabled = false;
                btnFolder.textContent = '✓ Folder Selected';
            } catch (err) {
                if (err.name !== 'AbortError') {
                    log('Error: ' + err.message);
                }
            }
        });
        
        // Test mode
        btnTest.addEventListener('click', function() {
            testMode = true;
            startGeneration();
        });
        
        // Full generation
        btnStart.addEventListener('click', function() {
            testMode = false;
            startGeneration();
        });
        
        function startGeneration() {
            btnTest.disabled = true;
            btnStart.disabled = true;
            btnFolder.disabled = true;
            btnPause.disabled = false;
            isPaused = false;
            sqlStatements = [];
            completedCount = 0;
            currentIndex = 0;
            currentCameraIndex = 0;
            
            const maxLocs = testMode ? Math.min(testLimit, locations.length) : locations.length;
            log(`Starting: ${maxLocs} locations × 4 = ${maxLocs * 4} images`);
            log('Using SecondaryMap.capture() from components-new.js');
            
            processNext();
        }
        
        // Pause/Resume
        btnPause.addEventListener('click', function() {
            isPaused = !isPaused;
            btnPause.textContent = isPaused ? 'Resume' : 'Pause';
            if (!isPaused) {
                log('Resuming...');
                processNext();
            } else {
                log('Paused');
            }
        });
        
        // Process next image
        function processNext() {
            if (isPaused) return;
            
            const maxLocs = testMode ? Math.min(testLimit, locations.length) : locations.length;
            if (currentIndex >= maxLocs) {
                finishGeneration();
                return;
            }
            
            const loc = locations[currentIndex];
            const cameras = getCameras(loc.location_type, loc.latitude, loc.longitude);
            const cam = cameras[currentCameraIndex];
            
            const baseFilename = generateFilename(loc.latitude, loc.longitude, cam.direction, cam.pitch, cam.zoom);
            
            log(`[${currentIndex + 1}/${maxLocs}] ${cam.direction.toUpperCase()} @ ${loc.latitude}, ${loc.longitude}`);
            log(`  Camera: center=[${cam.center[0]}, ${cam.center[1]}] zoom=${cam.zoom} pitch=${cam.pitch} bearing=${cam.bearing}`);
            
            // Verify coordinates are valid
            if (!cam.center || cam.center[0] === 0 || cam.center[1] === 0) {
                log('  ERROR: Invalid coordinates - skipping');
                moveToNext();
                return;
            }
            
            // Use SecondaryMap.capture() - the working code from components-new.js
            SecondaryMap.capture(cam, IMAGE_WIDTH, IMAGE_HEIGHT, async function(dataUrl) {
                if (!dataUrl) {
                    log('  ERROR: Capture failed');
                    moveToNext();
                    return;
                }
                
                try {
                    // Determine format from data URL
                    let ext = 'webp';
                    if (dataUrl.indexOf('data:image/jpeg') === 0) ext = 'jpg';
                    else if (dataUrl.indexOf('data:image/png') === 0) ext = 'png';
                    
                    const filename = baseFilename + '.' + ext;
                    
                    // Convert data URL to blob
                    const response = await fetch(dataUrl);
                    const blob = await response.blob();
                    
                    // Save to folder
                    const fileHandle = await saveFolder.getFileHandle(filename, { create: true });
                    const writable = await fileHandle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                    
                    // Generate SQL
                    const sql = generateSqlInsert(loc, cam, filename, blob.size);
                    sqlStatements.push(sql);
                    
                    completedCount++;
                    updateProgress();
                    log(`  ✓ Saved: ${filename} (${(blob.size/1024).toFixed(0)}KB)`);
                    
                } catch (err) {
                    log(`  ERROR: ${err.message}`);
                }
                
                moveToNext();
            });
        }
        
        function moveToNext() {
            currentCameraIndex++;
            if (currentCameraIndex >= 4) {
                currentCameraIndex = 0;
                currentIndex++;
            }
            // Small delay between captures
            setTimeout(processNext, 100);
        }
        
        function finishGeneration() {
            log('='.repeat(50));
            log(`COMPLETE! Generated ${completedCount} images`);
            if (testMode) {
                log('Check the images, then click "Generate All" for full run');
                btnTest.disabled = false;
                btnStart.disabled = false;
                btnFolder.disabled = false;
            }
            log('='.repeat(50));
            
            btnPause.disabled = true;
            btnDownloadSql.disabled = false;
            
            document.getElementById('sql-output').style.display = 'block';
            document.getElementById('sql-textarea').value = sqlStatements.join('\n');
        }
        
        // Download SQL
        btnDownloadSql.addEventListener('click', function() {
            const sql = sqlStatements.join('\n');
            const blob = new Blob([sql], { type: 'text/sql' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'map_images_insert.sql';
            link.click();
            URL.revokeObjectURL(url);
            log('SQL file downloaded');
        });
    </script>
</body>
</html>
