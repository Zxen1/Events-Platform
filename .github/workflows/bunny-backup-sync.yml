name: Bunny Backup Sync

on:
  schedule:
    - cron: '30 10 * * *'  # 21:30 AEDT (10:30 UTC) - temporary test, change to 4am later
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no actual changes)'
        required: false
        default: 'false'
        type: boolean

jobs:
  sync-bunny-storage:
    runs-on: ubuntu-latest

    steps:
      - name: Install rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash

      - name: Configure rclone remotes
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf << EOF
          [funmap-main]
          type = ftp
          host = storage.bunnycdn.com
          user = funmap
          pass = $(rclone obscure "${{ secrets.BUNNY_FTP_PASSWORD_MAIN }}")
          
          [funmap-backup]
          type = ftp
          host = syd.storage.bunnycdn.com
          user = funmap-backup
          pass = $(rclone obscure "${{ secrets.BUNNY_FTP_PASSWORD_BACKUP }}")
          EOF

      - name: Create logs directory on backup
        run: |
          rclone mkdir funmap-backup:logs

      - name: Sync Bunny Main to Bunny Backup
        run: |
          export TZ="Australia/Sydney"
          LOG_FILE="sync-$(date +%Y-%m-%d-%H%M%S).log"
          
          echo "Starting Bunny sync at $(date)" | tee "$LOG_FILE"
          echo "======================================" | tee -a "$LOG_FILE"
          
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "DRY RUN MODE - No changes will be made" | tee -a "$LOG_FILE"
            rclone copy funmap-main: funmap-backup: \
              --transfers 8 \
              --verbose \
              --ignore-errors \
              --dry-run \
              2>&1 | tee -a "$LOG_FILE" || true
          else
            rclone copy funmap-main: funmap-backup: \
              --transfers 8 \
              --verbose \
              --ignore-errors \
              2>&1 | tee -a "$LOG_FILE" || true
          fi
          
          echo "======================================" | tee -a "$LOG_FILE"
          echo "Sync completed at $(date)" | tee -a "$LOG_FILE"
          
          # Upload log to backup storage (--inplace avoids rename issues on Bunny FTP)
          rclone copy "$LOG_FILE" funmap-backup:logs/ --inplace

      - name: Summary
        run: |
          echo "âœ… Bunny backup sync complete"
          echo "ðŸ“‹ Log uploaded to funmap-backup:logs/"
