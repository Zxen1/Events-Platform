<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formbuilder Test</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #1a1a1a; color: #fff; font-size: 13px; overflow-x: hidden; }
        
        .formbuilder-accordion {
            width: 400px;
            margin-bottom: 3px;
            background: #222222;
            border-radius: 5px;
            overflow: visible;
        }
        
        .formbuilder-accordion-header {
            height: 40px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            cursor: pointer;
            background: #2e3a72;
            border-radius: 5px 5px 0 0;
        }
        .formbuilder-accordion:not(.formbuilder-accordion--open) .formbuilder-accordion-header {
            border-radius: 5px;
        }
        .formbuilder-accordion-header-image {
            width: 24px;
            height: 24px;
            object-fit: contain;
            border-radius: 4px;
        }
        .formbuilder-accordion-header-text {
            flex: 1;
            padding-left: 10px;
            font-weight: bold;
        }
        .formbuilder-accordion-header-arrow {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: transform 0.2s;
        }
        .formbuilder-accordion--open > .formbuilder-accordion-header .formbuilder-accordion-header-arrow {
            transform: rotate(180deg);
        }
        .formbuilder-accordion-header-editarea {
            height: 40px;
            display: flex;
            align-items: center;
            padding-left: 10px;
            padding-right: 10px;
            margin-right: -10px;
            cursor: pointer;
        }
        .formbuilder-accordion-header-edit {
            width: 20px;
            height: 20px;
            color: #888;
        }
        .formbuilder-accordion-header-editarea:hover .formbuilder-accordion-header-edit {
            color: #fff;
        }
        
        .formbuilder-accordion-editpanel {
            display: none;
            padding: 10px;
            background: #1a1a1a;
        }
        .formbuilder-accordion--editing > .formbuilder-accordion-editpanel {
            display: block;
        }
        .formbuilder-accordion-editpanel-input {
            width: 100%;
            height: 36px;
            padding: 0 10px;
            margin-bottom: 10px;
            background: #333;
            border: none;
            border-radius: 5px;
            color: #fff;
            font-size: 13px;
            box-sizing: border-box;
        }
        
        .formbuilder-accordion-body {
            display: none;
            padding: 3px 0 0 0;
        }
        .formbuilder-accordion--open > .formbuilder-accordion-body {
            display: block;
        }
        
        /* Subcategory */
        .formbuilder-accordion-option {
            margin-bottom: 3px;
            border-radius: 4px;
            overflow: visible;
        }
        .formbuilder-accordion-option-header {
            height: 36px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .formbuilder-accordion-option-image {
            width: 20px;
            height: 20px;
            object-fit: contain;
            border-radius: 3px;
        }
        .formbuilder-accordion-option-text {
            flex: 1;
            padding-left: 10px;
        }
        .formbuilder-accordion-option-arrow {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: transform 0.2s;
        }
        .formbuilder-accordion-option--open > .formbuilder-accordion-option-header .formbuilder-accordion-option-arrow {
            transform: rotate(180deg);
        }
        .formbuilder-accordion-option-editarea {
            height: 36px;
            display: flex;
            align-items: center;
            padding-left: 10px;
            padding-right: 10px;
            margin-right: -10px;
            cursor: pointer;
        }
        .formbuilder-accordion-option-edit {
            width: 16px;
            height: 16px;
            color: #888;
        }
        .formbuilder-accordion-option-editarea:hover .formbuilder-accordion-option-edit {
            color: #fff;
        }
        
        .formbuilder-accordion-option-editpanel {
            display: none;
            padding: 10px;
            background: #1a1a1a;
            margin-top: 2px;
            border-radius: 4px;
        }
        .formbuilder-accordion-option--editing > .formbuilder-accordion-option-editpanel {
            display: block;
        }
        
        /* Icon picker dropdown - from iconpicker-test.html */
        .menu { width: 100%; height: 36px; position: relative; }
        .menu-button { width: 100%; height: 36px; display: flex; align-items: center; padding: 0 10px; box-sizing: border-box; background: #333; border-radius: 5px; cursor: pointer; }
        .menu-button-image { width: 30px; height: 30px; object-fit: contain; flex-shrink: 0; }
        .menu-button-text { flex: 1; text-align: left; padding-left: 10px; font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .menu-button-arrow { width: 16px; height: 36px; margin-left: 10px; transition: transform 0.2s; display: flex; align-items: center; justify-content: center; font-size: 10px; line-height: 1; flex-shrink: 0; }
        .menu.open .menu-button-arrow { transform: rotate(180deg); }
        .menu-options { display: none; position: absolute; top: 36px; left: 0; width: 100%; background: #333; border-radius: 5px; max-height: 200px; overflow-y: auto; overflow-x: hidden; z-index: 100; }
        .menu.open .menu-options { display: block; }
        .menu-option { width: 100%; height: 36px; display: flex; align-items: center; padding: 0 10px; box-sizing: border-box; cursor: pointer; }
        .menu-option:hover { background: #444; }
        .menu-option-image { width: 30px; height: 30px; object-fit: contain; flex-shrink: 0; }
        .menu-option-text { flex: 1; text-align: left; padding-left: 10px; font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    </style>
</head>
<body>

<div id="formbuilder"></div>

<script>
(function(){
    var container = document.getElementById('formbuilder');
    var allIcons = [];
    
    var slidersSvg = '<svg viewBox="0 0 16 16" fill="currentColor"><path d="M11.5 2a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM9.05 3a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0V3h9.05zM4.5 7a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM2.05 8a2.5 2.5 0 0 1 4.9 0H16v1H6.95a2.5 2.5 0 0 1-4.9 0H0V8h2.05zm9.45 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zm-2.45 1a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0v-1h9.05z"/></svg>';
    
    function closeAllEditPanels() {
        container.querySelectorAll('.formbuilder-accordion--editing').forEach(function(el) {
            el.classList.remove('formbuilder-accordion--editing');
        });
        container.querySelectorAll('.formbuilder-accordion-option--editing').forEach(function(el) {
            el.classList.remove('formbuilder-accordion-option--editing');
        });
        container.querySelectorAll('.menu.open').forEach(function(el) {
            el.classList.remove('open');
        });
    }
    
    function extractDominantColor(img, callback) {
        try {
            var canvas = document.createElement('canvas');
            var ctx = canvas.getContext('2d');
            canvas.width = img.naturalWidth || 30;
            canvas.height = img.naturalHeight || 30;
            ctx.drawImage(img, 0, 0);
            var data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
            var r = 0, g = 0, b = 0, count = 0;
            for (var i = 0; i < data.length; i += 4) {
                if (data[i + 3] > 128) {
                    r += data[i];
                    g += data[i + 1];
                    b += data[i + 2];
                    count++;
                }
            }
            if (count > 0) {
                callback(Math.round(r / count), Math.round(g / count), Math.round(b / count));
            }
        } catch(e) {}
    }
    
    function buildIconPicker(currentSrc, onSelect) {
        var menu = document.createElement('div');
        menu.className = 'menu';
        var currentFilename = currentSrc ? currentSrc.split('/').pop() : 'Select...';
        menu.innerHTML = '<div class="menu-button"><img class="menu-button-image" src="' + currentSrc + '" alt=""><span class="menu-button-text">' + currentFilename + '</span><span class="menu-button-arrow">▼</span></div><div class="menu-options"></div>';
        var btn = menu.querySelector('.menu-button');
        var opts = menu.querySelector('.menu-options');
        var btnImg = menu.querySelector('.menu-button-image');
        var btnText = menu.querySelector('.menu-button-text');
        
        allIcons.forEach(function(iconPath) {
            var filename = iconPath.split('/').pop();
            var op = document.createElement('div');
            op.className = 'menu-option';
            op.innerHTML = '<img class="menu-option-image" src="' + iconPath + '" alt=""><span class="menu-option-text">' + filename + '</span>';
            op.onclick = function(e) {
                e.stopPropagation();
                btnImg.src = iconPath;
                btnText.textContent = filename;
                menu.classList.remove('open');
                onSelect(iconPath);
            };
            opts.appendChild(op);
        });
        
        btn.onclick = function(e) {
            e.stopPropagation();
            // Close other menus
            container.querySelectorAll('.menu.open').forEach(function(el) {
                if (el !== menu) el.classList.remove('open');
            });
            menu.classList.toggle('open');
        };
        
        return menu;
    }
    
    // Close edit panels when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.formbuilder-accordion-editpanel') && 
            !e.target.closest('.formbuilder-accordion-option-editpanel') &&
            !e.target.closest('.formbuilder-accordion-header-editarea') &&
            !e.target.closest('.formbuilder-accordion-option-editarea')) {
            closeAllEditPanels();
        }
    });
    
    // Fetch icons then categories
    fetch('/gateway.php?action=list-icons&folder=assets/icons-30/')
        .then(function(r) { return r.json(); })
        .then(function(res) {
            allIcons = (res.icons || []).map(function(name) { return 'assets/icons-30/' + name; });
            return fetch('/gateway.php?action=get-form');
        })
        .then(function(r) { return r.json(); })
        .then(function(res) {
            if (!res.success || !res.snapshot) return;
            
            var categories = res.snapshot.categories || [];
            var categoryIconPaths = res.snapshot.categoryIconPaths || {};
            var subcategoryIconPaths = res.snapshot.subcategoryIconPaths || {};
            
            categories.forEach(function(cat) {
                var accordion = document.createElement('div');
                accordion.className = 'formbuilder-accordion';
                
                var catIconSrc = categoryIconPaths[cat.name] || '';
                
                // Header
                var header = document.createElement('div');
                header.className = 'formbuilder-accordion-header';
                
                var headerImg = document.createElement('img');
                headerImg.className = 'formbuilder-accordion-header-image';
                headerImg.src = catIconSrc;
                
                var headerText = document.createElement('span');
                headerText.className = 'formbuilder-accordion-header-text';
                headerText.textContent = cat.name;
                
                var headerArrow = document.createElement('span');
                headerArrow.className = 'formbuilder-accordion-header-arrow';
                headerArrow.textContent = '▼';
                
                var headerEditArea = document.createElement('div');
                headerEditArea.className = 'formbuilder-accordion-header-editarea';
                var headerEdit = document.createElement('div');
                headerEdit.className = 'formbuilder-accordion-header-edit';
                headerEdit.innerHTML = slidersSvg;
                headerEditArea.appendChild(headerEdit);
                
                header.appendChild(headerImg);
                header.appendChild(headerText);
                header.appendChild(headerArrow);
                header.appendChild(headerEditArea);
                
                // Edit panel
                var editPanel = document.createElement('div');
                editPanel.className = 'formbuilder-accordion-editpanel';
                
                var nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.className = 'formbuilder-accordion-editpanel-input';
                nameInput.value = cat.name;
                nameInput.oninput = function() {
                    headerText.textContent = nameInput.value || cat.name;
                };
                
                var iconPicker = buildIconPicker(catIconSrc, function(newIcon) {
                    headerImg.src = newIcon;
                });
                
                editPanel.appendChild(nameInput);
                editPanel.appendChild(iconPicker);
                
                // Body
                var body = document.createElement('div');
                body.className = 'formbuilder-accordion-body';
                
                var subs = cat.subs || [];
                subs.forEach(function(subName) {
                    var option = document.createElement('div');
                    option.className = 'formbuilder-accordion-option';
                    
                    var subIconSrc = subcategoryIconPaths[subName] || '';
                    
                    var optHeader = document.createElement('div');
                    optHeader.className = 'formbuilder-accordion-option-header';
                    
                    var optImg = document.createElement('img');
                    optImg.className = 'formbuilder-accordion-option-image';
                    optImg.crossOrigin = 'anonymous';
                    optImg.src = subIconSrc;
                    
                    // Extract dominant color
                    optImg.onload = function() {
                        extractDominantColor(optImg, function(r, g, b) {
                            optHeader.style.background = 'rgba(' + r + ',' + g + ',' + b + ',0.2)';
                        });
                    };
                    
                    var optText = document.createElement('span');
                    optText.className = 'formbuilder-accordion-option-text';
                    optText.textContent = subName;
                    
                    var optArrow = document.createElement('span');
                    optArrow.className = 'formbuilder-accordion-option-arrow';
                    optArrow.textContent = '▼';
                    
                    var optEditArea = document.createElement('div');
                    optEditArea.className = 'formbuilder-accordion-option-editarea';
                    var optEdit = document.createElement('div');
                    optEdit.className = 'formbuilder-accordion-option-edit';
                    optEdit.innerHTML = slidersSvg;
                    optEditArea.appendChild(optEdit);
                    
                    optHeader.appendChild(optImg);
                    optHeader.appendChild(optText);
                    optHeader.appendChild(optArrow);
                    optHeader.appendChild(optEditArea);
                    
                    // Sub edit panel
                    var subEditPanel = document.createElement('div');
                    subEditPanel.className = 'formbuilder-accordion-option-editpanel';
                    
                    var subNameInput = document.createElement('input');
                    subNameInput.type = 'text';
                    subNameInput.className = 'formbuilder-accordion-editpanel-input';
                    subNameInput.value = subName;
                    subNameInput.oninput = function() {
                        optText.textContent = subNameInput.value || subName;
                    };
                    
                    var subIconPicker = buildIconPicker(subIconSrc, function(newIcon) {
                        optImg.src = newIcon;
                        // Update background color
                        var tempImg = new Image();
                        tempImg.crossOrigin = 'anonymous';
                        tempImg.onload = function() {
                            extractDominantColor(tempImg, function(r, g, b) {
                                optHeader.style.background = 'rgba(' + r + ',' + g + ',' + b + ',0.2)';
                            });
                        };
                        tempImg.src = newIcon;
                    });
                    
                    subEditPanel.appendChild(subNameInput);
                    subEditPanel.appendChild(subIconPicker);
                    
                    option.appendChild(optHeader);
                    option.appendChild(subEditPanel);
                    
                    // Sub edit area click
                    optEditArea.addEventListener('click', function(e) {
                        e.stopPropagation();
                        var isOpen = option.classList.contains('formbuilder-accordion-option--editing');
                        closeAllEditPanels();
                        if (!isOpen) {
                            option.classList.add('formbuilder-accordion-option--editing');
                        }
                    });
                    
                    // Sub header click (except edit area) - placeholder for now
                    optHeader.addEventListener('click', function(e) {
                        if (e.target.closest('.formbuilder-accordion-option-editarea')) return;
                        option.classList.toggle('formbuilder-accordion-option--open');
                    });
                    
                    body.appendChild(option);
                });
                
                accordion.appendChild(header);
                accordion.appendChild(editPanel);
                accordion.appendChild(body);
                
                // Header edit area click
                headerEditArea.addEventListener('click', function(e) {
                    e.stopPropagation();
                    var isOpen = accordion.classList.contains('formbuilder-accordion--editing');
                    closeAllEditPanels();
                    if (!isOpen) {
                        accordion.classList.add('formbuilder-accordion--editing');
                    }
                });
                
                // Header click (except edit area) expands/collapses
                header.addEventListener('click', function(e) {
                    if (e.target.closest('.formbuilder-accordion-header-editarea')) return;
                    accordion.classList.toggle('formbuilder-accordion--open');
                });
                
                container.appendChild(accordion);
            });
        });
})();
</script>

</body>
</html>
