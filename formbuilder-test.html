<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formbuilder Test</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #1a1a1a; color: #fff; font-size: 13px; overflow-x: hidden; }
        
        .formbuilder-accordion {
            width: 400px;
            margin-bottom: 3px;
            background: #080808;
            border-radius: 5px;
            overflow: visible;
        }
        
        .formbuilder-accordion-header {
            height: 40px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            cursor: pointer;
            background: #0c4070;
            border-radius: 5px 5px 0 0;
            border: 1px solid transparent;
        }
        .formbuilder-accordion:not(.formbuilder-accordion--open) .formbuilder-accordion-header {
            border-radius: 5px;
        }
        .formbuilder-accordion-header:hover {
            border-color: #3b82f5;
        }
        .formbuilder-accordion--editing .formbuilder-accordion-header {
            border-color: #3b82f5;
            border-radius: 5px 5px 0 0;
            border-bottom: none;
        }
        .formbuilder-accordion-header-image {
            width: 24px;
            height: 24px;
            object-fit: contain;
            border-radius: 4px;
        }
        .formbuilder-accordion-header-text {
            flex: 1;
            padding-left: 10px;
            font-weight: bold;
        }
        .formbuilder-accordion-editpanel-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .formbuilder-accordion-editpanel-input {
            flex: 1;
            height: 36px;
            padding: 0 10px;
            background: #062038;
            border: 1px solid #222222;
            border-radius: 5px;
            color: #fff;
            font-size: 13px;
            box-sizing: border-box;
        }
        .formbuilder-accordion-editpanel-input:hover,
        .formbuilder-accordion-editpanel-input:focus {
            outline: none;
            border-color: #3b82f5;
        }
        .formbuilder-accordion-editpanel-more {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #062038;
            border: 1px solid #222222;
            border-radius: 5px;
            cursor: pointer;
            color: #fff;
            position: relative;
        }
        .formbuilder-accordion-editpanel-more:hover {
            border-color: #3b82f5;
            color: #3b82f5;
        }
        .formbuilder-accordion-editpanel-more svg {
            width: 16px;
            height: 16px;
        }
        .formbuilder-accordion-editpanel-more-menu {
            position: absolute;
            top: 100%;
            right: 0;
            width: 180px;
            background: #111;
            border: 1px solid #3b82f5;
            border-radius: 5px;
            padding: 5px 0;
            z-index: 200;
            display: none;
        }
        .formbuilder-accordion-editpanel-more.open .formbuilder-accordion-editpanel-more-menu {
            display: block;
        }
        .formbuilder-accordion-editpanel-more-item {
            height: 36px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            cursor: pointer;
            color: #fff;
            font-size: 13px;
        }
        .formbuilder-accordion-editpanel-more-item:hover {
            background: #222;
        }
        .formbuilder-accordion-editpanel-more-item-text {
            flex: 1;
        }
        .formbuilder-accordion-editpanel-more-switch {
            width: 36px;
            height: 20px;
            background: #444;
            border-radius: 10px;
            position: relative;
            cursor: pointer;
        }
        .formbuilder-accordion-editpanel-more-switch::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.2s;
        }
        .formbuilder-accordion-editpanel-more-switch.on {
            background: #3b82f5;
        }
        .formbuilder-accordion-editpanel-more-switch.on::after {
            left: 18px;
        }
        .formbuilder-accordion-editpanel-more-delete {
            color: #f87171;
        }
        .formbuilder-accordion-editpanel-more-delete:hover {
            background: #7f1d1d;
        }
        .formbuilder-accordion-header-arrow {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: transform 0.2s;
        }
        .formbuilder-accordion--open > .formbuilder-accordion-header .formbuilder-accordion-header-arrow {
            transform: rotate(180deg);
        }
        .formbuilder-accordion-header-drag {
            width: 36px;
            height: 36px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: grab;
            color: #888;
        }
        .formbuilder-accordion-header-drag:hover {
            color: #fff;
        }
        .formbuilder-accordion-header-drag svg {
            width: 20px;
            height: 20px;
        }
        .formbuilder-accordion.dragging {
            opacity: 0.5;
        }
        .formbuilder-accordion-header-editarea {
            height: 40px;
            display: flex;
            align-items: center;
            padding-left: 10px;
            padding-right: 10px;
            margin-right: -10px;
            cursor: pointer;
        }
        .formbuilder-accordion-header-edit {
            width: 20px;
            height: 20px;
            color: #fff;
        }
        .formbuilder-accordion-header-editarea:hover .formbuilder-accordion-header-edit,
        .formbuilder-accordion--editing .formbuilder-accordion-header-edit {
            color: #3b82f5;
        }
        
        .formbuilder-accordion-editpanel {
            display: none;
            padding: 10px;
            background: #0c4070;
            border: 1px solid #3b82f5;
            border-top: none;
            border-radius: 0 0 5px 5px;
        }
        .formbuilder-accordion--editing > .formbuilder-accordion-editpanel {
            display: block;
        }
        
        .formbuilder-accordion-body {
            display: none;
            padding: 3px 0 0 0;
        }
        .formbuilder-accordion--open > .formbuilder-accordion-body {
            display: block;
        }
        
        /* Subcategory */
        .formbuilder-accordion-option {
            margin-bottom: 3px;
            border-radius: 4px;
            overflow: visible;
        }
        .formbuilder-accordion-option-header {
            height: 36px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid transparent;
            background: #000;
        }
        .formbuilder-accordion-option-header:hover {
            border-color: #3b82f5;
        }
        .formbuilder-accordion-option--editing .formbuilder-accordion-option-header {
            border-color: #3b82f5;
            border-radius: 4px 4px 0 0;
            border-bottom: none;
        }
        .formbuilder-accordion-option-image {
            width: 20px;
            height: 20px;
            object-fit: contain;
            border-radius: 3px;
        }
        .formbuilder-accordion-option-text {
            flex: 1;
            padding-left: 10px;
        }
        .formbuilder-accordion-option-arrow {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: transform 0.2s;
        }
        .formbuilder-accordion-option--open > .formbuilder-accordion-option-header .formbuilder-accordion-option-arrow {
            transform: rotate(180deg);
        }
        .formbuilder-accordion-option--open > .formbuilder-accordion-option-header {
            border-color: #3b82f5;
            border-radius: 4px 4px 0 0;
            border-bottom: none;
        }
        .formbuilder-accordion-option-drag {
            width: 36px;
            height: 36px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: grab;
            color: #888;
        }
        .formbuilder-accordion-option-drag:hover {
            color: #fff;
        }
        .formbuilder-accordion-option-drag svg {
            width: 20px;
            height: 20px;
        }
        .formbuilder-accordion-option.dragging {
            opacity: 0.5;
        }
        .formbuilder-accordion-option-editarea {
            height: 36px;
            display: flex;
            align-items: center;
            padding-left: 10px;
            padding-right: 10px;
            margin-right: -10px;
            cursor: pointer;
        }
        .formbuilder-accordion-option-edit {
            width: 16px;
            height: 16px;
            color: #fff;
        }
        .formbuilder-accordion-option-editarea:hover .formbuilder-accordion-option-edit,
        .formbuilder-accordion-option--editing .formbuilder-accordion-option-edit {
            color: #3b82f5;
        }
        
        .formbuilder-accordion-option-editpanel {
            display: none;
            padding: 10px;
            margin-top: 0;
            border: 1px solid #3b82f5;
            border-top: none;
            border-radius: 0 0 4px 4px;
            background: #000;
        }
        .formbuilder-accordion-option--editing > .formbuilder-accordion-option-editpanel {
            display: block;
        }
        
        .formbuilder-accordion-option-body {
            display: none;
            padding: 10px;
            border: 1px solid #3b82f5;
            border-top: none;
            border-radius: 0 0 4px 4px;
            background: #000;
        }
        .formbuilder-accordion-option--open > .formbuilder-accordion-option-body {
            display: block;
        }
        
        /* When both editing and open - one continuous border */
        .formbuilder-accordion-option--editing.formbuilder-accordion-option--open > .formbuilder-accordion-option-editpanel {
            border-radius: 0;
            border-bottom: none;
        }
        .formbuilder-accordion-option--editing.formbuilder-accordion-option--open > .formbuilder-accordion-option-body {
            border-top: none;
        }
        
        /* Subcategory edit panel overrides */
        .formbuilder-accordion-option-editpanel .formbuilder-accordion-editpanel-input {
            background: #111111;
        }
        .formbuilder-accordion-option-editpanel .formbuilder-accordion-editpanel-more {
            background: #111111;
        }
        .formbuilder-accordion-option-editpanel .menu-button {
            background: #111111;
        }
        .formbuilder-accordion-option-editpanel .menu-options {
            background: #111111;
        }
        
        /* Icon picker dropdown - from iconpicker-test.html */
        .menu { width: 100%; height: 36px; position: relative; }
        .menu-button { width: 100%; height: 36px; display: flex; align-items: center; padding: 0 10px; box-sizing: border-box; background: #062038; border: 1px solid #222222; border-radius: 5px; cursor: pointer; }
        .menu-button:hover { border-color: #3b82f5; }
        .menu.open .menu-button { border-color: #3b82f5; border-radius: 5px 5px 0 0; border-bottom: none; }
        .menu-button-image { width: 20px; height: 20px; object-fit: contain; flex-shrink: 0; }
        .menu-button-text { flex: 1; text-align: left; padding-left: 10px; font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .menu-button-arrow { width: 20px; height: 20px; margin-left: 10px; transition: transform 0.2s; display: flex; align-items: center; justify-content: center; font-size: 10px; }
        .menu.open .menu-button-arrow { transform: rotate(180deg); }
        .menu-options { display: none; position: absolute; top: 35px; left: 0; width: 100%; box-sizing: border-box; background: #062038; border: 1px solid #3b82f5; border-top: none; border-radius: 0 0 5px 5px; max-height: 200px; overflow-y: auto; overflow-x: hidden; z-index: 100; scrollbar-width: thin; scrollbar-color: #888 transparent; }
        .menu-options::-webkit-scrollbar { width: 8px; background: transparent; }
        .menu-options::-webkit-scrollbar-track { background: transparent; }
        .menu-options::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .menu.open .menu-options { display: block; }
        .menu-option { width: 100%; height: 36px; display: flex; align-items: center; padding: 0 10px; box-sizing: border-box; cursor: pointer; color: #fff; font-size: 13px; }
        .menu-option:hover { background: #0c4070; }
        .menu-option-image { width: 20px; height: 20px; object-fit: contain; flex-shrink: 0; }
        .menu-option-text { flex: 1; text-align: left; padding-left: 10px; font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        /* Add buttons */
        .formbuilder-add-button {
            width: 100%;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #222;
            border: 1px solid #222222;
            border-radius: 4px;
            color: #888;
            font-size: 13px;
            cursor: pointer;
            margin-top: 3px;
            box-sizing: border-box;
        }
        .formbuilder-add-button:hover {
            border-color: #3b82f5;
            color: #fff;
        }
        .formbuilder-add-category {
            width: 400px;
            margin-top: 3px;
        }
        
        /* Fieldset menu */
        .formbuilder-fieldset-menu {
            width: 100%;
            position: relative;
            box-sizing: border-box;
        }
        .formbuilder-fieldset-menu-button {
            width: 100%;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #222;
            border: 1px solid #222222;
            border-radius: 4px;
            color: #888;
            font-size: 13px;
            cursor: pointer;
            box-sizing: border-box;
        }
        .formbuilder-fieldset-menu-button:hover {
            border-color: #3b82f5;
            color: #fff;
        }
        .formbuilder-fieldset-menu.open .formbuilder-fieldset-menu-button {
            border-color: #3b82f5;
            border-radius: 4px 4px 0 0;
            border-bottom: none;
            color: #fff;
        }
        .formbuilder-fieldset-menu-options {
            display: none;
            position: absolute;
            top: 35px;
            left: 0;
            width: 100%;
            background: #111;
            border: 1px solid #3b82f5;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            scrollbar-width: thin;
            scrollbar-color: #888 transparent;
            box-sizing: border-box;
        }
        .formbuilder-fieldset-menu-options::-webkit-scrollbar {
            width: 8px;
            background: transparent;
        }
        .formbuilder-fieldset-menu-options::-webkit-scrollbar-track {
            background: transparent;
        }
        .formbuilder-fieldset-menu-options::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .formbuilder-fieldset-menu.open .formbuilder-fieldset-menu-options {
            display: block;
        }
        .formbuilder-fieldset-menu-option {
            width: 100%;
            height: 36px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            box-sizing: border-box;
            cursor: pointer;
            color: #fff;
            font-size: 13px;
        }
        .formbuilder-fieldset-menu-option:hover {
            background: #3b82f5;
        }
        .formbuilder-fieldset-menu-option.disabled {
            color: #555;
            cursor: not-allowed;
        }
        .formbuilder-fieldset-menu-option.disabled:hover {
            background: transparent;
        }
        
        /* Fields container */
        .formbuilder-fields-container {
            width: 100%;
        }
        
        /* Field buttons */
        .formbuilder-field {
            width: 100%;
            height: 36px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            margin-bottom: 3px;
            background: #222;
            border: 1px solid #222222;
            border-radius: 4px;
            color: #fff;
            font-size: 13px;
            box-sizing: border-box;
        }
        .formbuilder-field:hover {
            border-color: #3b82f5;
        }
        .formbuilder-field-text {
            flex: 1;
        }
        .formbuilder-field-drag {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            color: #888;
        }
        .formbuilder-field-drag:hover {
            color: #fff;
        }
        .formbuilder-field-drag svg {
            width: 16px;
            height: 16px;
        }
        .formbuilder-field-edit {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #fff;
        }
        .formbuilder-field-edit:hover {
            color: #3b82f5;
        }
        .formbuilder-field-edit svg {
            width: 16px;
            height: 16px;
        }
        .formbuilder-field.dragging {
            opacity: 0.5;
        }
        .formbuilder-field-wrapper.dragging {
            opacity: 0.5;
        }
        .formbuilder-field-wrapper {
            margin-bottom: 3px;
        }
        .formbuilder-field-wrapper--editing > .formbuilder-field {
            border-color: #3b82f5;
            border-radius: 4px 4px 0 0;
            border-bottom: none;
        }
        .formbuilder-field-wrapper--editing .formbuilder-field-edit {
            color: #3b82f5;
        }
        .formbuilder-field-editpanel {
            display: none;
            padding: 10px;
            background: #111;
            border: 1px solid #3b82f5;
            border-top: none;
            border-radius: 0 0 4px 4px;
        }
        .formbuilder-field-wrapper--editing > .formbuilder-field-editpanel {
            display: block;
        }
        .formbuilder-field-editpanel-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .formbuilder-field-required-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #fff;
            font-size: 13px;
            cursor: pointer;
            flex: 1;
        }
        .formbuilder-field-required-checkbox {
            width: 18px;
            height: 18px;
            accent-color: #3b82f5;
            cursor: pointer;
        }
        .formbuilder-field-delete {
            height: 36px;
            padding: 0 15px;
            background: #7f1d1d;
            border: 1px solid #7f1d1d;
            border-radius: 4px;
            color: #fff;
            font-size: 13px;
            cursor: pointer;
        }
        .formbuilder-field-delete:hover {
            background: #991b1b;
            border-color: #991b1b;
        }
    </style>
</head>
<body>

<div id="formbuilder"></div>

<script>
(function(){
    var container = document.getElementById('formbuilder');
    var allIcons = [];
    
    var editPenSvg = '<svg viewBox="0 0 16 16" fill="currentColor"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5L13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175l-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/></svg>';
    var moreDotsVvg = '<svg viewBox="0 0 16 16" fill="currentColor"><circle cx="8" cy="2.5" r="1.5"/><circle cx="8" cy="8" r="1.5"/><circle cx="8" cy="13.5" r="1.5"/></svg>';
    var dragHandleSvg = '<svg viewBox="0 0 16 16" fill="currentColor"><path d="M8 2L4 6h8L8 2zM8 14l4-4H4l4 4z"/></svg>';
    
    function closeAllEditPanels() {
        container.querySelectorAll('.formbuilder-accordion--editing').forEach(function(el) {
            el.classList.remove('formbuilder-accordion--editing');
        });
        container.querySelectorAll('.formbuilder-accordion-option--editing').forEach(function(el) {
            el.classList.remove('formbuilder-accordion-option--editing');
        });
        container.querySelectorAll('.menu.open').forEach(function(el) {
            el.classList.remove('open');
        });
    }
    
    function extractDominantColor(img, callback) {
        try {
            var canvas = document.createElement('canvas');
            var ctx = canvas.getContext('2d');
            canvas.width = img.naturalWidth || 30;
            canvas.height = img.naturalHeight || 30;
            ctx.drawImage(img, 0, 0);
            var data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
            var r = 0, g = 0, b = 0, count = 0;
            for (var i = 0; i < data.length; i += 4) {
                if (data[i + 3] > 128) {
                    r += data[i];
                    g += data[i + 1];
                    b += data[i + 2];
                    count++;
                }
            }
            if (count > 0) {
                callback(Math.round(r / count), Math.round(g / count), Math.round(b / count));
            }
        } catch(e) {}
    }
    
    function buildIconPicker(currentSrc, onSelect) {
        var menu = document.createElement('div');
        menu.className = 'menu';
        var currentFilename = currentSrc ? currentSrc.split('/').pop() : 'Select...';
        menu.innerHTML = '<div class="menu-button"><img class="menu-button-image" src="' + currentSrc + '" alt=""><span class="menu-button-text">' + currentFilename + '</span><span class="menu-button-arrow">▼</span></div><div class="menu-options"></div>';
        var btn = menu.querySelector('.menu-button');
        var opts = menu.querySelector('.menu-options');
        var btnImg = menu.querySelector('.menu-button-image');
        var btnText = menu.querySelector('.menu-button-text');
        
        allIcons.forEach(function(iconPath) {
            var filename = iconPath.split('/').pop();
            var op = document.createElement('div');
            op.className = 'menu-option';
            op.innerHTML = '<img class="menu-option-image" src="' + iconPath + '" alt=""><span class="menu-option-text">' + filename + '</span>';
            op.onclick = function(e) {
                e.stopPropagation();
                btnImg.src = iconPath;
                btnText.textContent = filename;
                menu.classList.remove('open');
                onSelect(iconPath);
            };
            opts.appendChild(op);
        });
        
        btn.onclick = function(e) {
            e.stopPropagation();
            // Close other menus
            container.querySelectorAll('.menu.open').forEach(function(el) {
                if (el !== menu) el.classList.remove('open');
            });
            menu.classList.toggle('open');
        };
        
        document.addEventListener('click', function(e) {
            if (!menu.contains(e.target)) menu.classList.remove('open');
        });
        
        return menu;
    }
    
    
    // Close edit panels when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.formbuilder-accordion-editpanel') && 
            !e.target.closest('.formbuilder-accordion-option-editpanel') &&
            !e.target.closest('.formbuilder-accordion-header-editarea') &&
            !e.target.closest('.formbuilder-accordion-option-editarea') &&
            !e.target.closest('.formbuilder-accordion-header') &&
            !e.target.closest('.formbuilder-accordion-option-header')) {
            closeAllEditPanels();
        }
        // Close more menus when clicking outside
        if (!e.target.closest('.formbuilder-accordion-editpanel-more')) {
            document.querySelectorAll('.formbuilder-accordion-editpanel-more.open').forEach(function(el) {
                el.classList.remove('open');
            });
        }
        // Close fieldset menus when clicking outside
        if (!e.target.closest('.formbuilder-fieldset-menu')) {
            document.querySelectorAll('.formbuilder-fieldset-menu.open').forEach(function(el) {
                el.classList.remove('open');
            });
        }
    });
    
    // Fetch icons then categories
    fetch('/gateway.php?action=list-icons&folder=assets/icons-30/')
        .then(function(r) { return r.json(); })
        .then(function(res) {
            allIcons = (res.icons || []).map(function(name) { return 'assets/icons-30/' + name; });
            return fetch('/gateway.php?action=get-form');
        })
        .then(function(r) { return r.json(); })
        .then(function(res) {
            if (!res.success || !res.snapshot) return;
            
            var categories = res.snapshot.categories || [];
            var categoryIconPaths = res.snapshot.categoryIconPaths || {};
            var subcategoryIconPaths = res.snapshot.subcategoryIconPaths || {};
            var fieldsets = res.snapshot.fieldsets || [];
            
            categories.forEach(function(cat) {
                var accordion = document.createElement('div');
                accordion.className = 'formbuilder-accordion formbuilder-accordion--open';
                
                var catIconSrc = categoryIconPaths[cat.name] || '';
                
                // Header
                var header = document.createElement('div');
                header.className = 'formbuilder-accordion-header';
                
                var headerImg = document.createElement('img');
                headerImg.className = 'formbuilder-accordion-header-image';
                headerImg.src = catIconSrc;
                
                var headerText = document.createElement('span');
                headerText.className = 'formbuilder-accordion-header-text';
                headerText.textContent = cat.name;
                
                var headerArrow = document.createElement('span');
                headerArrow.className = 'formbuilder-accordion-header-arrow';
                headerArrow.textContent = '▼';
                
                var headerEditArea = document.createElement('div');
                headerEditArea.className = 'formbuilder-accordion-header-editarea';
                var headerEdit = document.createElement('div');
                headerEdit.className = 'formbuilder-accordion-header-edit';
                headerEdit.innerHTML = editPenSvg;
                headerEditArea.appendChild(headerEdit);
                
                var headerDrag = document.createElement('div');
                headerDrag.className = 'formbuilder-accordion-header-drag';
                headerDrag.innerHTML = dragHandleSvg;
                
                header.appendChild(headerImg);
                header.appendChild(headerText);
                header.appendChild(headerArrow);
                header.appendChild(headerDrag);
                header.appendChild(headerEditArea);
                
                // Category drag and drop
                accordion.draggable = true;
                accordion.addEventListener('dragstart', function(e) {
                    e.dataTransfer.effectAllowed = 'move';
                    accordion.classList.add('dragging');
                });
                accordion.addEventListener('dragend', function() {
                    accordion.classList.remove('dragging');
                });
                accordion.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    var dragging = container.querySelector('.formbuilder-accordion.dragging');
                    if (dragging && dragging !== accordion) {
                        var rect = accordion.getBoundingClientRect();
                        var midY = rect.top + rect.height / 2;
                        if (e.clientY < midY) {
                            accordion.parentNode.insertBefore(dragging, accordion);
                        } else {
                            accordion.parentNode.insertBefore(dragging, accordion.nextSibling);
                        }
                    }
                });
                
                // Edit panel
                var editPanel = document.createElement('div');
                editPanel.className = 'formbuilder-accordion-editpanel';
                
                var nameRow = document.createElement('div');
                nameRow.className = 'formbuilder-accordion-editpanel-row';
                
                var nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.className = 'formbuilder-accordion-editpanel-input';
                nameInput.value = cat.name;
                nameInput.oninput = function() {
                    headerText.textContent = nameInput.value || cat.name;
                };
                
                var moreBtn = document.createElement('div');
                moreBtn.className = 'formbuilder-accordion-editpanel-more';
                moreBtn.innerHTML = moreDotsVvg + '<div class="formbuilder-accordion-editpanel-more-menu"><div class="formbuilder-accordion-editpanel-more-item"><span class="formbuilder-accordion-editpanel-more-item-text">Hide Category</span><div class="formbuilder-accordion-editpanel-more-switch"></div></div><div class="formbuilder-accordion-editpanel-more-item formbuilder-accordion-editpanel-more-delete">Delete Category</div></div>';
                
                moreBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    container.querySelectorAll('.formbuilder-accordion-editpanel-more.open').forEach(function(el) {
                        if (el !== moreBtn) el.classList.remove('open');
                    });
                    moreBtn.classList.toggle('open');
                });
                
                var hideSwitch = moreBtn.querySelector('.formbuilder-accordion-editpanel-more-switch');
                hideSwitch.addEventListener('click', function(e) {
                    e.stopPropagation();
                    hideSwitch.classList.toggle('on');
                });
                
                nameRow.appendChild(nameInput);
                nameRow.appendChild(moreBtn);
                
                var iconPicker = buildIconPicker(catIconSrc, function(newIcon) {
                    headerImg.src = newIcon;
                });
                
                editPanel.appendChild(nameRow);
                editPanel.appendChild(iconPicker);
                
                // Body
                var body = document.createElement('div');
                body.className = 'formbuilder-accordion-body';
                
                var subs = cat.subs || [];
                subs.forEach(function(subName) {
                    var option = document.createElement('div');
                    option.className = 'formbuilder-accordion-option';
                    
                    var subIconSrc = subcategoryIconPaths[subName] || '';
                    
                    var optHeader = document.createElement('div');
                    optHeader.className = 'formbuilder-accordion-option-header';
                    
                    var optImg = document.createElement('img');
                    optImg.className = 'formbuilder-accordion-option-image';
                    optImg.crossOrigin = 'anonymous';
                    optImg.src = subIconSrc;
                    
                    // Extract dominant color for inputs/menus only
                    optImg.onload = function() {
                        extractDominantColor(optImg, function(r, g, b) {
                            // Blended color: rgba(r,g,b,0.2) on #222 (34,34,34)
                            var blendedR = Math.round(0.2 * r + 0.8 * 34);
                            var blendedG = Math.round(0.2 * g + 0.8 * 34);
                            var blendedB = Math.round(0.2 * b + 0.8 * 34);
                            // One shade darker (25% darker)
                            var darkerR = Math.round(blendedR * 0.75);
                            var darkerG = Math.round(blendedG * 0.75);
                            var darkerB = Math.round(blendedB * 0.75);
                            var darkerColor = 'rgb(' + darkerR + ',' + darkerG + ',' + darkerB + ')';
                            
                            subEditPanel.style.setProperty('--darker-bg', darkerColor);
                        });
                    };
                    
                    var optText = document.createElement('span');
                    optText.className = 'formbuilder-accordion-option-text';
                    optText.textContent = subName;
                    
                    var optArrow = document.createElement('span');
                    optArrow.className = 'formbuilder-accordion-option-arrow';
                    optArrow.textContent = '▼';
                    
                    var optEditArea = document.createElement('div');
                    optEditArea.className = 'formbuilder-accordion-option-editarea';
                    var optEdit = document.createElement('div');
                    optEdit.className = 'formbuilder-accordion-option-edit';
                    optEdit.innerHTML = editPenSvg;
                    optEditArea.appendChild(optEdit);
                    
                    var optDrag = document.createElement('div');
                    optDrag.className = 'formbuilder-accordion-option-drag';
                    optDrag.innerHTML = dragHandleSvg;
                    
                    optHeader.appendChild(optImg);
                    optHeader.appendChild(optText);
                    optHeader.appendChild(optArrow);
                    optHeader.appendChild(optDrag);
                    optHeader.appendChild(optEditArea);
                    
                    // Subcategory drag and drop
                    option.draggable = true;
                    option.addEventListener('dragstart', function(e) {
                        e.stopPropagation();
                        e.dataTransfer.effectAllowed = 'move';
                        option.classList.add('dragging');
                    });
                    option.addEventListener('dragend', function() {
                        option.classList.remove('dragging');
                    });
                    option.addEventListener('dragover', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        var dragging = body.querySelector('.formbuilder-accordion-option.dragging');
                        if (dragging && dragging !== option) {
                            var rect = option.getBoundingClientRect();
                            var midY = rect.top + rect.height / 2;
                            if (e.clientY < midY) {
                                option.parentNode.insertBefore(dragging, option);
                            } else {
                                option.parentNode.insertBefore(dragging, option.nextSibling);
                            }
                        }
                    });
                    
                    // Sub edit panel
                    var subEditPanel = document.createElement('div');
                    subEditPanel.className = 'formbuilder-accordion-option-editpanel';
                    
                    var subNameRow = document.createElement('div');
                    subNameRow.className = 'formbuilder-accordion-editpanel-row';
                    
                    var subNameInput = document.createElement('input');
                    subNameInput.type = 'text';
                    subNameInput.className = 'formbuilder-accordion-editpanel-input';
                    subNameInput.value = subName;
                    subNameInput.oninput = function() {
                        optText.textContent = subNameInput.value || subName;
                    };
                    
                    var subMoreBtn = document.createElement('div');
                    subMoreBtn.className = 'formbuilder-accordion-editpanel-more';
                    subMoreBtn.innerHTML = moreDotsVvg + '<div class="formbuilder-accordion-editpanel-more-menu"><div class="formbuilder-accordion-editpanel-more-item"><span class="formbuilder-accordion-editpanel-more-item-text">Hide Subcategory</span><div class="formbuilder-accordion-editpanel-more-switch"></div></div><div class="formbuilder-accordion-editpanel-more-item formbuilder-accordion-editpanel-more-delete">Delete Subcategory</div></div>';
                    
                    subMoreBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        container.querySelectorAll('.formbuilder-accordion-editpanel-more.open').forEach(function(el) {
                            if (el !== subMoreBtn) el.classList.remove('open');
                        });
                        subMoreBtn.classList.toggle('open');
                    });
                    
                    var subHideSwitch = subMoreBtn.querySelector('.formbuilder-accordion-editpanel-more-switch');
                    subHideSwitch.addEventListener('click', function(e) {
                        e.stopPropagation();
                        subHideSwitch.classList.toggle('on');
                    });
                    
                    subNameRow.appendChild(subNameInput);
                    subNameRow.appendChild(subMoreBtn);
                    
                    var subIconPicker = buildIconPicker(subIconSrc, function(newIcon) {
                        optImg.src = newIcon;
                        // Update input/menu colors
                        var tempImg = new Image();
                        tempImg.crossOrigin = 'anonymous';
                        tempImg.onload = function() {
                            extractDominantColor(tempImg, function(r, g, b) {
                                // Blended color: rgba(r,g,b,0.2) on #222 (34,34,34)
                                var blendedR = Math.round(0.2 * r + 0.8 * 34);
                                var blendedG = Math.round(0.2 * g + 0.8 * 34);
                                var blendedB = Math.round(0.2 * b + 0.8 * 34);
                                // One shade darker (25% darker)
                                var darkerR = Math.round(blendedR * 0.75);
                                var darkerG = Math.round(blendedG * 0.75);
                                var darkerB = Math.round(blendedB * 0.75);
                                var darkerColor = 'rgb(' + darkerR + ',' + darkerG + ',' + darkerB + ')';
                                
                                subEditPanel.style.setProperty('--darker-bg', darkerColor);
                            });
                        };
                        tempImg.src = newIcon;
                    });
                    
                    subEditPanel.appendChild(subNameRow);
                    subEditPanel.appendChild(subIconPicker);
                    
                    // Subcategory body with fieldset menu and form preview
                    var optBody = document.createElement('div');
                    optBody.className = 'formbuilder-accordion-option-body';
                    
                    // Container for added fields
                    var fieldsContainer = document.createElement('div');
                    fieldsContainer.className = 'formbuilder-fields-container';
                    optBody.appendChild(fieldsContainer);
                    
                    // Fieldset menu
                    var fieldsetMenu = document.createElement('div');
                    fieldsetMenu.className = 'formbuilder-fieldset-menu';
                    fieldsetMenu.innerHTML = '<div class="formbuilder-fieldset-menu-button">+ Add Field</div><div class="formbuilder-fieldset-menu-options"></div>';
                    var fieldsetBtn = fieldsetMenu.querySelector('.formbuilder-fieldset-menu-button');
                    var fieldsetOpts = fieldsetMenu.querySelector('.formbuilder-fieldset-menu-options');
                    
                    // Track added fieldsets for this subcategory
                    var addedFieldsets = {};
                    
                    // Populate fieldset options
                    fieldsets.forEach(function(fs) {
                        var fsId = fs.id || fs.key || fs.name;
                        var opt = document.createElement('div');
                        opt.className = 'formbuilder-fieldset-menu-option';
                        opt.textContent = fs.name || fs.key || 'Unnamed';
                        opt.setAttribute('data-fieldset-id', fsId);
                        opt.onclick = function(e) {
                            e.stopPropagation();
                            if (opt.classList.contains('disabled')) return;
                            
                            // Create field wrapper
                            var fieldWrapper = document.createElement('div');
                            fieldWrapper.className = 'formbuilder-field-wrapper';
                            fieldWrapper.setAttribute('data-fieldset-id', fsId);
                            
                            // Field header
                            var field = document.createElement('div');
                            field.className = 'formbuilder-field';
                            
                            var fieldText = document.createElement('span');
                            fieldText.className = 'formbuilder-field-text';
                            fieldText.textContent = fs.name || fs.key || 'Unnamed';
                            
                            var fieldDrag = document.createElement('div');
                            fieldDrag.className = 'formbuilder-field-drag';
                            fieldDrag.innerHTML = dragHandleSvg;
                            
                            var fieldEdit = document.createElement('div');
                            fieldEdit.className = 'formbuilder-field-edit';
                            fieldEdit.innerHTML = editPenSvg;
                            
                            field.appendChild(fieldText);
                            field.appendChild(fieldDrag);
                            field.appendChild(fieldEdit);
                            
                            // Field edit panel
                            var fieldEditPanel = document.createElement('div');
                            fieldEditPanel.className = 'formbuilder-field-editpanel';
                            
                            var editRow = document.createElement('div');
                            editRow.className = 'formbuilder-field-editpanel-row';
                            
                            var requiredLabel = document.createElement('label');
                            requiredLabel.className = 'formbuilder-field-required-label';
                            
                            var requiredCheckbox = document.createElement('input');
                            requiredCheckbox.type = 'checkbox';
                            requiredCheckbox.className = 'formbuilder-field-required-checkbox';
                            
                            requiredLabel.appendChild(requiredCheckbox);
                            requiredLabel.appendChild(document.createTextNode('Required'));
                            
                            var deleteBtn = document.createElement('button');
                            deleteBtn.className = 'formbuilder-field-delete';
                            deleteBtn.textContent = 'Delete';
                            deleteBtn.onclick = function(ev) {
                                ev.stopPropagation();
                                fieldWrapper.remove();
                                addedFieldsets[fsId] = false;
                                opt.classList.remove('disabled');
                            };
                            
                            editRow.appendChild(requiredLabel);
                            editRow.appendChild(deleteBtn);
                            fieldEditPanel.appendChild(editRow);
                            
                            fieldWrapper.appendChild(field);
                            fieldWrapper.appendChild(fieldEditPanel);
                            
                            // Field edit button click
                            fieldEdit.addEventListener('click', function(ev) {
                                ev.stopPropagation();
                                var isOpen = fieldWrapper.classList.contains('formbuilder-field-wrapper--editing');
                                // Close other field edit panels
                                fieldsContainer.querySelectorAll('.formbuilder-field-wrapper--editing').forEach(function(el) {
                                    el.classList.remove('formbuilder-field-wrapper--editing');
                                });
                                if (!isOpen) {
                                    fieldWrapper.classList.add('formbuilder-field-wrapper--editing');
                                }
                            });
                            
                            // Field wrapper drag and drop
                            fieldWrapper.draggable = true;
                            fieldWrapper.addEventListener('dragstart', function(ev) {
                                ev.stopPropagation();
                                ev.dataTransfer.effectAllowed = 'move';
                                fieldWrapper.classList.add('dragging');
                            });
                            fieldWrapper.addEventListener('dragend', function() {
                                fieldWrapper.classList.remove('dragging');
                            });
                            fieldWrapper.addEventListener('dragover', function(ev) {
                                ev.preventDefault();
                                ev.stopPropagation();
                                var dragging = fieldsContainer.querySelector('.formbuilder-field-wrapper.dragging');
                                if (dragging && dragging !== fieldWrapper) {
                                    var rect = fieldWrapper.getBoundingClientRect();
                                    var midY = rect.top + rect.height / 2;
                                    if (ev.clientY < midY) {
                                        fieldWrapper.parentNode.insertBefore(dragging, fieldWrapper);
                                    } else {
                                        fieldWrapper.parentNode.insertBefore(dragging, fieldWrapper.nextSibling);
                                    }
                                }
                            });
                            
                            fieldsContainer.appendChild(fieldWrapper);
                            // Mark as added and disable option
                            addedFieldsets[fsId] = true;
                            opt.classList.add('disabled');
                            fieldsetMenu.classList.remove('open');
                        };
                        fieldsetOpts.appendChild(opt);
                    });
                    
                    fieldsetBtn.onclick = function(e) {
                        e.stopPropagation();
                        container.querySelectorAll('.formbuilder-fieldset-menu.open').forEach(function(el) {
                            if (el !== fieldsetMenu) el.classList.remove('open');
                        });
                        fieldsetMenu.classList.toggle('open');
                    };
                    
                    optBody.appendChild(fieldsetMenu);
                    
                    var formPreviewBtn = document.createElement('div');
                    formPreviewBtn.className = 'formbuilder-add-button';
                    formPreviewBtn.textContent = 'Form Preview';
                    formPreviewBtn.style.marginTop = '3px';
                    optBody.appendChild(formPreviewBtn);
                    
                    option.appendChild(optHeader);
                    option.appendChild(subEditPanel);
                    option.appendChild(optBody);
                    
                    // Sub edit area click
                    optEditArea.addEventListener('click', function(e) {
                        e.stopPropagation();
                        var isOpen = option.classList.contains('formbuilder-accordion-option--editing');
                        closeAllEditPanels();
                        if (!isOpen) {
                            option.classList.add('formbuilder-accordion-option--editing');
                        }
                    });
                    
                    // Sub header click (except edit area) - placeholder for now
                    optHeader.addEventListener('click', function(e) {
                        if (e.target.closest('.formbuilder-accordion-option-editarea')) return;
                        if (!option.classList.contains('formbuilder-accordion-option--editing')) {
                            closeAllEditPanels();
                        }
                        option.classList.toggle('formbuilder-accordion-option--open');
                    });
                    
                    body.appendChild(option);
                });
                
                // Add Subcategory button
                var addSubBtn = document.createElement('div');
                addSubBtn.className = 'formbuilder-add-button';
                addSubBtn.textContent = '+ Add Subcategory';
                body.appendChild(addSubBtn);
                
                accordion.appendChild(header);
                accordion.appendChild(editPanel);
                accordion.appendChild(body);
                
                // Header edit area click
                headerEditArea.addEventListener('click', function(e) {
                    e.stopPropagation();
                    var isOpen = accordion.classList.contains('formbuilder-accordion--editing');
                    closeAllEditPanels();
                    if (!isOpen) {
                        accordion.classList.add('formbuilder-accordion--editing');
                    }
                });
                
                // Header click (except edit area) expands/collapses
                header.addEventListener('click', function(e) {
                    if (e.target.closest('.formbuilder-accordion-header-editarea')) return;
                    if (!accordion.classList.contains('formbuilder-accordion--editing')) {
                        closeAllEditPanels();
                    }
                    accordion.classList.toggle('formbuilder-accordion--open');
                });
                
                container.appendChild(accordion);
            });
            
            // Add Category button
            var addCatBtn = document.createElement('div');
            addCatBtn.className = 'formbuilder-add-button formbuilder-add-category';
            addCatBtn.textContent = '+ Add Category';
            container.appendChild(addCatBtn);
        });
})();
</script>

</body>
</html>
