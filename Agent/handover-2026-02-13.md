# Handover — 13 February 2026

## Completed Earlier Today (Previous Agent)

### 1. Rename "My Posts" to "Post Editor"
- Renamed all HTML IDs, classes, data attributes, aria attributes, and button text in `index.php`
- Renamed 14 CSS classes and keyframe animation in `base.css` (`member-myposts-*` → `member-posteditor-*`)
- Renamed ID selector, keyframe reference, and comments in `posteditor.css`
- Renamed ID selector, variable name (`isInMyPosts` → `isInPostEditor`), and comment in `components.js`
- Renamed variables (`mypostsTabBtn` → `posteditorTabBtn`, `myPostsEl` → `postEditorEl`), ID lookups, tab name strings, and 7 comments in `member.js`
- Renamed ID lookups and 4 comments in `posteditor.js`
- Renamed 2 comments in `post.js`
- Renamed 1 comment in `components.css`
- Renamed display text in `sitemap.html`
- **Database SQL provided but not yet applied** — 7 UPDATE statements (see SQL section below)

### 2. Auditor Tool Fix
- `Agent/auditor.html` search was case-sensitive (`String.includes`)
- Added "Case sensitive" checkbox — unchecked by default (case-insensitive search)
- Cleared pre-filled search box so it's ready to type

### 3. Wallpaper Double API Call Fix
- `refresh()` in `components.js` was calling `getLibraryWallpapers` twice per location change
- Fix: calls once and passes result via `prefetchedLib` parameter

### 4. Self-Healing Wallpaper Upload
- Added POST handling to `get-map-wallpapers.php` for automatic wallpaper upload
- Added `uploadCapturedWallpapers()` in `components.js`

---

## Completed This Session (Current Agent)

### 5. Multi-Location Postcard Text
- Postcards with more than 1 location now show "X Locations" instead of a single city name
- Applied to `renderPostCard` in `post.js` (covers post panel + post editor) and `marquee.js`
- Recent cards still show specific location per entry (by design — recents track individual locations)
- Added comment on `renderRecentCard` explaining the difference
- Fixed recent history (`addToRecentHistory`) to use the same venue/city/suburb/state/country formula as postcards

### 6. Post Editor Status Bar Redesign
- **Removed** locations fraction (3/3) — already shown in the location picker inside the editor
- **Moved** status word (ACTIVE/HIDDEN/etc.) from right to left
- **Added** checkout tier (Standard/Featured/Premium) next to status
- **Removed** date prefixes ("Expires"/"Expired"/"Deleted") — redundant with status word
- **New layout**: three flex items with `space-between`:
  1. Left: `[STATUS tier]` — bold status + normal tier, 6px gap, full white
  2. Center: countdown — bold, `rgba(255,255,255,0.85)`
  3. Right: date — normal, `rgba(255,255,255,0.6)`
- Padding changed to `2px 10px` (10px each side)

### 7. Checkout Tier Rename (Database + Code)
- **Database SQL applied**: Renamed `checkout_options` keys and titles:
  - `free-listing` → `free`, `Free Listing` → `Free`
  - `standard-listing` → `standard`, `Standard Listing` → `Standard`
  - `featured-listing` → `featured`, `Featured Listing` → `Featured`
  - `premium-listing` → `premium`, `Premium Listing` → `Premium`
- **Database SQL applied**: Updated all `posts.checkout_key` values to match
- Updated 2 comments in `save-admin-settings.php`
- Auditor confirmed 0 remaining references to old keys

### 8. Post Editor Postcard Click — Fly to Location + Toasts (PARTIAL)
- Clicking an **active** postcard flies the map to the first location (`MapModule.flyTo` at default zoom 14)
- Clicking **hidden** shows toast: "This post is hidden and not visible on the website."
- Clicking **expired** shows toast: "This post has expired and is no longer visible on the website."
- Clicking **deleted** shows toast: "This post has been deleted."
- Toast messages fetched from DB via `getMessage` (rows 272–274)
- Clicks on Manage button and favourite star are ignored (handled by their own listeners)

---

## INCOMPLETE — Needs Finishing

### ~~Post Editor Fly-To: Left Panel Behavior~~ COMPLETED
- Modified `closePanels()` in `header.js` to accept `options.keepMember` — skips closing member panel when truthy
- Exposed `setMode` in `HeaderModule` public API
- Updated postcard click handler in `posteditor.js` to mirror the PostLocationComponent different-location pattern:
  - `closePanels({ keepMember: true })` + `setMode('map')` → fly at `postsLoadZoom` → on `moveend` verify arrival → `closePanels({ keepMember: true })` + `setMode('posts')` → `PostModule.openPostById` with `autoExpand`
- Member panel stays open throughout the entire flow

### Filter Toast (msg_posteditor_toast_filtered, row 275)
**Not wired up.** A `wouldFiltersHidePost` function was attempted and completely removed — it was fundamentally broken because the agent did not understand the filter system.

**CRITICAL WARNING FOR NEXT AGENT:** The filter system on this website is complex and central to the entire application. Before writing ANY code that interacts with filters, you MUST thoroughly read and understand `FilterModule`, `get-posts.php`, and how filters are applied to map markers. There is both server-side and client-side filtering, and they behave differently at different zoom levels. Do NOT make assumptions about how filters work. Do NOT attempt to predict filter outcomes without reading the actual code first. The previous agent wasted significant time and caused major frustration by guessing.

---

## Files Modified This Session

| File | Changes |
|------|---------|
| `post.js` | Multi-location "X Locations" in `renderPostCard`, fixed location text in `addToRecentHistory`, added comment on `renderRecentCard` |
| `marquee.js` | Multi-location "X Locations" override |
| `posteditor.js` | Status bar redesign (tier, layout, removed locations), postcard click handler (fly + toasts + full left-panel behavior) |
| `posteditor.css` | Status bar CSS (3-item flex, removed locations/absolute positioning, added tier/left/countdown/date classes, dimmed colors) |
| `header.js` | `closePanels(options)` — added `keepMember` option; exposed `setMode` in public API |
| `save-admin-settings.php` | 2 comment updates for checkout key rename |

---

## Database SQL (Not Yet Applied — From Previous Agent)

```sql
UPDATE admin_messages SET message_name = 'Member Tab Post Editor', message_key = 'msg_member_tab_posteditor', message_text = 'Post Editor', message_description = 'Tab label for post editor section' WHERE id = 234;
UPDATE admin_messages SET message_description = 'Toast shown when member clicks a hidden post in Post Editor' WHERE id = 272;
UPDATE admin_messages SET message_description = 'Toast shown when member clicks an expired post in Post Editor' WHERE id = 273;
UPDATE admin_messages SET message_description = 'Toast shown when member clicks a deleted post in Post Editor' WHERE id = 274;
UPDATE admin_settings SET setting_value = '["create","posteditor","profile"]' WHERE id = 24;
UPDATE layout_tabs SET tab_key = 'member_posteditor', tab_name = 'Post Editor' WHERE id = 6;
```

## Database SQL (Applied This Session)

```sql
UPDATE checkout_options SET checkout_key = 'free', checkout_title = 'Free' WHERE checkout_key = 'free-listing';
UPDATE checkout_options SET checkout_key = 'standard', checkout_title = 'Standard' WHERE checkout_key = 'standard-listing';
UPDATE checkout_options SET checkout_key = 'featured', checkout_title = 'Featured' WHERE checkout_key = 'featured-listing';
UPDATE checkout_options SET checkout_key = 'premium', checkout_title = 'Premium' WHERE checkout_key = 'premium-listing';
UPDATE posts SET checkout_key = 'free' WHERE checkout_key = 'free-listing';
UPDATE posts SET checkout_key = 'standard' WHERE checkout_key = 'standard-listing';
UPDATE posts SET checkout_key = 'featured' WHERE checkout_key = 'featured-listing';
UPDATE posts SET checkout_key = 'premium' WHERE checkout_key = 'premium-listing';
```

---

## Outstanding Issues

### ~~1. Post Editor Fly-To — Left Panel Behavior~~ COMPLETED
### 2. Filter Toast — msg_posteditor_toast_filtered (see INCOMPLETE above)
### 3. Location Menu Flickering
- Switching locations inside an open post causes flicker.
### 4. Expired Non-Events on Map
- Filter doesn't distinguish events from non-events.
### 5. Hide Account 404
- `edit-member` connector missing from gateway.
### 6. Security: get-posts.php Filter Bypass
- Any user can fetch any post by ID, bypassing visibility/payment/moderation filters.
### 7. Rain in Spain Root Cause
- Fix works but "why only that post?" unanswered.
### 8. flagMissingMapImages 500 Error
- `moderation-action.php` returns 500 when flagging missing images.
### 9. Connector Directory Audit
- User noted unfamiliar files in `home/funmapco/connectors/`. Needs review.
