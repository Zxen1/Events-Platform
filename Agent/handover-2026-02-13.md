# Handover — 13 February 2026

## Completed This Session

### 1. Rename "My Posts" to "Post Editor"
- Renamed all HTML IDs, classes, data attributes, aria attributes, and button text in `index.php`
- Renamed 14 CSS classes and keyframe animation in `base.css` (`member-myposts-*` → `member-posteditor-*`)
- Renamed ID selector, keyframe reference, and comments in `posteditor.css`
- Renamed ID selector, variable name (`isInMyPosts` → `isInPostEditor`), and comment in `components.js`
- Renamed variables (`mypostsTabBtn` → `posteditorTabBtn`, `myPostsEl` → `postEditorEl`), ID lookups, tab name strings, and 7 comments in `member.js`
- Renamed ID lookups and 4 comments in `posteditor.js`
- Renamed 2 comments in `post.js`
- Renamed 1 comment in `components.css`
- Renamed display text in `sitemap.html`
- **Database SQL provided but not yet applied** — 7 UPDATE statements for `admin_messages` (rows 234, 272–274), `admin_settings` (row 24), and `layout_tabs` (row 6)

### 2. Auditor Tool Fix
- `Agent/auditor.html` search was case-sensitive (`String.includes`)
- Added "Case sensitive" checkbox — unchecked by default (case-insensitive search)
- Cleared pre-filled search box so it's ready to type

### 3. Wallpaper Double API Call Fix
- `refresh()` in `components.js` was calling `getLibraryWallpapers` twice per location change: once from `ensureAllFourImages` and once from the display mode (`startBasicMode`/`startStillMode`)
- Fix: `refresh()` now calls `getLibraryWallpapers` once for basic/still modes and passes the result to both functions via `prefetchedLib` parameter
- `ensureAllFourImages`, `startBasicMode`, `startStillMode` all accept optional `prefetchedLib` — if provided, skip the internal fetch
- Orbit and off modes unaffected (only `ensureAllFourImages` fetches, no duplicate)

### 4. Self-Healing Wallpaper Upload
- When any user views a post with missing wallpaper images, the browser captures the 4 bearings and now automatically uploads them to the configured storage
- Added POST handling to `get-map-wallpapers.php`: accepts `map_images[]` files + `map_images_meta` JSON, validates (WebP, valid bearings, valid coords), checks DB + HEAD request for existence, uploads to storage, inserts into `map_images` table
- Only adds, never replaces — if images already exist, skips
- Storage settings read from `admin_settings` (`folder_map_images`, `storage_api_key`, `storage_zone_name`)
- Added `uploadCapturedWallpapers()` function in `components.js` — called after `WallpaperCache.putAll()` in `ensureAllFourImages`, fire-and-forget
- Tested: Gdansk location went from 0 server images → 4 uploaded → instant load on next visit

---

## Files Modified

| File | Changes |
|------|---------|
| `index.php` | Post Editor rename (IDs, classes, data-tab, aria, button text) |
| `base.css` | 14 class renames, keyframe rename, comments |
| `posteditor.css` | ID selector, keyframe ref, 3 comments |
| `posteditor.js` | ID lookups, 4 comments |
| `components.js` | ID selector, variable rename, wallpaper double-call fix, self-healing upload function |
| `components.css` | 1 comment |
| `member.js` | Variable renames, ID lookups, tab name strings, 7 comments |
| `post.js` | 2 comments |
| `sitemap.html` | Display text |
| `Agent/auditor.html` | Case-insensitive search toggle, cleared pre-filled input |
| `get-map-wallpapers.php` | Added POST upload handling for self-healing |

---

## Database SQL (Not Yet Applied)

```sql
UPDATE admin_messages SET message_name = 'Member Tab Post Editor', message_key = 'msg_member_tab_posteditor', message_text = 'Post Editor', message_description = 'Tab label for post editor section' WHERE id = 234;
UPDATE admin_messages SET message_description = 'Toast shown when member clicks a hidden post in Post Editor' WHERE id = 272;
UPDATE admin_messages SET message_description = 'Toast shown when member clicks an expired post in Post Editor' WHERE id = 273;
UPDATE admin_messages SET message_description = 'Toast shown when member clicks a deleted post in Post Editor' WHERE id = 274;
UPDATE admin_settings SET setting_value = '["create","posteditor","profile"]' WHERE id = 24;
UPDATE layout_tabs SET tab_key = 'member_posteditor', tab_name = 'Post Editor' WHERE id = 6;
```

---

## Outstanding Issues

### 1. Tier Badge Visibility
- Featured/premium/standard should be visible at a glance on postcards without opening.
- Discussion started but not implemented.

### 2. Status Bar Position
- Move ACTIVE/HIDDEN/etc. from right to left side of status bar.

### 3. Toast Wiring
- DB rows 272–275 exist but JS isn't connected yet.

### 4. Location Menu Flickering
- Switching locations inside an open post causes flicker.

### 5. Expired Non-Events on Map
- Filter doesn't distinguish events from non-events.

### 6. Hide Account 404
- `edit-member` connector missing from gateway.

### 7. Security: get-posts.php Filter Bypass
- Any user can fetch any post by ID, bypassing visibility/payment/moderation filters.

### 8. Rain in Spain Root Cause
- Fix works but "why only that post?" unanswered.

### 9. flagMissingMapImages 500 Error
- `moderation-action.php` returns 500 when flagging missing images. Pre-existing, not related to this session's work. May involve a missing `checkout_title` column.

### 10. Connector Directory Audit
- User noted unfamiliar files in `home/funmapco/connectors/`. Needs review to identify orphaned/unnecessary connectors.
