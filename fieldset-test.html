<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fieldset Test</title>
    <!-- Google Places API - Replace YOUR_API_KEY with actual key -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyATJV1D6MtAUsQ58fSEHcSD8QmznJXAPqY&libraries=places"></script>
    <style>
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: sans-serif; padding: 20px; background: #1a1a1a; color: #fff; font-size: 13px; }
        
        .fieldset-container {
            width: 400px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        /* Fieldset wrapper */
        .fieldset {
            width: 100%;
        }
        .fieldset-header {
            font-size: 14px;
            font-weight: bold;
            color: #3b82f5;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
        }
        
        /* Label row */
        .fieldset-label {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }
        .fieldset-label-text {
            font-size: 13px;
            color: #fff;
        }
        .fieldset-label-required {
            color: #f87171;
            font-weight: bold;
            margin-left: 3px;
        }
        .fieldset-label-tooltip {
            width: 16px;
            height: 16px;
            margin-left: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #333;
            border-radius: 50%;
            color: #888;
            font-size: 10px;
            font-style: italic;
            font-family: serif;
            cursor: help;
            position: relative;
        }
        .fieldset-label-tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 6px);
            left: 50%;
            transform: translateX(-50%);
            background: #000;
            border: 1px solid #3b82f5;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 12px;
            font-style: normal;
            font-family: sans-serif;
            color: #fff;
            width: 250px;
            white-space: normal;
            z-index: 100;
            line-height: 1.4;
        }
        
        /* Text input */
        .fieldset-input {
            width: 100%;
            height: 36px;
            padding: 0 10px;
            background: #222;
            border: 1px solid #333;
            border-radius: 4px;
            color: #fff;
            font-size: 13px;
        }
        .fieldset-input:hover { border-color: #555; }
        .fieldset-input:focus { outline: none; border-color: #3b82f5; }
        .fieldset-input::placeholder { color: #666; }
        
        /* Textarea */
        .fieldset-textarea {
            width: 100%;
            min-height: 120px;
            padding: 10px;
            background: #222;
            border: 1px solid #333;
            border-radius: 4px;
            color: #fff;
            font-size: 13px;
            resize: vertical;
        }
        .fieldset-textarea:hover { border-color: #555; }
        .fieldset-textarea:focus { outline: none; border-color: #3b82f5; }
        .fieldset-textarea::placeholder { color: #666; }
        
        /* Dropdown menu (reusable from menu-test) */
        .fieldset-menu { width: 100%; height: 36px; position: relative; }
        .fieldset-menu-button { width: 100%; height: 36px; display: flex; align-items: center; padding: 0 10px; background: #222; border: 1px solid #333; border-radius: 4px; cursor: pointer; }
        .fieldset-menu-button:hover { border-color: #555; }
        .fieldset-menu.open .fieldset-menu-button { border-color: #3b82f5; border-radius: 4px 4px 0 0; border-bottom: none; }
        .fieldset-menu-button-image { width: 24px; height: 24px; object-fit: contain; flex-shrink: 0; }
        .fieldset-menu-button-text { flex: 1; text-align: left; padding-left: 10px; font-size: 13px; color: #fff; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .fieldset-menu-button-arrow { width: 16px; height: 36px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #888; transition: transform 0.2s; }
        .fieldset-menu.open .fieldset-menu-button-arrow { transform: rotate(180deg); }
        .fieldset-menu-options { display: none; position: absolute; top: 36px; left: 0; width: 100%; background: #222; border: 1px solid #3b82f5; border-top: none; border-radius: 0 0 4px 4px; max-height: 250px; overflow-y: auto; z-index: 100; scrollbar-width: thin; scrollbar-color: #888 transparent; }
        .fieldset-menu-options::-webkit-scrollbar { width: 8px; background: transparent; }
        .fieldset-menu-options::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .fieldset-menu.open .fieldset-menu-options { display: block; }
        .fieldset-menu-option { width: 100%; height: 36px; display: flex; align-items: center; padding: 0 10px; cursor: pointer; color: #fff; font-size: 13px; }
        .fieldset-menu-option:hover { background: #3b82f5; }
        .fieldset-menu-option-image { width: 24px; height: 24px; object-fit: contain; flex-shrink: 0; }
        .fieldset-menu-option-text { flex: 1; text-align: left; padding-left: 10px; font-size: 13px; }
        
        /* Native select fallback */
        .fieldset-select {
            width: 100%;
            height: 36px;
            padding: 0 10px;
            background: #222;
            border: 1px solid #333;
            border-radius: 4px;
            color: #fff;
            font-size: 13px;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
        }
        .fieldset-select:hover { border-color: #555; }
        .fieldset-select:focus { outline: none; border-color: #3b82f5; }
        .fieldset-select option { background: #222; color: #fff; }
        
        /* Radio buttons */
        .fieldset-radio-group { display: flex; flex-direction: column; gap: 8px; }
        .fieldset-radio { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .fieldset-radio-input { width: 18px; height: 18px; accent-color: #3b82f5; cursor: pointer; }
        .fieldset-radio-text { font-size: 13px; color: #fff; }
        
        /* Multi-field row */
        .fieldset-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .fieldset-row > * { flex: 1; }
        .fieldset-row > .fieldset-menu { flex: 0 0 120px; }
        .fieldset-row > .fieldset-input-small { flex: 0 0 100px; }
        
        /* Images upload */
        .fieldset-images {
            width: 100%;
            min-height: 120px;
            padding: 20px;
            background: #222;
            border: 2px dashed #333;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
        }
        .fieldset-images:hover { border-color: #3b82f5; }
        .fieldset-images-icon { font-size: 32px; color: #555; }
        .fieldset-images-text { font-size: 13px; color: #888; }
        
        /* Date and time */
        .fieldset-date, .fieldset-time {
            width: 100%;
            height: 36px;
            padding: 0 10px;
            background: #222;
            border: 1px solid #333;
            border-radius: 4px;
            color: #fff;
            font-size: 13px;
        }
        .fieldset-date:hover, .fieldset-time:hover { border-color: #555; }
        .fieldset-date:focus, .fieldset-time:focus { outline: none; border-color: #3b82f5; }
        .fieldset-date::-webkit-calendar-picker-indicator,
        .fieldset-time::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
        
        /* Horizontal scrolling calendar */
        .fieldset-calendar-container {
            width: 100%;
            overflow: hidden;
            background: #222;
            border: 1px solid #333;
            border-radius: 4px;
            position: relative;
            margin-bottom: 10px;
        }
        .fieldset-calendar-scroll {
            width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            scrollbar-width: thin;
            scrollbar-color: #888 #222;
        }
        .fieldset-calendar-scroll::-webkit-scrollbar {
            height: 8px;
            background: #222;
        }
        .fieldset-calendar-scroll::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .fieldset-calendar-scroll::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }
        .fieldset-calendar {
            display: flex;
            width: max-content;
        }
        .fieldset-calendar-month {
            flex: 0 0 auto;
            width: 250px;
        }
        .fieldset-calendar-month:not(:first-child) {
            border-left: 1px solid #1a1a1a;
        }
        .fieldset-calendar-header {
            height: 34px;
            line-height: 34px;
            text-align: center;
            font-size: 13px;
            font-weight: bold;
            background: #2e3a72;
        }
        .fieldset-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }
        .fieldset-calendar-weekday, .fieldset-calendar-day {
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
        }
        .fieldset-calendar-weekday { font-weight: bold; }
        .fieldset-calendar-day { cursor: pointer; }
        .fieldset-calendar-day.empty { cursor: default; background: #222; }
        .fieldset-calendar-day.past { background: #1a1a1a; color: #808080; }
        .fieldset-calendar-day.past:hover { background: #333; }
        .fieldset-calendar-day.future { background: #222; }
        .fieldset-calendar-day.future:hover { background: #333; }
        .fieldset-calendar-day.today { color: #ff0000; font-weight: bold; }
        .fieldset-calendar-day.selected { background: #2e3a72; color: #fff; }
        .fieldset-calendar-day.selected.today { color: #ff0000; }
        .fieldset-calendar-today-marker {
            position: absolute;
            bottom: 3px;
            width: 12px;
            height: 12px;
            background: #ff0000;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10;
        }
        
        /* Session rows (auto-generated from calendar) */
        .fieldset-sessions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .fieldset-session-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .fieldset-session-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .fieldset-session-date {
            flex: 1;
            height: 36px;
            padding: 0 10px;
            background: #333;
            border: 1px solid #333;
            border-radius: 4px;
            color: #fff;
            font-size: 13px;
            display: flex;
            align-items: center;
        }
        .fieldset-session-date-spacer {
            flex: 1;
            height: 36px;
        }
        .fieldset-session-time {
            flex: 0 0 100px;
        }
        .fieldset-session-add, .fieldset-session-remove {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: 1px solid #333;
            border-radius: 4px;
            color: #666;
            cursor: pointer;
            font-size: 18px;
        }
        .fieldset-session-add:hover { border-color: #3b82f5; color: #3b82f5; }
        .fieldset-session-remove:hover { border-color: #f87171; color: #f87171; }
        
        /* Section divider */
        .fieldset-divider {
            width: 100%;
            height: 1px;
            background: #333;
            margin: 8px 0;
        }
        
        /* Sub-label for multi-field */
        .fieldset-sublabel {
            font-size: 11px;
            color: #666;
            margin-bottom: 4px;
        }
        
        /* Google Places Autocomplete styling */
        .pac-container {
            background: #222;
            border: 1px solid #3b82f5;
            border-top: none;
            border-radius: 0 0 4px 4px;
            font-family: sans-serif;
            font-size: 13px;
            z-index: 10000;
        }
        .pac-item {
            padding: 8px 10px;
            color: #fff;
            cursor: pointer;
            border-top: 1px solid #333;
        }
        .pac-item:first-child { border-top: none; }
        .pac-item:hover { background: #3b82f5; }
        .pac-item-query { color: #fff; font-weight: bold; }
        .pac-matched { color: #3b82f5; }
        .pac-item:hover .pac-matched { color: #fff; }
        .pac-icon { display: none; }
        .pac-item-selected { background: #3b82f5; }
        
        /* Location status indicator */
        .fieldset-location-status {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
        }
        .fieldset-location-status.success { color: #22c55e; }
        .fieldset-location-status.error { color: #ef4444; }
        
        /* Amenities checklist grid */
        .fieldset-amenities {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .fieldset-amenity-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 6px 0;
        }
        .fieldset-amenity-icon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }
        .fieldset-amenity-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: brightness(0) invert(1);
        }
        .fieldset-amenity-name {
            flex: 1;
            font-size: 13px;
            color: #fff;
        }
        .fieldset-amenity-options {
            display: flex;
            gap: 16px;
            flex-shrink: 0;
        }
        .fieldset-amenity-option {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            cursor: pointer;
            font-size: 12px;
            color: #ccc;
            min-width: 36px;
            min-height: 36px;
            padding: 0 8px;
            border-radius: 4px;
        }
        .fieldset-amenity-option input {
            cursor: pointer;
            accent-color: #3b82f5;
        }
        /* Row states based on selection */
        .fieldset-amenity-row.selected-yes .fieldset-amenity-icon img {
            filter: brightness(0) saturate(100%) invert(45%) sepia(95%) saturate(1000%) hue-rotate(200deg) brightness(100%);
        }
        .fieldset-amenity-row.selected-no .fieldset-amenity-icon img {
            filter: brightness(0) invert(0.4);
        }
        .fieldset-amenity-row.selected-no .fieldset-amenity-name {
            color: #666;
        }
    </style>
</head>
<body>

<!-- Front-end search test (for user map navigation) -->
<div class="fieldset-container" style="margin-bottom: 40px;">
    <div class="fieldset">
        <div class="fieldset-header">Front-End Search (User Navigation)</div>
        <div class="fieldset-sublabel">Search for any place - POI, address, city (for map flyTo)</div>
        <input type="text" id="frontend-search" class="fieldset-input" placeholder="Search any location...">
        <div id="frontend-status" class="fieldset-location-status"></div>
        <div id="frontend-result" style="margin-top: 10px; padding: 10px; background: #111; border-radius: 4px; font-size: 12px; color: #888; display: none;">
            <div><strong>Name:</strong> <span id="result-name">-</span></div>
            <div><strong>Address:</strong> <span id="result-address">-</span></div>
            <div><strong>Lat:</strong> <span id="result-lat">-</span></div>
            <div><strong>Lng:</strong> <span id="result-lng">-</span></div>
            <div><strong>Place ID:</strong> <span id="result-placeid">-</span></div>
        </div>
    </div>
</div>

<div class="fieldset-container" id="fieldset-container"></div>

<script>
(function(){
    var container = document.getElementById('fieldset-container');
    var picklist = {};
    
    // Close all menus when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.fieldset-menu')) {
            container.querySelectorAll('.fieldset-menu.open').forEach(function(el) {
                el.classList.remove('open');
            });
        }
    });
    
    // Initialize front-end search (all types - for user navigation)
    function initFrontendSearch() {
        var input = document.getElementById('frontend-search');
        var status = document.getElementById('frontend-status');
        var resultBox = document.getElementById('frontend-result');
        
        if (typeof google === 'undefined' || !google.maps || !google.maps.places) {
            status.textContent = 'Google Places API not loaded - add your API key';
            status.className = 'fieldset-location-status error';
            return;
        }
        
        // No type restriction - search everything
        var autocomplete = new google.maps.places.Autocomplete(input, {
            fields: ['formatted_address', 'geometry', 'name', 'place_id', 'types']
        });
        
        autocomplete.addListener('place_changed', function() {
            var place = autocomplete.getPlace();
            
            if (!place.geometry || !place.geometry.location) {
                status.textContent = 'No location data for this place';
                status.className = 'fieldset-location-status error';
                resultBox.style.display = 'none';
                return;
            }
            
            var lat = place.geometry.location.lat();
            var lng = place.geometry.location.lng();
            
            status.textContent = 'âœ“ Ready to flyTo: [' + lng.toFixed(6) + ', ' + lat.toFixed(6) + ']';
            status.className = 'fieldset-location-status success';
            
            // Show result details
            resultBox.style.display = 'block';
            document.getElementById('result-name').textContent = place.name || '-';
            document.getElementById('result-address').textContent = place.formatted_address || '-';
            document.getElementById('result-lat').textContent = lat;
            document.getElementById('result-lng').textContent = lng;
            document.getElementById('result-placeid').textContent = place.place_id || '-';
            
            console.log('Front-end search result:', place);
            console.log('Mapbox flyTo command: map.flyTo({ center: [' + lng + ', ' + lat + '], zoom: 15 });');
        });
        
        status.textContent = 'Google Places ready - start typing';
    }
    
    // Initialize on page load
    if (typeof google !== 'undefined' && google.maps) {
        initFrontendSearch();
    } else {
        window.addEventListener('load', function() {
            setTimeout(initFrontendSearch, 100);
        });
    }
    
    // Google Places Autocomplete helper
    // type: 'address' | 'establishment' | '(cities)'
    function initGooglePlaces(inputElement, type, latInput, lngInput, statusElement) {
        if (typeof google === 'undefined' || !google.maps || !google.maps.places) {
            console.warn('Google Places API not loaded');
            if (statusElement) {
                statusElement.textContent = 'Location search unavailable';
                statusElement.className = 'fieldset-location-status error';
            }
            return null;
        }
        
        var options = {
            fields: ['formatted_address', 'geometry', 'name', 'place_id']
        };
        
        // Set type restriction
        if (type === 'address') {
            options.types = ['address'];
        } else if (type === 'establishment') {
            options.types = ['establishment'];
        } else if (type === '(cities)') {
            options.types = ['(cities)'];
        }
        
        var autocomplete = new google.maps.places.Autocomplete(inputElement, options);
        
        autocomplete.addListener('place_changed', function() {
            var place = autocomplete.getPlace();
            
            if (!place.geometry || !place.geometry.location) {
                if (statusElement) {
                    statusElement.textContent = 'No location data for this place';
                    statusElement.className = 'fieldset-location-status error';
                }
                return;
            }
            
            var lat = place.geometry.location.lat();
            var lng = place.geometry.location.lng();
            
            if (latInput) latInput.value = lat;
            if (lngInput) lngInput.value = lng;
            
            if (statusElement) {
                statusElement.textContent = 'âœ“ Location set: ' + lat.toFixed(6) + ', ' + lng.toFixed(6);
                statusElement.className = 'fieldset-location-status success';
            }
            
            console.log('Google Places result:', {
                name: place.name,
                address: place.formatted_address,
                lat: lat,
                lng: lng,
                place_id: place.place_id
            });
        });
        
        return autocomplete;
    }
    
    // Build currency menu
    function buildCurrencyMenu(placeholder) {
        var menu = document.createElement('div');
        menu.className = 'fieldset-menu';
        menu.innerHTML = '<div class="fieldset-menu-button"><img class="fieldset-menu-button-image" src="" alt=""><span class="fieldset-menu-button-text">Select currency...</span><span class="fieldset-menu-button-arrow">â–¼</span></div><div class="fieldset-menu-options"></div>';
        
        var btn = menu.querySelector('.fieldset-menu-button');
        var opts = menu.querySelector('.fieldset-menu-options');
        var btnImg = menu.querySelector('.fieldset-menu-button-image');
        var btnText = menu.querySelector('.fieldset-menu-button-text');
        
        var currencies = picklist['currency'] || [];
        currencies.forEach(function(item) {
            var op = document.createElement('div');
            op.className = 'fieldset-menu-option';
            op.innerHTML = '<img class="fieldset-menu-option-image" src="assets/flags/' + item.value.substring(0,2) + '.svg" alt=""><span class="fieldset-menu-option-text">' + item.value.substring(3) + ' - ' + item.label + '</span>';
            op.onclick = function(e) {
                e.stopPropagation();
                btnImg.src = 'assets/flags/' + item.value.substring(0,2) + '.svg';
                btnText.textContent = item.value.substring(3) + ' - ' + item.label;
                menu.classList.remove('open');
            };
            opts.appendChild(op);
        });
        
        btn.onclick = function(e) {
            e.stopPropagation();
            container.querySelectorAll('.fieldset-menu.open').forEach(function(el) {
                if (el !== menu) el.classList.remove('open');
            });
            menu.classList.toggle('open');
        };
        
        return menu;
    }
    
    // Build phone prefix menu
    function buildPhonePrefixMenu() {
        var menu = document.createElement('div');
        menu.className = 'fieldset-menu';
        menu.style.flex = '0 0 140px';
        menu.innerHTML = '<div class="fieldset-menu-button"><img class="fieldset-menu-button-image" src="" alt=""><span class="fieldset-menu-button-text">+...</span><span class="fieldset-menu-button-arrow">â–¼</span></div><div class="fieldset-menu-options"></div>';
        
        var btn = menu.querySelector('.fieldset-menu-button');
        var opts = menu.querySelector('.fieldset-menu-options');
        var btnImg = menu.querySelector('.fieldset-menu-button-image');
        var btnText = menu.querySelector('.fieldset-menu-button-text');
        
        var prefixes = picklist['phone-prefix'] || [];
        if (prefixes.length > 0) {
            btnImg.src = 'assets/flags/' + prefixes[0].value.substring(0,2) + '.svg';
            btnText.textContent = prefixes[0].value.substring(3);
        }
        
        prefixes.forEach(function(item) {
            var op = document.createElement('div');
            op.className = 'fieldset-menu-option';
            op.innerHTML = '<img class="fieldset-menu-option-image" src="assets/flags/' + item.value.substring(0,2) + '.svg" alt=""><span class="fieldset-menu-option-text">' + item.value.substring(3) + ' - ' + item.label + '</span>';
            op.onclick = function(e) {
                e.stopPropagation();
                btnImg.src = 'assets/flags/' + item.value.substring(0,2) + '.svg';
                btnText.textContent = item.value.substring(3);
                menu.classList.remove('open');
            };
            opts.appendChild(op);
        });
        
        btn.onclick = function(e) {
            e.stopPropagation();
            container.querySelectorAll('.fieldset-menu.open').forEach(function(el) {
                if (el !== menu) el.classList.remove('open');
            });
            menu.classList.toggle('open');
        };
        
        return menu;
    }
    
    // Build label with required asterisk and tooltip
    function buildLabel(name, tooltip) {
        var label = document.createElement('div');
        label.className = 'fieldset-label';
        label.innerHTML = '<span class="fieldset-label-text">' + name + '</span><span class="fieldset-label-required">*</span>';
        if (tooltip) {
            var tip = document.createElement('span');
            tip.className = 'fieldset-label-tooltip';
            tip.textContent = 'i';
            tip.setAttribute('data-tooltip', tooltip);
            label.appendChild(tip);
        }
        return label;
    }
    
    // Fetch general options first, then fieldsets
    fetch('/gateway.php?action=get-admin-settings')
        .then(function(r) { return r.json(); })
        .then(function(res) {
            picklist = res.picklist || {};
            return fetch('/gateway.php?action=get-form');
        })
        .then(function(r) { return r.json(); })
        .then(function(res) {
            if (!res.success || !res.snapshot) return;
            
            var fieldsets = res.snapshot.fieldsets || [];
            
            fieldsets.forEach(function(fs, index) {
                var fieldset = document.createElement('div');
                fieldset.className = 'fieldset';
                
                var key = fs.fieldset_key || fs.key || '';
                var name = fs.fieldset_name || fs.name || 'Unnamed';
                var tooltip = fs.fieldset_tooltip || '';
                var placeholder = fs.fieldset_placeholder || '';
                var options = fs.fieldset_options || [];
                var fields = fs.fieldset_fields || [];
                
                // Add divider between fieldsets (except first)
                if (index > 0) {
                    var divider = document.createElement('div');
                    divider.className = 'fieldset-divider';
                    container.appendChild(divider);
                }
                
                // Build based on fieldset type
                switch (key) {
                    case 'title':
                    case 'coupon':
                        fieldset.appendChild(buildLabel(name, tooltip));
                        var input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'fieldset-input';
                        input.placeholder = placeholder;
                        fieldset.appendChild(input);
                        break;
                        
                    case 'description':
                        fieldset.appendChild(buildLabel(name, tooltip));
                        var textarea = document.createElement('textarea');
                        textarea.className = 'fieldset-textarea';
                        textarea.placeholder = placeholder;
                        fieldset.appendChild(textarea);
                        break;
                        
                    case 'text-box':
                        fieldset.appendChild(buildLabel(name + ' (editable)', tooltip));
                        var input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'fieldset-input';
                        input.placeholder = placeholder;
                        fieldset.appendChild(input);
                        break;
                        
                    case 'text-area':
                        fieldset.appendChild(buildLabel(name + ' (editable)', tooltip));
                        var textarea = document.createElement('textarea');
                        textarea.className = 'fieldset-textarea';
                        textarea.placeholder = placeholder;
                        fieldset.appendChild(textarea);
                        break;
                        
                    case 'dropdown':
                        fieldset.appendChild(buildLabel(name + ' (editable)', tooltip));
                        var select = document.createElement('select');
                        select.className = 'fieldset-select';
                        select.innerHTML = '<option value="">Select an option...</option>';
                        if (Array.isArray(options)) {
                            options.forEach(function(opt) {
                                var option = document.createElement('option');
                                option.value = opt;
                                option.textContent = opt;
                                select.appendChild(option);
                            });
                        }
                        fieldset.appendChild(select);
                        break;
                        
                    case 'radio':
                        fieldset.appendChild(buildLabel(name + ' (editable)', tooltip));
                        var radioGroup = document.createElement('div');
                        radioGroup.className = 'fieldset-radio-group';
                        if (Array.isArray(options)) {
                            options.forEach(function(opt, i) {
                                var radio = document.createElement('label');
                                radio.className = 'fieldset-radio';
                                radio.innerHTML = '<input type="radio" name="radio-' + index + '" class="fieldset-radio-input" value="' + opt + '"><span class="fieldset-radio-text">' + opt + '</span>';
                                radioGroup.appendChild(radio);
                            });
                        }
                        fieldset.appendChild(radioGroup);
                        break;
                        
                    case 'email':
                        fieldset.appendChild(buildLabel(name, tooltip));
                        var input = document.createElement('input');
                        input.type = 'email';
                        input.className = 'fieldset-input';
                        input.placeholder = placeholder;
                        fieldset.appendChild(input);
                        break;
                        
                    case 'phone':
                        fieldset.appendChild(buildLabel(name, tooltip));
                        var row = document.createElement('div');
                        row.className = 'fieldset-row';
                        row.appendChild(buildPhonePrefixMenu());
                        var phoneInput = document.createElement('input');
                        phoneInput.type = 'tel';
                        phoneInput.className = 'fieldset-input';
                        phoneInput.placeholder = placeholder;
                        row.appendChild(phoneInput);
                        fieldset.appendChild(row);
                        break;
                        
                    case 'address':
                    case 'location': // legacy support
                        fieldset.appendChild(buildLabel(name, tooltip));
                        var addrInputEl = document.createElement('input');
                        addrInputEl.type = 'text';
                        addrInputEl.className = 'fieldset-input';
                        addrInputEl.placeholder = placeholder || 'Search for address...';
                        fieldset.appendChild(addrInputEl);
                        // Hidden lat/lng fields
                        var addrLatInput = document.createElement('input');
                        addrLatInput.type = 'hidden';
                        addrLatInput.className = 'fieldset-lat';
                        var addrLngInput = document.createElement('input');
                        addrLngInput.type = 'hidden';
                        addrLngInput.className = 'fieldset-lng';
                        fieldset.appendChild(addrLatInput);
                        fieldset.appendChild(addrLngInput);
                        // Status indicator
                        var addrStatus = document.createElement('div');
                        addrStatus.className = 'fieldset-location-status';
                        fieldset.appendChild(addrStatus);
                        // Init Google Places
                        initGooglePlaces(addrInputEl, 'address', addrLatInput, addrLngInput, addrStatus);
                        break;
                        
                    case 'city':
                        fieldset.appendChild(buildLabel(name, tooltip));
                        var cityInputEl = document.createElement('input');
                        cityInputEl.type = 'text';
                        cityInputEl.className = 'fieldset-input';
                        cityInputEl.placeholder = placeholder || 'Search for city or town...';
                        fieldset.appendChild(cityInputEl);
                        // Hidden lat/lng fields
                        var cityLatInput = document.createElement('input');
                        cityLatInput.type = 'hidden';
                        cityLatInput.className = 'fieldset-lat';
                        var cityLngInput = document.createElement('input');
                        cityLngInput.type = 'hidden';
                        cityLngInput.className = 'fieldset-lng';
                        fieldset.appendChild(cityLatInput);
                        fieldset.appendChild(cityLngInput);
                        // Status indicator
                        var cityStatus = document.createElement('div');
                        cityStatus.className = 'fieldset-location-status';
                        fieldset.appendChild(cityStatus);
                        // Init Google Places (cities only)
                        initGooglePlaces(cityInputEl, '(cities)', cityLatInput, cityLngInput, cityStatus);
                        break;
                        
                    case 'website-url':
                    case 'tickets-url':
                        fieldset.appendChild(buildLabel(name, tooltip));
                        var input = document.createElement('input');
                        input.type = 'url';
                        input.className = 'fieldset-input';
                        input.placeholder = placeholder;
                        fieldset.appendChild(input);
                        break;
                        
                    case 'images':
                        fieldset.appendChild(buildLabel(name, tooltip));
                        var upload = document.createElement('div');
                        upload.className = 'fieldset-images';
                        upload.innerHTML = '<div class="fieldset-images-icon">ðŸ“·</div><div class="fieldset-images-text">Click to upload images</div>';
                        fieldset.appendChild(upload);
                        break;
                    
                    case 'amenities':
                        fieldset.appendChild(buildLabel(name, tooltip));
                        var amenitiesGrid = document.createElement('div');
                        amenitiesGrid.className = 'fieldset-amenities';
                        
                        // Get amenities from picklist table
                        var amenities = picklist['amenity'] || [];
                        
                        amenities.forEach(function(item, i) {
                            // Parse value: "parking Parking" -> icon: parking, name: Parking
                            var parts = item.value.split(' ');
                            var iconKey = parts[0];
                            var amenityName = parts.slice(1).join(' ');
                            var description = item.label;
                            
                            var row = document.createElement('div');
                            row.className = 'fieldset-amenity-row';
                            row.title = description; // Tooltip on hover
                            
                            // Icon
                            var iconEl = document.createElement('div');
                            iconEl.className = 'fieldset-amenity-icon';
                            iconEl.innerHTML = '<img src="assets/amenities/' + iconKey + '.svg" alt="' + amenityName + '">';
                            row.appendChild(iconEl);
                            
                            // Name
                            var nameEl = document.createElement('div');
                            nameEl.className = 'fieldset-amenity-name';
                            nameEl.textContent = amenityName;
                            row.appendChild(nameEl);
                            
                            // Yes/No options
                            var optionsEl = document.createElement('div');
                            optionsEl.className = 'fieldset-amenity-options';
                            
                            var yesLabel = document.createElement('label');
                            yesLabel.className = 'fieldset-amenity-option';
                            yesLabel.innerHTML = '<input type="radio" name="amenity-' + iconKey + '" value="1"> Yes';
                            optionsEl.appendChild(yesLabel);
                            
                            var noLabel = document.createElement('label');
                            noLabel.className = 'fieldset-amenity-option';
                            noLabel.innerHTML = '<input type="radio" name="amenity-' + iconKey + '" value="0"> No';
                            optionsEl.appendChild(noLabel);
                            
                            // Add change listeners to update row styling
                            var yesRadio = yesLabel.querySelector('input');
                            var noRadio = noLabel.querySelector('input');
                            
                            yesRadio.addEventListener('change', function() {
                                row.classList.remove('selected-no');
                                row.classList.add('selected-yes');
                            });
                            
                            noRadio.addEventListener('change', function() {
                                row.classList.remove('selected-yes');
                                row.classList.add('selected-no');
                            });
                            
                            row.appendChild(optionsEl);
                            amenitiesGrid.appendChild(row);
                        });
                        
                        fieldset.appendChild(amenitiesGrid);
                        break;
                        
                    case 'item-pricing':
                        // Item Name > Item Variant > Item Price > Currency
                        fieldset.appendChild(buildLabel(name, tooltip));
                        
                        // Row 1: Item Name + Item Variant
                        var itemRow1 = document.createElement('div');
                        itemRow1.className = 'fieldset-row';
                        itemRow1.style.marginBottom = '10px';
                        
                        var itemNameCol = document.createElement('div');
                        itemNameCol.style.flex = '1';
                        var itemNameSub = document.createElement('div');
                        itemNameSub.className = 'fieldset-sublabel';
                        itemNameSub.textContent = 'Item Name';
                        var itemNameInput = document.createElement('input');
                        itemNameInput.type = 'text';
                        itemNameInput.className = 'fieldset-input';
                        itemNameInput.placeholder = 'eg. T-Shirt';
                        itemNameCol.appendChild(itemNameSub);
                        itemNameCol.appendChild(itemNameInput);
                        
                        var itemVariantCol = document.createElement('div');
                        itemVariantCol.style.flex = '1';
                        var itemVariantSub = document.createElement('div');
                        itemVariantSub.className = 'fieldset-sublabel';
                        itemVariantSub.textContent = 'Item Variant';
                        var itemVariantInput = document.createElement('input');
                        itemVariantInput.type = 'text';
                        itemVariantInput.className = 'fieldset-input';
                        itemVariantInput.placeholder = 'eg. Large Red';
                        itemVariantCol.appendChild(itemVariantSub);
                        itemVariantCol.appendChild(itemVariantInput);
                        
                        itemRow1.appendChild(itemNameCol);
                        itemRow1.appendChild(itemVariantCol);
                        fieldset.appendChild(itemRow1);
                        
                        // Row 2: Price + Currency
                        var itemRow2 = document.createElement('div');
                        itemRow2.className = 'fieldset-row';
                        
                        var itemPriceCol = document.createElement('div');
                        itemPriceCol.style.flex = '1';
                        var itemPriceSub = document.createElement('div');
                        itemPriceSub.className = 'fieldset-sublabel';
                        itemPriceSub.textContent = 'Item Price';
                        var itemPriceInput = document.createElement('input');
                        itemPriceInput.type = 'number';
                        itemPriceInput.className = 'fieldset-input';
                        itemPriceInput.placeholder = '0.00';
                        itemPriceInput.step = '0.01';
                        itemPriceCol.appendChild(itemPriceSub);
                        itemPriceCol.appendChild(itemPriceInput);
                        
                        var itemCurrencyCol = document.createElement('div');
                        itemCurrencyCol.style.flex = '0 0 130px';
                        var itemCurrencySub = document.createElement('div');
                        itemCurrencySub.className = 'fieldset-sublabel';
                        itemCurrencySub.textContent = 'Currency';
                        itemCurrencyCol.appendChild(itemCurrencySub);
                        itemCurrencyCol.appendChild(buildCurrencyMenu());
                        
                        itemRow2.appendChild(itemPriceCol);
                        itemRow2.appendChild(itemCurrencyCol);
                        fieldset.appendChild(itemRow2);
                        break;
                        
                    case 'ticket-pricing':
                        // Seating Area > Pricing Tier > Ticket Price > Currency
                        fieldset.appendChild(buildLabel(name, tooltip));
                        
                        // Row 1: Seating Area + Pricing Tier
                        var ticketRow1 = document.createElement('div');
                        ticketRow1.className = 'fieldset-row';
                        ticketRow1.style.marginBottom = '10px';
                        
                        var seatAreaCol = document.createElement('div');
                        seatAreaCol.style.flex = '1';
                        var seatAreaSub = document.createElement('div');
                        seatAreaSub.className = 'fieldset-sublabel';
                        seatAreaSub.textContent = 'Seating Area';
                        var seatAreaInput = document.createElement('input');
                        seatAreaInput.type = 'text';
                        seatAreaInput.className = 'fieldset-input';
                        seatAreaInput.placeholder = 'eg. Orchestra';
                        seatAreaCol.appendChild(seatAreaSub);
                        seatAreaCol.appendChild(seatAreaInput);
                        
                        var priceTierCol = document.createElement('div');
                        priceTierCol.style.flex = '1';
                        var priceTierSub = document.createElement('div');
                        priceTierSub.className = 'fieldset-sublabel';
                        priceTierSub.textContent = 'Pricing Tier';
                        var priceTierInput = document.createElement('input');
                        priceTierInput.type = 'text';
                        priceTierInput.className = 'fieldset-input';
                        priceTierInput.placeholder = 'eg. Adult';
                        priceTierCol.appendChild(priceTierSub);
                        priceTierCol.appendChild(priceTierInput);
                        
                        ticketRow1.appendChild(seatAreaCol);
                        ticketRow1.appendChild(priceTierCol);
                        fieldset.appendChild(ticketRow1);
                        
                        // Row 2: Ticket Price + Currency
                        var ticketRow2 = document.createElement('div');
                        ticketRow2.className = 'fieldset-row';
                        
                        var ticketPriceCol2 = document.createElement('div');
                        ticketPriceCol2.style.flex = '1';
                        var ticketPriceSub2 = document.createElement('div');
                        ticketPriceSub2.className = 'fieldset-sublabel';
                        ticketPriceSub2.textContent = 'Ticket Price';
                        var ticketPriceInput2 = document.createElement('input');
                        ticketPriceInput2.type = 'number';
                        ticketPriceInput2.className = 'fieldset-input';
                        ticketPriceInput2.placeholder = '0.00';
                        ticketPriceInput2.step = '0.01';
                        ticketPriceCol2.appendChild(ticketPriceSub2);
                        ticketPriceCol2.appendChild(ticketPriceInput2);
                        
                        var ticketCurrencyCol2 = document.createElement('div');
                        ticketCurrencyCol2.style.flex = '0 0 130px';
                        var ticketCurrencySub2 = document.createElement('div');
                        ticketCurrencySub2.className = 'fieldset-sublabel';
                        ticketCurrencySub2.textContent = 'Currency';
                        ticketCurrencyCol2.appendChild(ticketCurrencySub2);
                        ticketCurrencyCol2.appendChild(buildCurrencyMenu());
                        
                        ticketRow2.appendChild(ticketPriceCol2);
                        ticketRow2.appendChild(ticketCurrencyCol2);
                        fieldset.appendChild(ticketRow2);
                        break;
                        
                    case 'session':
                        // Horizontal scrolling calendar + auto-generated session rows with autofill
                        fieldset.appendChild(buildLabel(name, tooltip));
                        
                        // Track selected dates: { '2025-01-15': { times: ['19:00', ''], edited: [true, false] }, ... }
                        var sessionData = {};
                        
                        var today = new Date();
                        today.setHours(0, 0, 0, 0);
                        var todayIso = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
                        
                        var minDate = new Date(today.getFullYear(), today.getMonth(), 1);
                        var maxDate = new Date(today.getFullYear(), today.getMonth() + 24, 1);
                        
                        var todayMonthEl = null;
                        var todayMonthIndex = 0;
                        var totalMonths = 0;
                        var weekdayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                        
                        function toISODate(d) {
                            return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
                        }
                        
                        function getDayOfWeek(dateStr) {
                            var d = new Date(dateStr + 'T00:00:00');
                            return d.getDay();
                        }
                        
                        // Calendar container
                        var calContainer = document.createElement('div');
                        calContainer.className = 'fieldset-calendar-container';
                        
                        var calScroll = document.createElement('div');
                        calScroll.className = 'fieldset-calendar-scroll';
                        
                        var calendar = document.createElement('div');
                        calendar.className = 'fieldset-calendar';
                        
                        // Build months
                        var current = new Date(minDate.getFullYear(), minDate.getMonth(), 1);
                        var monthIdx = 0;
                        while (current <= maxDate) {
                            var monthEl = document.createElement('div');
                            monthEl.className = 'fieldset-calendar-month';
                            
                            var header = document.createElement('div');
                            header.className = 'fieldset-calendar-header';
                            header.textContent = current.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
                            monthEl.appendChild(header);
                            
                            var grid = document.createElement('div');
                            grid.className = 'fieldset-calendar-grid';
                            
                            weekdayNames.forEach(function(wd) {
                                var w = document.createElement('div');
                                w.className = 'fieldset-calendar-weekday';
                                w.textContent = wd;
                                grid.appendChild(w);
                            });
                            
                            var firstDay = new Date(current.getFullYear(), current.getMonth(), 1);
                            var startDow = firstDay.getDay();
                            var daysInMonth = new Date(current.getFullYear(), current.getMonth() + 1, 0).getDate();
                            
                            for (var i = 0; i < 42; i++) {
                                var cell = document.createElement('div');
                                cell.className = 'fieldset-calendar-day';
                                var dayNum = i - startDow + 1;
                                
                                if (i < startDow || dayNum > daysInMonth) {
                                    cell.classList.add('empty');
                                } else {
                                    cell.textContent = dayNum;
                                    var dateObj = new Date(current.getFullYear(), current.getMonth(), dayNum);
                                    dateObj.setHours(0, 0, 0, 0);
                                    var iso = toISODate(dateObj);
                                    cell.dataset.iso = iso;
                                    
                                    if (dateObj < today) {
                                        cell.classList.add('past');
                                    } else {
                                        cell.classList.add('future');
                                    }
                                    
                                    if (iso === todayIso) {
                                        cell.classList.add('today');
                                        todayMonthEl = monthEl;
                                        todayMonthIndex = monthIdx;
                                    }
                                }
                                grid.appendChild(cell);
                            }
                            
                            monthEl.appendChild(grid);
                            calendar.appendChild(monthEl);
                            current.setMonth(current.getMonth() + 1);
                            monthIdx++;
                        }
                        totalMonths = monthIdx;
                        
                        calScroll.appendChild(calendar);
                        calContainer.appendChild(calScroll);
                        
                        // Today marker
                        var marker = document.createElement('div');
                        marker.className = 'fieldset-calendar-today-marker';
                        calContainer.appendChild(marker);
                        
                        fieldset.appendChild(calContainer);
                        
                        // Sessions container (below calendar)
                        var sessionsContainer = document.createElement('div');
                        sessionsContainer.className = 'fieldset-sessions';
                        fieldset.appendChild(sessionsContainer);
                        
                        // Position marker dynamically based on today's month index
                        setTimeout(function() {
                            if (todayMonthEl) {
                                calScroll.scrollLeft = todayMonthEl.offsetLeft;
                            }
                            var markerFraction = (todayMonthIndex + 0.5) / totalMonths;
                            var markerPos = markerFraction * (calContainer.clientWidth - 12);
                            marker.style.left = markerPos + 'px';
                        }, 0);
                        
                        // Marker click - scroll to today
                        marker.addEventListener('click', function() {
                            if (todayMonthEl) {
                                calScroll.scrollTo({ left: todayMonthEl.offsetLeft, behavior: 'smooth' });
                            }
                        });
                        
                        // Horizontal wheel scroll
                        calScroll.addEventListener('wheel', function(e) {
                            e.preventDefault();
                            calScroll.scrollLeft += e.deltaY || e.deltaX;
                        });
                        
                        // Track which slot indices have had their "god" time set
                        // GOD = first edit fills ALL dates
                        // DEMIGOD = subsequent edits fill same weekday only
                        var godSetForSlot = {};
                        
                        function autofillTimes(changedDateStr, changedSlotIdx, newTime) {
                            var sortedDates = Object.keys(sessionData).sort();
                            var changedDow = getDayOfWeek(changedDateStr);
                            
                            if (!godSetForSlot[changedSlotIdx]) {
                                // GOD MODE: first edit at this slot - fill ALL unedited slots
                                godSetForSlot[changedSlotIdx] = true;
                                
                                for (var i = 0; i < sortedDates.length; i++) {
                                    var dateStr = sortedDates[i];
                                    if (dateStr === changedDateStr) continue;
                                    var data = sessionData[dateStr];
                                    if (data.times.length > changedSlotIdx && !data.edited[changedSlotIdx]) {
                                        data.times[changedSlotIdx] = newTime;
                                    }
                                }
                            } else {
                                // DEMIGOD MODE: fill only same weekday unedited slots
                                for (var i = 0; i < sortedDates.length; i++) {
                                    var dateStr = sortedDates[i];
                                    if (dateStr === changedDateStr) continue;
                                    if (getDayOfWeek(dateStr) !== changedDow) continue;
                                    var data = sessionData[dateStr];
                                    if (data.times.length > changedSlotIdx && !data.edited[changedSlotIdx]) {
                                        data.times[changedSlotIdx] = newTime;
                                    }
                                }
                            }
                        }
                        
                        // Get autofill value for a new time slot (worship the demigod - same weekday first)
                        function getAutofillForSlot(dateStr, slotIdx) {
                            var dow = getDayOfWeek(dateStr);
                            var sortedDates = Object.keys(sessionData).sort();
                            
                            // Priority 1: Same weekday with a value at this slot (worship the demigod)
                            for (var i = 0; i < sortedDates.length; i++) {
                                var d = sortedDates[i];
                                if (d === dateStr) continue;
                                if (getDayOfWeek(d) === dow && sessionData[d].times.length > slotIdx && sessionData[d].times[slotIdx]) {
                                    return sessionData[d].times[slotIdx];
                                }
                            }
                            
                            // Priority 2: Any date with a value at this slot (worship the god if no demigod)
                            for (var i = 0; i < sortedDates.length; i++) {
                                var d = sortedDates[i];
                                if (d === dateStr) continue;
                                if (sessionData[d].times.length > slotIdx && sessionData[d].times[slotIdx]) {
                                    return sessionData[d].times[slotIdx];
                                }
                            }
                            
                            return '';
                        }
                        
                        // Render session rows
                        function renderSessions() {
                            sessionsContainer.innerHTML = '';
                            
                            var sortedDates = Object.keys(sessionData).sort();
                            
                            sortedDates.forEach(function(dateStr) {
                                var data = sessionData[dateStr];
                                var group = document.createElement('div');
                                group.className = 'fieldset-session-group';
                                
                                data.times.forEach(function(timeVal, idx) {
                                    var row = document.createElement('div');
                                    row.className = 'fieldset-session-row';
                                    
                                    if (idx === 0) {
                                        var dateDisplay = document.createElement('div');
                                        dateDisplay.className = 'fieldset-session-date';
                                        var d = new Date(dateStr + 'T00:00:00');
                                        dateDisplay.textContent = d.toLocaleDateString('en-AU', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
                                        row.appendChild(dateDisplay);
                                    } else {
                                        var spacer = document.createElement('div');
                                        spacer.className = 'fieldset-session-date-spacer';
                                        row.appendChild(spacer);
                                    }
                                    
                                    var timeWrapper = document.createElement('div');
                                    timeWrapper.className = 'fieldset-session-time';
                                    var timeInput = document.createElement('input');
                                    timeInput.type = 'time';
                                    timeInput.className = 'fieldset-time';
                                    timeInput.value = timeVal;
                                    
                                    (function(dateStr, idx) {
                                        timeInput.addEventListener('change', function() {
                                            var newTime = this.value;
                                            sessionData[dateStr].times[idx] = newTime;
                                            sessionData[dateStr].edited[idx] = true;
                                            autofillTimes(dateStr, idx, newTime);
                                            renderSessions();
                                        });
                                    })(dateStr, idx);
                                    
                                    timeWrapper.appendChild(timeInput);
                                    row.appendChild(timeWrapper);
                                    
                                    // + button (always visible, greyed out at max 10)
                                    var maxTimesPerDate = 10;
                                    var addBtn = document.createElement('button');
                                    addBtn.type = 'button';
                                    addBtn.className = 'fieldset-session-add';
                                    addBtn.textContent = '+';
                                    if (data.times.length >= maxTimesPerDate) {
                                        addBtn.disabled = true;
                                        addBtn.style.opacity = '0.3';
                                        addBtn.style.cursor = 'not-allowed';
                                    } else {
                                        (function(dateStr, idx) {
                                            addBtn.addEventListener('click', function() {
                                                var newSlotIdx = idx + 1;
                                                var autofillVal = getAutofillForSlot(dateStr, newSlotIdx);
                                                sessionData[dateStr].times.splice(newSlotIdx, 0, autofillVal);
                                                sessionData[dateStr].edited.splice(newSlotIdx, 0, false);
                                                renderSessions();
                                            });
                                        })(dateStr, idx);
                                    }
                                    row.appendChild(addBtn);
                                    
                                    // - button (always visible, greyed out if only 1 time)
                                    var removeBtn = document.createElement('button');
                                    removeBtn.type = 'button';
                                    removeBtn.className = 'fieldset-session-remove';
                                    removeBtn.textContent = 'âˆ’';
                                    if (data.times.length === 1) {
                                        removeBtn.disabled = true;
                                        removeBtn.style.opacity = '0.3';
                                        removeBtn.style.cursor = 'not-allowed';
                                    } else {
                                        (function(dateStr, idx) {
                                            removeBtn.addEventListener('click', function() {
                                                sessionData[dateStr].times.splice(idx, 1);
                                                sessionData[dateStr].edited.splice(idx, 1);
                                                renderSessions();
                                            });
                                        })(dateStr, idx);
                                    }
                                    row.appendChild(removeBtn);
                                    
                                    group.appendChild(row);
                                });
                                
                                sessionsContainer.appendChild(group);
                            });
                        }
                        
                        // Calendar day click
                        calendar.addEventListener('click', function(e) {
                            var day = e.target;
                            if (day.classList.contains('fieldset-calendar-day') && !day.classList.contains('empty')) {
                                var iso = day.dataset.iso;
                                if (sessionData[iso]) {
                                    delete sessionData[iso];
                                    day.classList.remove('selected');
                                } else {
                                    // New date - autofill first time slot
                                    var autofillVal = getAutofillForSlot(iso, 0);
                                    sessionData[iso] = { times: [autofillVal], edited: [false] };
                                    day.classList.add('selected');
                                }
                                renderSessions();
                            }
                        });
                        
                        break;
                        
                    case 'venue':
                        // SMART VENUE FIELDSET
                        // - Both inputs have Google Places (unrestricted)
                        // - Auto-fill ONLY empty boxes
                        // - User edits are protected
                        fieldset.appendChild(buildLabel(name, tooltip));
                        
                        // Hidden lat/lng fields
                        var smartLatInput = document.createElement('input');
                        smartLatInput.type = 'hidden';
                        smartLatInput.className = 'fieldset-lat';
                        var smartLngInput = document.createElement('input');
                        smartLngInput.type = 'hidden';
                        smartLngInput.className = 'fieldset-lng';
                        
                        // Venue name row
                        var smartVenueSub = document.createElement('div');
                        smartVenueSub.className = 'fieldset-sublabel';
                        smartVenueSub.textContent = 'Venue Name';
                        fieldset.appendChild(smartVenueSub);
                        var smartVenueInput = document.createElement('input');
                        smartVenueInput.type = 'text';
                        smartVenueInput.className = 'fieldset-input';
                        smartVenueInput.placeholder = 'Search or type venue name...';
                        smartVenueInput.style.marginBottom = '8px';
                        fieldset.appendChild(smartVenueInput);
                        
                        // Address row
                        var smartAddrSub = document.createElement('div');
                        smartAddrSub.className = 'fieldset-sublabel';
                        smartAddrSub.textContent = 'Address';
                        fieldset.appendChild(smartAddrSub);
                        var smartAddrInput = document.createElement('input');
                        smartAddrInput.type = 'text';
                        smartAddrInput.className = 'fieldset-input';
                        smartAddrInput.placeholder = 'Search or type address...';
                        smartAddrInput.style.marginBottom = '4px';
                        fieldset.appendChild(smartAddrInput);
                        
                        // Status indicator
                        var smartStatus = document.createElement('div');
                        smartStatus.className = 'fieldset-location-status';
                        fieldset.appendChild(smartStatus);
                        
                        fieldset.appendChild(smartLatInput);
                        fieldset.appendChild(smartLngInput);
                        
                        // Smart autofill function - only fills empty boxes
                        function initSmartVenueAutocomplete(inputEl, otherInputEl, isVenueBox) {
                            if (typeof google === 'undefined' || !google.maps || !google.maps.places) {
                                console.warn('Google Places API not loaded');
                                return;
                            }
                            
                            // Unrestricted search - finds both venues and addresses
                            var autocomplete = new google.maps.places.Autocomplete(inputEl, {
                                fields: ['formatted_address', 'geometry', 'name', 'place_id', 'types']
                            });
                            
                            autocomplete.addListener('place_changed', function() {
                                var place = autocomplete.getPlace();
                                if (!place.geometry || !place.geometry.location) return;
                                
                                var lat = place.geometry.location.lat();
                                var lng = place.geometry.location.lng();
                                var venueName = place.name || '';
                                var address = place.formatted_address || '';
                                var isEstablishment = place.types && place.types.includes('establishment');
                                
                                // Always update lat/lng
                                smartLatInput.value = lat;
                                smartLngInput.value = lng;
                                
                                if (isVenueBox) {
                                    // User searched in venue box
                                    // Strip venue name to just the name (Google fills with full address)
                                    if (isEstablishment && venueName) {
                                        smartVenueInput.value = venueName;
                                    }
                                    // Address: fill only if empty
                                    if (!smartAddrInput.value.trim()) {
                                        smartAddrInput.value = address;
                                    }
                                } else {
                                    // User searched in address box
                                    // Address: strip to just address (in case Google added extra)
                                    smartAddrInput.value = address;
                                    // Venue name: fill only if empty AND result is an establishment
                                    if (!smartVenueInput.value.trim() && isEstablishment && venueName) {
                                        smartVenueInput.value = venueName;
                                    }
                                }
                                
                                // Update status
                                smartStatus.textContent = 'âœ“ Location set: ' + lat.toFixed(6) + ', ' + lng.toFixed(6);
                                smartStatus.className = 'fieldset-location-status success';
                                
                                console.log('Smart venue result:', {
                                    name: venueName,
                                    address: address,
                                    isEstablishment: isEstablishment,
                                    lat: lat,
                                    lng: lng
                                });
                            });
                        }
                        
                        // Init both inputs with smart autofill
                        initSmartVenueAutocomplete(smartVenueInput, smartAddrInput, true);
                        initSmartVenueAutocomplete(smartAddrInput, smartVenueInput, false);
                        break;
                    
                    case 'venue-ticketing':
                        fieldset.appendChild(buildLabel(name, tooltip));
                        
                        // Hidden lat/lng fields for venue
                        var venueLatInput = document.createElement('input');
                        venueLatInput.type = 'hidden';
                        venueLatInput.className = 'fieldset-lat';
                        var venueLngInput = document.createElement('input');
                        venueLngInput.type = 'hidden';
                        venueLngInput.className = 'fieldset-lng';
                        
                        // Venue name row (POI search)
                        var venueSub = document.createElement('div');
                        venueSub.className = 'fieldset-sublabel';
                        venueSub.textContent = 'Venue Name (search for business/venue)';
                        fieldset.appendChild(venueSub);
                        var venueInput = document.createElement('input');
                        venueInput.type = 'text';
                        venueInput.className = 'fieldset-input';
                        venueInput.placeholder = 'eg. Sydney Opera House';
                        venueInput.style.marginBottom = '4px';
                        fieldset.appendChild(venueInput);
                        
                        // Venue status
                        var venueStatus = document.createElement('div');
                        venueStatus.className = 'fieldset-location-status';
                        venueStatus.style.marginBottom = '10px';
                        fieldset.appendChild(venueStatus);
                        
                        // Address row (address search - if venue not found)
                        var vtAddrSub = document.createElement('div');
                        vtAddrSub.className = 'fieldset-sublabel';
                        vtAddrSub.textContent = 'Or search by address';
                        fieldset.appendChild(vtAddrSub);
                        var vtAddrInput = document.createElement('input');
                        vtAddrInput.type = 'text';
                        vtAddrInput.className = 'fieldset-input';
                        vtAddrInput.placeholder = 'Search for address...';
                        vtAddrInput.style.marginBottom = '4px';
                        fieldset.appendChild(vtAddrInput);
                        
                        // Address status
                        var vtAddrStatus = document.createElement('div');
                        vtAddrStatus.className = 'fieldset-location-status';
                        vtAddrStatus.style.marginBottom = '10px';
                        fieldset.appendChild(vtAddrStatus);
                        
                        fieldset.appendChild(venueLatInput);
                        fieldset.appendChild(venueLngInput);
                        
                        // Init Google Places for venue (establishment/POI)
                        initGooglePlaces(venueInput, 'establishment', venueLatInput, venueLngInput, venueStatus);
                        // Init Google Places for address fallback
                        initGooglePlaces(vtAddrInput, 'address', venueLatInput, venueLngInput, vtAddrStatus);
                        
                        // Date/Time row
                        var dtRow = document.createElement('div');
                        dtRow.className = 'fieldset-row';
                        dtRow.style.marginBottom = '10px';
                        
                        var dateCol = document.createElement('div');
                        dateCol.style.flex = '1';
                        var dateSub = document.createElement('div');
                        dateSub.className = 'fieldset-sublabel';
                        dateSub.textContent = 'Session Date';
                        var dateInput = document.createElement('input');
                        dateInput.type = 'date';
                        dateInput.className = 'fieldset-date';
                        dateCol.appendChild(dateSub);
                        dateCol.appendChild(dateInput);
                        
                        var timeCol = document.createElement('div');
                        timeCol.style.flex = '1';
                        var timeSub = document.createElement('div');
                        timeSub.className = 'fieldset-sublabel';
                        timeSub.textContent = 'Session Time';
                        var timeInput = document.createElement('input');
                        timeInput.type = 'time';
                        timeInput.className = 'fieldset-time';
                        timeCol.appendChild(timeSub);
                        timeCol.appendChild(timeInput);
                        
                        dtRow.appendChild(dateCol);
                        dtRow.appendChild(timeCol);
                        fieldset.appendChild(dtRow);
                        
                        // Seating/Tier row
                        var stRow = document.createElement('div');
                        stRow.className = 'fieldset-row';
                        stRow.style.marginBottom = '10px';
                        
                        var seatCol = document.createElement('div');
                        seatCol.style.flex = '1';
                        var seatSub = document.createElement('div');
                        seatSub.className = 'fieldset-sublabel';
                        seatSub.textContent = 'Seating Area';
                        var seatInput = document.createElement('input');
                        seatInput.type = 'text';
                        seatInput.className = 'fieldset-input';
                        seatInput.placeholder = 'eg. Section A';
                        seatCol.appendChild(seatSub);
                        seatCol.appendChild(seatInput);
                        
                        var tierCol = document.createElement('div');
                        tierCol.style.flex = '1';
                        var tierSub = document.createElement('div');
                        tierSub.className = 'fieldset-sublabel';
                        tierSub.textContent = 'Pricing Tier';
                        var tierInput = document.createElement('input');
                        tierInput.type = 'text';
                        tierInput.className = 'fieldset-input';
                        tierInput.placeholder = 'eg. VIP';
                        tierCol.appendChild(tierSub);
                        tierCol.appendChild(tierInput);
                        
                        stRow.appendChild(seatCol);
                        stRow.appendChild(tierCol);
                        fieldset.appendChild(stRow);
                        
                        // Price/Currency row
                        var pcRow = document.createElement('div');
                        pcRow.className = 'fieldset-row';
                        
                        var ticketPriceCol = document.createElement('div');
                        ticketPriceCol.style.flex = '1';
                        var ticketPriceSub = document.createElement('div');
                        ticketPriceSub.className = 'fieldset-sublabel';
                        ticketPriceSub.textContent = 'Ticket Price';
                        var ticketPriceInput = document.createElement('input');
                        ticketPriceInput.type = 'number';
                        ticketPriceInput.className = 'fieldset-input';
                        ticketPriceInput.placeholder = '0.00';
                        ticketPriceInput.step = '0.01';
                        ticketPriceCol.appendChild(ticketPriceSub);
                        ticketPriceCol.appendChild(ticketPriceInput);
                        
                        var ticketCurrencyCol = document.createElement('div');
                        ticketCurrencyCol.style.flex = '0 0 130px';
                        var ticketCurrencySub = document.createElement('div');
                        ticketCurrencySub.className = 'fieldset-sublabel';
                        ticketCurrencySub.textContent = 'Currency';
                        ticketCurrencyCol.appendChild(ticketCurrencySub);
                        ticketCurrencyCol.appendChild(buildCurrencyMenu());
                        
                        pcRow.appendChild(ticketPriceCol);
                        pcRow.appendChild(ticketCurrencyCol);
                        fieldset.appendChild(pcRow);
                        break;
                        
                    default:
                        // Generic text input fallback
                        fieldset.appendChild(buildLabel(name, tooltip));
                        var input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'fieldset-input';
                        input.placeholder = placeholder;
                        fieldset.appendChild(input);
                }
                
                container.appendChild(fieldset);
            });
        });
})();
</script>

</body>
</html>
