<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fieldset Test</title>
    <!-- Google Places API - Replace YOUR_API_KEY with actual key -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyATJV1D6MtAUsQ58fSEHcSD8QmznJXAPqY&libraries=places"></script>
    <style>
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: sans-serif; padding: 20px; background: #1a1a1a; color: #fff; font-size: 13px; }
        
        .fieldset-container {
            width: 400px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        /* Fieldset wrapper */
        .fieldset {
            width: 100%;
        }
        .fieldset-header {
            font-size: 14px;
            font-weight: bold;
            color: #3b82f5;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
        }
        
        /* Label row */
        .fieldset-label {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }
        .fieldset-label-text {
            font-size: 13px;
            color: #fff;
        }
        .fieldset-label-required {
            color: #f87171;
            font-weight: bold;
            margin-left: 3px;
        }
        .fieldset-label-tooltip {
            width: 16px;
            height: 16px;
            margin-left: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #333;
            border-radius: 50%;
            color: #888;
            font-size: 10px;
            font-style: italic;
            font-family: serif;
            cursor: help;
            position: relative;
        }
        .fieldset-label-tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 6px);
            left: 0;
            background: #000;
            border: 1px solid #3b82f5;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 12px;
            font-style: normal;
            font-family: sans-serif;
            color: #fff;
            width: 250px;
            max-width: calc(100vw - 40px);
            white-space: normal;
            z-index: 1000;
            line-height: 1.4;
        }
        
        /* Text input */
        .fieldset-input {
            width: 100%;
            height: 36px;
            padding: 0 10px;
            background: #222;
            border: 1px solid #333;
            border-radius: 4px;
            color: #fff;
            font-size: 13px;
        }
        .fieldset-input:hover { border-color: #555; }
        /* Remove number input spinners */
        .fieldset-input[type="number"]::-webkit-outer-spin-button,
        .fieldset-input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .fieldset-input[type="number"] { -moz-appearance: textfield; appearance: textfield; }
        .fieldset-input:focus { outline: none; border-color: #3b82f5; }
        .fieldset-input::placeholder { color: #666; }
        .fieldset-input--invalid { border-color: #ef4444; }
        .fieldset-input--invalid:focus { border-color: #ef4444; }
        .fieldset-char-count { font-size: 11px; color: #666; text-align: right; margin-top: 3px; }
        .fieldset-char-count--warning { color: #f59e0b; }
        .fieldset-char-count--danger { color: #ef4444; }
        
        /* Textarea */
        .fieldset-textarea {
            width: 100%;
            min-height: 120px;
            padding: 10px;
            background: #222;
            border: 1px solid #333;
            border-radius: 4px;
            color: #fff;
            font-size: 13px;
            resize: vertical;
        }
        .fieldset-textarea:hover { border-color: #555; }
        .fieldset-textarea:focus { outline: none; border-color: #3b82f5; }
        .fieldset-textarea::placeholder { color: #666; }
        .fieldset-textarea.fieldset-input--invalid { border-color: #ef4444; }
        .fieldset-textarea.fieldset-input--invalid:focus { border-color: #ef4444; }
        
        /* Dropdown menu (reusable from menu-test) */
        .fieldset-menu { width: 100%; height: 36px; position: relative; }
        .fieldset-menu-button { width: 100%; height: 36px; display: flex; align-items: center; padding: 0 10px; background: #222; border: 1px solid #333; border-radius: 4px; cursor: pointer; }
        .fieldset-menu-button:hover { border-color: #555; }
        .fieldset-menu.open .fieldset-menu-button { border-color: #3b82f5; border-radius: 4px 4px 0 0; border-bottom: none; }
        .fieldset-menu-button-image { width: 24px; height: 24px; object-fit: contain; flex-shrink: 0; }
        .fieldset-menu-button-text { flex: 1; text-align: left; padding-left: 10px; font-size: 13px; color: #fff; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .fieldset-menu-button-arrow { width: 16px; height: 36px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #888; transition: transform 0.2s; }
        .fieldset-menu.open .fieldset-menu-button-arrow { transform: rotate(180deg); }
        .fieldset-menu-options { display: none; position: absolute; top: 36px; left: 0; width: 100%; background: #222; border: 1px solid #3b82f5; border-top: none; border-radius: 0 0 4px 4px; max-height: 250px; overflow-y: auto; z-index: 1000; scrollbar-width: thin; scrollbar-color: #888 transparent; }
        .fieldset-menu-options::-webkit-scrollbar { width: 8px; background: transparent; }
        .fieldset-menu-options::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .fieldset-menu.open .fieldset-menu-options { display: block; }
        .fieldset-menu-option { width: 100%; height: 36px; display: flex; align-items: center; padding: 0 10px; cursor: pointer; color: #fff; font-size: 13px; }
        .fieldset-menu-option:hover { background: #3b82f5; }
        .fieldset-menu-option-image { width: 24px; height: 24px; object-fit: contain; flex-shrink: 0; }
        .fieldset-menu-option-text { flex: 1; text-align: left; padding-left: 10px; font-size: 13px; }
        
        /* Native select fallback */
        .fieldset-select {
            width: 100%;
            height: 36px;
            padding: 0 10px;
            background: #222;
            border: 1px solid #333;
            border-radius: 4px;
            color: #fff;
            font-size: 13px;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
        }
        .fieldset-select:hover { border-color: #555; }
        .fieldset-select:focus { outline: none; border-color: #3b82f5; }
        .fieldset-select option { background: #222; color: #fff; }
        
        /* Radio buttons */
        .fieldset-radio-group { display: flex; flex-direction: column; gap: 8px; }
        .fieldset-radio { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .fieldset-radio-input { width: 18px; height: 18px; accent-color: #3b82f5; cursor: pointer; }
        .fieldset-radio-text { font-size: 13px; color: #fff; }
        
        /* Multi-field row */
        .fieldset-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .fieldset-row > * { flex: 1; }
        .fieldset-row > .fieldset-menu { flex: 0 0 120px; }
        .fieldset-row > .fieldset-currency-compact { flex: 0 0 100px; }
        .fieldset-row > .fieldset-input-small { flex: 0 0 100px; }
        
        /* Images upload */
        .fieldset-images {
            width: 76px;
            height: 76px;
            padding: 0;
            background: #222;
            border: 2px dashed #333;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            cursor: pointer;
            flex-shrink: 0;
        }
        .fieldset-images:hover { border-color: #3b82f5; }
        .fieldset-images-icon { font-size: 22px; color: #555; }
        .fieldset-images-text { font-size: 10px; color: #888; }
        
        /* Date and time */
        .fieldset-date, .fieldset-time {
            width: 100%;
            height: 36px;
            padding: 0 10px;
            background: #222;
            border: 1px solid #333;
            border-radius: 4px;
            color: #fff;
            font-size: 13px;
        }
        .fieldset-date:hover, .fieldset-time:hover { border-color: #555; }
        .fieldset-date:focus, .fieldset-time:focus { outline: none; border-color: #3b82f5; }
        .fieldset-date::-webkit-calendar-picker-indicator,
        .fieldset-time::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
        
        /* Horizontal scrolling calendar */
        .fieldset-calendar-container {
            width: 100%;
            overflow: hidden;
            background: #222;
            border: 1px solid #333;
            border-radius: 4px;
            position: relative;
            margin-bottom: 10px;
        }
        .fieldset-calendar-scroll {
            width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            scrollbar-width: thin;
            scrollbar-color: #888 #222;
        }
        .fieldset-calendar-scroll::-webkit-scrollbar {
            height: 8px;
            background: #222;
        }
        .fieldset-calendar-scroll::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .fieldset-calendar-scroll::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }
        .fieldset-calendar {
            display: flex;
            width: max-content;
        }
        .fieldset-calendar-month {
            flex: 0 0 auto;
            width: 250px;
        }
        .fieldset-calendar-month:not(:first-child) {
            border-left: 1px solid #1a1a1a;
        }
        .fieldset-calendar-header {
            height: 34px;
            line-height: 34px;
            text-align: center;
            font-size: 13px;
            font-weight: bold;
            background: #2e3a72;
        }
        .fieldset-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }
        .fieldset-calendar-weekday, .fieldset-calendar-day {
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
        }
        .fieldset-calendar-weekday { font-weight: bold; }
        .fieldset-calendar-day { cursor: pointer; }
        .fieldset-calendar-day.empty { cursor: default; background: #222; }
        .fieldset-calendar-day.past { background: #1a1a1a; color: #808080; }
        .fieldset-calendar-day.future { background: #222; }
        .fieldset-calendar-day.today { color: #ff0000; font-weight: bold; }
        .fieldset-calendar-day:not(.selected):not(.empty):hover { background: #333; }
        .fieldset-calendar-day:not(.selected):not(.empty):active { background: #2e3a72; color: #fff; }
        .fieldset-calendar-day.selected { background: #2e3a72; color: #fff; }
        .fieldset-calendar-day.selected.today { color: #ff0000; }
        .fieldset-calendar-today-marker {
            position: absolute;
            bottom: 0;
            width: 8px;
            height: 8px;
            background: #ff0000;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10;
        }
        
        /* Session rows (auto-generated from calendar) */
        .fieldset-sessions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .fieldset-session-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .fieldset-session-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .fieldset-session-date {
            flex: 1;
            height: 36px;
            padding: 0 10px;
            background: #333;
            border: 1px solid #333;
            border-radius: 4px;
            color: #fff;
            font-size: 13px;
            display: flex;
            align-items: center;
        }
        .fieldset-session-date-spacer {
            flex: 1;
            height: 36px;
        }
        .fieldset-session-time {
            flex: 0 0 100px;
        }
        .fieldset-session-add, .fieldset-session-remove,
        .fieldset-pricing-add, .fieldset-pricing-remove {
            width: 36px;
            min-width: 36px;
            max-width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: 1px solid #333;
            border-radius: 4px;
            color: #666;
            cursor: pointer;
            font-size: 18px;
            flex: 0 0 36px;
        }
        .fieldset-session-add:hover, .fieldset-pricing-add:hover { border-color: #3b82f5; color: #3b82f5; }
        .fieldset-session-remove:hover, .fieldset-pricing-remove:hover { border-color: #f87171; color: #f87171; }
        
        /* Compact currency button (100px, value only) */
        .fieldset-currency-compact { width: 100px; height: 36px; position: relative; flex-shrink: 0; }
        .fieldset-currency-compact .fieldset-menu-button { width: 100px; }
        .fieldset-currency-compact .fieldset-menu-button-text { padding-left: 6px; font-size: 12px; }
        .fieldset-currency-compact .fieldset-menu-options { width: 250px; left: 0; right: auto; border-top: 1px solid #3b82f5; border-radius: 4px; }
        
        /* Section divider */
        .fieldset-divider {
            width: 100%;
            height: 1px;
            background: #333;
            margin: 8px 0;
        }
        
        /* Sub-label for multi-field */
        .fieldset-sublabel {
            font-size: 11px;
            color: #666;
            margin-bottom: 6px;
        }
        
        /* Google Places Autocomplete styling */
        .pac-container {
            background: #222;
            border: 1px solid #3b82f5;
            border-top: none;
            border-radius: 0 0 4px 4px;
            font-family: sans-serif;
            font-size: 13px;
            z-index: 10000;
        }
        .pac-item {
            padding: 8px 10px;
            color: #fff;
            cursor: pointer;
            border-top: 1px solid #333;
        }
        .pac-item:first-child { border-top: none; }
        .pac-item:hover { background: #3b82f5; }
        .pac-item-query { color: #fff; font-weight: bold; }
        .pac-matched { color: #3b82f5; }
        .pac-item:hover .pac-matched { color: #fff; }
        .pac-icon { display: none; }
        .pac-item-selected { background: #3b82f5; }
        
        /* Location status indicator */
        .fieldset-location-status {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
        }
        .fieldset-location-status.success { color: #22c55e; }
        .fieldset-location-status.error { color: #ef4444; }
        
        /* Amenities checklist grid */
        .fieldset-amenities {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .fieldset-amenity-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 6px 0;
        }
        .fieldset-amenity-icon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }
        .fieldset-amenity-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: brightness(0) invert(1);
        }
        .fieldset-amenity-name {
            flex: 1;
            font-size: 13px;
            color: #fff;
        }
        .fieldset-amenity-options {
            display: flex;
            gap: 16px;
            flex-shrink: 0;
        }
        .fieldset-amenity-option {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            cursor: pointer;
            font-size: 12px;
            color: #ccc;
            min-width: 36px;
            min-height: 36px;
            padding: 0 8px;
            border-radius: 4px;
        }
        .fieldset-amenity-option input {
            cursor: pointer;
            accent-color: #3b82f5;
        }
        /* Row states based on selection */
        .fieldset-amenity-row.selected-yes .fieldset-amenity-icon img {
            filter: brightness(0) saturate(100%) invert(45%) sepia(95%) saturate(1000%) hue-rotate(200deg) brightness(100%);
        }
        .fieldset-amenity-row.selected-no .fieldset-amenity-icon img {
            filter: brightness(0) invert(0.4);
        }
        .fieldset-amenity-row.selected-no .fieldset-amenity-name {
            color: #666;
        }
    </style>
</head>
<body>

<!-- Front-end search test (for user map navigation) -->
<div class="fieldset-container" style="margin-bottom: 40px;">
    <div class="fieldset">
        <div class="fieldset-header">Front-End Search (User Navigation)</div>
        <div class="fieldset-sublabel">Search for any place - POI, address, city (for map flyTo)</div>
        <input type="text" id="frontend-search" class="fieldset-input" placeholder="Search any location...">
        <div id="frontend-status" class="fieldset-location-status"></div>
        <div id="frontend-result" style="margin-top: 10px; padding: 10px; background: #111; border-radius: 4px; font-size: 12px; color: #888; display: none;">
            <div><strong>Name:</strong> <span id="result-name">-</span></div>
            <div><strong>Address:</strong> <span id="result-address">-</span></div>
            <div><strong>Lat:</strong> <span id="result-lat">-</span></div>
            <div><strong>Lng:</strong> <span id="result-lng">-</span></div>
            <div><strong>Place ID:</strong> <span id="result-placeid">-</span></div>
        </div>
    </div>
</div>

<div class="fieldset-container" id="fieldset-container"></div>

<script>
(function(){
    var container = document.getElementById('fieldset-container');
    var picklist = {};
    
    // Close all menus when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.fieldset-menu')) {
            container.querySelectorAll('.fieldset-menu.open').forEach(function(el) {
                el.classList.remove('open');
            });
        }
    });
    
    // Initialize front-end search (all types - for user navigation)
    function initFrontendSearch() {
        var input = document.getElementById('frontend-search');
        var status = document.getElementById('frontend-status');
        var resultBox = document.getElementById('frontend-result');
        
        if (typeof google === 'undefined' || !google.maps || !google.maps.places) {
            status.textContent = 'Google Places API not loaded - add your API key';
            status.className = 'fieldset-location-status error';
            return;
        }
        
        // No type restriction - search everything
        var autocomplete = new google.maps.places.Autocomplete(input, {
            fields: ['formatted_address', 'geometry', 'name', 'place_id', 'types']
        });
        
        autocomplete.addListener('place_changed', function() {
            var place = autocomplete.getPlace();
            
            if (!place.geometry || !place.geometry.location) {
                status.textContent = 'No location data for this place';
                status.className = 'fieldset-location-status error';
                resultBox.style.display = 'none';
                return;
            }
            
            var lat = place.geometry.location.lat();
            var lng = place.geometry.location.lng();
            
            status.textContent = 'âœ“ Ready to flyTo: [' + lng.toFixed(6) + ', ' + lat.toFixed(6) + ']';
            status.className = 'fieldset-location-status success';
            
            // Show result details
            resultBox.style.display = 'block';
            document.getElementById('result-name').textContent = place.name || '-';
            document.getElementById('result-address').textContent = place.formatted_address || '-';
            document.getElementById('result-lat').textContent = lat;
            document.getElementById('result-lng').textContent = lng;
            document.getElementById('result-placeid').textContent = place.place_id || '-';
            
        });
        
        status.textContent = 'Google Places ready - start typing';
    }
    
    // Initialize on page load
    if (typeof google !== 'undefined' && google.maps) {
        initFrontendSearch();
    } else {
        window.addEventListener('load', function() {
            setTimeout(initFrontendSearch, 100);
        });
    }
    
    // Google Places Autocomplete helper
    // type: 'address' | 'establishment' | '(cities)'
    function initGooglePlaces(inputElement, type, latInput, lngInput, statusElement) {
        if (typeof google === 'undefined' || !google.maps || !google.maps.places) {
            console.warn('Google Places API not loaded');
            if (statusElement) {
                statusElement.textContent = 'Location search unavailable';
                statusElement.className = 'fieldset-location-status error';
            }
            return null;
        }
        
        var options = {
            fields: ['formatted_address', 'geometry', 'name', 'place_id']
        };
        
        // Set type restriction
        if (type === 'address') {
            options.types = ['address'];
        } else if (type === 'establishment') {
            options.types = ['establishment'];
        } else if (type === '(cities)') {
            options.types = ['(cities)'];
        }
        
        var autocomplete = new google.maps.places.Autocomplete(inputElement, options);
        
        autocomplete.addListener('place_changed', function() {
            var place = autocomplete.getPlace();
            
            if (!place.geometry || !place.geometry.location) {
                if (statusElement) {
                    statusElement.textContent = 'No location data for this place';
                    statusElement.className = 'fieldset-location-status error';
                }
                return;
            }
            
            var lat = place.geometry.location.lat();
            var lng = place.geometry.location.lng();
            
            if (latInput) latInput.value = lat;
            if (lngInput) lngInput.value = lng;
            
            if (statusElement) {
                statusElement.textContent = 'âœ“ Location set: ' + lat.toFixed(6) + ', ' + lng.toFixed(6);
                statusElement.className = 'fieldset-location-status success';
            }
        });
        
        return autocomplete;
    }
    
    // Build compact currency menu (100px, value only, default USD)
    function buildCurrencyMenuCompact() {
        var menu = document.createElement('div');
        menu.className = 'fieldset-menu fieldset-currency-compact';
        menu.innerHTML = '<div class="fieldset-menu-button"><img class="fieldset-menu-button-image" src="assets/flags/us.svg" alt=""><span class="fieldset-menu-button-text">USD</span><span class="fieldset-menu-button-arrow">â–¼</span></div><div class="fieldset-menu-options"></div>';
        
        var btn = menu.querySelector('.fieldset-menu-button');
        var opts = menu.querySelector('.fieldset-menu-options');
        var btnImg = menu.querySelector('.fieldset-menu-button-image');
        var btnText = menu.querySelector('.fieldset-menu-button-text');
        
        var currencies = picklist['currency'] || [];
        currencies.forEach(function(item) {
            var op = document.createElement('div');
            op.className = 'fieldset-menu-option';
            op.innerHTML = '<img class="fieldset-menu-option-image" src="assets/flags/' + item.value.substring(0,2) + '.svg" alt=""><span class="fieldset-menu-option-text">' + item.value.substring(3) + ' - ' + item.label + '</span>';
            op.onclick = function(e) {
                e.stopPropagation();
                btnImg.src = 'assets/flags/' + item.value.substring(0,2) + '.svg';
                btnText.textContent = item.value.substring(3); // Value only
                menu.classList.remove('open');
            };
            opts.appendChild(op);
        });
        
        btn.onclick = function(e) {
            e.stopPropagation();
            container.querySelectorAll('.fieldset-menu.open').forEach(function(el) {
                if (el !== menu) el.classList.remove('open');
            });
            menu.classList.toggle('open');
        };
        
        return menu;
    }
    
    // Build phone prefix menu (100px compact, same style as currency)
    function buildPhonePrefixMenu() {
        var menu = document.createElement('div');
        menu.className = 'fieldset-menu fieldset-currency-compact';
        menu.innerHTML = '<div class="fieldset-menu-button"><img class="fieldset-menu-button-image" src="" alt=""><span class="fieldset-menu-button-text">+...</span><span class="fieldset-menu-button-arrow">â–¼</span></div><div class="fieldset-menu-options"></div>';
        
        var btn = menu.querySelector('.fieldset-menu-button');
        var opts = menu.querySelector('.fieldset-menu-options');
        var btnImg = menu.querySelector('.fieldset-menu-button-image');
        var btnText = menu.querySelector('.fieldset-menu-button-text');
        
        var prefixes = picklist['phone-prefix'] || [];
        if (prefixes.length > 0) {
            btnImg.src = 'assets/flags/' + prefixes[0].value.substring(0,2) + '.svg';
            btnText.textContent = prefixes[0].value.substring(3);
        }
        
        prefixes.forEach(function(item) {
            var op = document.createElement('div');
            op.className = 'fieldset-menu-option';
            op.innerHTML = '<img class="fieldset-menu-option-image" src="assets/flags/' + item.value.substring(0,2) + '.svg" alt=""><span class="fieldset-menu-option-text">' + item.value.substring(3) + ' - ' + item.label + '</span>';
            op.onclick = function(e) {
                e.stopPropagation();
                btnImg.src = 'assets/flags/' + item.value.substring(0,2) + '.svg';
                btnText.textContent = item.value.substring(3);
                menu.classList.remove('open');
            };
            opts.appendChild(op);
        });
        
        btn.onclick = function(e) {
            e.stopPropagation();
            container.querySelectorAll('.fieldset-menu.open').forEach(function(el) {
                if (el !== menu) el.classList.remove('open');
            });
            menu.classList.toggle('open');
        };
        
        return menu;
    }
    
    // Build label with required asterisk and tooltip
    function buildLabel(name, tooltip) {
        var label = document.createElement('div');
        label.className = 'fieldset-label';
        label.innerHTML = '<span class="fieldset-label-text">' + name + '</span><span class="fieldset-label-required">*</span>';
        if (tooltip) {
            var tip = document.createElement('span');
            tip.className = 'fieldset-label-tooltip';
            tip.textContent = 'i';
            tip.setAttribute('data-tooltip', tooltip);
            label.appendChild(tip);
        }
        return label;
    }
    
    // Add validation with char limit and invalid state
    function addInputValidation(input, minLength, maxLength, validationFn) {
        var charCount = document.createElement('div');
        charCount.className = 'fieldset-char-count';
        charCount.style.display = 'none';
        
        var touched = false;
        
        function updateCharCount() {
            var remaining = maxLength - input.value.length;
            if (remaining <= 5 && input.value.length > 0) {
                charCount.style.display = 'block';
                charCount.textContent = remaining + ' characters remaining';
                if (remaining <= 0) {
                    charCount.className = 'fieldset-char-count fieldset-char-count--danger';
                } else {
                    charCount.className = 'fieldset-char-count fieldset-char-count--warning';
                }
            } else {
                charCount.style.display = 'none';
            }
        }
        
        function validate() {
            if (!touched) return;
            var isValid = true;
            var len = input.value.length;
            
            // Check min length (only if field has content)
            if (len > 0 && minLength > 0 && len < minLength) {
                isValid = false;
            }
            // Check max length
            if (len > maxLength) {
                isValid = false;
            }
            // Check custom validation
            if (len > 0 && validationFn && !validationFn(input.value)) {
                isValid = false;
            }
            
            if (!isValid) {
                input.classList.add('fieldset-input--invalid');
            } else {
                input.classList.remove('fieldset-input--invalid');
            }
        }
        
        input.setAttribute('maxlength', maxLength);
        
        input.addEventListener('input', function() {
            updateCharCount();
            if (touched) validate();
        });
        
        input.addEventListener('blur', function() {
            touched = true;
            validate();
        });
        
        input.addEventListener('focus', function() {
            updateCharCount();
        });
        
        return { charCount: charCount };
    }
    
    // Email validation regex
    function isValidEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }
    
    // URL validation (accepts with or without protocol)
    function isValidUrl(url) {
        return /^(https?:\/\/)?.+\..+/.test(url);
    }
    
    // Phone digits-only filter
    function makePhoneDigitsOnly(input) {
        input.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
    }
    
    // URL auto-prepend https://
    function autoUrlProtocol(input) {
        input.addEventListener('blur', function() {
            var val = this.value.trim();
            if (val && !val.match(/^https?:\/\//i)) {
                this.value = 'https://' + val;
            }
        });
    }
    
    // Fetch general options first, then fieldsets
    fetch('/gateway.php?action=get-admin-settings')
        .then(function(r) { return r.json(); })
        .then(function(res) {
            picklist = res.picklist || {};
            return fetch('/gateway.php?action=get-form');
        })
        .then(function(r) { return r.json(); })
        .then(function(res) {
            if (!res.success || !res.snapshot) return;
            
            var fieldsets = res.snapshot.fieldsets || [];
            
            fieldsets.forEach(function(fs, index) {
                var fieldset = document.createElement('div');
                fieldset.className = 'fieldset';
                
                var key = fs.fieldset_key || fs.key || '';
                var name = fs.fieldset_name || fs.name || 'Unnamed';
                var tooltip = fs.fieldset_tooltip || '';
                var placeholder = fs.fieldset_placeholder || '';
                var minLength = fs.min_length || 0;
                var maxLength = fs.max_length || 500;
                var options = fs.fieldset_options || [];
                var fields = fs.fieldset_fields || [];
                
                // Add divider between fieldsets (except first)
                if (index > 0) {
                    var divider = document.createElement('div');
                    divider.className = 'fieldset-divider';
                    container.appendChild(divider);
                }
                
                // Build based on fieldset type
                switch (key) {
                    case 'title':
                        fieldset.appendChild(buildLabel(name, tooltip));
                        var titleInput = document.createElement('input');
                        titleInput.type = 'text';
                        titleInput.className = 'fieldset-input';
                        titleInput.placeholder = placeholder;
                        var titleValidation = addInputValidation(titleInput, minLength, maxLength, null);
                        fieldset.appendChild(titleInput);
                        fieldset.appendChild(titleValidation.charCount);
                        break;
                    
                    case 'coupon':
                        fieldset.appendChild(buildLabel(name, tooltip));
                        var couponInput = document.createElement('input');
                        couponInput.type = 'text';
                        couponInput.className = 'fieldset-input';
                        couponInput.placeholder = placeholder;
                        var couponValidation = addInputValidation(couponInput, minLength, maxLength, null);
                        fieldset.appendChild(couponInput);
                        fieldset.appendChild(couponValidation.charCount);
                        break;
                        
                    case 'description':
                        fieldset.appendChild(buildLabel(name, tooltip));
                        var descTextarea = document.createElement('textarea');
                        descTextarea.className = 'fieldset-textarea';
                        descTextarea.placeholder = placeholder;
                        var descValidation = addInputValidation(descTextarea, minLength, maxLength, null);
                        fieldset.appendChild(descTextarea);
                        fieldset.appendChild(descValidation.charCount);
                        break;
                        
                    case 'text-box':
                        fieldset.appendChild(buildLabel(name + ' (editable)', tooltip));
                        var textBoxInput = document.createElement('input');
                        textBoxInput.type = 'text';
                        textBoxInput.className = 'fieldset-input';
                        textBoxInput.placeholder = placeholder;
                        var textBoxValidation = addInputValidation(textBoxInput, minLength, maxLength, null);
                        fieldset.appendChild(textBoxInput);
                        fieldset.appendChild(textBoxValidation.charCount);
                        break;
                        
                    case 'text-area':
                        fieldset.appendChild(buildLabel(name + ' (editable)', tooltip));
                        var editableTextarea = document.createElement('textarea');
                        editableTextarea.className = 'fieldset-textarea';
                        editableTextarea.placeholder = placeholder;
                        var textareaValidation = addInputValidation(editableTextarea, minLength, maxLength, null);
                        fieldset.appendChild(editableTextarea);
                        fieldset.appendChild(textareaValidation.charCount);
                        break;
                        
                    case 'dropdown':
                        fieldset.appendChild(buildLabel(name + ' (editable)', tooltip));
                        var select = document.createElement('select');
                        select.className = 'fieldset-select';
                        select.innerHTML = '<option value="">Select an option...</option>';
                        if (Array.isArray(options)) {
                            options.forEach(function(opt) {
                                var option = document.createElement('option');
                                option.value = opt;
                                option.textContent = opt;
                                select.appendChild(option);
                            });
                        }
                        fieldset.appendChild(select);
                        break;
                        
                    case 'radio':
                        fieldset.appendChild(buildLabel(name + ' (editable)', tooltip));
                        var radioGroup = document.createElement('div');
                        radioGroup.className = 'fieldset-radio-group';
                        if (Array.isArray(options)) {
                            options.forEach(function(opt, i) {
                                var radio = document.createElement('label');
                                radio.className = 'fieldset-radio';
                                radio.innerHTML = '<input type="radio" name="radio-' + index + '" class="fieldset-radio-input" value="' + opt + '"><span class="fieldset-radio-text">' + opt + '</span>';
                                radioGroup.appendChild(radio);
                            });
                        }
                        fieldset.appendChild(radioGroup);
                        break;
                        
                    case 'email':
                        fieldset.appendChild(buildLabel(name, tooltip));
                        var emailInput = document.createElement('input');
                        emailInput.type = 'email';
                        emailInput.className = 'fieldset-input';
                        emailInput.placeholder = placeholder;
                        var emailValidation = addInputValidation(emailInput, minLength, maxLength, isValidEmail);
                        fieldset.appendChild(emailInput);
                        fieldset.appendChild(emailValidation.charCount);
                        break;
                        
                    case 'phone':
                        fieldset.appendChild(buildLabel(name, tooltip));
                        var phoneRow = document.createElement('div');
                        phoneRow.className = 'fieldset-row';
                        phoneRow.appendChild(buildPhonePrefixMenu());
                        var phoneInput = document.createElement('input');
                        phoneInput.type = 'tel';
                        phoneInput.className = 'fieldset-input';
                        phoneInput.placeholder = placeholder;
                        makePhoneDigitsOnly(phoneInput);
                        var phoneValidation = addInputValidation(phoneInput, minLength, maxLength, null);
                        phoneRow.appendChild(phoneInput);
                        fieldset.appendChild(phoneRow);
                        fieldset.appendChild(phoneValidation.charCount);
                        break;
                        
                    case 'address':
                    case 'location': // legacy support
                        fieldset.appendChild(buildLabel(name, tooltip));
                        var addrInputEl = document.createElement('input');
                        addrInputEl.type = 'text';
                        addrInputEl.className = 'fieldset-input';
                        addrInputEl.placeholder = placeholder || 'Search for address...';
                        fieldset.appendChild(addrInputEl);
                        // Hidden lat/lng fields
                        var addrLatInput = document.createElement('input');
                        addrLatInput.type = 'hidden';
                        addrLatInput.className = 'fieldset-lat';
                        var addrLngInput = document.createElement('input');
                        addrLngInput.type = 'hidden';
                        addrLngInput.className = 'fieldset-lng';
                        fieldset.appendChild(addrLatInput);
                        fieldset.appendChild(addrLngInput);
                        // Status indicator
                        var addrStatus = document.createElement('div');
                        addrStatus.className = 'fieldset-location-status';
                        fieldset.appendChild(addrStatus);
                        // Init Google Places
                        initGooglePlaces(addrInputEl, 'address', addrLatInput, addrLngInput, addrStatus);
                        break;
                        
                    case 'city':
                        fieldset.appendChild(buildLabel(name, tooltip));
                        var cityInputEl = document.createElement('input');
                        cityInputEl.type = 'text';
                        cityInputEl.className = 'fieldset-input';
                        cityInputEl.placeholder = placeholder || 'Search for city or town...';
                        fieldset.appendChild(cityInputEl);
                        // Hidden lat/lng fields
                        var cityLatInput = document.createElement('input');
                        cityLatInput.type = 'hidden';
                        cityLatInput.className = 'fieldset-lat';
                        var cityLngInput = document.createElement('input');
                        cityLngInput.type = 'hidden';
                        cityLngInput.className = 'fieldset-lng';
                        fieldset.appendChild(cityLatInput);
                        fieldset.appendChild(cityLngInput);
                        // Status indicator
                        var cityStatus = document.createElement('div');
                        cityStatus.className = 'fieldset-location-status';
                        fieldset.appendChild(cityStatus);
                        // Init Google Places (cities only)
                        initGooglePlaces(cityInputEl, '(cities)', cityLatInput, cityLngInput, cityStatus);
                        break;
                        
                    case 'website-url':
                    case 'tickets-url':
                        fieldset.appendChild(buildLabel(name, tooltip));
                        var urlInput = document.createElement('input');
                        urlInput.type = 'text'; // text not url, we handle protocol
                        urlInput.className = 'fieldset-input';
                        urlInput.placeholder = placeholder;
                        autoUrlProtocol(urlInput);
                        var urlValidation = addInputValidation(urlInput, minLength, maxLength, isValidUrl);
                        fieldset.appendChild(urlInput);
                        fieldset.appendChild(urlValidation.charCount);
                        break;
                        
                    case 'images':
                        fieldset.appendChild(buildLabel(name, tooltip));
                        
                        var imagesContainer = document.createElement('div');
                        imagesContainer.className = 'fieldset-images-container';
                        imagesContainer.style.cssText = 'display: flex; flex-wrap: wrap; gap: 5px;';
                        
                        var imageFiles = [];
                        var maxImages = 10;
                        
                        function renderImages() {
                            imagesContainer.innerHTML = '';
                            
                            // Show existing images
                            imageFiles.forEach(function(file, idx) {
                                var thumb = document.createElement('div');
                                thumb.className = 'fieldset-image-thumb';
                                thumb.style.cssText = 'width: 76px; height: 76px; position: relative; border-radius: 4px; overflow: hidden; background: #222; border: 1px solid #333; flex-shrink: 0;';
                                
                                var img = document.createElement('img');
                                img.src = URL.createObjectURL(file);
                                img.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
                                thumb.appendChild(img);
                                
                                var removeBtn = document.createElement('button');
                                removeBtn.type = 'button';
                                removeBtn.textContent = 'Ã—';
                                removeBtn.style.cssText = 'position: absolute; top: 2px; right: 2px; width: 16px; height: 16px; background: rgba(0,0,0,0.7); border: none; border-radius: 50%; color: #fff; cursor: pointer; font-size: 12px; line-height: 1;';
                                (function(idx) {
                                    removeBtn.addEventListener('click', function() {
                                        imageFiles.splice(idx, 1);
                                        renderImages();
                                    });
                                })(idx);
                                thumb.appendChild(removeBtn);
                                
                                imagesContainer.appendChild(thumb);
                            });
                            
                            // Show upload button if under max
                            if (imageFiles.length < maxImages) {
                                var uploadBox = document.createElement('div');
                                uploadBox.className = 'fieldset-images';
                                uploadBox.innerHTML = '<div class="fieldset-images-icon">ðŸ“·</div><div class="fieldset-images-text">Add</div>';
                                uploadBox.addEventListener('click', function() {
                                    fileInput.click();
                                });
                                imagesContainer.appendChild(uploadBox);
                            }
                        }
                        
                        var fileInput = document.createElement('input');
                        fileInput.type = 'file';
                        fileInput.accept = 'image/*';
                        fileInput.multiple = true;
                        fileInput.style.display = 'none';
                        fileInput.addEventListener('change', function() {
                            var files = Array.from(this.files);
                            files.forEach(function(file) {
                                if (imageFiles.length < maxImages && file.type.startsWith('image/')) {
                                    imageFiles.push(file);
                                }
                            });
                            renderImages();
                            this.value = '';
                        });
                        fieldset.appendChild(fileInput);
                        fieldset.appendChild(imagesContainer);
                        
                        renderImages();
                        break;
                    
                    case 'amenities':
                        fieldset.appendChild(buildLabel(name, tooltip));
                        var amenitiesGrid = document.createElement('div');
                        amenitiesGrid.className = 'fieldset-amenities';
                        
                        // Get amenities from picklist table
                        var amenities = picklist['amenity'] || [];
                        
                        amenities.forEach(function(item, i) {
                            // Parse value: "parking Parking" -> icon: parking, name: Parking
                            var parts = item.value.split(' ');
                            var iconKey = parts[0];
                            var amenityName = parts.slice(1).join(' ');
                            var description = item.label;
                            
                            var row = document.createElement('div');
                            row.className = 'fieldset-amenity-row';
                            row.title = description; // Tooltip on hover
                            
                            // Icon
                            var iconEl = document.createElement('div');
                            iconEl.className = 'fieldset-amenity-icon';
                            iconEl.innerHTML = '<img src="assets/amenities/' + iconKey + '.svg" alt="' + amenityName + '">';
                            row.appendChild(iconEl);
                            
                            // Name
                            var nameEl = document.createElement('div');
                            nameEl.className = 'fieldset-amenity-name';
                            nameEl.textContent = amenityName;
                            row.appendChild(nameEl);
                            
                            // Yes/No options
                            var optionsEl = document.createElement('div');
                            optionsEl.className = 'fieldset-amenity-options';
                            
                            var yesLabel = document.createElement('label');
                            yesLabel.className = 'fieldset-amenity-option';
                            yesLabel.innerHTML = '<input type="radio" name="amenity-' + iconKey + '" value="1"> Yes';
                            optionsEl.appendChild(yesLabel);
                            
                            var noLabel = document.createElement('label');
                            noLabel.className = 'fieldset-amenity-option';
                            noLabel.innerHTML = '<input type="radio" name="amenity-' + iconKey + '" value="0"> No';
                            optionsEl.appendChild(noLabel);
                            
                            // Add change listeners to update row styling
                            var yesRadio = yesLabel.querySelector('input');
                            var noRadio = noLabel.querySelector('input');
                            
                            yesRadio.addEventListener('change', function() {
                                row.classList.remove('selected-no');
                                row.classList.add('selected-yes');
                            });
                            
                            noRadio.addEventListener('change', function() {
                                row.classList.remove('selected-yes');
                                row.classList.add('selected-no');
                            });
                            
                            row.appendChild(optionsEl);
                            amenitiesGrid.appendChild(row);
                        });
                        
                        fieldset.appendChild(amenitiesGrid);
                        break;
                        
                    case 'item-pricing':
                        // Item Name (full width), then variants with currency + price
                        fieldset.appendChild(buildLabel(name, tooltip));
                        
                        // Track shared currency state for item pricing
                        var itemCurrencyState = { flag: 'us', code: 'USD' };
                        var itemCurrencyMenus = [];
                        
                        function syncAllItemCurrencies() {
                            itemCurrencyMenus.forEach(function(menu) {
                                var img = menu.querySelector('.fieldset-menu-button-image');
                                var text = menu.querySelector('.fieldset-menu-button-text');
                                img.src = 'assets/flags/' + itemCurrencyState.flag + '.svg';
                                text.textContent = itemCurrencyState.code;
                            });
                        }
                        
                        function buildItemCurrencyMenu() {
                            var menu = document.createElement('div');
                            menu.className = 'fieldset-menu fieldset-currency-compact';
                            menu.innerHTML = '<div class="fieldset-menu-button"><img class="fieldset-menu-button-image" src="assets/flags/' + itemCurrencyState.flag + '.svg" alt=""><span class="fieldset-menu-button-text">' + itemCurrencyState.code + '</span><span class="fieldset-menu-button-arrow">â–¼</span></div><div class="fieldset-menu-options"></div>';
                            
                            var btn = menu.querySelector('.fieldset-menu-button');
                            var opts = menu.querySelector('.fieldset-menu-options');
                            
                            var currencies = picklist['currency'] || [];
                            currencies.forEach(function(item) {
                                var op = document.createElement('div');
                                op.className = 'fieldset-menu-option';
                                op.innerHTML = '<img class="fieldset-menu-option-image" src="assets/flags/' + item.value.substring(0,2) + '.svg" alt=""><span class="fieldset-menu-option-text">' + item.value.substring(3) + ' - ' + item.label + '</span>';
                                op.onclick = function(e) {
                                    e.stopPropagation();
                                    itemCurrencyState.flag = item.value.substring(0,2);
                                    itemCurrencyState.code = item.value.substring(3);
                                    syncAllItemCurrencies();
                                    menu.classList.remove('open');
                                };
                                opts.appendChild(op);
                            });
                            
                            btn.onclick = function(e) {
                                e.stopPropagation();
                                container.querySelectorAll('.fieldset-menu.open').forEach(function(el) {
                                    if (el !== menu) el.classList.remove('open');
                                });
                                menu.classList.toggle('open');
                            };
                            
                            itemCurrencyMenus.push(menu);
                            return menu;
                        }
                        
                        // Item Name (single, no +/-)
                        var itemNameSub = document.createElement('div');
                        itemNameSub.className = 'fieldset-sublabel';
                        itemNameSub.textContent = 'Item Name';
                        fieldset.appendChild(itemNameSub);
                        var itemNameInput = document.createElement('input');
                        itemNameInput.type = 'text';
                        itemNameInput.className = 'fieldset-input';
                        itemNameInput.placeholder = 'eg. T-Shirt';
                        itemNameInput.style.marginBottom = '10px';
                        fieldset.appendChild(itemNameInput);
                        
                        // Variants container
                        var itemVariantsContainer = document.createElement('div');
                        itemVariantsContainer.className = 'fieldset-variants-container';
                        fieldset.appendChild(itemVariantsContainer);
                        
                        function createItemVariantBlock() {
                            var block = document.createElement('div');
                            block.className = 'fieldset-variant-block';
                            block.style.marginBottom = '10px';
                            block.style.marginLeft = '20px';
                            
                            // Row 1: Variant input + +/- buttons
                            var variantRow = document.createElement('div');
                            variantRow.className = 'fieldset-row';
                            variantRow.style.marginBottom = '10px';
                            
                            var variantCol = document.createElement('div');
                            variantCol.style.flex = '1';
                            var variantSub = document.createElement('div');
                            variantSub.className = 'fieldset-sublabel';
                            variantSub.textContent = 'Item Variant';
                            var variantInput = document.createElement('input');
                            variantInput.type = 'text';
                            variantInput.className = 'fieldset-input';
                            variantInput.placeholder = 'eg. Large Red';
                            variantCol.appendChild(variantSub);
                            variantCol.appendChild(variantInput);
                            variantRow.appendChild(variantCol);
                            
                            // + button
                            var addBtn = document.createElement('button');
                            addBtn.type = 'button';
                            addBtn.className = 'fieldset-pricing-add';
                            addBtn.textContent = '+';
                            addBtn.addEventListener('click', function() {
                                itemVariantsContainer.appendChild(createItemVariantBlock());
                                updateItemVariantButtons();
                            });
                            variantRow.appendChild(addBtn);
                            
                            // - button
                            var removeBtn = document.createElement('button');
                            removeBtn.type = 'button';
                            removeBtn.className = 'fieldset-pricing-remove';
                            removeBtn.textContent = 'âˆ’';
                            removeBtn.addEventListener('click', function() {
                                block.remove();
                                // Remove from tracked menus
                                var blockMenu = block.querySelector('.fieldset-currency-compact');
                                var idx = itemCurrencyMenus.indexOf(blockMenu);
                                if (idx > -1) itemCurrencyMenus.splice(idx, 1);
                                updateItemVariantButtons();
                            });
                            variantRow.appendChild(removeBtn);
                            
                            block.appendChild(variantRow);
                            
                            // Row 2: Currency + Price (cropped to align under variant)
                            var priceRow = document.createElement('div');
                            priceRow.className = 'fieldset-row';
                            priceRow.style.marginRight = '92px'; // 10px gap + 36px + 10px + 36px
                            
                            var currencyCol = document.createElement('div');
                            currencyCol.style.flex = '0 0 100px';
                            var currencySub = document.createElement('div');
                            currencySub.className = 'fieldset-sublabel';
                            currencySub.textContent = 'Currency';
                            currencyCol.appendChild(currencySub);
                            currencyCol.appendChild(buildItemCurrencyMenu());
                            priceRow.appendChild(currencyCol);
                            
                            var priceCol = document.createElement('div');
                            priceCol.style.flex = '1';
                            var priceSub = document.createElement('div');
                            priceSub.className = 'fieldset-sublabel';
                            priceSub.textContent = 'Price';
                            var priceInput = document.createElement('input');
                            priceInput.type = 'number';
                            priceInput.className = 'fieldset-input';
                            priceInput.placeholder = '0.00';
                            priceInput.step = '0.01';
                            priceInput.addEventListener('blur', function() {
                                if (this.value !== '') {
                                    this.value = parseFloat(this.value).toFixed(2);
                                }
                            });
                            priceCol.appendChild(priceSub);
                            priceCol.appendChild(priceInput);
                            priceRow.appendChild(priceCol);
                            
                            block.appendChild(priceRow);
                            
                            return block;
                        }
                        
                        function updateItemVariantButtons() {
                            var blocks = itemVariantsContainer.querySelectorAll('.fieldset-variant-block');
                            var atMax = blocks.length >= 10;
                            blocks.forEach(function(block) {
                                var addBtn = block.querySelector('.fieldset-pricing-add');
                                var removeBtn = block.querySelector('.fieldset-pricing-remove');
                                if (atMax) {
                                    addBtn.style.opacity = '0.3';
                                    addBtn.style.cursor = 'not-allowed';
                                    addBtn.disabled = true;
                                } else {
                                    addBtn.style.opacity = '1';
                                    addBtn.style.cursor = 'pointer';
                                    addBtn.disabled = false;
                                }
                                if (blocks.length === 1) {
                                    removeBtn.style.opacity = '0.3';
                                    removeBtn.style.cursor = 'not-allowed';
                                    removeBtn.disabled = true;
                                } else {
                                    removeBtn.style.opacity = '1';
                                    removeBtn.style.cursor = 'pointer';
                                    removeBtn.disabled = false;
                                }
                            });
                        }
                        
                        // Create first variant block
                        itemVariantsContainer.appendChild(createItemVariantBlock());
                        updateItemVariantButtons();
                        break;
                        
                    case 'ticket-pricing':
                        // Seating Areas container with nested Pricing Tiers
                        fieldset.appendChild(buildLabel(name, tooltip));
                        
                        var seatingAreasContainer = document.createElement('div');
                        seatingAreasContainer.className = 'fieldset-seating-areas-container';
                        fieldset.appendChild(seatingAreasContainer);
                        
                        // Track shared currency state
                        var ticketCurrencyState = { flag: 'us', code: 'USD' };
                        var ticketCurrencyMenus = [];
                        
                        function syncAllTicketCurrencies() {
                            ticketCurrencyMenus.forEach(function(menu) {
                                var img = menu.querySelector('.fieldset-menu-button-image');
                                var text = menu.querySelector('.fieldset-menu-button-text');
                                img.src = 'assets/flags/' + ticketCurrencyState.flag + '.svg';
                                text.textContent = ticketCurrencyState.code;
                            });
                        }
                        
                        function buildTicketCurrencyMenu() {
                            var menu = document.createElement('div');
                            menu.className = 'fieldset-menu fieldset-currency-compact';
                            menu.innerHTML = '<div class="fieldset-menu-button"><img class="fieldset-menu-button-image" src="assets/flags/' + ticketCurrencyState.flag + '.svg" alt=""><span class="fieldset-menu-button-text">' + ticketCurrencyState.code + '</span><span class="fieldset-menu-button-arrow">â–¼</span></div><div class="fieldset-menu-options"></div>';
                            
                            var btn = menu.querySelector('.fieldset-menu-button');
                            var opts = menu.querySelector('.fieldset-menu-options');
                            
                            var currencies = picklist['currency'] || [];
                            currencies.forEach(function(item) {
                                var op = document.createElement('div');
                                op.className = 'fieldset-menu-option';
                                op.innerHTML = '<img class="fieldset-menu-option-image" src="assets/flags/' + item.value.substring(0,2) + '.svg" alt=""><span class="fieldset-menu-option-text">' + item.value.substring(3) + ' - ' + item.label + '</span>';
                                op.onclick = function(e) {
                                    e.stopPropagation();
                                    ticketCurrencyState.flag = item.value.substring(0,2);
                                    ticketCurrencyState.code = item.value.substring(3);
                                    syncAllTicketCurrencies();
                                    menu.classList.remove('open');
                                };
                                opts.appendChild(op);
                            });
                            
                            btn.onclick = function(e) {
                                e.stopPropagation();
                                container.querySelectorAll('.fieldset-menu.open').forEach(function(el) {
                                    if (el !== menu) el.classList.remove('open');
                                });
                                menu.classList.toggle('open');
                            };
                            
                            ticketCurrencyMenus.push(menu);
                            return menu;
                        }
                        
                        function createPricingTierBlock(tiersContainer) {
                            var block = document.createElement('div');
                            block.className = 'fieldset-tier-block';
                            block.style.marginBottom = '10px';
                            block.style.marginLeft = '20px';
                            
                            // Row 1: Tier name + +/- buttons
                            var tierRow = document.createElement('div');
                            tierRow.className = 'fieldset-row';
                            tierRow.style.marginBottom = '10px';
                            
                            var tierCol = document.createElement('div');
                            tierCol.style.flex = '1';
                            var tierSub = document.createElement('div');
                            tierSub.className = 'fieldset-sublabel';
                            tierSub.textContent = 'Pricing Tier';
                            var tierInput = document.createElement('input');
                            tierInput.type = 'text';
                            tierInput.className = 'fieldset-input';
                            tierInput.placeholder = 'eg. Adult';
                            tierCol.appendChild(tierSub);
                            tierCol.appendChild(tierInput);
                            tierRow.appendChild(tierCol);
                            
                            // + button
                            var addBtn = document.createElement('button');
                            addBtn.type = 'button';
                            addBtn.className = 'fieldset-pricing-add';
                            addBtn.textContent = '+';
                            addBtn.addEventListener('click', function() {
                                tiersContainer.appendChild(createPricingTierBlock(tiersContainer));
                                updateTierButtons(tiersContainer);
                            });
                            tierRow.appendChild(addBtn);
                            
                            // - button
                            var removeBtn = document.createElement('button');
                            removeBtn.type = 'button';
                            removeBtn.className = 'fieldset-pricing-remove';
                            removeBtn.textContent = 'âˆ’';
                            removeBtn.addEventListener('click', function() {
                                block.remove();
                                // Remove from tracked menus
                                var blockMenu = block.querySelector('.fieldset-currency-compact');
                                var idx = ticketCurrencyMenus.indexOf(blockMenu);
                                if (idx > -1) ticketCurrencyMenus.splice(idx, 1);
                                updateTierButtons(tiersContainer);
                            });
                            tierRow.appendChild(removeBtn);
                            
                            block.appendChild(tierRow);
                            
                            // Row 2: Currency + Price (cropped to align under tier)
                            var priceRow = document.createElement('div');
                            priceRow.className = 'fieldset-row';
                            priceRow.style.marginRight = '92px'; // 10px gap + 36px + 10px + 36px
                            
                            var currencyCol = document.createElement('div');
                            currencyCol.style.flex = '0 0 100px';
                            var currencySub = document.createElement('div');
                            currencySub.className = 'fieldset-sublabel';
                            currencySub.textContent = 'Currency';
                            currencyCol.appendChild(currencySub);
                            currencyCol.appendChild(buildTicketCurrencyMenu());
                            priceRow.appendChild(currencyCol);
                            
                            var priceCol = document.createElement('div');
                            priceCol.style.flex = '1';
                            var priceSub = document.createElement('div');
                            priceSub.className = 'fieldset-sublabel';
                            priceSub.textContent = 'Price';
                            var priceInput = document.createElement('input');
                            priceInput.type = 'number';
                            priceInput.className = 'fieldset-input';
                            priceInput.placeholder = '0.00';
                            priceInput.step = '0.01';
                            priceInput.addEventListener('blur', function() {
                                if (this.value !== '') {
                                    this.value = parseFloat(this.value).toFixed(2);
                                }
                            });
                            priceCol.appendChild(priceSub);
                            priceCol.appendChild(priceInput);
                            priceRow.appendChild(priceCol);
                            
                            block.appendChild(priceRow);
                            
                            return block;
                        }
                        
                        function updateTierButtons(tiersContainer) {
                            var blocks = tiersContainer.querySelectorAll('.fieldset-tier-block');
                            var atMax = blocks.length >= 10;
                            blocks.forEach(function(block) {
                                var addBtn = block.querySelector('.fieldset-pricing-add');
                                var removeBtn = block.querySelector('.fieldset-pricing-remove');
                                // + button: grey out at cap
                                if (atMax) {
                                    addBtn.style.opacity = '0.3';
                                    addBtn.style.cursor = 'not-allowed';
                                    addBtn.disabled = true;
                                } else {
                                    addBtn.style.opacity = '1';
                                    addBtn.style.cursor = 'pointer';
                                    addBtn.disabled = false;
                                }
                                // - button: grey out when only 1
                                if (blocks.length === 1) {
                                    removeBtn.style.opacity = '0.3';
                                    removeBtn.style.cursor = 'not-allowed';
                                    removeBtn.disabled = true;
                                } else {
                                    removeBtn.style.opacity = '1';
                                    removeBtn.style.cursor = 'pointer';
                                    removeBtn.disabled = false;
                                }
                            });
                        }
                        
                        function createSeatingAreaBlock() {
                            var block = document.createElement('div');
                            block.className = 'fieldset-seating-block';
                            block.style.marginBottom = '20px';
                            block.style.paddingBottom = '10px';
                            block.style.borderBottom = '1px solid #333';
                            
                            // Seating Area row
                            var seatRow = document.createElement('div');
                            seatRow.className = 'fieldset-row';
                            seatRow.style.marginBottom = '10px';
                            
                            var seatCol = document.createElement('div');
                            seatCol.style.flex = '1';
                            var seatSub = document.createElement('div');
                            seatSub.className = 'fieldset-sublabel';
                            seatSub.textContent = 'Seating Area';
                            var seatInput = document.createElement('input');
                            seatInput.type = 'text';
                            seatInput.className = 'fieldset-input';
                            seatInput.placeholder = 'eg. Orchestra';
                            seatCol.appendChild(seatSub);
                            seatCol.appendChild(seatInput);
                            seatRow.appendChild(seatCol);
                            
                            // + button for seating area
                            var addBtn = document.createElement('button');
                            addBtn.type = 'button';
                            addBtn.className = 'fieldset-pricing-add';
                            addBtn.textContent = '+';
                            addBtn.addEventListener('click', function() {
                                seatingAreasContainer.appendChild(createSeatingAreaBlock());
                                updateSeatingAreaButtons();
                            });
                            seatRow.appendChild(addBtn);
                            
                            // - button for seating area
                            var removeBtn = document.createElement('button');
                            removeBtn.type = 'button';
                            removeBtn.className = 'fieldset-pricing-remove';
                            removeBtn.textContent = 'âˆ’';
                            removeBtn.addEventListener('click', function() {
                                block.remove();
                                updateSeatingAreaButtons();
                            });
                            seatRow.appendChild(removeBtn);
                            
                            block.appendChild(seatRow);
                            
                            // Pricing tiers container for this seating area
                            var tiersContainer = document.createElement('div');
                            tiersContainer.className = 'fieldset-tiers-container';
                            tiersContainer.appendChild(createPricingTierBlock(tiersContainer));
                            updateTierButtons(tiersContainer);
                            block.appendChild(tiersContainer);
                            
                            return block;
                        }
                        
                        function updateSeatingAreaButtons() {
                            var blocks = seatingAreasContainer.querySelectorAll('.fieldset-seating-block');
                            var atMax = blocks.length >= 10;
                            blocks.forEach(function(block) {
                                var addBtn = block.querySelector('.fieldset-row > .fieldset-pricing-add');
                                var removeBtn = block.querySelector('.fieldset-row > .fieldset-pricing-remove');
                                // + button: grey out at cap
                                if (atMax) {
                                    addBtn.style.opacity = '0.3';
                                    addBtn.style.cursor = 'not-allowed';
                                    addBtn.disabled = true;
                                } else {
                                    addBtn.style.opacity = '1';
                                    addBtn.style.cursor = 'pointer';
                                    addBtn.disabled = false;
                                }
                                // - button: grey out when only 1
                                if (blocks.length === 1) {
                                    removeBtn.style.opacity = '0.3';
                                    removeBtn.style.cursor = 'not-allowed';
                                    removeBtn.disabled = true;
                                } else {
                                    removeBtn.style.opacity = '1';
                                    removeBtn.style.cursor = 'pointer';
                                    removeBtn.disabled = false;
                                }
                            });
                        }
                        
                        // Create first seating area
                        seatingAreasContainer.appendChild(createSeatingAreaBlock());
                        updateSeatingAreaButtons();
                        break;
                        
                    case 'sessions':
                        // Horizontal scrolling calendar + auto-generated session rows with autofill
                        fieldset.appendChild(buildLabel(name, tooltip));
                        
                        // Track selected dates: { '2025-01-15': { times: ['19:00', ''], edited: [true, false] }, ... }
                        var sessionData = {};
                        
                        var today = new Date();
                        today.setHours(0, 0, 0, 0);
                        var todayIso = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
                        
                        var minDate = new Date(today.getFullYear(), today.getMonth(), 1);
                        var maxDate = new Date(today.getFullYear(), today.getMonth() + 24, 1);
                        
                        var todayMonthEl = null;
                        var todayMonthIndex = 0;
                        var totalMonths = 0;
                        var weekdayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                        
                        function toISODate(d) {
                            return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
                        }
                        
                        function getDayOfWeek(dateStr) {
                            var d = new Date(dateStr + 'T00:00:00');
                            return d.getDay();
                        }
                        
                        // Calendar container
                        var calContainer = document.createElement('div');
                        calContainer.className = 'fieldset-calendar-container';
                        
                        var calScroll = document.createElement('div');
                        calScroll.className = 'fieldset-calendar-scroll';
                        
                        var calendar = document.createElement('div');
                        calendar.className = 'fieldset-calendar';
                        
                        // Build months
                        var current = new Date(minDate.getFullYear(), minDate.getMonth(), 1);
                        var monthIdx = 0;
                        while (current <= maxDate) {
                            var monthEl = document.createElement('div');
                            monthEl.className = 'fieldset-calendar-month';
                            
                            var header = document.createElement('div');
                            header.className = 'fieldset-calendar-header';
                            header.textContent = current.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
                            monthEl.appendChild(header);
                            
                            var grid = document.createElement('div');
                            grid.className = 'fieldset-calendar-grid';
                            
                            weekdayNames.forEach(function(wd) {
                                var w = document.createElement('div');
                                w.className = 'fieldset-calendar-weekday';
                                w.textContent = wd;
                                grid.appendChild(w);
                            });
                            
                            var firstDay = new Date(current.getFullYear(), current.getMonth(), 1);
                            var startDow = firstDay.getDay();
                            var daysInMonth = new Date(current.getFullYear(), current.getMonth() + 1, 0).getDate();
                            
                            for (var i = 0; i < 42; i++) {
                                var cell = document.createElement('div');
                                cell.className = 'fieldset-calendar-day';
                                var dayNum = i - startDow + 1;
                                
                                if (i < startDow || dayNum > daysInMonth) {
                                    cell.classList.add('empty');
                                } else {
                                    cell.textContent = dayNum;
                                    var dateObj = new Date(current.getFullYear(), current.getMonth(), dayNum);
                                    dateObj.setHours(0, 0, 0, 0);
                                    var iso = toISODate(dateObj);
                                    cell.dataset.iso = iso;
                                    
                                    if (dateObj < today) {
                                        cell.classList.add('past');
                                    } else {
                                        cell.classList.add('future');
                                    }
                                    
                                    if (iso === todayIso) {
                                        cell.classList.add('today');
                                        todayMonthEl = monthEl;
                                        todayMonthIndex = monthIdx;
                                    }
                                }
                                grid.appendChild(cell);
                            }
                            
                            monthEl.appendChild(grid);
                            calendar.appendChild(monthEl);
                            current.setMonth(current.getMonth() + 1);
                            monthIdx++;
                        }
                        totalMonths = monthIdx;
                        
                        calScroll.appendChild(calendar);
                        calContainer.appendChild(calScroll);
                        
                        // Today marker
                        var marker = document.createElement('div');
                        marker.className = 'fieldset-calendar-today-marker';
                        calContainer.appendChild(marker);
                        
                        fieldset.appendChild(calContainer);
                        
                        // Sessions container (below calendar)
                        var sessionsContainer = document.createElement('div');
                        sessionsContainer.className = 'fieldset-sessions';
                        fieldset.appendChild(sessionsContainer);
                        
                        // Position marker dynamically based on today's month index
                        setTimeout(function() {
                            if (todayMonthEl) {
                                calScroll.scrollLeft = todayMonthEl.offsetLeft;
                            }
                            var markerFraction = (todayMonthIndex + 0.5) / totalMonths;
                            var markerPos = markerFraction * (calContainer.clientWidth - 8);
                            marker.style.left = markerPos + 'px';
                        }, 0);
                        
                        // Marker click - scroll to today
                        marker.addEventListener('click', function() {
                            if (todayMonthEl) {
                                calScroll.scrollTo({ left: todayMonthEl.offsetLeft, behavior: 'smooth' });
                            }
                        });
                        
                        // Horizontal wheel scroll (reduced sensitivity)
                        calScroll.addEventListener('wheel', function(e) {
                            e.preventDefault();
                            calScroll.scrollLeft += (e.deltaY || e.deltaX) * 0.3;
                        });
                        
                        // Track which slot indices have had their "god" time set
                        // GOD = first edit fills ALL dates
                        // DEMIGOD = subsequent edits fill same weekday only
                        var godSetForSlot = {};
                        
                        function autofillTimes(changedDateStr, changedSlotIdx, newTime) {
                            var sortedDates = Object.keys(sessionData).sort();
                            var changedDow = getDayOfWeek(changedDateStr);
                            
                            if (!godSetForSlot[changedSlotIdx]) {
                                // GOD MODE: first edit at this slot - fill ALL unedited slots
                                godSetForSlot[changedSlotIdx] = true;
                                
                                for (var i = 0; i < sortedDates.length; i++) {
                                    var dateStr = sortedDates[i];
                                    if (dateStr === changedDateStr) continue;
                                    var data = sessionData[dateStr];
                                    if (data.times.length > changedSlotIdx && !data.edited[changedSlotIdx]) {
                                        data.times[changedSlotIdx] = newTime;
                                    }
                                }
                            } else {
                                // DEMIGOD MODE: fill only same weekday unedited slots
                                for (var i = 0; i < sortedDates.length; i++) {
                                    var dateStr = sortedDates[i];
                                    if (dateStr === changedDateStr) continue;
                                    if (getDayOfWeek(dateStr) !== changedDow) continue;
                                    var data = sessionData[dateStr];
                                    if (data.times.length > changedSlotIdx && !data.edited[changedSlotIdx]) {
                                        data.times[changedSlotIdx] = newTime;
                                    }
                                }
                            }
                        }
                        
                        // Get autofill value for a new time slot (worship the demigod - same weekday first)
                        function getAutofillForSlot(dateStr, slotIdx) {
                            var dow = getDayOfWeek(dateStr);
                            var sortedDates = Object.keys(sessionData).sort();
                            
                            // Priority 1: Same weekday with a value at this slot (worship the demigod)
                            for (var i = 0; i < sortedDates.length; i++) {
                                var d = sortedDates[i];
                                if (d === dateStr) continue;
                                if (getDayOfWeek(d) === dow && sessionData[d].times.length > slotIdx && sessionData[d].times[slotIdx]) {
                                    return sessionData[d].times[slotIdx];
                                }
                            }
                            
                            // Priority 2: Any date with a value at this slot (worship the god if no demigod)
                            for (var i = 0; i < sortedDates.length; i++) {
                                var d = sortedDates[i];
                                if (d === dateStr) continue;
                                if (sessionData[d].times.length > slotIdx && sessionData[d].times[slotIdx]) {
                                    return sessionData[d].times[slotIdx];
                                }
                            }
                            
                            return '';
                        }
                        
                        // Render session rows
                        function renderSessions() {
                            sessionsContainer.innerHTML = '';
                            
                            var sortedDates = Object.keys(sessionData).sort();
                            
                            sortedDates.forEach(function(dateStr) {
                                var data = sessionData[dateStr];
                                var group = document.createElement('div');
                                group.className = 'fieldset-session-group';
                                
                                data.times.forEach(function(timeVal, idx) {
                                    var row = document.createElement('div');
                                    row.className = 'fieldset-session-row';
                                    
                                    if (idx === 0) {
                                        var dateDisplay = document.createElement('div');
                                        dateDisplay.className = 'fieldset-session-date';
                                        var d = new Date(dateStr + 'T00:00:00');
                                        dateDisplay.textContent = d.toLocaleDateString('en-AU', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
                                        row.appendChild(dateDisplay);
                                    } else {
                                        var spacer = document.createElement('div');
                                        spacer.className = 'fieldset-session-date-spacer';
                                        row.appendChild(spacer);
                                    }
                                    
                                    var timeWrapper = document.createElement('div');
                                    timeWrapper.className = 'fieldset-session-time';
                                    var timeInput = document.createElement('input');
                                    timeInput.type = 'text';
                                    timeInput.className = 'fieldset-time';
                                    timeInput.placeholder = 'HH:MM';
                                    timeInput.maxLength = 5;
                                    timeInput.value = timeVal;
                                    timeInput.dataset.date = dateStr;
                                    timeInput.dataset.idx = idx;
                                    
                                    // Select all on focus for easy overwrite
                                    timeInput.addEventListener('focus', function() {
                                        var input = this;
                                        setTimeout(function() { input.select(); }, 0);
                                    });
                                    
                                    // Auto-format time input (add colon after 2 digits)
                                    timeInput.addEventListener('input', function() {
                                        var v = this.value.replace(/[^0-9]/g, '');
                                        if (v.length >= 2) {
                                            v = v.substring(0, 2) + ':' + v.substring(2, 4);
                                        }
                                        this.value = v;
                                    });
                                    
                                    (function(dateStr, idx) {
                                        timeInput.addEventListener('blur', function() {
                                            var raw = this.value.replace(/[^0-9]/g, ''); // digits only
                                            if (raw === '') {
                                                sessionData[dateStr].times[idx] = '';
                                                return;
                                            }
                                            
                                            var hh, mm;
                                            if (raw.length === 1) {
                                                // "9" â†’ "09:00"
                                                hh = '0' + raw;
                                                mm = '00';
                                            } else if (raw.length === 2) {
                                                // "19" â†’ "19:00"
                                                hh = raw;
                                                mm = '00';
                                            } else if (raw.length === 3) {
                                                // "193" â†’ "19:30"
                                                hh = raw.substring(0, 2);
                                                mm = raw.substring(2) + '0';
                                            } else {
                                                // "1930" â†’ "19:30"
                                                hh = raw.substring(0, 2);
                                                mm = raw.substring(2, 4);
                                            }
                                            
                                            var newTime = hh + ':' + mm;
                                            
                                            // Validate hours 00-23 and minutes 00-59
                                            var hours = parseInt(hh, 10);
                                            var mins = parseInt(mm, 10);
                                            if (hours <= 23 && mins <= 59) {
                                                this.value = newTime;
                                                sessionData[dateStr].times[idx] = newTime;
                                                sessionData[dateStr].edited[idx] = true;
                                                autofillTimes(dateStr, idx, newTime);
                                                // Update other visible time inputs without full re-render
                                                sessionsContainer.querySelectorAll('.fieldset-time').forEach(function(input) {
                                                    var d = input.dataset.date;
                                                    var i = parseInt(input.dataset.idx, 10);
                                                    if (d && sessionData[d] && sessionData[d].times[i] !== undefined) {
                                                        input.value = sessionData[d].times[i];
                                                    }
                                                });
                                            } else {
                                                // Invalid time - reset input
                                                this.value = '';
                                                sessionData[dateStr].times[idx] = '';
                                            }
                                        });
                                    })(dateStr, idx);
                                    
                                    timeWrapper.appendChild(timeInput);
                                    row.appendChild(timeWrapper);
                                    
                                    // + button (always visible, greyed out at max 10)
                                    var maxTimesPerDate = 10;
                                    var addBtn = document.createElement('button');
                                    addBtn.type = 'button';
                                    addBtn.className = 'fieldset-session-add';
                                    addBtn.textContent = '+';
                                    if (data.times.length >= maxTimesPerDate) {
                                        addBtn.disabled = true;
                                        addBtn.style.opacity = '0.3';
                                        addBtn.style.cursor = 'not-allowed';
                                    } else {
                                        (function(dateStr, idx) {
                                            addBtn.addEventListener('click', function() {
                                                var newSlotIdx = idx + 1;
                                                var autofillVal = getAutofillForSlot(dateStr, newSlotIdx);
                                                sessionData[dateStr].times.splice(newSlotIdx, 0, autofillVal);
                                                sessionData[dateStr].edited.splice(newSlotIdx, 0, false);
                                                renderSessions();
                                            });
                                        })(dateStr, idx);
                                    }
                                    row.appendChild(addBtn);
                                    
                                    // - button (always visible, greyed out if only 1 time)
                                    var removeBtn = document.createElement('button');
                                    removeBtn.type = 'button';
                                    removeBtn.className = 'fieldset-session-remove';
                                    removeBtn.textContent = 'âˆ’';
                                    if (data.times.length === 1) {
                                        removeBtn.disabled = true;
                                        removeBtn.style.opacity = '0.3';
                                        removeBtn.style.cursor = 'not-allowed';
                                    } else {
                                        (function(dateStr, idx) {
                                            removeBtn.addEventListener('click', function() {
                                                sessionData[dateStr].times.splice(idx, 1);
                                                sessionData[dateStr].edited.splice(idx, 1);
                                                renderSessions();
                                            });
                                        })(dateStr, idx);
                                    }
                                    row.appendChild(removeBtn);
                                    
                                    group.appendChild(row);
                                });
                                
                                sessionsContainer.appendChild(group);
                            });
                        }
                        
                        // Calendar day click
                        calendar.addEventListener('click', function(e) {
                            var day = e.target;
                            if (day.classList.contains('fieldset-calendar-day') && !day.classList.contains('empty')) {
                                var iso = day.dataset.iso;
                                if (sessionData[iso]) {
                                    delete sessionData[iso];
                                    day.classList.remove('selected');
                                } else {
                                    // New date - autofill first time slot
                                    var autofillVal = getAutofillForSlot(iso, 0);
                                    sessionData[iso] = { times: [autofillVal], edited: [false] };
                                    day.classList.add('selected');
                                }
                                renderSessions();
                            }
                        });
                        
                        break;
                        
                    case 'venue':
                        // SMART VENUE FIELDSET
                        // - Both inputs have Google Places (unrestricted)
                        // - Auto-fill ONLY empty boxes
                        // - User edits are protected
                        fieldset.appendChild(buildLabel(name, tooltip));
                        
                        // Hidden lat/lng fields
                        var smartLatInput = document.createElement('input');
                        smartLatInput.type = 'hidden';
                        smartLatInput.className = 'fieldset-lat';
                        var smartLngInput = document.createElement('input');
                        smartLngInput.type = 'hidden';
                        smartLngInput.className = 'fieldset-lng';
                        
                        // Venue name row
                        var smartVenueSub = document.createElement('div');
                        smartVenueSub.className = 'fieldset-sublabel';
                        smartVenueSub.textContent = 'Venue Name';
                        fieldset.appendChild(smartVenueSub);
                        var smartVenueInput = document.createElement('input');
                        smartVenueInput.type = 'text';
                        smartVenueInput.className = 'fieldset-input';
                        smartVenueInput.placeholder = 'Search or type venue name...';
                        smartVenueInput.style.marginBottom = '8px';
                        fieldset.appendChild(smartVenueInput);
                        
                        // Address row
                        var smartAddrSub = document.createElement('div');
                        smartAddrSub.className = 'fieldset-sublabel';
                        smartAddrSub.textContent = 'Address';
                        fieldset.appendChild(smartAddrSub);
                        var smartAddrInput = document.createElement('input');
                        smartAddrInput.type = 'text';
                        smartAddrInput.className = 'fieldset-input';
                        smartAddrInput.placeholder = 'Search or type address...';
                        smartAddrInput.style.marginBottom = '4px';
                        fieldset.appendChild(smartAddrInput);
                        
                        // Status indicator
                        var smartStatus = document.createElement('div');
                        smartStatus.className = 'fieldset-location-status';
                        fieldset.appendChild(smartStatus);
                        
                        fieldset.appendChild(smartLatInput);
                        fieldset.appendChild(smartLngInput);
                        
                        // Smart autofill function - only fills empty boxes
                        function initSmartVenueAutocomplete(inputEl, otherInputEl, isVenueBox) {
                            if (typeof google === 'undefined' || !google.maps || !google.maps.places) {
                                console.warn('Google Places API not loaded');
                                return;
                            }
                            
                            // Unrestricted search - finds both venues and addresses
                            var autocomplete = new google.maps.places.Autocomplete(inputEl, {
                                fields: ['formatted_address', 'geometry', 'name', 'place_id', 'types']
                            });
                            
                            autocomplete.addListener('place_changed', function() {
                                var place = autocomplete.getPlace();
                                if (!place.geometry || !place.geometry.location) return;
                                
                                var lat = place.geometry.location.lat();
                                var lng = place.geometry.location.lng();
                                var venueName = place.name || '';
                                var address = place.formatted_address || '';
                                var isEstablishment = place.types && place.types.includes('establishment');
                                
                                // Always update lat/lng
                                smartLatInput.value = lat;
                                smartLngInput.value = lng;
                                
                                if (isVenueBox) {
                                    // User searched in venue box
                                    // Strip venue name to just the name (Google fills with full address)
                                    if (isEstablishment && venueName) {
                                        smartVenueInput.value = venueName;
                                    }
                                    // Address: fill only if empty
                                    if (!smartAddrInput.value.trim()) {
                                        smartAddrInput.value = address;
                                    }
                                } else {
                                    // User searched in address box
                                    // Address: strip to just address (in case Google added extra)
                                    smartAddrInput.value = address;
                                    // Venue name: fill only if empty AND result is an establishment
                                    if (!smartVenueInput.value.trim() && isEstablishment && venueName) {
                                        smartVenueInput.value = venueName;
                                    }
                                }
                                
                                // Update status
                                smartStatus.textContent = 'âœ“ Location set: ' + lat.toFixed(6) + ', ' + lng.toFixed(6);
                                smartStatus.className = 'fieldset-location-status success';
                            });
                        }
                        
                        // Init both inputs with smart autofill
                        initSmartVenueAutocomplete(smartVenueInput, smartAddrInput, true);
                        initSmartVenueAutocomplete(smartAddrInput, smartVenueInput, false);
                        break;
                        
                    default:
                        // Generic text input fallback
                        fieldset.appendChild(buildLabel(name, tooltip));
                        var input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'fieldset-input';
                        input.placeholder = placeholder;
                        fieldset.appendChild(input);
                }
                
                container.appendChild(fieldset);
            });
        });
})();
</script>

</body>
</html>
