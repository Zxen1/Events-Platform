# Handover — 12 February 2026

## Completed This Session

### 1. Switch Consolidation
- Deleted 5 duplicate switch components (medium, massive, big, bigorange, small) from `components.css`
- Created single `component-switch` (36x20) with semantic states: `--on-default` (blue), `--on-filter` (orange), `--on-danger` (red), `--disabled`
- Updated `SwitchComponent.create()` in `components.js` — removed `size` param, added `state` param
- Renamed all references in `index.php`, `filter.js`, `admin.js`
- Converted 4 custom switches to use `component-switch`:
  - `admin-checkout-accordion-body-more-switch` (admin.css + admin.js) — Hide Tier
  - `formbuilder-accordion-editpanel-more-switch` (formbuilder.css + formbuilder.js) — Hide Category/Subcategory
  - `formbuilder-field-switch` (formbuilder.css) — dead CSS, deleted
  - `member-profile-more-switch` (member.css + member.js + index.php) — Hide Account

### 2. Hide Toggle (My Posts)
- Removed confirmation dialog — hide/show is now instant (matches formbuilder pattern)
- Uses `component-switch` with `--on-default` (blue)
- Disabled for expired posts (`component-switch--disabled`)
- Fixed double-click bug (label synthetic click guard on `component-switch-input`)

### 3. Status Bar Colors (My Posts)
- Hidden: `#444` (dark gray) — `posteditor-status-bar--darkgray`
- Expired: `#000` (black) — `posteditor-status-bar--black`
- Deleted: `#000` (black) — `posteditor-status-bar--black`
- Active: green/yellow/red based on days remaining (unchanged)
- Added full CSS support for `--darkgray` and `--black` (hover, borders, modal borders)

### 4. Confirm Dialog Button Colors
- Added `success` (green) variant: `.component-confirm-dialog-button--confirm.success`
- Hide = danger (red), Show = success (green), Delete = danger, Restore = danger

### 5. My Posts Sort Order
- Tier 0 (top): Active + Hidden — favorites first, then most recently published
- Tier 1 (middle): Expired — most recently published
- Tier 2 (bottom): Deleted — most recently published
- Implemented in `sortPostsWithFavorites()` in `posteditor.js`

### 6. Expired Post Preview Fix
- `get-posts.php` was filtering out expired posts when fetched by `post_id`
- Fixed: skip public filters (visibility, payment, moderation) when `post_id` or `post_key` is specified
- This fixed "Rain in Spain" being unclickable in My Posts
- **Security note**: This bypass applies to all users, not just logged-in members. A tighter check using `$isLoggedIn` was attempted but broke functionality (fetch may not send auth cookie). Needs proper investigation.

### 7. Toast Messages (SQL only — not wired up yet)
- Added 4 rows to `admin_messages` (IDs 272–275):
  - `msg_posteditor_toast_hidden` — "This post is hidden and not visible on the website."
  - `msg_posteditor_toast_expired` — "This post has expired and is no longer visible on the website."
  - `msg_posteditor_toast_deleted` — "This post has been deleted."
  - `msg_posteditor_toast_filtered` — "This post is not visible because your current filters are hiding it."

---

## Files Modified

| File | Changes |
|------|---------|
| `components.css` | Switch consolidation, success button variant |
| `components.js` | SwitchComponent rewrite (no size, new state param) |
| `index.php` | Switch class renames (9 admin toggles + expired filter + Hide Account) |
| `filter.js` | Switch state renames, removed `size: 'big'` from SwitchComponent calls |
| `admin.js` | Switch renames + Hide Tier conversion to component-switch |
| `admin.css` | Deleted custom Hide Tier switch CSS |
| `formbuilder.js` | Hide Category/Subcategory conversion to component-switch + save logic |
| `formbuilder.css` | Deleted 2 custom switch CSS blocks |
| `member.js` | Hide Account conversion to component-switch |
| `member.css` | Deleted custom Hide Account switch CSS |
| `posteditor.js` | Hide toggle (instant, no dialog), status bar colors, sort tiers, double-click fix |
| `posteditor.css` | Deleted custom switch CSS, added darkgray/black status bar variants |
| `get-posts.php` | Skip public filters when post_id or post_key is specified |

---

## Outstanding Issues

### 1. My Posts → Map Interaction
- **Decision made**: Active posts should fly to location when clicked. Hidden/expired/deleted should show a toast instead.
- **Not implemented yet**. Toast messages exist in DB but aren't wired up in JS.

### 2. Location Menu Flickering
- Switching locations inside an open post causes ugly flickering as the panel rebuilds.
- Needs visual transition smoothing in `post.js`.

### 3. Expired Non-Events on the Map
- `get-posts.php` or frontend filter isn't distinguishing events from non-events.
- Only expired events should be searchable for 24 months after expiry.
- Expired non-events should never appear in public results.

### 4. Hide Account 404
- `gateway.php?action=edit-member` returns 404.
- The `edit-member` connector doesn't exist or isn't registered in the gateway.

### 5. Security: get-posts.php Filter Bypass
- Currently any user can fetch any post by ID, bypassing visibility/payment/moderation filters.
- Needs `$isLoggedIn` check, but the fetch request may not send auth cookies. Investigate auth flow for fetch calls.

### 6. Root Cause Unknown: Rain in Spain
- The fix works (post is now clickable), but the root cause isn't fully explained.
- Hidden posts and one other expired post were clickable before the fix. Only Rain in Spain was affected.
- If it were purely the visibility filter, all hidden/expired posts should have failed. They didn't.
- May be worth investigating in the next session to ensure nothing else is fragile.
