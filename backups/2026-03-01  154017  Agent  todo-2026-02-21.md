# FunMap To Do List
Created: 21 February 2026

---

## 1. Email Verification — Inline Animated Button
Inline animated verify-email button on the registration form. Sends verification email when clicked. Button spins while waiting. Turns green when user clicks the link in their email. Unlocks the submit button. The form stays open throughout — user never leaves the page.

---

## 2. Email Templates
Create all templates in the `admin_messages` table under `msg_email`. Required emails:
1. Welcome / registration confirmation
2. New post live — details + edit link
3. Post upgraded — confirmation
4. Payment receipt (covers donation, new post, upgrade)
5. Password reset
6. Deletion confirmation (post or account)
7. 7-day expiry warning — sent once per member, lists all posts expiring within the next 14 days (batched, no daily hounding)
8. Post expired notice — batched daily per member

All sent from `support@funmap.com`.

---

## 3. Buttons Site-Wide
Audit all buttons. Decide whether subtle soft-3D styling is appropriate and consistent with the brand. User leans toward keeping it. Confirm decision then apply consistently across the entire site.

---

## ~~4. Icons~~
~~Replace current icons in postcards and post views with better ones throughout the site.~~

---

## 5. Categories & Subcategories
Streamline the full category and subcategory list. Remove any subcategories with zero worldwide results in the filter panel. Ensure every subcategory has the correct fieldsets assigned.

---

## 6. Payment Currency
Confirm Stripe and PayPal are charging in USD. Understand how Stripe converts to AUD before depositing to bank account. Clarify how this appears in reporting and reconciliation.

---

## 7. Responsive Design
Test and fix layout on iPhone, Android, tablets, and various desktop sizes. Decide on a strategy for landscape phone orientation.

---

## 8. Password Recovery & Email Triggers
Preview: https://funmap.com/Agent/email-preview.php
a. [COMPLETE] Welcome — trigger in `add-member.php` after successful registration
b. [COMPLETE] Post live — trigger in `add-post.php` after post goes live
c. [COMPLETE] Post updated — trigger in `edit-post.php` on meaningful changes
d. [COMPLETE] Donation thanks — trigger in `payment-order.php` after successful payment (renamed from msg_email_payment_receipt)
e. [COMPLETE] Password reset — full flow: token table, reset page, email with 1-hour expiry, password change
f. [COMPLETE] Email verification — verify email address after registration before account is active
g. **Deletion confirmed** — trigger in `delete-member.php` and `delete-post.php`
h. **Expiry warning** — daily cron job checks posts expiring within 14 days, sends once per member per cycle
i. **Post expired** — same daily cron job, batched per member
j. **Rate limiting** — before sending, check `emails_sent` for emails sent to the same address in the last 24 hours; abort if over threshold
k. **Unsubscribe link** — legally required in many countries; add one-click unsubscribe to all emails
l. **Bounce handling** — add a `bounced` flag to `members`; stop sending to bounced addresses
m. **Cron job throttling** — expiry/expired cron jobs must throttle to max 1 email/second and batch per member
n. **Sender reputation monitoring** — register `funmap.com` at Google Postmaster Tools and Microsoft SNDS (both free)
o. **Inactivity closure** — if a member has not logged in for 365 days, close their account automatically. Two emails required: template 710 (warning, sent at 335 days — "your account will be closed in 30 days unless you log in") and template 711 (closure confirmation, sent at 365 days). Security rationale: email providers recycle dormant addresses; a live FunMap account tied to a recycled email is a takeover risk via password reset. Requires `last_login_at` column on `members` and `admins` tables, a daily cron job, and the same soft-delete/hard-delete logic as account deletion (708/709). Logging in at any point resets the 365-day clock.

---

## 9. Coupon Codes
Allow free or discounted post creation via coupon codes — for testing, friends, and promotions.

---

## 10. Post Status Bars
Add status bars to posts appropriate to the active sort order. Examples: countdown to start date for events. Verify all existing sort orders work correctly. Consider a new sort order for deals and promos.

---

## ~~11. Buy Now Button~~
~~Add a configurable Buy Now / Shop Now / Tickets button per post, linking to an external ticket, item, or shop page.~~

---

## ~~12. Formbuilder — Subcategory Auto-Fill~~
~~Ensure subcategory fieldsets are auto-populated correctly in Formbuilder based on subcategory type (events vs general).~~

---

## 20. Storefront / Entries System
Multiple posts at the same address by the same member should merge into a storefront. Member avatar becomes the group thumbnail. Support multiple cities per storefront. Consider bulk pricing discounts for storefront members.

---

## 13. Tier Colours
Decide on dedicated colours for Standard / Featured / Premium tiers and apply them consistently throughout the site (buttons, borders, checkout, post editor tabs, etc.).

---

## 14. Moderation System
Design and implement the full moderation system.

---

## 15. Update Sitemap
Update `sitemap.html` to reflect the current state of the platform.

---

## 16. SEO & Social Sharing
Ensure all imagery, icons, logos, descriptions, and meta tags look correct when links are shared on Facebook, Instagram, and elsewhere.

---

## 17. Data Population
Integrate Ticketmaster Open Events API and other legal data sources to populate subcategories with real content. Consider daily scheduled scrapes. Review whether new fieldsets are needed (e.g. opening hours).

---

## 18. Test Posts Audit
Check every fieldset renders correctly in post view. Amenities not yet implemented. Other fieldsets need review to ensure they display correctly.

---

## 21. Single-Use Invite Codes
Each code is tied to one specific email address and expires after one use. If someone else tries it, it simply doesn't work. Separate system from coupon codes — intended for granting complimentary access to friends or companies without the risk of a code spreading publicly.

---

## 19. Growth Plan
Evaluate SEO strategy for major world events. Consider a Facebook page with auto-posted new listings. Research influencer vs paid advertising options that are not extremely expensive.

---

## 23. config.js — Deployment Configuration File
Create a `config.js` file to hold deployment-specific hardcoded constants (e.g. `LOCKED_FIELDSETS`). This makes the platform transferable — only `config.js` needs updating per deployment, everything else stays untouched.

---

## 25. Admin Panel Settings Tab — Scroll on Open
Settings tab always opens scrolled to the 3rd field. Root cause unknown — do not patch with `scrollTop = 0`.

---

## 24. Batch Edit Checkout
Allow members to edit multiple posts and pay for all changes in a single transaction, reducing per-transaction fees (e.g. Stripe's 30¢ flat fee). High priority for event organisers who manage multiple listings (venues, festivals, promoters) — forcing a separate payment per post edit is a poor experience and unnecessarily costly for power users.

---

## 22. Pre-Launch: Set Real API Key
When the connectors folder moves to its final location one tier above `public_html`, replace `YOUR_SECRET_KEY` in both `config/config-auth.php` and `connectors/.htaccess` with a real random secret. Do not do this while connectors are inside `public_html`.

---

## APPENDIX: Email System — Built 27 February 2026

### Overview
A complete email sending system has been built. Templates exist in the database. Nothing is triggered yet — all triggers are listed under todo item 8.

---

### SMTP Configuration
All SMTP credentials are stored in `home/funmapco/config/config-auth.php` on the server (not in the repo). This file is never committed to git.

The file contains:
```php
$SMTP_HOST     = 'mail.funmap.com';
$SMTP_USERNAME = 'support@funmap.com';
$SMTP_PASSWORD = '(set by user — stored only in config-auth.php on server)';
```

The email account `support@funmap.com` was created in cPanel → Email Accounts on Ventra IP hosting. SMTP port: 465, SSL/TLS.

**IMPORTANT:** The SMTP password exists only in `config-auth.php` on the server. No agent has seen it. Do not ask the user to paste it in chat.

---

### Files Created
| File | Location | Purpose |
|------|----------|---------|
| `send-email.php` | `home/funmapco/connectors/` | Sends email given a template key and recipient |
| `email-preview.php` | `Agent/` | Browser preview of all 8 email templates |
| `PHPMailer.php` | `public_html/libs/phpmailer/` | PHPMailer library |
| `SMTP.php` | `public_html/libs/phpmailer/` | PHPMailer SMTP class |
| `Exception.php` | `public_html/libs/phpmailer/` | PHPMailer exception class |

---

### Database

**Table: `emails_sent`**
Logs every email sent (or failed). Columns: `id`, `member_id`, `message_key`, `to_email`, `status` (sent/failed), `created_at`.

**Templates in `admin_messages`** (container_key = `msg_email`, IDs 700–707):

| ID | message_key | Subject |
|----|-------------|---------|
| 700 | `msg_email_welcome` | Welcome to FunMap! |
| 701 | `msg_email_post_live` | Your listing is now live on FunMap |
| 702 | `msg_email_post_updated` | Your listing has been updated |
| 703 | `msg_email_donation_thanks` | Your FunMap payment receipt |
| 704 | `msg_email_password_reset` | Reset your FunMap password |
| 705 | `msg_email_deletion_confirmed` | Deletion confirmed |
| 706 | `msg_email_expiry_warning` | Your FunMap listings expire soon |
| 707 | `msg_email_post_expired` | Your FunMap listing has expired |

---

## APPENDIX: Session — 1 March 2026

### Email Verification (To-Do Item 1)
Built inline email verification for the registration form. A "Send Code" button appears after the email field. On click, a 6-character alphanumeric code (no ambiguous chars) is generated, stored in `member_tokens` (member_id=0, member_role=unverified), and emailed via template 712 (`msg_email_verification_code`). User types the code into an inline input; on 6th character it auto-verifies. The fieldset uses `data-complete` to gate the submit button through the existing validity mechanism. Includes a 60-second resend cooldown with live countdown timer. New connectors: `send-verification-code.php`, `verify-email-code.php`. New gateway routes: `send-verification-code`, `verify-email-code`. `email` column added to `member_tokens` table (SQL run by user). Template 712 inserted by user.

### Bugs Fixed
- **`payment-order.php`** — `bind_param` format string `'iiisssdsss'` (10 chars, 11 vars) corrected to `'iisssssdsss'` in both Stripe and PayPal capture paths. Was causing 500 on all payment captures.
- **`add-member.php`** — `send_payment_receipt_email` was missing `{date}` and `{payment}` substitutions and used an unpadded receipt ID. Fixed to match `payment-order.php` pattern.
- **`add-member.php`** — Avatar filename was not zero-padded. Fixed: `str_pad($id, 8, '0', STR_PAD_LEFT) . '-avatar.' . $ext`.
- **`payment-order.php`, `add-post.php`, `edit-post.php`, `add-member.php`** — Added `'link' => 'Link'` to `$methodLabels` so Stripe Link shows as "Stripe · Link" in emails.
- **`components.js`** — `_showProcessing()` moved to fire immediately when Stripe confirms client-side, instead of waiting for server capture. Eliminates the payment button delay.
- **`components.js`** — Email verification widget state transitions changed from `display:none` to `visibility:hidden` to prevent TopSlack scroll jumps on resend.
- **`member_tokens`** — `email` column added to support pre-registration verification tokens.
- **Members table** — AUTO_INCREMENT was at 20108 (from prior migration). Reset to 209 after renumbering member 20108 → 208.

**Admin settings:** `email_logo` (ID 256) — filename of email logo, uses `folder_system_images` for base URL. Logo file: `funmap-logo-email.png` on Bunny CDN in `system-images/`.

---

### How `send-email.php` Works
- Called via the gateway like all other connectors
- POST params: `message_key`, `to_email`, `to_name`, `member_id`, plus any placeholder values declared in the template
- Reads template from `admin_messages` by `message_key`
- Substitutes declared `{placeholders}` only
- Fetches `support_email`, `website_name`, `email_logo`, `folder_system_images` from `admin_settings` at runtime — nothing hardcoded
- Injects logo header dynamically into email body
- Sends via PHPMailer (SSL, port 465)
- Logs result to `emails_sent` table regardless of success or failure

---

### Logo Injection
The logo is NOT stored in the email templates. It is injected by `send-email.php` at send time by inserting a header div after the opening wrapper div. The preview page (`email-preview.php`) does the same. To change the email logo, update the `email_logo` setting in the admin panel Settings tab.
