<!doctype html> 
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" id="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Events Platform</title>
  <link rel="apple-touch-icon" sizes="180x180" href="assets/favicons/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="assets/favicons/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="assets/favicons/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="assets/favicons/android-chrome-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="assets/favicons/android-chrome-512x512.png" />
  <link rel="manifest" href="assets/favicons/site.webmanifest" />
  <link rel="shortcut icon" href="assets/favicons/favicon.ico" />
  <link id="mapbox-gl-css" rel="stylesheet"
        href="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.css" />

  <style id="hotfixes">
    /* Hand cursor for DOM-based Mapbox markers */
    .mapboxgl-marker,
    .marker,
    .is-clickable {
      cursor: pointer;
    }

    .logo img.is-loading {
      animation: logo-rotate 1s linear infinite;
      transform-origin: 50% 50%;
    }

    @keyframes logo-rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Menus stay clickable above overlays */
    .options-menu { z-index: 10000; }

    /* Cards stay clickable on narrow screens */
    @media (max-width: 600px){
      .post-card, .post { position: relative; z-index: 2; }
    }
  </style>

  <style>
    .map-card{
      position: relative;
      width: 225px;
      height: 60px;
      transform: translateZ(0);
      pointer-events: auto;
      isolation: isolate;
      touch-action: none;
    }
    .mapmarker-overlay{
      position: relative;
      width: 0;
      height: 0;
      transform: translateZ(0);
      pointer-events: none;
      isolation: isolate;
      touch-action: none;
      background: transparent;
      border-radius: 999px;
      box-shadow: none;
      z-index: 5;
      will-change: transform;
    }
    .mapmarker-overlay > .map-card{
      position: absolute;
      left: 0;
      top: 0;
      transform: translate(-25px, -25px);
      pointer-events: auto;
      z-index: 30;
    }
    .mapmarker-overlay.is-card-visible > .mapmarker-container{
      display: none;
    }
    .mapmarker-overlay.is-card-visible{
      pointer-events: auto;
      z-index: 20000;
    }
    .map-card img,
    .mapmarker-container img{ display:block; }
    .map-card-pill{
      position: absolute;
      inset: auto;
      left: -5px;
      top: -5px;
      width: 225px;
      height: 60px;
      object-fit: contain;
      pointer-events: auto;
      opacity: 0.9 !important;
      mix-blend-mode: normal;
      z-index: 0;
    }
    .mapmarker-container{
      position: absolute;
      left: 0;
      top: 0;
      width: 150px;
      height: 40px;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }
    .mapmarker{
      position: absolute;
      left: 12px;
      top: 5px;
      width: 30px;
      height: 30px;
      pointer-events: none;
      z-index: 2;
    }
    .mapmarker-pill{
      position: absolute;
      left: 0;
      top: 0;
      width: 150px;
      height: 40px;
      object-fit: contain;
      pointer-events: none;
      opacity: 0.9 !important;
      mix-blend-mode: normal;
      z-index: 0;
    }
    .map-card-thumb{
      position: absolute;
      left: 0;
      top: 0;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: 0 2px 6px rgba(0,0,0,0.35);
      z-index: 40;
    }
    .map-card-label,
    .mapmarker-label{
      position: absolute;
      left: 55px;
      top: 0;
      width: 165px;
      height: 50px;
      padding: 6px 5px 6px 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: flex-start;
      gap: 2px;
      color: #fff;
      font-size: 12px;
      font-weight: 400;
      line-height: 1.2;
      white-space: normal;
      overflow: hidden;
      text-overflow: ellipsis;
      text-shadow: 0 1px 2px rgba(0,0,0,0.35);
      z-index: 1;
      pointer-events: auto;
    }

    .mapmarker-label{
      left: calc(12px + 30px + 5px);
      top: 7px;
      width: 96px;
      height: auto;
      padding: 4px 8px 4px 0;
      pointer-events: none;
      color: #fff;
      gap: 1px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.4);
      white-space: normal;
      z-index: 3;
      text-align: left;
    }

    .mapmarker-label-line{
      width: 100%;
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .mapmarker-label-line:first-child{ font-weight: 600; }
    .mapmarker-label-line:not(:first-child){ font-weight: 400; }

    .post-location-marker{
      width: 32px;
      height: 32px;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.4);
      transition: transform 0.2s ease, filter 0.2s ease, opacity 0.2s ease;
      cursor: pointer;
      display: block;
    }
    .post-location-marker.is-dimmed{
      filter: grayscale(100%);
      opacity: 0.5;
      transform: scale(0.9);
    }
    .post-location-marker.is-selected{
      filter: none;
      opacity: 1;
      transform: scale(1.1);
    }

    .map-card-label{
      height: 60px;
      justify-content: flex-start;
      gap: 0;
    }

    .map-card-title{
      display: flex;
      flex-direction: column;
      gap: 1px;
      width: 100%;
    }

    .map-card-title-line{
      width: 100%;
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 12px;
      line-height: 1.2;
      font-weight: 400;
    }

    .map-card-venue{
      font-weight: 400;
      font-size: 12px;
      line-height: 1.2;
      opacity: 0.9;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      width: 100%;
      margin-top: 0;
      color: #d0d0d0;
    }
    .map-card--list{
      position: relative;
      width: 100%;
      height: auto;
      display: flex;
      align-items: center;
      gap: 12px;
      transform: none;
      background: none;
      border-radius: 0;
      box-shadow: none;
    }
    .map-card--list .map-card-thumb{
      position: static;
      width: 64px;
      height: 64px;
      border-radius: 8px;
      box-shadow: none;
      flex: 0 0 64px;
    }
    .map-card--list .map-card-label{
      position: static;
      width: auto;
      height: auto;
      padding: 0;
      gap: 4px;
      text-shadow: none;
    }
    .map-card--list .map-card-title{
      white-space: normal;
    }
    .map-card--list .map-card-title-line{
      white-space: normal;
    }
    .map-card--list .map-card-venue{
      white-space: nowrap;
    }
  </style>

  <script>
    (function(){
      const LOADING_CLASS = 'is-loading';
      let pendingCount = 0;
      let logoImg = null;
      let updatePending = false;
      let stopRequested = false;
      let stopTimeoutId = null;

      function handleAnimationLoop(){
        if(stopRequested && pendingCount === 0){
          finalizeStop();
        }
      }

      function ensureLogo(){
        if(!logoImg){
          logoImg = document.querySelector('.logo img');
          if(logoImg && !logoImg.__logoAnimationBound){
            try{
              logoImg.addEventListener('animationiteration', handleAnimationLoop);
              logoImg.addEventListener('animationend', handleAnimationLoop);
            }catch(err){}
            logoImg.__logoAnimationBound = true;
          }
        }
        return logoImg;
      }

      function finalizeStop(){
        const img = ensureLogo();
        if(!img){
          return;
        }
        stopRequested = false;
        if(stopTimeoutId){
          clearTimeout(stopTimeoutId);
          stopTimeoutId = null;
        }
        if(img.classList && img.classList.contains(LOADING_CLASS)){
          img.classList.remove(LOADING_CLASS);
        } else if(!img.classList && img.style){
          img.style.animation = '';
        }
      }

      function requestStop(){
        const img = ensureLogo();
        if(!img){
          return;
        }
        if(pendingCount > 0){
          return;
        }
        let isAnimating = false;
        if(img.classList){
          isAnimating = img.classList.contains(LOADING_CLASS);
        } else if(img.style){
          isAnimating = typeof img.style.animation === 'string' && img.style.animation !== '';
        }
        if(!isAnimating){
          finalizeStop();
          return;
        }
        if(stopRequested){
          return;
        }
        stopRequested = true;
        if(stopTimeoutId){
          clearTimeout(stopTimeoutId);
        }
        stopTimeoutId = setTimeout(()=>{
          if(stopRequested && pendingCount === 0){
            finalizeStop();
          }
        }, 1200);
      }

      function applyState(){
        updatePending = false;
        const img = ensureLogo();
        if(!img){
          return;
        }
        if(pendingCount > 0){
          stopRequested = false;
          if(stopTimeoutId){
            clearTimeout(stopTimeoutId);
            stopTimeoutId = null;
          }
          if(img.classList && !img.classList.contains(LOADING_CLASS)){
            img.classList.add(LOADING_CLASS);
          } else if(!img.classList){
            img.style.animation = 'logo-rotate 1s linear infinite';
          }
        } else {
          requestStop();
        }
      }

      function scheduleUpdate(){
        if(updatePending){
          return;
        }
        updatePending = true;
        if(typeof requestAnimationFrame === 'function'){
          requestAnimationFrame(applyState);
        } else {
          setTimeout(applyState, 0);
        }
      }

      function begin(){
        pendingCount++;
        scheduleUpdate();
      }

      function end(){
        if(pendingCount > 0){
          pendingCount--;
        }
        scheduleUpdate();
      }

      if(document.readyState === 'complete' || document.readyState === 'interactive'){
        ensureLogo();
        scheduleUpdate();
      } else {
        document.addEventListener('DOMContentLoaded', () => {
          ensureLogo();
          scheduleUpdate();
        });
      }

      window.addEventListener('pageshow', () => {
        ensureLogo();
        scheduleUpdate();
      });

      const originalFetch = window.fetch;
      if(typeof originalFetch === 'function'){
        window.fetch = function(...args){
          begin();
          let finished = false;
          const finalize = () => {
            if(finished) return;
            finished = true;
            end();
          };
          try{
            const response = originalFetch.apply(this, args);
            Promise.resolve(response).then(finalize, finalize);
            return response;
          } catch(err){
            finalize();
            throw err;
          }
        };
      }

      if('XMLHttpRequest' in window && XMLHttpRequest.prototype){
        const originalSend = XMLHttpRequest.prototype.send;
        if(typeof originalSend === 'function'){
          XMLHttpRequest.prototype.send = function(...args){
            begin();
            let finalized = false;
            const finalize = () => {
              if(finalized) return;
              finalized = true;
              this.removeEventListener('loadend', finalize);
              end();
            };
            this.addEventListener('loadend', finalize);
            try{
              return originalSend.apply(this, args);
            } catch(err){
              finalize();
              throw err;
            }
          };
        }
      }

      const loaderApi = (()=>{
        const api = {
          begin(){ begin(); },
          end(){ end(); },
          track(promise){
            if(!promise || typeof promise.then !== 'function'){
              return promise;
            }
            let settled = false;
            begin();
            const finalize = () => {
              if(settled) return;
              settled = true;
              end();
            };
            Promise.resolve(promise).then(finalize, finalize);
            return promise;
          }
        };
        return api;
      })();

      const existingLoader = window.__logoLoading && typeof window.__logoLoading === 'object'
        ? window.__logoLoading
        : {};
      existingLoader.begin = loaderApi.begin;
      existingLoader.end = loaderApi.end;
      existingLoader.track = loaderApi.track;
      existingLoader.trackPromise = loaderApi.track;
      window.__logoLoading = existingLoader;
    })();
  </script>

  <style id="mapboxgl-critical-css">
    .mapboxgl-map{position:relative;width:100%;height:100%}
    .mapboxgl-canvas{position:absolute;left:0;top:0}
    .mapboxgl-canvas-container{position:absolute;inset:0}
    .mapboxgl-ctrl{box-sizing:border-box}
  </style>
  <link
    rel="stylesheet"
    href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css"
    data-fallback="https://unpkg.com/@mapbox/mapbox-gl-geocoder@5.0.0/dist/mapbox-gl-geocoder.css"
    onerror="if(this.dataset.fallback && this.href !== this.dataset.fallback){this.dataset.fallbackState='retry';this.href=this.dataset.fallback;}else{this.dataset.fallbackState='failed';}"
  />
  <style>:root{
  --header-h: 56px;
  --subheader-h: 0;
  --panel-w: 440px;
  --results-w: 530px;
  --post-board-max-w: 530px;
  --gap: 10px;
  --logo-size: 40px;
    --filter-panel-offset: 0px;
    --panel-transition-duration: 0.3s;
    --panel-area-height: calc((var(--vh, 1vh) * 100) - var(--header-h) - var(--safe-top) - var(--footer-h));
    --media-h: 200px;
    --calendar-scale: 1;
    --ink: #ffffff;
    --ink-d: #ececec;
    --gold: #ffc107; 
    --muted: #777;
      --primary: #3E5393;
      --secondary: #000000;
      --accent: #5C6FB1;
      --active: #2E3A72;
      --background: rgba(41,41,41,1);
      --text: #ffffff;
      --button-text: #ffffff;
      --button-hover-text: #ffffff;
      --button-active-text: #ffffff;
      --button-disabled-text: #666666;
      --btn: #333333;
      --btn-hover: #4d4d4d;
      --btn-active: #1a1a1a;
      --btn-selected: #2e3a72;
      --btn-selected-hover: #3c4b8a;
      --btn-selected-active: #232e59;
      --btn-disabled: #bbbbbb;
      --panel-bg: rgba(0,0,0,1);
      --panel-text: #000000;
      --footer-h: 0px;
      --list-background: rgba(0,0,0,0.37);
      --closed-card-bg: rgba(0,0,0,0.37);
      --scrollbar-track: rgba(0,0,0,0);
      --scrollbar-thumb: rgba(0,0,0,0.3);
      --scrollbar-thumb-hover: rgba(0,0,0,0.5);
      --scrollbar-h: 8px;
      --border: rgba(173,173,173,0.31);
      --border-hover: rgba(255,136,0,0.43);
      --border-active: rgba(255,200,0,0.45);
      --placeholder-text: gray;
      --filter-placeholder-text: var(--placeholder-text);
      --popup-bg: rgba(0,0,0,1);
      --popup-text: #ffffff;
      --dropdown-title: #000000;
      --dropdown-selected-bg: #7c4dff;
      --dropdown-selected-text: #ffffff;
      --dropdown-text: #000000;
      --dropdown-bg: rgba(255,255,255,1);
      --dropdown-hover-bg: rgba(224,224,224,1);
      --dropdown-hover-text: #000000;
        --dropdown-venue-text: #000000;
        --dropdown-radius: 8px;
        --calendar-width: 250px;
        --calendar-height: 200px;
        --calendar-cell-w: calc(var(--calendar-width) / 7);
        --calendar-header-h: 20px;
        --calendar-cell-h: calc((var(--calendar-height) - var(--calendar-header-h)) / 7);
        --calendar-past-bg: #f0f0f0;
        --calendar-future-bg: #ffffff;
        --session-available: #888888;
        --session-selected: #2e3a72;
        --today: #ff0000;
        --image-panel-bg: rgba(0,0,0,0.7);
      --filter-active-color: #7c4dff;
      --category-switch-active: #00b050;
      --keyword-bg: #FFFFFF;
      --date-range-bg: rgba(74,74,74,0.9);
      --date-range-text: rgba(255,255,255,1);
      --control-h: 35px;
      --geocoder-h: var(--control-h);
      --panel-label-font: system-ui, sans-serif;
      --panel-label-size: 14px;
      --panel-label-color: #ffffff;
      --panel-title-font: system-ui, sans-serif;
      --panel-title-size: 16px;
      --panel-title-color: #ffffff;
      --post-mode-bg-color: 0,0,0;
      --post-mode-bg-opacity: 0;
      --safe-top: env(safe-area-inset-top, 0px);
}

*:not([class*="mapboxgl-"]){
  box-sizing: border-box;
  scrollbar-width: thin;
  scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
  border-color: var(--border) !important;
}

fieldset{
  margin:0;
  padding:6px 0 0;
  border:0 !important;
}

*:not([class*="mapboxgl-"]):hover{
  border-color: var(--border-hover) !important;
}

*:not([class*="mapboxgl-"]):active{
  border-color: var(--border-active) !important;
}

*[aria-pressed="true"]:not([class*="mapboxgl-"]),
*[aria-current="page"]:not([class*="mapboxgl-"]),
.selected:not([class*="mapboxgl-"]),
.on:not([class*="mapboxgl-"]){
  border-color: var(--border-active) !important;
  color: var(--active);
}

*[aria-selected="true"]:not([class*="mapboxgl-"]){
  border-color: var(--border-active) !important;
}

html,body{
  height: 100%;
}

*:not([class*="mapboxgl-"])::-webkit-scrollbar{
  width:var(--scrollbar-h);
  height:var(--scrollbar-h);
}
*:not([class*="mapboxgl-"])::-webkit-scrollbar-track{
  background:var(--scrollbar-track);
}
*:not([class*="mapboxgl-"])::-webkit-scrollbar-thumb{
  background:var(--scrollbar-thumb);
  border-radius:0;
}
*:not([class*="mapboxgl-"])::-webkit-scrollbar-thumb:hover{
  background:var(--scrollbar-thumb-hover);
}

  body{
    margin: 0;
    font: 13px system-ui, sans-serif;
    background: var(--background);
    color: var(--text);
    overflow: hidden;
    cursor: auto;
    caret-color: transparent;
    display: flex;
    flex-direction: column;
    min-height: calc(var(--vh, 1vh) * 100);
    user-select: text;
    touch-action: manipulation;
  }

  body, .post-board, .second-post-column{
    overscroll-behavior: contain;
  }
  .panel-content, .options-menu, .calendar-scroll{
    overscroll-behavior: contain;
  }

  h1, h2, h3, h4, h5, h6{
    font-size: 16px;
    font-weight: bold;
  }

input,
textarea,
.wysiwyg{
  caret-color: auto;
  user-select: text;
}

button:not([class*="mapboxgl-ctrl"]),
[role="button"]{
  background: var(--btn);
  border: 1px solid var(--btn);
  color: var(--button-text);
  font-size: 13px;
  padding: 0 10px;
  height: var(--control-h);
  min-width: 35px;
  border-radius: 8px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  cursor: pointer;
  transition: background .2s,border-color .2s,color .2s,transform .05s;
}

button:hover,
[role="button"]:hover{
  background: var(--btn-hover);
  border-color: var(--btn-hover);
  color: var(--button-hover-text);
}

button:active,
[role="button"]:active{
  background: var(--btn-active);
  border-color: var(--btn-active);
  color: var(--button-active-text);
}

button[aria-pressed="true"],
[role="button"][aria-pressed="true"],
button[aria-current="page"],
[role="button"][aria-current="page"],
button[aria-selected="true"],
[role="button"][aria-selected="true"],
button.selected,
[role="button"].selected,
button.on,
[role="button"].on{
  background: var(--button-selected-bg, var(--btn-selected));
  border-color: var(--button-selected-border, var(--button-selected-bg, var(--btn-selected))) !important;
  color: var(--button-selected-text, var(--button-active-text)) !important;
}

button[aria-pressed="true"]:hover,
[role="button"][aria-pressed="true"]:hover,
button[aria-current="page"]:hover,
[role="button"][aria-current="page"]:hover,
button[aria-selected="true"]:hover,
[role="button"][aria-selected="true"]:hover,
button.selected:hover,
[role="button"].selected:hover,
button.on:hover,
[role="button"].on:hover{
  background: var(--button-selected-hover, var(--btn-selected-hover));
  border-color: var(--button-selected-hover-border, var(--button-selected-hover, var(--btn-selected-hover))) !important;
  color: var(--button-selected-hover-text, var(--button-selected-text, var(--button-active-text))) !important;
}

button[aria-pressed="true"]:active,
[role="button"][aria-pressed="true"]:active,
button[aria-current="page"]:active,
[role="button"][aria-current="page"]:active,
button[aria-selected="true"]:active,
[role="button"][aria-selected="true"]:active,
button.selected:active,
[role="button"].selected:active,
button.on:active,
[role="button"].on:active{
  background: var(--button-selected-active, var(--btn-selected-active));
  border-color: var(--button-selected-active-border, var(--button-selected-active, var(--btn-selected-active))) !important;
  color: var(--button-selected-active-text, var(--button-selected-text, var(--button-active-text))) !important;
}

a{
  color: var(--primary);
}

a:hover{
  color: var(--accent);
}

a:active{
  color: var(--active);
}
button:active,
[role="button"]:active{
  transform: scale(0.97);
}
button:focus-visible,
[role="button"]:focus-visible{
  outline:2px solid #ffffff;
  outline-offset:2px;
}

button:disabled,
[role="button"][aria-disabled="true"],
button.disabled,
[role="button"].disabled{
  background: var(--btn-disabled);
  border-color: var(--btn-disabled);
  color: var(--button-disabled-text);
  cursor: not-allowed;
  opacity: 0.6;
}

button:disabled:hover,
[role="button"][aria-disabled="true"]:hover,
button.disabled:hover,
[role="button"].disabled:hover{
  background: var(--btn-disabled);
  border-color: var(--btn-disabled);
  color: var(--button-disabled-text);
}

input::placeholder,
textarea::placeholder{
  color: var(--placeholder-text);
  font-size: inherit;
}
#filterPanel #keyword-textbox::placeholder{
  color: var(--filter-placeholder-text);
  font-size: inherit;
}
#filterPanel #daterange-textbox::placeholder{
  color: var(--filter-placeholder-text);
  font-size: inherit;
}

.field label{
  color: var(--panel-label-color);
  font-size: var(--panel-label-size);
}

.panel-content .title,
.panel-content .t{
  color: var(--panel-title-color);
  font-size: var(--panel-title-size);
}

select{
  background: var(--dropdown-bg);
  color: var(--dropdown-text);
  border-radius: var(--dropdown-radius);
}
.venue-select{
  color: var(--dropdown-venue-text);
}
select option{
  background: var(--dropdown-bg);
  color: var(--dropdown-text);
}
select option:checked{
  background: var(--dropdown-selected-bg);
  color: var(--dropdown-selected-text);
}
select option:hover{
  background: var(--dropdown-hover-bg);
  color: var(--dropdown-hover-text);
}

input[type="text"],
input[type="email"],
input[type="password"],
input[type="search"],
input[type="tel"],
input[type="url"],
textarea,
select{
  height: var(--control-h);
  border-radius: 8px;
}
input[type="checkbox"]{
  width: var(--control-h);
  height: var(--control-h);
  border-radius: 8px;
}

  .header{
    height: calc(var(--header-h) + var(--safe-top));
    min-height: calc(var(--header-h) + var(--safe-top));
    max-height: calc(var(--header-h) + var(--safe-top));
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding: var(--safe-top) var(--gap) 0 var(--gap);
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 20;
    background: rgba(0,0,0,0.7);
  }

  .logo{
    position: absolute;
    left: var(--gap);
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    align-items: center;
    gap: var(--gap);
    font-weight: 800;
    letter-spacing: .4px;
    user-select: none;
    cursor: pointer;
  }

.logo img{
  width: var(--logo-size);
  height: var(--logo-size);
  display: block;
}

  .view-toggle{
  position: absolute;
  left: calc(var(--gap) * 2 + var(--logo-size));
  right: var(--gap);
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  height: 40px;
  gap: 10px;
  }

.view-toggle button{
  border: 1px solid var(--btn);
  border-radius: 8px;
  padding: 0;
  width: 40px;
  background: var(--btn);
  color: var(--button-text);
  font-weight: 600;
  cursor: pointer;
  transition: background .2s,border-color .2s,color .2s;
}

.view-toggle button[aria-pressed="true"]{
  background: var(--btn-selected);
  border-color: var(--btn-selected) !important;
  color: var(--button-active-text) !important;
}

.header-buttons{display:flex;gap:10px;position:relative;z-index:1;}

.header-buttons button{width:40px;}

.header button,
.options-menu button:not([class*="mapboxgl-ctrl"]){
  height:40px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  line-height:1;
}
.header button{
  border-radius:8px;
}
.options-menu button:not([class*="mapboxgl-ctrl"]){
  border-radius:0;
}
.header .gear,
.header a{
  border-radius:8px;
}

.results-arrow,
.dropdown-arrow{
  display:inline-block;
  width:8px;
  height:8px;
  border-style:solid;
  border-width:0 2px 2px 0;
  border-color:currentColor !important;
  color:inherit;
  transition:transform .3s;
}

.options-dropdown > button{
  position:relative;
  padding-right:30px;
}
.results-arrow{
  transform:rotate(45deg);
  transition:transform .3s;
  vertical-align:middle;
}

.options-dropdown .dropdown-arrow,
.options-dropdown .results-arrow{
  position:absolute;
  top:50%;
  right:10px;
  transform:translateY(-50%) rotate(45deg);
  margin-right:0;
}

button[aria-expanded="true"] .dropdown-arrow,
button[aria-expanded="true"] .results-arrow{
  transform:translateY(-50%) rotate(-135deg);
}

/* Spin controls */
#adminPanel .range-wrap{
  display:flex;
  align-items:center;
  gap:8px;
}
#adminPanel .range-wrap input[type="range"]{
  width:300px;
}
#adminPanel .range-wrap span{
  width:40px;
  text-align:right;
}
#adminPanel #balloonSize{
  width:300px;
}
#adminPanel #balloonSizeValue{
  display:inline-block;
  width:40px;
  text-align:right;
  margin-left:8px;
}
  #spinType{
    display:flex;
    gap:6px;
    margin-top:6px;
  }
  #spinType label{
    flex:1;
    border-radius:8px;
    overflow:hidden;
  }
  #spinType input{
    display:none;
  }
  #spinType span{
    display:block;
    padding:0 10px;
    height:35px;
    line-height:35px;
    background:var(--btn);
    color:var(--button-text);
    font-weight:600;
    cursor:pointer;
    text-align:center;
    transition:background .2s,border-color .2s,color .2s;
    border:1px solid var(--btn);
    border-radius:8px;
  }

.gear{
  width: 36px;
  height: 36px;
  border-radius: 8px;
  background: rgba(255,255,255,0.2);
  display: grid;
  place-items: center;
  border:1px solid rgba(255,255,255,0.4);
  color: #fff;
}

.gear svg{
  width: 18px;
  height: 18px;
  opacity: .9;
}

.panel{
  position:fixed;
  top:0;
  left:0;
  right:0;
  width:100%;
  height:calc(var(--vh, 1vh) * 100);
  background:transparent;
  display:none;
  z-index:2000;
  pointer-events:none;
}
.panel.show{
  display:block;
}
.modal{
  position:fixed;
  top:0;
  left:0;
  right:0;
  width:100%;
  height:calc(var(--vh, 1vh) * 100);
  background:transparent;
  display:none;
  z-index:2000;
  pointer-events:none;
}
.modal.show{
  display:block;
}
.panel-content{
  position:absolute;
  left:50%;
  top:calc(var(--header-h) + var(--safe-top));
  bottom:auto;
  width:440px;
  max-width:440px;
  height:var(--panel-area-height, calc((var(--vh, 1vh) * 100) - var(--header-h) - var(--safe-top) - var(--footer-h)));
  max-height:var(--panel-area-height, calc((var(--vh, 1vh) * 100) - var(--header-h) - var(--safe-top) - var(--footer-h)));
  min-height:var(--panel-area-height, calc((var(--vh, 1vh) * 100) - var(--header-h) - var(--safe-top) - var(--footer-h)));
  border-radius:0;
  display:flex;
  flex-direction:column;
  overflow:hidden;
  pointer-events:auto;
  transition:transform var(--panel-transition-duration, 0.3s) ease;
  will-change:transform;
  box-sizing:border-box;
}

.panel-content[data-side='left']{
  transform:translateX(-100%);
}

.panel-content[data-side='right']{
  transform:translateX(100%);
}

.panel-content[data-side]:not(.panel-visible){
  pointer-events:none;
}

.panel-content[data-side].panel-visible{
  pointer-events:auto;
  transform:translateX(0);
}

.panel-content .resizer{position:absolute;z-index:10;background:transparent;display:none;}
.panel-content .resizer.n{top:0;left:0;right:0;height:6px;cursor:n-resize;}
.panel-content .resizer.s{bottom:0;left:0;right:0;height:6px;cursor:s-resize;}
.panel-content .resizer.e{top:0;right:0;bottom:0;width:6px;cursor:e-resize;}
.panel-content .resizer.w{top:0;left:0;bottom:0;width:6px;cursor:w-resize;}
.panel-content .resizer.ne{top:0;right:0;width:10px;height:10px;cursor:ne-resize;}
.panel-content .resizer.nw{top:0;left:0;width:10px;height:10px;cursor:nw-resize;}
.panel-content .resizer.se{bottom:0;right:0;width:10px;height:10px;cursor:se-resize;}
.panel-content .resizer.sw{bottom:0;left:0;width:10px;height:10px;cursor:sw-resize;}
.panel-body{
  flex:1 1 auto;
  min-height:0;
  overflow-y:auto;
  overflow-y:overlay;
  overflow-x:hidden;
  padding:20px 10px;
  overscroll-behavior:contain;
  display:flex;
  flex-direction:column;
  align-items:stretch;
  gap:20px;
}
.panel-body > *{
  width:100%;
  max-width:420px;
  box-sizing:border-box;
  margin:0 auto;
  min-width:0;
}
.panel-body > *:last-child{
  margin-bottom:0;
}
.panel-body > *:not(.map-control-row) > *{
  width:100%;
  max-width:100%;
  min-width:0;
}
#adminPanel #styleControls{
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  gap:12px;
}
#adminPanel #styleControls > *{
  width:100%;
  max-width:420px;
}
#adminPanel .admin-fieldset,
.admin-fieldset{
  margin:0 auto;
  border:0;
  border-radius:8px;
  padding:0;
  width:100%;
  max-width:420px;
  box-sizing:border-box;
}
#adminPanel .admin-fieldset.collapsed{
  padding:0;
}
  #adminPanel .panel-content,
  #memberPanel .panel-content{
    width:min(440px, 100%);
    max-width:100%;
    height:var(--panel-area-height, calc((var(--vh, 1vh) * 100) - var(--header-h) - var(--safe-top) - var(--footer-h)));
    max-height:var(--panel-area-height, calc((var(--vh, 1vh) * 100) - var(--header-h) - var(--safe-top) - var(--footer-h)));
    min-height:var(--panel-area-height, calc((var(--vh, 1vh) * 100) - var(--header-h) - var(--safe-top) - var(--footer-h)));
    display:flex;
    flex-direction:column;
    overflow-y:auto;
    overflow-y:overlay;
    left:auto;
    right:0;
  }

  #adminPanel .panel-content{
    background:#222222;
    color:#fff;
  }

  #memberPanel .panel-content{
    background:#222222;
    color:#fff;
  }
#filterPanel .panel-content{
  width:100%;
  max-width:380px;
  background:#555555;
  color:#fff;
  display:flex;
  flex-direction:column;
  overflow-y:auto;
  overflow-y:overlay;
  padding-bottom:calc(10px + env(safe-area-inset-bottom, 0px));
}

#filterPanel .panel-body{
  gap:var(--gap);
  padding:0 10px calc(var(--gap) + env(safe-area-inset-bottom, 0px));
}

#filterPanel button:not([class*="mapboxgl-"]),
#filterPanel .sq,
#filterPanel .tiny{
  background:#333333;
  border: none;
}
#adminPanel button,
#memberPanel button{
  background:#333333;
  color: var(--ink);
  border: none;
}
#adminPanel button{
  height:35px;
  line-height:35px;
}
#adminPanel input[type="color"]{
  width:35px;
  height:35px;
}
#filterPanel input[type="text"]{
  background: var(--panel-bg);
  color: var(--panel-text);
}
#filterPanel .calendar-container{
  background: var(--dropdown-bg);
  position:absolute;
  top:0;
  left:0;
  display:flex;
  align-items:stretch;
  overflow-x:auto;
  overflow-y:hidden;
  padding-bottom:var(--scrollbar-h);
  box-sizing:content-box;
  width:340px;
  height:var(--calendar-height);
  max-width:100%;
  border:1px solid var(--border);
  border-radius:8px;
  box-shadow:0 12px 32px rgba(0,0,0,0.4);
  overscroll-behavior:contain;
  -webkit-overflow-scrolling:touch;
  touch-action:pan-x pan-y;
  opacity:0;
  visibility:hidden;
  pointer-events:none;
  transform:translateY(4px);
  transition:opacity 0.2s ease, transform 0.2s ease, visibility 0.2s ease;
  z-index:5000;
}
#filterPanel .calendar-container.is-visible{
  opacity:1;
  visibility:visible;
  pointer-events:auto;
  transform:translateY(0);
}
#filterPanel .calendar-container .today-marker{
  position:absolute;
  bottom:0;
  width:8px;
  height:8px;
  border-radius:50%;
  background:var(--today);
  cursor:pointer;
}
#filterPanel #datePicker{
  width:var(--calendar-width);
  flex:0 0 auto;
}
#filterPanel .calendar{
  display:flex;
  width:max-content;
  transform:scale(var(--calendar-scale));
  transform-origin:top left;
  background:var(--dropdown-bg);
  color:var(--dropdown-text);
}
.calendar .month{
  flex:0 0 auto;
  width:var(--calendar-width);
  height:var(--calendar-height);
}
.calendar .month:not(:first-child){
  border-left:1px solid var(--calendar-past-bg);
}
.calendar .grid{
  width:100%;
  height:calc(var(--calendar-height) - var(--calendar-header-h));
  display:grid;
  grid-template-columns:repeat(7,var(--calendar-cell-w));
  grid-template-rows:repeat(7,var(--calendar-cell-h));
}
.calendar .calendar-header{
  height:var(--calendar-header-h);
  line-height:var(--calendar-header-h);
  text-align:center;
  font-size:inherit;
  color:#fff;
  background:#2e3a72;
}
.calendar .weekday,
.calendar .day{
  width:var(--calendar-cell-w);
  height:var(--calendar-cell-h);
  line-height:var(--calendar-cell-h);
  text-align:center;
  font-size:inherit;
  border-radius:8px;
}
#filterPanel .calendar .weekday,
#filterPanel .calendar .day{
  border-radius:0;
}
#filterPanel .calendar .day.range-start{
  border-top-left-radius:8px;
  border-bottom-left-radius:8px;
}
#filterPanel .calendar .day.range-end{
  border-top-right-radius:8px;
  border-bottom-right-radius:8px;
}
#filterPanel .calendar .day.range-start.range-end{
  border-radius:8px;
}
.calendar .weekday{font-weight:bold;}
.calendar .day{cursor:pointer;}
.calendar .day.empty{cursor:default;background:var(--calendar-future-bg);}
.calendar .day.past{background:var(--calendar-past-bg);color:#b3b3b3;}
.calendar .day.future{background:var(--calendar-future-bg);}
.calendar .day.today{color:var(--today) !important;font-weight:bold;}
.calendar .day.in-range{background:#add8e6;}
.calendar .day.selected{background:var(--session-selected);color:#fff;}
.calendar .day.selected.today{color:var(--today) !important;}
.calendar .day.range-start{border-radius:8px 0 0 8px;}
.calendar .day.range-end{border-radius:0 8px 8px 0;}
.calendar .day.range-start.range-end{border-radius:8px;}
#memberPanel input[type=color]{
  border-radius:8px;
  padding:0;
  height:40px;
  display:block;
}
#welcomeBody{
  display:flex;
  flex-direction:column;
  align-items:center;
  text-align:center;
  padding:0;
  gap:var(--gap);
}
#welcomeBody > :not(.map-control-row){
  pointer-events:none;
}
#welcomeBody .welcome-logo{
  max-width:100%;
  width:min(100%, 600px);
  max-height:300px;
  height:auto;
  margin:0;
}
#welcomeBody .welcome-illustration{
  max-width:280px;
  width:100%;
  height:auto;
  margin:0;
  border-radius:8px;
}
#welcome-modal{background:rgba(0,0,0,0.7);}
#welcome-modal .modal-content{
  position:absolute;
  width:min(600px, 90vw);
  max-width:90vw;
  background:none;
  border-radius:0;
  display:flex;
  flex-direction:column;
  overflow:visible;
  pointer-events:auto;
}
  @media (max-width:440px){
  #adminPanel .panel-content,
  #memberPanel .panel-content,
  #filterPanel .panel-content{
    width:100%;
    max-width:100%;
    max-height:none;
  }
}
#adminPanel legend{font-weight:600;padding:0 6px;display:flex;align-items:center;gap:6px;justify-content:space-between;cursor:pointer;user-select:none;width:100%;max-width:420px;height:35px;background:var(--btn);border:1px solid var(--btn);border-radius:var(--dropdown-radius);box-sizing:border-box;margin:0 auto;}
#adminPanel legend::after{content:'\25BC';margin-left:auto;font-size:14px;}
#adminPanel fieldset.collapsed legend::after{content:'\25B6';}
#adminPanel fieldset.collapsed > :not(legend){display:none;}
#adminPanel .fieldset-actions{display:flex;gap:4px;margin:4px 6px;}
#adminPanel .fieldset-actions .same-btn{flex:1 1 0;padding:6px;}
#adminPanel .control-row{display:flex;align-items:center;justify-content:space-between;gap:6px;margin:0 auto;padding:10px 0;width:100%;max-width:420px;}
#adminPanel .control-row label:first-child{min-width:80px;font-size:14px;cursor:pointer;user-select:none;}
.control-row > *:last-child{margin-left:auto;width:200px;}
#post-mode-background-field{
  width:100%;
  max-width:420px;
  margin:0 auto;
}
#post-mode-background-row{
  display:flex;
  align-items:center;
  width:100%;
  gap:8px;
  row-gap:8px;
  flex-wrap:wrap;
}
#post-mode-background-row input[type="color"]{
  width:40px;
  height:40px;
  padding:0;
  border-radius:8px;
  flex:0 0 40px;
}
#post-mode-background-row input[type="range"]{
  flex:1 1 160px;
  width:100%;
  max-width:none;
}
#post-mode-background-row span{
  flex:0 0 auto;
  min-width:40px;
  text-align:right;
}

.map-theme-container,
.map-balloon-container,
.map-spin-container{
  background:#444444;
  width:100%;
  max-width:420px;
  padding:10px;
  border-radius:8px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.map-theme-container .panel-field,
.map-balloon-container .panel-field,
.map-spin-container .panel-field{
  width:100%;
}

.settings-style-container,
.settings-welcome-container{
  background:#444444;
  width:100%;
  max-width:420px;
  padding:10px;
  border-radius:8px;
}

.sub-icon svg{
  width:18px;
  height:18px;
  vertical-align:middle;
}
.cat-line{
  display:flex;
  align-items:center;
}
.cat-line .sub-icon{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  flex:0 0 auto;
  padding-right:5px;
}
.cat-line .sub-icon:empty{
  display:none;
  padding-right:0;
}
.post-card .sub-icon img,
.post-card .sub-icon svg,
.recents-card .sub-icon img,
.recents-card .sub-icon svg{
  width:18px;
  height:18px;
}
#adminPanel .color-group{
  flex:0 0 200px;
  width:100%;
  max-width:200px;
  display:flex;
  flex-direction:column;
  align-items:stretch;
  position:relative;
}
#autoTheme-row{
  flex-direction:row;
  align-items:center;
  gap:8px;
  margin-left:0;
  width:440px;
  max-width:440px;
}
#autoTheme-row button{
  flex:0 0 auto;
  height:35px;
  padding:0 8px;
  min-width:0;
}
#autoTheme-row input[type=color]{
  flex:0 0 35px;
  width:35px;
  height:35px;
  padding:0;
}
#adminPanel .shadow-group{
  flex:0 0 200px;
  width:100%;
  max-width:200px;
  display:flex;
  gap:4px;
  align-items:center;
}
#adminPanel .shadow-group input[type=color]{
  width:40px;
  height:40px;
  padding:0;
  border-radius:8px;
}
#adminPanel .shadow-group input[type=number]{
  flex:1 1 0;
}
#adminPanel .textpicker{
  flex:0 0 200px;
  width:200px;
  position:relative;
}
#adminPanel .textpicker .text-preview{
  width:100%;
  height:35px;
  border-radius:8px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}
#adminPanel .textpicker .text-popup{
  display:none;
  position:absolute;
  top:44px;
  left:0;
  z-index:20;
  background:#fff;
  border:1px solid #ccc;
  border-radius:8px;
  padding:8px;
  width:200px;
}
#adminPanel .textpicker.open .text-popup{display:block;}
#adminPanel .textpicker .text-popup select,
#adminPanel .textpicker .text-popup input[type=color]{
  width:100%;
  margin-top:4px;
  border-radius:var(--dropdown-radius);
  padding:4px;
  box-sizing:border-box;
  height:35px;
}
#adminPanel .textpicker .text-popup input[type=color]{padding:0;}
#adminPanel .textpicker .text-popup .shadow-group{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:4px;
  margin-top:4px;
}
#adminPanel .textpicker .text-popup .shadow-group input[type=color],
#adminPanel .textpicker .text-popup .shadow-group input[type=number]{
  width:100%;
  height:40px;
  border-radius:var(--dropdown-radius);
  padding:0;
  box-sizing:border-box;
}
#adminPanel .admin-fieldset input,
#adminPanel .admin-fieldset select,
#adminPanel .admin-fieldset textarea{
  max-width:200px;
  box-sizing:border-box;
}
#adminPanel .control-row select{
  flex:0 0 200px;
  width:200px;
  max-width:200px;
  margin-left:auto;
  border-radius:var(--dropdown-radius);
  padding:4px;
}
#adminPanel .color-group input[type=color],
#adminPanel .color-group input[type=range]{
  width:100%;
}
#adminPanel .color-group input[type=color]{
  border-radius:8px;
  padding:0;
  height:35px;
  display:block;
  cursor:pointer;
  pointer-events:auto;
}
#adminPanel .range-group{
  display:flex;
  align-items:center;
  gap:4px;
}
#adminPanel .range-group input[type=range]{
  flex:1;
  width:auto;
}
#adminPanel .range-group span{
  min-width:32px;
  text-align:right;
  font-size:14px;
}
#adminPanel .tab-bar{display:flex;gap:6px;}
#adminPanel .tab-bar button{
  flex:1;
  padding:6px 10px;
  border-radius:8px;
  background:var(--btn);
  border:1px solid var(--btn);
  color:var(--button-text);
  cursor:pointer;
}
#adminPanel .tab-panel{display:none;}
#adminPanel .tab-panel.active{display:flex;flex-direction:column;align-items:flex-start;gap:12px;}
#adminPanel .marker-grid{display:flex;flex-direction:column;gap:8px;}
#adminPanel .marker-grid select{min-width:120px;}
#adminPanel .marker-options{display:flex;gap:8px;align-items:center;}
#adminPanel .marker-set{display:grid;grid-template-columns:repeat(10,max-content);gap:4px;}
#adminPanel .marker-set svg.outline *{stroke:#000;stroke-width:1;}
#adminPanel input[type=range]{width:100%;}
.panel-field{
  margin:8px auto;
  display:flex;
  flex-direction:column;
  gap:8px;
  width:100%;
  max-width:420px;
  min-width:0;
}
#adminPanel .panel-field{margin:8px auto;}
#adminPanel h3{margin:0;}
.admin-section{display:flex;flex-direction:column;gap:var(--gap);}
#tab-forms .panel-field{max-width:none;}
.history-group,
.color-group{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.option-label{
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
}
.option-group{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.option-label > *,
.option-group > *{
  min-width:0;
}
.wysiwyg{
  border:1px solid #ccc;
  min-height:80px;
  padding:8px;
}
.wysiwyg:empty:before{
  content:attr(data-placeholder);
  color:#999;
}
.wysiwyg-toolbar{
  display:flex;
  gap:4px;
}
.wysiwyg-toolbar button{
  padding:4px 6px;
}
.panel-field input,
.panel-field textarea,
.panel-field select{
  padding:8px;
  border-radius:var(--dropdown-radius);
  border:none;
  width:100%;
  max-width:100%;
}
.panel-actions{
  margin-top:10px;
  display:flex;
  gap:10px;
}
.panel-header{
  position:sticky;
  top:0;
  padding:10px;
  border-top-left-radius:0;
  border-top-right-radius:0;
  z-index:1;
  cursor:move;
  display:flex;
  flex-direction:column;
  gap:10px;
  flex-shrink:0;
}
.panel-header .header-top{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  width:100%;
}
.panel-header .panel-actions{
  margin-top:0;
  margin-left:auto;
  justify-content:flex-end;
}
.panel-header h2{
  margin:0;
}

@media (max-width:440px){
  .panel-header .panel-actions .move-left,
  .panel-header .panel-actions .move-right{
    display:none;
  }
  #post-mode-background-row input[type="range"]{
    flex-basis:100%;
  }
  #post-mode-background-row span{
    text-align:left;
  }
}
#filterPanel .panel-header{
  padding:10px;
}
.palette{
  display:flex;
  gap:10px;
  margin-bottom:10px;
}
.field-item,
.field-instance{
  padding:6px 10px;
  border:1px solid #ccc;
  border-radius:8px;
  background:#f9f9f9;
  cursor:move;
}
.builder-zone{
  min-height:100px;
  border:2px dashed #ccc;
  padding:10px;
}
.field-instance{margin:4px 0;}

.left-tools{
  display: flex;
  gap: 8px;
  margin-bottom: 8px;
  padding-left: 2px;
}

.sq{
  width: 30px;
  height: 30px;
  border-radius: 8px;
  background: var(--btn);
  display: grid;
  place-items: center;
  border: 1px solid var(--btn);
}

.sq svg{
  width: 14px;
  height: 14px;
  opacity: .9;
}

.field{
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 0;
  margin:0;
}

.field .input{
  position: relative;
  display:flex;
  align-items:center;
  gap:6px;
  flex:1;
}

.field .options-dropdown{
  flex:1;
}

.field .options-dropdown > button{
  width:100%;
}

.input input,
.input select{
  flex: 1;
  width: 100%;
  height: 35px;
  line-height: 35px;
  border: none;
  padding: 0 12px;
  outline: 0;
  display: flex;
  align-items: center;
}
.input input{
  border-radius: 8px;
  background: var(--btn);
  color: var(--ink);
}
.input select{
  border-radius: var(--dropdown-radius);
}
#filterPanel #keyword-textbox{
  background: var(--keyword-bg);
}
#filterPanel #daterange-textbox{
  background: #333333;
  color: var(--date-range-text);
}

.input .down{
  position: static;
  width: 35px;
  height: 35px;
  border-radius: 8px;
  background: var(--btn);
  cursor: pointer;
  border: 1px solid var(--btn);
  line-height:35px;
  text-align:center;
}
.input .down svg{
  vertical-align:middle;
}
#filterPanel .keyword-clear-button,
#filterPanel .daterange-clear-button{
  position: static;
  width: 35px;
  height: 35px;
  border-radius: 8px;
  background: var(--dropdown-bg);
  cursor: pointer;
  border: 0;
  margin-left: 6px;
  line-height: 35px;
  text-align: center;
  color: var(--dropdown-text);
  opacity:1;
}
#filterPanel .keyword-clear-button.active,
#filterPanel .daterange-clear-button.active{
  background: var(--filter-active-color);
  color: var(--button-text);
  opacity:1;
}

#filterPanel .field label.t{
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  gap: 6px;
}

.expired-row{
  grid-template-columns:1fr auto;
  align-items:center;
  gap:8px;
}
.expired-text{
  color:#fff;
  font-size:14px;
}
.filter-summary{
  font-size:14px;
  width:100%;
  max-width:420px;
  margin:0 auto;
  text-align:center;
}
#filterPanel .panel-header{
  align-items:center;
}
#filterPanel .panel-header #filterSummary{
  margin:0;
}
#filterPanel .panel-body > .filter-panel-actions{
  display:flex;
  justify-content:flex-end;
  gap:10px;
}
#filterPanel .panel-body > .filter-panel-actions button{
  flex:0 0 auto;
}

#filterPanel .reset-box,
#filterPanel .sort-field{
  width:100%;
  max-width:420px;
  margin:0 auto;
  padding:0;
}
#filterPanel .reset-box{
  padding:0;
}
#filterPanel .reset-box + .reset-box{
  margin-top:0;
}
#filterPanel .panel-body > .reset-box{
  padding:0;
}
#filterPanel .reset-box #resetBtn{
  width:100%;
}
#filterPanel .sort-field{
  display:flex;
  justify-content:center;
}
#filterPanel .sort-field .options-menu{
  width:100%;
  max-width:420px;
}
.sort-options .sort-option[aria-pressed="true"]{
  background:#2e3a72;
  color:var(--button-active-text);
  border-color:#2e3a72;
}
#filterPanel .filter-basics-container,
#filterPanel .filter-category-container,
#tab-forms .formbuilder-container{
  width:100%;
  max-width:420px;
  margin:0 auto;
  background:#444444;
  border-radius:8px;
  padding:10px;
}
#filterPanel .filter-basics-container{
  position:relative;
}
#filterPanel .filter-category-container,
#tab-forms .formbuilder-container{
  margin-top:10px;
}
#filterPanel .keyword-row,
#filterPanel .daterange-row,
#filterPanel .expired-row{
  width:100%;
  max-width:420px;
  margin:0 auto;
}
#filterPanel .filter-category-container .cats,
#filterPanel .filter-category-container .filter-category-menu,
#tab-forms .formbuilder-container .cats,
#tab-forms .formbuilder-container .filter-category-menu{
  width:100%;
}
.switch{
  position:relative;
  display:inline-block;
  width:48px;
  height:24px;
  flex:0 0 48px;
}
.switch input{
  opacity:0;
  width:0;
  height:0;
}
.switch .slider{
  position:absolute;
  cursor:pointer;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background:var(--btn);
  border-radius:24px;
  transition:.2s;
}
.switch .slider:before{
  position:absolute;
  content:'';
  height:20px;
  width:20px;
  left:2px;
  top:2px;
  background:var(--button-text);
  border-radius:50%;
  transition:.2s;
}
.switch input:checked + .slider{
  background:var(--session-selected);
}
#expiredToggle:checked + .slider{
  background:var(--filter-active-color);
}
.switch input:checked + .slider:before{
  transform:translateX(24px);
}

.tiny{
  display: grid;
  place-items: center;
  width: 38px;
  height: 40px;
  border-radius: 8px;
  background: var(--btn);
  cursor: pointer;
  border: 1px solid var(--btn);
}

.tiny svg{
  width: 18px;
  height: 18px;
}

.cats{
  margin:8px 0;
  display:flex;
  flex-direction:column;
  gap:8px;
}

.filter-category-menu{
  display:flex;
  flex-direction:column;
  gap:6px;
}

.filter-category-menu .filter-category-header{
  display:flex;
  align-items:flex-start;
  gap:8px;
}

.filter-category-menu .filter-category-trigger-wrap{
  flex:1;
}

.filter-category-menu .filter-category-trigger{
  height:36px;
  border-radius:8px;
  padding:0 12px;
  display:flex;
  align-items:center;
  justify-content:flex-start;
  gap:10px;
  background: var(--btn);
  border: 1px solid var(--btn);
  cursor: pointer;
  width: 100%;
  text-align: left;
  color: var(--button-text);
  font: inherit;
  margin: 0;
}

.filter-category-menu .category-logo{
  flex:0 0 24px;
  width:24px;
  height:24px;
  display:flex;
  align-items:center;
  justify-content:center;
}

.filter-category-menu .category-logo img{
  width:24px;
  height:24px;
}

.filter-category-menu .filter-category-trigger .label{
  font-weight:700;
  letter-spacing:.2px;
  flex:1;
}

.filter-category-menu .cat-switch{
  position:relative;
  display:flex;
  align-items:center;
  justify-content:flex-end;
  width:38px;
  height:36px;
  flex:0 0 38px;
  cursor:pointer;
  align-self:flex-start;
}
.filter-category-menu .cat-switch input{
  opacity:0;
  width:0;
  height:0;
}
.filter-category-menu .cat-switch .slider{
  position:absolute;
  top:8px;
  left:0;
  right:0;
  margin:0 auto;
  width:38px;
  height:20px;
  border-radius:16px;
  background:var(--btn);
  border:1px solid var(--btn);
  transition:.2s;
}
.filter-category-menu .cat-switch .slider:before{
  content:'';
  position:absolute;
  width:16px;
  height:16px;
  left:1px;
  top:1px;
  border-radius:50%;
  background:var(--button-text);
  transition:.2s;
}
.filter-category-menu .cat-switch input:checked + .slider{
  background:var(--category-switch-active);
  border-color:var(--category-switch-active);
}
.filter-category-menu .cat-switch input:checked + .slider:before{
  transform:translateX(18px);
}

.filter-category-menu .options-dropdown{
  width:100%;
}

.filter-category-menu .options-menu{
  width:100%;
  box-sizing:border-box;
  position:static;
  margin-top:6px;
  background:transparent;
  border:none;
  padding:0;
  border-radius:0;
  z-index:auto;
}

.filter-category-menu .options-menu button{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:flex-start;
  gap:var(--gap);
  border-radius:6px;
  border:1px solid transparent;
  box-sizing:border-box;
  padding:0 12px;
}

.filter-category-menu .options-menu button .subcategory-logo{
  flex:0 0 24px;
  width:24px;
  height:24px;
  display:flex;
  align-items:center;
  justify-content:center;
}

.filter-category-menu .options-menu button .subcategory-logo img{
  width:20px;
  height:20px;
}

.filter-category-menu .options-menu button .subcategory-label{
  flex:1;
  text-align:left;
}

.filter-category-menu .options-menu button .subcategory-switch{
  flex:0 0 auto;
  display:flex;
  align-items:center;
  justify-content:flex-end;
  width:34px;
  height:18px;
  position:relative;
  pointer-events:none;
}

.filter-category-menu .options-menu button .subcategory-switch .track{
  position:absolute;
  inset:0;
  border-radius:12px;
  background:var(--btn);
  border:1px solid var(--btn);
  transition:.2s;
}

.filter-category-menu .options-menu button .subcategory-switch .thumb{
  position:absolute;
  width:14px;
  height:14px;
  border-radius:50%;
  background:var(--button-text);
  left:2px;
  top:2px;
  transition:.2s;
}
.filter-category-menu .options-menu button[aria-pressed="false"]{
  color:var(--muted);
}
.filter-category-menu .options-menu button[aria-pressed="false"] .subcategory-logo{
  opacity:0.6;
}
.filter-category-menu .options-menu button[aria-pressed="false"] .subcategory-logo img{
  filter:grayscale(1);
}
.filter-category-menu .options-menu button[aria-pressed="false"] .subcategory-label{
  color:inherit;
}
.filter-category-menu .options-menu button[aria-pressed="false"] .subcategory-switch .track{
  background:var(--btn);
  border-color:var(--btn);
}
.filter-category-menu .options-menu button[aria-pressed="false"] .subcategory-switch .thumb{
  transform:translateX(0);
  opacity:0.7;
}

.filter-category-menu .options-menu button[aria-pressed="true"]{
  background: var(--dropdown-selected-bg);
  color: var(--dropdown-selected-text);
  border-color: var(--dropdown-selected-bg);
  --button-selected-bg: var(--dropdown-selected-bg);
  --button-selected-border: var(--dropdown-selected-bg);
  --button-selected-text: var(--dropdown-selected-text);
}
.filter-category-menu .options-menu button.on{
  --button-selected-bg: var(--dropdown-selected-bg);
  --button-selected-border: var(--dropdown-selected-bg);
  --button-selected-text: var(--dropdown-selected-text);
}

.filter-category-menu .options-menu button[aria-pressed="true"] .subcategory-switch .track,
.filter-category-menu .options-menu button.on .subcategory-switch .track{
  background:var(--category-switch-active);
  border-color:var(--category-switch-active);
}

.filter-category-menu .options-menu button[aria-pressed="true"] .subcategory-switch .thumb,
.filter-category-menu .options-menu button.on .subcategory-switch .thumb{
  transform:translateX(16px);
}

.filter-category-menu[aria-expanded="true"] .filter-category-trigger{
  border-color: var(--border-active);
}

.filter-category-menu.cat-off{
  opacity:0.6;
}

.filter-category-menu.cat-off .filter-category-trigger{
  cursor:default;
}

.reset-box{
  margin:0;
}

.reset-box .btn{
  width:100%;
  height: 36px;
  border-radius: 8px;
  background: var(--btn);
  border: 1px solid var(--btn);
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 0 14px;
  font-weight: 700;
  letter-spacing: .2px;
  color: var(--ink);
  cursor: pointer;
}
.reset-box .btn.active{
  background: var(--filter-active-color);
  border-color: var(--filter-active-color);
}

.reset-box .btn svg{
  width: 16px;
  height: 16px;
}

.reset-box .arr{
  display: grid;
  place-items: center;
  width: 38px;
  height: 36px;
  border-radius: 8px;
  background: var(--btn);
  border: 1px solid var(--btn);
}

.post-mode-background{
  position:fixed;
  top:calc(var(--header-h) + var(--safe-top));
  bottom:var(--footer-h);
  left:0;
  right:0;
  background: rgba(var(--post-mode-bg-color), var(--post-mode-bg-opacity));
  z-index:1;
  pointer-events:none;
  display:none;
}

.mode-posts .post-mode-background{
  display:block;
  pointer-events:none;
}

.post-mode-boards{
  position:fixed;
  top:calc(var(--header-h) + var(--safe-top));
  bottom:auto;
  left:0;
  right:0;
  height:var(--panel-area-height, calc((var(--vh, 1vh) * 100) - var(--header-h) - var(--safe-top) - var(--footer-h)));
  max-height:var(--panel-area-height, calc((var(--vh, 1vh) * 100) - var(--header-h) - var(--safe-top) - var(--footer-h)));
  min-height:var(--panel-area-height, calc((var(--vh, 1vh) * 100) - var(--header-h) - var(--safe-top) - var(--footer-h)));
  padding-left:var(--filter-panel-offset);
  padding-right:0;
  display:flex;
  justify-content:center;
  align-items:stretch;
  gap:var(--gap);
  z-index:2;
  pointer-events:none;
  transition:padding var(--panel-transition-duration, 0.3s) ease;
}

body.filter-anchored .post-mode-boards{
  justify-content:flex-start;
}

body.hide-ads .post-mode-boards{padding-right:0;}

.quick-list-board{
  position:fixed;
  top:calc(var(--header-h) + var(--safe-top));
  bottom:auto;
  left:0;
  width:440px;
  padding:10px;
  overflow:auto;
  overflow:overlay;
  background:rgba(0,0,0,0);
  pointer-events:auto;
  z-index:2;
  transform:translateX(0);
  height:var(--panel-area-height, calc((var(--vh, 1vh) * 100) - var(--header-h) - var(--safe-top) - var(--footer-h)));
  max-height:var(--panel-area-height, calc((var(--vh, 1vh) * 100) - var(--header-h) - var(--safe-top) - var(--footer-h)));
  min-height:var(--panel-area-height, calc((var(--vh, 1vh) * 100) - var(--header-h) - var(--safe-top) - var(--footer-h)));
  transition:transform var(--panel-transition-duration, 0.3s) ease;
  will-change:transform;
}

.recents-board{
  position:relative;
  top:auto;
  bottom:auto;
  left:auto;
  padding:0;
  margin:0;
  overflow:auto;
  overflow:overlay;
  overflow-x:hidden;
  background:rgba(0,0,0,0.7);
  transition:margin var(--panel-transition-duration, 0.3s) ease, transform var(--panel-transition-duration, 0.3s) ease;
  will-change:margin, transform;
  display:flex;
  flex-direction:column;
  gap:0;
  pointer-events:auto;
  height:var(--panel-area-height, calc((var(--vh, 1vh) * 100) - var(--header-h) - var(--safe-top) - var(--footer-h)));
  max-height:var(--panel-area-height, calc((var(--vh, 1vh) * 100) - var(--header-h) - var(--safe-top) - var(--footer-h)));
  min-height:var(--panel-area-height, calc((var(--vh, 1vh) * 100) - var(--header-h) - var(--safe-top) - var(--footer-h)));
  transform:translateX(0);
}

.post-board{
  width:var(--post-board-max-w);
  max-width:var(--post-board-max-w);
  flex-shrink:0;
  position:relative;
  left:0;
  display:flex;
  flex-direction:column;
  height:var(--panel-area-height, calc((var(--vh, 1vh) * 100) - var(--header-h) - var(--safe-top) - var(--footer-h)));
  min-height:var(--panel-area-height, calc((var(--vh, 1vh) * 100) - var(--header-h) - var(--safe-top) - var(--footer-h)));
  max-height:var(--panel-area-height, calc((var(--vh, 1vh) * 100) - var(--header-h) - var(--safe-top) - var(--footer-h)));
  transition:left var(--panel-transition-duration, 0.3s) ease,
             margin var(--panel-transition-duration, 0.3s) ease,
             transform var(--panel-transition-duration, 0.3s) ease;
  will-change:left, margin, transform;
  transform:translateX(0);
}

.recents-board{
  width:var(--post-board-max-w);
  max-width:var(--post-board-max-w);
  flex-shrink:0;
  height:var(--panel-area-height, calc((var(--vh, 1vh) * 100) - var(--header-h) - var(--safe-top) - var(--footer-h)));
  min-height:var(--panel-area-height, calc((var(--vh, 1vh) * 100) - var(--header-h) - var(--safe-top) - var(--footer-h)));
  max-height:var(--panel-area-height, calc((var(--vh, 1vh) * 100) - var(--header-h) - var(--safe-top) - var(--footer-h)));
}

.recents-board,
.post-board{
  transition:transform var(--panel-transition-duration, 0.3s) ease;
  will-change:transform;
}

.recents-board[data-side='left']:not(.panel-visible),
.post-board[data-side='left']:not(.panel-visible),
.ad-board[data-side='left']:not(.panel-visible){
  transform:translateX(-110%);
}

.recents-board[data-side='right']:not(.panel-visible),
.post-board[data-side='right']:not(.panel-visible),
.ad-board[data-side='right']:not(.panel-visible){
  transform:translateX(110%);
}

.recents-board.panel-visible,
.post-board.panel-visible,
.ad-board.panel-visible{
  transform:translateX(0);
}

.recents-board:not(.panel-visible),
.post-board:not(.panel-visible){
  pointer-events:none;
}

.ad-board{
  opacity:0;
}

.ad-board.panel-visible{
  opacity:1;
}

.ad-board:not(.panel-visible){
  pointer-events:none;
}
@media (max-width:440px){
  .post-board,
  .recents-board,
  .second-post-column.is-visible{
    width:100%;
    max-width:100%;
  }
  .second-post-column{
    display:none;
  }
}

.last-opened-label{
  font-size:12px;
  margin:0;
  background:#000;
  color:#fff;
  padding:2px 4px;
}

.post-board{
  padding:0;
  margin:0;
  overflow-y:auto;
  overflow-y:overlay;
  overflow-x:hidden;
  display:flex;
  flex-direction:column;
  gap:0;
  background:rgba(0,0,0,0.7);
  pointer-events:auto;
}
.post-board .post-card{
  width:100%;
  max-width:100%;
}

.post-board .open-post{
  width:100%;
  max-width:100%;
}

.recents-board .recents-card{
  width:100%;
  max-width:100%;
}
.recents-board .recents-card{
  margin:0;
  border-radius:0;
  background-color:transparent;
  border-bottom:1px solid rgba(255,255,255,0.12);
}
.recents-board .recents-card:last-child{border-bottom:none;}

.post-board .post-body,
.recents-board .post-body{
  display:flex;
  flex-direction:column;
  padding-bottom:10px;
  gap:0;
  position:relative;
}

.main-post-column{
  flex:0 0 100%;
  width:100%;
  max-width:var(--post-board-max-w);
  padding:0;
  display:flex;
  flex-direction:column;
}

.post-images{
  margin-top:var(--gap);
  padding-top:0;
  width:100%;
  display:flex;
  flex-direction:column;
}

@media (max-width:440px){
  .main-post-column{
    flex:0 0 auto;
    width:100%;
    max-width:none;
  }
  .post-images .thumbnail-row{
    width:100%;
  }
}

.post-board .post-header{
  position:sticky;
  top:0;
  z-index:1;
}

.post-images .thumbnail-row{
  display:flex;
  width:100%;
  max-width:var(--post-board-max-w);
  box-sizing:border-box;
  padding:0 15px 10px 0;
  margin:0;
  gap:5px;
  overflow-x:auto;
  overflow-y:hidden;
  scrollbar-gutter:stable both-edges;
  justify-content:flex-start;
}

.post-images .thumbnail-row img{
  width:40px;
  height:40px;
  object-fit:cover;
  border-radius:8px;
  cursor:pointer;
  flex:0 0 auto;
}

.post-images .selected-image{
  width:100%;
  max-width:var(--post-board-max-w);
  aspect-ratio:1/1;
  background:#000;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}

.post-images .selected-image img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
}

.second-post-column{
  width:100%;
  max-width:100%;
  min-width:0;
  padding:0;
  display:flex;
  flex-direction:column;
  overflow:visible;
  height:auto;
  margin-top:0;
}

.post-venue-selection-container,
.post-session-selection-container{
  width:100%;
  height:auto;
  min-height:0;
  display:flex;
  flex-direction:column;
  gap:var(--gap);
}
.post-venue-selection-container:empty,
.post-session-selection-container:empty{
  display:none;
}

.post-details-title-container,
.post-details-member-container,
.post-details-info-container,
.post-details-description-container{
  width:100%;
  min-width:0;
}
.post-details-info-container{
  display:flex;
  flex-direction:column;
  gap:var(--gap);
}
.post-details-info-container > *{
  min-width:0;
}

.post-details-description-container{
  display:flex;
  flex-direction:column;
  gap:var(--gap);
}

.post-details-description-container .desc,
.post-details-description-container .desc-wrap{
  border:none;
  padding:0;
}

.post-details-description-container .desc{
  font-size:14px;
}

.ad-board{
  position:fixed;
  top:calc(var(--header-h) + var(--safe-top));
  bottom:auto;
  right:0;
  width:440px;
  padding:10px;
  background:rgba(0,0,0,0.7);
  pointer-events:auto;
  z-index:2;
  transform:translateX(0);
  transition:transform var(--panel-transition-duration, 0.3s) ease,
             opacity var(--panel-transition-duration, 0.3s) ease;
  will-change:transform, opacity;
  height:var(--panel-area-height, calc((var(--vh, 1vh) * 100) - var(--header-h) - var(--safe-top) - var(--footer-h)));
  max-height:var(--panel-area-height, calc((var(--vh, 1vh) * 100) - var(--header-h) - var(--safe-top) - var(--footer-h)));
  min-height:var(--panel-area-height, calc((var(--vh, 1vh) * 100) - var(--header-h) - var(--safe-top) - var(--footer-h)));
}

body.hide-ads .ad-board{
  pointer-events:none;
}

@media (min-width:1900px){
  .ad-board{
    display:block;
  }
  body.hide-ads .ad-board{
    display:block;
  }
}

.ad-panel{
  width:100%;
  height:100%;
  position:relative;
  overflow:hidden;
  border-radius:8px;
}

.ad-panel .ad-slide{
  position:absolute;
  inset:0;
  opacity:0;
  transition:opacity 1.5s ease-in-out;
  cursor:pointer;
}

.ad-panel .ad-slide.active{opacity:1;}

.ad-panel .ad-slide img{
  width:100%;
  height:100%;
  object-fit:cover;
  animation:adZoom 20s linear forwards;
}

.ad-panel .ad-slide .info{
  position:absolute;
  left:0;
  right:0;
  bottom:0;
  background:rgba(0,0,0,0.5);
  color:#fff;
  padding:10px;
  text-shadow:0 0 4px #000;
}

@keyframes adZoom{
  from{transform:scale(1);}
  to{transform:scale(1.1);}
}

#filterBtn,
#memberBtn,
#adminBtn{
  gap:4px;
}
.header .view-toggle #filterBtn{
  height:40px;
  width:auto;
  padding:0 16px;
  border-radius:20px;
}
.icon-search{
  display:inline-block;
  vertical-align:middle;
  color: currentColor;
  width:30px; height:30px;
}
.mode-toggle{
  display:grid;
  grid-template-columns:repeat(3,40px);
  flex:0 1 auto;
  min-width:0;
  height:40px;
  border:1px solid var(--btn);
  border-radius:8px;
  overflow:hidden;
}
.mode-toggle button{
  width:40px;
  border:none;
  background:var(--btn);
  color:var(--button-text);
  font-weight:600;
  cursor:pointer;
  transition:background .2s,border-color .2s,color .2s;
  height:100%;
  border-radius:0;
  min-width:0;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:0;
  padding:0;
}
.mode-toggle .mode-icon{
  display:flex;
  align-items:center;
  justify-content:center;
  line-height:0;
  width:100%;
  height:100%;
}
.mode-toggle .mode-label{
  display:none;
  font-size:14px;
  line-height:1;
  white-space:nowrap;
}
.mode-toggle button svg{
  width:20px;
  height:20px;
}
.mode-toggle button + button{
  border-left:1px solid var(--btn);
}
.mode-toggle button[aria-pressed="true"]{
  background:var(--btn-selected);
  color:var(--button-active-text);
}
@media (min-width: 601px){
  .mode-toggle{
    grid-template-columns:repeat(3, auto);
  }
  .mode-toggle button{
    width:auto;
    padding:0 16px;
  }
  .mode-toggle .mode-icon{
    display:none;
  }
  .mode-toggle .mode-label{
    display:block;
  }
}
body.filters-active #filterBtn{
  background: var(--filter-active-color);
  border-color: var(--filter-active-color);
  }

.options-dropdown{ position:relative; }
.options-menu{ position:absolute; top:calc(100% + 4px); left:0; background:var(--dropdown-bg); color:var(--dropdown-text); border:1px solid var(--border); border-radius:var(--dropdown-radius); padding:10px; display:flex; flex-direction:column; gap:6px;  z-index:30; }
.options-menu[hidden]{ display:none; }
.options-menu label{ display:flex; align-items:center; gap:6px; white-space:nowrap; }

.card,
.recents-card,
.post-card{
  display: grid;
  grid-template-columns:90px 1fr 36px;
  gap:12px;
  align-items: flex-start;
  background-color: transparent;
  border: none;
  border-radius:8px;
  padding:12px;
  margin-bottom:12px;
  cursor:pointer;
}

.post-card{
  border:none;
  border-radius:8px;
  padding-top:10px;
  margin-top:10px;
}

.thumb{
  width: 90px;
  height: 70px;
  border-radius: 8px;
  object-fit: cover;
  display: block;
  background: var(--panel-bg);
  transition: filter .22s ease;
}

.thumb.lqip{
  filter: none;
}

.meta{
  display: flex;
  flex-direction: column;
  gap: 6px;
  min-width: 0;
}

.title{
  margin: 0;
  font-weight: bold;
  font-size: 16px;
  line-height: 1.2;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  line-clamp: 2;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

.info{
  display: flex;
  gap: 16px;
  align-items: center;
  min-width: 0;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

.quick-list-board .info{
  flex-direction: column;
  align-items: flex-start;
  gap: 4px;
  font-size: 13px;
}

.post-board .info{
  flex-direction: column;
  align-items: flex-start;
  gap: 4px;
  font-size: 13px;
}

.quick-list-board .info > div{
  display: flex;
  align-items: center;
  gap: 0;
}

.post-board .info > div{
  display: flex;
  align-items: center;
  gap: 0;
}

.badge{
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  padding-right: 5px;
  border: 0;
  border-radius: 0;
  width: auto;
  height: auto;
  line-height: 1;
}

.info > div > :not(.badge) + *{
  margin-left: 5px;
}

.fav{
  width: 36px;
  height: 36px;
  border-radius: 8px;
  display: grid;
  place-items: center;
  background: var(--btn);
  border: 1px solid var(--btn);
}

.fav svg{
  width: 18px;
  height: 18px;
  fill: none;
  stroke: var(--gold);
  stroke-width: 1.5;
}

.fav[aria-pressed="true"] svg{
  fill: var(--gold);
  stroke: var(--gold);
}

.share{
  width: 36px;
  height: 36px;
  border-radius: 8px;
  display: grid;
  place-items: center;
  background: var(--btn);
  border: 1px solid var(--btn);
  margin-left: auto;
}

.share svg{
  width: 18px;
  height: 18px;
  fill: var(--button-text);
}

#favToggle{
  white-space:nowrap;
}
#favToggle svg{
  width:18px;
  height:18px;
  fill:none;
  stroke:var(--gold);
  stroke-width:1.5;
  vertical-align:middle;
  margin-left:6px;
}
#favToggle[aria-pressed="true"] svg{
  fill:var(--gold);
  stroke:var(--gold);
}

#map{
  position: absolute;
  inset: 0;
}

.map-overlay{
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
  display: grid;
  place-items: center;
  color: #fff;
  font-weight: 700;
  letter-spacing: .5px;
  opacity: .15;
  pointer-events: none;
}

.map-zoom-indicator{
  position:absolute;
  bottom:calc(var(--safe-bottom, 0px) + 20px);
  left:50%;
  transform:translateX(-50%);
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:6px 12px;
  border-radius:999px;
  background:rgba(0, 0, 0, 0.7);
  color:#fff;
  font-size:12px;
  font-weight:600;
  letter-spacing:.3px;
  line-height:1;
  pointer-events:none;
  z-index:5;
  min-width:72px;
  text-align:center;
}

.map-control-row{
  display:flex;
  align-items:center;
  gap:var(--gap);
  flex-wrap:nowrap;
}
.map-control-row .geocoder{
  background-color:#ffffff;
  border-radius:8px;
  flex:1 1 240px;
  min-width:0;
  width:100%;
  max-width:360px;
  display:flex;
}
#filterPanel .map-control-row .geocoder,
#filterPanel .map-control-row .mapboxgl-ctrl-geocoder,
#filterPanel .map-control-row .mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--input{
  background-color:#ffffff;
  color:#000000;
}
#memberPanel .map-control-row .mapboxgl-ctrl-geolocate button,
#memberPanel .map-control-row .mapboxgl-ctrl-compass button{
  background-color:#ffffff !important;
  background-image:none !important;
  box-shadow:none !important;
}
#memberPanel .map-control-row .mapboxgl-ctrl-geolocate button svg,
#memberPanel .map-control-row .mapboxgl-ctrl-compass button svg{
  filter:none !important;
}
.map-control-row .mapboxgl-ctrl-geolocate button,
.map-control-row .mapboxgl-ctrl-compass button{
  width:35px;
  height:35px;
  border-radius:8px;
  background-color:#ffffff;
  border:1px solid rgba(0,0,0,0.15);
  box-shadow:none;
}

.mapboxgl-ctrl-geolocate button,
.mapboxgl-ctrl-compass button{
  width:35px !important;
  height:35px !important;
  background-color:#ffffff !important;
  border-radius:8px !important;
  border:1px solid rgba(0,0,0,0.15) !important;
  box-shadow:none !important;
}

.map-control-row .mapboxgl-ctrl-geolocate button:hover,
.map-control-row .mapboxgl-ctrl-compass button:hover{
  background-color:#f2f2f2;
}

.map-control-row .mapboxgl-ctrl-geolocate button svg,
.map-control-row .mapboxgl-ctrl-compass button svg{
  filter:none;
}

.map-control-row .mapboxgl-ctrl-geocoder{
  background:#ffffff;
  border-radius:8px;
  color:#000000;
  display:flex;
  align-items:center;
  gap:0;
  height:var(--geocoder-h);
  min-height:var(--geocoder-h);
  width:100%;
  max-width:100%;
  min-width:0;
}

.map-control-row .mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--input{
  background:#ffffff;
  color:#000000;
  flex:1 1 auto;
  width:100%;
  height:100%;
  padding-top:0;
  padding-bottom:0;
  padding-left:12px;
  padding-right:12px;
  line-height:var(--geocoder-h);
}

.map-control-row .mapboxgl-ctrl-geocoder input.mapboxgl-ctrl-geocoder--input{
  height:100%;
}

.map-control-row .mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--pin-right{
  display:none;
}

.map-control-row .mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--button,
.map-control-row .mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--icon,
.map-control-row .mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--icon-loading,
.map-control-row .mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--icon-search{
  display:none;
}

.panel-body .map-control-row:not(.map-controls-welcome){
  width:100%;
  max-width:100%;
  margin:0;
  justify-content:flex-start;
  background:none;
  border-radius:0;
  padding:0;
  box-sizing:border-box;
}
.panel-body .map-control-row:not(.map-controls-welcome) > *{
  flex:0 0 auto;
  width:auto;
  max-width:none;
  background:transparent;
  border-radius:8px;
  min-width:0;
}
.panel-body .map-control-row:not(.map-controls-welcome) > .geocoder{
  flex:1 1 auto;
}

#welcomeBody .map-control-row{
  justify-content:center;
  width:100%;
  max-width:100%;
  margin:0 auto;
  gap:10px;
  flex-wrap:nowrap;
}
#welcomeBody .map-controls-welcome{
  pointer-events:auto;
}
#welcomeBody .map-control-row > *{
  flex:0 0 auto;
}
#welcomeBody .map-control-row > .geocoder{
  flex:1 1 240px;
  min-width:0;
  width:100%;
  max-width:360px;
}
#welcomeBody .map-control-row .mapboxgl-ctrl-geocoder{
  width:100% !important;
  max-width:360px !important;
  min-width:0 !important;
}
#welcomeBody .map-controls-welcome .mapboxgl-ctrl-geocoder{
  display:flex;
  align-items:center;
  gap:0;
  height:var(--control-h);
}
#welcomeBody .map-controls-welcome .mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--input{
  flex:1 1 auto;
  height:100%;
  padding-top:0;
  padding-bottom:0;
  padding-left:12px;
  padding-right:12px;
  line-height:var(--control-h);
}
#welcomeBody .map-controls-welcome .mapboxgl-ctrl-geocoder,
#welcomeBody .map-controls-welcome .mapboxgl-ctrl-geocoder *,
#welcomeBody .map-controls-welcome .mapboxgl-ctrl-geolocate,
#welcomeBody .map-controls-welcome .mapboxgl-ctrl-geolocate *{
  text-align:left;
}
#welcomeBody .map-controls-welcome .mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--button{
  display:none;
}
#welcomeBody .map-controls-welcome .mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--icon{
  display:none;
}
#welcomeBody .map-control-row .mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--input{
  width:100%;
}

.mode-posts .map-controls-map{display:none;}

.map-controls-map{
  position:absolute;
  left:50%;
  top:calc(var(--header-h) + 10px);
  transform:translateX(-50%);
  width:auto;
  max-width:90vw;
  min-width:0;
  z-index:1;
  flex-wrap:nowrap;
}

.map-controls-map .geocoder{
  flex:1 1 360px;
  min-width:0;
  width:min(100%, 360px);
  max-width:360px;
}

.map-control-row .geocoder{margin:0;}

@media (max-width:600px){
  .map-controls-map{
    flex-wrap:nowrap;
    justify-content:center;
    gap:8px;
  }
  .map-controls-map .geocoder,
  .map-controls-map .mapboxgl-ctrl-geocoder{
    flex:1 1 100%;
    width:100% !important;
    max-width:100% !important;
  }
  #welcomeBody .map-control-row > .geocoder,
  #welcomeBody .map-control-row .mapboxgl-ctrl-geocoder{
    width:100% !important;
    max-width:100% !important;
  }
}

.post-board .posts{
  flex:1 1 auto;
  min-height:0;
  overflow-y:auto;
  overflow-y:overlay;
  overflow-x:hidden;
  padding:0;
  margin:0;
}
.post-board .posts,
.recents-board{
  scrollbar-width:thin;
  scrollbar-color:rgba(255,255,255,0.4) rgba(0,0,0,0);
}
.post-board .posts::-webkit-scrollbar,
.recents-board::-webkit-scrollbar{
  width:8px;
  height:8px;
}
.post-board .posts::-webkit-scrollbar-track,
.recents-board::-webkit-scrollbar-track{
  background-color:rgba(0,0,0,0);
}
.post-board .posts::-webkit-scrollbar-thumb,
.recents-board::-webkit-scrollbar-thumb{
  background-color:rgba(255,255,255,0.4);
  border-radius:999px;
}
.post-board .posts::-webkit-scrollbar-corner,
.recents-board::-webkit-scrollbar-corner{
  background-color:rgba(0,0,0,0);
}
.post-board{color:#fff;}
.post-board .post-card,
.post-board .open-post{
  background-color:transparent;
  margin:0;
  border:none;
  border-radius:0;
  border-bottom:1px solid rgba(255,255,255,0.12);
}
.post-board .post-card:last-child,
.post-board .open-post:last-child{border-bottom:none;}
.post-board > *:last-child{margin-bottom:0 !important;}
.post-board .post-card .thumb{border-radius:8px;}
.post-board button{background:var(--btn);border-color:var(--btn);color:var(--ink);}

.post-board-empty{
  padding:20px 16px;
  text-align:center;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:0;
}

.post-board-empty-summary{
  margin:0 0 10px;
  width:100%;
  max-width:var(--post-board-max-w);
}

.post-board-empty-image{
  margin-top:10px;
  width:auto;
  max-width:100%;
  height:auto;
  border-radius:8px;
}

.post-board-empty-message{
  margin:10px 0 0;
}

.recents-board-reminder{
  margin:10px 0 20px;
  padding:0 12px;
  text-align:center;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;
}

.recents-board-reminder img{
  max-width:100%;
  height:auto;
  border-radius:8px;
}

.recents-board-reminder p{
  margin:0;
}

body.mode-posts .post-board,
body.mode-map .post-board{
  z-index:1;
}
.map-area{
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 0;
}

.open-post{
  border:none;
  border-radius:0;
  margin:0;
  padding-top:0;
  overflow:visible;
  color:#fff;
  font-size:14px;
  display:flex;
  flex-direction:column;
  gap:0;
  position:relative;
}

.open-post .post-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px;
  opacity:1;
  border-top-left-radius:inherit;
  border-top-right-radius:inherit;
  position:sticky;
  top:0;
  z-index:3;
  background:transparent;
  pointer-events:none;
}
.open-post .post-header button,
.open-post .post-header [role="button"],
.open-post .post-header a{
  pointer-events:auto;
}
.post-card .post-header{
  background-color:transparent;
}
.open-post .post-header .share{margin-left:auto;margin-right:var(--gap);}

.open-post .post-body{
  padding:0 0 10px;
  display:flex;
  flex-direction:row;
  flex-wrap:wrap;
  gap:var(--gap);
  align-items:flex-start;
  align-content:flex-start;
}
.open-post .post-body > .main-post-column{
  flex:0 0 var(--post-board-max-w);
  max-width:var(--post-board-max-w);
  width:var(--post-board-max-w);
}
.open-post .post-body > .second-post-column{
  flex:1 1 100%;
  max-width:100%;
  width:100%;
}

.open-post .post-details{
  margin-top:0;
  width:calc(100% - 20px);
  max-width:calc(100% - 20px);
  min-width:0;
  display:flex;
  flex-direction:column;
  gap:var(--gap);
  padding:10px 0;
  flex:1 1 auto;
  box-sizing:border-box;
  margin-left:auto;
  margin-right:auto;
}

.open-post:not(.desc-expanded) .post-venue-selection-container,
.open-post:not(.desc-expanded) .post-session-selection-container,
.open-post:not(.desc-expanded) .location-section,
.open-post:not(.desc-expanded) .post-details-info-container,
.open-post:not(.desc-expanded) .member-avatar-row{
  display:none;
}

.open-post .post-details .info{
  color: inherit;
  font-size: inherit;
}

.open-post .post-images{
  display:flex;
  flex-direction:column;
  gap:5px;
  width:100%;
  max-width:var(--post-board-max-w);
  flex:0 0 100%;
  box-sizing:border-box;
  margin:0 auto;
  align-self:center;
}

.open-post.desc-expanded .post-images,
body.open-post-sticky-images .open-post.desc-expanded .post-images{
  position:static;
}

.open-post.desc-expanded .post-images{
  margin-top:var(--gap);
}

.open-post-sticky-images .open-post .post-images{
  position:sticky;
  top:var(--open-post-header-h,0px);
  align-self:start;
}

.open-post .image-box{
  width:100%;
  max-width:100%;
  aspect-ratio:1/1;
  height:auto;
  min-height:0;
  overflow:hidden;
  border:none;
  border-radius:0;
  flex-shrink:0;
  cursor:pointer;
  background: rgba(0,0,0,0);
  position:relative;
}

.open-post .image-box .image-track{
  display:flex;
  width:100%;
  height:100%;
  gap:0;
  align-items:stretch;
  transition:transform 0.35s ease;
  will-change:transform;
  touch-action: pan-y;
}

.open-post .image-box img{
  width:100%;
  height:100%;
  aspect-ratio:1/1;
  object-fit:cover;
  object-position:center;
  display:block;
  flex:0 0 100%;
}
.open-post .image-box img.ready{
  object-fit:cover;
}

.open-post .thumbnail-row{
  position:relative;
}

.open-post .thumbnail-row img{
  width:50px;
  height:50px;
  object-fit:cover;
  object-position:center;
  aspect-ratio:1/1;
  border:1px solid var(--border);
  border-radius:8px;
  cursor:pointer;
  position:relative;
  z-index:1;
}

@media (max-width: 440px){
  .post-board .posts{padding:0;}
  .post-board .post-card{
    grid-template-columns:80px 1fr 36px;
    gap:12px;
    padding:12px;
    margin:10px 0 12px;
    border-radius:0;
  }
  .post-board .post-card .thumb{
    width:80px;
    height:80px;
  }
  .post-board .post-card .meta{padding:0;}
  .open-post{
    margin:10px 0 12px;
  }
  .post-board .post-card:last-child,
  .post-board .open-post:last-child{
    margin-bottom:0;
  }
  .open-post .post-body{
    padding:0;
  }
  .open-post .post-header{
    padding:10px;
  }
  .open-post .post-images,
  .open-post .venue-dropdown,
  .open-post .session-dropdown,
  .open-post .post-details{
    margin-bottom:var(--gap);
  }
  .open-post .post-details{
    margin-bottom:0;
  }
  .open-post .post-images{
    flex:1 1 100%;
    width:100%;
  }
  .open-post .image-box{
    width:100%;
    max-width:100%;
    aspect-ratio:1/1;
    height:auto;
    margin:0;
    border-radius:0;
    position:relative;
    overflow:hidden;
  }
  .open-post .image-box .image-track{
    display:flex;
    width:100%;
    height:100%;
    gap:0;
    align-items:stretch;
    transition:transform 0.35s ease;
    will-change:transform;
    touch-action: pan-y;
  }
  .open-post .image-box img{
    width:100%;
    height:100%;
    aspect-ratio:1/1;
    object-fit:cover;
    object-position:center;
    flex:0 0 100%;
  }
  .open-post .thumbnail-row{
    width:100%;
    max-width:100%;
  }
  .open-post .venue-dropdown,
  .open-post .session-dropdown{
    width:100%;
    max-width:100%;
    padding:0;
  }
  .second-post-column .venue-dropdown,
  .second-post-column .session-dropdown{
    width:100%;
    max-width:100%;
    padding:0;
  }
  .open-post .venue-dropdown,
  .open-post .session-dropdown,
  .second-post-column .venue-dropdown,
  .second-post-column .session-dropdown{
    min-width:0;
    width:100%;
    max-width:100%;
  }
}

.open-post .post-header .title{
  margin:0;
  font-size:16px;
  font-weight:bold;
  line-height:1.2;
  color:#fff;
}

.open-post .post-header .title-block{
  display:flex;
  flex-direction:column;
}

.open-post .post-header .cat-line{
  font-size:14px;
  margin-top:4px;
  display:flex;
  align-items:center;
}

.open-post .meta{
  font-size:14px;
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}

.open-post .member-avatar-row,
.second-post-column .member-avatar-row{
  display:none;
  align-items:center;
  height:50px;
  gap:10px;
  margin:var(--gap) 0 0;
}
.open-post.desc-expanded .member-avatar-row,
.open-post.desc-expanded .second-post-column .member-avatar-row{
  display:flex;
}
.open-post .member-avatar-row img,
.second-post-column .member-avatar-row img{
  width:50px;
  height:50px;
  object-fit:cover;
}

.open-post .member-avatar-row span,
.second-post-column .member-avatar-row span{
  padding-left:10px;
}

.second-post-column .desc-wrap{
  width:100%;
}

.second-post-column .desc{
  display:-webkit-box;
  -webkit-line-clamp:2;
  line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
  text-overflow:ellipsis;
  cursor:pointer;
  white-space:normal;
}

.second-post-column .desc:focus{
  outline:none;
}

.second-post-column .desc.expanded{
  display:block;
  -webkit-line-clamp:unset;
  line-clamp:unset;
  overflow:visible;
  text-overflow:unset;
}

.open-post .location-section,
.second-post-column .location-section{
  display:flex;
  flex-direction:column;
  gap:var(--gap);
  margin:0;
}

.open-post .venue-dropdown,
.open-post .session-dropdown,
.second-post-column .venue-dropdown,
.second-post-column .session-dropdown{
  position:relative;
  width:100%;
  max-width:100%;
  min-width:0;
}

.venue-options,
.session-options{
  display:flex;
  flex-direction:column;
  gap:var(--gap);
  width:100%;
  flex:1 1 auto;
  max-height:250px;
  overflow-y:auto;
}

.open-post .post-venue-menu .map-container,
.second-post-column .post-venue-menu .map-container{
  position:relative;
  width:100%;
  border-radius:8px;
  overflow:hidden;
  background:var(--dropdown-bg);
  min-height:200px;
  flex:0 0 auto;
}

.open-post .post-venue-menu .post-map,
.second-post-column .post-venue-menu .post-map{
  width:100%;
  height:200px;
  min-height:200px;
  border:none;
  border-radius:8px;
}

.post-map{
  border-radius:8px;
}

.open-post .venue-dropdown > button,
.second-post-column .venue-dropdown > button{
  height:50px;
  background:var(--btn);
  border:1px solid var(--btn);
  border-radius:var(--dropdown-radius);
  text-align:left;
  padding:2px 8px;
  color:var(--button-text);
  display:inline-flex;
  flex-direction:column;
  align-items:flex-start;
  justify-content:center;
  width:100%;
}

.open-post .session-dropdown > button,
.second-post-column .session-dropdown > button{
  height:50px;
  background:var(--btn);
  border:1px solid var(--btn);
  border-radius:var(--dropdown-radius);
  text-align:left;
  padding:2px 8px;
  color:var(--button-text);
  display:inline-flex;
  align-items:center;
  justify-content:flex-start;
  width:100%;
}

.open-post .venue-dropdown > button .venue-name,
.second-post-column .venue-dropdown > button .venue-name{
  font-weight:bold;
  display:block;
}

.open-post .venue-dropdown > button .venue-address,
.second-post-column .venue-dropdown > button .venue-address{
  display:block;
}

.open-post .post-venue-menu .venue-options button .venue-name,
.second-post-column .post-venue-menu .venue-options button .venue-name{
  font-weight:bold;
  display:block;
}

.open-post .post-venue-menu .venue-options button .venue-address,
.second-post-column .post-venue-menu .venue-options button .venue-address{
  display:block;
}

.open-post .venue-dropdown > button .venue-name,
.second-post-column .venue-dropdown > button .venue-name,
.open-post .venue-dropdown > button .venue-address,
.second-post-column .venue-dropdown > button .venue-address,
.open-post .post-venue-menu .venue-options button .venue-name,
.second-post-column .post-venue-menu .venue-options button .venue-name,
.open-post .post-venue-menu .venue-options button .venue-address,
.second-post-column .post-venue-menu .venue-options button .venue-address{
  line-height:1.2;
}

.open-post .post-venue-menu,
.open-post .session-menu,
.second-post-column .post-venue-menu,
.second-post-column .session-menu{
  position:absolute;
  top:calc(100% + 4px);
  left:0;
  width:100%;
  min-width:0;
  box-sizing:border-box;
  max-width:100%;
  max-height:min(80vh, calc(100vh - (var(--header-h) + var(--safe-top) + 20px)));
  overflow:auto;
  background:var(--dropdown-bg);
  border:1px solid var(--border);
  border-radius:var(--dropdown-radius);
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:10px;
  z-index:30;
}
.open-post .post-venue-menu,
.open-post .session-menu{
  max-width:100%;
}
.second-post-column .post-venue-menu,
.second-post-column .session-menu{
  max-width:100%;
}

.open-post .post-venue-menu[hidden],
.open-post .session-menu[hidden],
.second-post-column .post-venue-menu[hidden],
.second-post-column .session-menu[hidden]{display:none;}

.open-post .post-venue-menu .venue-options button,
.second-post-column .post-venue-menu .venue-options button{
  height:50px;
  background:var(--btn);
  border:1px solid var(--btn);
  border-radius:var(--dropdown-radius);
  text-align:left;
  padding:4px 8px;
  color:var(--button-text);
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  justify-content:center;
  width:100%;
}

.open-post .session-menu button,
.second-post-column .session-menu button{
  height:50px;
  background:var(--btn);
  border:1px solid var(--btn);
  border-radius:var(--dropdown-radius);
  text-align:left;
  padding:4px 8px;
  color:var(--button-text);
  display:flex;
  align-items:center;
  justify-content:flex-start;
}

.open-post .post-venue-menu,
.open-post .session-menu,
.second-post-column .post-venue-menu,
.second-post-column .session-menu,
.sort-options{
  --button-selected-bg: #2e3a72;
  --button-selected-border: #2e3a72;
  --button-selected-text: var(--button-active-text);
  --button-selected-hover: #2e3a72;
  --button-selected-hover-border: #2e3a72;
  --button-selected-hover-text: var(--button-active-text);
  --button-selected-active: #2e3a72;
  --button-selected-active-border: #2e3a72;
  --button-selected-active-text: var(--button-active-text);
}

.open-post .post-venue-menu .venue-options button.selected,
.open-post .session-menu button.selected,
.second-post-column .post-venue-menu .venue-options button.selected,
.second-post-column .session-menu button.selected{
  background:#2e3a72;
  color:var(--button-active-text);
  border-color:#2e3a72;
}

.open-post .session-menu button .session-time,
.second-post-column .session-menu button .session-time{
  margin-left:auto;
  padding-right:20px;
}
.open-post .session-dropdown > button .session-time,
.second-post-column .session-dropdown > button .session-time{
  margin-left:auto;
  padding-right:20px;
}

.open-post .location-section .post-venue-menu,
.second-post-column .location-section .post-venue-menu{
  width:100%;
  box-sizing:border-box;
}

.hide-map-calendar .open-post .map-container,
.hide-map-calendar .open-post .calendar-container,
.hide-map-calendar .second-post-column .map-container,
.hide-map-calendar .second-post-column .calendar-container{
  display:none;
}

.open-post .post-calendar,
.second-post-column .post-calendar,
.second-post-column .post-calendar{
  position:relative;
  font-size:var(--panel-label-size);
  min-width:var(--calendar-width);
  width:max-content;
}

.open-post .session-menu .calendar-container,
.second-post-column .session-menu .calendar-container{
  display:flex;
  flex-direction:column;
  gap:var(--gap);
  position:relative;
  width:100%;
  min-width:0;
  height:auto;
  border-radius:8px;
  overflow:hidden;
  background:var(--dropdown-bg);
  min-height:200px;
  flex:0 0 auto;
}

.open-post .calendar-container .calendar-scroll,
.second-post-column .calendar-container .calendar-scroll{
  width:100%;
  min-height:var(--calendar-height);
  height:auto;
  max-height:none;
  display:flex;
  align-items:stretch;
  overflow-x:auto;
  overflow-y:hidden;
  padding-bottom:var(--scrollbar-h);
  box-sizing:content-box;
  background:var(--dropdown-bg);
  border:none;
  border-radius:8px;
  display:flex;
  align-items:stretch;
  flex:1 1 auto;
  max-width:100%;
  margin-bottom:0;
  scrollbar-gutter: stable both-edges;
}
.open-post .post-calendar .calendar,
.second-post-column .post-calendar .calendar,
.second-post-column .post-calendar .calendar{
  margin:0;
  box-sizing:border-box;
  display:flex;
  flex-direction:row;
  align-items:flex-start;
  width:max-content;
  height:var(--calendar-height);
  transform:scale(var(--calendar-scale));
  transform-origin:top left;
  background:var(--dropdown-bg);
  color:var(--dropdown-text);
  font-size:inherit;
}
.open-post .post-calendar .month,
.second-post-column .post-calendar .month,
.second-post-column .post-calendar .month{
  flex:0 0 auto;
  width:var(--calendar-width);
  min-width:var(--calendar-width);
  height:var(--calendar-height);
  display:flex;
  flex-direction:column;
}
.open-post .post-calendar .month:not(:first-child),
.second-post-column .post-calendar .month:not(:first-child),
.second-post-column .post-calendar .month:not(:first-child){
  border-left:1px solid var(--calendar-past-bg);
}
.open-post .post-calendar .grid,
.second-post-column .post-calendar .grid,
.second-post-column .post-calendar .grid{
  flex:1 1 auto;
  width:100%;
  height:calc(var(--calendar-height) - var(--calendar-header-h));
  display:grid;
  grid-template-columns:repeat(7,var(--calendar-cell-w));
  grid-template-rows:repeat(7,var(--calendar-cell-h));
}
.open-post .post-calendar .calendar-header,
.second-post-column .post-calendar .calendar-header,
.second-post-column .post-calendar .calendar-header{
  height:var(--calendar-header-h);
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  font-weight:bold;
  line-height:var(--calendar-header-h);
  background:#2e3a72;
  color:#fff;
  font-size:inherit;
}
.open-post .post-calendar .weekday,
.open-post .post-calendar .day,
.second-post-column .post-calendar .weekday,
.second-post-column .post-calendar .day,
.second-post-column .post-calendar .weekday,
.second-post-column .post-calendar .day{
  width:var(--calendar-cell-w);
  height:var(--calendar-cell-h);
  line-height:var(--calendar-cell-h);
  text-align:center;
  font-size:inherit;
}
.open-post .post-calendar .weekday,
.second-post-column .post-calendar .weekday,
.second-post-column .post-calendar .weekday{
  font-weight:bold;
  color:var(--dropdown-text);
}
.open-post .post-calendar .day,
.second-post-column .post-calendar .day,
.second-post-column .post-calendar .day{
  cursor:pointer;
  background:var(--calendar-future-bg);
  color:var(--dropdown-text);
  transition:background .2s,color .2s;
}
.open-post .post-calendar .day.empty,
.second-post-column .post-calendar .day.empty,
.second-post-column .post-calendar .day.empty{
  cursor:default;
  background:var(--calendar-future-bg);
  color:var(--dropdown-text);
  opacity:0.6;
}
.open-post .post-calendar .day.available-day,
.second-post-column .post-calendar .day.available-day,
.second-post-column .post-calendar .day.available-day{
  background:var(--session-available);
  color:#fff;
}
.open-post .post-calendar .day.available-day:hover,
.second-post-column .post-calendar .day.available-day:hover,
.second-post-column .post-calendar .day.available-day:hover{
  background:var(--session-available);
  color:#fff;
}
.open-post .post-calendar .day.selected,
.second-post-column .post-calendar .day.selected,
.second-post-column .post-calendar .day.selected{
  background:var(--session-selected);
  color:#fff;
}
.open-post .post-calendar .day.selected:hover,
.second-post-column .post-calendar .day.selected:hover,
.second-post-column .post-calendar .day.selected:hover{
  background:var(--session-selected);
  color:#fff;
}
.open-post .post-calendar .day.today,
.second-post-column .post-calendar .day.today,
.second-post-column .post-calendar .day.today{color:var(--today) !important;}
.open-post .post-calendar .day.available-day.today,
.open-post .post-calendar .day.available-day.selected.today,
.open-post .post-calendar .day.selected.today,
.second-post-column .post-calendar .day.available-day.today,
.second-post-column .post-calendar .day.available-day.selected.today,
.second-post-column .post-calendar .day.selected.today,
.second-post-column .post-calendar .day.available-day.today,
.second-post-column .post-calendar .day.available-day.selected.today,
.second-post-column .post-calendar .day.selected.today{color:var(--today) !important;}

.open-post .post-calendar .selected-month-name,
.second-post-column .post-calendar .selected-month-name,
.second-post-column .post-calendar .selected-month-name{
  background:var(--accent);
  color:var(--button-hover-text);
  border-radius:8px;
  padding:0 4px;
}

.open-post .calendar-container .time-popup,
.second-post-column .calendar-container .time-popup{
  position:absolute;
  z-index:10;
}

.open-post .calendar-container .time-popup .time-list,
.second-post-column .calendar-container .time-popup .time-list{
  background:var(--dropdown-bg);
  color:var(--dropdown-text);
  padding:8px;
  border-radius:8px;
  display:flex;
  flex-direction:column;
  gap:4px;
   }

.open-post .calendar-container .time-popup .time-list button,
.second-post-column .calendar-container .time-popup .time-list button{
  background:var(--btn);
  border:1px solid var(--btn);
  color:var(--button-text);
  border-radius:8px;
  padding:6px 10px;
  cursor:pointer;
}

.open-post .venue-info,
.open-post .session-info,
.second-post-column .venue-info,
.second-post-column .session-info{
  color: inherit;
  font-size: inherit;
}
.open-post .venue-info,
.second-post-column .venue-info{margin-top:4px;}
.open-post .session-info,
.second-post-column .session-info{margin-top:8px;}

.pill{
  border: 1px solid var(--btn);
  background: var(--btn);
  border-radius: 999px;
  padding: 8px 12px;
  font-weight: 700;
  cursor: pointer;
}

.close{
  border: 0;
  background: #16283f;
  border-radius: 8px;
  padding: 8px 12px;
  cursor: pointer;
}

.dates{
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 4px;
}

.date{
  background: var(--btn);
  border: 1px solid var(--btn);
  border-radius: 999px;
  padding: 6px 10px;
  font-size: 14px;
}

.desc{
  margin-top:8px;
  cursor:pointer;
  font-size:14px;
}

@media (max-width:440px){
  html{
    touch-action:pan-x pan-y;
  }
  .map-container{
    touch-action:auto;
  }
}

@media (max-width:440px){
  .post-mode-boards{
    top:calc(var(--header-h) + var(--safe-top));
    bottom:var(--footer-h);
    padding:0;
    gap:0;
    flex-direction:column;
    align-items:flex-start;
  }
  .quick-list-board,
  .post-board,
  .recents-board{
    width:100%;
    max-width:100%;
    left:0;
    right:0;
    padding:0;
    border-radius:0;
    flex:0 0 auto;
    min-height:0;
    height:auto;
    max-height:100%;
  }
  .quick-list-board{
    position:relative;
    top:0;
    bottom:auto;
  }
  .panel-content{
    top:calc(var(--header-h) + var(--safe-top));
    bottom:var(--footer-h);
    height:calc(100vh - var(--header-h) - var(--safe-top) - var(--footer-h));
    min-height:0;
  }
  .card,
  .recents-card,
  .post-card{
    margin:0;
    border-radius:0;
    padding:12px;
  }
  .post-board .post-card,
  .recents-board .recents-card{
    margin:0;
    border-radius:0;
  }
  .thumb,
  .recents-card .thumb{
    border-radius:0;
  }
  .post-card .thumb{
    border-radius:8px;
  }
  .post-board .post-card,
  .recents-board .recents-card{
    border-bottom:1px solid rgba(255,255,255,0.12);
  }
  .post-board .post-card:last-child,
  .recents-board .recents-card:last-child{
    border-bottom:none;
  }
  .panel-content{
    left:0 !important;
    right:0 !important;
    top:calc(var(--header-h) + var(--safe-top));
    bottom:var(--footer-h);
    width:100% !important;
    max-width:100% !important;
    height:calc(100vh - var(--header-h) - var(--safe-top) - var(--footer-h));
    max-height:calc(100vh - var(--header-h) - var(--safe-top) - var(--footer-h));
    border-radius:0;
  }
  .panel-body{
    padding:10px;
    align-items:stretch;
  }
  .panel-body > *{
    max-width:100%;
  }
  #filterPanel .panel-body{
    padding:10px;
  }
  #filterPanel .panel-body > *{
    max-width:100%;
  }
  .post-details-description-container .desc-wrap{
    margin:10px 0 0;
  }
  .open-post:not(.desc-expanded) .post-details-description-container .desc-wrap{
    margin-top:0;
  }
  .post-details-description-container .desc{
    margin:0;
  }
  .post-details-description-container .desc[aria-expanded="false"]{
    display:-webkit-box;
    -webkit-line-clamp:2;
    line-clamp:2;
    -webkit-box-orient:vertical;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .post-details-description-container .desc[aria-expanded="true"],
  .post-details-description-container .desc.expanded{
    display:block;
  }
  .post-images{
    margin-top:10px;
  }
  .open-post .image-box{
    width:100%;
    max-width:100%;
    aspect-ratio:1/1;
    margin:0;
    border-radius:0;
    display:block;
    overflow:hidden;
    position:relative;
  }
  .open-post .image-box .image-track{
    display:flex;
    width:100%;
    height:100%;
    gap:0;
    align-items:stretch;
    transition:transform 0.35s ease;
    will-change:transform;
    touch-action: pan-y;
  }
  .open-post .image-box img{
    border-radius:0;
    width:100%;
    height:100%;
    aspect-ratio:1/1;
    object-fit:cover;
    display:block;
    flex:0 0 100%;
  }
  .open-post .thumbnail-row img{
    width:60px;
    height:60px;
    border-radius:8px;
  }
}

@media (max-width:440px){
  .open-post .post-body{
    flex-direction:column;
    gap:var(--gap);
  }
  .open-post .post-body > .main-post-column,
  .open-post .post-body > .second-post-column{
    flex:1 1 100%;
    max-width:100%;
    width:100%;
  }
  .open-post .location-section,
  .second-post-column .location-section{
    flex-direction:column;
  }
  .open-post .post-details .location-section,
  .second-post-column .post-details .location-section{
    order:-1;
  }
  .open-post .image-box{
    max-width:100%;
    width:100%;
    aspect-ratio:1/1;
    height:auto;
    display:block;
    position:relative;
    overflow:hidden;
  }
    .open-post .image-box .image-track{
      display:flex;
      width:100%;
      height:100%;
      gap:0;
      align-items:stretch;
      transition:transform 0.35s ease;
      will-change:transform;
      touch-action: pan-y;
    }
    .open-post .image-box img{
      width:100%;
      height:100%;
      aspect-ratio:1/1;
      flex:0 0 100%;
    }
  .open-post .venue-dropdown,
  .open-post .session-dropdown,
  .second-post-column .venue-dropdown,
  .second-post-column .session-dropdown{
    display:block;
  }
}

  @media (max-width:440px){
    .post-board,
    .post-board .post-card,
    .open-post{
      width:100%;
      max-width:100%;
      border:none;
      border-radius:0;
    }
    .post-board,
    .open-post{
      min-width:0;
    }
    .open-post .image-box{
      width:100%;
      max-width:100%;
      aspect-ratio:1/1;
      height:auto;
      max-height:none;
      margin:0;
      padding:0;
      border:none;
      border-radius:0;
      display:block;
      overflow:hidden;
      position:relative;
    }
    .open-post .image-box .image-track{
      display:flex;
      width:100%;
      height:100%;
      gap:0;
      align-items:stretch;
      transition:transform 0.35s ease;
      will-change:transform;
      touch-action: pan-y;
    }
    .open-post .image-box img{
      width:100%;
      height:100%;
      object-fit:cover;
      margin:0;
      border-radius:0;
      aspect-ratio:1/1;
      flex:0 0 100%;
    }
    .open-post .post-body{
      padding:0;
      gap:0;
    }
    .open-post .post-details{
      padding:10px 0;
    }
  }

@media (max-width:440px){
  .open-post .venue-dropdown > button,
  .open-post .session-dropdown > button{
    height:50px;
  }
}

  .fullscreen-btn{
    width:35px;
    height:35px;
    padding:0;
    flex:0 0 auto;
  }

  .copy-msg{ 
    position:absolute;
    background:rgba(0,0,0,0.8);
    color:#fff;
    padding:4px 8px;
    border-radius:8px;
    opacity:0;
    transition:opacity .3s;
    pointer-events:none;
  }
  .copy-msg.show{opacity:1;}

  .image-modal-container{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.7);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:3000;
  }
  .image-modal-container.hidden{display:none;}
  .image-modal-container .image-modal img{
    max-width:90vw;
    max-height:90vh;
    display:block;
  }

  #post-modal-container{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.7);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:3000;
  }
  #post-modal-container.hidden{display:none;}
    #post-modal-container .post-modal{
      width:880px;
    max-width:100%;
    height:90%;
    overflow:auto;
    overflow:overlay;
    background:var(--list-background);
    border-radius:8px;
  }
    @media (max-width:440px){
      #post-modal-container .post-modal{width:440px;}
    }
    @media (max-width:440px){
      #post-modal-container .post-modal{width:100%;min-width:0;}
    }

  .chip-small{
  flex: 0 0 auto;
  max-width: 240px;
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--btn);
  border-radius: 8px;
  padding: 6px 10px;
  font-size: 14px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  cursor: pointer;
}

.chip-small img.mini{
  width: 26px;
  height: 20px;
  border-radius: 8px;
  object-fit: cover;
  flex: 0 0 auto;
  display: block;
  background: var(--btn);
}

.chip-small .t{
  overflow: hidden;
  text-overflow: ellipsis;
}

.card .thumb,
.recents-card .thumb,
.post-card .thumb{
  flex: 0 0 80px;
  width: 80px;
  height: 80px;
  display: block;
  object-fit: cover;
  border-radius: 8px;
}

.card .meta,
.recents-card .meta,
.post-card .meta{
  flex: 1 1 auto;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.post-card,
.post-card *,
.recents-card,
.recents-card *{
  cursor: pointer;
}

.card .fav,
.recents-card .fav,
.post-card .fav{
  flex: 0 0 auto;
}

.recents-card[aria-selected="true"]{
  position:relative;
  z-index:0;
  background:none;
}

.recents-card[aria-selected="true"]::before{
  content:"";
  position:absolute;
  inset:0;
  background-color:#2e3a72;
  border-radius:8px;
  z-index:-1;
}

.multi-head{
  margin: 0 0 8px 0;
  font-size: 13px;
  color: #fff !important;
  font-weight: 600;
  line-height: 1.3;
  letter-spacing: 0;
  text-align: left;
}
.multi-head-line{
  display: block;
}
.multi-head-line + .multi-head-line{
  font-weight: 400;
}
.multi-head .soonest{
  font-weight: 400;
}

.multi-list{
  max-height: 360px;
  overflow-y: auto;
  overflow-y: overlay;
  overflow-x: hidden;
  padding: 2px 6px 2px 2px;
  box-sizing: border-box;
}

.map-card--popup,
.map-card--list{
  pointer-events: auto;
  cursor: pointer;
}
.map-card--popup{
  display: block;
}

.map-card-list{
  max-height: 360px;
  overflow-y: auto;
  overflow-y: overlay;
  overflow-x: hidden;
  padding: 2px 6px 2px 2px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.map-card-list-item{
  padding: 5px;
  border-radius: 8px;
  cursor: pointer;
  min-width: 0;
  box-sizing: border-box;
}

.mapboxgl-popup,
.mapboxgl-popup-content{
  border-radius:8px !important;
}

.mapboxgl-popup-content{
  background: var(--popup-bg) !important;
  color: var(--popup-text) !important;
  overflow:hidden;
}

.mapboxgl-popup.map-card .mapboxgl-popup-content{
  overflow: visible;
}

.mapboxgl-popup-close-button{
  color: var(--popup-text) !important;
}

.multi-ctrls{
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  margin-top: 8px;
}

.multi-ctrls .hint{
  font-size: 14px;
  color: var(--ink-d);
}

.multi-ctrls .close{
  border: 0;
  background: #16283f;
  color: #fff;
  border-radius: 8px;
  padding: 6px 10px;
  cursor: pointer;
}

.nowrap{
  white-space: nowrap;
}

.multi-hover .soonest{
  color: var(--ink-d);
  font-weight: 400;
  opacity: 0.85;
}

@media (max-width:600px){
  .mapboxgl-popup.map-card .multi-hover,
  .mapboxgl-popup.map-card .map-card-list,
  .mapboxgl-popup.map-card .map-card{
    width: 90vw;
    max-width: 90vw;
  }
  .mapboxgl-popup.map-card .map-card--list{
    width: 90vw;
    max-width: 90vw;
  }
}

.mapboxgl-popup.multi-post-map-card .mapboxgl-popup-content,
.mapboxgl-popup.multi-post-map-card .multi-hover,
.mapboxgl-popup.multi-post-map-card .map-card-list{
  width: 400px;
  max-width: min(400px, calc(100vw - 32px));
  min-width: min(400px, calc(100vw - 32px));
  box-sizing: border-box;
}

.mapboxgl-popup.multi-post-map-card .mapboxgl-popup-content{
  margin-left: auto;
  margin-right: auto;
}

.hero img.lqip{
  filter: blur(10px);
  transform: scale(1.02);
  transition: filter .22s ease, transform .22s ease;
}

.hero img.ready{
  filter: none;
  transform: none;
}

img.thumb{
  width: 80px;
  height: 80px;
  object-fit: cover;
  border-radius: 8px;
}

#results .recents-card > img, #results .recents-card img.thumb{
  width: 80px;
  height: 80px;
  aspect-ratio: 1/1;
  object-fit: cover;
  display: block;
  border-radius: 8px;
}

.mode-posts #postsWide{
  border: none;
  background: transparent;
}

.mode-posts #postsWide.posts{
  background: transparent;
}

@media (max-width:440px){
  #filterPanel .panel-content{
    top:calc(var(--header-h) + var(--safe-top));
    left:0;
    right:0;
    bottom:var(--footer-h);
    width:100%;
    max-width:none;
    max-height:none;
    border-radius:0;
    padding-bottom:10px;
  }
  #filterPanel .panel-content .resizer{
    display:none;
  }
}

@media (max-width:440px){
  .post-board .posts{
    padding:0;
    margin:0;
  }
  .post-board .post-card{
    width:100%;
    margin:0;
    border-radius:0;
  }
  .post-board .open-post{
    margin:0;
  }
  .open-post{
    width:100%;
    border-radius:0;
    margin:0;
  }
  .open-post .post-images{
    flex:0 0 100%;
    width:100%;
  }
  .open-post .post-details{
    width:calc(100% - 20px);
    max-width:calc(100% - 20px);
    min-width:0;
    padding:10px 0;
    margin-left:auto;
    margin-right:auto;
  }
  .open-post .image-box{
    width:100%;
    max-width:100%;
    aspect-ratio:1/1;
    height:auto;
    flex:0 0 auto;
    border-radius:0;
    display:block;
    position:relative;
    overflow:hidden;
  }
  .open-post .image-box .image-track{
    display:flex;
    width:100%;
    height:100%;
    gap:0;
    align-items:stretch;
    transition:transform 0.35s ease;
    will-change:transform;
    touch-action: pan-y;
  }
  .open-post .image-box img{
    width:100%;
    height:100%;
    object-fit:cover;
    aspect-ratio:1/1;
    flex:0 0 100%;
  }
  .second-post-column{
    width:100%;
    max-width:520px;
    min-width:0;
    flex:0 0 100%;
  }
  .open-post .second-post-column{
    height:auto;
    max-height:none;
    overflow:visible;
  }
  .open-post .second-post-column .post-details{
    height:auto;
  }
}

@media (max-width:440px){
  :root{
    --footer-h:0;
  }
  body.mode-map{
    --footer-h:0;
  }
  #filterPanel .panel-content{
    top:calc(var(--header-h) + var(--safe-top));
    left:0;
    right:0;
  }
  .open-post .post-header{
    padding:10px;
  }
  .open-post .post-body{
    padding:0;
  }
}

</style>
  <style id="cursor-fixes">
    html, body { cursor: auto !important; }
    a, button, [role="button"], .clickable { cursor: pointer !important; }
    .mapboxgl-canvas { cursor: grab; }
    .mapboxgl-canvas:active { cursor: grabbing; }
    * { -webkit-tap-highlight-color: transparent; }
  </style>
  <script>
  // --- tiny scheduler helpers ---
  function rafThrottle(fn){
    let scheduled = false, lastArgs, lastThis;
    return function throttled(...args){
      lastArgs = args; lastThis = this;
      if (scheduled) return;
      scheduled = true;
      requestAnimationFrame(() => { scheduled = false; fn.apply(lastThis, lastArgs); });
    };
  }

  // Prefer idle time, but don't stall forever.
  function scheduleIdle(fn, timeout=200){
    if ('requestIdleCallback' in window) {
      requestIdleCallback(fn, { timeout });
    } else {
      setTimeout(fn, Math.min(timeout, 50));
    }
  }

  function withPassiveDefault(options){
    if(options === undefined){
      return { passive: true };
    }
    if(typeof options === 'boolean'){
      return { capture: options, passive: true };
    }
    if(typeof options === 'object' && options !== null && options.passive === undefined){
      return Object.assign({}, options, { passive: true });
    }
    return options;
  }

  function addPassiveScrollListener(target, listener, options){
    if(!target || typeof target.addEventListener !== 'function') return null;
    const opts = withPassiveDefault(options);
    target.addEventListener('scroll', listener, opts);
    return opts;
  }

  function removeScrollListener(target, listener, options){
    if(!target || typeof target.removeEventListener !== 'function') return;
    let capture = false;
    if(typeof options === 'boolean'){
      capture = options;
    } else if(typeof options === 'object' && options !== null){
      capture = !!options.capture;
    }
    target.removeEventListener('scroll', listener, capture);
  }
  </script>

<script>
if (typeof slugify !== 'function') {
  function slugify(text) {
    return String(text)
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .toLowerCase()
      .trim()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/^-+|-+$/g, '');
  }
}
</script>

<script>
// === 150x40 pill provider (sprite id: marker-label-bg) ===
(function(){
  const PILL_ID = 'marker-label-bg';
  const PILL_IMAGE_URL = 'assets/icons-30/150x40 pill 99.webp';
  let cachedImage = null;
  let loadingImage = null;
  const pendingMaps = new Set();

  function applyImageToMap(map){
    if(!map || typeof map.hasImage !== 'function' || !cachedImage){
      return;
    }
    try{
      if(map.hasImage(PILL_ID)){
        try{ map.removeImage(PILL_ID); }catch(e){}
      }
      map.addImage(PILL_ID, cachedImage, { pixelRatio: 1 });
    }catch(e){ /* silent */ }
  }

  function handleImageLoad(){
    if(!loadingImage){
      return;
    }
    if(loadingImage.complete && loadingImage.naturalWidth > 0){
      cachedImage = loadingImage;
      pendingMaps.forEach((map)=>applyImageToMap(map));
    }
    pendingMaps.clear();
    loadingImage = null;
  }

  function ensureImage(){
    if(cachedImage || loadingImage){
      return;
    }
    loadingImage = new Image();
    try{ loadingImage.crossOrigin = 'anonymous'; }catch(e){}
    loadingImage.decoding = 'async';
    loadingImage.onload = handleImageLoad;
    loadingImage.onerror = handleImageLoad;
    loadingImage.src = PILL_IMAGE_URL;
    if(loadingImage.complete){
      handleImageLoad();
    }
  }

  function addOrReplacePill(map){
    try{
      if(!map || typeof map.hasImage !== 'function'){
        return;
      }
      if(cachedImage){
        applyImageToMap(map);
        return;
      }
      pendingMaps.add(map);
      ensureImage();
    }catch(e){ /* silent */ }
  }

  window.__addOrReplacePill150x40 = addOrReplacePill;
  ensureImage();
})();
</script>
</head>
<body class="mode-map" style="padding-bottom:var(--footer-h);">
  <header class="header" role="banner">
    <div class="logo" aria-label="Site logo">
      <img src="assets/funmap-logo-small.png" alt="FunMap.com logo" />
    </div>
    <nav class="view-toggle" aria-label="Primary" role="tablist">
      <!-- <button id="quickBtn" aria-pressed="false" aria-label="Toggle results list">Quick List</button> -->
      <button id="filterBtn" aria-pressed="false" aria-label="Open filters panel">
        <svg class="icon-search" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <span id="resultCount" aria-live="polite" style="display:none"></span>
      </button>
      <div class="mode-toggle">
        <button id="recents-button" aria-pressed="false" aria-label="Recents">
          <span class="mode-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
          </span>
          <span class="mode-label">Recents</span>
        </button>
        <button id="posts-button" aria-pressed="false" aria-label="Posts">
          <span class="mode-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="5" y1="6" x2="19" y2="6"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
              <line x1="5" y1="18" x2="13" y2="18"></line>
            </svg>
          </span>
          <span class="mode-label">Posts</span>
        </button>
        <button id="map-button" aria-pressed="true" aria-label="Map">
          <span class="mode-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 21s-6-4.5-6-10a6 6 0 1112 0c0 5.5-6 10-6 10z"></path>
              <circle cx="12" cy="11" r="2.5"></circle>
            </svg>
          </span>
          <span class="mode-label">Map</span>
        </button>
      </div>
    </nav>
    <div class="header-buttons">
      <button id="memberBtn" type="button" aria-pressed="false" aria-label="Open members area">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 18.75a6 6 0 00-7.5 0"/>
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 15a3 3 0 100-6 3 3 0 000 6z"/>
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 3.75a8.25 8.25 0 100 16.5 8.25 8.25 0 000-16.5z"/>
        </svg>
      </button>
      <button id="adminBtn" type="button" aria-pressed="false" aria-label="Open admin area">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <circle cx="12" cy="12" r="3"/>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82 2 2 0 1 1-2.83 2.83 1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51 2 2 0 1 1-4 0 1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33 2 2 0 1 1-2.83-2.83 1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1A2 2 0 1 1 4 9a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82A2 2 0 1 1 8.01 3.35a1.65 1.65 0 0 0 1.82-.33 1.65 1.65 0 0 0 1-1.51A2 2 0 1 1 14 3a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33A2 2 0 1 1 19.65 8a1.65 1.65 0 0 0-.33 1.82 1.65 1.65 0 0 0 1.51 1A2 2 0 1 1 21 15a1.65 1.65 0 0 0-1.51 1z"/>
        </svg>
      </button>
      <button id="fullscreenBtn" type="button" class="fullscreen-btn" aria-label="Toggle fullscreen">⛶</button>
    </div>
  </header>
  

  <section class="map-area" aria-label="Map">
    <div class="map-control-row map-controls-map">
      <div id="geocoder-map" class="geocoder"></div>
      <div id="geolocate-map" class="geolocate-btn"></div>
      <div id="compass-map" class="compass-btn"></div>
    </div>
    <div class="map-zoom-indicator" id="mapZoomIndicator" aria-live="polite">Zoom --</div>
    <div id="map"></div>
  </section>

  <div class="post-mode-background"></div>
  <div class="post-mode-boards">
    <!-- <section class="quick-list-board" id="results" aria-label="Quick List Board"></section> -->
    <section class="recents-board quick-list-board" id="recentsBoard" aria-label="Recents Board" data-side="left" aria-hidden="true" style="display:none;">
    </section>
    <section class="post-board" aria-label="Post Board" data-side="left" aria-hidden="true" style="display:none;">
    </section>
    <section class="ad-board" aria-label="Ad Board" data-side="right" aria-hidden="true" style="display:none;">
      <div class="ad-panel">
      </div>
    </section>
  </div>

  <div id="filterPanel" class="panel" role="dialog" aria-panel="true" aria-hidden="true">
    <div class="panel-content" style="top:calc(var(--header-h) + var(--safe-top));left:0;">
      <div class="panel-header">
        <div id="filterSummary" class="filter-summary"></div>
      </div>
      <div class="panel-body">
        <div class="map-control-row map-controls-filter">
          <div id="geocoder-filter" class="geocoder"></div>
          <div id="geolocate-filter" class="geolocate-btn"></div>
          <div id="compass-filter" class="compass-btn"></div>
        </div>
        <div class="reset-box">
          <div id="resetBtn" class="btn" role="button" aria-label="Reset all filters">
            Reset All Filters
          </div>
        </div>
        <div class="reset-box">
          <div id="resetCategoriesBtn" class="btn" role="button" aria-label="Reset all categories">
            Reset All Categories
          </div>
        </div>
        <div class="field sort-field">
          <div class="options-dropdown">
            <button id="optionsBtn" aria-haspopup="true" aria-expanded="false">Sort by Title A-Z</button>
            <div id="optionsMenu" class="options-menu" hidden>
              <button id="favToggle" aria-pressed="false">Favourites on top<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 17.3 6.2 21l1.6-6.7L2 9.3l6.9-.6L12 2l3.1 6.7 6.9.6-5.8 4.9L17.8 21 12 17.3z"/></svg></button>
              <div class="sort-options" role="group" aria-label="Sort order" style="display:flex; flex-direction:column; gap:6px;">
                <button class="sort-option" data-sort="az" aria-pressed="true">Sort by Title A-Z</button>
                <button class="sort-option" data-sort="nearest" aria-pressed="false">Sort by Closest</button>
                <button class="sort-option" data-sort="soon" aria-pressed="false">Sort by Soonest</button>
              </div>
            </div>
          </div>
        </div>
        <section aria-label="Filters">
          <div class="filter-basics-container">
            <div class="field keyword-row">
              <div class="input"><input id="keyword-textbox" type="text" placeholder="Keywords" aria-label="Keywords" />
                <div class="keyword-clear-button" role="button" aria-label="Clear keywords">X</div>
              </div>
            </div>
            <div class="field daterange-row">
              <div class="input"><input id="daterange-textbox" type="text" aria-label="Date range" placeholder="Date Range" readonly aria-haspopup="dialog" aria-expanded="false" aria-controls="datePickerContainer" />
                <div class="daterange-clear-button" role="button" aria-label="Clear date">X</div>
              </div>
            </div>
            <div class="field expired-row">
              <span class="expired-text">Show Expired Events</span>
              <label class="switch">
                <input id="expiredToggle" type="checkbox" />
                <span class="slider"></span>
              </label>
            </div>
            <div id="datePickerContainer" class="calendar-container" aria-hidden="true">
              <div id="datePicker"></div>
            </div>
          </div>
          <div class="filter-category-container">
            <div class="cats" id="cats" aria-label="Categories"></div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <div id="memberPanel" class="panel" role="dialog" aria-panel="true" aria-hidden="true">
    <div class="panel-content" style="right:0;">
      <div class="panel-header">
        <div class="header-top">
          <h2>Create Post</h2>
          <div class="panel-actions">
            <button type="button" class="move-left" aria-label="Move panel left">&lt;</button>
            <button type="button" class="move-right" aria-label="Move panel right">&gt;</button>
            <button type="button" class="close-panel">Close</button>
          </div>
        </div>
      </div>
      <form id="memberForm" class="panel-body">
        <div class="map-control-row map-controls-member">
          <div id="geocoder-member" class="geocoder"></div>
          <div id="geolocate-member" class="geolocate-btn"></div>
          <div id="compass-member" class="compass-btn"></div>
        </div>
        <div class="panel-field">
          <label for="mTitle">Title</label>
          <input type="text" id="mTitle" required />
        </div>
        <div class="panel-field">
          <label for="mImage">Image</label>
          <input type="file" id="mImage" accept="image/*" />
        </div>
        <div class="panel-field">
          <label for="mDate">Date</label>
          <input type="date" id="mDate" />
        </div>
        <div class="panel-field">
          <label for="mColor">Color</label>
          <input type="color" id="mColor" data-mode="hex" value="#000000" />
        </div>
      </form>
    </div>
  </div>

  <div id="adminPanel" class="panel" role="dialog" aria-panel="true" aria-hidden="true">
    <div class="panel-content" style="top:calc(var(--header-h) + var(--safe-top));right:0;">
      <div class="panel-header">
        <div class="header-top">
          <h2 class="title">Admin</h2>
          <div class="panel-actions">
            <button type="button" class="move-left" aria-label="Move panel left">&lt;</button>
            <button type="button" class="move-right" aria-label="Move panel right">&gt;</button>
            <button type="button" class="close-panel">Close</button>
          </div>
        </div>
        <div class="tab-bar">
          <button type="button" class="tab-btn" data-tab="map" aria-selected="true">Map</button>
          <button type="button" class="tab-btn" data-tab="settings">Settings</button>
          <button type="button" class="tab-btn" data-tab="forms">Forms</button>
        </div>
      </div>
      <form id="adminForm" class="panel-body">
        <div id="tab-map" class="tab-panel active">
          <div class="map-spin-container">
            <div class="panel-field">
              <label for="spinSpeed">Spin speed</label>
              <div class="range-wrap">
                <input type="range" id="spinSpeed" min="0" max="1" step="0.01" />
                <span id="spinSpeedVal"></span>
              </div>
            </div>
            <div class="panel-field">
              <label for="mapPitch">Pitch</label>
              <div class="range-wrap">
                <input type="range" id="mapPitch" min="0" max="85" step="1" />
                <span id="pitchVal"></span>
              </div>
            </div>
            <div class="panel-field">
              <label for="mapBearing">Bearing</label>
              <div class="range-wrap">
                <input type="range" id="mapBearing" min="-180" max="180" step="1" />
                <span id="bearingVal"></span>
              </div>
            </div>
            <div class="panel-field">
              <div class="option-label">
                <span>Spin on Load</span>
                <label class="switch">
                  <input type="checkbox" id="spinLoadStart" />
                  <span class="slider"></span>
                </label>
              </div>
              <div id="spinType" class="option-group">
                <label class="option-label"><span>Everyone</span><input type="radio" name="spinType" value="all" /></label>
                <label class="option-label"><span>New Users</span><input type="radio" name="spinType" value="new" /></label>
              </div>
            </div>
            <div class="panel-field">
              <div class="option-label">
                <span>Spin on Logo</span>
                <label class="switch">
                  <input type="checkbox" id="spinLogoClick" checked />
                  <span class="slider"></span>
                </label>
              </div>
          </div>
        </div>
        <div id="map-balloon-container" class="map-balloon-container">
          <style>
              #map-balloon-container .t{font-size:16px;font-weight:bold;}
              #map-balloon-container .shape-dropdown{position:relative;width:100%;max-width:100%;height:35px;margin-bottom:8px;}
              #map-balloon-container .shape-dropdown > button{width:100%;height:35px;background:var(--btn);border:1px solid var(--btn);border-radius:var(--dropdown-radius);text-align:left;padding:0;}
              #map-balloon-container .shape-menu{position:absolute;top:calc(100% + 4px);left:0;width:100%;max-height:400px;overflow-y:auto;overflow-y:overlay;background:var(--dropdown-bg);border:1px solid var(--border);border-radius:var(--dropdown-radius);padding:10px;display:flex;flex-direction:column;gap:6px;z-index:30;}
              #map-balloon-container .shape-menu[hidden]{display:none;}
              #map-balloon-container .shape-button{width:100%;height:35px;background:var(--btn);border:1px solid var(--btn);border-radius:var(--dropdown-radius);text-align:left;display:flex;align-items:center;gap:4px;padding:4px;cursor:pointer;}
              #map-balloon-container .shape-button svg{width:24px;height:24px;vertical-align:middle;}
              #map-balloon-container .shape-button.active{outline:2px solid var(--border);}
              #map-balloon-container .panel-field{width:100%;max-width:100%;}
              #map-balloon-container #copySvgCode{width:100%;height:35px;padding:0;margin-bottom:8px;}
              #map-balloon-container #shapeMenuBtn{padding:0;}
              #map-balloon-container #balloonGrid{display:grid;grid-template-columns: repeat(auto-fill, minmax(32px, 1fr)); gap:4px;overflow-x:auto;margin-bottom:8px;}
              #map-balloon-container #balloonGrid svg{cursor:pointer;}
              #map-balloon-container #balloonSvgCode{width:100%;max-width:100%;min-height:200px;}
            </style>
            <div class="t">Balloon Icon Generator</div>
            <div class="shape-dropdown">
              <button type="button" id="shapeMenuBtn" aria-expanded="false">Select Shape</button>
              <div class="shape-menu" id="balloonShapeButtons" hidden></div>
            </div>
            <div class="panel-field size-control">
              <label for="balloonSize">Balloon size</label>
              <div class="range-wrap">
                <input type="range" id="balloonSize" min="40" max="120" value="40" />
                <span id="balloonSizeValue">40</span>px
              </div>
            </div>
            <button type="button" id="copySvgCode">Copy SVG</button>
            <div id="balloonGrid"></div>
            <textarea id="balloonSvgCode"></textarea>
          </div>
        </div>
        <div id="tab-settings" class="tab-panel">
        <div id="post-mode-background-field" class="panel-field">
          <label for="postModeBgColor">Post Mode Background</label>
          <div class="settings-style-container">
            <div id="post-mode-background-row">
              <input type="color" id="postModeBgColor">
              <input type="range" id="postModeBgOpacity" min="0" max="1" step="0.01">
              <span id="postModeBgOpacityVal">0.00</span>
            </div>
          </div>
        </div>
        <div class="settings-welcome-container">
          <div id="welcome-message-panel" class="panel-field">
            <label for="welcomeMessageEditor">Welcome Message</label>
            <div class="wysiwyg-toolbar">
              <button type="button" data-command="bold"><b>B</b></button>
              <button type="button" data-command="italic"><i>I</i></button>
              <button type="button" data-command="underline"><u>U</u></button>
            </div>
            <div id="welcomeMessageEditor" class="wysiwyg" contenteditable="true" data-placeholder='<p>Welcome to Funmap! Choose an area on the map to search for events and listings. Click the <svg class="icon-search" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" role="img" aria-label="Filters"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg> button to refine your search.</p>'></div>
            <textarea id="welcomeMessage" hidden></textarea>
          </div>
        </div>
        </div>
        <div id="tab-forms" class="tab-panel">
          <div class="formbuilder-container">
            <div class="cats" id="formbuilderCats" aria-label="Categories"></div>
          </div>
          <style>
            #tab-forms .form-category{margin:10px 0;border:1px solid #ccc;padding:0;}
            #tab-forms .category-header{display:flex;gap:6px;align-items:center;margin-bottom:8px;}
            #tab-forms .subcategory-table{border-collapse:collapse;}
            #tab-forms .subcategory-table td,#tab-forms .subcategory-table th{border:1px solid #999;padding:4px;}
          </style>
          <div id="formsControls">
            <div class="settings-style-container">
              <button type="button" id="addCategory">Add Category</button>
            </div>
            <div id="formsCategories"></div>
          </div>
        </div>
      </form>
  </div>
  </div>

  <script>
    // Remember where the user actually clicked/tapped
    document.addEventListener('pointerdown', (e) => {
      window.__lastPointerDown = e;
    }, { capture: true });

    // Place the opened post right after the clicked .post-card
    function placeOpenPost(el) {
      const anchor = window.__lastPointerDown &&
                     window.__lastPointerDown.target &&
                     window.__lastPointerDown.target.closest('.post-card');
      if (anchor && anchor.parentElement) {
        anchor.after(el);
      } else {
        const board = document.querySelector('.post-board');
        if (board) board.prepend(el);
      }
    }
  </script>

  <div id="welcome-modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <!-- Welcome modal content (not a panel) -->
    <div class="modal-content">
      <div class="panel-body" id="welcomeBody">
        <img class="welcome-logo" src="https://raw.githubusercontent.com/Zxen1/Events-Platform/refs/heads/main/assets/funmap-logo-big.png" alt="FunMap logo" />
        <div class="map-control-row map-controls-welcome">
          <div id="geocoder-welcome" class="geocoder"></div>
          <div id="geolocate-welcome" class="geolocate-btn"></div>
          <div id="compass-welcome" class="compass-btn"></div>
        </div>
        <div id="welcomeMessageBox"></div>
        <img class="welcome-illustration" src="assets/monkeys/Firefly_cute-little-monkey-in-red-cape-with-arms-outstretched-in-welcome-609041-600.png" alt="Friendly monkey mascot welcoming visitors" />
      </div>
    </div>
  </div>

  <script>
  async function ensureMapboxCssFor(container) {
    const ver = (window.MAPBOX_VERSION || "v3.15.0").replace(/^v/,'v');
    const cssHref = `https://api.mapbox.com/mapbox-gl-js/${ver}/mapbox-gl.css`;

    const doc = (container && container.ownerDocument) || document;
    const root = container && container.getRootNode && container.getRootNode();

    // For Shadow DOM maps, inject right into the shadow root
    if (root && root.host && typeof ShadowRoot !== "undefined" && root instanceof ShadowRoot) {
      if (!root.querySelector('style[data-mapbox-gl]')) {
        const s = document.createElement('style');
        s.setAttribute('data-mapbox-gl','');
        s.textContent = `@import url('${cssHref}');`;
        root.prepend(s);
      }
      return;
    }

    // Normal document (or iframe document)
    let link = doc.getElementById('mapbox-gl-css');
    if (!link) {
      link = doc.createElement('link');
      link.id = 'mapbox-gl-css';
      link.rel = 'stylesheet';
      link.href = cssHref;
      doc.head.appendChild(link);
    }
    if (link.sheet) return;
    await new Promise(res => link.addEventListener('load', res, { once: true }));
  }

  (async () => {
    try {
      await ensureMapboxCssFor(document.body);
    } catch(e){}
  })();

  (function(){
    const q = [];
    let scheduled = false;
    function flush(){
      scheduled = false;
      const budget = 6;
      let start = performance.now();
      while(q.length){
        const fn = q.shift();
        try{ fn && fn(); }catch(err){ console.error(err); }
        if(performance.now() - start > budget){
          if(typeof requestAnimationFrame === 'function'){
            requestAnimationFrame(flush);
          } else {
            setTimeout(flush, 16);
          }
          return;
        }
      }
    }
    window.deferToAnimationFrame = function(cb){
      q.push(cb);
      if(!scheduled){
        scheduled = true;
        if(typeof requestAnimationFrame === 'function'){
          requestAnimationFrame(flush);
        } else {
          setTimeout(flush, 16);
        }
      }
    };
  })();

  // Helper: do nothing until style is truly loaded
  function whenStyleReady(map, fn){
    if (map.isStyleLoaded && map.isStyleLoaded()) { fn(); return; }
    const onLoad = () => { map.off('load', onLoad); fn(); };
    map.on('load', onLoad);
  }

  function applyNightSky(mapInstance){
    if(!mapInstance) return;
    if(typeof mapInstance.setFog === 'function'){
      try {
        mapInstance.setFog({
          color: 'rgba(11,13,23,0.6)',
          'high-color': 'rgba(27,32,53,0.7)',
          'horizon-blend': 0.15,
          'space-color': '#010409',
          'star-intensity': 0.6
        });
      } catch(err){}
    }
    if(typeof mapInstance.getLayer !== 'function'){
      return;
    }
    let skyLayerId = null;
    const skyPaint = {
      'sky-type': 'gradient',
      'sky-gradient-center': [0, 0],
      'sky-gradient-radius': 80,
      'sky-gradient': [
        'interpolate',
        ['linear'],
        ['sky-radial-progress'],
        0.0, 'rgba(6,10,20,1)',
        0.6, '#0b1d51',
        1.0, '#1a2a6c'
      ],
      'sky-opacity': 1
    };
    try {
      if(mapInstance.getLayer('sky')){
        skyLayerId = 'sky';
      } else if(mapInstance.getLayer('night-sky')){
        skyLayerId = 'night-sky';
      } else if(typeof mapInstance.addLayer === 'function'){
        mapInstance.addLayer({
          id:'night-sky',
          type:'sky',
          paint: skyPaint
        });
        skyLayerId = 'night-sky';
      }
    } catch(err){
      if(!skyLayerId && typeof mapInstance.getLayer === 'function' && mapInstance.getLayer('sky')){
        skyLayerId = 'sky';
      }
    }
    if(!skyLayerId || typeof mapInstance.setPaintProperty !== 'function'){
      return;
    }
    Object.entries(skyPaint).forEach(([prop, value]) => {
      try { mapInstance.setPaintProperty(skyLayerId, prop, value); } catch(err){}
    });
  }

  function createTransparentPlaceholder(size){
    const canvas = document.createElement('canvas');
    const s = Math.max(1, size || 2);
    canvas.width = s;
    canvas.height = s;
    const ctx = canvas.getContext('2d');
    if(ctx){
      ctx.clearRect(0, 0, s, s);
    }
    return canvas;
  }

  function ensurePlaceholderSprites(mapInstance){
    if(!mapInstance || typeof mapInstance.addImage !== 'function') return;
    const required = ['mx-federal-5','background','background-stroke','icon','icon-stroke'];
    required.forEach(name => {
      try{
        if(mapInstance.hasImage?.(name)) return;
        mapInstance.addImage(name, createTransparentPlaceholder(4), { pixelRatio: 1 });
      }catch(err){}
    });
  }

  const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0) || (window.matchMedia && window.matchMedia('(pointer: coarse)').matches);
  const narrowScreenQuery = typeof window.matchMedia === 'function' ? window.matchMedia('(max-width: 600px)') : null;
  const isNarrowScreen = narrowScreenQuery ? narrowScreenQuery.matches : window.innerWidth <= 600;
  const markerIconSize = (isTouchDevice || isNarrowScreen) ? 1.35 : 1;
  const markerIconBaseSizePx = 30;
  const markerLabelBackgroundWidthPx = 150;
  const markerLabelBackgroundHeightPx = 40;
  const markerLabelTextGapPx = 5;
  const markerLabelMarkerInsetPx = 5;
  const markerLabelTextRightPaddingPx = 5;
  const markerLabelTextPaddingPx = markerIconBaseSizePx * markerIconSize + markerLabelMarkerInsetPx + markerLabelTextGapPx;
  const markerLabelTextAreaWidthPx = Math.max(0, markerLabelBackgroundWidthPx - markerLabelTextPaddingPx - markerLabelTextRightPaddingPx);
  const markerLabelTextSize = 12;
  const markerLabelTextLineHeight = 1.2;
  const markerLabelBgTranslatePx = -(markerIconBaseSizePx * markerIconSize / 2 + markerLabelMarkerInsetPx);
  const markerLabelEllipsisChar = '\u2026';
  const mapCardTitleWidthPx = 165;
  let markerLabelMeasureContext = null;

  function ensureMarkerLabelMeasureContext(){
    if(markerLabelMeasureContext){
      return markerLabelMeasureContext;
    }
    const canvas = document.createElement('canvas');
    markerLabelMeasureContext = canvas.getContext('2d');
    return markerLabelMeasureContext;
  }

  function markerLabelMeasureFont(){
    return `${markerLabelTextSize}px "Open Sans", "Arial Unicode MS Regular", sans-serif`;
  }

  function shortenMarkerLabelText(text, widthPx = markerLabelTextAreaWidthPx){
    const raw = (text ?? '').toString().trim();
    if(!raw){
      return '';
    }
    const ctx = ensureMarkerLabelMeasureContext();
    if(!ctx){
      return raw;
    }
    ctx.font = markerLabelMeasureFont();
    const maxWidth = widthPx;
    if(maxWidth <= 0){
      return raw;
    }
    if(ctx.measureText(raw).width <= maxWidth){
      return raw;
    }
    const ellipsis = markerLabelEllipsisChar;
    let low = 0;
    let high = raw.length;
    let best = ellipsis;
    while(low <= high){
      const mid = Math.floor((low + high) / 2);
      if(mid <= 0){
        high = mid - 1;
        continue;
      }
      const candidate = raw.slice(0, mid).trimEnd() + ellipsis;
      if(ctx.measureText(candidate).width <= maxWidth){
        best = candidate;
        low = mid + 1;
      } else {
        high = mid - 1;
      }
    }
    return best;
  }

  function splitTextAcrossLines(text, widthPx, maxLines){
    const normalized = (text ?? '').toString().replace(/\s+/g, ' ').trim();
    if(!normalized){
      return [];
    }
    if(!Number.isFinite(widthPx) || widthPx <= 0 || maxLines <= 0){
      return [normalized];
    }
    const ctx = ensureMarkerLabelMeasureContext();
    if(!ctx){
      return [normalized];
    }
    ctx.font = markerLabelMeasureFont();
    if(ctx.measureText(normalized).width <= widthPx){
      return [normalized];
    }
    const lines = [];
    let remaining = normalized;
    while(remaining && lines.length < maxLines){
      if(lines.length === maxLines - 1){
        lines.push(shortenMarkerLabelText(remaining, widthPx));
        break;
      }
      let low = 1;
      let high = remaining.length;
      let bestIndex = 0;
      while(low <= high){
        const mid = Math.floor((low + high) / 2);
        const candidate = remaining.slice(0, mid).trimEnd();
        if(!candidate){
          low = mid + 1;
          continue;
        }
        if(ctx.measureText(candidate).width <= widthPx){
          bestIndex = mid;
          low = mid + 1;
        } else {
          high = mid - 1;
        }
      }
      let line = remaining.slice(0, bestIndex).trimEnd();
      const leftoverRaw = remaining.slice(bestIndex);
      const leftoverHadLeadingWhitespace = /^\s/.test(leftoverRaw);
      let leftover = leftoverRaw.trimStart();
      if(leftover){
        const lastSpace = line.lastIndexOf(' ');
        if(lastSpace > 0){
          const candidate = line.slice(0, lastSpace).trimEnd();
          const movedBase = line.slice(lastSpace + 1);
          const moved = (leftoverHadLeadingWhitespace ? `${movedBase} ${leftover}` : `${movedBase}${leftover}`).trim();
          if(candidate && ctx.measureText(candidate).width <= widthPx){
            line = candidate;
            leftover = moved;
          }
        }
      }
      if(!line){
        lines.push(shortenMarkerLabelText(remaining, widthPx));
        break;
      }
      lines.push(line);
      remaining = leftover;
      if(remaining && ctx.measureText(remaining).width <= widthPx && lines.length < maxLines){
        lines.push(remaining);
        break;
      }
    }
    return lines;
  }

  function getPrimaryVenueName(p){
    if(!p) return '';
    const loc = Array.isArray(p.locations) && p.locations.length ? p.locations[0] : null;
    if(loc && loc.venue){
      return loc.venue;
    }
    if(p.venue){
      return p.venue;
    }
    return p.city || '';
  }

  function getMarkerLabelLines(p){
    const title = p && p.title ? p.title : '';
    const markerTitleLines = splitTextAcrossLines(title, markerLabelTextAreaWidthPx, 2);
    while(markerTitleLines.length < 2){ markerTitleLines.push(''); }
    const cardTitleLines = splitTextAcrossLines(title, mapCardTitleWidthPx, 2);
    while(cardTitleLines.length < 2){ cardTitleLines.push(''); }
    const venueRaw = getPrimaryVenueName(p);
    return {
      line1: markerTitleLines[0] || '',
      line2: markerTitleLines[1] || '',
      cardTitleLines,
      venueLine: venueRaw ? shortenMarkerLabelText(venueRaw, mapCardTitleWidthPx) : ''
    };
  }

  function buildMarkerLabelText(p, overrideLines){
    const lines = overrideLines || getMarkerLabelLines(p);
    if(lines.line2){
      return `${lines.line1}\n${lines.line2}`;
    }
    return lines.line1;
  }

  const MARKER_LABEL_BG_ID = 'marker-label-bg';
  const MARKER_LABEL_COMPOSITE_PREFIX = 'marker-label-composite-';
  const markerLabelCompositeStore = new Map();
  const markerLabelCompositePending = new Map();
  let markerLabelPillImagePromise = null;

  function loadMarkerLabelImage(url){
    return new Promise((resolve, reject) => {
      if(!url){
        reject(new Error('Missing URL'));
        return;
      }
      const img = new Image();
      try{ img.crossOrigin = 'anonymous'; }catch(err){}
      img.decoding = 'async';
      img.onload = () => resolve(img);
      img.onerror = () => reject(new Error(`Failed to load ${url}`));
      img.src = url;
      if(img.complete){
        setTimeout(() => {
          if(img.naturalWidth > 0 && img.naturalHeight > 0){
            resolve(img);
          }
        }, 0);
      }
    });
  }

  async function ensureMarkerLabelPillImage(){
    if(markerLabelPillImagePromise){
      return markerLabelPillImagePromise;
    }
    markerLabelPillImagePromise = loadMarkerLabelImage('assets/icons-30/150x40 pill 99.webp')
      .catch(err => {
        console.error(err);
        markerLabelPillImagePromise = null;
        return null;
      });
    return markerLabelPillImagePromise;
  }

  function markerLabelCompositeId(spriteId){
    return `${MARKER_LABEL_COMPOSITE_PREFIX}${spriteId}`;
  }

  async function ensureMarkerLabelComposite(mapInstance, labelSpriteId, iconId, labelLine1, labelLine2, isMulti){
    if(!mapInstance || !labelSpriteId){
      return null;
    }
    const compositeId = markerLabelCompositeId(labelSpriteId);
    const meta = markerLabelCompositeStore.get(labelSpriteId) || {};
    meta.iconId = iconId || meta.iconId || '';
    meta.labelLine1 = labelLine1 ?? meta.labelLine1 ?? '';
    meta.labelLine2 = labelLine2 ?? meta.labelLine2 ?? '';
    meta.isMulti = Boolean(isMulti ?? meta.isMulti);
    markerLabelCompositeStore.set(labelSpriteId, meta);
    if(mapInstance.hasImage?.(compositeId)){
      return compositeId;
    }
    if(meta.image){
      try{
        mapInstance.addImage(compositeId, meta.image, meta.options || {});
        return compositeId;
      }catch(err){
        console.error(err);
      }
    }
    if(markerLabelCompositePending.has(labelSpriteId)){
      return markerLabelCompositePending.get(labelSpriteId);
    }
    const task = (async () => {
      const pillImg = await ensureMarkerLabelPillImage();
      if(!pillImg){
        return null;
      }
      const markerSources = window.subcategoryMarkers || {};
      const iconUrl = meta.iconId ? markerSources[meta.iconId] : null;
      let iconImg = null;
      if(iconUrl){
        try{
          iconImg = await loadMarkerLabelImage(iconUrl);
        }catch(err){
          console.error(err);
        }
      }
      const rawWidth = pillImg.naturalWidth || pillImg.width || markerLabelBackgroundWidthPx;
      const rawHeight = pillImg.naturalHeight || pillImg.height || markerLabelBackgroundHeightPx;
      const canvas = document.createElement('canvas');
      canvas.width = Math.max(1, Math.round(Number.isFinite(rawWidth) && rawWidth > 0 ? rawWidth : markerLabelBackgroundWidthPx));
      canvas.height = Math.max(1, Math.round(Number.isFinite(rawHeight) && rawHeight > 0 ? rawHeight : markerLabelBackgroundHeightPx));
      const ctx = canvas.getContext('2d');
      if(!ctx){
        return null;
      }
      const canvasWidth = canvas.width;
      const canvasHeight = canvas.height;
      ctx.clearRect(0, 0, canvasWidth, canvasHeight);
      ctx.drawImage(pillImg, 0, 0, canvasWidth, canvasHeight);
      const pixelRatio = canvasWidth / markerLabelBackgroundWidthPx;
      if(iconImg){
        const iconSizePx = markerIconBaseSizePx * markerIconSize * pixelRatio;
        const destX = markerLabelMarkerInsetPx * pixelRatio;
        const destY = (canvasHeight - iconSizePx) / 2;
        try{
          ctx.drawImage(iconImg, destX, destY, iconSizePx, iconSizePx);
        }catch(err){
          console.error(err);
        }
      }
      const labelLines = [];
      const line1 = (meta.labelLine1 || '').trim();
      const line2 = (meta.labelLine2 || '').trim();
      if(line1){
        labelLines.push({ text: line1, color: '#ffffff' });
      }
      if(line2){
        labelLines.push({ text: line2, color: meta.isMulti ? '#d0d0d0' : '#ffffff' });
      }
      if(labelLines.length){
        const fontSizePx = markerLabelTextSize * pixelRatio;
        const lineGapPx = Math.max(0, (markerLabelTextLineHeight - 1) * markerLabelTextSize * pixelRatio);
        const totalHeight = labelLines.length * fontSizePx + Math.max(0, labelLines.length - 1) * lineGapPx;
        let textY = (canvasHeight - totalHeight) / 2;
        if(!Number.isFinite(textY) || textY < 0){
          textY = 0;
        }
        const textX = markerLabelTextPaddingPx * pixelRatio;
        ctx.font = `${fontSizePx}px "Open Sans", "Arial Unicode MS Regular", sans-serif`;
        ctx.textBaseline = 'top';
        ctx.textAlign = 'left';
        ctx.shadowColor = 'rgba(0,0,0,0.4)';
        ctx.shadowBlur = 2 * pixelRatio;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 1 * pixelRatio;
        labelLines.forEach(line => {
          ctx.fillStyle = line.color;
          try{
            ctx.fillText(line.text, textX, textY);
          }catch(err){
            console.error(err);
          }
          textY += fontSizePx + lineGapPx;
        });
        ctx.shadowColor = 'transparent';
      }
      const options = { pixelRatio: Number.isFinite(pixelRatio) && pixelRatio > 0 ? pixelRatio : 1 };
      try{
        if(mapInstance.hasImage?.(compositeId)){
          mapInstance.removeImage(compositeId);
        }
      }catch(err){
        console.error(err);
      }
      let imageData = null;
      try{
        imageData = ctx.getImageData(0, 0, canvasWidth, canvasHeight);
      }catch(err){
        console.error(err);
      }
      if(!imageData){
        return null;
      }
      try{
        mapInstance.addImage(compositeId, imageData, options);
        markerLabelCompositeStore.set(labelSpriteId, Object.assign(meta, { image: imageData, options }));
        return compositeId;
      }catch(err){
        console.error(err);
        return null;
      }
    })().finally(() => {
      markerLabelCompositePending.delete(labelSpriteId);
    });
    markerLabelCompositePending.set(labelSpriteId, task);
    return task;
  }

  function reapplyMarkerLabelComposites(mapInstance){
    if(!mapInstance){
      return;
    }
    markerLabelCompositeStore.forEach((entry, spriteId) => {
      if(!entry || !entry.image){
        return;
      }
      const compositeId = markerLabelCompositeId(spriteId);
      try{
        if(mapInstance.hasImage?.(compositeId)){
          return;
        }
        mapInstance.addImage(compositeId, entry.image, entry.options || {});
      }catch(err){
        console.error(err);
      }
    });
  }

  function scheduleMarkerLabelBackgroundRetry(mapInstance){
    if(!mapInstance || typeof mapInstance === 'undefined') return;
    const mark = '__markerLabelBgRetryScheduled';
    if(mapInstance[mark]) return;
    mapInstance[mark] = true;
    const retry = () => {
      mapInstance[mark] = false;
      try{ ensureMarkerLabelBackground(mapInstance); }catch(err){}
    };
    if(typeof mapInstance.once === 'function'){
      mapInstance.once('style.load', retry);
    } else if(typeof mapInstance.on === 'function'){
      const handler = () => {
        try{ mapInstance.off?.('style.load', handler); }catch(err){}
        retry();
      };
      mapInstance.on('style.load', handler);
    } else {
      setTimeout(retry, 0);
    }
  }

  function ensureMarkerLabelBackground(mapInstance){
    if(!mapInstance || typeof mapInstance.addImage !== 'function') return;
    try{
      if(mapInstance.hasImage && mapInstance.hasImage(MARKER_LABEL_BG_ID)){
        mapInstance.__markerLabelBgRetryScheduled = false;
        return;
      }
    }catch(err){
      scheduleMarkerLabelBackgroundRetry(mapInstance);
      return;
    }
    if(typeof mapInstance.isStyleLoaded === 'function' && !mapInstance.isStyleLoaded()){
      scheduleMarkerLabelBackgroundRetry(mapInstance);
      return;
    }
    const placeholder = document.createElement('canvas');
    try{
      placeholder.width = Math.max(1, Math.round(markerLabelBackgroundWidthPx));
      placeholder.height = Math.max(1, Math.round(markerLabelBackgroundHeightPx));
      const phCtx = placeholder.getContext('2d');
      if(phCtx){
        phCtx.clearRect(0, 0, placeholder.width, placeholder.height);
      }
    }catch(err){
      placeholder.width = 1;
      placeholder.height = 1;
    }
    try{
      mapInstance.addImage(MARKER_LABEL_BG_ID, placeholder, { pixelRatio: 1 });
      mapInstance.__markerLabelBgRetryScheduled = false;
    }catch(err){
      scheduleMarkerLabelBackgroundRetry(mapInstance);
      return;
    }
    try{ window.__addOrReplacePill150x40?.(mapInstance); }catch(err){}
  }

  function patchLayerFiltersForMissingLayer(mapInstance, style){
    if(!mapInstance || typeof mapInstance.setFilter !== 'function') return;
    const layers = style && Array.isArray(style.layers) ? style.layers : [];
    if(!layers.length) return;

    function patchExpression(expr){
      if(!Array.isArray(expr)){
        return { expr, changed:false };
      }
      const op = expr[0];
      let changed = false;
      const result = expr.map((item, idx) => {
        if(idx === 0) return item;
        const patched = patchExpression(item);
        if(patched.changed) changed = true;
        return patched.expr;
      });

      if((op === 'number' || op === 'to-number') && result.length > 1){
        const target = result[1];
        if(Array.isArray(target)){
          const already = target[0] === 'coalesce'
            && Array.isArray(target[1])
            && target[1][0] === 'get'
            && target[1][1] === 'layer';
          if(!already && target[0] === 'get' && target[1] === 'layer'){
            result[1] = ['coalesce', target, 0];
            changed = true;
          }
        }
      }

      return { expr: result, changed };
    }

    layers.forEach(layer => {
      if(!layer || !layer.id || !layer.filter) return;
      try{
        const patched = patchExpression(layer.filter);
        if(!patched.changed) return;
        mapInstance.setFilter(layer.id, patched.expr);
      }catch(err){}
    });
  }

  function patchTerrainSource(mapInstance, style){
    if(!mapInstance || typeof mapInstance.setTerrain !== 'function') return;
    const terrain = style && style.terrain;
    if(!terrain || !terrain.source) return;
    const sources = style.sources || {};
    const originalSource = sources[terrain.source];
    if(!originalSource) return;

    const dedicatedId = 'terrain-dem-dedicated';
    if(!mapInstance.getSource?.(dedicatedId)){
      try {
        const clone = JSON.parse(JSON.stringify(originalSource));
        mapInstance.addSource(dedicatedId, clone);
      } catch(err){}
    }

    const targetSource = mapInstance.getSource?.(dedicatedId) ? dedicatedId : terrain.source;
    const nextTerrain = Object.assign({}, terrain, { source: targetSource });
    if(typeof nextTerrain.cutoff !== 'number' || nextTerrain.cutoff <= 0){
      nextTerrain.cutoff = 0.01;
    }
    try { mapInstance.setTerrain(nextTerrain); } catch(err){}
  }

  function patchMapboxStyleArtifacts(mapInstance){
    if(!mapInstance || typeof mapInstance.getStyle !== 'function') return;
    if(mapInstance.isStyleLoaded && !mapInstance.isStyleLoaded()) return;
    let style;
    try{
      style = mapInstance.getStyle();
    }catch(err){
      return;
    }
    if(!style) return;
    try{ ensurePlaceholderSprites(mapInstance); }catch(err){}
    try{ patchLayerFiltersForMissingLayer(mapInstance, style); }catch(err){}
    try{ patchTerrainSource(mapInstance, style); }catch(err){}
  }

  // Attach pointer cursor only after style is ready, and re-attach if style changes later.
  function armPointerOnSymbolLayers(map){
    const POINTER_READY_IDS = new Set(['marker-label','clusters','cluster-count']);

    function shouldAttachPointer(layer){
      if (!layer || layer.type !== 'symbol') return false;
      if (POINTER_READY_IDS.has(layer.id)) return true;
      if (typeof layer.source === 'string' && layer.source === 'posts') return true;
      if (layer.metadata && layer.metadata.cursor === 'pointer') return true;
      return false;
    }

    function attach(){
      if (!map.getStyle || !map.isStyleLoaded || !map.isStyleLoaded()) return;
      const st = map.getStyle();
      if (!st || !st.layers) return;

      map.__cursorArmed = map.__cursorArmed || new Set();
      st.layers.forEach(l => {
        if (!shouldAttachPointer(l) || map.__cursorArmed.has(l.id)) return;
        map.on('mouseenter', l.id, () => map.getCanvas().style.cursor = 'pointer');
        map.on('mouseleave', l.id, () => map.getCanvas().style.cursor = 'grab');
        map.__cursorArmed.add(l.id);
      });
    }

    // First time once the style is fully loaded
    whenStyleReady(map, attach);

    // If the style changes later, reattach *after* the new style finishes
    map.on('styledata', () => {
      if (map.isStyleLoaded && map.isStyleLoaded()) attach();
    });
  }
  const callWhenDefined = window.callWhenDefined || function(name, invoke, timeoutMs){
    const start = performance.now(), max = timeoutMs ?? 5000;
    (function wait(){
      const fn = window[name];
      if (typeof fn === 'function') {
        try { invoke(fn); } catch(e){}
        return;
      }
      if (performance.now() - start < max) requestAnimationFrame(wait);
    })();
  };
  window.callWhenDefined = window.callWhenDefined || callWhenDefined;

  let startPitch, startBearing, logoEls = [], geocoder;
  const geocoders = [];
  const CARD_SURFACE = 'linear-gradient(rgba(0,0,0,0.8),rgba(0,0,0,0.6))';
  const MapRegistry = {
    list: [],
    limit: 4,
    register(map){
      if(!map) return;
      if(this.list.includes(map)) return;
      this.list.push(map);
      if(typeof map.once === 'function'){
        map.once('remove', () => {
          this.list = this.list.filter(m => m !== map);
        });
      }
      if(this.list.length > this.limit){
        const victim = this.list.shift();
        try{ victim && typeof victim.remove === 'function' && victim.remove(); }catch(err){}
      }
    }
  };

  function getGeocoderInput(gc){
    if(!gc) return null;
    if(gc._inputReference) return gc._inputReference;
    if(gc._inputEl) return gc._inputEl;
    if(gc._container) return gc._container.querySelector('input[type="text"]');
    return null;
  }

  function blurAllGeocoderInputs(){
    geocoders.forEach(gc => {
      const input = getGeocoderInput(gc);
      if(input && typeof input.blur === 'function'){
        input.blur();
      }
    });
  }

  function clearMapGeocoder(){
    if(!geocoder || typeof geocoder.clear !== 'function') return;
    const before = document.activeElement;
    geocoder.clear();
    const after = document.activeElement;
    requestAnimationFrame(() => {
      [after, before, getGeocoderInput(geocoder)].forEach(el => {
        if(el && el.classList && el.classList.contains('mapboxgl-ctrl-geocoder--input') && typeof el.blur === 'function'){
          el.blur();
        }
      });
      blurAllGeocoderInputs();
    });
  }

  (function(){
    const MAPBOX_TOKEN = "pk.eyJ1IjoienhlbiIsImEiOiJjbWViaDRibXEwM2NrMm1wcDhjODg4em5iIn0.2A9teACgwpiCy33uO4WZJQ";

    let mode = localStorage.getItem('mode') || 'map';
    const DEFAULT_SPIN_SPEED = 0.3;
    const DEFAULT_WELCOME = '<p>Welcome to Funmap! Choose an area on the map to search for events and listings. Click the <svg class="icon-search" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" role="img" aria-label="Filters"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg> button to refine your search.</p>';

    const firstVisit = !localStorage.getItem('hasVisited');
    localStorage.setItem('hasVisited','1');
    if(firstVisit){
      mode = 'map';
      localStorage.setItem('mode','map');
      localStorage.setItem('historyActive','false');
      ['filterPanel','memberPanel','adminPanel'].forEach(id => {
        localStorage.setItem(`panel-open-${id}`,'false');
      });
    }
    const savedView = JSON.parse(localStorage.getItem('mapView') || 'null');
    const defaultCenter = [(Math.random()*360)-180,(Math.random()*140)-70];
    const startCenter = savedView?.center || defaultCenter;
    const startZoom = savedView?.zoom || 1.5;
    startPitch = window.startPitch = savedView?.pitch || 0;
    startBearing = window.startBearing = savedView?.bearing || 0;

      let map, spinning = false, historyWasActive = localStorage.getItem('historyActive') === 'true', expiredWasOn = false, dateStart = null, dateEnd = null,
          spinLoadStart = JSON.parse(localStorage.getItem('spinLoadStart') ?? 'true'),
          spinLoadType = localStorage.getItem('spinLoadType') || 'all',
          spinLogoClick = localStorage.getItem('spinLogoClick') === 'false' ? false : true,
          spinSpeed = parseFloat(localStorage.getItem('spinSpeed') || String(DEFAULT_SPIN_SPEED)),
          spinEnabled = spinLoadStart && (spinLoadType === 'all' || (spinLoadType === 'new' && firstVisit)),
          mapStyle = window.mapStyle = 'mapbox://styles/mapbox/standard',
          clusterRadius = parseInt(localStorage.getItem('clusterRadius') || '52', 10),
          clusterMaxZoom = (()=>{
            let storedValue = parseInt(localStorage.getItem('clusterMaxZoom') || '9', 10);
            if(Number.isNaN(storedValue)) storedValue = 9;
            return Math.max(0, Math.min(storedValue, 9));
          })(),
          clusterIconType = localStorage.getItem('clusterIconType') || 'circle',
          clusterSvg = localStorage.getItem('clusterSvg') || '',
          currentClusterVisualKey = '',
          lastClusterSvgHash = '';
        localStorage.setItem('spinGlobe', JSON.stringify(spinEnabled));
        logoEls = [document.querySelector('.logo')].filter(Boolean);
        let ensureMapIcon = null;
      function updateLogoClickState(){
        logoEls.forEach(el=>{
          el.style.cursor = 'pointer';
          el.style.pointerEvents = 'auto';
        });
      }
      updateLogoClickState();

      function openWelcome(){
        const popup = document.getElementById('welcome-modal');
        const msgEl = document.getElementById('welcomeMessageBox');
        const saved = JSON.parse(localStorage.getItem('admin-settings-current') || '{}');
        msgEl.innerHTML = saved.welcomeMessage || DEFAULT_WELCOME;
        openPanel(popup);
        const body = document.getElementById('welcomeBody');
        body.style.padding = '20px';
      }
      window.openWelcome = openWelcome;

      function toggleWelcome(){
        const popup = document.getElementById('welcome-modal');
        if(popup.classList.contains('show')){
          closePanel(popup);
        } else {
          openWelcome();
        }
      }

      logoEls.forEach(el=>{
        el.addEventListener('click', (e) => {
          e.stopPropagation();
          if(spinning){
            toggleWelcome();
            return;
          }
          if(spinLogoClick && map && map.getZoom() <= 4){
            spinEnabled = true;
            localStorage.setItem('spinGlobe', 'true');
            startSpin(true);
          }
          toggleWelcome();
        });
      });
    // 'Post Panel' is defined as the current map bounds
    let postPanel = null;
    let posts = [], filtered = [], adPosts = [], adIndex = -1, adTimer = null, adPanel = null, adIdsKey = '', pendingPostLoad = false;
    let filtersInitialized = false;
    let favToTop = false, favSortDirty = true, currentSort = 'az';
    let selection = { cats: new Set(), subs: new Set() };
    let viewHistory = loadHistory();
    let hoverPopup = null;
    let postSourceEventsBound = false;
    let touchMarker = null;
    let activePostId = null;
    let selectedVenueKey = null;
    const BASE_URL = (()=>{ let b = location.origin + location.pathname.split('/post/')[0]; if(!b.endsWith('/')) b+='/'; return b; })();

    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const clamp = (n, a, b)=> Math.max(a, Math.min(b, n));
    const toRad = d => d * Math.PI / 180;
    function distKm(a,b){ const dLat = toRad(b.lat - a.lat), dLng = toRad(b.lng - a.lng); const s = Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(Math.PI*(b.lng - a.lng)/360)**2; return 2 * 6371 * Math.asin(Math.sqrt(s)); }
    const sleep = ms => new Promise(r=>setTimeout(r,ms));
    const nextFrame = ()=> new Promise(r=> requestAnimationFrame(()=>r()));

    // Ensure result lists occupy available space between the header and footer
    function adjustListHeight(){
      const rootStyles = getComputedStyle(document.documentElement);
      const headerH = parseFloat(rootStyles.getPropertyValue('--header-h')) || 0;
      const subH = parseFloat(rootStyles.getPropertyValue('--subheader-h')) || 0;
      const footerH = parseFloat(rootStyles.getPropertyValue('--footer-h')) || 0;
      const safeTop = parseFloat(rootStyles.getPropertyValue('--safe-top')) || 0;
      let viewportHeight = getViewportHeight();
      if(!Number.isFinite(viewportHeight) || viewportHeight <= 0){
        viewportHeight = headerH + subH + footerH + safeTop;
      }
      let availableHeight = Math.max(0, viewportHeight - headerH - subH - footerH - safeTop);
      const boardsContainer = document.querySelector('.post-mode-boards');
      if(boardsContainer){
        const boardsRect = boardsContainer.getBoundingClientRect();
        if(boardsRect && Number.isFinite(boardsRect.height) && boardsRect.height > 0){
          const measured = Math.max(0, boardsRect.height);
          availableHeight = availableHeight > 0 ? Math.min(availableHeight, measured) : measured;
        }
      }
      if(!Number.isFinite(availableHeight) || availableHeight < 0){
        availableHeight = 0;
      }
      const root = document.documentElement;
      if(root){
        const fullHeight = (Number.isFinite(viewportHeight) && viewportHeight > 0)
          ? viewportHeight
          : (availableHeight + headerH + subH + footerH + safeTop);
        if(Number.isFinite(fullHeight) && fullHeight > 0){
          root.style.setProperty('--vh', `${(fullHeight / 100)}px`);
        }
        if(availableHeight > 0){
          root.style.setProperty('--panel-area-height', `${availableHeight}px`);
          root.style.setProperty('--boards-area-height', `${availableHeight}px`);
        } else {
          root.style.removeProperty('--panel-area-height');
          root.style.removeProperty('--boards-area-height');
        }
      }
      document.querySelectorAll('.recents-board, .quick-list-board, .post-board, .ad-board').forEach(list=>{
        if(availableHeight > 0){
          const value = `${availableHeight}px`;
          list.style.height = value;
          list.style.maxHeight = value;
          list.style.minHeight = value;
        } else {
          list.style.removeProperty('height');
          list.style.removeProperty('max-height');
          list.style.removeProperty('min-height');
        }
      });
    }
    window.adjustListHeight = adjustListHeight;
    if(window.visualViewport){
      window.visualViewport.addEventListener('resize', adjustListHeight);
      addPassiveScrollListener(window.visualViewport, adjustListHeight);
    }
    window.addEventListener('resize', adjustListHeight);
    window.addEventListener('orientationchange', adjustListHeight);

    let stickyScrollHandler = null;
      function updateStickyImages(){
        const root = document.documentElement;
        const openPost = document.querySelector('.post-board .open-post');
        const body = openPost ? openPost.querySelector('.post-body') : null;
        const imgArea = body ? body.querySelector('.post-images') : null;
        const header = openPost ? openPost.querySelector('.post-header') : null;
        document.body.classList.remove('hide-map-calendar');
        if(!openPost || !body || !imgArea || !header){
          document.body.classList.remove('open-post-sticky-images');
          root.style.removeProperty('--open-post-header-h');
          return;
        }
        root.style.setProperty('--open-post-header-h', header.offsetHeight + 'px');
        document.body.classList.add('open-post-sticky-images');
      }

    window.updateStickyImages = updateStickyImages;

    function updateLayoutVars(){
      const root = document.documentElement;
      const header = document.querySelector('.header');
      if(header){
        const headerStyles = getComputedStyle(header);
        const safeTop = parseFloat(headerStyles.paddingTop) || 0;
        const rect = header.getBoundingClientRect();
        let measured = Number.isFinite(rect.height) ? rect.height : 0;
        if(!measured || measured <= safeTop){
          const fallbackOffset = Number.isFinite(header.offsetHeight) ? header.offsetHeight : 0;
          measured = fallbackOffset;
        }
        if(!measured || measured <= safeTop){
          const fallbackScroll = Number.isFinite(header.scrollHeight) ? header.scrollHeight : 0;
          measured = fallbackScroll;
        }
        measured = Math.max(0, measured - safeTop);
        if(!measured){
          const rootStyles = getComputedStyle(root);
          const current = parseFloat(rootStyles.getPropertyValue('--header-h')) || 0;
          if(current > 0){
            measured = current;
          }
        }
        if(measured > 0){
          root.style.setProperty('--header-h', `${measured}px`);
        }
      }
      if(typeof window.adjustListHeight === 'function'){
        window.adjustListHeight();
      }
    }
    window.updateLayoutVars = updateLayoutVars;

    function updatePostPanel(){ if(map) postPanel = map.getBounds(); }

    // === 0528 helpers: cluster contextmenu list (robust positioning + locking) ===
    let listLocked = false;
    let lastListOpenAt = 0;
    function lockMap(lock){
      listLocked = lock;
      const fn = lock ? 'disable' : 'enable';
      try{ map.dragPan[fn](); }catch(e){}
      try{ map.scrollZoom[fn](); }catch(e){}
      try{ map.boxZoom[fn](); }catch(e){}
      try{ map.keyboard[fn](); }catch(e){}
      try{ map.doubleClickZoom[fn](); }catch(e){}
      try{ map.touchZoomRotate[fn](); }catch(e){}
    }
    const MAX_CLUSTER_BOUNDS_LEAVES = 500;

    const MARKER_INTERACTIVE_LAYERS = ['marker-label','multi-marker-label'];
    window.__overCard = window.__overCard || false;

    function getPopupElement(popup){
      return popup && typeof popup.getElement === 'function' ? popup.getElement() : null;
    }

    function popupIsHovered(popup){
      const el = getPopupElement(popup);
      if(!el) return false;
      if(el.matches(':hover')) return true;
      try {
        return !!el.querySelector(':hover');
      } catch(err){
        return false;
      }
    }

    function schedulePopupRemoval(popup, delay=180){
      const target = popup || hoverPopup;
      if(!target) return;
      setTimeout(()=>{
        if(hoverPopup !== target) return;
        if(popupIsHovered(target)){
          window.__overCard = true;
          return;
        }
        window.__overCard = false;
        try{ target.remove(); }catch(e){}
        if(hoverPopup === target){
          hoverPopup = null;
        }
      }, delay);
    }

    function updateSelectedMarkerRing(){}

    function hashString(str){
      let hash = 0;
      for(let i=0;i<str.length;i++){
        hash = ((hash << 5) - hash) + str.charCodeAt(i);
        hash |= 0;
      }
      return hash.toString(36);
    }

    function getClusterLeavesAll(sourceId, clusterId, maxCount = Infinity, expectedCount){
      return new Promise((resolve)=>{
        const src = map.getSource(sourceId);
        if(!src) return resolve({ leaves: [], complete: false });
        const page = 50;
        const limit = Number.isFinite(maxCount) && maxCount >= 0 ? maxCount : Infinity;
        const totalExpected = Number.isFinite(expectedCount) && expectedCount >= 0 ? expectedCount : null;
        const collected = [];
        function step(offset){
          src.getClusterLeaves(clusterId, page, offset, (err, leaves)=>{
            if(err){ resolve({ leaves: [], complete: false }); return; }
            collected.push(...leaves);
            const haveAll = typeof totalExpected === 'number' ? collected.length >= totalExpected : leaves.length < page;
            const reachedLimit = collected.length >= limit;
            if(haveAll || reachedLimit || leaves.length === 0){
              const finalLeaves = limit < Infinity ? collected.slice(0, limit) : collected.slice();
              const complete = haveAll || (typeof totalExpected !== 'number' && !reachedLimit);
              resolve({ leaves: finalLeaves, complete });
              return;
            }
            step(offset + page);
          });
        }
        step(0);
      });
    }
    
function buildClusterListHTML(items){
  const allDates = items.flatMap(p=>p.dates).sort();
  const first = allDates[0];
  const last = allDates[allDates.length-1] || first;
  const fmt = iso => parseISODate(iso).toLocaleDateString('en-GB',{weekday:'short', day:'numeric', month:'short', year:'numeric'}).replace(',', '').replace(/ (\d{4})$/, ', $1');
  const head = `<div class="multi-head"><span class="multi-head-line">${items.length} posts here</span><span class="multi-head-line soonest"><span class="nowrap">${fmt(first)} - ${fmt(last)}</span></span></div>`;
  const sort = currentSort;
  const arr = items.slice();
  if(sort==='az') arr.sort((a,b)=> a.title.localeCompare(b.title));
  if(sort==='soon') arr.sort((a,b)=> a.dates[0].localeCompare(b.dates[0]));
  if(sort==='nearest'){
    let ref = {lng:0,lat:0}; if(map){ const c = map.getCenter(); ref = {lng:c.lng,lat:c.lat}; }
    arr.sort((a,b)=> distKm({lng:a.lng,lat:a.lat}, ref) - distKm({lng:b.lng,lat:b.lat}, ref));
  }
  if(favToTop && !favSortDirty) arr.sort((a,b)=> (b.fav - a.fav));
  const list = arr.map(p => {
    return `<div class=\"map-card-list-item\" data-id=\"${p.id}\">${mapCardHTML(p, { variant: 'list' })}</div>`;
  }).join('');
  return `<div class=\"multi-hover\">${head}<div class=\"multi-list map-card-list\">${list}</div></div>`;
}
    // 0530: group posts at the same venue (by coordinate)
    function lngDeltaWithWrap(a, b){
      if(!Number.isFinite(a) || !Number.isFinite(b)){
        return Number.POSITIVE_INFINITY;
      }
      const delta = ((a - b + 540) % 360) - 180;
      return Math.abs(delta);
    }

    function postsAtVenue(lng, lat){
      const list = (filtered.length ? filtered : posts);
      const eps = 1e-6; // ~0.1m at equator
      return list.filter(p => lngDeltaWithWrap(p.lng, lng) < eps && Math.abs(p.lat - lat) < eps);
    }

    function openListPopupAtPoint(point, htmlStr){
      // Remove previous
      if(hoverPopup){ hoverPopup.remove(); hoverPopup=null; }
      touchMarker = null;
      // Place popup at the pointer, then adjust to keep fully in view by moving the lngLat
      const lngLat = map.unproject(point);
      const containerRect = map.getContainer().getBoundingClientRect();
      const anchorPreference = (point.y - containerRect.top) > (containerRect.height / 2) ? 'bottom' : 'top';
      const popupOffset = {
        'top': [0, 10],
        'top-left': [0, 10],
        'top-right': [0, 10],
        'bottom': [0, -10],
        'bottom-left': [0, -10],
        'bottom-right': [0, -10],
        'left': [10, 0],
        'right': [-10, 0]
      };
      hoverPopup = new mapboxgl.Popup({maxWidth:'none', closeButton:false, closeOnClick:false, anchor:anchorPreference, className:'hover-pop multi-post-map-card map-card', offset:popupOffset}).setLngLat(lngLat).setHTML(htmlStr).addTo(map);
      registerPopup(hoverPopup);
      // Prevent the browser contextmenu while locked
      map.getCanvas().addEventListener('contextmenu', ev => ev.preventDefault(), {once:true});
      // Stop events inside from bubbling to map
      const el = hoverPopup.getElement();
      el.addEventListener('click', e => e.stopPropagation(), {capture:true});
      // After layout, ensure fully on-screen
      requestAnimationFrame(()=>{
        const rect = el.getBoundingClientRect();
        const cont = map.getContainer().getBoundingClientRect();
        let x = point.x, y = point.y;
        const pad = 12;
        let headerOffset = 0;
        try{
          const root = document.documentElement;
          if(root){
            const rootStyles = getComputedStyle(root);
            const headerH = parseFloat(rootStyles.getPropertyValue('--header-h')) || 0;
            const safeTop = parseFloat(rootStyles.getPropertyValue('--safe-top')) || 0;
            headerOffset = Math.max(0, headerH + safeTop);
          }
        }catch(err){}
        const topPad = pad + headerOffset;
        const maxX = cont.width - pad;
        const maxY = cont.height - pad;
        // If overflowing right/left, clamp
        if(rect.right > cont.right - pad) x -= (rect.right - (cont.right - pad));
        if(rect.left  < cont.left + pad)  x += (cont.left + pad - rect.left);
        // If overflowing bottom/top, clamp
        if(rect.bottom > cont.bottom - pad) y -= (rect.bottom - (cont.bottom - pad));
        if(rect.top    < cont.top + topPad)    y += (cont.top + topPad - rect.top);
        hoverPopup.setLngLat(map.unproject({x,y}));
      });
    }

    function setupMultiPopupInteractions(root, options = {}){
      if(!root) return { close: ()=>{} };
      const { lockOnOpen = false } = options;
      if(lockOnOpen){
        lockMap(true);
      }

      const close = ()=>{
        if(hoverPopup){
          try{ hoverPopup.remove(); }catch(err){}
          hoverPopup = null;
        }
        if(lockOnOpen){
          lockMap(false);
        }
      };

      const openPostFromPopup = (postId)=>{
        if(!postId) return;
        callWhenDefined('openPost', (fn)=>{
          requestAnimationFrame(() => {
            try{
              touchMarker = null;
              close();
              stopSpin();
              if(typeof closePanel === 'function' && typeof filterPanel !== 'undefined' && filterPanel){
                try{ closePanel(filterPanel); }catch(err){}
              }
              fn(postId, false, true);
            }catch(err){ console.error(err); }
          });
        });
      };

      root.addEventListener('click', (ev)=> ev.stopPropagation(), { capture: true });
      root.querySelectorAll('.map-card-list-item').forEach(node => {
        node.addEventListener('click', (evt)=>{
          evt.stopPropagation();
          evt.preventDefault();
          openPostFromPopup(node.getAttribute('data-id'));
        }, { capture: true });
      });

      const closeBtn = root.querySelector('[data-act="close"]');
      if(closeBtn){
        closeBtn.addEventListener('click', close);
      }

      root.addEventListener('click', (ev)=>{
        const row = ev.target && ev.target.closest ? ev.target.closest('.map-card-list-item') : null;
        if(!row) return;
        ev.stopPropagation();
        ev.preventDefault();
        openPostFromPopup(row.getAttribute('data-id'));
      }, { capture: true });

      return { close };
    }

    function showMultiVenuePopup(point, lng, lat, options = {}){
      if(!point || !Number.isFinite(lng) || !Number.isFinite(lat)) return null;
      const { items: providedItems = null, lockOnOpen = false } = options;
      const list = Array.isArray(providedItems) ? providedItems : postsAtVenue(lng, lat);
      if(!list || list.length <= 1){
        return null;
      }
      openListPopupAtPoint(point, buildClusterListHTML(list));
      const root = hoverPopup && hoverPopup.getElement ? hoverPopup.getElement() : null;
      if(!root){
        return null;
      }
      const { close } = setupMultiPopupInteractions(root, { lockOnOpen });
      return { root, close, items: list };
    }

    function bindPopupHoverGuards(el){
      if(!el) return;
      ['pointerdown','mousedown','mouseup','click'].forEach(type => {
        el.addEventListener(type, (ev)=>{
          try{ ev.preventDefault(); }catch(err){}
          try{ ev.stopPropagation(); }catch(err){}
        }, { capture: true });
      });
      el.addEventListener('mouseenter', ()=>{ window.__overCard = true; });
      el.addEventListener('mouseleave', ()=>{
        window.__overCard = false;
        if(listLocked) return;
        const currentPopup = hoverPopup;
        schedulePopupRemoval(currentPopup, 160);
      });
    }

    function mulberry32(a){ return function(){var t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15, t|1); t^=t+Math.imul(t^t>>>7, t|61); return ((t^t>>>14)>>>0)/4294967296; }; }
    const rnd = mulberry32(42);

    const cities = [
      {n:"Melbourne, Australia", c:[144.9631,-37.8136]},
      {n:"Sydney, Australia", c:[151.2093,-33.8688]},
      {n:"London, UK", c:[-0.1276,51.5072]},
      {n:"New York, USA", c:[-74.0060,40.7128]},
      {n:"Tokyo, Japan", c:[139.6917,35.6895]},
      {n:"Paris, France", c:[2.3522,48.8566]},
      {n:"Rio de Janeiro, Brazil", c:[-43.1729,-22.9068]},
      {n:"Cape Town, South Africa", c:[18.4241,-33.9249]},
      {n:"Reykjavík, Iceland", c:[-21.8174,64.1265]},
      {n:"Mumbai, India", c:[72.8777,19.0760]}
    ];
    const categories = window.categories = [
      { name:"What's On", subs:["Live Gigs","Live Theatre","Screenings","Artwork","Live Sport","Other Events"] },
      { name:"Opportunities", subs:["Stage Auditions","Screen Auditions","Clubs","Jobs","Volunteers","Competitions","Other Opportunities"] },
      { name:"Learning", subs:["Tutors","Education Centres","Courses","Other Learning"] },
      { name:"Buy and Sell", subs:["Wanted","For Sale","Freebies"] },
      { name:"For Hire", subs:["Performers","Staff","Goods and Services"] }
    ];
      const ICON_BASE = window.ICON_BASE = {
        "What's On": "whats-on-category-icon",
        "Opportunities": "opportunities-category-icon",
        "Learning": "learning-category-icon",
        "Buy and Sell": "Buy-and-sell-category-icon",
        "For Hire": "For-hire-category-icon"
      };
    const COLOR_NAMES = window.COLOR_NAMES = ['blue','dark-yellow','green','indigo','orange','red','violet'];
    const subcategoryIcons = window.subcategoryIcons = {};
    const subcategoryMarkers = window.subcategoryMarkers = {};
    const subcategoryMarkerIds = window.subcategoryMarkerIds = {};
    const categoryShapes = window.categoryShapes = {};

    // --- Icon loader: ensures Mapbox images are available and quiets missing-image logs ---
    function attachIconLoader(mapInstance){
      if(!mapInstance) return () => Promise.resolve(false);
      const KNOWN = [
        'freebies','live-sport','volunteers','goods-and-services','clubs','artwork',
        'live-gigs','for-sale','education-centres','tutors',
        'multi-venue-marker'
      ];
      const BASES = [
        'assets/icons/subcategories/',
        'assets/icons/',
        'assets/images/icons/'
      ];
      const pending = new Map();

      const urlsFor = (name) => {
        const urls = [];
        const markers = window.subcategoryMarkers || {};
        const manual = markers[name] || null;
        const shouldLookupLocal = manual || KNOWN.includes(name);
        if(manual) urls.push(manual);
        if(shouldLookupLocal){
          const ratio = (window.devicePixelRatio || 1) >= 2 ? '@2x' : '';
          BASES.forEach(base => urls.push(`${base}${name}${ratio}.png`));
          BASES.forEach(base => urls.push(`${base}${name}.png`));
        }
        return { urls, shouldLookupLocal };
      };

      function loadImageCompat(url){
        return new Promise((resolve, reject) => {
          if(typeof mapInstance.loadImage === 'function'){
            mapInstance.loadImage(url, (err, img) => err ? reject(err) : resolve(img));
          } else {
            fetch(url)
              .then(r => r.ok ? r.blob() : Promise.reject(url))
              .then(blob => createImageBitmap(blob))
              .then(resolve)
              .catch(reject);
          }
        });
      }

      function pickPixelRatio(url, img){
        if(typeof url === 'string' && /@2x\.[^./]+$/i.test(url)){
          return 2;
        }
        return 1;
      }

      function placeholder(name){
        const canvas = document.createElement('canvas');
        canvas.width = 48;
        canvas.height = 48;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#222';
        ctx.beginPath();
        ctx.arc(24, 24, 24, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 20px system-ui, sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText((name && name[0] ? name[0] : '?').toUpperCase(), 24, 24);
        return canvas;
      }

      async function addIcon(name){
        if(!name) return false;
        if(mapInstance.hasImage?.(name)) return true;
        if(pending.has(name)) return pending.get(name);
        const task = (async () => {
          const { urls, shouldLookupLocal } = urlsFor(name);
          if(!urls.length && !shouldLookupLocal){
            try{ mapInstance.addImage(name, placeholder(name)); }catch(err){}
            return false;
          }
          for(const url of urls){
            try{
              const img = await loadImageCompat(url);
              if(mapInstance.hasImage?.(name)) return true;
              const pixelRatio = pickPixelRatio(url, img);
              mapInstance.addImage(name, img, { sdf:false, pixelRatio });
              return true;
            }catch(err){}
          }
          try{ mapInstance.addImage(name, placeholder(name)); }catch(err){}
          return false;
        })().finally(() => pending.delete(name));
        pending.set(name, task);
        return task;
      }

      mapInstance.on('style.load', async () => {
        try{ ensureMarkerLabelBackground(mapInstance); }catch(err){}
        try{ reapplyMarkerLabelComposites(mapInstance); }catch(err){}
        const markers = window.subcategoryMarkers || {};
        const preload = new Set([...KNOWN, ...Object.keys(markers)]);
        for(const iconName of preload){
          try{ await addIcon(iconName); }catch(err){}
        }
      });

      mapInstance.on('styleimagemissing', e => {
        if(!e || !e.id) return;
        if(e.id === MARKER_LABEL_BG_ID){
          try{ ensureMarkerLabelBackground(mapInstance); }catch(err){}
          return;
        }
        if(e.id.startsWith(MARKER_LABEL_COMPOSITE_PREFIX)){
          const spriteId = e.id.slice(MARKER_LABEL_COMPOSITE_PREFIX.length);
          const meta = markerLabelCompositeStore.get(spriteId) || {};
          ensureMarkerLabelComposite(mapInstance, spriteId, meta.iconId, meta.labelLine1, meta.labelLine2, meta.isMulti);
          return;
        }
        addIcon(e.id);
      });

      return addIcon;
    }

    const MULTI_VENUE_MARKER_ID = 'multi-venue-marker';
    const MULTI_VENUE_MARKER_URL = 'assets/icons-30/multi-post-icon-30.webp';
    const MULTI_VENUE_COORD_PRECISION = 6;
    const venueKey = (lng, lat) => `${lng.toFixed(MULTI_VENUE_COORD_PRECISION)},${lat.toFixed(MULTI_VENUE_COORD_PRECISION)}`;
    subcategoryMarkers[MULTI_VENUE_MARKER_ID] = MULTI_VENUE_MARKER_URL;

    function setSelectedVenueHighlight(lng, lat){
      if(Number.isFinite(lng) && Number.isFinite(lat)){
        const key = venueKey(lng, lat);
        if(selectedVenueKey !== key){
          selectedVenueKey = key;
          updateSelectedMarkerRing();
        }
      } else if(selectedVenueKey !== null){
        selectedVenueKey = null;
        updateSelectedMarkerRing();
      }
    }

    function ensureSvgDimensions(svg){
      try{
        const doc = new DOMParser().parseFromString(svg, 'image/svg+xml');
        const el = doc.documentElement;
        let w = parseFloat(el.getAttribute('width'));
        let h = parseFloat(el.getAttribute('height'));
        const viewBox = el.getAttribute('viewBox');
        if((!w || !h) && viewBox){
          const parts = viewBox.split(/[ ,]/).map(Number);
          if(parts.length === 4){
            w = w || parts[2];
            h = h || parts[3];
          }
        }
        if(!w) w = 40;
        if(!h) h = 40;
        el.setAttribute('width', w);
        el.setAttribute('height', h);
        return {svg: new XMLSerializer().serializeToString(el), width: w, height: h};
      }catch(e){
        return {svg, width:40, height:40};
      }
    }
// 0585: unique title generator (with location; no category prefix)
const __ADJ = ["Radiant","Indigo","Velvet","Silver","Crimson","Neon","Amber","Sapphire","Emerald","Electric","Roaring","Midnight","Sunlit","Ethereal","Urban","Astral","Analog","Digital","Windswept","Golden","Hidden","Avant","Cosmic","Garden","Quiet","Vivid","Obsidian","Scarlet","Cerulean","Lunar","Solar","Autumn","Verdant","Azure"];
const __NOUN = ["Symphony","Market","Carnival","Showcase","Assembly","Parade","Salon","Summit","Expo","Soirée","Revue","Collective","Fair","Gathering","Series","Retrospective","Circuit","Sessions","Weekender","Festival","Bazaar","Program","Tableau","Odyssey","Forum","Mosaic","Canvas","Relay","Drift","Workshop","Lab"];
const __HOOK = ["at Dusk","of Ideas","in Motion","for Everyone","Remix","Live","Reborn","MKII","Redux","Infinite","Prime","Pulse","Wave","Future","Now","Unlocked","Extended","Panorama","Unbound","Edition","Run","Sequence"];
function __rng(seed){ let s = seed|0; return ()=> (s = (s*1664525 + 1013904223)>>>0); }
const __USED_BIGRAMS = new Set();
function uniqueTitle(seed, cityName, idx){
  // Deterministic RNG with attempt salt for conflict resolution
  const base = (seed||0) ^ ((idx||0)*99991);

  const normalize = (s)=> s
    .replace(/[^\p{L}\p{N}]+/gu,' ')
    .trim()
    .split(/\s+/)
    .filter(Boolean);

  const lower = (ws)=> ws.map(w=> w.toLowerCase());

  const bigrams = (words)=> {
    const out = [];
    for(let i=0;i<words.length-1;i++) out.push(words[i]+" "+words[i+1]);
    return out;
  };

  const violates = (title)=> {
    const ws = normalize(title);
    const lc = lower(ws);
    if(!ws.length) return true;

    // no duplicate adjacent words inside one title
    for(let i=0;i<lc.length-1;i++){
      if(lc[i]===lc[i+1]) return true;
    }
    // any bigram seen before globally?
    const b = bigrams(lc);
    for(const bg of b){ if(__USED_BIGRAMS.has(bg)) return true; }

    return false;
  };

  const pickFrom = (r, arr)=> arr[r()%arr.length];

  // Word banks
  const A = __ADJ, N = __NOUN, H = __HOOK;
  const ARTISTS = [
    "The Silver Comets","Neon Parade","Paper Lanterns","Velvet Echoes","Indigo Quartet",
    "The Jet Set","Crimson Tide","Midnight Radio","Electric Hearts","Golden Hour",
    "The Amber Rooms","Violet Skyline","Satellite City","The Night Owls","Ivory Street Band",
    "Bluebird Company","Marble Garden","Velvet Undergrounders","Echo Park Players","Lantern Light",
    "Harbor & Co.","The Carousel Club","Kite & Canvas","Saffron Society","The Prairie Dogs"
  ];
  const PLAY_FORMS = [
    "Picture Show","Live on Stage","In Concert","Experience","Cabaret","Showcase",
    "Festival","Gala","Residency","Matinee","After Dark","Revue","Workshop"
  ];
  const STORY_OPENERS = [
    "Once Upon a Time","Into the Unknown","A Night to Remember","Between Two Worlds",
    "The Last Carousel","Dreams of Summer","Echoes in the Hall","Velvet Midnight",
    "The Paper Moon","Lanterns at Dusk","The Long Goodbye","Morning After Dark","Before the Storm"
  ];
  const TOUR_TAGS = ["Greatest Hits","Unplugged","Anniversary Tour","Acoustic Sessions","Late Night Set"];
  const PROMOS = ["One Night Only!","Two Nights Only!","One Weekend Only!","2 weeks only!!","Limited Season","Encore Performance"];

  const makeTitle = (r)=>{
    const templates = [
      ()=> `${pickFrom(r, ARTISTS)} Live on Stage`,
      ()=> `${pickFrom(r, ARTISTS)} — ${pickFrom(r, TOUR_TAGS)}`,
      ()=> `An Evening with ${pickFrom(r, ARTISTS)}`,
      ()=> `The ${pickFrom(r, N)} ${pickFrom(r, PLAY_FORMS)}`,
      ()=> `The ${pickFrom(r, A)} ${pickFrom(r, N)}`,
      ()=> `${pickFrom(r, A)} ${pickFrom(r, N)} ${pickFrom(r, H)}`,
      ()=> `${pickFrom(r, STORY_OPENERS)}`,
      ()=> `${pickFrom(r, A)} ${pickFrom(r, N)}: ${pickFrom(r, H)}`,
      ()=> `${pickFrom(r, A)} ${pickFrom(r, N)} ${pickFrom(r, PLAY_FORMS)}`,
      ()=> `${pickFrom(r, N)} ${pickFrom(r, PLAY_FORMS)}`
    ];
    let t = templates[r()%templates.length]();
    if ((r()%4)===0) t += ` — ${pickFrom(r, PROMOS)}`;
    return t.replace(/\s+/g,' ').trim();
  };

  // Try multiple deterministic attempts with salted RNG until constraints satisfied
  let attempt = 0, title = "";
  for(; attempt < 96; attempt++){
    const r = __rng(base ^ (attempt * 1315423911));
    const candidate = makeTitle(r);
    if(!violates(candidate)){
      title = candidate;
      break;
    }
  }
  if(!title){ title = makeTitle(__rng(base ^ 0x9e3779b9)); } // fallback

  // Commit global constraints
  const ws = lower(normalize(title));
  for(let i=0;i<ws.length-1;i++){ __USED_BIGRAMS.add(ws[i]+" "+ws[i+1]); }

  return title;
}function pick(arr){ return arr[Math.floor(rnd()*arr.length)]; }
    function jitter([lng,lat]){ return [lng + (rnd()-0.5)*8, clamp(lat + (rnd()-0.5)*8,-80,80)]; }

  function toISODate(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  function parseISODate(s){
    const [yy, mm, dd] = s.split('-').map(Number);
    return new Date(yy, mm - 1, dd);
  }

  function randomDates(){
    const count = 1 + Math.floor(rnd()*30);
    const now = new Date();
    return Array.from({length:count}, ()=>{
      const d = new Date(+now + Math.floor(rnd()*365)*86400000);
      return toISODate(d);
    }).sort();
  }

  const REAL_VENUES = {
    "Federation Square, Melbourne": [
      { venue: "Federation Square", address: "Swanston St & Flinders St, Melbourne VIC 3000, Australia", lng: 144.9695, lat: -37.8178 },
      { venue: "ACMI", address: "Fed Square, Flinders St, Melbourne VIC 3000, Australia", lng: 144.9696, lat: -37.8177 },
      { venue: "Deakin Edge", address: "Fed Square, Melbourne VIC 3000, Australia", lng: 144.9699, lat: -37.8182 },
      { venue: "The Atrium at Fed Square", address: "Flinders St, Melbourne VIC 3000, Australia", lng: 144.9698, lat: -37.8173 },
      { venue: "Ian Potter Centre: NGV Australia", address: "Federation Square, Melbourne VIC 3000, Australia", lng: 144.9692, lat: -37.8171 },
      { venue: "Koorie Heritage Trust", address: "Yarra Building, Federation Square, Melbourne VIC 3000, Australia", lng: 144.9690, lat: -37.8175 }
    ],
    "Hobart, Tasmania": [
      { venue: "Hobart Town Hall", address: "50 Macquarie St, Hobart TAS 7000, Australia", lng: 147.3291, lat: -42.8810 },
      { venue: "Theatre Royal", address: "29 Campbell St, Hobart TAS 7000, Australia", lng: 147.3297, lat: -42.8798 },
      { venue: "Salamanca Arts Centre", address: "77 Salamanca Pl, Hobart TAS 7004, Australia", lng: 147.3336, lat: -42.8874 },
      { venue: "Princes Wharf No. 1", address: "Castray Esplanade, Hobart TAS 7000, Australia", lng: 147.3337, lat: -42.8892 },
      { venue: "Federation Concert Hall", address: "1 Davey St, Hobart TAS 7000, Australia", lng: 147.3271, lat: -42.8799 },
      { venue: "Mona", address: "655 Main Rd, Berriedale TAS 7011, Australia", lng: 147.2580, lat: -42.8262 }
    ],
    "New York, USA": [
      { venue: "Madison Square Garden", address: "4 Pennsylvania Plaza, New York, NY 10001, USA", lng: -73.9934, lat: 40.7505 },
      { venue: "Radio City Music Hall", address: "1260 6th Ave, New York, NY 10020, USA", lng: -73.9787, lat: 40.7599 },
      { venue: "Carnegie Hall", address: "881 7th Ave, New York, NY 10019, USA", lng: -73.9799, lat: 40.7651 },
      { venue: "Lincoln Center", address: "10 Lincoln Center Plaza, New York, NY 10023, USA", lng: -73.9850, lat: 40.7729 },
      { venue: "Brooklyn Academy of Music", address: "30 Lafayette Ave, Brooklyn, NY 11217, USA", lng: -73.9772, lat: 40.6860 },
      { venue: "Barclays Center", address: "620 Atlantic Ave, Brooklyn, NY 11217, USA", lng: -73.9757, lat: 40.6827 }
    ],
    "Los Angeles, USA": [
      { venue: "Hollywood Bowl", address: "2301 N Highland Ave, Los Angeles, CA 90068, USA", lng: -118.3386, lat: 34.1122 },
      { venue: "Dolby Theatre", address: "6801 Hollywood Blvd, Hollywood, CA 90028, USA", lng: -118.3400, lat: 34.1020 },
      { venue: "Crypto.com Arena", address: "1111 S Figueroa St, Los Angeles, CA 90015, USA", lng: -118.2670, lat: 34.0430 },
      { venue: "Greek Theatre", address: "2700 N Vermont Ave, Los Angeles, CA 90027, USA", lng: -118.2965, lat: 34.1192 },
      { venue: "Microsoft Theater", address: "777 Chick Hearn Ct, Los Angeles, CA 90015, USA", lng: -118.2667, lat: 34.0443 },
      { venue: "Walt Disney Concert Hall", address: "111 S Grand Ave, Los Angeles, CA 90012, USA", lng: -118.2498, lat: 34.0553 }
    ],
    "London, UK": [
      { venue: "Royal Albert Hall", address: "Kensington Gore, South Kensington, London SW7 2AP, UK", lng: -0.1780, lat: 51.5009 },
      { venue: "The O2", address: "Peninsula Square, London SE10 0DX, UK", lng: 0.0032, lat: 51.5030 },
      { venue: "Barbican Centre", address: "Silk St, London EC2Y 8DS, UK", lng: -0.0910, lat: 51.5199 },
      { venue: "Southbank Centre", address: "Belvedere Rd, London SE1 8XX, UK", lng: -0.1154, lat: 51.5051 },
      { venue: "Roundhouse", address: "Chalk Farm Rd, London NW1 8EH, UK", lng: -0.1527, lat: 51.5430 },
      { venue: "Alexandra Palace", address: "Alexandra Palace Way, London N22 7AY, UK", lng: -0.1280, lat: 51.5942 }
    ],
    "Paris, France": [
      { venue: "Philharmonie de Paris", address: "221 Av. Jean Jaurès, 75019 Paris, France", lng: 2.3932, lat: 48.8899 },
      { venue: "Accor Arena", address: "8 Bd de Bercy, 75012 Paris, France", lng: 2.3770, lat: 48.8389 },
      { venue: "Le Grand Rex", address: "1 Bd Poissonnière, 75002 Paris, France", lng: 2.3488, lat: 48.8706 },
      { venue: "L'Olympia", address: "28 Bd des Capucines, 75009 Paris, France", lng: 2.3282, lat: 48.8694 },
      { venue: "Théâtre Mogador", address: "25 Rue de Mogador, 75009 Paris, France", lng: 2.3326, lat: 48.8760 },
      { venue: "Palais des Congrès de Paris", address: "2 Pl. de la Prte Maillot, 75017 Paris, France", lng: 2.2835, lat: 48.8782 }
    ],
    "Berlin, Germany": [
      { venue: "Mercedes-Benz Arena Berlin", address: "Mercedes-Platz 1, 10243 Berlin, Germany", lng: 13.4433, lat: 52.5051 },
      { venue: "Tempodrom", address: "Möckernstrasse 10, 10963 Berlin, Germany", lng: 13.3837, lat: 52.5034 },
      { venue: "Konzerthaus Berlin", address: "Gendarmenmarkt, 10117 Berlin, Germany", lng: 13.3933, lat: 52.5136 },
      { venue: "Waldbühne", address: "Glockenturmstraße 1, 14053 Berlin, Germany", lng: 13.2414, lat: 52.5125 },
      { venue: "Max-Schmeling-Halle", address: "Falkplatz 1, 10437 Berlin, Germany", lng: 13.4071, lat: 52.5483 },
      { venue: "Admiralspalast", address: "Friedrichstraße 101, 10117 Berlin, Germany", lng: 13.3878, lat: 52.5219 }
    ],
    "Madrid, Spain": [
      { venue: "WiZink Center", address: "Av. de Felipe II, s/n, 28009 Madrid, Spain", lng: -3.6711, lat: 40.4237 },
      { venue: "Teatro Real", address: "Pl. de Isabel II, s/n, 28013 Madrid, Spain", lng: -3.7104, lat: 40.4170 },
      { venue: "IFEMA Madrid", address: "Av. del Partenón, 5, 28042 Madrid, Spain", lng: -3.6156, lat: 40.4678 },
      { venue: "Auditorio Nacional de Música", address: "C. del Príncipe de Vergara, 146, 28002 Madrid, Spain", lng: -3.6845, lat: 40.4383 },
      { venue: "Teatro Lope de Vega", address: "C. Gran Vía, 57, 28013 Madrid, Spain", lng: -3.7070, lat: 40.4201 },
      { venue: "Palacio Vistalegre", address: "C. de Matilde Hernández, 100, 28025 Madrid, Spain", lng: -3.7344, lat: 40.3820 }
    ],
    "Rome, Italy": [
      { venue: "Auditorium Parco della Musica", address: "V.le Pietro de Coubertin, 30, 00196 Roma RM, Italy", lng: 12.4823, lat: 41.9287 },
      { venue: "Stadio Olimpico", address: "V.le dei Gladiatori, 00135 Roma RM, Italy", lng: 12.4547, lat: 41.9341 },
      { venue: "Palazzo dello Sport", address: "Piazzale Pier Luigi Nervi, 1, 00144 Roma RM, Italy", lng: 12.4709, lat: 41.8308 },
      { venue: "Teatro dell'Opera di Roma", address: "Piazza Beniamino Gigli, 7, 00184 Roma RM, Italy", lng: 12.4946, lat: 41.9008 },
      { venue: "Cinecittà Studios", address: "Via Tuscolana, 1055, 00173 Roma RM, Italy", lng: 12.5727, lat: 41.8545 },
      { venue: "Casa del Jazz", address: "Viale di Porta Ardeatina, 55, 00154 Roma RM, Italy", lng: 12.4920, lat: 41.8729 }
    ],
    "Amsterdam, NL": [
      { venue: "Paradiso Amsterdam", address: "Weteringschans 6-8, 1017 SG Amsterdam, Netherlands", lng: 4.8839, lat: 52.3620 },
      { venue: "Melkweg", address: "Lijnbaansgracht 234A, 1017 PH Amsterdam, Netherlands", lng: 4.8830, lat: 52.3630 },
      { venue: "Concertgebouw", address: "Concertgebouwplein 10, 1071 LN Amsterdam, Netherlands", lng: 4.8791, lat: 52.3569 },
      { venue: "AFAS Live", address: "ArenA Boulevard 590, 1101 DS Amsterdam, Netherlands", lng: 4.9514, lat: 52.3122 },
      { venue: "Ziggo Dome", address: "De Passage 100, 1101 AX Amsterdam, Netherlands", lng: 4.9442, lat: 52.3136 },
      { venue: "Westergas", address: "Klönneplein 1, 1014 DD Amsterdam, Netherlands", lng: 4.8710, lat: 52.3876 }
    ],
    "Dublin, Ireland": [
      { venue: "3Arena", address: "N Wall Quay, North Dock, Dublin 1, Ireland", lng: -6.2288, lat: 53.3479 },
      { venue: "The Olympia Theatre", address: "73 Dame St, Temple Bar, Dublin 2, Ireland", lng: -6.2666, lat: 53.3448 },
      { venue: "National Concert Hall", address: "Earlsfort Terrace, Saint Kevin's, Dublin, Ireland", lng: -6.2581, lat: 53.3347 },
      { venue: "Vicar Street", address: "58 Thomas St, The Liberties, Dublin, Ireland", lng: -6.2823, lat: 53.3421 },
      { venue: "Aviva Stadium", address: "Lansdowne Rd, Dublin 4, Ireland", lng: -6.2250, lat: 53.3351 },
      { venue: "Croke Park", address: "Jones' Rd, Drumcondra, Dublin 3, Ireland", lng: -6.2525, lat: 53.3607 }
    ],
    "Stockholm, Sweden": [
      { venue: "Avicii Arena", address: "Globentorget 2, 121 77 Johanneshov, Sweden", lng: 18.0837, lat: 59.2933 },
      { venue: "Friends Arena", address: "Råsta strandväg 1, 169 56 Solna, Sweden", lng: 18.0009, lat: 59.3725 },
      { venue: "Stockholm Concert Hall", address: "Hötorget 8, 103 87 Stockholm, Sweden", lng: 18.0686, lat: 59.3341 },
      { venue: "Cirkus", address: "Djurgårdsslätten 43-45, 115 21 Stockholm, Sweden", lng: 18.1082, lat: 59.3232 },
      { venue: "Annexet", address: "Arenatorget 1, 121 77 Johanneshov, Sweden", lng: 18.0831, lat: 59.2945 },
      { venue: "Skansen Solliden Stage", address: "Djurgårdsslätten 49-51, 115 21 Stockholm, Sweden", lng: 18.1035, lat: 59.3253 }
    ],
    "Copenhagen, Denmark": [
      { venue: "Royal Arena", address: "Hannemanns Allé 20, 2300 København, Denmark", lng: 12.5806, lat: 55.6287 },
      { venue: "DR Koncerthuset", address: "Ørestads Blvd. 13, 2300 København, Denmark", lng: 12.5766, lat: 55.6611 },
      { venue: "Tivoli Concert Hall", address: "Vesterbrogade 3, 1630 København, Denmark", lng: 12.5663, lat: 55.6725 },
      { venue: "VEGA", address: "Enghavevej 40, 1674 København, Denmark", lng: 12.5553, lat: 55.6668 },
      { venue: "Forum Copenhagen", address: "Julius Thomsens Pl. 1, 1925 Frederiksberg, Denmark", lng: 12.5516, lat: 55.6795 },
      { venue: "KB Hallen", address: "Peter Bangs Vej 147, 2000 Frederiksberg, Denmark", lng: 12.5106, lat: 55.6820 }
    ],
    "Helsinki, Finland": [
      { venue: "Helsinki Music Centre", address: "Mannerheimintie 13 A, 00100 Helsinki, Finland", lng: 24.9386, lat: 60.1722 },
      { venue: "Hartwall Arena", address: "Areenankuja 1, 00240 Helsinki, Finland", lng: 24.9171, lat: 60.2056 },
      { venue: "Savoy Theatre", address: "Kasarmikatu 46-48, 00130 Helsinki, Finland", lng: 24.9479, lat: 60.1696 },
      { venue: "Finlandia Hall", address: "Mannerheimintie 13e, 00100 Helsinki, Finland", lng: 24.9330, lat: 60.1731 },
      { venue: "Cable Factory", address: "Tallberginkatu 1 C, 00180 Helsinki, Finland", lng: 24.9056, lat: 60.1611 },
      { venue: "Helsinki Ice Hall", address: "Nordenskiöldinkatu 11-13, 00250 Helsinki, Finland", lng: 24.9185, lat: 60.1997 }
    ],
    "Oslo, Norway": [
      { venue: "Oslo Spektrum", address: "Sonja Henies plass 2, 0185 Oslo, Norway", lng: 10.7528, lat: 59.9131 },
      { venue: "Rockefeller Music Hall", address: "Torggata 16, 0181 Oslo, Norway", lng: 10.7520, lat: 59.9175 },
      { venue: "Norwegian National Opera & Ballet", address: "Kirsten Flagstads Plass 1, 0150 Oslo, Norway", lng: 10.7525, lat: 59.9076 },
      { venue: "Sentrum Scene", address: "Arbeidersamfunnets plass 1, 0181 Oslo, Norway", lng: 10.7463, lat: 59.9145 },
      { venue: "Det Norske Teatret", address: "Kristian IVs gate 8, 0164 Oslo, Norway", lng: 10.7407, lat: 59.9138 },
      { venue: "Chateau Neuf", address: "Slemdalsveien 15, 0369 Oslo, Norway", lng: 10.7154, lat: 59.9292 }
    ],
    "Reykjavík, Iceland": [
      { venue: "Harpa Concert Hall", address: "Austurbakki 2, 101 Reykjavík, Iceland", lng: -21.9336, lat: 64.1505 },
      { venue: "Laugardalshöll", address: "Engjavegur 8, 104 Reykjavík, Iceland", lng: -21.8954, lat: 64.1415 },
      { venue: "Gamla Bíó", address: "Ingólfsstræti 2A, 101 Reykjavík, Iceland", lng: -21.9385, lat: 64.1468 },
      { venue: "Reykjavík City Theatre", address: "Listabraut 3, 103 Reykjavík, Iceland", lng: -21.9173, lat: 64.1377 },
      { venue: "Háskólabíó", address: "Hagatorg, 107 Reykjavík, Iceland", lng: -21.9492, lat: 64.1426 },
      { venue: "IÐNÓ", address: "Vonarstræti 3, 101 Reykjavík, Iceland", lng: -21.9393, lat: 64.1454 }
    ],
    "Moscow, Russia": [
      { venue: "Bolshoi Theatre", address: "Teatralnaya Ploshchad, 1, Moskva, Russia, 125009", lng: 37.6208, lat: 55.7601 },
      { venue: "Crocus City Hall", address: "Mezhdunarodnaya 20, Krasnogorsk, Moscow Oblast, Russia", lng: 37.3855, lat: 55.8220 },
      { venue: "VTB Arena", address: "Leningradsky Ave, 36, Moskva, Russia, 125167", lng: 37.5599, lat: 55.7915 },
      { venue: "Moscow International House of Music", address: "Kosmodamianskaya Naberezhnaya, 52, строение 8, Moskva, Russia, 115054", lng: 37.6551, lat: 55.7329 },
      { venue: "Luzhniki Stadium", address: "Luzhniki St, 24, Moskva, Russia, 119048", lng: 37.5531, lat: 55.7158 },
      { venue: "Izvestia Hall", address: "Tverskaya St, 3, Moskva, Russia, 125009", lng: 37.6082, lat: 55.7665 }
    ],
    "Istanbul, Türkiye": [
      { venue: "Volkswagen Arena Istanbul", address: "Huzur, Maslak Mahallesi, Saryer/İstanbul, Türkiye", lng: 29.0217, lat: 41.1063 },
      { venue: "Zorlu Performing Arts Center", address: "Levazım, Koru Sokağı, Beşiktaş/İstanbul, Türkiye", lng: 29.0127, lat: 41.0675 },
      { venue: "Cemal Reşit Rey Concert Hall", address: "Harbiye Mahallesi, Darülbedayi Cd. No:3, Şişli/İstanbul, Türkiye", lng: 28.9947, lat: 41.0417 },
      { venue: "Istanbul Congress Center", address: "Harbiye Mahallesi, Darülbedayi Cd. No:4, Şişli/İstanbul, Türkiye", lng: 28.9881, lat: 41.0410 },
      { venue: "Sinan Erdem Dome", address: "Ataköy 2-5-6, Bakırköy/İstanbul, Türkiye", lng: 28.8468, lat: 40.9874 },
      { venue: "Ülker Sports Arena", address: "Barbaros, Dereboyu Cd. No:9, Ataşehir/İstanbul, Türkiye", lng: 29.1034, lat: 40.9828 }
    ],
    "Athens, Greece": [
      { venue: "Stavros Niarchos Hall", address: "364 Syggrou Ave, Kallithea 176 74, Greece", lng: 23.7021, lat: 37.9393 },
      { venue: "Odeon of Herodes Atticus", address: "Dionysiou Areopagitou, Athens 105 55, Greece", lng: 23.7223, lat: 37.9715 },
      { venue: "Megaron Athens Concert Hall", address: "Vas. Sofias 1, Athens 115 21, Greece", lng: 23.7529, lat: 37.9794 },
      { venue: "Technopolis City of Athens", address: "100 Pireos St, Athens 118 54, Greece", lng: 23.7104, lat: 37.9775 },
      { venue: "Panathenaic Stadium", address: "Leof. Vasileos Konstantinou, Athens 116 35, Greece", lng: 23.7415, lat: 37.9680 },
      { venue: "Gazarte", address: "32-34 Voutadon St, Athens 118 54, Greece", lng: 23.7037, lat: 37.9788 }
    ],
    "Cairo, Egypt": [
      { venue: "Cairo Opera House", address: "Opera Square, Zamalek, Cairo Governorate, Egypt", lng: 31.2242, lat: 30.0427 },
      { venue: "Cairo International Convention Centre", address: "El Nasr Rd, Cairo Governorate, Egypt", lng: 31.3299, lat: 30.0723 },
      { venue: "El Sawy Culturewheel", address: "26th of July Corridor, Zamalek, Cairo Governorate, Egypt", lng: 31.2255, lat: 30.0659 },
      { venue: "Al Azhar Park", address: "El-Darb El-Ahmar, Cairo Governorate, Egypt", lng: 31.2696, lat: 30.0411 },
      { venue: "Manara International Conference Center", address: "New Cairo 3, Cairo Governorate, Egypt", lng: 31.3777, lat: 30.0692 },
      { venue: "Gomhouria Theatre", address: "Qasr Al Nile, Abdeen, Cairo Governorate, Egypt", lng: 31.2485, lat: 30.0472 }
    ],
    "Nairobi, Kenya": [
      { venue: "Kenyatta International Convention Centre", address: "Harambee Ave, Nairobi, Kenya", lng: 36.8217, lat: -1.2886 },
      { venue: "Sarit Expo Centre", address: "Karuna Rd, Nairobi, Kenya", lng: 36.8044, lat: -1.2658 },
      { venue: "Kenya National Theatre", address: "Harry Thuku Rd, Nairobi, Kenya", lng: 36.8137, lat: -1.2807 },
      { venue: "Bomas of Kenya", address: "Langata Rd, Nairobi, Kenya", lng: 36.7725, lat: -1.3318 },
      { venue: "Carnivore Grounds", address: "Langata Rd, Nairobi, Kenya", lng: 36.8054, lat: -1.3224 },
      { venue: "The Alchemist", address: "Parklands Rd, Nairobi, Kenya", lng: 36.8000, lat: -1.2689 }
    ],
    "Lagos, Nigeria": [
      { venue: "Eko Convention Centre", address: "1415 Adetokunbo Ademola St, Victoria Island, Lagos, Nigeria", lng: 3.4216, lat: 6.4260 },
      { venue: "Terra Kulture", address: "1376 Tiamiyu Savage St, Victoria Island, Lagos, Nigeria", lng: 3.4231, lat: 6.4304 },
      { venue: "Muson Centre", address: "8/9 Marina, Onikan, Lagos, Nigeria", lng: 3.4218, lat: 6.4333 },
      { venue: "Freedom Park Lagos", address: "1 Hospital Rd, Lagos Island, Lagos, Nigeria", lng: 3.3947, lat: 6.4474 },
      { venue: "Landmark Event Centre", address: "Plot 2&3 Water Corporation Dr, Victoria Island, Lagos, Nigeria", lng: 3.4327, lat: 6.4268 },
      { venue: "National Theatre Lagos", address: "Iganmu Rd, Lagos, Nigeria", lng: 3.3706, lat: 6.4760 }
    ],
    "Johannesburg, SA": [
      { venue: "FNB Stadium", address: "Nasrec Rd, Johannesburg, 2147, South Africa", lng: 27.9826, lat: -26.2348 },
      { venue: "Emperors Palace Convention Centre", address: "64 Jones Rd, Kempton Park, Johannesburg, South Africa", lng: 28.2217, lat: -26.1390 },
      { venue: "Sandton Convention Centre", address: "Maude St, Sandown, Sandton, 2196, South Africa", lng: 28.0575, lat: -26.1076 },
      { venue: "Lyric Theatre", address: "Gold Reef City, Northern Pkwy, Ormonde, Johannesburg, South Africa", lng: 28.0115, lat: -26.2351 },
      { venue: "Market Theatre", address: "56 Margaret Mcingana St, Newtown, Johannesburg, South Africa", lng: 28.0112, lat: -26.2016 },
      { venue: "Walter Sisulu Square", address: "Klipspruit Valley Rd, Kliptown, Soweto, South Africa", lng: 27.8538, lat: -26.2645 }
    ],
    "Cape Town, SA": [
      { venue: "Cape Town International Convention Centre", address: "Convention Square, 1 Lower Long St, Cape Town, 8001, South Africa", lng: 18.4236, lat: -33.9180 },
      { venue: "Artscape Theatre Centre", address: "D F Malan St, Foreshore, Cape Town, 8001, South Africa", lng: 18.4260, lat: -33.9188 },
      { venue: "GrandWest Grand Arena", address: "1 Jakes Gerwel Dr, Goodwood, Cape Town, 7460, South Africa", lng: 18.5482, lat: -33.9130 },
      { venue: "Kirstenbosch National Botanical Garden", address: "Rhodes Dr, Newlands, Cape Town, 7735, South Africa", lng: 18.4326, lat: -33.9886 },
      { venue: "Cape Town Stadium", address: "Fritz Sonnenberg Rd, Green Point, Cape Town, 8051, South Africa", lng: 18.4110, lat: -33.9036 },
      { venue: "Baxter Theatre Centre", address: "Main Rd, Rondebosch, Cape Town, 7701, South Africa", lng: 18.4671, lat: -33.9583 }
    ],
    "Dubai, UAE": [
      { venue: "Dubai Opera", address: "Sheikh Mohammed bin Rashid Blvd, Dubai, United Arab Emirates", lng: 55.2744, lat: 25.1972 },
      { venue: "Coca-Cola Arena", address: "City Walk, Dubai, United Arab Emirates", lng: 55.2645, lat: 25.2047 },
      { venue: "Dubai World Trade Centre", address: "Sheikh Zayed Rd, Dubai, United Arab Emirates", lng: 55.2881, lat: 25.2233 },
      { venue: "Madinat Theatre", address: "Jumeirah Rd, Dubai, United Arab Emirates", lng: 55.1852, lat: 25.1337 },
      { venue: "Expo City Dubai", address: "Expo Rd, Dubai, United Arab Emirates", lng: 55.3500, lat: 24.9575 },
      { venue: "Jumeirah Beach Hotel Events Arena", address: "Jumeirah Beach Rd, Dubai, United Arab Emirates", lng: 55.1886, lat: 25.1404 }
    ],
    "Mumbai, India": [
      { venue: "NCPA Mumbai", address: "NCPA Marg, Nariman Point, Mumbai, Maharashtra 400021, India", lng: 72.8327, lat: 18.9243 },
      { venue: "Jio World Convention Centre", address: "G Block, Bandra Kurla Complex, Mumbai, Maharashtra 400051, India", lng: 72.8428, lat: 19.0606 },
      { venue: "Shanmukhananda Hall", address: "292, Comrade Harbanslal Marg, Sion East, Mumbai, Maharashtra 400022, India", lng: 72.8602, lat: 19.0446 },
      { venue: "NSCI Dome", address: "Lala Lajpatrai Marg, Worli, Mumbai, Maharashtra 400018, India", lng: 72.8274, lat: 19.0170 },
      { venue: "St. Andrew's Auditorium", address: "St. Dominic Rd, Bandra West, Mumbai, Maharashtra 400050, India", lng: 72.8317, lat: 19.0665 },
      { venue: "Royal Opera House Mumbai", address: "Maulana Shaukat Ali Rd, Mumbai, Maharashtra 400007, India", lng: 72.8274, lat: 18.9557 }
    ],
    "Delhi, India": [
      { venue: "Pragati Maidan", address: "Mathura Rd, New Delhi, Delhi 110001, India", lng: 77.2437, lat: 28.6189 },
      { venue: "India Habitat Centre", address: "Lodhi Rd, Lodhi Gardens, New Delhi, Delhi 110003, India", lng: 77.2227, lat: 28.5889 },
      { venue: "Siri Fort Auditorium", address: "August Kranti Marg, Siri Fort, New Delhi, Delhi 110049, India", lng: 77.2246, lat: 28.5495 },
      { venue: "Jawaharlal Nehru Stadium", address: "Bhishma Pitamah Marg, Pragati Vihar, New Delhi, Delhi 110003, India", lng: 77.2430, lat: 28.5823 },
      { venue: "Talkatora Stadium", address: "Talkatora Garden, President's Estate, New Delhi, Delhi 110004, India", lng: 77.1984, lat: 28.6262 },
      { venue: "Kingdom of Dreams", address: "Auditorium Complex, Sector 29, Gurugram, Haryana 122001, India", lng: 77.0725, lat: 28.4707 }
    ],
    "Bangkok, Thailand": [
      { venue: "Queen Sirikit National Convention Center", address: "60 Ratchadaphisek Rd, Khlong Toei, Bangkok 10110, Thailand", lng: 100.5604, lat: 13.7247 },
      { venue: "Impact Arena", address: "Popular Rd, Ban Mai, Nonthaburi 11120, Thailand", lng: 100.5483, lat: 13.9210 },
      { venue: "GMM Live House", address: "8th Floor, CentralWorld, Bangkok 10330, Thailand", lng: 100.5397, lat: 13.7464 },
      { venue: "Royal Paragon Hall", address: "991 Rama I Rd, Pathum Wan, Bangkok 10330, Thailand", lng: 100.5346, lat: 13.7465 },
      { venue: "True Icon Hall", address: "299 Charoen Nakhon Rd, Khlong San, Bangkok 10600, Thailand", lng: 100.5117, lat: 13.7213 },
      { venue: "Moonstar Studio", address: "701 Ladprao Rd, Khwaeng Wang Thonglang, Bangkok 10310, Thailand", lng: 100.6080, lat: 13.7765 }
    ],
    "Singapore": [
      { venue: "Marina Bay Sands Expo & Convention Centre", address: "10 Bayfront Ave, Singapore 018956", lng: 103.8607, lat: 1.2831 },
      { venue: "Esplanade – Theatres on the Bay", address: "1 Esplanade Dr, Singapore 038981", lng: 103.8554, lat: 1.2893 },
      { venue: "Singapore Indoor Stadium", address: "2 Stadium Walk, Singapore 397691", lng: 103.8716, lat: 1.3026 },
      { venue: "Resorts World Convention Centre", address: "8 Sentosa Gateway, Singapore 098269", lng: 103.8211, lat: 1.2556 },
      { venue: "Suntec Singapore Convention & Exhibition Centre", address: "1 Raffles Blvd, Singapore 039593", lng: 103.8571, lat: 1.2931 },
      { venue: "Capitol Theatre", address: "17 Stamford Rd, Singapore 178907", lng: 103.8512, lat: 1.2940 }
    ],
    "Hong Kong, China": [
      { venue: "Hong Kong Convention and Exhibition Centre", address: "1 Expo Dr, Wan Chai, Hong Kong", lng: 114.1734, lat: 22.2837 },
      { venue: "AsiaWorld-Expo", address: "AsiaWorld-Expo, Chek Lap Kok, Hong Kong", lng: 113.9411, lat: 22.3157 },
      { venue: "Hong Kong Coliseum", address: "9 Cheong Wan Rd, Hung Hom, Hong Kong", lng: 114.1882, lat: 22.3023 },
      { venue: "Xiqu Centre", address: "88 Austin Rd W, Tsim Sha Tsui, Hong Kong", lng: 114.1610, lat: 22.3032 },
      { venue: "Queen Elizabeth Stadium", address: "18 Oi Kwan Rd, Wan Chai, Hong Kong", lng: 114.1885, lat: 22.2802 },
      { venue: "KITEC Star Hall", address: "1 Trademart Dr, Kowloon Bay, Hong Kong", lng: 114.2039, lat: 22.3224 }
    ],
    "Tokyo, Japan": [
      { venue: "Tokyo International Forum", address: "3 Chome-5-1 Marunouchi, Chiyoda City, Tokyo 100-0005, Japan", lng: 139.7670, lat: 35.6767 },
      { venue: "Nippon Budokan", address: "2 Chome-3-1 Kudankita, Chiyoda City, Tokyo 102-8321, Japan", lng: 139.7506, lat: 35.6938 },
      { venue: "Tokyo Dome", address: "1 Chome-3-61 Koraku, Bunkyo City, Tokyo 112-8575, Japan", lng: 139.7516, lat: 35.7056 },
      { venue: "Shibuya Stream Hall", address: "3 Chome-21-3 Shibuya, Shibuya City, Tokyo 150-0002, Japan", lng: 139.7024, lat: 35.6587 },
      { venue: "NHK Hall", address: "2 Chome-2-1 Jinnan, Shibuya City, Tokyo 150-8001, Japan", lng: 139.6991, lat: 35.6697 },
      { venue: "Sumida Triphony Hall", address: "1 Chome-2-3 Kinshi, Sumida City, Tokyo 130-0013, Japan", lng: 139.8132, lat: 35.7107 }
    ],
    "Seoul, South Korea": [
      { venue: "Jamsil Arena", address: "20 Olympic-ro, Songpa-gu, Seoul, South Korea", lng: 127.0714, lat: 37.5112 },
      { venue: "Olympic Hall", address: "424 Olympic-ro, Songpa-gu, Seoul, South Korea", lng: 127.1260, lat: 37.5242 },
      { venue: "Seoul World Cup Stadium", address: "240 World Cup-ro, Mapo-gu, Seoul, South Korea", lng: 126.8960, lat: 37.5683 },
      { venue: "COEX Convention Center", address: "513 Yeongdong-daero, Gangnam-gu, Seoul, South Korea", lng: 127.0592, lat: 37.5111 },
      { venue: "Blue Square", address: "294 Itaewon-ro, Yongsan-gu, Seoul, South Korea", lng: 127.0033, lat: 37.5409 },
      { venue: "Lotte Concert Hall", address: "300 Olympic-ro, Songpa-gu, Seoul, South Korea", lng: 127.1027, lat: 37.5131 }
    ],
    "Sydney, Australia": [
      { venue: "Sydney Opera House", address: "Bennelong Point, Sydney NSW 2000, Australia", lng: 151.2153, lat: -33.8568 },
      { venue: "International Convention Centre Sydney", address: "14 Darling Dr, Sydney NSW 2000, Australia", lng: 151.2019, lat: -33.8747 },
      { venue: "Sydney Showground", address: "1 Showground Rd, Sydney Olympic Park NSW 2127, Australia", lng: 151.0653, lat: -33.8470 },
      { venue: "Qudos Bank Arena", address: "19 Edwin Flack Ave, Sydney Olympic Park NSW 2127, Australia", lng: 151.0670, lat: -33.8479 },
      { venue: "Hordern Pavilion", address: "1 Driver Ave, Moore Park NSW 2021, Australia", lng: 151.2236, lat: -33.8913 },
      { venue: "Enmore Theatre", address: "118-132 Enmore Rd, Newtown NSW 2042, Australia", lng: 151.1742, lat: -33.8973 }
    ],
    "Brisbane, Australia": [
      { venue: "Brisbane Convention & Exhibition Centre", address: "Glenelg St, South Brisbane QLD 4101, Australia", lng: 153.0183, lat: -27.4785 },
      { venue: "Riverstage", address: "59 Gardens Point Rd, Brisbane City QLD 4000, Australia", lng: 153.0291, lat: -27.4743 },
      { venue: "Suncorp Stadium", address: "40 Castlemaine St, Milton QLD 4064, Australia", lng: 153.0090, lat: -27.4646 },
      { venue: "The Fortitude Music Hall", address: "312 Brunswick St, Fortitude Valley QLD 4006, Australia", lng: 153.0273, lat: -27.4587 },
      { venue: "QPAC", address: "Cnr Grey and, Melbourne St, South Brisbane QLD 4101, Australia", lng: 153.0196, lat: -27.4812 },
      { venue: "The Tivoli", address: "52 Costin St, Fortitude Valley QLD 4006, Australia", lng: 153.0318, lat: -27.4554 }
    ],
    "Auckland, New Zealand": [
      { venue: "Spark Arena", address: "42 Mahuhu Crescent, Auckland 1010, New Zealand", lng: 174.7737, lat: -36.8444 },
      { venue: "Aotea Centre", address: "50 Mayoral Drive, Auckland 1010, New Zealand", lng: 174.7633, lat: -36.8513 },
      { venue: "The Civic", address: "Cnr Queen Street &, Wellesley St W, Auckland 1010, New Zealand", lng: 174.7639, lat: -36.8494 },
      { venue: "ASB Showgrounds", address: "217 Green Lane W, Epsom, Auckland 1051, New Zealand", lng: 174.7781, lat: -36.8927 },
      { venue: "Eden Park", address: "Reimers Ave, Kingsland, Auckland 1024, New Zealand", lng: 174.7361, lat: -36.8770 },
      { venue: "Bruce Mason Centre", address: "Takapuna, Auckland 0622, New Zealand", lng: 174.7666, lat: -36.8286 }
    ],
    "Toronto, Canada": [
      { venue: "Scotiabank Arena", address: "40 Bay St., Toronto, ON M5J 2X2, Canada", lng: -79.3791, lat: 43.6435 },
      { venue: "Roy Thomson Hall", address: "60 Simcoe St, Toronto, ON M5J 2H5, Canada", lng: -79.3853, lat: 43.6467 },
      { venue: "Toronto Congress Centre", address: "650 Dixon Rd, Etobicoke, ON M9W 1J1, Canada", lng: -79.6068, lat: 43.7012 },
      { venue: "Meridian Hall", address: "1 Front St E, Toronto, ON M5E 1B2, Canada", lng: -79.3764, lat: 43.6466 },
      { venue: "Enercare Centre", address: "100 Princes' Blvd, Toronto, ON M6K 3C3, Canada", lng: -79.4169, lat: 43.6327 },
      { venue: "Danforth Music Hall", address: "147 Danforth Ave, Toronto, ON M4K 1N2, Canada", lng: -79.3528, lat: 43.6785 }
    ],
    "Vancouver, Canada": [
      { venue: "Rogers Arena", address: "800 Griffiths Way, Vancouver, BC V6B 6G1, Canada", lng: -123.1080, lat: 49.2777 },
      { venue: "Pacific Coliseum", address: "100 N Renfrew St, Vancouver, BC V5K 3N7, Canada", lng: -123.0327, lat: 49.2812 },
      { venue: "Queen Elizabeth Theatre", address: "630 Hamilton St, Vancouver, BC V6B 5N6, Canada", lng: -123.1099, lat: 49.2804 },
      { venue: "Vancouver Convention Centre", address: "1055 Canada Pl, Vancouver, BC V6C 0C3, Canada", lng: -123.1134, lat: 49.2897 },
      { venue: "PNE Forum", address: "2901 E Hastings St, Vancouver, BC V5K 5J1, Canada", lng: -123.0495, lat: 49.2815 },
      { venue: "Commodore Ballroom", address: "868 Granville St, Vancouver, BC V6Z 1K3, Canada", lng: -123.1233, lat: 49.2811 }
    ],
    "Mexico City, Mexico": [
      { venue: "Auditorio Nacional", address: "Av. Paseo de la Reforma 50, Miguel Hidalgo, 11580 Ciudad de México, CDMX, Mexico", lng: -99.2114, lat: 19.4260 },
      { venue: "Palacio de los Deportes", address: "Av. Río Churubusco s/n, Granjas México, 08400 Ciudad de México, CDMX, Mexico", lng: -99.0990, lat: 19.4020 },
      { venue: "Arena Ciudad de México", address: "Av. de las Granjas 800, Santa Bárbara, 02230 Ciudad de México, CDMX, Mexico", lng: -99.1583, lat: 19.4893 },
      { venue: "Centro Cultural Teatro 1", address: "Av. Cuauhtémoc 19, Colonia Roma, 06700 Ciudad de México, CDMX, Mexico", lng: -99.1578, lat: 19.4315 },
      { venue: "Teatro Metropólitan", address: "Av. Independencia 90, Centro, 06050 Ciudad de México, CDMX, Mexico", lng: -99.1460, lat: 19.4336 },
      { venue: "Auditorio BlackBerry", address: "Av. de los Insurgentes Sur 453, Hipódromo, 06100 Ciudad de México, CDMX, Mexico", lng: -99.1673, lat: 19.4055 }
    ],
    "São Paulo, Brazil": [
      { venue: "Allianz Parque", address: "Av. Francisco Matarazzo, 1705, São Paulo - SP, 05001-200, Brazil", lng: -46.6795, lat: -23.5275 },
      { venue: "Auditório Ibirapuera", address: "Av. Pedro Álvares Cabral, s/n, São Paulo - SP, 04094-050, Brazil", lng: -46.6578, lat: -23.5870 },
      { venue: "Espaço das Américas", address: "Rua Tagipuru, 795, São Paulo - SP, 01156-000, Brazil", lng: -46.6677, lat: -23.5219 },
      { venue: "Vibra São Paulo", address: "Av. das Nações Unidas, 17955, São Paulo - SP, 04795-100, Brazil", lng: -46.7303, lat: -23.6051 },
      { venue: "Memorial da América Latina", address: "Av. Auro Soares de Moura Andrade, 664, São Paulo - SP, 01156-001, Brazil", lng: -46.6644, lat: -23.5250 },
      { venue: "Ginásio do Ibirapuera", address: "Rua Manoel da Nóbrega, 1361, São Paulo - SP, 04001-084, Brazil", lng: -46.6543, lat: -23.5721 }
    ],
    "Rio de Janeiro, Brazil": [
      { venue: "Jeunesse Arena", address: "Av. Embaixador Abelardo Bueno, 3401, Rio de Janeiro - RJ, 22775-040, Brazil", lng: -43.3650, lat: -22.9775 },
      { venue: "Maracanã Stadium", address: "Av. Pres. Castelo Branco, Portão 3, Rio de Janeiro - RJ, 20271-130, Brazil", lng: -43.2302, lat: -22.9122 },
      { venue: "Vivo Rio", address: "Av. Infante Dom Henrique, 85, Rio de Janeiro - RJ, 20021-140, Brazil", lng: -43.1702, lat: -22.9128 },
      { venue: "Cidade das Artes", address: "Av. das Américas, 5300, Rio de Janeiro - RJ, 22793-080, Brazil", lng: -43.3713, lat: -22.9970 },
      { venue: "Theatro Municipal do Rio de Janeiro", address: "Praça Floriano, S/N, Rio de Janeiro - RJ, 20031-050, Brazil", lng: -43.1767, lat: -22.9084 },
      { venue: "Fundição Progresso", address: "Rua dos Arcos, 24, Rio de Janeiro - RJ, 20230-060, Brazil", lng: -43.1820, lat: -22.9127 }
    ],
    "Buenos Aires, Argentina": [
      { venue: "Teatro Colón", address: "Cerrito 628, C1010 CABA, Argentina", lng: -58.3830, lat: -34.6033 },
      { venue: "Luna Park", address: "Av. Eduardo Madero 470, C1106 CABA, Argentina", lng: -58.3703, lat: -34.6032 },
      { venue: "Usina del Arte", address: "Caffarena 1, C1157 CABA, Argentina", lng: -58.3610, lat: -34.6327 },
      { venue: "Centro Cultural Kirchner", address: "Sarmiento 151, C1041 CABA, Argentina", lng: -58.3700, lat: -34.6020 },
      { venue: "Movistar Arena", address: "Humboldt 450, C1414 CABA, Argentina", lng: -58.4446, lat: -34.5874 },
      { venue: "La Rural", address: "Av. Sarmiento 2704, C1425 CABA, Argentina", lng: -58.4166, lat: -34.5750 }
    ],
    "Santiago, Chile": [
      { venue: "Movistar Arena", address: "Av. Beaucheff 1204, Santiago, Región Metropolitana, Chile", lng: -70.6189, lat: -33.4562 },
      { venue: "Teatro Caupolicán", address: "San Diego 850, Santiago, Región Metropolitana, Chile", lng: -70.6424, lat: -33.4460 },
      { venue: "Centro Cultural Gabriela Mistral", address: "Av. Libertador Bernardo O'Higgins 227, Santiago, Región Metropolitana, Chile", lng: -70.6455, lat: -33.4381 },
      { venue: "Estadio Nacional Julio Martínez Prádanos", address: "Av. Grecia 2001, Ñuñoa, Región Metropolitana, Chile", lng: -70.6106, lat: -33.4648 },
      { venue: "Teatro Municipal de Santiago", address: "Agustinas 794, Santiago, Región Metropolitana, Chile", lng: -70.6484, lat: -33.4389 },
      { venue: "Espacio Riesco", address: "Av. El Salto 5000, Huechuraba, Región Metropolitana, Chile", lng: -70.6015, lat: -33.3830 }
    ]
  };

  const REAL_VENUE_ID_PRECISION = 6;
  const MIN_MULTI_VENUE_DISTANCE_KM = 100;
  const MAX_MULTI_VENUE_DISTANCE_KM = 4000;

  const ALL_REAL_VENUES = Object.values(REAL_VENUES).reduce((acc, arr) => {
    if(Array.isArray(arr)){
      arr.forEach(entry => {
        if(entry && Number.isFinite(entry.lng) && Number.isFinite(entry.lat)){
          acc.push(entry);
        }
      });
    }
    return acc;
  }, []);

  function realVenueIdentity(entry){
    if(!entry) return '';
    const lng = Number(entry.lng);
    const lat = Number(entry.lat);
    const venue = (entry.venue || '').toLowerCase();
    const address = (entry.address || '').toLowerCase();
    if(!Number.isFinite(lng) || !Number.isFinite(lat)){
      return `${venue}|${address}|invalid`;
    }
    return `${venue}|${address}|${lng.toFixed(REAL_VENUE_ID_PRECISION)}|${lat.toFixed(REAL_VENUE_ID_PRECISION)}`;
  }

  const REAL_VENUE_IDENTIFIERS = new Set(ALL_REAL_VENUES.map(realVenueIdentity));

  function isRealVenueEntry(entry){
    return REAL_VENUE_IDENTIFIERS.has(realVenueIdentity(entry));
  }

  function haversineDistanceKm(lng1, lat1, lng2, lat2){
    if(![lng1, lat1, lng2, lat2].every(Number.isFinite)){
      return NaN;
    }
    const toRad = deg => deg * Math.PI / 180;
    const lat1Rad = toRad(lat1);
    const lat2Rad = toRad(lat2);
    const dLat = toRad(lat2 - lat1);
    const dLng = toRad(lng2 - lng1);
    const sinLat = Math.sin(dLat / 2);
    const sinLng = Math.sin(dLng / 2);
    const a = sinLat * sinLat + Math.cos(lat1Rad) * Math.cos(lat2Rad) * sinLng * sinLng;
    const clamped = Math.min(1, Math.max(0, a));
    const c = 2 * Math.atan2(Math.sqrt(clamped), Math.sqrt(1 - clamped));
    const EARTH_RADIUS_KM = 6371;
    return EARTH_RADIUS_KM * c;
  }

  function shuffleRealVenues(list){
    const arr = list.slice();
    for(let i = arr.length - 1; i > 0; i--){
      const j = Math.floor(rnd() * (i + 1));
      const tmp = arr[i];
      arr[i] = arr[j];
      arr[j] = tmp;
    }
    return arr;
  }

  const CITY_BOUNDS = {
    "Federation Square, Melbourne": { lng:[144.9660, 144.9730], lat:[-37.8200, -37.8100] },
    "Hobart, Tasmania": { lng:[147.2900, 147.3600], lat:[-42.9100, -42.8600] },
    "New York, USA": { lng:[-74.1000, -73.8500], lat:[40.6000, 40.8500] },
    "Los Angeles, USA": { lng:[-118.5500, -118.1500], lat:[33.8500, 34.1500] },
    "London, UK": { lng:[-0.2500, 0.1000], lat:[51.4500, 51.6000] },
    "Paris, France": { lng:[2.2500, 2.4200], lat:[48.8200, 48.9000] },
    "Berlin, Germany": { lng:[13.2000, 13.5000], lat:[52.4500, 52.5700] },
    "Madrid, Spain": { lng:[-3.7500, -3.6000], lat:[40.3700, 40.4800] },
    "Rome, Italy": { lng:[12.4400, 12.5600], lat:[41.8500, 41.9500] },
    "Amsterdam, NL": { lng:[4.8000, 5.0200], lat:[52.3300, 52.4000] },
    "Dublin, Ireland": { lng:[-6.3500, -6.2000], lat:[53.3000, 53.3600] },
    "Stockholm, Sweden": { lng:[18.0000, 18.1400], lat:[59.3000, 59.3600] },
    "Copenhagen, Denmark": { lng:[12.4500, 12.6500], lat:[55.6300, 55.7100] },
    "Helsinki, Finland": { lng:[24.8800, 25.0200], lat:[60.1500, 60.2000] },
    "Oslo, Norway": { lng:[10.6500, 10.8500], lat:[59.9000, 59.9700] },
    "Reykjavík, Iceland": { lng:[-21.9900, -21.7500], lat:[64.1000, 64.1600] },
    "Moscow, Russia": { lng:[37.5500, 37.7500], lat:[55.7000, 55.8200] },
    "Istanbul, Türkiye": { lng:[28.9000, 29.1500], lat:[40.9500, 41.1000] },
    "Athens, Greece": { lng:[23.7000, 23.7800], lat:[37.9400, 38.0200] },
    "Cairo, Egypt": { lng:[31.1900, 31.2700], lat:[30.0000, 30.0800] },
    "Nairobi, Kenya": { lng:[36.7800, 36.8600], lat:[-1.3200, -1.2600] },
    "Lagos, Nigeria": { lng:[3.3300, 3.4500], lat:[6.4300, 6.5500] },
    "Johannesburg, SA": { lng:[27.9800, 28.1000], lat:[-26.2500, -26.1700] },
    "Cape Town, SA": { lng:[18.3800, 18.5000], lat:[-33.9800, -33.8500] },
    "Dubai, UAE": { lng:[55.2400, 55.3400], lat:[25.1800, 25.2500] },
    "Mumbai, India": { lng:[72.8200, 72.9000], lat:[18.9200, 19.0900] },
    "Delhi, India": { lng:[77.0500, 77.2000], lat:[28.5800, 28.7200] },
    "Bangkok, Thailand": { lng:[100.4500, 100.5500], lat:[13.7000, 13.8200] },
    "Singapore": { lng:[103.8000, 103.8700], lat:[1.2700, 1.3600] },
    "Hong Kong, China": { lng:[114.1300, 114.2100], lat:[22.2800, 22.3700] },
    "Tokyo, Japan": { lng:[139.6800, 139.7800], lat:[35.6300, 35.7300] },
    "Seoul, South Korea": { lng:[126.9500, 127.0500], lat:[37.5300, 37.6000] },
    "Sydney, Australia": { lng:[151.1800, 151.2400], lat:[-33.9300, -33.8400] },
    "Brisbane, Australia": { lng:[152.9900, 153.0600], lat:[-27.5200, -27.4400] },
    "Auckland, New Zealand": { lng:[174.7400, 174.7800], lat:[-36.8700, -36.8300] },
    "Toronto, Canada": { lng:[-79.4200, -79.3500], lat:[43.6400, 43.7000] },
    "Vancouver, Canada": { lng:[-123.1500, -123.0800], lat:[49.2600, 49.2900] },
    "Mexico City, Mexico": { lng:[-99.1700, -99.0900], lat:[19.3800, 19.4500] },
    "São Paulo, Brazil": { lng:[-46.6800, -46.6100], lat:[-23.5900, -23.5200] },
    "Rio de Janeiro, Brazil": { lng:[-43.2500, -43.1500], lat:[-22.9800, -22.9000] },
    "Buenos Aires, Argentina": { lng:[-58.4500, -58.3600], lat:[-34.6400, -34.5600] },
    "Santiago, Chile": { lng:[-70.7100, -70.6000], lat:[-33.4900, -33.4000] }
  };

  function safeCoordinate(city, baseLng=0, baseLat=0, radius=0.1){
    const bounds = CITY_BOUNDS[city];
    const range = Math.max(radius || 0, 0);
    if(range <= 0){
      if(bounds){
        return {
          lng: clamp(baseLng, bounds.lng[0], bounds.lng[1]),
          lat: clamp(baseLat, bounds.lat[0], bounds.lat[1])
        };
      }
      return { lng: baseLng, lat: baseLat };
    }
    const attempts = 24;
    for(let i=0;i<attempts;i++){
      const lng = baseLng + (rnd()-0.5) * 2 * range;
      const lat = baseLat + (rnd()-0.5) * 2 * range;
      if(!bounds || (lng >= bounds.lng[0] && lng <= bounds.lng[1] && lat >= bounds.lat[0] && lat <= bounds.lat[1])){
        return { lng, lat };
      }
    }
    if(bounds){
      return {
        lng: clamp(baseLng, bounds.lng[0], bounds.lng[1]),
        lat: clamp(baseLat, bounds.lat[0], bounds.lat[1])
      };
    }
    return { lng: baseLng, lat: baseLat };
  }

  function randomSchedule(){
    const count = 1 + Math.floor(rnd()*20);
    const now = new Date();
    return Array.from({length:count}, ()=>{
      const d = new Date(+now + Math.floor(rnd()*365)*86400000);
      const date = d.toLocaleDateString('en-GB',{weekday:'short', day:'numeric', month:'short'}).replace(/,/g,'');
      const time = `${String(Math.floor(rnd()*24)).padStart(2,'0')}:${String(Math.floor(rnd()*4)*15).padStart(2,'0')}`;
      const full = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      return {date, time, full};
    });
  }

  function getVenuePool(city){
    if(!city) return [];
    const direct = REAL_VENUES[city];
    if(Array.isArray(direct) && direct.length) return direct;
    const normalized = city.split(',')[0].trim();
    const alias = REAL_VENUES[normalized];
    return Array.isArray(alias) ? alias : [];
  }

  function pickRealVenue(city, baseLng=0, baseLat=0, options={}){
    const pool = getVenuePool(city);
    if(options && options.prefer){
      const preferred = pool.find(v => v.venue === options.prefer);
      if(preferred) return preferred;
    }
    if(pool.length){
      return pool[Math.floor(rnd()*pool.length)];
    }
    return {
      venue: options?.fallbackName || city,
      address: options?.fallbackAddress || city,
      lng: baseLng,
      lat: baseLat
    };
  }

  function toLocationDetails(entry){
    return {
      venue: entry.venue,
      address: entry.address,
      lng: entry.lng,
      lat: entry.lat,
      dates: randomSchedule(),
      price: randomPriceRange()
    };
  }

  function buildLocationList(city, baseLng=0, baseLat=0, primaryEntry){
    const count = 1 + Math.floor(rnd()*5);
    const locations = [];
    const selectedLocations = [];
    const usedKeys = new Set();
    const baseEntry = primaryEntry || pickRealVenue(city, baseLng, baseLat, { fallbackName: city, fallbackAddress: city });
    if(baseEntry){
      const detail = toLocationDetails(baseEntry);
      locations.push(detail);
      if(Number.isFinite(detail.lng) && Number.isFinite(detail.lat)){
        selectedLocations.push(detail);
      }
      usedKeys.add(realVenueIdentity(baseEntry));
    }
    if(locations.length >= count){
      return locations;
    }
    if(!isRealVenueEntry(baseEntry)){
      return locations;
    }
    const desiredCount = Math.min(Math.max(count, 1), 6);
    if(desiredCount <= 1){
      return locations;
    }
    const candidates = shuffleRealVenues(ALL_REAL_VENUES);
    for(const entry of candidates){
      if(locations.length >= desiredCount){
        break;
      }
      const key = realVenueIdentity(entry);
      if(!key || usedKeys.has(key)){
        continue;
      }
      if(!isRealVenueEntry(entry)){
        continue;
      }
      const detail = toLocationDetails(entry);
      if(!Number.isFinite(detail.lng) || !Number.isFinite(detail.lat)){
        continue;
      }
      const withinRange = selectedLocations.every(existing => {
        const dist = haversineDistanceKm(existing.lng, existing.lat, detail.lng, detail.lat);
        return Number.isFinite(dist) && dist >= MIN_MULTI_VENUE_DISTANCE_KM && dist <= MAX_MULTI_VENUE_DISTANCE_KM;
      });
      if(!withinRange){
        continue;
      }
      locations.push(detail);
      selectedLocations.push(detail);
      usedKeys.add(key);
    }
    return locations;
  }

  function randomImages(id){
    const hero = imgHero(id);
    const others = Array.from({length:9},(_,i)=>{
      const port = i % 2 === 0;
      return `https://picsum.photos/seed/${encodeURIComponent(id)}-${i}/${port?'800/1200':'1200/800'}`;
    });
    return [hero, ...others];
  }

  function randomText(min=50,max=200){
    const lorem = "lorem ipsum dolor sit amet consectetur adipiscing elit sed do eiusmod tempor incididunt ut labore et dolore magna aliqua".split(' ');
    const count = min + Math.floor(rnd()*(max-min+1));
    const words = [];
    for(let i=0;i<count;i++){ words.push(lorem[i%lorem.length]); }
    words[0] = words[0][0].toUpperCase() + words[0].slice(1);
    return words.join(' ') + '.';
  }

  function randomPriceRange(){
    const low = 10 + Math.floor(rnd()*90);
    const high = low + 10 + Math.floor(rnd()*90);
    return `$${low} - $${high}`;
  }

  function randomUsername(seed){
    const names = ['Aria','Blake','Casey','Drew','Evan','Finn','Gray','Harper','Indie','Jules'];
    let h = 0; for(let i=0;i<seed.length;i++){ h = (h<<5)-h+seed.charCodeAt(i); }
    const name = names[Math.abs(h)%names.length];
    const num = Math.abs(Math.floor(h/7))%1000;
    return name + num;
  }

  function randomAvatar(seed){
    return `https://picsum.photos/seed/${encodeURIComponent(seed)}-a/100/100`;
  }

  function slugify(str){
    return str.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'');
  }
  window.slugify = slugify;

  function postUrl(p){
    return `${BASE_URL}#/post/${p.slug}-${p.created}`;
  }

  function showCopyMsg(btn){
    const header = btn && btn.closest('.post-header');
    if(!header) return;
    const msg = document.createElement('div');
    msg.className='copy-msg';
    msg.textContent='Link Copied';
    header.appendChild(msg);
    const btnRect = btn.getBoundingClientRect();
    const headerRect = header.getBoundingClientRect();
    const msgRect = msg.getBoundingClientRect();
    msg.style.top = (btnRect.top - headerRect.top + (btnRect.height - msgRect.height)/2) + 'px';
    msg.style.left = (btnRect.left - headerRect.left - msgRect.width - 10) + 'px';
    requestAnimationFrame(()=>msg.classList.add('show'));
    setTimeout(()=>msg.remove(),1500);
  }

function makePosts(){
  const out = [];
  // ---- 100 posts at Federation Square (as before) ----
  const fsLng = 144.9695, fsLat = -37.8178;
  const fsCity = "Federation Square, Melbourne";
  for(let i=0;i<100;i++){
    const cat = pick(categories);
    const sub = pick(cat.subs);
    const id = 'FS'+i;
    const title = `${id} ${uniqueTitle(i*7777+13, fsCity, i)}`;
    const created = new Date().toISOString().replace(/[:.]/g,'-');
    const primaryVenue = pickRealVenue(fsCity, fsLng, fsLat, {
      prefer: 'Federation Square',
      fallbackName: 'Federation Square',
      fallbackAddress: 'Swanston St & Flinders St, Melbourne VIC 3000, Australia'
    });
    const fsCoord = {
      lng: Number.isFinite(primaryVenue.lng) ? primaryVenue.lng : fsLng,
      lat: Number.isFinite(primaryVenue.lat) ? primaryVenue.lat : fsLat
    };
    out.push({
      id,
      title,
      slug: slugify(title),
      created,
      city: fsCity,
      lng: fsCoord.lng, lat: fsCoord.lat,
      category: cat.name,
      subcategory: sub,
      dates: randomDates(),
      sponsored: true, // All posts are sponsored for development
      fav:false,
      desc: randomText(),
      images: randomImages(id),
      locations: buildLocationList(fsCity, fsCoord.lng, fsCoord.lat, primaryVenue),
      member: { username: randomUsername(id), avatar: randomAvatar(id) },
    });
  }

  // ---- 100 posts in Tasmania ----
  const tasLng = 147.3272, tasLat = -42.8821;
  const tasCity = "Hobart, Tasmania";
  const todayTas = new Date(); todayTas.setHours(0,0,0,0);
  for(let i=0;i<100;i++){
    const cat = pick(categories);
    const sub = pick(cat.subs);
    const id = 'TAS'+i;
    const title = `${id} ${uniqueTitle(i*5311+23, tasCity, i)}`;
    const created = new Date().toISOString().replace(/[:.]/g,'-');
    const offset = 1 + i%30;
    const date = new Date(todayTas);
    date.setDate(date.getDate() + (i<50 ? -offset : offset));
    const tasBase = safeCoordinate(tasCity, tasLng, tasLat, 0.1);
    const tasPrimary = pickRealVenue(tasCity, tasBase.lng, tasBase.lat);
    const tasCoord = {
      lng: Number.isFinite(tasPrimary.lng) ? tasPrimary.lng : tasBase.lng,
      lat: Number.isFinite(tasPrimary.lat) ? tasPrimary.lat : tasBase.lat
    };
    out.push({
      id,
      title,
      slug: slugify(title),
      created,
      city: tasCity,
      lng: tasCoord.lng,
      lat: tasCoord.lat,
      category: cat.name,
      subcategory: sub,
      dates: [toISODate(date)],
      sponsored: true, // All posts are sponsored for development
      fav:false,
      desc: randomText(),
      images: randomImages(id),
      locations: buildLocationList(tasCity, tasCoord.lng, tasCoord.lat, tasPrimary),
      member: { username: randomUsername(id), avatar: randomAvatar(id) },
    });
  }

  // ---- Restore world-wide posts ----
  // A light list of hub cities for better realism
  const hubs = [
    {c:"New York, USA",      lng:-73.9857, lat:40.7484},
    {c:"Los Angeles, USA",   lng:-118.2437, lat:34.0522},
    {c:"London, UK",         lng:-0.1276, lat:51.5074},
    {c:"Paris, France",      lng:2.3522, lat:48.8566},
    {c:"Berlin, Germany",    lng:13.4050, lat:52.5200},
    {c:"Madrid, Spain",      lng:-3.7038, lat:40.4168},
    {c:"Rome, Italy",        lng:12.4964, lat:41.9028},
    {c:"Amsterdam, NL",      lng:4.9041, lat:52.3676},
    {c:"Dublin, Ireland",    lng:-6.2603, lat:53.3498},
    {c:"Stockholm, Sweden",  lng:18.0686, lat:59.3293},
    {c:"Copenhagen, Denmark",lng:12.5683, lat:55.6761},
    {c:"Helsinki, Finland",  lng:24.9384, lat:60.1699},
    {c:"Oslo, Norway",       lng:10.7522, lat:59.9139},
    {c:"Reykjavík, Iceland", lng:-21.8277, lat:64.1265},
    {c:"Moscow, Russia",     lng:37.6173, lat:55.7558},
    {c:"Istanbul, Türkiye",  lng:28.9784, lat:41.0082},
    {c:"Athens, Greece",     lng:23.7275, lat:37.9838},
    {c:"Cairo, Egypt",       lng:31.2357, lat:30.0444},
    {c:"Nairobi, Kenya",     lng:36.8219, lat:-1.2921},
    {c:"Lagos, Nigeria",     lng:3.3792, lat:6.5244},
    {c:"Johannesburg, SA",   lng:28.0473, lat:-26.2041},
    {c:"Cape Town, SA",      lng:18.4241, lat:-33.9249},
    {c:"Dubai, UAE",         lng:55.2708, lat:25.2048},
    {c:"Mumbai, India",      lng:72.8777, lat:19.0760},
    {c:"Delhi, India",       lng:77.1025, lat:28.7041},
    {c:"Bangkok, Thailand",  lng:100.5018, lat:13.7563},
    {c:"Singapore",          lng:103.8198, lat:1.3521},
    {c:"Hong Kong, China",   lng:114.1694, lat:22.3193},
    {c:"Tokyo, Japan",       lng:139.6917, lat:35.6895},
    {c:"Seoul, South Korea", lng:126.9780, lat:37.5665},
    {c:"Sydney, Australia",  lng:151.2093, lat:-33.8688},
    {c:"Brisbane, Australia",lng:153.0251, lat:-27.4698},
    {c:"Auckland, New Zealand", lng:174.7633, lat:-36.8485},
    {c:"Toronto, Canada",    lng:-79.3832, lat:43.6532},
    {c:"Vancouver, Canada",  lng:-123.1207, lat:49.2827},
    {c:"Mexico City, Mexico",lng:-99.1332, lat:19.4326},
    {c:"São Paulo, Brazil",  lng:-46.6333, lat:-23.5505},
    {c:"Rio de Janeiro, Brazil", lng:-43.1729, lat:-22.9068},
    {c:"Buenos Aires, Argentina", lng:-58.3816, lat:-34.6037},
    {c:"Santiago, Chile",    lng:-70.6693, lat:-33.4489}
  ];

  // Generate ~900 posts across hubs with small jitter to spread within cities
  const TOTAL_WORLD = 900;
  for(let i=0;i<TOTAL_WORLD;i++){
    const hub = hubs[Math.floor(rnd()*hubs.length)];
    const baseCoord = safeCoordinate(hub.c, hub.lng, hub.lat, 0.1);
    const primaryVenue = pickRealVenue(hub.c, baseCoord.lng, baseCoord.lat);
    const coord = {
      lng: Number.isFinite(primaryVenue.lng) ? primaryVenue.lng : baseCoord.lng,
      lat: Number.isFinite(primaryVenue.lat) ? primaryVenue.lat : baseCoord.lat
    };
    const cat = pick(categories);
    const sub = pick(cat.subs);
    const id = 'WW'+i;
    const title = `${id} ${uniqueTitle(i*9343+19, hub.c, i)}`;
    const created = new Date().toISOString().replace(/[:.]/g,'-');
    out.push({
      id,
      title,
      slug: slugify(title),
      created,
      city: hub.c,
      lng: coord.lng,
      lat: coord.lat,
      category: cat.name,
      subcategory: sub,
      dates: randomDates(),
      sponsored: true, // All posts are sponsored for development
      fav:false,
      desc: randomText(),
      images: randomImages(id),
      locations: buildLocationList(hub.c, coord.lng, coord.lat, primaryVenue),
      member: { username: randomUsername(id), avatar: randomAvatar(id) },
    });
  }

  // ---- 400 single-venue posts across unique locations ----
  const coordKey = (lng, lat)=>{
    if(!Number.isFinite(lng) || !Number.isFinite(lat)) return '';
    return `${lng.toFixed(6)},${lat.toFixed(6)}`;
  };
  const existingCoordKeys = new Set(out.map(p => coordKey(p.lng, p.lat)).filter(Boolean));
  const singleVenueBases = [
    { city: "Anchorage, USA", lng: -149.9003, lat: 61.2181 },
    { city: "Honolulu, USA", lng: -157.8583, lat: 21.3069 },
    { city: "San Francisco, USA", lng: -122.4194, lat: 37.7749 },
    { city: "Seattle, USA", lng: -122.3321, lat: 47.6062 },
    { city: "Vancouver, Canada", lng: -123.1207, lat: 49.2827 },
    { city: "Calgary, Canada", lng: -114.0719, lat: 51.0447 },
    { city: "Toronto, Canada", lng: -79.3832, lat: 43.6532 },
    { city: "Montreal, Canada", lng: -73.5673, lat: 45.5017 },
    { city: "Boston, USA", lng: -71.0589, lat: 42.3601 },
    { city: "New Orleans, USA", lng: -90.0715, lat: 29.9511 },
    { city: "Chicago, USA", lng: -87.6298, lat: 41.8781 },
    { city: "Miami, USA", lng: -80.1918, lat: 25.7617 },
    { city: "Dallas, USA", lng: -96.7969, lat: 32.7767 },
    { city: "Denver, USA", lng: -104.9903, lat: 39.7392 },
    { city: "Phoenix, USA", lng: -112.0740, lat: 33.4484 },
    { city: "Los Angeles, USA", lng: -118.2437, lat: 34.0522 },
    { city: "Mexico City, Mexico", lng: -99.1332, lat: 19.4326 },
    { city: "Guadalajara, Mexico", lng: -103.3496, lat: 20.6597 },
    { city: "Bogotá, Colombia", lng: -74.0721, lat: 4.7110 },
    { city: "Lima, Peru", lng: -77.0428, lat: -12.0464 },
    { city: "Quito, Ecuador", lng: -78.4678, lat: -0.1807 },
    { city: "Santiago, Chile", lng: -70.6693, lat: -33.4489 },
    { city: "Buenos Aires, Argentina", lng: -58.3816, lat: -34.6037 },
    { city: "Montevideo, Uruguay", lng: -56.1645, lat: -34.9011 },
    { city: "São Paulo, Brazil", lng: -46.6333, lat: -23.5505 },
    { city: "Rio de Janeiro, Brazil", lng: -43.1729, lat: -22.9068 },
    { city: "Brasília, Brazil", lng: -47.8825, lat: -15.7942 },
    { city: "Recife, Brazil", lng: -34.8770, lat: -8.0476 },
    { city: "Fortaleza, Brazil", lng: -38.5434, lat: -3.7319 },
    { city: "Caracas, Venezuela", lng: -66.9036, lat: 10.4806 },
    { city: "San Juan, Puerto Rico", lng: -66.1057, lat: 18.4655 },
    { city: "Reykjavík, Iceland", lng: -21.8277, lat: 64.1265 },
    { city: "Oslo, Norway", lng: 10.7522, lat: 59.9139 },
    { city: "Stockholm, Sweden", lng: 18.0686, lat: 59.3293 },
    { city: "Helsinki, Finland", lng: 24.9384, lat: 60.1699 },
    { city: "Copenhagen, Denmark", lng: 12.5683, lat: 55.6761 },
    { city: "Edinburgh, UK", lng: -3.1883, lat: 55.9533 },
    { city: "Dublin, Ireland", lng: -6.2603, lat: 53.3498 },
    { city: "Glasgow, UK", lng: -4.2518, lat: 55.8642 },
    { city: "London, UK", lng: -0.1276, lat: 51.5074 },
    { city: "Manchester, UK", lng: -2.2426, lat: 53.4808 },
    { city: "Paris, France", lng: 2.3522, lat: 48.8566 },
    { city: "Lyon, France", lng: 4.8357, lat: 45.7640 },
    { city: "Marseille, France", lng: 5.3698, lat: 43.2965 },
    { city: "Madrid, Spain", lng: -3.7038, lat: 40.4168 },
    { city: "Barcelona, Spain", lng: 2.1734, lat: 41.3851 },
    { city: "Valencia, Spain", lng: -0.3763, lat: 39.4699 },
    { city: "Lisbon, Portugal", lng: -9.1393, lat: 38.7223 },
    { city: "Porto, Portugal", lng: -8.6291, lat: 41.1579 },
    { city: "Brussels, Belgium", lng: 4.3517, lat: 50.8503 },
    { city: "Amsterdam, Netherlands", lng: 4.9041, lat: 52.3676 },
    { city: "Rotterdam, Netherlands", lng: 4.4792, lat: 51.9244 },
    { city: "Berlin, Germany", lng: 13.4050, lat: 52.5200 },
    { city: "Hamburg, Germany", lng: 9.9937, lat: 53.5511 },
    { city: "Munich, Germany", lng: 11.5820, lat: 48.1351 },
    { city: "Frankfurt, Germany", lng: 8.6821, lat: 50.1109 },
    { city: "Prague, Czechia", lng: 14.4378, lat: 50.0755 },
    { city: "Vienna, Austria", lng: 16.3738, lat: 48.2082 },
    { city: "Zurich, Switzerland", lng: 8.5417, lat: 47.3769 },
    { city: "Warsaw, Poland", lng: 21.0122, lat: 52.2297 },
    { city: "Kraków, Poland", lng: 19.9440, lat: 50.0647 },
    { city: "Budapest, Hungary", lng: 19.0402, lat: 47.4979 },
    { city: "Bucharest, Romania", lng: 26.1025, lat: 44.4268 },
    { city: "Athens, Greece", lng: 23.7275, lat: 37.9838 },
    { city: "Istanbul, Türkiye", lng: 28.9784, lat: 41.0082 },
    { city: "Ankara, Türkiye", lng: 32.8597, lat: 39.9334 },
    { city: "Cairo, Egypt", lng: 31.2357, lat: 30.0444 },
    { city: "Casablanca, Morocco", lng: -7.5898, lat: 33.5731 },
    { city: "Marrakesh, Morocco", lng: -7.9811, lat: 31.6295 },
    { city: "Algiers, Algeria", lng: 3.0588, lat: 36.7538 },
    { city: "Tunis, Tunisia", lng: 10.1815, lat: 36.8065 },
    { city: "Tripoli, Libya", lng: 13.1913, lat: 32.8872 },
    { city: "Khartoum, Sudan", lng: 32.5599, lat: 15.5007 },
    { city: "Addis Ababa, Ethiopia", lng: 38.7578, lat: 8.9806 },
    { city: "Nairobi, Kenya", lng: 36.8219, lat: -1.2921 },
    { city: "Kampala, Uganda", lng: 32.5825, lat: 0.3476 },
    { city: "Dar es Salaam, Tanzania", lng: 39.2083, lat: -6.7924 },
    { city: "Kigali, Rwanda", lng: 30.0588, lat: -1.9499 },
    { city: "Lagos, Nigeria", lng: 3.3792, lat: 6.5244 },
    { city: "Accra, Ghana", lng: -0.1869, lat: 5.6037 },
    { city: "Abidjan, Côte d'Ivoire", lng: -4.0083, lat: 5.3599 },
    { city: "Dakar, Senegal", lng: -17.4731, lat: 14.7167 },
    { city: "Kinshasa, DR Congo", lng: 15.2663, lat: -4.4419 },
    { city: "Luanda, Angola", lng: 13.2344, lat: -8.8383 },
    { city: "Johannesburg, South Africa", lng: 28.0473, lat: -26.2041 },
    { city: "Cape Town, South Africa", lng: 18.4241, lat: -33.9249 },
    { city: "Windhoek, Namibia", lng: 17.0832, lat: -22.5609 },
    { city: "Gaborone, Botswana", lng: 25.9089, lat: -24.6282 },
    { city: "Harare, Zimbabwe", lng: 31.0530, lat: -17.8249 },
    { city: "Maputo, Mozambique", lng: 32.5732, lat: -25.9692 },
    { city: "Riyadh, Saudi Arabia", lng: 46.6753, lat: 24.7136 },
    { city: "Jeddah, Saudi Arabia", lng: 39.1979, lat: 21.4858 },
    { city: "Doha, Qatar", lng: 51.5310, lat: 25.2854 },
    { city: "Dubai, UAE", lng: 55.2708, lat: 25.2048 },
    { city: "Muscat, Oman", lng: 58.4059, lat: 23.5859 },
    { city: "Kuwait City, Kuwait", lng: 47.9783, lat: 29.3759 },
    { city: "Manama, Bahrain", lng: 50.5861, lat: 26.2285 },
    { city: "Tehran, Iran", lng: 51.3890, lat: 35.6892 },
    { city: "Baghdad, Iraq", lng: 44.3661, lat: 33.3152 },
    { city: "Amman, Jordan", lng: 35.9239, lat: 31.9522 },
    { city: "Beirut, Lebanon", lng: 35.5018, lat: 33.8938 },
    { city: "Jerusalem", lng: 35.2137, lat: 31.7683 },
    { city: "Mumbai, India", lng: 72.8777, lat: 19.0760 },
    { city: "Delhi, India", lng: 77.1025, lat: 28.7041 },
    { city: "Bengaluru, India", lng: 77.5946, lat: 12.9716 },
    { city: "Hyderabad, India", lng: 78.4867, lat: 17.3850 },
    { city: "Chennai, India", lng: 80.2707, lat: 13.0827 },
    { city: "Kolkata, India", lng: 88.3639, lat: 22.5726 },
    { city: "Kathmandu, Nepal", lng: 85.3240, lat: 27.7172 },
    { city: "Dhaka, Bangladesh", lng: 90.4125, lat: 23.8103 },
    { city: "Colombo, Sri Lanka", lng: 79.8612, lat: 6.9271 },
    { city: "Bangkok, Thailand", lng: 100.5018, lat: 13.7563 },
    { city: "Chiang Mai, Thailand", lng: 98.9931, lat: 18.7883 },
    { city: "Vientiane, Laos", lng: 102.6341, lat: 17.9757 },
    { city: "Phnom Penh, Cambodia", lng: 104.9282, lat: 11.5564 },
    { city: "Ho Chi Minh City, Vietnam", lng: 106.6297, lat: 10.8231 },
    { city: "Hanoi, Vietnam", lng: 105.8342, lat: 21.0278 },
    { city: "Yangon, Myanmar", lng: 96.1951, lat: 16.8409 },
    { city: "Singapore", lng: 103.8198, lat: 1.3521 },
    { city: "Kuala Lumpur, Malaysia", lng: 101.6869, lat: 3.1390 },
    { city: "Jakarta, Indonesia", lng: 106.8456, lat: -6.2088 },
    { city: "Surabaya, Indonesia", lng: 112.7521, lat: -7.2575 },
    { city: "Manila, Philippines", lng: 120.9842, lat: 14.5995 },
    { city: "Cebu, Philippines", lng: 123.8854, lat: 10.3157 },
    { city: "Hong Kong", lng: 114.1694, lat: 22.3193 },
    { city: "Macau", lng: 113.5439, lat: 22.1987 },
    { city: "Taipei, Taiwan", lng: 121.5654, lat: 25.0330 },
    { city: "Seoul, South Korea", lng: 126.9780, lat: 37.5665 },
    { city: "Busan, South Korea", lng: 129.0756, lat: 35.1796 },
    { city: "Tokyo, Japan", lng: 139.6917, lat: 35.6895 },
    { city: "Osaka, Japan", lng: 135.5023, lat: 34.6937 },
    { city: "Nagoya, Japan", lng: 136.9066, lat: 35.1815 },
    { city: "Sapporo, Japan", lng: 141.3544, lat: 43.0618 },
    { city: "Beijing, China", lng: 116.4074, lat: 39.9042 },
    { city: "Shanghai, China", lng: 121.4737, lat: 31.2304 },
    { city: "Guangzhou, China", lng: 113.2644, lat: 23.1291 },
    { city: "Shenzhen, China", lng: 114.0579, lat: 22.5431 },
    { city: "Chengdu, China", lng: 104.0665, lat: 30.5728 },
    { city: "Xi'an, China", lng: 108.9398, lat: 34.3416 },
    { city: "Ulaanbaatar, Mongolia", lng: 106.9057, lat: 47.8864 },
    { city: "Almaty, Kazakhstan", lng: 76.8860, lat: 43.2389 },
    { city: "Bishkek, Kyrgyzstan", lng: 74.5698, lat: 42.8746 },
    { city: "Tashkent, Uzbekistan", lng: 69.2401, lat: 41.2995 },
    { city: "Astana, Kazakhstan", lng: 71.4704, lat: 51.1605 },
    { city: "Moscow, Russia", lng: 37.6173, lat: 55.7558 },
    { city: "Saint Petersburg, Russia", lng: 30.3351, lat: 59.9343 },
    { city: "Novosibirsk, Russia", lng: 82.9346, lat: 55.0084 },
    { city: "Yekaterinburg, Russia", lng: 60.5975, lat: 56.8389 },
    { city: "Perth, Australia", lng: 115.8575, lat: -31.9505 },
    { city: "Adelaide, Australia", lng: 138.6007, lat: -34.9285 },
    { city: "Melbourne, Australia", lng: 144.9631, lat: -37.8136 },
    { city: "Sydney, Australia", lng: 151.2093, lat: -33.8688 },
    { city: "Brisbane, Australia", lng: 153.0251, lat: -27.4698 },
    { city: "Hobart, Australia", lng: 147.3272, lat: -42.8821 },
    { city: "Auckland, New Zealand", lng: 174.7633, lat: -36.8485 },
    { city: "Wellington, New Zealand", lng: 174.7762, lat: -41.2865 },
    { city: "Christchurch, New Zealand", lng: 172.6362, lat: -43.5321 },
    { city: "Suva, Fiji", lng: 178.4419, lat: -18.1248 }
  ];
  const SINGLE_VENUE_POSTS = 400;
  for(let i=0;i<SINGLE_VENUE_POSTS;i++){
    const base = singleVenueBases[i % singleVenueBases.length];
    const seq = Math.floor(i / singleVenueBases.length) + 1;
    const angle = ((i % singleVenueBases.length) / singleVenueBases.length) * Math.PI * 2;
    const radius = 0.3 + seq * 0.02;
    let lng = base.lng + Math.cos(angle) * radius;
    let lat = clamp(base.lat + Math.sin(angle) * radius, -80, 80);
    let key = coordKey(lng, lat);
    let attempt = 0;
    while(existingCoordKeys.has(key) && attempt < 120){
      const adjust = 0.05 + attempt * 0.01;
      lng = base.lng + Math.cos(angle + adjust) * (radius + adjust * 0.5);
      lat = clamp(base.lat + Math.sin(angle + adjust) * (radius + adjust * 0.5), -80, 80);
      key = coordKey(lng, lat);
      attempt++;
    }
    if(existingCoordKeys.has(key)){
      let fallback = 0;
      let nextLng = lng;
      let nextLat = lat;
      let nextKey = key;
      while(existingCoordKeys.has(nextKey) && fallback < 160){
        nextLng += 0.005 * (1 + (fallback % 3));
        nextLat = clamp(nextLat + (fallback % 2 === 0 ? 0.003 : -0.003), -80, 80);
        nextKey = coordKey(nextLng, nextLat);
        fallback++;
      }
      lng = nextLng;
      lat = nextLat;
      key = nextKey;
    }
    if(key){ existingCoordKeys.add(key); }
    const cat = pick(categories);
    const sub = pick(cat.subs);
    const id = 'SV'+i;
    const title = `${id} ${uniqueTitle(i*48271+131, base.city, i)}`;
    const created = new Date().toISOString().replace(/[:.]/g,'-');
    const venueName = `${base.city} Solo Venue ${seq}-${(i % singleVenueBases.length) + 1}`;
    const locationDetail = toLocationDetails({
      venue: venueName,
      address: base.city,
      lng,
      lat
    });
    out.push({
      id,
      title,
      slug: slugify(title),
      created,
      city: base.city,
      lng,
      lat,
      category: cat.name,
      subcategory: sub,
      dates: randomDates(),
      sponsored: true, // All posts are sponsored for development
      fav:false,
      desc: randomText(),
      images: randomImages(id),
      locations: [locationDetail],
      member: { username: randomUsername(id), avatar: randomAvatar(id) },
    });
  }
  return out;
}

    let postsLoaded = window.postsLoaded || false;
    window.postsLoaded = postsLoaded;
    let waitForInitialZoom = window.waitForInitialZoom ?? (firstVisit ? true : false);
    let initialZoomStarted = false;
    let postLoadRequested = false;
    window.waitForInitialZoom = waitForInitialZoom;
    if(postsLoaded){
      waitForInitialZoom = false;
      window.waitForInitialZoom = waitForInitialZoom;
    }
    function loadPosts(){
      if(postsLoaded) return;
      if(spinning){
        pendingPostLoad = true;
        return;
      }
      posts = makePosts().filter(p => Number.isFinite(p.lng) && Number.isFinite(p.lat));
      postsLoaded = true;
      window.postsLoaded = postsLoaded;
      if(Object.keys(subcategoryMarkers).length) addPostSource();
      initAdBoard();
      applyFilters();
    }

    function checkLoadPosts(){
      if(waitForInitialZoom){
        postLoadRequested = true;
        hideResultIndicators();
        return;
      }
      if(!map) return;
      if(spinning){
        if(!postsLoaded) pendingPostLoad = true;
        hideResultIndicators();
        return;
      }
      postLoadRequested = false;
      if(!postsLoaded) loadPosts();
      if(postsLoaded && Object.keys(subcategoryMarkers).length) addPostSource();
      applyFilters();
    }

    const resultsEl = $('#results');
    const postsWideEl = $('.post-board');
    const postsModeEl = $('.post-board');

    let sortedPostList = [];
    let renderedPostCount = 0;
    let postBatchObserver = null;
    let postSentinel = null;
    let postBoardScrollOptions = null;
    const INITIAL_RENDER_COUNT = 50;
    const POST_BATCH_SIZE = 25;

    function appendPostBatch(count = POST_BATCH_SIZE){
      const slice = sortedPostList.slice(renderedPostCount, renderedPostCount + count);
      slice.forEach(p => {
        if(resultsEl){
          const rCard = card(p);
          if(activePostId && p.id === activePostId) rCard.setAttribute('aria-selected','true');
          resultsEl.appendChild(rCard);
        }
        const wCard = card(p, true);
        postsWideEl.insertBefore(wCard, postSentinel);
      });
      renderedPostCount += slice.length;
      if(renderedPostCount >= sortedPostList.length){
        if(postBatchObserver) postBatchObserver.disconnect();
        removeScrollListener(postsWideEl, onPostBoardScroll, postBoardScrollOptions);
        postBoardScrollOptions = null;
      }
      prioritizeVisibleImages();
    }

    function onPostBoardScroll(){
      if(postsWideEl.scrollTop + postsWideEl.clientHeight >= postsWideEl.scrollHeight - 200){
        appendPostBatch();
      }
    }

    // Image helpers (unique per post)
    function isPortrait(id){ let h=0; for(let i=0;i<id.length;i++){ h=(h<<5)-h+id.charCodeAt(i); h|=0; } return Math.abs(h)%2===0; }
    function imgThumb(pOrId){ const id = typeof pOrId==='string' ? pOrId : pOrId.id; const port=isPortrait(id); return `https://picsum.photos/seed/${encodeURIComponent(id)}-t/${port?'200/300':'300/200'}`; }
    function imgHero(pOrId){  const id = typeof pOrId==='string' ? pOrId : pOrId.id;  const port=isPortrait(id); return `https://picsum.photos/seed/${encodeURIComponent(id)}-t/${port?'800/1200':'1200/800'}`; }

    function memberAvatarUrl(p){
      if(p.member && p.member.avatar){
        return p.member.avatar;
      }
      return 'assets/balloons/balloons-icon-16185.png';
    }

    function mapCardHTML(p, opts={}){
      const venueName = getPrimaryVenueName(p) || p.city;
      const labelLines = getMarkerLabelLines(p);
      const cardTitleLines = Array.isArray(labelLines.cardTitleLines) && labelLines.cardTitleLines.length
        ? labelLines.cardTitleLines.slice(0, 2)
        : [labelLines.line1, labelLines.line2].filter(Boolean).slice(0, 2);
      const titleHtml = (cardTitleLines.length ? cardTitleLines : [''])
        .filter((_, idx) => idx < 2)
        .map(line => `<div class="map-card-title-line">${line}</div>`)
        .join('');
      const venueLine = labelLines.venueLine || shortenMarkerLabelText(venueName, mapCardTitleWidthPx);
      const venueHtml = venueLine ? `<div class="map-card-venue">${venueLine}</div>` : '';
      const labelHtml = `<div class="map-card-label"><div class="map-card-title">${titleHtml}</div>${venueHtml}</div>`;
      const classes = ['map-card'];
      const extraClasses = Array.isArray(opts.extraClasses) ? opts.extraClasses : (opts.extraClass ? [opts.extraClass] : []);
      const variant = opts.variant || 'popup';
      if(variant === 'popup') classes.push('map-card--popup');
      if(variant === 'list') classes.push('map-card--list');
      extraClasses.filter(Boolean).forEach(cls => classes.push(cls));
      if(variant === 'list'){
        return `<div class="${classes.join(' ')}" data-id="${p.id}"><img class="map-card-thumb" src="${imgThumb(p)}" alt="" referrerpolicy="no-referrer" />${labelHtml}</div>`;
      }
      return `<div class="${classes.join(' ')}" data-id="${p.id}"><img class="map-card-pill" src="assets/icons-30/225x60-pill-99.webp" alt="" /><img class="map-card-thumb" src="${imgThumb(p)}" alt="" referrerpolicy="no-referrer" />${labelHtml}</div>`;
    }

    function hoverHTML(p){
      return mapCardHTML(p);
    }

    // Categories UI
    const categoryControllers = {};
    const allSubcategoryKeys = [];
    const resetCategoriesBtn = $('#resetCategoriesBtn');
    const catsEl = $('#cats');
    const formbuilderCats = document.getElementById('formbuilderCats');
    const syncFormbuilderCats = ()=>{
      if(!formbuilderCats || !catsEl) return;
      const frag = document.createDocumentFragment();
      catsEl.querySelectorAll('.filter-category-menu').forEach(menu=>{
        const clone = menu.cloneNode(true);
        const trigger = clone.querySelector('.filter-category-trigger');
        const optionsMenu = clone.querySelector('.options-menu');
        if(optionsMenu){
          const originalId = optionsMenu.id || '';
          const cloneId = originalId ? `${originalId}-formbuilder` : '';
          if(cloneId){
            optionsMenu.id = cloneId;
            if(trigger){
              trigger.setAttribute('aria-controls', cloneId);
            }
          }
        }
        if(trigger && optionsMenu){
          const isExpanded = menu.getAttribute('aria-expanded') === 'true';
          clone.setAttribute('aria-expanded', isExpanded ? 'true' : 'false');
          trigger.setAttribute('aria-expanded', isExpanded ? 'true' : 'false');
          optionsMenu.hidden = !isExpanded;
          trigger.addEventListener('click', ()=>{
            if(trigger.getAttribute('aria-disabled') === 'true') return;
            const open = clone.getAttribute('aria-expanded') === 'true';
            const next = !open;
            clone.setAttribute('aria-expanded', next ? 'true' : 'false');
            trigger.setAttribute('aria-expanded', next ? 'true' : 'false');
            optionsMenu.hidden = !next;
          });
        }
        clone.querySelectorAll('.cat-switch').forEach(el => el.remove());
        if(optionsMenu){
          optionsMenu.querySelectorAll('.subcategory-switch').forEach(el => el.remove());
        }
        const optionButtons = optionsMenu ? Array.from(optionsMenu.querySelectorAll('button')) : [];
        const syncCatState = checked =>{
          clone.classList.toggle('cat-off', !checked);
          if(trigger){
            trigger.setAttribute('aria-disabled', checked ? 'false' : 'true');
          }
          optionButtons.forEach(btn=>{
            btn.disabled = !checked;
            btn.setAttribute('aria-disabled', checked ? 'false' : 'true');
          });
          if(!checked && optionsMenu){
            optionsMenu.hidden = true;
            clone.setAttribute('aria-expanded', 'false');
            if(trigger){
              trigger.setAttribute('aria-expanded', 'false');
            }
          }
        };
        const catSwitchInput = clone.querySelector('.cat-switch input');
        if(catSwitchInput){
          const initialActive = !clone.classList.contains('cat-off');
          catSwitchInput.checked = initialActive;
          syncCatState(initialActive);
          catSwitchInput.addEventListener('change', ()=>{
            syncCatState(catSwitchInput.checked);
          });
        } else {
          syncCatState(!clone.classList.contains('cat-off'));
        }
        optionButtons.forEach(btn=>{
          btn.addEventListener('click', ()=>{
            if(btn.disabled) return;
            const pressed = btn.getAttribute('aria-pressed') === 'true';
            const next = !pressed;
            btn.setAttribute('aria-pressed', next ? 'true' : 'false');
            btn.classList.toggle('on', next);
          });
        });
        frag.appendChild(clone);
      });
      formbuilderCats.innerHTML = '';
      formbuilderCats.appendChild(frag);
    };
    function updateCategoryResetBtn(){
      if(!resetCategoriesBtn) return;
      const anyCategoryOff = Object.values(categoryControllers).some(ctrl=>ctrl && typeof ctrl.isActive === 'function' && !ctrl.isActive());
      const totalSubs = allSubcategoryKeys.length;
      const activeSubs = selection.subs instanceof Set ? selection.subs.size : 0;
      const anySubOff = totalSubs > 0 && activeSubs < totalSubs;
      resetCategoriesBtn.classList.toggle('active', anyCategoryOff || anySubOff);
    }
    function refreshSubcategoryLogos(){
      Object.values(categoryControllers).forEach(ctrl=>{
        if(ctrl && typeof ctrl.refreshLogos === 'function'){
          ctrl.refreshLogos();
        }
      });
    }
    if(catsEl){
      const seedSubs = selection.subs.size === 0;
      categories.forEach(c=>{
        const el = document.createElement('div');
        el.className='filter-category-menu';
        el.dataset.category = c.name;
        el.setAttribute('role','group');
        el.setAttribute('aria-expanded','false');

        const header = document.createElement('div');
        header.className='filter-category-header';

        const triggerWrap = document.createElement('div');
        triggerWrap.className='options-dropdown filter-category-trigger-wrap';

        const menuBtn = document.createElement('button');
        menuBtn.type='button';
        menuBtn.className='filter-category-trigger';
        menuBtn.setAttribute('aria-haspopup','true');
        menuBtn.setAttribute('aria-expanded','false');
        const menuId = `filter-category-menu-${slugify(c.name)}`;
        menuBtn.setAttribute('aria-controls', menuId);

        const categoryLogo = document.createElement('span');
        categoryLogo.className='category-logo';
        const iconPrefix = (window.ICON_BASE || {})[c.name];
        if(iconPrefix){
          const img = document.createElement('img');
          img.src = `assets/icons-30/${iconPrefix}-30.webp`;
          img.width = 30;
          img.height = 30;
          img.alt = '';
          categoryLogo.appendChild(img);
        } else {
          categoryLogo.textContent = c.name.charAt(0) || '';
        }

        const label = document.createElement('span');
        label.className='label';
        label.textContent=c.name;

        const arrow = document.createElement('span');
        arrow.className='dropdown-arrow';
        arrow.setAttribute('aria-hidden','true');

        menuBtn.append(categoryLogo, label, arrow);

        const optionsMenu = document.createElement('div');
        optionsMenu.className='options-menu';
        optionsMenu.id = menuId;
        optionsMenu.hidden = true;

        triggerWrap.append(menuBtn, optionsMenu);

        const toggle = document.createElement('label');
        toggle.className='cat-switch';
        const input = document.createElement('input');
        input.type='checkbox';
        input.setAttribute('aria-label',`Toggle ${c.name} category`);
        const slider = document.createElement('span');
        slider.className='slider';
        toggle.append(input, slider);

        const subButtons = [];
        c.subs.forEach(s=>{
          const subBtn=document.createElement('button');
          subBtn.type='button';
          subBtn.className='subcategory-option';
          subBtn.dataset.category = c.name;
          subBtn.dataset.subcategory = s;
          const key = c.name+'::'+s;
          if(!allSubcategoryKeys.includes(key)){
            allSubcategoryKeys.push(key);
          }
          if(seedSubs){
            selection.subs.add(key);
          }
          const isSelected = selection.subs.has(key);
          subBtn.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
          if(isSelected){
            subBtn.classList.add('on');
          }
          subBtn.innerHTML='<span class="subcategory-logo"></span><span class="subcategory-label"></span><span class="subcategory-switch" aria-hidden="true"><span class="track"></span><span class="thumb"></span></span>';
          const subLabel = subBtn.querySelector('.subcategory-label');
          if(subLabel){
            subLabel.textContent = s;
          }
          subBtn.addEventListener('click',()=>{
            if(!input.checked) return;
            const isActive = subBtn.getAttribute('aria-pressed') === 'true';
            if(isActive){
              subBtn.setAttribute('aria-pressed','false');
              subBtn.classList.remove('on');
              selection.subs.delete(key);
            } else {
              subBtn.setAttribute('aria-pressed','true');
              subBtn.classList.add('on');
              selection.subs.add(key);
            }
            applyFilters();
            updateCategoryResetBtn();
          });
          optionsMenu.appendChild(subBtn);
          subButtons.push(subBtn);
        });

        header.append(triggerWrap, toggle);
        el.appendChild(header);
        catsEl.appendChild(el);

        let openState = false;
        function syncExpanded(){
          const expanded = input.checked && openState;
          el.setAttribute('aria-expanded', expanded ? 'true' : 'false');
          menuBtn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
          optionsMenu.hidden = !expanded;
        }
        function setOpenState(next){
          openState = !!next;
          syncExpanded();
        }
        function setCategoryActive(active, opts={}){
          const enabled = !!active;
          input.checked = enabled;
          el.classList.toggle('cat-off', !enabled);
          menuBtn.disabled = !enabled;
          menuBtn.setAttribute('aria-disabled', enabled ? 'false' : 'true');
          subButtons.forEach(btn=>{
            btn.disabled = !enabled;
            btn.setAttribute('aria-disabled', enabled ? 'false' : 'true');
          });
          if(enabled){
            selection.cats.add(c.name);
          } else {
            selection.cats.delete(c.name);
            setOpenState(false);
          }
          syncExpanded();
          if(!opts.silent){
            applyFilters();
            updateResetBtn();
          }
          updateCategoryResetBtn();
        }
        menuBtn.addEventListener('click', ()=>{
          if(menuBtn.disabled) return;
          setOpenState(!openState);
        });
        input.addEventListener('change', ()=>{
          setCategoryActive(input.checked);
        });

        const controller = {
          name: c.name,
          element: el,
          setActive: (active, opts={})=> setCategoryActive(active, opts),
          setOpen: (open)=> setOpenState(open),
          getOpenState: ()=> openState,
          isActive: ()=> input.checked,
          syncSubs: ()=>{
            subButtons.forEach(btn=>{
              const subName = btn.dataset.subcategory;
              const key = c.name+'::'+subName;
              const selected = selection.subs.has(key);
              btn.setAttribute('aria-pressed', selected ? 'true' : 'false');
              btn.classList.toggle('on', selected);
            });
          },
          refreshLogos: ()=>{
            subButtons.forEach(btn=>{
              const logoSpan = btn.querySelector('.subcategory-logo');
              if(!logoSpan) return;
              const iconHtml = subcategoryIcons[btn.dataset.subcategory] || '';
              logoSpan.innerHTML = iconHtml;
            });
          }
        };
        categoryControllers[c.name] = controller;
        setCategoryActive(true, {silent:true});
        controller.syncSubs();
        syncExpanded();
      });
      refreshSubcategoryLogos();
      syncFormbuilderCats();
      if(formbuilderCats){
        const observer = new MutationObserver(()=> syncFormbuilderCats());
        observer.observe(catsEl, {childList:true, subtree:true, attributes:true});
      }
      const handleIconsReady = ()=>{
        refreshSubcategoryLogos();
        syncFormbuilderCats();
      };
      document.addEventListener('subcategory-icons-ready', handleIconsReady);
      updateCategoryResetBtn();
      updateResetBtn();
    }

    if(resetCategoriesBtn){
      resetCategoriesBtn.addEventListener('click', ()=>{
        selection.subs = new Set(allSubcategoryKeys);
        Object.values(categoryControllers).forEach(ctrl=>{
          ctrl.setActive(true, {silent:true});
          ctrl.setOpen(false);
          ctrl.syncSubs();
        });
        applyFilters();
        updateResetBtn();
        updateCategoryResetBtn();
      });
    }

    // Reset
    $('#resetBtn').addEventListener('click',()=>{
      $('#keyword-textbox').value='';
      $('#daterange-textbox').value='';
      const expired = $('#expiredToggle');
      if(expired){
        expired.checked = false;
        expiredWasOn = false;
      }
      dateStart = null;
      dateEnd = null;
      buildFilterCalendar(today, maxPickerDate);
      updateRangeClasses();
      updateInput();
      closeCalendarPopup();
      if(geocoder) geocoder.clear();
      applyFilters();
      updateClearButtons();
    });

    function updateClearButtons(){
      const kw = $('#keyword-textbox');
      const kwX = kw.parentElement.querySelector('.keyword-clear-button');
      kwX && kwX.classList.toggle('active', kw.value.trim() !== '');
      const date = $('#daterange-textbox');
      const dateX = date.parentElement.querySelector('.daterange-clear-button');
      const hasDate = (dateStart || dateEnd) || $('#expiredToggle').checked;
      dateX && dateX.classList.toggle('active', !!hasDate);
      updateResetBtn();
    }

    function nonLocationFiltersActive(){
      const kw = $('#keyword-textbox').value.trim() !== '';
      const raw = $('#daterange-textbox').value.trim();
      const hasDate = !!(dateStart || dateEnd || raw);
      const expired = $('#expiredToggle').checked;
      return kw || hasDate || expired;
    }

    function updateResetBtn(){
      const active = nonLocationFiltersActive();
      document.body.classList.toggle('filters-active', active);
      const reset = $('#resetBtn');
      reset && reset.classList.toggle('active', active);
    }

    function fmtShort(iso){
      return parseISODate(iso).toLocaleDateString('en-GB', {weekday:'short', day:'numeric', month:'short'}).replace(/,/g,'');
    }

    const dateRangeInput = $('#daterange-textbox');
    $('#keyword-textbox').addEventListener('input', ()=>{ applyFilters(); updateClearButtons(); });
    dateRangeInput?.addEventListener('input', ()=>{ applyFilters(); updateClearButtons(); });
    if(dateRangeInput){
      dateRangeInput.addEventListener('focus', ()=> openCalendarPopup());
      dateRangeInput.addEventListener('click', ()=> openCalendarPopup());
    }
    $('#daterange-textbox').addEventListener('keydown', e=>{
      if(e.key === 'Tab'){
        closeCalendarPopup();
        return;
      }
      if(e.key === 'Escape'){
        e.preventDefault();
        closeCalendarPopup();
        return;
      }
      if(e.key === 'Enter' || e.key === ' ' || e.key === 'ArrowDown'){
        e.preventDefault();
        openCalendarPopup(true);
        return;
      }
      if(e.key==='ArrowLeft' || e.key==='ArrowRight'){
        e.preventDefault();
        openCalendarPopup();
        const month = calendarScroll ? calendarScroll.querySelector('.month') : null;
        const w = month ? month.offsetWidth : 0;
        if(calendarScroll && w){
          calendarScroll.scrollBy({left:e.key==='ArrowLeft'?-w:w, behavior:'smooth'});
        }
        return;
      }
      e.preventDefault();
    });
    const today = new Date();
    today.setHours(0,0,0,0);
    const minPickerDate = new Date(today);
    minPickerDate.setMonth(minPickerDate.getMonth() - 12);
    const maxPickerDate = new Date(today);
    maxPickerDate.setFullYear(maxPickerDate.getFullYear() + 2);
    const expiredToggle = $('#expiredToggle');
    const calendarScroll = $('#datePickerContainer');
    const filterBasics = $('#filterPanel .filter-basics-container');
    const filterPanelBody = $('#filterPanel .panel-body');
    let calendarPopupOpen = false;

    function positionCalendarPopup(){
      if(!calendarScroll || !dateRangeInput || !filterBasics) return;
      const inputRect = dateRangeInput.getBoundingClientRect();
      const containerRect = filterBasics.getBoundingClientRect();
      const left = inputRect.left - containerRect.left;
      const top = inputRect.bottom - containerRect.top + 8;
      const popupWidth = calendarScroll.offsetWidth || 0;
      const maxLeft = Math.max(0, containerRect.width - popupWidth);
      const clampedLeft = Math.min(Math.max(left, 0), maxLeft);
      calendarScroll.style.left = `${Math.round(clampedLeft)}px`;
      calendarScroll.style.top = `${Math.round(top)}px`;
    }

    function handleCalendarOutsideClick(e){
      if(!calendarScroll) return;
      if(calendarScroll.contains(e.target)) return;
      if(dateRangeInput && dateRangeInput.contains(e.target)) return;
      closeCalendarPopup();
    }

    function openCalendarPopup(focusCalendar = false){
      if(!calendarScroll) return;
      if(!calendarPopupOpen){
        calendarPopupOpen = true;
        calendarScroll.classList.add('is-visible');
        calendarScroll.setAttribute('tabindex','0');
        calendarScroll.setAttribute('aria-hidden','false');
        if(dateRangeInput) dateRangeInput.setAttribute('aria-expanded','true');
        document.addEventListener('click', handleCalendarOutsideClick, true);
        window.addEventListener('resize', positionCalendarPopup);
        filterPanelBody?.addEventListener('scroll', positionCalendarPopup, { passive:true });
      }
      positionCalendarPopup();
      if(focusCalendar){
        calendarScroll.focus({ preventScroll:true });
      }
    }

    function closeCalendarPopup(){
      if(!calendarScroll || !calendarPopupOpen) return;
      calendarPopupOpen = false;
      if(calendarScroll.contains(document.activeElement)){
        const activeEl = document.activeElement;
        if(activeEl && typeof activeEl.blur === 'function'){
          activeEl.blur();
        }
      }
      calendarScroll.setAttribute('tabindex','-1');
      calendarScroll.classList.remove('is-visible');
      calendarScroll.setAttribute('aria-hidden','true');
      if(dateRangeInput) dateRangeInput.setAttribute('aria-expanded','false');
      document.removeEventListener('click', handleCalendarOutsideClick, true);
      window.removeEventListener('resize', positionCalendarPopup);
      filterPanelBody?.removeEventListener('scroll', positionCalendarPopup);
    }

    function verticalCanScroll(el, delta){
      if(!el) return false;
      if(delta < 0) return el.scrollTop > 0;
      if(delta > 0) return el.scrollTop < el.scrollHeight - el.clientHeight;
      return false;
    }

    function setupHorizontalWheel(scroller){
      if(!scroller) return;
      scroller.addEventListener('wheel', e=>{
        const delta = Math.abs(e.deltaX) > Math.abs(e.deltaY) ? e.deltaX : e.deltaY;
        if(delta !== 0){
          scroller.scrollLeft += delta;
          e.preventDefault();
        }
      }, {passive:false});
    }

    function smoothScroll(el, to, duration=600){
      const start = el.scrollLeft;
      const change = to - start;
      const startTime = performance.now();
      function animate(time){
        const elapsed = time - startTime;
        const progress = Math.min(elapsed / duration, 1);
        el.scrollLeft = start + change * progress;
        if(progress < 1) requestAnimationFrame(animate);
      }
      requestAnimationFrame(animate);
    }

    function setupCalendarScroll(scroller){
      if(!scroller) return;
      scroller.setAttribute('tabindex','0');
      setupHorizontalWheel(scroller);
      const container = scroller.closest('.calendar-container');
      const adjustScale = () => {
        if(!container) return;
        const base = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--calendar-width')) || 0;
        const available = container.parentElement ? container.parentElement.clientWidth : container.clientWidth;
        const scale = base ? Math.min(1, available / base) : 1;
        container.style.setProperty('--calendar-scale', scale);
        if(calendarPopupOpen){
          positionCalendarPopup();
        }
      };
      if('ResizeObserver' in window && container){
        const ro = new ResizeObserver(adjustScale);
        ro.observe(container);
      }
      adjustScale();
      scroller.addEventListener('keydown', e=>{
        if(e.key==='Escape'){
          e.preventDefault();
          closeCalendarPopup();
          dateRangeInput?.focus({ preventScroll:true });
          return;
        }
        if(e.key==='ArrowLeft' || e.key==='ArrowRight'){
          const m = scroller.querySelector('.month') || scroller.querySelector('.month-item');
          const w = m ? m.offsetWidth : 0;
          scroller.scrollLeft += e.key==='ArrowLeft'?-w:w;
          e.preventDefault();
        }
      });
        addPassiveScrollListener(scroller, ()=>{
          const marker = scroller.querySelector('.today-marker');
          if(marker){
            const base = parseFloat(marker.dataset.pos || '0');
            marker.style.left = `${base + Math.round(scroller.scrollLeft)}px`;
          }
        });
      }
      setupCalendarScroll(calendarScroll);
      expiredWasOn = expiredToggle && expiredToggle.checked;

    function scrollCalendarToToday(behavior='auto'){
      const calScroll = $('#datePickerContainer');
      if(!calScroll) return;
      const todayCell = calScroll.querySelector('.day.today');
      if(todayCell){
        const month = todayCell.closest('.month');
        const left = month ? month.offsetLeft : 0;
        calScroll.dataset.todayScroll = left;
        calScroll.scrollTo({left, behavior});
        const marker = calScroll.querySelector('.today-marker');
        if(marker){
          const base = parseFloat(marker.dataset.pos || '0');
          marker.style.left = `${base + left}px`;
        }
      }
    }
    window.scrollCalendarToToday = scrollCalendarToToday;

    function formatDisplay(date){
      const wd = date.toLocaleDateString('en-GB',{weekday:'short'});
      const day = date.getDate();
      const mon = date.toLocaleDateString('en-GB',{month:'short'});
      let str = `${wd} ${day} ${mon}`;
      if(date.getFullYear() !== today.getFullYear()) str += `, ${date.getFullYear()}`;
      return str;
    }

    function orderedRange(){
      if(dateStart && dateEnd){
        return dateStart <= dateEnd ? {start:dateStart,end:dateEnd} : {start:dateEnd,end:dateStart};
      }
      return {start:dateStart,end:dateEnd};
    }

    function sameDay(a,b){ return a.toDateString()===b.toDateString(); }
    function isToday(d){ return sameDay(d,today); }

    function updateRangeClasses(){
      const {start,end} = orderedRange();
      $('#datePicker').querySelectorAll('.day').forEach(day=>{
        const iso = day.dataset.iso;
        if(!iso) return;
        const [yy, mm, dd] = iso.split('-').map(Number);
        const d = new Date(yy, mm - 1, dd);
        day.classList.remove('selected','in-range','range-start','range-end');
        if(start && sameDay(d, start)) day.classList.add('selected','range-start');
        if(end && sameDay(d, end)) day.classList.add('selected','range-end');
        if(start && end && d>start && d<end) day.classList.add('in-range');
      });
    }

    function updateInput(){
      const input = $('#daterange-textbox');
      const {start,end} = orderedRange();
      if(start && end){
        input.value = `${formatDisplay(start)} - ${formatDisplay(end)}`;
      } else if(start){
        input.value = formatDisplay(start);
      } else {
        input.value = '';
      }
      applyFilters();
      updateClearButtons();
    }

    function selectRangeDate(date){
      if(!dateStart || dateEnd){ dateStart = date; dateEnd = null; }
      else { dateEnd = date; }
      updateRangeClasses();
      updateInput();
      if(dateEnd){
        closeCalendarPopup();
      }
    }

    function buildFilterCalendar(minDate, maxDate){
      const container = $('#datePicker');
      container.innerHTML='';
      const cal = document.createElement('div');
      cal.className='calendar';
      let current = new Date(minDate.getFullYear(), minDate.getMonth(),1);
      const end = new Date(maxDate.getFullYear(), maxDate.getMonth(),1);
      const todayDate = new Date();
      todayDate.setHours(0,0,0,0);
      let monthIndex = 0;
      let currentMonthIndex = 0;
      while(current <= end){
        const monthEl = document.createElement('div');
        monthEl.className='month';
        const header = document.createElement('div');
        header.className='calendar-header';
        header.textContent=current.toLocaleDateString('en-GB',{month:'long',year:'numeric'});
        monthEl.appendChild(header);
        const grid = document.createElement('div');
        grid.className='grid';

        const weekdays=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        weekdays.forEach(wd=>{
          const w=document.createElement('div');
          w.className='weekday';
          w.textContent=wd;
          grid.appendChild(w);
        });

        const firstDay = new Date(current.getFullYear(), current.getMonth(),1);
        const startDow = firstDay.getDay();
        const daysInMonth = new Date(current.getFullYear(), current.getMonth()+1,0).getDate();
        const totalCells = 42;
        for(let i=0;i<totalCells;i++){
          const cell=document.createElement('div');
          cell.className='day';
          const dayNum=i-startDow+1;
          if(i<startDow || dayNum>daysInMonth){
            cell.classList.add('empty');
          }else{
            cell.textContent=dayNum;
            const date=new Date(current.getFullYear(), current.getMonth(), dayNum);
            cell.dataset.iso = toISODate(date);
            if(date < todayDate) cell.classList.add('past');
            else cell.classList.add('future');
            if(isToday(date)) cell.classList.add('today');
            if(date >= minDate) cell.addEventListener('click', ()=> selectRangeDate(date));
          }
          grid.appendChild(cell);
        }
        monthEl.appendChild(grid);
        cal.appendChild(monthEl);
        if(current.getFullYear() === todayDate.getFullYear() && current.getMonth() === todayDate.getMonth()){
          currentMonthIndex = monthIndex;
        }
        current.setMonth(current.getMonth()+1);
        monthIndex++;
      }
      container.appendChild(cal);
      updateRangeClasses();
      if(calendarScroll){
        const monthWidth = cal.querySelector('.month').offsetWidth;
        const scrollPos = monthWidth * currentMonthIndex;
        const maxScroll = calendarScroll.scrollWidth - calendarScroll.clientWidth;
        const track = calendarScroll.clientWidth - 20;
        const pos = maxScroll ? scrollPos / maxScroll * track + 10 : 10;
        calendarScroll.querySelector('.today-marker')?.remove();
        const marker = document.createElement('div');
        marker.className = 'today-marker';
        marker.dataset.pos = pos;
        calendarScroll.appendChild(marker);
        marker.addEventListener('click', ()=> scrollCalendarToToday('smooth'));
      }
    }

    buildFilterCalendar(today, maxPickerDate);
    closeCalendarPopup();

    $$('#filterPanel .keyword-clear-button, #filterPanel .daterange-clear-button').forEach(btn=> btn.addEventListener('click',()=>{
      const input = btn.parentElement.querySelector('input');
      if(input){
        if(input.id==='daterange-textbox'){
          dateStart = null;
          dateEnd = null;
          updateRangeClasses();
          updateInput();
        } else {
          input.value='';
        }
        input.focus();
        applyFilters();
        updateClearButtons();
      }
    }));
    if(expiredToggle){
      expiredToggle.addEventListener('change', ()=>{
        const input = $('#daterange-textbox');
        const todayDate = new Date();
        todayDate.setHours(0,0,0,0);
        dateStart = null;
        dateEnd = null;
        if(expiredToggle.checked){
          buildFilterCalendar(minPickerDate, maxPickerDate);
        } else {
          buildFilterCalendar(todayDate, maxPickerDate);
        }
        expiredWasOn = expiredToggle.checked;
        updateRangeClasses();
        updateInput();
        closeCalendarPopup();
      });
      if(expiredToggle.checked){
        expiredToggle.dispatchEvent(new Event('change'));
      }
    }
    updateClearButtons();
    updateResetBtn();
    const optionsBtn = $('#optionsBtn');
    const optionsMenu = $('#optionsMenu');
    const favToggle = $('#favToggle');
    const sortButtons = $$('.sort-option');

    function updateSortBtnLabel(text){
      const hasMultiple = optionsMenu.querySelectorAll('button').length > 1;
      if(hasMultiple){
        optionsBtn.innerHTML = `${text}<span class="results-arrow" aria-hidden="true"></span>`;
      } else {
        optionsBtn.textContent = text;
      }
    }

    updateSortBtnLabel(optionsBtn.textContent);

    favToggle.addEventListener('click', ()=>{
      favToTop = !favToTop;
      favSortDirty = favToTop ? false : true;
      favToggle.setAttribute('aria-pressed', favToTop);
      renderLists(filtered);
    });

    sortButtons.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        currentSort = btn.dataset.sort;
        sortButtons.forEach(b=> b.setAttribute('aria-pressed', b===btn ? 'true' : 'false'));
        updateSortBtnLabel(btn.textContent);
        renderLists(filtered);
      });
    });

    optionsBtn.addEventListener('click', e=>{
      e.stopPropagation();
      const open = !optionsMenu.hasAttribute('hidden');
      if(open){
        optionsMenu.setAttribute('hidden','');
        optionsBtn.setAttribute('aria-expanded','false');
      } else {
        optionsMenu.removeAttribute('hidden');
        optionsBtn.setAttribute('aria-expanded','true');
      }
    });
    optionsMenu.addEventListener('click', e=> e.stopPropagation());
      document.addEventListener('click', ()=>{
        optionsMenu.setAttribute('hidden','');
        optionsBtn.setAttribute('aria-expanded','false');
      });

      const recentsBoard = $('#recentsBoard');
      const adBoard = $('.ad-board');
      const boardsContainer = $('.post-mode-boards');
      const postBoard = $('.post-board');
      const recentsButton = $('#recents-button');
      const postsButton = $('#posts-button');
      const mapButton = $('#map-button');
      const boardDisplayCache = new WeakMap();
      let boardsInitialized = false;

      function getDefaultBoardDisplay(board){
        if(!board) return 'block';
        if(boardDisplayCache.has(board)) return boardDisplayCache.get(board);
        let value = '';
        try{
          value = getComputedStyle(board).display;
        }catch(err){ value = ''; }
        if(!value || value === 'none'){
          if(board.classList.contains('post-board')) value = 'flex';
          else if(board.classList.contains('ad-board')) value = 'block';
          else value = 'block';
        }
        boardDisplayCache.set(board, value);
        return value;
      }

      function clearBoardHide(board){
        if(!board) return;
        if(board._boardHideHandler){
          board.removeEventListener('transitionend', board._boardHideHandler);
          board._boardHideHandler = null;
        }
        if(board._boardHideTimer){
          clearTimeout(board._boardHideTimer);
          board._boardHideTimer = null;
        }
      }

      function showBoard(board, immediate=false){
        if(!board) return;
        clearBoardHide(board);
        const defaultDisplay = getDefaultBoardDisplay(board);
        board.style.display = defaultDisplay;
        board.setAttribute('aria-hidden','false');
        if(immediate){
          board.classList.add('panel-visible');
          board.style.transform = '';
        } else {
          const wasHidden = !board.classList.contains('panel-visible');
          schedulePanelEntrance(board, wasHidden);
        }
      }

      function hideBoard(board, immediate=false){
        if(!board) return;
        clearBoardHide(board);
        board.setAttribute('aria-hidden','true');
        const finalize = ()=>{
          board.style.display = 'none';
          board._boardHideHandler = null;
          board._boardHideTimer = null;
          try{
            board.style.removeProperty('transform');
          }catch(err){}
        };
        if(immediate){
          board.classList.remove('panel-visible');
          finalize();
          return;
        }
        if(!board.classList.contains('panel-visible')){
          finalize();
          return;
        }
        const handler = event=>{
          if(event && event.target !== board) return;
          board.removeEventListener('transitionend', handler);
          finalize();
        };
        board._boardHideHandler = handler;
        board.addEventListener('transitionend', handler);
        const removeVisible = ()=>{
          if(!board.isConnected){
            board.removeEventListener('transitionend', handler);
            finalize();
            return;
          }
          board.classList.remove('panel-visible');
        };
        if('requestAnimationFrame' in window){
          requestAnimationFrame(removeVisible);
        } else {
          removeVisible();
        }
        board._boardHideTimer = setTimeout(()=>{
          if(board._boardHideHandler){
            board._boardHideHandler();
          }
        }, 400);
      }

      function toggleBoard(board, shouldShow, immediate=false){
        if(shouldShow){
          showBoard(board, immediate);
        } else {
          hideBoard(board, immediate);
        }
      }

      function updateModeToggle(){
        const historyActive = document.body.classList.contains('show-history');
        const isPostsMode = document.body.classList.contains('mode-posts');
        const isMapMode = document.body.classList.contains('mode-map');
        if(recentsButton){
          recentsButton.setAttribute('aria-pressed', historyActive ? 'true' : 'false');
        }
        if(postsButton){
          postsButton.setAttribute('aria-pressed', !historyActive && isPostsMode ? 'true' : 'false');
        }
        if(mapButton){
          mapButton.setAttribute('aria-pressed', isMapMode ? 'true' : 'false');
        }
      }

      function adjustBoards(){
        const small = window.innerWidth < 1200;
        const historyActive = document.body.classList.contains('show-history');
        const isPostsMode = document.body.classList.contains('mode-posts');
        const filterPanel = document.getElementById('filterPanel');
        const filterContent = filterPanel ? filterPanel.querySelector('.panel-content') : null;
        const pinBtn = filterPanel ? filterPanel.querySelector('.pin-panel') : null;
        const filterPinned = !!(filterPanel && filterPanel.classList.contains('show') && pinBtn && pinBtn.getAttribute('aria-pressed') === 'true');
        const historyOpenPost = recentsBoard ? recentsBoard.querySelector('.open-post') : null;
        const postsOpenPost = postBoard ? postBoard.querySelector('.open-post') : null;
        const anyOpenPost = historyOpenPost || postsOpenPost;
        const gap = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--gap')) || 10;
        let filterWidth = filterPinned && filterContent ? filterContent.getBoundingClientRect().width : 0;
        const postWidth = postBoard ? (postBoard.offsetWidth || 530) : 0;
        const historyWidth = recentsBoard ? (recentsBoard.offsetWidth || 530) : 0;
        const boardsWidths = [];
        if(historyActive && recentsBoard){
          boardsWidths.push(historyWidth);
        } else if(postBoard){
          boardsWidths.push(postWidth);
        }
        let totalBoardsWidth = boardsWidths.reduce((sum, w)=> sum + w, 0);
        if(boardsWidths.length > 1){
          totalBoardsWidth += gap * (boardsWidths.length - 1);
        }
        const adWidth = adBoard ? (adBoard.offsetWidth || 440) : 0;
        const shouldShowAds = adBoard && window.innerWidth >= 1900;
        let hideAds = !shouldShowAds || !isPostsMode;
        let requiredWidth = totalBoardsWidth;
        if(filterPinned && filterWidth){
          requiredWidth += filterWidth;
        } else {
          filterWidth = 0;
        }
        if(shouldShowAds && adWidth){
          requiredWidth += adWidth + gap;
        }
        const canAnchor = filterPinned && filterWidth && requiredWidth <= window.innerWidth;
        document.body.classList.toggle('filter-anchored', canAnchor);
        document.documentElement.style.setProperty('--filter-panel-offset', canAnchor ? `${filterWidth}px` : '0px');
        boardsContainer.style.justifyContent = 'flex-start';
        const skipAnimation = !boardsInitialized;
        toggleBoard(recentsBoard, isPostsMode && historyActive, skipAnimation);
        toggleBoard(postBoard, isPostsMode && !historyActive, skipAnimation);
        document.body.classList.toggle('detail-open', !!anyOpenPost);
        if(adBoard){
          toggleBoard(adBoard, isPostsMode && !hideAds && shouldShowAds, skipAnimation);
        }
        document.body.classList.toggle('hide-ads', hideAds);
        updateModeToggle();
        boardsInitialized = true;
      }
      window.adjustBoards = adjustBoards;
      adjustBoards();
      window.addEventListener('resize', adjustBoards);
      window.adjustListHeight();
        setTimeout(()=>{
          if(map && typeof map.resize === 'function'){
            map.resize();
            updatePostPanel();
            applyFilters();
          }
        }, 0);

      recentsButton && recentsButton.addEventListener('click', ()=>{
        const isPostsMode = document.body.classList.contains('mode-posts');
        const historyActive = document.body.classList.contains('show-history');
        if(isPostsMode && historyActive){
          setMode('map');
          return;
        }
        setMode('posts');
        document.body.classList.add('show-history');
        renderHistoryBoard();
        adjustBoards();
        setTimeout(()=>{
          if(map && typeof map.resize === 'function'){
            map.resize();
            updatePostPanel();
          }
        }, 300);
        updateModeToggle();
      });

      postsButton && postsButton.addEventListener('click', ()=>{
        const historyActive = document.body.classList.contains('show-history');
        const isPostsMode = document.body.classList.contains('mode-posts');
        if(isPostsMode && !historyActive){
          setMode('map');
          return;
        }
        document.body.classList.remove('show-history');
        if(!isPostsMode || historyActive){
          setMode('posts');
          setTimeout(()=>{
            if(map && typeof map.resize === 'function'){
              map.resize();
              updatePostPanel();
            }
          }, 0);
        } else {
          updateModeToggle();
        }
      });

      mapButton && mapButton.addEventListener('click', ()=>{
        const isMapMode = document.body.classList.contains('mode-map');
        if(!isMapMode){
          setMode('map');
        } else if(document.body.classList.contains('show-history')){
          document.body.classList.remove('show-history');
          adjustBoards();
          updateModeToggle();
        }
      });

    function buildDetail(p){
      const wrap = document.createElement('div');
      wrap.className = 'open-post';
      wrap.dataset.id = p.id;
      const loc0 = p.locations[0];
      const dsorted = loc0.dates.slice().sort((a,b)=> a.full.localeCompare(b.full));
      const defaultInfo = `💲 ${loc0.price} | 📅 ${dsorted[0].date} - ${dsorted[dsorted.length-1].date}<span style="display:inline-block;margin-left:10px;">(Select Session)</span>`;
      const thumbSrc = imgThumb(p);
      const headerInner = `
          <div class="title-block">
            <div class="title">${p.title}</div>
            <div class="cat-line"><span class="sub-icon">${subcategoryIcons[p.subcategory]||''}</span> ${p.category} &gt; ${p.subcategory}</div>
          </div>
          <button class="share" aria-label="Share post">
            <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.06-.23.09-.46.09-.7s-.03-.47-.09-.7l7.13-4.17A2.99 2.99 0 0 0 18 9a3 3 0 1 0-3-3c0 .24.03.47.09.7L7.96 10.87A3.003 3.003 0 0 0 6 10a3 3 0 1 0 3 3c0-.24-.03-.47-.09-.7l7.13 4.17c.53-.5 1.23-.81 1.96-.81a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/></svg>
          </button>
          <button class="fav" aria-pressed="${p.fav?'true':'false'}" aria-label="Toggle favourite">
            <svg viewBox="0 0 24 24"><path d="M12 17.3 6.2 21l1.6-6.7L2 9.3l6.9-.6L12 2l3.1 6.7 6.9.6-5.8 4.9L17.8 21 12 17.3z"/></svg>
          </button>
        `;
      const posterName = p.member ? p.member.username : 'Anonymous';
      const postedTime = formatPostTimestamp(p.created);
      const postedMeta = postedTime ? `Posted by ${posterName} · ${postedTime}` : `Posted by ${posterName}`;
      wrap.innerHTML = `
        <div class="post-header">
          ${headerInner}
        </div>
        <div class="post-body">
          <div class="second-post-column">
            <div class="post-details">
              <div class="post-venue-selection-container"></div>
              <div class="post-session-selection-container"></div>
              <div class="location-section">
                <div id="venue-${p.id}" class="venue-dropdown options-dropdown"><button class="venue-btn" aria-haspopup="true" aria-expanded="false"><span class="venue-name">${p.locations[0].venue}</span><span class="venue-address">${p.locations[0].address}</span></button><div class="venue-menu post-venue-menu" hidden><div class="map-container"><div id="map-${p.id}" class="post-map"></div></div><div class="venue-options">${p.locations.map((loc,i)=>`<button data-index="${i}"><span class="venue-name">${loc.venue}</span><span class="venue-address">${loc.address}</span></button>`).join('')}</div></div></div>
                <div id="sess-${p.id}" class="session-dropdown options-dropdown"><button class="sess-btn" aria-haspopup="true" aria-expanded="false">Select Session</button><div class="session-menu options-menu" hidden><div class="calendar-container"><div class="calendar-scroll"><div id="cal-${p.id}" class="post-calendar"></div></div></div><div class="session-options"></div></div></div>
              </div>
              <div class="post-details-info-container">
                <div id="venue-info-${p.id}" class="venue-info"></div>
                <div id="session-info-${p.id}" class="session-info">
                  <div>${defaultInfo}</div>
                </div>
              </div>
              <div class="post-details-description-container">
                <div class="desc-wrap"><div class="desc" tabindex="0" aria-expanded="false">${p.desc}</div></div>
                <div class="member-avatar-row"><img src="${memberAvatarUrl(p)}" alt="${posterName} avatar" width="50" height="50"/><span>${postedMeta}</span></div>
              </div>
            </div>
            <div class="post-images">
              <div class="image-box"><div class="image-track"><img id="hero-img" class="lqip" src="${thumbSrc}" data-full="${heroUrl(p)}" alt="" loading="eager" fetchpriority="high" referrerpolicy="no-referrer" onerror="this.onerror=null; this.src='${thumbSrc}';"/></div></div>
              <div class="thumbnail-row"></div>
            </div>
          </div>
        </div>`;
      wrap.querySelectorAll('.post-header').forEach(head => {
        head.style.background = CARD_SURFACE;
      });
      wrap.style.background = CARD_SURFACE;
        // progressive hero swap
        (function(){
          const img = wrap.querySelector('#hero-img');
          if(img){
            const full = img.getAttribute('data-full');
            const hi = new Image();
            hi.referrerPolicy = 'no-referrer';
            hi.fetchPriority = 'high';
            hi.onload = ()=>{
              const swap = ()=>{ img.src = full; img.classList.remove('lqip'); img.classList.add('ready'); };
              if(hi.decode){ hi.decode().then(swap).catch(swap); } else { swap(); }
            };
            hi.onerror = ()=>{};
            hi.src = full;
          }
        })();
        return wrap;
    }

      async function openPost(id, fromHistory=false, fromMap=false, originEl=null){
        lockMap(false);
        touchMarker = null;
        if(hoverPopup){
          let shouldRemovePopup = true;
          if(fromMap && typeof popupIsHovered === 'function'){
            try{
              if(popupIsHovered(hoverPopup)){
                shouldRemovePopup = false;
              }
            }catch(err){
              shouldRemovePopup = true;
            }
          }
          if(shouldRemovePopup){
            try{ hoverPopup.remove(); }catch(err){}
            hoverPopup = null;
          }
        }
        spinEnabled = false;
        localStorage.setItem('spinGlobe', 'false');
        stopSpin();
        const p = posts.find(x=>x.id===id); if(!p) return;
        activePostId = id;
        selectedVenueKey = null;
        updateSelectedMarkerRing();

        if(!fromHistory){
          if(document.body.classList.contains('show-history')){
            document.body.classList.remove('show-history');
            adjustBoards();
            updateModeToggle();
          }
          if(mode !== 'posts'){
            setMode('posts', true);
            await nextFrame();
          }
        }
        $$('.recents-card[aria-selected="true"], .post-card[aria-selected="true"]').forEach(el=>el.removeAttribute('aria-selected'));
        $$('.mapboxgl-popup.map-card .map-card[aria-selected="true"]').forEach(el=>el.removeAttribute('aria-selected'));

        const container = fromHistory ? document.getElementById('recentsBoard') : postsWideEl;
        if(!container) return;

        if(!container.children.length && !fromHistory){
          const initialCard = card(p, true);
          placeOpenPost(initialCard);
        }

        const alreadyOpen = container.querySelector(`.open-post[data-id="${id}"]`);
        if(alreadyOpen){
          return;
        }

        if(originEl && !container.contains(originEl)){
          originEl = null;
        }
        let target = originEl || container.querySelector(`[data-id="${id}"]`);

        (function(){
          const ex = container.querySelector('.open-post');
          if(ex){
            const seenDetailMaps = new Set();
            const cleanupDetailMap = node=>{
              if(!node || !node._detailMap) return;
              const ref = node._detailMap;
              if(!seenDetailMaps.has(ref)){
                if(ref.resizeHandler){
                  window.removeEventListener('resize', ref.resizeHandler);
                }
                if(ref.map && typeof ref.map.remove === 'function'){
                  ref.map.remove();
                }
                seenDetailMaps.add(ref);
              }
              if(ref){
                ref.map = null;
                ref.resizeHandler = null;
              }
              if(node && node.__map){
                node.__map = null;
              }
              delete node._detailMap;
            };
            cleanupDetailMap(ex);
            const mapNode = ex.querySelector('.post-map');
            if(mapNode){
              cleanupDetailMap(mapNode);
            }
            const exId = ex.dataset && ex.dataset.id;
            const prev = posts.find(x=> x.id===exId);
            if(prev){ ex.replaceWith(card(prev, fromHistory ? false : true)); } else { ex.remove(); }
          }
        })();

        if(originEl && !container.contains(originEl)){
          originEl = null;
        }
        target = originEl || container.querySelector(`[data-id="${id}"]`);

        const pointerEvt = window.__lastPointerDown;
        let pointerTarget = null;
        if(pointerEvt && pointerEvt.target instanceof Element){
          let consider = true;
          if(typeof pointerEvt.timeStamp === 'number'){
            const nowTs = (typeof performance !== 'undefined' && typeof performance.now === 'function') ? performance.now() : Date.now();
            const evtTs = pointerEvt.timeStamp;
            if(typeof evtTs === 'number'){
              const diff = nowTs - evtTs;
              if(Number.isFinite(diff) && (diff > 2000 || diff < -2000)){
                consider = false;
              }
            }
          }
          if(consider){
            pointerTarget = pointerEvt.target;
          }
        }
        const pointerCard = pointerTarget ? pointerTarget.closest('.post-card, .recents-card') : null;
        const pointerInsideCardContainer = pointerCard && container.contains(pointerCard);
        const pointerInAdBoard = pointerTarget ? pointerTarget.closest('.ad-board, .ad-panel') : null;
        const shouldAlignToTop = fromMap || (!!pointerInAdBoard && !pointerInsideCardContainer) || pointerInsideCardContainer;

        if(!target){
          target = card(p, fromHistory ? false : true);
          placeOpenPost(target);
        } else if(shouldAlignToTop && container.contains(target) && !pointerInsideCardContainer){
          const firstCard = container.querySelector('.open-post, .post-card, .recents-card');
          if(firstCard && firstCard !== target){
            container.insertBefore(target, firstCard);
          } else if(!firstCard){
            container.prepend(target);
          }
        }
        const resCard = resultsEl ? resultsEl.querySelector(`[data-id="${id}"]`) : null;
        if(resCard){
          resCard.setAttribute('aria-selected','true');
          if(fromMap){
            const qb = resCard.closest('.quick-list-board');
            if(qb){
              // intentionally skipping automatic scrolling
            }
          }
        }
        const mapCard = document.querySelector('.mapboxgl-popup.map-card .map-card');
        if(mapCard) mapCard.setAttribute('aria-selected','true');

        const detail = buildDetail(p);
        target.replaceWith(detail);
        hookDetailActions(detail, p);
        if (typeof updateStickyImages === 'function') {
          updateStickyImages();
        }
        if (typeof initPostLayout === 'function') {
          initPostLayout(container);
          if (typeof updateStickyImages === 'function') {
            updateStickyImages();
          }
        }

        await nextFrame();

        if(fromMap){
          if(typeof window.adjustBoards === 'function'){
            window.adjustBoards();
          }
          if(typeof window.adjustListHeight === 'function'){
            window.adjustListHeight();
          }
        }

        const header = detail.querySelector('.post-header');
        if(header){
          const h = header.offsetHeight;
          header.style.scrollMarginTop = h + 'px';
        }

        if(shouldAlignToTop && container && container.contains(detail)){
          requestAnimationFrame(() => {
            const containerRect = container.getBoundingClientRect();
            const detailRect = detail.getBoundingClientRect();
            if(!containerRect || !detailRect) return;
            const topTarget = container.scrollTop + (detailRect.top - containerRect.top);
            if(typeof container.scrollTo === 'function'){
              container.scrollTo({ top: Math.max(0, topTarget), behavior: 'smooth' });
            } else {
              container.scrollTop = Math.max(0, topTarget);
            }
          });
        }

        // Update history on open (keep newest-first)
        viewHistory = viewHistory.filter(x=>x.id!==id);
        viewHistory.unshift({id:p.id, title:p.title, url:postUrl(p), lastOpened: Date.now()});
        if(viewHistory.length>100) viewHistory.length=100;
        saveHistory();
        if(!fromHistory){
          renderHistoryBoard();
        }
      }

      function closeActivePost(){
        const openEl = document.querySelector('.post-board .open-post, #recentsBoard .open-post');
        if(!openEl){
          document.body.classList.remove('detail-open');
          if(typeof initPostLayout === 'function') initPostLayout(postsWideEl);
          if(typeof window.adjustBoards === 'function') window.adjustBoards();
          return;
        }
        const openBody = openEl.querySelector('.post-body');
        if(openBody){
          openBody.style.removeProperty('--second-post-height');
          openBody.style.removeProperty('min-height');
          if(openBody.dataset) delete openBody.dataset.secondPostHeight;
        }
        const container = openEl.closest('.post-board, #recentsBoard') || postsWideEl;
        const isHistory = container && container.id === 'recentsBoard';
        const id = openEl.dataset ? openEl.dataset.id : null;
        const post = id ? posts.find(x => x.id === id) : null;
        const detachedColumn = document.querySelector('.post-mode-boards > .second-post-column');
        if(detachedColumn){
          detachedColumn.classList.remove('is-visible');
          if(detachedColumn.dataset) delete detachedColumn.dataset.openPostId;
          detachedColumn.remove();
        }
        document.body.classList.remove('detail-open');
        $$('.recents-card[aria-selected="true"], .post-card[aria-selected="true"]').forEach(el=> el.removeAttribute('aria-selected'));
        if(post){
          const replacement = card(post, !isHistory);
          openEl.replaceWith(replacement);
        } else {
          openEl.remove();
        }
        activePostId = null;
        selectedVenueKey = null;
        updateSelectedMarkerRing();
        if(typeof initPostLayout === 'function') initPostLayout(postsWideEl);
        if(typeof updateStickyImages === 'function') updateStickyImages();
        if(typeof window.adjustBoards === 'function') window.adjustBoards();
      }

      window.openPost = openPost;
      if(typeof window.__wrapForInputYield === 'function'){
        window.__wrapForInputYield('openPost');
      }

      const resLists = $$('.recents-board');
      resLists.forEach(list=>{
          list.addEventListener('click', (e)=>{
            if(e.target.closest('.fav')) return;
            const cardEl = e.target.closest('.recents-card');
            if(!cardEl) return;
            e.preventDefault();
            const id = cardEl.getAttribute('data-id');
            if(!id) return;
            callWhenDefined('openPost', (fn)=>{
              requestAnimationFrame(() => {
                try{
                  stopSpin();
                  fn(id, true, false, cardEl);
                }catch(err){ console.error(err); }
              });
            });
          }, { capture: true });
        });

      const postsWide = $('.post-board');
      if(postsWide){
        postsWide.addEventListener('click', e=>{
          if(e.target.closest('.fav')) return;
          const cardEl = e.target.closest('.post-card');
          if(cardEl){
            const id = cardEl.getAttribute('data-id');
            if(id){
              e.preventDefault();
              callWhenDefined('openPost', (fn)=>{
                requestAnimationFrame(() => {
                  try{
                    stopSpin();
                    fn(id, false, false, cardEl);
                  }catch(err){ console.error(err); }
                });
              });
            }
            return;
          }
          if(e.target === postsWide && postsWide.querySelector('.open-post')){
            setTimeout(()=> setMode('map'), 0);
          }
        }, { capture:true });
      }

      recentsBoard && recentsBoard.addEventListener('click', e=>{
        if(e.target === recentsBoard){
          setMode('map');
        }
      });

      function setMode(m, skipFilters = false){
        mode = m;
        document.body.classList.remove('mode-map','mode-posts','hide-posts-ui');
        document.body.classList.add('mode-'+m);
        if(m==='map'){
          document.body.classList.remove('show-history');
        }
        const shouldAdjustListHeight = m === 'posts' && typeof window.adjustListHeight === 'function';
        adjustBoards();
        if(shouldAdjustListHeight){
          window.adjustListHeight();
        }
        updateModeToggle();
        if(m === 'posts'){
          const boardEl = document.querySelector('.post-board');
          if(boardEl){
            boardEl.style.width = '';
          }
          if(window.adjust){
            window.adjust();
          }
        }
        if(map){
          if(typeof map.resize === 'function'){
            map.resize();
          }
          updatePostPanel();
        }
        if(m==='posts'){
          spinEnabled = false;
          localStorage.setItem('spinGlobe','false');
          stopSpin();
        }
        if(!skipFilters) applyFilters();
      }
    window.setMode = setMode;

    // Mapbox
    function loadMapbox(cb){
      const mapboxVerRaw = window.MAPBOX_VERSION || 'v3.15.0';
      const mapboxVer = mapboxVerRaw.startsWith('v') ? mapboxVerRaw : `v${mapboxVerRaw}`;
      const mapboxVerNoV = mapboxVer.replace(/^v/, '');
      const cssSources = [
        {
          selector: 'link[href*="mapbox-gl.css"], link[href*="mapbox-gl@"], style[data-mapbox]',
          primary: `https://api.mapbox.com/mapbox-gl-js/${mapboxVer}/mapbox-gl.css`,
          fallback: `https://unpkg.com/mapbox-gl@${mapboxVerNoV}/dist/mapbox-gl.css`
        },
        {
          selector: 'link[href*="mapbox-gl-geocoder.css"], link[href*="mapbox-gl-geocoder@"]',
          primary: 'https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css',
          fallback: 'https://unpkg.com/@mapbox/mapbox-gl-geocoder@5.0.0/dist/mapbox-gl-geocoder.css'
        }
      ];

      const finalize = (()=>{
        let called = false;
        return ()=>{
          if(called) return;
          called = true;
          Promise.resolve(ensureMapboxCssFor(document.body))
            .catch(()=>{})
            .finally(()=>{ try{ cb && cb(); }catch(err){ console.error(err); } });
        };
      })();

      function monitorLink(link, onReady, fallbackUrl){
        if(!link || (link.tagName && link.tagName.toLowerCase() === 'style')){
          onReady();
          return;
        }
        if(fallbackUrl && link.dataset && !link.dataset.fallback){
          link.dataset.fallback = fallbackUrl;
        }

        let settled = false;

        function cleanup(){
          link.removeEventListener('load', handleLoad);
          link.removeEventListener('error', handleError);
        }

        function finalize(){
          if(settled){
            return;
          }
          settled = true;
          cleanup();
          onReady();
        }

        function handleLoad(){
          finalize();
        }

        function handleError(){
          const attempts = link.dataset && link.dataset.fallbackErrors ? Number(link.dataset.fallbackErrors) : 0;
          const nextAttempts = (Number.isNaN(attempts) ? 0 : attempts) + 1;
          if(link.dataset){
            link.dataset.fallbackErrors = String(nextAttempts);
          }
          const fallback = link.dataset ? link.dataset.fallback : fallbackUrl;
          if(fallback && link.href !== fallback){
            link.href = fallback;
            return;
          }
          if(fallback && nextAttempts === 1){
            return;
          }
          finalize();
        }

        function needsListeners(){
          if(!link.sheet){
            return true;
          }
          try {
            void link.sheet.cssRules;
            return false;
          } catch(err){
            if(err && (err.name === 'SecurityError' || err.code === 18)){
              return false;
            }
            return true;
          }
        }

        if(needsListeners()){
          link.addEventListener('load', handleLoad, {once:true});
          link.addEventListener('error', handleError);
        } else {
          finalize();
        }
      }

      function ensureCss(index, onReady){
        const {selector, primary, fallback} = cssSources[index];
        const selectors = selector.split(',').map(s => s.trim());
        for(const sel of selectors){
          const candidate = document.querySelector(sel);
          if(candidate){
            if(candidate.tagName && candidate.tagName.toLowerCase() === 'style'){
              onReady();
              return;
            }
            monitorLink(candidate, onReady, fallback);
            return;
          }
        }
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = primary;
        monitorLink(link, onReady, fallback);
        document.head.appendChild(link);
      }

      if(window.mapboxgl && window.MapboxGeocoder){
        let pending = cssSources.length;
        if(pending === 0){
          finalize();
          return;
        }
        const done = () => {
          if(--pending === 0){
            finalize();
          }
        };
        cssSources.forEach((_, i) => ensureCss(i, done));
        return;
      }

      let cssLoaded = 0;
      const onCss = () => {
        cssLoaded++;
        if(cssLoaded === cssSources.length){
          loadScripts();
        }
      };
      cssSources.forEach((_, i) => ensureCss(i, onCss));

      function loadScripts(){
        const done = (()=>{
          let called = false;
          return ()=>{
            if(called) return;
            called = true;
            finalize();
          };
        })();

        const loadGeocoder = ()=>{
          const g = document.createElement('script');
          g.src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js';
          g.onload = done;
          g.onerror = ()=>{
            const gf = document.createElement('script');
            gf.src='https://unpkg.com/@mapbox/mapbox-gl-geocoder@5.0.0/dist/mapbox-gl-geocoder.min.js';
            gf.onload = done;
            gf.onerror = done;
            document.head.appendChild(gf);
          };
          document.head.appendChild(g);
        };

        const s = document.createElement('script');
        s.src=`https://api.mapbox.com/mapbox-gl-js/${mapboxVer}/mapbox-gl.js`;
        s.onload = loadGeocoder;
        s.onerror = ()=>{
          const sf = document.createElement('script');
          sf.src=`https://unpkg.com/mapbox-gl@${mapboxVerNoV}/dist/mapbox-gl.js`;
          sf.onload = loadGeocoder;
          sf.onerror = done;
          document.head.appendChild(sf);
        };
        document.head.appendChild(s);
      }
    }
    loadMapbox(initMap);

    function addControls(){
      if(typeof MapboxGeocoder === 'undefined'){
        const script = document.createElement('script');
        script.src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js';
        script.onload = addControls;
    script.onerror = ()=> console.error('Mapbox Geocoder failed to load');
    document.head.appendChild(script);
    return;
  }
  const cssLink = document.querySelector('style[data-mapbox], link[href*="mapbox-gl.css"], link[href*="mapbox-gl@"]');
  if(!cssLink || !cssLink.sheet){
    setTimeout(addControls, 50);
    return;
  }
    const sets = [
      {geo:'#geocoder-welcome', locate:'#geolocate-welcome', compass:'#compass-welcome'},
      {geo:'#geocoder-map', locate:'#geolocate-map', compass:'#compass-map'},
      {geo:'#geocoder-filter', locate:'#geolocate-filter', compass:'#compass-filter'},
      {geo:'#geocoder-member', locate:'#geolocate-member', compass:'#compass-member'}
        ];
      const logoLoader = (window.__logoLoading && typeof window.__logoLoading === 'object') ? window.__logoLoading : null;
      const cityZoomLevel = 12;
      sets.forEach((sel, idx)=>{
        const gc = new MapboxGeocoder({
          accessToken: mapboxgl.accessToken,
          mapboxgl,
          marker:false,
          placeholder:'Location',
          reverseGeocode:true,
          collapsed:false
        });
        gc.on('result', (e)=>{
          spinEnabled = false;
          localStorage.setItem('spinGlobe','false');
          stopSpin();
          if(mode!=='map') setMode('map');
          gc.clear();
        });
        const gEl = document.querySelector(sel.geo);
        if(gEl){
          gEl.appendChild(gc.onAdd(map));
          const input = gEl.querySelector('input[type="text"]');
          if(input){
            input.setAttribute('autocomplete','street-address');
            gc._inputReference = input;
          }
          const container = gEl.querySelector('.mapboxgl-ctrl-geocoder');
          if(container) gc._container = container;
        }
        geocoders.push(gc);
        if(idx===1) geocoder = gc;
        const geolocate = new mapboxgl.GeolocateControl({
          positionOptions:{ enableHighAccuracy:true },
          trackUserLocation:false,
          fitBoundsOptions:{ maxZoom: cityZoomLevel }
        });
        let geolocateLogoPending = 0;
        const startGeolocateLoading = () => {
          if(logoLoader && typeof logoLoader.begin === 'function' && geolocateLogoPending === 0){
            try{ logoLoader.begin(); }catch(err){}
            geolocateLogoPending = 1;
          }
        };
        const stopGeolocateLoading = () => {
          if(geolocateLogoPending > 0 && logoLoader && typeof logoLoader.end === 'function'){
            geolocateLogoPending = 0;
            try{ logoLoader.end(); }catch(err){}
          }
        };
        if(geolocate && typeof geolocate.trigger === 'function' && !geolocate.__logoLoadingWrapped){
          const originalTrigger = geolocate.trigger.bind(geolocate);
          geolocate.trigger = function(...args){
            try{ startGeolocateLoading(); }catch(err){}
            return originalTrigger(...args);
          };
          geolocate.__logoLoadingWrapped = true;
        }
        geolocate.on('trackuserlocationstart', () => { startGeolocateLoading(); });
        geolocate.on('geolocate', (event)=>{
          stopGeolocateLoading();
          spinEnabled = false; localStorage.setItem('spinGlobe','false'); stopSpin();
          if(mode!=='map') setMode('map');
          if(map && typeof map.easeTo === 'function' && event && event.coords){
            let targetZoom = cityZoomLevel;
            if(typeof map.getMaxZoom === 'function'){
              try{
                const maxZoom = map.getMaxZoom();
                if(typeof maxZoom === 'number' && maxZoom < targetZoom){
                  targetZoom = maxZoom;
                }
              }catch(err){}
            }
            const currentZoom = (typeof map.getZoom === 'function') ? map.getZoom() : null;
            const needsZoomAdjust = typeof currentZoom !== 'number' || currentZoom > targetZoom + 0.05;
            const center = [event.coords.longitude, event.coords.latitude];
            if(needsZoomAdjust){
              try{
                map.easeTo({ center, zoom: targetZoom, duration: 800, essential: true });
              }catch(err){}
            }
          }
        });
        geolocate.on('error', stopGeolocateLoading);
        geolocate.on('trackuserlocationend', stopGeolocateLoading);
        geolocate.on('outofmaxbounds', stopGeolocateLoading);
        const geoHolder = document.querySelector(sel.locate);
        if(geoHolder){
          const controlEl = geolocate.onAdd(map);
          geoHolder.appendChild(controlEl);
          const geoButton = controlEl && controlEl.querySelector ? controlEl.querySelector('button') : null;
          if(geoButton && !geoButton.dataset.logoSpinBound){
            const triggerLoading = (ev) => {
              if(ev && ev.type === 'keydown'){
                const key = ev.key || ev.code;
                if(key !== 'Enter' && key !== ' ' && key !== 'Space' && key !== 'Spacebar'){
                  return;
                }
              }
              startGeolocateLoading();
            };
            geoButton.addEventListener('pointerdown', triggerLoading);
            geoButton.addEventListener('mousedown', triggerLoading);
            geoButton.addEventListener('touchstart', triggerLoading);
            geoButton.addEventListener('keydown', triggerLoading);
            geoButton.addEventListener('click', triggerLoading);
            geoButton.dataset.logoSpinBound = 'true';
          }
        }
        const nav = new mapboxgl.NavigationControl({showZoom:false, visualizePitch:true});
        const compassHolder = document.querySelector(sel.compass);
        if(compassHolder) compassHolder.appendChild(nav.onAdd(map));
      });
    }

    async function initMap(){
      if(typeof mapboxgl === 'undefined'){
        console.error('Mapbox GL failed to load');
        return;
      }
      try{
        await ensureMapboxCssFor(document.body);
      }catch(err){}
          mapboxgl.accessToken = MAPBOX_TOKEN;
        if(typeof mapboxgl.setLogLevel === 'function'){
          mapboxgl.setLogLevel('error');
        }
        map = new mapboxgl.Map({
          container:'map',
          style:'mapbox://styles/mapbox/standard',
          projection:'globe',
          center: startCenter,
          zoom: startZoom,
          pitch: startPitch,
          bearing: startBearing,
          attributionControl:true
        });
        const zoomIndicatorEl = document.getElementById('mapZoomIndicator');
        const updateZoomIndicator = () => {
          if(!map || !zoomIndicatorEl || typeof map.getZoom !== 'function') return;
          try{
            const zoomLevel = map.getZoom();
            if(Number.isFinite(zoomLevel)){
              zoomIndicatorEl.textContent = `Zoom ${zoomLevel.toFixed(2)}`;
            }
          }catch(err){}
        };
        if(zoomIndicatorEl){
          map.on('zoom', updateZoomIndicator);
          map.on('zoomend', updateZoomIndicator);
          map.once('load', updateZoomIndicator);
          updateZoomIndicator();
        }
// === Pill hooks (safe) ===
try { if (typeof __addOrReplacePill150x40 === 'function') __addOrReplacePill150x40(map); } catch(e){}
if (!map.__pillHooksInstalled) {
  try { map.on('style.load', () => __addOrReplacePill150x40(map)); } catch(e){}
  try { map.on('styleimagemissing', (evt) => { if (evt && evt.id === 'marker-label-bg') __addOrReplacePill150x40(map); }); } catch(e){}
  map.__pillHooksInstalled = true;
}
        const ensureMissingStyleImage = (evt) => {
          if(!evt || !evt.id) return;
          const placeholders = ['mx-federal-5','background','background-stroke','icon','icon-stroke'];
          if(!placeholders.includes(evt.id)) return;
          try{
            if(map.hasImage?.(evt.id)) return;
            map.addImage(evt.id, createTransparentPlaceholder(4), { pixelRatio: 1 });
          }catch(err){}
        };
        try{ map.on('styleimagemissing', ensureMissingStyleImage); }catch(err){}

        const ensureCompositeOnStyleMissing = (evt) => {
          if(!evt || !evt.id) return;
          if(evt.id.startsWith(MARKER_LABEL_COMPOSITE_PREFIX)){
            const spriteId = evt.id.slice(MARKER_LABEL_COMPOSITE_PREFIX.length);
            const meta = markerLabelCompositeStore.get(spriteId) || {};
            try{
              ensureMarkerLabelComposite(map, spriteId, meta.iconId, meta.labelLine1, meta.labelLine2, meta.isMulti);
            }catch(err){}
          }
        };
        if(!map.__compositeStyleHookInstalled){
          try{ map.on('styleimagemissing', ensureCompositeOnStyleMissing); }catch(err){}
          map.__compositeStyleHookInstalled = true;
        }

        try{ map.on('style.load', () => { try{ reapplyMarkerLabelComposites(map); }catch(err){} }); }catch(err){}

        const applyStyleAdjustments = () => {
          applyNightSky(map);
          patchMapboxStyleArtifacts(map);
        };
        whenStyleReady(map, applyStyleAdjustments);
        map.on('style.load', applyStyleAdjustments);
        map.on('styledata', () => {
          if(map.isStyleLoaded && map.isStyleLoaded()){
            patchMapboxStyleArtifacts(map);
          }
        });
        ensureMapIcon = attachIconLoader(map);
        const mapLoading = (() => {
          const loader = window.__logoLoading;
          if(!loader || typeof loader.begin !== 'function' || typeof loader.end !== 'function'){
            return null;
          }
          const motionTokens = new Set();
          let tilesPending = false;
          let active = false;

          const isMapMovingNow = () => {
            if(!map) return false;
            try{
              if(typeof map.isMoving === 'function' && map.isMoving()) return true;
              if(typeof map.isZooming === 'function' && map.isZooming()) return true;
              if(typeof map.isRotating === 'function' && map.isRotating()) return true;
              if(typeof map.isEasing === 'function' && map.isEasing()) return true;
            }catch(err){}
            return false;
          };

          const apply = (forceStop = false) => {
            const busy = !forceStop && (tilesPending || motionTokens.size > 0 || isMapMovingNow());
            if(busy){
              if(!active){
                active = true;
                try{ loader.begin('map'); }catch(err){}
              }
            } else if(active){
              active = false;
              try{ loader.end('map'); }catch(err){}
            }
          };

          return {
            apply,
            setTiles(pending){
              if(tilesPending === pending) return;
              tilesPending = pending;
              apply();
            },
            addMotion(token){
              if(motionTokens.has(token)) return;
              motionTokens.add(token);
              apply();
            },
            removeMotion(token){
              if(!motionTokens.has(token)) return;
              motionTokens.delete(token);
              apply();
            },
            clearAll(){
              motionTokens.clear();
              tilesPending = false;
              apply(true);
            }
          };
        })();

        if(mapLoading){
          const updateRenderState = () => {
            let tileBusy = false;
            if(map){
              try{
                if(typeof map.isStyleLoaded === 'function' && !map.isStyleLoaded()){
                  tileBusy = true;
                } else if(typeof map.areTilesLoaded === 'function'){
                  tileBusy = !map.areTilesLoaded();
                }
              }catch(err){
                tileBusy = true;
              }
            }
            mapLoading.setTiles(tileBusy);
            mapLoading.apply();
          };

          map.on('sourcedataloading', () => mapLoading.setTiles(true));
          map.on('render', updateRenderState);
          map.on('idle', () => {
            mapLoading.setTiles(false);
            mapLoading.apply();
          });

          ['move','zoom','rotate','pitch','drag'].forEach(evt => {
            const startEv = `${evt}start`;
            const endEv = `${evt}end`;
            map.on(startEv, () => mapLoading.addMotion(evt));
            map.on(endEv, () => mapLoading.removeMotion(evt));
          });
          ['moveend','zoomend','rotateend','pitchend','dragend'].forEach(evt => {
            map.on(evt, () => mapLoading.apply());
          });
          map.on('remove', () => mapLoading.clearAll());
        }
      map.on('zoomstart', ()=>{
        if(waitForInitialZoom){
          initialZoomStarted = true;
        }
      });
      map.on('zoomend', (e)=>{
        if(waitForInitialZoom){
          if(initialZoomStarted){
            waitForInitialZoom = false;
            window.waitForInitialZoom = waitForInitialZoom;
            initialZoomStarted = false;
            requestAnimationFrame(checkLoadPosts);
          }
          return;
        }
        checkLoadPosts();
      });
      addControls();
      try{
        map.scrollZoom.setWheelZoomRate(1/240);
        map.scrollZoom.setZoomRate(1/240);
      }catch(e){}
      map.on('load', ()=>{
        applyNightSky(map);
        $$('.map-overlay').forEach(el=>el.remove());
        if(spinEnabled){
          startSpin(true);
        }
        updatePostPanel();
        applyFilters();
        checkLoadPosts();
      });

        ['mousedown','wheel','touchstart','dragstart','pitchstart','rotatestart','zoomstart'].forEach(ev=> map.on(ev, haltSpin));
        map.on('pitch', () => {
          const pIn = document.getElementById('mapPitch');
          const pVal = document.getElementById('pitchVal');
          if(pIn) pIn.value = map.getPitch();
          if(pVal) pVal.textContent = map.getPitch().toFixed(0);
        });
        map.on('rotate', () => {
          const bIn = document.getElementById('mapBearing');
          const bVal = document.getElementById('bearingVal');
          if(bIn) bIn.value = map.getBearing();
          if(bVal) bVal.textContent = map.getBearing().toFixed(0);
        });
        let suppressNextRefresh = false;
        const refreshMapView = () => {
          if(suppressNextRefresh) return;
          updatePostPanel();
          updateFilterCounts();
          refreshMarkers();
          const center = map.getCenter().toArray();
          const zoom = map.getZoom();
          const pitch = map.getPitch();
          const bearing = map.getBearing();
          localStorage.setItem('mapView', JSON.stringify({center, zoom, pitch, bearing}));
        };
        ['moveend','zoomend','rotateend','pitchend'].forEach(ev => map.on(ev, refreshMapView));
        map.on('dragend', clearMapGeocoder);
        map.on('click', clearMapGeocoder);
        map.on('touchstart', () => requestAnimationFrame(blurAllGeocoderInputs));
      }

    function startSpin(fromCurrent=false){
      if(mode!=='map') setMode('map');
      if(!spinEnabled || spinning || !map) return;
      if(map.getZoom() >= 3) return;
      if(typeof filterPanel !== 'undefined' && filterPanel) closePanel(filterPanel);
      spinning = true;
      hideResultIndicators();
      historyWasActive = document.body.classList.contains('show-history');
      if(historyWasActive){
        document.body.classList.remove('show-history');
        adjustBoards();
        updateModeToggle();
      }
      function step(){
        if(!spinning || !map) return;
        const isBusy = (map.isMoving && map.isMoving()) || (map.areTilesLoaded && !map.areTilesLoaded());
        if(isBusy){
          requestAnimationFrame(step);
          return;
        }
        const c = map.getCenter();
        map.setCenter([c.lng + spinSpeed, c.lat]);
        requestAnimationFrame(step);
      }
      if(fromCurrent){
        requestAnimationFrame(step);
      }else{
        map.easeTo({center:[0,0], zoom:startZoom, pitch:0, essential:true});
        map.once('moveend', () => requestAnimationFrame(step));
      }
    }
    function stopSpin(){
      spinning = false;
      const wasHistory = historyWasActive;
      historyWasActive = false;
      if(wasHistory){
        document.body.classList.add('show-history');
        adjustBoards();
        updateModeToggle();
      }
      const shouldLoadPosts = pendingPostLoad;
      pendingPostLoad = false;
      if(shouldLoadPosts){
        checkLoadPosts();
        return;
      }
      applyFilters();
    }

    function haltSpin(e){
      const target = (e && e.originalEvent && e.originalEvent.target) || (e && e.target);
      if(target instanceof Node && logoEls.some(el=>el.contains(target))) return;
      if(spinEnabled || spinning){
        spinEnabled = false;
        localStorage.setItem('spinGlobe','false');
        stopSpin();
      }
    }

    ['pointerdown','wheel','keydown','touchstart'].forEach(ev=>
      document.addEventListener(ev, haltSpin, {capture:true})
    );

    function updateSpinState(){
      const shouldSpin = spinLoadStart && (spinLoadType === 'all' || (spinLoadType === 'new' && firstVisit));
      if(shouldSpin !== spinEnabled){
        spinEnabled = shouldSpin;
        localStorage.setItem('spinGlobe', JSON.stringify(spinEnabled));
        if(spinEnabled) startSpin(); else stopSpin();
      }
    }

    window.spinGlobals = {
      get spinEnabled(){ return spinEnabled; },
      set spinEnabled(v){ spinEnabled = v; },
      get spinSpeed(){ return spinSpeed; },
      set spinSpeed(v){ spinSpeed = v; },
      get spinLoadStart(){ return spinLoadStart; },
      set spinLoadStart(v){ spinLoadStart = v; },
      get spinLoadType(){ return spinLoadType; },
      set spinLoadType(v){ spinLoadType = v; },
      get spinLogoClick(){ return spinLogoClick; },
      set spinLogoClick(v){ spinLogoClick = v; updateLogoClickState(); },
      startSpin,
      stopSpin,
      updateSpinState,
      updateLogoClickState
    };

    // Map layers
    function postsToGeoJSON(list){
      const coordMeta = new Map();
      function increment(map, key){
        if(!key) return;
        const trimmed = key.trim();
        if(!trimmed) return;
        map.set(trimmed, (map.get(trimmed) || 0) + 1);
      }
      function deriveVenueFromCity(city){
        const raw = (city ?? '').trim();
        if(!raw) return '';
        const parts = raw.split(',');
        return (parts[0] || '').trim();
      }
      list.forEach(p => {
        if(Number.isFinite(p.lng) && Number.isFinite(p.lat)){
          const key = venueKey(p.lng, p.lat);
          let meta = coordMeta.get(key);
          if(!meta){
            meta = {
              locVenueCounts: new Map(),
              cityVenueCounts: new Map(),
              fallbackCounts: new Map(),
              count: 0
            };
            coordMeta.set(key, meta);
          }
          meta.count++;
          const loc = Array.isArray(p.locations) && p.locations.length ? p.locations[0] : null;
          if(loc && typeof loc.venue === 'string'){
            increment(meta.locVenueCounts, loc.venue);
          }
          increment(meta.cityVenueCounts, deriveVenueFromCity(p.city));
          increment(meta.fallbackCounts, getPrimaryVenueName(p));
        }
      });
      const coordLabels = new Map();
      function findCommonLabel(countMap, total){
        for(const [value, count] of countMap.entries()){
          if(count === total){
            return value;
          }
        }
        return '';
      }
      function findTopLabel(countMap){
        let best = '';
        let bestCount = 0;
        for(const [value, count] of countMap.entries()){
          if(count > bestCount || (count === bestCount && value.localeCompare(best) < 0)){
            best = value;
            bestCount = count;
          }
        }
        return best;
      }
      coordMeta.forEach((meta, key) => {
        let label = findCommonLabel(meta.locVenueCounts, meta.count);
        if(!label){
          label = findCommonLabel(meta.cityVenueCounts, meta.count);
        }
        if(!label){
          label = findTopLabel(meta.cityVenueCounts);
        }
        if(!label){
          label = findTopLabel(meta.locVenueCounts);
        }
        if(!label){
          label = findTopLabel(meta.fallbackCounts);
        }
        coordLabels.set(key, label || '');
      });
      const grouped = new Map();
      list
        .filter(p => Number.isFinite(p.lng) && Number.isFinite(p.lat))
        .forEach(p => {
          const key = venueKey(p.lng, p.lat);
          if(!grouped.has(key)){
            grouped.set(key, []);
          }
          grouped.get(key).push(p);
        });
      const features = [];
      grouped.forEach((group, key) => {
        if(!group.length) return;
        const sample = group[0];
        const baseSub = subcategoryMarkerIds[sample.subcategory] || slugify(sample.subcategory);
        const count = group.length;
        const primaryVenue = getPrimaryVenueName(sample);
        const canonicalVenue = coordLabels.get(key) || primaryVenue || '';
        if(count > 1){
          const multiTitle = `${count} posts here`;
          const labelTitle = shortenMarkerLabelText(multiTitle);
          const venueLine = canonicalVenue ? shortenMarkerLabelText(canonicalVenue) : '';
          const combinedLabel = buildMarkerLabelText(sample, {
            line1: labelTitle,
            line2: venueLine
          });
          const spriteSource = [MULTI_VENUE_MARKER_ID, labelTitle || '', venueLine || ''].join('|');
          const labelSpriteId = hashString(spriteSource);
          features.push({
            type:'Feature',
            properties:{
              id:`multi:${key}`,
              title: labelTitle,
              label: combinedLabel,
              labelLine1: labelTitle,
              labelLine2: venueLine,
              labelSpriteId,
              venueName: canonicalVenue,
              city: sample.city,
              cat: sample.category,
              sub: MULTI_VENUE_MARKER_ID,
              baseSub,
              multi: 1,
              multiCount: count,
              multiLabel: String(count),
              venueKey: key
            },
            geometry:{ type:'Point', coordinates:[sample.lng, sample.lat] }
          });
          return;
        }
        const p = group[0];
        const labelLines = getMarkerLabelLines(p);
        const combinedLabel = buildMarkerLabelText(p, labelLines);
        const spriteSource = [baseSub || '', labelLines.line1 || '', labelLines.line2 || ''].join('|');
        const labelSpriteId = hashString(spriteSource);
        features.push({
          type:'Feature',
          properties:{
            id:p.id,
            title: p.title,
            label: combinedLabel,
            labelLine1: labelLines.line1,
            labelLine2: labelLines.line2,
            labelSpriteId,
            venueName: primaryVenue,
            city:p.city,
            cat:p.category,
            sub: baseSub,
            baseSub,
            multi:0,
            multiCount:1,
            multiLabel:'1',
            venueKey: key
          },
          geometry:{ type:'Point', coordinates:[p.lng, p.lat] }
        });
      });
      return {
        type:'FeatureCollection',
        features
      };
    }

    let addingPostSource = false;
    async function addPostSource(){
      if(!map || addingPostSource) return;
      addingPostSource = true;
      try{
      const markerList = filtersInitialized && Array.isArray(filtered) ? filtered : posts;
      const geojson = postsToGeoJSON(markerList);
      const multiFeatures = geojson.features.filter(f => f && f.properties && f.properties.multi === 1);
      const singleFeatures = geojson.features.filter(f => f && (!f.properties || f.properties.multi !== 1));
      const postsData = { type:'FeatureCollection', features: singleFeatures };
      const multiData = { type:'FeatureCollection', features: multiFeatures };
      const shouldCluster = posts.length >= 10 && clusterRadius > 0;
      const existing = map.getSource('posts');
      const opts = existing && typeof existing.serialize === 'function' ? existing.serialize() : null;
      const desiredClusterProperties = shouldCluster ? { total_posts: ['+', ['get','multiCount']] } : undefined;
      const serializedClusterProps = opts && opts.clusterProperties;
      const clusterPropsChanged = shouldCluster
        ? JSON.stringify(serializedClusterProps || {}) !== JSON.stringify(desiredClusterProperties)
        : !!(serializedClusterProps && Object.keys(serializedClusterProps).length);
      const sourceNeedsRebuild = !existing || !opts || opts.cluster !== shouldCluster || opts.clusterRadius !== clusterRadius || opts.clusterMaxZoom !== clusterMaxZoom || clusterPropsChanged;
      if(sourceNeedsRebuild){
        ['cluster-count','clusters','marker-label','multi-marker-label','posts-heat','hover-fill'].forEach(id=>{ if(map.getLayer(id)) map.removeLayer(id); });
        if(existing) map.removeSource('posts');
        const sourceConfig = { type:'geojson', data: postsData, cluster: shouldCluster, clusterRadius: clusterRadius, clusterMaxZoom: clusterMaxZoom };
        if(shouldCluster){
          sourceConfig.clusterProperties = desiredClusterProperties;
        }
        map.addSource('posts', sourceConfig);
      } else if(existing){
        existing.setData(postsData);
      }
      const multiSourceId = 'multi-posts';
      const existingMulti = map.getSource(multiSourceId);
      if(!existingMulti){
        map.addSource(multiSourceId, { type:'geojson', data: multiData });
      } else {
        existingMulti.setData(multiData);
      }
      const iconIds = Object.keys(subcategoryMarkers);
      if(typeof ensureMapIcon === 'function'){
        await Promise.all(iconIds.map(id => ensureMapIcon(id).catch(()=>{})));
      }
      if(typeof ensureMarkerLabelComposite === 'function'){
        const spriteMeta = new Map();
        geojson.features.forEach(feature => {
          if(!feature || !feature.properties) return;
          const props = feature.properties;
          const spriteId = props.labelSpriteId;
          if(!spriteId || spriteMeta.has(spriteId)) return;
          spriteMeta.set(spriteId, {
            sub: props.sub || props.baseSub || '',
            line1: props.labelLine1 || '',
            line2: props.labelLine2 || '',
            isMulti: props.multi === 1
          });
        });
        await Promise.all(Array.from(spriteMeta.entries()).map(([spriteId, meta]) =>
          ensureMarkerLabelComposite(map, spriteId, meta.sub, meta.line1, meta.line2, meta.isMulti).catch(()=>{})
        ));
      }
      if(!map.getLayer('posts-heat')){
        map.addLayer({ id:'posts-heat', type:'heatmap', source:'posts', maxzoom:4, paint:{
          'heatmap-weight': 0.7, 'heatmap-intensity': 2.0, 'heatmap-radius': 40,
          'heatmap-color':[ 'interpolate',['linear'],['heatmap-density'], 0,'rgba(33,102,172,0)', 0.2,'rgba(103,169,207,.6)', 0.4,'rgba(209,229,240,.9)', 0.6,'rgba(253,219,146,.95)', 0.8,'rgba(239,138,98,.95)', 1,'rgba(178,24,43,.95)']
        } });
      }
      const usingSvgClusters = shouldCluster && clusterIconType === 'svg' && clusterSvg;
      const svgHash = usingSvgClusters ? hashString(clusterSvg) : '';
      const clusterVisualKey = shouldCluster ? (usingSvgClusters ? `svg:${svgHash}` : 'circle') : 'none';
      const visualsChanged = clusterVisualKey !== currentClusterVisualKey || sourceNeedsRebuild;
      ensureMarkerLabelBackground(map);
      const markerLabelFilter = ['all', ['!',['has','point_count']], ['has','title']];

      if(shouldCluster){
        if(usingSvgClusters){
          const imgId = 'cluster-svg';
          if(visualsChanged || svgHash !== lastClusterSvgHash || !map.hasImage(imgId)){
            if(map.hasImage(imgId)) map.removeImage(imgId);
            await new Promise(res=>{
              const {svg: svgData, width, height} = ensureSvgDimensions(clusterSvg);
              const url = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgData);
              const img = new Image(width, height);
              img.onload = () => { if(!map.hasImage(imgId)) map.addImage(imgId, img); res(); };
              img.onerror = () => res();
              img.src = url;
            });
            lastClusterSvgHash = svgHash;
          }
          if(visualsChanged || !map.getLayer('clusters')){
            if(map.getLayer('clusters')) map.removeLayer('clusters');
            map.addLayer({
              id:'clusters',
              type:'symbol',
              source:'posts',
              filter:['has','point_count'],
              layout:{
                'icon-image': 'cluster-svg',
                'icon-allow-overlap': true,
                'icon-ignore-placement': true,
                'icon-pitch-alignment': 'viewport',
                'symbol-z-order': 'viewport-y',
                'symbol-sort-key': 1000
              },
              paint:{},
            });
          } else {
            try{ map.setLayoutProperty('clusters','icon-image','cluster-svg'); }catch(e){}
          }
        } else {
          if(visualsChanged || !map.getLayer('clusters')){
            if(map.getLayer('clusters')) map.removeLayer('clusters');
            map.addLayer({ id:'clusters', type:'circle', source:'posts', filter:['has','point_count'], paint:{
              'circle-color': ['step',['get','point_count'], '#24c6dc', 20, '#514a9d', 50, '#f7797d', 100, '#fbd786'],
              'circle-radius': ['step',['get','point_count'], 16, 20, 22, 50, 28, 100, 34],
              'circle-opacity': 0.85,
              'circle-stroke-color':'#0b1623',
              'circle-stroke-width':1
            } });
          } else {
            try{ map.setPaintProperty('clusters','circle-color', ['step',['get','point_count'], '#24c6dc', 20, '#514a9d', 50, '#f7797d', 100, '#fbd786']); }catch(e){}
            try{ map.setPaintProperty('clusters','circle-radius', ['step',['get','point_count'], 16, 20, 22, 50, 28, 100, 34]); }catch(e){}
            try{ map.setPaintProperty('clusters','circle-opacity', 0.85); }catch(e){}
            try{ map.setPaintProperty('clusters','circle-stroke-color','#0b1623'); }catch(e){}
            try{ map.setPaintProperty('clusters','circle-stroke-width',1); }catch(e){}
          }
          lastClusterSvgHash = '';
        }

        if(!map.getLayer('cluster-count')){
          map.addLayer({
            id:'cluster-count',
            type:'symbol',
            source:'posts',
            filter:['has','point_count'],
            layout:{
              'text-field':['to-string', ['coalesce', ['get','total_posts'], ['get','point_count_abbreviated']]],
              'text-size':12,
              'text-allow-overlap': true,
              'text-ignore-placement': true,
              'symbol-z-order': 'viewport-y',
              'symbol-sort-key': 1001
            },
            paint:{'text-color':'#fff'}
          });
        } else {
          try{ map.setLayoutProperty('cluster-count','text-field',['to-string', ['coalesce', ['get','total_posts'], ['get','point_count_abbreviated']]]); }catch(e){}
          try{ map.setPaintProperty('cluster-count','text-color','#fff'); }catch(e){}
        }
      } else {
        if(map.getLayer('clusters')) map.removeLayer('clusters');
        if(map.getLayer('cluster-count')) map.removeLayer('cluster-count');
        lastClusterSvgHash = '';
      }

      const markerLabelIconImage = ['let', 'spriteId', ['coalesce', ['get','labelSpriteId'], ''],
        ['case',
          ['==', ['var','spriteId'], ''],
          MARKER_LABEL_BG_ID,
          ['concat', MARKER_LABEL_COMPOSITE_PREFIX, ['var','spriteId']]
        ]
      ];

      const labelLayersConfig = [
        { id:'marker-label', source:'posts', sortKey: 1100 },
        { id:'multi-marker-label', source:'multi-posts', sortKey: 1101 }
      ];
      labelLayersConfig.forEach(({ id, source, sortKey }) => {
        if(!map.getLayer(id)){
          map.addLayer({
            id,
            type:'symbol',
            source,
            filter: markerLabelFilter,
            layout:{
              'icon-image': markerLabelIconImage,
              'icon-size': 1,
              'icon-allow-overlap': true,
              'icon-ignore-placement': true,
              'icon-anchor': 'left',
              'icon-pitch-alignment': 'viewport',
              'symbol-z-order': 'viewport-y',
              'symbol-sort-key': sortKey
            },
            paint:{
              'icon-translate': [markerLabelBgTranslatePx, 0],
              'icon-translate-anchor': 'viewport',
              'icon-opacity': 1
            }
          });
        }
        try{ map.setFilter(id, markerLabelFilter); }catch(e){}
        try{ map.setLayoutProperty(id,'icon-image', markerLabelIconImage); }catch(e){}
        try{ map.setLayoutProperty(id,'icon-size', 1); }catch(e){}
        try{ map.setLayoutProperty(id,'icon-allow-overlap', true); }catch(e){}
        try{ map.setLayoutProperty(id,'icon-ignore-placement', true); }catch(e){}
        try{ map.setLayoutProperty(id,'icon-anchor','left'); }catch(e){}
        try{ map.setLayoutProperty(id,'icon-pitch-alignment','viewport'); }catch(e){}
        try{ map.setLayoutProperty(id,'symbol-z-order','viewport-y'); }catch(e){}
        try{ map.setLayoutProperty(id,'symbol-sort-key', sortKey); }catch(e){}
        try{ map.setPaintProperty(id,'icon-translate',[markerLabelBgTranslatePx,0]); }catch(e){}
        try{ map.setPaintProperty(id,'icon-translate-anchor','viewport'); }catch(e){}
        try{ map.setPaintProperty(id,'icon-opacity',1); }catch(e){}
      });
      ['hover-fill','clusters','cluster-count','marker-label','multi-marker-label'].forEach(id=>{
        if(map.getLayer(id)){
          try{ map.moveLayer(id); }catch(e){}
        }
      });
      [
        ['clusters','circle-opacity-transition'],
        ['clusters','icon-opacity-transition'],
        ['cluster-count','text-opacity-transition'],
        ['marker-label','icon-opacity-transition'],
        ['multi-marker-label','icon-opacity-transition']
      ].forEach(([layer, prop])=>{
        if(map.getLayer(layer)){
          try{ map.setPaintProperty(layer, prop, {duration:0}); }catch(e){}
        }
      });
      currentClusterVisualKey = clusterVisualKey;
      if(!postSourceEventsBound){
        // === 0528: Right‑click cluster -> open scrollable list (locks map) ===
        // Close list on outside click or ESC
        map.on('click', (e)=>{
          if(!listLocked) return; if(Date.now() - lastListOpenAt < 200) return;
          // ignore the click that just opened it
          if(Date.now() - lastListOpenAt < 200) return;
          const el = hoverPopup && hoverPopup.getElement();
          if(!el) { lockMap(false); return; }
          const within = el.contains(e.originalEvent.target);
          if(!within){ hoverPopup.remove(); hoverPopup=null; lockMap(false); }
        });
        window.addEventListener('keydown', (ev)=>{ if(ev.key==='Escape' && listLocked){ if(hoverPopup){ hoverPopup.remove(); hoverPopup=null; } lockMap(false); } });
        // 0530: Right‑click a *venue marker* -> show list of events at that venue
        const handleMarkerContextMenu = (e)=>{
          const f = e.features && e.features[0]; if(!f) return;
          if(e.preventDefault) e.preventDefault();
          const coords = f.geometry && f.geometry.coordinates; if(!coords || coords.length<2) return;
          const items = postsAtVenue(coords[0], coords[1]);
          if(!items || !items.length){ return; }
          openListPopupAtPoint(e.point, buildClusterListHTML(items));

          (function(){
            function consume(ev){ try{ ev.preventDefault(); }catch(e){} try{ ev.stopPropagation(); }catch(e){} }
            const _root = hoverPopup && hoverPopup.getElement ? hoverPopup.getElement() : null;
            if(_root){
              ['pointerdown','mousedown','mouseup','click'].forEach(t=> _root.addEventListener(t, consume, {capture:true}));
            }
          })();

          // Wire interactions
          const root = hoverPopup.getElement();
          const close = ()=>{ if(hoverPopup){ hoverPopup.remove(); hoverPopup=null; } lockMap(false); };
          root.addEventListener('click', (ev)=> ev.stopPropagation(), {capture:true});
          root.querySelectorAll('.map-card-list-item').forEach(n => n.addEventListener('click', (evt)=>{
            const id = n.getAttribute('data-id');
            if(!id) return;
            evt.preventDefault();
            callWhenDefined('openPost', (fn)=>{
              requestAnimationFrame(() => {
                try{
                  touchMarker = null;
                  close();
                  stopSpin();
                  if(typeof closePanel === 'function' && typeof filterPanel !== 'undefined' && filterPanel){
                    try{ closePanel(filterPanel); }catch(err){}
                  }
                  fn(id, false, true);
                }catch(err){ console.error(err); }
              });
            });
          }, { capture: true }));
            const btn = root.querySelector('[data-act="close"]'); if(btn) btn.addEventListener('click', close);
            lockMap(true); lastListOpenAt = Date.now();
        };
        MARKER_INTERACTIVE_LAYERS.forEach(layer => map.on('contextmenu', layer, handleMarkerContextMenu));

        map.on('click','clusters', (e)=>{
          stopSpin();
          if(e && e.preventDefault) e.preventDefault();
          const features = map.queryRenderedFeatures(e.point, { layers:['clusters'] });
          if(!features.length) return;
          const feature = features[0];
          const props = feature.properties || {};
          const clusterId = props.cluster_id;
          const clusterLayer = map.getLayer('clusters');
          const sourceId = clusterLayer ? clusterLayer.source : null;
          if(clusterId === undefined || clusterId === null || !sourceId) return;
          const src = map.getSource && map.getSource(sourceId);
          if(!src || typeof src.getClusterExpansionZoom !== 'function') return;

          suppressNextRefresh = true;
          const clearSuppress = () => { suppressNextRefresh = false; };
          src.getClusterExpansionZoom(clusterId, (err, expansionZoom)=>{
            if(err){ clearSuppress(); return; }
            try{
              const coords = feature.geometry && feature.geometry.coordinates;
              if(!coords) { clearSuppress(); return; }
              const maxZoom = typeof map.getMaxZoom === 'function' ? map.getMaxZoom() : undefined;
              const hasExpansionZoom = typeof expansionZoom === 'number' && !Number.isNaN(expansionZoom);
              const fallbackZoom = typeof map.getZoom === 'function' ? map.getZoom() : undefined;
              const targetZoom = hasExpansionZoom ? expansionZoom : fallbackZoom;
              if(typeof targetZoom !== 'number'){ clearSuppress(); return; }
              const nextZoom = typeof maxZoom === 'number' ? Math.min(targetZoom, maxZoom) : targetZoom;
              const animationOpts = { center: coords, zoom: nextZoom, essential: true };
              let computedDuration = 650;
              try{
                const getCenter = typeof map.getCenter === 'function' ? map.getCenter() : null;
                const getZoom = typeof map.getZoom === 'function' ? map.getZoom() : null;
                const targetLngLat = (typeof mapboxgl !== 'undefined' && mapboxgl && typeof mapboxgl.LngLat === 'function')
                  ? new mapboxgl.LngLat(coords[0], coords[1])
                  : null;
                if(getCenter && targetLngLat && typeof getCenter.distanceTo === 'function'){
                  const distanceMeters = getCenter.distanceTo(targetLngLat);
                  const distanceMs = Math.min(1200, Math.log(distanceMeters / 1000 + 1) * 600);
                  const zoomDelta = typeof getZoom === 'number' ? Math.abs(nextZoom - getZoom) : 0;
                  const zoomMs = Math.min(600, zoomDelta * 120);
                  const base = 450;
                  computedDuration = Math.max(450, Math.min(2200, base + distanceMs + zoomMs));
                  if(zoomDelta < 0.35){
                    const blend = Math.max(0, Math.min(1, zoomDelta / 0.35));
                    const speedMultiplier = 0.45 + (0.55 * blend);
                    computedDuration = Math.max(220, Math.min(2200, computedDuration * speedMultiplier));
                  }
                }
              }catch(durationErr){
                console.error(durationErr);
              }
              animationOpts.duration = Math.round(computedDuration);
              map.easeTo(animationOpts);
              const settleDelay = Math.max(400, (animationOpts.duration || 500) + 120);
              setTimeout(clearSuppress, settleDelay);
            }catch(ex){
              console.error(ex);
              clearSuppress();
            }
          });
        });

        function createMapCardOverlay(post, opts = {}){
          const { targetLngLat, fixedLngLat, eventLngLat } = opts;
          const overlayRoot = document.createElement('div');
          overlayRoot.className = 'mapmarker-overlay';
          overlayRoot.dataset.id = String(post.id);
          overlayRoot.setAttribute('aria-hidden', 'true');
          overlayRoot.style.pointerEvents = 'none';
          overlayRoot.style.userSelect = 'none';

          const markerContainer = document.createElement('div');
          markerContainer.className = 'mapmarker-container';
          markerContainer.dataset.id = overlayRoot.dataset.id;
          markerContainer.setAttribute('aria-hidden', 'true');
          markerContainer.style.pointerEvents = 'none';
          markerContainer.style.userSelect = 'none';

          const markerIcon = new Image();
          try{ markerIcon.decoding = 'async'; }catch(e){}
          markerIcon.alt = '';
          markerIcon.className = 'mapmarker';
          markerIcon.draggable = false;
          const markerSources = window.subcategoryMarkers || {};
          const markerIds = window.subcategoryMarkerIds || {};
          const slugifyFn = typeof slugify === 'function' ? slugify : (window.slugify || (str => (str || '').toString().trim().toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'')));
          const markerIdCandidates = [];
          if(post && post.subcategory){
            const mappedId = markerIds[post.subcategory];
            if(mappedId) markerIdCandidates.push(mappedId);
            markerIdCandidates.push(slugifyFn(post.subcategory));
          }
          markerIdCandidates.push(MULTI_VENUE_MARKER_ID);
          const markerIconUrl = markerIdCandidates.map(id => (id && markerSources[id]) || null).find(Boolean) || '';
          if(markerIconUrl){
            markerIcon.src = markerIconUrl;
          }

          const markerPill = new Image();
          try{ markerPill.decoding = 'async'; }catch(e){}
          markerPill.alt = '';
          markerPill.src = 'assets/icons-30/150x40 pill 99.webp';
          markerPill.className = 'mapmarker-pill';
          markerPill.style.opacity = '0.9';
          markerPill.draggable = false;

          const labelLines = getMarkerLabelLines(post);
          const markerLabel = document.createElement('div');
          markerLabel.className = 'mapmarker-label';
          const markerLine1 = document.createElement('div');
          markerLine1.className = 'mapmarker-label-line';
          markerLine1.textContent = labelLines.line1;
          markerLabel.appendChild(markerLine1);
          if(labelLines.line2){
            const markerLine2 = document.createElement('div');
            markerLine2.className = 'mapmarker-label-line';
            markerLine2.textContent = labelLines.line2;
            markerLabel.appendChild(markerLine2);
          }

          markerContainer.append(markerPill, markerIcon, markerLabel);

          const cardRoot = document.createElement('div');
          cardRoot.className = 'map-card map-card--popup';
          cardRoot.dataset.id = overlayRoot.dataset.id;
          cardRoot.setAttribute('aria-hidden', 'true');
          cardRoot.style.pointerEvents = 'auto';
          cardRoot.style.userSelect = 'none';

          const pillImg = new Image();
          try{ pillImg.decoding = 'async'; }catch(e){}
          pillImg.alt = '';
          pillImg.src = 'assets/icons-30/225x60-pill-99.webp';
          pillImg.className = 'map-card-pill';
          pillImg.style.opacity = '0.9';
          pillImg.draggable = false;

          const thumbImg = new Image();
          try{ thumbImg.decoding = 'async'; }catch(e){}
          thumbImg.alt = '';
          thumbImg.src = imgThumb(post);
          thumbImg.className = 'map-card-thumb';
          thumbImg.referrerPolicy = 'no-referrer';
          thumbImg.draggable = false;

          const labelEl = document.createElement('div');
          labelEl.className = 'map-card-label';
          const titleWrap = document.createElement('div');
          titleWrap.className = 'map-card-title';
          const cardTitleLines = Array.isArray(labelLines.cardTitleLines) && labelLines.cardTitleLines.length
            ? labelLines.cardTitleLines.slice(0, 2)
            : [labelLines.line1, labelLines.line2].filter(Boolean).slice(0, 2);
          cardTitleLines.forEach(line => {
            if(!line) return;
            const lineEl = document.createElement('div');
            lineEl.className = 'map-card-title-line';
            lineEl.textContent = line;
            titleWrap.appendChild(lineEl);
          });
          if(!titleWrap.childElementCount){
            const lineEl = document.createElement('div');
            lineEl.className = 'map-card-title-line';
            lineEl.textContent = '';
            titleWrap.appendChild(lineEl);
          }
          labelEl.appendChild(titleWrap);
          const venueLine = labelLines.venueLine || shortenMarkerLabelText(getPrimaryVenueName(post), mapCardTitleWidthPx);
          if(venueLine){
            const venueEl = document.createElement('div');
            venueEl.className = 'map-card-venue';
            venueEl.textContent = venueLine;
            labelEl.appendChild(venueEl);
          }

          cardRoot.append(pillImg, thumbImg, labelEl);
          overlayRoot.append(markerContainer, cardRoot);
          overlayRoot.classList.add('is-card-visible');
          overlayRoot.style.pointerEvents = '';

          const handleOverlayClick = (ev)=>{
            ev.preventDefault();
            ev.stopPropagation();
            const pid = overlayRoot.dataset.id;
            if(!pid) return;
            callWhenDefined('openPost', (fn)=>{
              requestAnimationFrame(() => {
                try{
                  touchMarker = null;
                  stopSpin();
                  if(typeof closePanel === 'function' && typeof filterPanel !== 'undefined' && filterPanel){
                    try{ closePanel(filterPanel); }catch(err){}
                  }
                  fn(pid, false, true);
                }catch(err){ console.error(err); }
              });
            });
          };
          cardRoot.addEventListener('click', handleOverlayClick, { capture: true });
          ['pointerdown','mousedown','touchstart'].forEach(type => {
            cardRoot.addEventListener(type, (ev)=>{
              const pointerType = typeof ev.pointerType === 'string' ? ev.pointerType.toLowerCase() : '';
              const isTouchLike = pointerType === 'touch' || ev.type === 'touchstart';
              if(!isTouchLike){
                try{ ev.preventDefault(); }catch(err){}
              }
              try{ ev.stopPropagation(); }catch(err){}
            }, { capture: true });
          });
          cardRoot.addEventListener('mouseenter', ()=>{
            window.__overCard = true;
          });
          cardRoot.addEventListener('mouseleave', ()=>{
            window.__overCard = false;
            if(listLocked) return;
            const currentPopup = hoverPopup;
            schedulePopupRemoval(currentPopup, 160);
          });

          const marker = new mapboxgl.Marker({ element: overlayRoot, anchor: 'center' });
          if(typeof marker.setZIndexOffset === 'function'){
            try{ marker.setZIndexOffset(20000); }catch(e){}
          }
          const markerElement = typeof marker.getElement === 'function' ? marker.getElement() : overlayRoot;
          if(markerElement && markerElement.style){
            markerElement.style.zIndex = '20000';
          }
          if(targetLngLat){ marker.setLngLat(targetLngLat); }
          else if(fixedLngLat){ marker.setLngLat(fixedLngLat); }
          else if(eventLngLat){ marker.setLngLat(eventLngLat); }
          marker.addTo(map);
          marker.__fixedLngLat = fixedLngLat;
          window.__overCard = false;
          registerPopup(marker);
          return marker;
        }

        const handleMarkerClick = (e)=>{
          stopSpin();
          const f = e.features && e.features[0]; if(!f) return;
        const props = f.properties || {};
        const id = props.id;
        if(id !== undefined && id !== null){
          activePostId = id;
          selectedVenueKey = props.venueKey || null;
          updateSelectedMarkerRing();
        }
        const coords = f.geometry && f.geometry.coordinates;
        const hasCoords = Array.isArray(coords) && coords.length >= 2 && Number.isFinite(coords[0]) && Number.isFinite(coords[1]);
        const baseLngLat = hasCoords ? { lng: coords[0], lat: coords[1] } : (e && e.lngLat ? { lng: e.lngLat.lng, lat: e.lngLat.lat } : null);
        const fixedLngLat = baseLngLat || (e && e.lngLat ? { lng: e.lngLat.lng, lat: e.lngLat.lat } : null);
        const targetLngLat = baseLngLat || (e ? e.lngLat : null);
        if(coords && coords.length>=2){
          const items = postsAtVenue(coords[0], coords[1]);
          if(items && items.length>1){
            if(e.preventDefault) e.preventDefault();
            if(e.originalEvent){ e.originalEvent.preventDefault(); e.originalEvent.stopPropagation(); }
            const multiPopup = showMultiVenuePopup(e.point, coords[0], coords[1], { lockOnOpen: true, items });
            if(multiPopup){
              lastListOpenAt = Date.now();
              return;
            }
          }
        }
        const touchClick = isTouchDevice || (e.originalEvent && (e.originalEvent.pointerType === 'touch' || e.originalEvent.pointerType === 'pen'));
        if(touchClick){
          if(touchMarker !== id || !hoverPopup){
            touchMarker = id;
            if(hoverPopup){
              try{ hoverPopup.remove(); }catch(err){}
              hoverPopup = null;
            }
            const p = posts.find(x=>x.id===id);
            if(p){
              hoverPopup = createMapCardOverlay(p, { targetLngLat, fixedLngLat, eventLngLat: e && e.lngLat });
            }
          }
          return;
        }
      };
      MARKER_INTERACTIVE_LAYERS.forEach(layer => map.on('click', layer, handleMarkerClick));

      map.on('click', e=>{
        const originalTarget = e.originalEvent && e.originalEvent.target;
        const targetEl = originalTarget && typeof originalTarget.closest === 'function'
          ? originalTarget.closest('.mapmarker-overlay')
          : null;
        if(targetEl){
          return;
        }
        const feats = map.queryRenderedFeatures(e.point);
        if(!feats.length){
          if(hoverPopup){ hoverPopup.remove(); hoverPopup=null; }
          touchMarker = null;
        }
      });

      updateSelectedMarkerRing();

      // Cursor + popup for marker points
      
      const handleMarkerMouseEnter = (e)=>{
        map.getCanvas().style.cursor = 'pointer';
        const f = e.features && e.features[0]; if(!f) return;
        const id = f.properties.id;
        const coords = f.geometry && f.geometry.coordinates;
        const hasCoords = Array.isArray(coords) && coords.length >= 2 && Number.isFinite(coords[0]) && Number.isFinite(coords[1]);
        const baseLngLat = hasCoords ? { lng: coords[0], lat: coords[1] } : (e && e.lngLat ? { lng: e.lngLat.lng, lat: e.lngLat.lat } : null);
        const fixedLngLat = baseLngLat || (e && e.lngLat ? { lng: e.lngLat.lng, lat: e.lngLat.lat } : null);
        const targetLngLat = baseLngLat || (e ? e.lngLat : null);
        const multi = hasCoords ? postsAtVenue(coords[0], coords[1]) : null;
        if(multi && multi.length>1){
          const multiPopup = showMultiVenuePopup(e.point, coords[0], coords[1], { items: multi });
          const popupEl = multiPopup && multiPopup.root ? multiPopup.root : getPopupElement(hoverPopup);
          bindPopupHoverGuards(popupEl);
          return;
        }
        const p = posts.find(x=>x.id===id);
        if(!p){
          return;
        }
        if(hoverPopup){
          try{ hoverPopup.remove(); }catch(e){}
          hoverPopup = null;
        }
        hoverPopup = createMapCardOverlay(p, { targetLngLat, fixedLngLat, eventLngLat: e && e.lngLat });
      };
      MARKER_INTERACTIVE_LAYERS.forEach(layer => map.on('mouseenter', layer, handleMarkerMouseEnter));

      const onMarkerMove = window.rafThrottle(()=>{
        if(hoverPopup && typeof hoverPopup.setLngLat === 'function'){
          const fixed = hoverPopup.__fixedLngLat;
          if(fixed && Number.isFinite(fixed.lng) && Number.isFinite(fixed.lat)){
            hoverPopup.setLngLat(fixed);
          }
        }
      });
      MARKER_INTERACTIVE_LAYERS.forEach(layer => map.on('mousemove', layer, onMarkerMove));

      const handleMarkerMouseLeave = ()=>{
        map.getCanvas().style.cursor = 'grab';
        if(listLocked) return;
        const currentPopup = hoverPopup;
        schedulePopupRemoval(currentPopup, 200);
      };
      MARKER_INTERACTIVE_LAYERS.forEach(layer => map.on('mouseleave', layer, handleMarkerMouseLeave));

      const handleClusterInteraction = (e, options = {})=>{
        const lockOnOpen = !!options.lockOnOpen;
        if(listLocked && !lockOnOpen) return;
        const feature = e.features && e.features[0];
        if(!feature || !feature.properties) return;
        const props = feature.properties;
        const clusterId = typeof props.cluster_id === 'number' ? props.cluster_id : null;
        if(clusterId === null) return;
        getClusterLeavesAll('posts', clusterId, MAX_CLUSTER_BOUNDS_LEAVES, props.point_count).then(({ leaves })=>{
          if(!Array.isArray(leaves) || !leaves.length) return;
          let venueKey = null;
          let coords = null;
          for(let i=0;i<leaves.length;i++){
            const leaf = leaves[i];
            if(!leaf || !leaf.properties) { venueKey = null; break; }
            const leafVenue = leaf.properties.venueKey;
            if(!leafVenue){ venueKey = null; break; }
            if(venueKey === null){
              venueKey = leafVenue;
              const geom = leaf.geometry && leaf.geometry.coordinates;
              if(Array.isArray(geom) && geom.length >= 2){
                coords = geom;
              }
            } else if(leafVenue !== venueKey){
              venueKey = null;
              break;
            }
          }
          if(!venueKey || !coords || coords.length < 2) return;
          const items = postsAtVenue(coords[0], coords[1]);
          if(!items || items.length <= 1) return;
          if(typeof e.preventDefault === 'function') e.preventDefault();
          if(e.originalEvent){
            try{ e.originalEvent.preventDefault(); }catch(err){}
            try{ e.originalEvent.stopPropagation(); }catch(err){}
          }
          const popup = showMultiVenuePopup(e.point, coords[0], coords[1], { lockOnOpen, items });
          if(!popup) return;
          if(lockOnOpen){
            lastListOpenAt = Date.now();
          } else {
            bindPopupHoverGuards(popup.root || getPopupElement(hoverPopup));
          }
        }).catch(err => console.error(err));
      };

      // Maintain pointer cursor for clusters and surface multi-venue cards when applicable
      map.on('mouseenter','clusters', (e)=>{
        map.getCanvas().style.cursor='pointer';
        handleClusterInteraction(e);
      });
      map.on('click','clusters', (e)=>{
        handleClusterInteraction(e, { lockOnOpen: true });
      });
      map.on('mouseleave','clusters', ()=>{
        map.getCanvas().style.cursor='grab';
        if(listLocked) return;
        const currentPopup = hoverPopup;
        schedulePopupRemoval(currentPopup, 200);
      });
        postSourceEventsBound = true;
      }
      } catch (err) {
        console.error('addPostSource failed', err);
      } finally {
        addingPostSource = false;
      }
      }
      window.addPostSource = addPostSource;
    function renderLists(list){
      if(spinning || !postsLoaded) return;
      const sort = currentSort;
      const arr = list.slice();
      if(sort==='az') arr.sort((a,b)=> a.title.localeCompare(b.title));
      if(sort==='soon') arr.sort((a,b)=> a.dates[0].localeCompare(b.dates[0]));
      if(sort==='nearest'){
        let ref = {lng:0,lat:0}; if(map){ const c = map.getCenter(); ref = {lng:c.lng,lat:c.lat}; }
        arr.sort((a,b)=> distKm({lng:a.lng,lat:a.lat}, ref) - distKm({lng:b.lng,lat:b.lat}, ref));
      }
      if(favToTop && !favSortDirty) arr.sort((a,b)=> (b.fav - a.fav));

      sortedPostList = arr;
      renderedPostCount = 0;

      if(postBatchObserver) postBatchObserver.disconnect();
      removeScrollListener(postsWideEl, onPostBoardScroll, postBoardScrollOptions);
      postBoardScrollOptions = null;
      if(postSentinel) postSentinel.remove();
      postSentinel = null;

      if(resultsEl) resultsEl.innerHTML = '';
      postsWideEl.innerHTML = '';

      if(!arr.length){
        updateResultCount(0);
        const emptyWrap = document.createElement('div');
        emptyWrap.className = 'post-board-empty';
        const summaryEl = $('#filterSummary');
        const summaryText = summaryEl ? summaryEl.textContent.trim() : '';
        const summaryCopy = document.createElement('div');
        summaryCopy.className = 'filter-summary post-board-empty-summary';
        summaryCopy.textContent = summaryText || 'No results match your filters.';
        emptyWrap.appendChild(summaryCopy);
        const emptyImg = document.createElement('img');
        emptyImg.src = 'assets/monkeys/Firefly_cute-little-monkey-in-red-cape-pointing-up-937096.png';
        emptyImg.alt = 'Cute little monkey in red cape pointing up';
        emptyImg.className = 'post-board-empty-image';
        emptyWrap.appendChild(emptyImg);
        const emptyMsg = document.createElement('p');
        emptyMsg.className = 'post-board-empty-message';
        emptyMsg.textContent = 'There are no posts here. Try moving the map or changing your filter settings.';
        emptyWrap.appendChild(emptyMsg);
        postsWideEl.appendChild(emptyWrap);
        return;
      }

      postSentinel = document.createElement('div');
      postSentinel.style.height = '1px';
      postsWideEl.appendChild(postSentinel);

      if(spinning && arr.length){
        const sample = card(arr[0], true);
        sample.style.visibility = 'hidden';
        postsWideEl.insertBefore(sample, postSentinel);
        const rect = sample.getBoundingClientRect();
        const style = getComputedStyle(sample);
        const cardHeight = rect.height + parseFloat(style.marginBottom || 0);
        postsWideEl.removeChild(sample);
        const max = Math.max(1, Math.floor(postsModeEl.clientHeight / cardHeight));
        appendPostBatch(max);
      } else {
        appendPostBatch(INITIAL_RENDER_COUNT);
      }

      updateResultCount(arr.length);

      if('IntersectionObserver' in window){
        postBatchObserver = new IntersectionObserver(entries => {
          entries.forEach(entry => {
            if(entry.isIntersecting){
              appendPostBatch();
            }
          });
        }, {root: postsWideEl, rootMargin:'0px 0px 200px 0px'});
        postBatchObserver.observe(postSentinel);
      } else {
        postBoardScrollOptions = addPassiveScrollListener(postsWideEl, onPostBoardScroll);
      }
    }
    function updateResultCount(n){
      const el = $('#resultCount');
      if(!el) return;
      if(spinning){
        el.innerHTML = '';
        el.style.display = 'none';
        return;
      }
      el.innerHTML = `<strong>${n}</strong>`;
      el.style.display = '';
    }
    function formatDates(d){
      if(!d || !d.length) return '';
      const sorted = d.slice().sort();
      const currentYear = new Date().getFullYear();
      const formatPart = (dateObj, includeYear=false)=>{
        const base = dateObj.toLocaleDateString('en-GB',{weekday:'short', day:'numeric', month:'short'}).replace(/,/g,'');
        return includeYear ? `${base}, ${dateObj.getFullYear()}` : base;
      };
      const first = parseISODate(sorted[0]);
      const last = parseISODate(sorted[sorted.length-1]);
      if(sorted.length === 1){
        const includeYear = first.getFullYear() !== currentYear;
        return formatPart(first, includeYear);
      }
      const firstYear = first.getFullYear();
      const lastYear = last.getFullYear();
      const crossYear = firstYear !== lastYear;
      const firstIncludeYear = crossYear && firstYear !== currentYear;
      const lastIncludeYear = (crossYear && lastYear !== currentYear) || (!crossYear && lastYear !== currentYear);
      const startText = formatPart(first, firstIncludeYear);
      const endText = formatPart(last, lastIncludeYear);
      return `${startText} - ${endText}`;
    }

    function parseCreatedToDate(created){
      if(!created) return null;
      const parts = created.split('T');
      if(parts.length < 2) return null;
      const [datePart, rawTime] = parts;
      if(!datePart) return null;
      const hasZ = rawTime.endsWith('Z');
      const timeCore = hasZ ? rawTime.slice(0, -1) : rawTime;
      const [hh = '00', mm = '00', ss = '00', ms = ''] = timeCore.split('-');
      const iso = `${datePart}T${hh.padStart(2,'0')}:${mm.padStart(2,'0')}:${ss.padStart(2,'0')}${ms ? '.' + ms : ''}${hasZ ? 'Z' : ''}`;
      const dt = new Date(iso);
      return Number.isNaN(dt.getTime()) ? null : dt;
    }

    function formatPostTimestamp(created){
      const dt = parseCreatedToDate(created);
      if(!dt) return '';
      const y = dt.getUTCFullYear();
      const m = String(dt.getUTCMonth()+1).padStart(2,'0');
      const d = String(dt.getUTCDate()).padStart(2,'0');
      const hh = String(dt.getUTCHours()).padStart(2,'0');
      const mm = String(dt.getUTCMinutes()).padStart(2,'0');
      return `${y}-${m}-${d} ${hh}:${mm} UTC`;
    }

    function prioritizeVisibleImages(){
      const roots = [postsWideEl];
      if(resultsEl) roots.push(resultsEl);
      roots.forEach(root => {
        const imgs = root.querySelectorAll('img.thumb');
        if(!imgs.length) return;
        if('IntersectionObserver' in window){
          const observerRoot = root === postsWideEl ? root.closest('.post-board') : root;
          const obs = new IntersectionObserver(entries => {
            entries.forEach(entry => {
              if(entry.isIntersecting){
                const img = entry.target;
                if(img.dataset.src){
                  img.addEventListener('load', ()=> img.classList.remove('lqip'), {once:true});
                  img.src = img.dataset.src;
                  img.removeAttribute('data-src');
                }
                img.fetchPriority = 'high';
                obs.unobserve(img);
              }
            });
          }, {root: observerRoot});
          imgs.forEach(img => obs.observe(img));
        } else {
          imgs.forEach(img => {
            img.loading = 'lazy';
            if(img.dataset.src){
              img.addEventListener('load', ()=> img.classList.remove('lqip'), {once:true});
              img.src = img.dataset.src;
              img.removeAttribute('data-src');
            }
          });
        }
      });
    }

    function card(p, wide=false){
      const el = document.createElement('article');
      el.className = wide ? 'post-card' : 'recents-card';
      el.dataset.id = p.id;
      if(wide) el.style.gridTemplateColumns='80px 1fr 36px';
      const thumbSrc = imgThumb(p);
      const thumb = `<img class="thumb lqip" loading="lazy" src="${thumbSrc}" alt="" referrerpolicy="no-referrer" />`;
        el.innerHTML = `
          ${thumb}
        <div class="meta">
          <div class="title">${p.title}</div>
          <div class="info">
            <div class="cat-line"><span class="sub-icon">${subcategoryIcons[p.subcategory]||''}</span> ${p.category} &gt; ${p.subcategory}</div>
            <div class="loc-line"><span class="badge" title="Venue">📍</span><span>${p.city}</span></div>
            <div class="date-line"><span class="badge" title="Dates">📅</span><span>${formatDates(p.dates)}</span></div>
          </div>
        </div>
        <button class="fav" aria-pressed="${p.fav?'true':'false'}" aria-label="Toggle favourite">
          <svg viewBox="0 0 24 24"><path d="M12 17.3 6.2 21l1.6-6.7L2 9.3l6.9-.6L12 2l3.1 6.7 6.9.6-5.8 4.9L17.8 21 12 17.3z"/></svg>
        </button>
      `;
      el.style.background = CARD_SURFACE;
      el.querySelector('.fav').addEventListener('click', (e)=>{
        e.stopPropagation();
        p.fav = !p.fav;
        favSortDirty = true;
        document.querySelectorAll(`[data-id="${p.id}"] .fav`).forEach(btn=>{
          btn.setAttribute('aria-pressed', p.fav ? 'true' : 'false');
        });
        renderHistoryBoard();
      });
      return el;
    }

    // History board
    function loadHistory(){ try{ return JSON.parse(localStorage.getItem('openHistoryV2')||'[]'); }catch(e){ return []; } }
    function saveHistory(){ localStorage.setItem('openHistoryV2', JSON.stringify(viewHistory)); }
    function formatLastOpened(ts){
      if(!ts) return '';
      const diff = Date.now() - ts;
      const mins = Math.floor(diff/60000);
      let ago;
      if(mins < 60){
        ago = mins + ' minute' + (mins===1?'':'s');
      } else if(mins < 1440){
        const hrs = Math.floor(mins/60);
        ago = hrs + ' hour' + (hrs===1?'':'s');
      } else {
        const days = Math.floor(mins/1440);
        ago = days + ' day' + (days===1?'':'s');
      }
      const d = new Date(ts);
      const weekday = d.toLocaleDateString('en-GB', {weekday:'short'});
      const day = d.getDate();
      const month = d.toLocaleDateString('en-GB', {month:'short'});
      const year = d.getFullYear();
      const hour = String(d.getHours()).padStart(2,'0');
      const minute = String(d.getMinutes()).padStart(2,'0');
      return `Last opened ${ago} ago - ${weekday} ${day} ${month}, ${year} ${hour}:${minute}`;
    }

    function captureState(){
      const {start,end} = orderedRange();
      const openCats = Object.values(categoryControllers).filter(ctrl=>ctrl.getOpenState && ctrl.getOpenState()).map(ctrl=>ctrl.name);
      return {
        bounds: map ? map.getBounds().toArray() : null,
        kw: $('#keyword-textbox').value,
        date: $('#daterange-textbox').value,
        start: start ? toISODate(start) : null,
        end: end ? toISODate(end) : null,
        expired: $('#expiredToggle').checked,
        cats: [...selection.cats],
        subs: [...selection.subs],
        openCats
      };
    }

    function restoreState(st){
      if(!st) return;
      $('#keyword-textbox').value = st.kw || '';
      dateStart = st.start ? parseISODate(st.start) : null;
      dateEnd = st.end ? parseISODate(st.end) : null;
      if(!st.start && st.range){
        const parts = st.range.split(' to ').map(s=>s.trim());
        if(parts[0]) dateStart = parseISODate(parts[0]);
        if(parts[1]) dateEnd = parseISODate(parts[1]);
      }
      $('#expiredToggle').checked = st.expired || false;
      if($('#expiredToggle').checked){
        buildFilterCalendar(minPickerDate, maxPickerDate);
      } else {
        buildFilterCalendar(today, maxPickerDate);
      }
      if(dateStart){
        const sIso = toISODate(dateStart);
        const sDisp = fmtShort(sIso);
        if(dateEnd && dateEnd.getTime() !== dateStart.getTime()){
          const eIso = toISODate(dateEnd);
          const eDisp = fmtShort(eIso);
          $('#daterange-textbox').value = `${sDisp} - ${eDisp}`;
        } else {
          $('#daterange-textbox').value = sDisp;
        }
      } else {
        $('#daterange-textbox').value = '';
      }
      expiredWasOn = $('#expiredToggle').checked;
      updateRangeClasses();
      updateInput();
      const savedCatsArray = Array.isArray(st.cats) && st.cats.length ? st.cats : categories.map(cat=>cat.name);
      const savedCats = new Set(savedCatsArray);
      const savedSubsArray = Array.isArray(st.subs) ? st.subs : null;
      const subsToUse = savedSubsArray && savedSubsArray.length ? savedSubsArray : allSubcategoryKeys;
      const openCats = Array.isArray(st.openCats) ? new Set(st.openCats) : null;
      selection.cats = new Set();
      selection.subs = new Set(subsToUse);
      const controllers = Object.values(categoryControllers);
      if(controllers.length){
        controllers.forEach(ctrl=>{
          const active = savedCats.has(ctrl.name);
          ctrl.setActive(active, {silent:true});
          const shouldOpen = active && (openCats ? openCats.has(ctrl.name) : false);
          ctrl.setOpen(shouldOpen);
          ctrl.syncSubs();
        });
      } else {
        selection.cats = new Set(savedCatsArray);
      }
      if(map && st.bounds){
        stopSpin();
        const bounds = new mapboxgl.LngLatBounds(st.bounds);
        map.fitBounds(bounds, {padding:10});
        postPanel = bounds;
      }
      applyFilters();
      updateClearButtons();
      updateCategoryResetBtn();
    }
    function renderHistoryBoard(){
      if(!recentsBoard) return;
      recentsBoard.innerHTML='';
      viewHistory = viewHistory.filter(v => posts.some(p => p.id === v.id));
      saveHistory();
      const items = viewHistory.slice(0,100);
      for(const v of items){
        const p = posts.find(x=>x.id===v.id);
        if(!p) continue;
        if(!v.lastOpened) v.lastOpened = Date.now();
        const labelEl = document.createElement('div');
        labelEl.className = 'last-opened-label';
        labelEl.textContent = formatLastOpened(v.lastOpened);
        recentsBoard.appendChild(labelEl);
        const el = card(p);
        recentsBoard.appendChild(el);
      }
      const reminderWrap = document.createElement('div');
      reminderWrap.className = 'recents-board-reminder';
      const reminderImg = document.createElement('img');
      reminderImg.src = 'assets/monkeys/Firefly_cute-little-monkey-in-red-cape-pointing-up-937096.png';
      reminderImg.alt = 'Cute little monkey in red cape pointing up';
      reminderWrap.appendChild(reminderImg);
      const reminderMsg = document.createElement('p');
      reminderMsg.textContent = 'When you log in as a member, I can remember your recent posts and favourites on any device.';
      reminderWrap.appendChild(reminderMsg);
      recentsBoard.appendChild(reminderWrap);
    }

    renderHistoryBoard();

function openPostModal(id){
      const p = posts.find(x=>x.id===id);
      if(!p) return;
      activePostId = id;
      updateSelectedMarkerRing();
      const container = document.getElementById('post-modal-container');
      if(!container) return;
      const modal = container.querySelector('.post-modal');
      modal.innerHTML='';
      const wrap = document.createElement('div');
      wrap.className = 'post-board';
      const detail = buildDetail(p);
      const headerEl = detail.querySelector('.post-header');
      const favBtn = headerEl && headerEl.querySelector('.fav');
      if(headerEl && favBtn){
        const closeBtn = document.createElement('button');
        closeBtn.type='button';
        closeBtn.className='close-post';
        closeBtn.setAttribute('aria-label','Close post');
        closeBtn.textContent='✖';
        closeBtn.style.marginLeft='10px';
        favBtn.after(closeBtn);
        closeBtn.addEventListener('click', e=>{ e.stopPropagation(); closePostModal(); });
      }
      wrap.appendChild(detail);
      modal.appendChild(wrap);
      hookDetailActions(detail, p);
      container.classList.remove('hidden');
      if(!panelStack.includes(container)) panelStack.push(container);
      bringToTop(container);
      requestAnimationFrame(()=>{
        const imgArea = detail.querySelector('.post-images');
        const text = detail.querySelector('.post-details');
        if(headerEl){
          headerEl.style.position='sticky';
          headerEl.style.top='0';
          headerEl.style.zIndex='2';
        }
        if(imgArea && text && text.offsetTop === imgArea.offsetTop){
          imgArea.style.position='sticky';
          imgArea.style.top = headerEl ? headerEl.offsetHeight + 'px' : '0';
        }
      });
      viewHistory = viewHistory.filter(x=>x.id!==id);
      viewHistory.unshift({id:p.id, title:p.title, url:postUrl(p), lastOpened: Date.now()});
      if(viewHistory.length>100) viewHistory.length=100;
      saveHistory(); renderHistoryBoard();
      location.hash = `/post/${p.slug}-${p.created}`;
    }

    function closePostModal(){
      const container = document.getElementById('post-modal-container');
      if(!container) return;
      container.classList.add('hidden');
      const idx = panelStack.indexOf(container);
      if(idx!==-1) panelStack.splice(idx,1);
      const modal = container.querySelector('.post-modal');
      if(modal) modal.innerHTML='';
      location.hash = '';
    }
    window.closePostModal = closePostModal;

    function handleHash(){
      if(!location.hash){
        closePostModal();
        return;
      }
      const m = location.hash.match(/\/post\/([^\/]+)-([^\/]+)$/);
      if(!m || !(Array.isArray(posts) && posts.length)) return;
      const slug = decodeURIComponent(m[1]);
      const created = m[2];
      const post = posts.find(x=>x.slug===slug && x.created===created);
      if(post){ openPostModal(post.id); }
    }

    window.addEventListener('hashchange', handleHash);

    window.addEventListener('resize', ()=>{});

    document.addEventListener('DOMContentLoaded', ()=>{
      const container = document.getElementById('post-modal-container');
      if(container){
        container.addEventListener('click', e=>{ if(e.target===container) closePostModal(); });
      }
      handleHash();
    });

    document.addEventListener('click', (ev)=>{
      const card = ev.target.closest('.mapboxgl-popup.map-card .map-card');
      if(card){
        ev.preventDefault();
        const pid = card.getAttribute('data-id') || (card.closest('.map-card-list-item') && card.closest('.map-card-list-item').getAttribute('data-id'));
        if(pid){
          callWhenDefined('openPost', (fn)=>{
            requestAnimationFrame(() => {
              try{
                touchMarker = null;
                stopSpin();
                if(typeof closePanel === 'function' && typeof filterPanel !== 'undefined' && filterPanel){
                  try{ closePanel(filterPanel); }catch(err){}
                }
                fn(pid, false, true);
              }catch(err){ console.error(err); }
            });
          });
        }
      }
    }, { capture:true });

    function hookDetailActions(el, p){
      el.querySelectorAll('.post-header').forEach(headerEl => {
        headerEl.addEventListener('click', evt=>{
          if(evt.target.closest('button')) return;
          evt.stopPropagation();
          closeActivePost();
        });
      });
      el.querySelectorAll('.fav').forEach(favBtn => {
        favBtn.addEventListener('click', (e)=>{
          e.stopPropagation();
          p.fav = !p.fav;
          favSortDirty = true;
          document.querySelectorAll(`[data-id="${p.id}"] .fav`).forEach(btn=>{
            btn.setAttribute('aria-pressed', p.fav ? 'true' : 'false');
          });
          const detailEl = el;
          renderHistoryBoard();
          const replacement = postsWideEl.querySelector(`[data-id="${p.id}"]`);
          if(replacement){
            replacement.replaceWith(detailEl);
          }
        });
      });

      el.querySelectorAll('.share').forEach(shareBtn => {
        shareBtn.addEventListener('click', (e)=>{
          e.stopPropagation();
          const url = postUrl(p);
          navigator.clipboard.writeText(url).then(()=>{ showCopyMsg(shareBtn); });
        });
      });

      const descEl = el.querySelector('.post-details .desc');
      if(descEl){
        const toggleDesc = evt => {
          const allowed = ['Enter', ' ', 'Spacebar', 'Space'];
          if(evt.type === 'keydown' && !allowed.includes(evt.key)){
            return;
          }
          evt.preventDefault();
          const expanded = !descEl.classList.contains('expanded');
          descEl.classList.toggle('expanded', expanded);
          descEl.setAttribute('aria-expanded', expanded ? 'true' : 'false');
          const openPostEl = el;
          if(openPostEl){
            openPostEl.classList.toggle('desc-expanded', expanded);
          }
          if(expanded){
            document.body.classList.remove('open-post-sticky-images');
          } else if(typeof updateStickyImages === 'function'){
            updateStickyImages();
          }
        };
        descEl.addEventListener('click', toggleDesc);
        descEl.addEventListener('keydown', toggleDesc);
      }

      const imgs = p.images && p.images.length ? p.images : [imgHero(p)];
      const thumbCol = el.querySelector('.thumbnail-row');
      const imageBox = el.querySelector('.image-box');
      const imageTrack = imageBox ? imageBox.querySelector('.image-track') : null;
      const baseImg = imageTrack ? imageTrack.querySelector('img') : null;
      const slides = [];
      if(imageBox){
        imageBox._modalImages = imgs.slice();
        try {
          imageBox.dataset.modalImages = JSON.stringify(imgs);
        } catch(err) {
          imageBox.dataset.modalImages = '';
        }
        if(typeof imageBox.dataset.index === 'undefined'){
          imageBox.dataset.index = '0';
        }
      }
      if(baseImg){
        baseImg.dataset.index = '0';
        baseImg.dataset.full = imgs[0];
        if(!baseImg.classList.contains('ready')){
          baseImg.classList.add('lqip');
        }
        slides[0] = baseImg;
      }
      if(imageTrack){
        imageTrack.style.transform = 'translateX(0)';
      }
      for(let i=1;i<imgs.length;i++){
        if(!imageTrack) break;
        const slide = document.createElement('img');
        slide.dataset.index = i;
        slide.dataset.full = imgs[i];
        slide.alt = '';
        slide.decoding = 'async';
        slide.loading = 'lazy';
        slide.classList.add('lqip');
        slide.src = imgs[i];
        imageTrack.appendChild(slide);
        slides[i] = slide;
      }
      if(thumbCol){
        imgs.forEach((url,i)=>{
          const t = document.createElement('img');
          t.src = url;
          t.dataset.full = url;
          t.dataset.index = i;
          t.tabIndex = 0;
          thumbCol.appendChild(t);
        });
      }
      const clampIdx = idx => Math.min(Math.max(idx, 0), imgs.length - 1);
      let currentIdx = 0;
      const ensureSlide = idx => {
        if(!imageTrack) return null;
        if(!slides[idx]){
          const slide = document.createElement('img');
          slide.dataset.index = idx;
          slide.dataset.full = imgs[idx];
          slide.alt = '';
          slide.decoding = 'async';
          slide.loading = 'lazy';
          slide.classList.add('lqip');
          slide.src = imgs[idx];
          imageTrack.appendChild(slide);
          slides[idx] = slide;
        }
        return slides[idx];
      };
      const scrollThumbIntoView = target => {
        if(!thumbCol || !target) return;
        const rowRect = thumbCol.getBoundingClientRect();
        const tRect = target.getBoundingClientRect();
        if(tRect.left < rowRect.left){
          thumbCol.scrollBy({left: tRect.left - rowRect.left - 8, behavior:'smooth'});
        } else if(tRect.right > rowRect.right){
          thumbCol.scrollBy({left: tRect.right - rowRect.right + 8, behavior:'smooth'});
        }
      };
      const moveTo = (idx, {instant=false}={})=>{
        if(!imageTrack) return;
        if(instant){
          imageTrack.style.transition = 'none';
        }
        const apply = ()=>{ imageTrack.style.transform = `translateX(-${idx * 100}%)`; };
        if(instant){
          apply();
          requestAnimationFrame(()=>{ imageTrack.style.transition = ''; });
        } else {
          apply();
        }
      };
      function show(idx, {instant=false}={}){
        idx = clampIdx(idx);
        const t = thumbCol ? thumbCol.querySelector(`img[data-index="${idx}"]`) : null;
        const slide = ensureSlide(idx);
        if(!slide) return;
        const prevIdx = currentIdx;
        const alreadyReady = slide.classList.contains('ready');
        currentIdx = idx;
        if(prevIdx !== idx || instant){
          moveTo(idx, {instant});
        }
        if(imageBox){
          imageBox.dataset.index = idx;
        }
        if(slides.length){
          slides.forEach((img,i)=>{
            if(img){
              img.classList.toggle('active', i===idx);
            }
          });
        }
        if(t && thumbCol){
          thumbCol.querySelectorAll('img').forEach(im=> im.classList.toggle('selected', im===t));
          scrollThumbIntoView(t);
        }
        if(t && slide.src !== t.src){
          slide.src = t.src;
        }
        const full = (t && (t.dataset.full || t.src)) || slide.dataset.full || slide.src;
        if(!slide.dataset.full){
          slide.dataset.full = full;
        }
        if(!alreadyReady || slide.src !== full){
          slide.classList.remove('ready');
          slide.classList.add('lqip');
          const hi = new Image();
          hi.onload = ()=>{
            const swap = ()=>{
              if(slide.dataset.full !== full){ slide.dataset.full = full; }
              slide.src = full;
              slide.classList.remove('lqip');
              slide.classList.add('ready');
            };
            if(hi.decode){ hi.decode().then(swap).catch(swap); } else { swap(); }
          };
          hi.onerror = ()=>{};
          hi.src = full;
        }
      }
      show(0, {instant:true});
      if(thumbCol){
        thumbCol.scrollLeft = 0;
        setupHorizontalWheel(thumbCol);
        thumbCol.addEventListener('click', e=>{
          const t = e.target.closest('img');
          if(!t) return;
          const idx = clampIdx(parseInt(t.dataset.index,10));
          if(currentIdx === idx && t.classList.contains('selected')){
            const fullSrc = t.dataset.full || t.src;
            openImageModal(fullSrc, {images: imgs, startIndex: idx, origin: t});
          } else {
            show(idx);
          }
        });
        thumbCol.addEventListener('keydown', e=>{
          if(e.key==='ArrowDown'){
            e.preventDefault();
            const ni = clampIdx(currentIdx + 1);
            show(ni);
            const nextThumb = thumbCol.querySelector(`img[data-index="${ni}"]`);
            if(nextThumb) nextThumb.focus();
          } else if(e.key==='ArrowUp'){
            e.preventDefault();
            const ni = clampIdx(currentIdx - 1);
            show(ni);
            const prevThumb = thumbCol.querySelector(`img[data-index="${ni}"]`);
            if(prevThumb) prevThumb.focus();
          }
        });
      }
      if(imageBox){
        let dragStartX = null;
        let dragStartY = null;
        let dragActive = false;
        let lastDragTime = 0;
        const resetDragState = ()=>{
          dragStartX = null;
          dragStartY = null;
          dragActive = false;
          if(imageTrack){
            imageTrack.style.transition = '';
          }
        };
        imageBox.addEventListener('click', e=>{
          if(Date.now() - lastDragTime < 400){
            e.preventDefault();
            return;
          }
          const imgTarget = e.target.closest('.image-track img');
          if(!imgTarget) return;
          e.stopPropagation();
          const currentSlide = ensureSlide(currentIdx) || slides[currentIdx] || imgTarget;
          const fullSrc = currentSlide ? (currentSlide.dataset.full || currentSlide.src) : imgs[currentIdx];
          openImageModal(fullSrc, {images: imgs, startIndex: currentIdx, origin: imgTarget});
        });
        imageBox.addEventListener('touchstart', e=>{
          if(e.touches.length !== 1) return;
          dragStartX = e.touches[0].clientX;
          dragStartY = e.touches[0].clientY;
          dragActive = false;
        });
        imageBox.addEventListener('touchmove', e=>{
          if(dragStartX===null || !imageTrack) return;
          const touch = e.touches[0];
          const deltaX = touch.clientX - dragStartX;
          const deltaY = touch.clientY - dragStartY;
          if(!dragActive){
            if(Math.abs(deltaX) < 5) return;
            if(Math.abs(deltaY) > Math.abs(deltaX)){
              resetDragState();
              return;
            }
            dragActive = true;
            imageTrack.style.transition = 'none';
          }
          const width = imageBox.clientWidth || 1;
          let adjustedDelta = deltaX;
          if((currentIdx === 0 && adjustedDelta > 0) || (currentIdx === imgs.length-1 && adjustedDelta < 0)){
            adjustedDelta *= 0.3;
          }
          const deltaPercent = (adjustedDelta / width) * 100;
          const basePercent = -currentIdx * 100;
          imageTrack.style.transform = `translateX(${basePercent + deltaPercent}%)`;
          e.preventDefault();
        }, {passive:false});
        imageBox.addEventListener('touchend', e=>{
          if(dragStartX===null){
            resetDragState();
            return;
          }
          const deltaX = e.changedTouches[0].clientX - dragStartX;
          if(imageTrack){
            imageTrack.style.transition = '';
          }
          if(dragActive){
            const prevIdx = currentIdx;
            let targetIdx = prevIdx;
            const threshold = (imageBox.clientWidth || 1) * 0.15;
            if(deltaX <= -threshold && prevIdx < imgs.length - 1){
              targetIdx = prevIdx + 1;
            } else if(deltaX >= threshold && prevIdx > 0){
              targetIdx = prevIdx - 1;
            }
            lastDragTime = Date.now();
            requestAnimationFrame(()=> show(targetIdx));
          }
          resetDragState();
        });
        imageBox.addEventListener('touchcancel', ()=>{
          if(dragActive && imageTrack){
            imageTrack.style.transition = '';
            requestAnimationFrame(()=> show(currentIdx));
          }
          resetDragState();
        });
      }
      const venueDropdown = el.querySelector(`#venue-${p.id}`);
      const venueBtn = venueDropdown ? venueDropdown.querySelector('.venue-btn') : null;
      const venueMenu = venueDropdown ? venueDropdown.querySelector('.venue-menu') : null;
      const venueOptions = venueMenu ? venueMenu.querySelector('.venue-options') : null;
      let venueCloseTimer = null;
      const venueInfo = el.querySelector(`#venue-info-${p.id}`);
      const sessDropdown = el.querySelector(`#sess-${p.id}`);
      const sessBtn = sessDropdown ? sessDropdown.querySelector('.sess-btn') : null;
      const sessMenu = sessDropdown ? sessDropdown.querySelector('.session-menu') : null;
      const sessionOptions = sessMenu ? sessMenu.querySelector('.session-options') : null;
      const showMenu = menu => { if(menu) menu.removeAttribute('hidden'); };
      const hideMenu = menu => { if(menu) menu.setAttribute('hidden',''); };
      const isMenuOpen = menu => !!(menu && !menu.hasAttribute('hidden'));
      const sessionInfo = el.querySelector(`#session-info-${p.id}`);
      const calendarEl = el.querySelector(`#cal-${p.id}`);
      const mapEl = el.querySelector(`#map-${p.id}`);
      const calContainer = el.querySelector('.calendar-container');
      const calScroll = calContainer ? calContainer.querySelector('.calendar-scroll') : null;
      if(calScroll){
        setupCalendarScroll(calScroll);
      }
      let map, locationMarkers = [], sessionHasMultiple = false, lastClickedCell = null, resizeHandler = null, detailMapRef = null;
      let currentVenueIndex = 0;

      function updateDetailMarkerSelection(selectedIdx = currentVenueIndex){
        if(!Number.isInteger(selectedIdx)){
          selectedIdx = currentVenueIndex;
        }
        locationMarkers.forEach(({ element, index }) => {
          const isSelected = index === selectedIdx;
          element.classList.toggle('is-selected', isSelected);
          element.classList.toggle('is-dimmed', !isSelected);
          element.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
        });
      }
      let sessionCloseTimer = null;
      let ensureMapForVenue = async ()=>{};
        function scheduleSessionMenuClose({waitForScroll=false, targetLeft=null}={}){
          if(!sessMenu) return;
          if(sessionCloseTimer){
            clearTimeout(sessionCloseTimer);
            sessionCloseTimer = null;
          }
          const begin = ()=>{
            requestAnimationFrame(()=>requestAnimationFrame(()=>{
              sessionCloseTimer = setTimeout(()=>{
                hideMenu(sessMenu);
                if(sessBtn) sessBtn.setAttribute('aria-expanded','false');
                sessionCloseTimer = null;
              }, 100);
            }));
          };
          if(waitForScroll && calScroll && targetLeft !== null){
            let attempts = 0;
            const maxAttempts = 60;
            const check = ()=>{
              const distance = Math.abs(calScroll.scrollLeft - targetLeft);
              if(distance <= 0.5 || attempts >= maxAttempts){
                begin();
              } else {
                attempts += 1;
                requestAnimationFrame(check);
              }
            };
            requestAnimationFrame(check);
          } else {
            begin();
          }
        }
        if(mapEl && mapEl._detailMap){
          detailMapRef = mapEl._detailMap;
          map = detailMapRef.map || map;
          resizeHandler = detailMapRef.resizeHandler || resizeHandler;
          if(!el._detailMap){
            el._detailMap = detailMapRef;
          }
        }
      function updateVenue(idx){
        const locations = Array.isArray(p.locations) ? p.locations : [];
        const hasLocations = locations.length > 0;
        let targetIndex = Number.isInteger(idx) ? idx : 0;
        if(hasLocations){
          targetIndex = Math.min(Math.max(targetIndex, 0), locations.length - 1);
        } else {
          targetIndex = 0;
        }
        currentVenueIndex = targetIndex;
        const loc = hasLocations ? locations[targetIndex] : null;

        if(venueOptions){
          const buttons = venueOptions.querySelectorAll('button');
          buttons.forEach((button, optionIndex) => {
            button.classList.toggle('selected', optionIndex === targetIndex);
          });
        }

        if(loc){
          setSelectedVenueHighlight(loc.lng, loc.lat);
        } else {
          setSelectedVenueHighlight();
        }

        updateDetailMarkerSelection(targetIndex);

        if(venueBtn){
          if(loc){
            venueBtn.innerHTML = `<span class="venue-name">${loc.venue}</span><span class="venue-address">${loc.address}</span>${p.locations.length>1?'<span class="results-arrow" aria-hidden="true"></span>':''}`;
          } else {
            venueBtn.innerHTML = `<span class="venue-name">${p.city || ''}</span><span class="venue-address">${p.city || ''}</span>`;
          }
        }

        if(venueInfo){
          if(loc){
            venueInfo.innerHTML = `<strong>${loc.venue}</strong><br>${loc.address}`;
          } else {
            venueInfo.innerHTML = '';
          }
        }

        const hasDates = loc && Array.isArray(loc.dates) && loc.dates.length;
        if(!hasDates){
          sessionHasMultiple = false;
          if(sessionInfo){
            sessionInfo.innerHTML = '';
          }
          ensureMapForVenue();
          return;
        }

        loc.dates.sort((a,b)=> a.full.localeCompare(b.full) || a.time.localeCompare(b.time));

        const currentYear = new Date().getFullYear();
        const parseDate = s => {
          const [yy, mm, dd] = s.split('-').map(Number);
          return new Date(yy, mm - 1, dd);
        };
        const formatDate = d => {
          const y = parseDate(d.full).getFullYear();
          return y !== currentYear ? `${d.date}, ${y}` : d.date;
        };

        if(venueInfo){
          venueInfo.innerHTML = `<strong>${loc.venue}</strong><br>${loc.address}`;
        }
        if(venueBtn){
          venueBtn.innerHTML = `<span class="venue-name">${loc.venue}</span><span class="venue-address">${loc.address}</span>${p.locations.length>1?'<span class="results-arrow" aria-hidden="true"></span>':''}`;
        }

        sessionHasMultiple = loc.dates.length > 1;
        let defaultInfoHTML = '';
        if(sessionInfo){
          const firstDate = loc.dates[0];
          const lastDate = loc.dates[loc.dates.length-1];
          const rangeText = `${formatDate(firstDate)} - ${formatDate(lastDate)}`;
          defaultInfoHTML = `<div>💲 ${loc.price} | 📅 ${rangeText}<span style="display:inline-block;margin-left:10px;">(Select Session)</span></div>`;
          sessionInfo.innerHTML = defaultInfoHTML;
        }

        const dateStrings = Array.from(new Set(loc.dates.map(d=>d.full)));
        const allowedSet = new Set(dateStrings);
        const minDate = parseDate(dateStrings[0]);
        const maxDate = parseDate(dateStrings[dateStrings.length-1]);
        let cal = null;
        let selectedIndex = null;

        const months = [];
        if(minDate && maxDate){
          const cursor = new Date(minDate.getFullYear(), minDate.getMonth(), 1);
          const limit = new Date(maxDate.getFullYear(), maxDate.getMonth(), 1);
          while(cursor <= limit){
            months.push(new Date(cursor));
            cursor.setMonth(cursor.getMonth() + 1);
          }
        }

        function markSelected(){
          if(!calendarEl) return;
          calendarEl.querySelectorAll('.day').forEach(d=> d.classList.remove('selected'));
          if(selectedIndex!==null){
            const dt = loc.dates[selectedIndex];
            const cell = calendarEl.querySelector(`.day[data-iso="${dt.full}"]`);
            if(cell) cell.classList.add('selected');
          }
        }

        function scrollCalendarToMonth(dt, {smooth=false}={}){
          if(!dt || !calendarEl || !calScroll) return null;
          const cell = calendarEl.querySelector(`.day[data-iso="${dt.full}"]`);
          if(!cell) return null;
          const monthEl = cell.closest('.month');
          if(!monthEl) return null;
          const currentLeft = calScroll.scrollLeft;
          let targetLeft = monthEl.offsetLeft;
          if(typeof monthEl.getBoundingClientRect === 'function' && typeof calScroll.getBoundingClientRect === 'function'){
            const monthRect = monthEl.getBoundingClientRect();
            const scrollRect = calScroll.getBoundingClientRect();
            const delta = monthRect.left - scrollRect.left;
            const adjusted = currentLeft + delta;
            if(Number.isFinite(adjusted)){
              targetLeft = adjusted;
            }
          }
          const maxLeft = Math.max(0, calScroll.scrollWidth - calScroll.clientWidth);
          targetLeft = Math.min(Math.max(targetLeft, 0), maxLeft);
          const distance = Math.abs(currentLeft - targetLeft);
          if(typeof calScroll.scrollTo === 'function'){
            if(smooth && distance > 1){
              calScroll.scrollTo({left: targetLeft, behavior: 'smooth'});
              return {targetLeft, waitForScroll: true};
            }
            calScroll.scrollTo({left: targetLeft});
          } else {
            calScroll.scrollLeft = targetLeft;
          }
          return {targetLeft, waitForScroll: false};
        }

        function selectSession(i){
          if(!sessMenu || !sessionOptions) return;
          selectedIndex = Number.isInteger(i) ? i : null;
          sessionOptions.querySelectorAll('button').forEach(b=> b.classList.remove('selected'));
          const btn = selectedIndex !== null ? sessionOptions.querySelector(`button[data-index="${selectedIndex}"]`) : null;
          if(btn) btn.classList.add('selected');
          const dt = selectedIndex !== null ? loc.dates[selectedIndex] : null;
          let waitForScroll = false;
          let targetScrollLeft = null;
          if(dt){
            if(sessionInfo){
              sessionInfo.innerHTML = `<div><strong>${formatDate(dt)} ${dt.time}</strong></div><div>Adults $20, Kids $10, Pensioners $15</div><div>🎫 Buy at venue | ♿ Accessible | 👶 Kid-friendly</div>`;
            }
            if(sessBtn){
              sessBtn.innerHTML = `<span class="session-date">${formatDate(dt)}</span><span class="session-time">${dt.time}</span>${sessionHasMultiple?'<span class="results-arrow" aria-hidden="true"></span>':''}`;
            }
            markSelected();
            const scrollResult = scrollCalendarToMonth(dt, {smooth: true});
            if(scrollResult){
              targetScrollLeft = scrollResult.targetLeft;
              waitForScroll = scrollResult.waitForScroll;
            }
          } else {
            if(sessionInfo){
              sessionInfo.innerHTML = defaultInfoHTML;
            }
            if(sessBtn){
              sessBtn.innerHTML = sessionHasMultiple ? 'Select Session<span class="results-arrow" aria-hidden="true"></span>' : 'Select Session';
              sessBtn.setAttribute('aria-expanded','false');
            }
            markSelected();
          }
          if(isMenuOpen(sessMenu)){
            scheduleSessionMenuClose({waitForScroll, targetLeft: targetScrollLeft});
          } else if(sessBtn){
            sessBtn.setAttribute('aria-expanded','false');
          }
        }

        function showTimePopup(matches){
          if(!calContainer) return;
          const existing = calContainer.querySelector('.time-popup');
          if(existing) existing.remove();
          const popup = document.createElement('div');
          popup.className = 'time-popup';
          popup.innerHTML = `<div class="time-list">${matches.map(m=>`<button data-index="${m.i}">${m.d.time}</button>`).join('')}</div>`;
          calContainer.appendChild(popup);
          if(lastClickedCell){
            const rect = lastClickedCell.getBoundingClientRect();
            const containerRect = calContainer.getBoundingClientRect();
            popup.style.left = (rect.left - containerRect.left) + 'px';
            popup.style.top = (rect.bottom - containerRect.top + 4) + 'px';
          }
          popup.querySelectorAll('button').forEach(b=> b.addEventListener('click',()=>{ selectSession(parseInt(b.dataset.index,10)); popup.remove(); }));
          setTimeout(()=> document.addEventListener('click', function handler(e){ if(!popup.contains(e.target)){ popup.remove(); document.removeEventListener('click', handler); } }),0);
        }

        function renderMonth(monthDate){
          if(!cal) return;
          const monthEl = document.createElement('div');
          monthEl.className='month';
          const header = document.createElement('div');
          header.className='calendar-header';
          header.textContent = monthDate.toLocaleDateString('en-GB',{month:'long',year:'numeric'});
          monthEl.appendChild(header);
          const grid = document.createElement('div');
          grid.className='grid';
          ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(wd=>{
            const w=document.createElement('div');
            w.className='weekday';
            w.textContent=wd;
            grid.appendChild(w);
          });
          const firstDay = new Date(monthDate.getFullYear(), monthDate.getMonth(),1);
          const startDow = firstDay.getDay();
          const daysInMonth = new Date(monthDate.getFullYear(), monthDate.getMonth()+1,0).getDate();
          const totalCells = 42;
          for(let i=0;i<totalCells;i++){
            const cell=document.createElement('div');
            cell.className='day';
            const dayNum=i-startDow+1;
            if(i<startDow || dayNum>daysInMonth){
              cell.classList.add('empty');
            }else{
              cell.textContent=dayNum;
              const dateObj=new Date(monthDate.getFullYear(), monthDate.getMonth(), dayNum);
              const iso=toISODate(dateObj);
              cell.dataset.iso = iso;
              if(allowedSet.has(iso)){
                cell.classList.add('available-day');
                cell.addEventListener('mousedown',()=>{ lastClickedCell = cell; });
                cell.addEventListener('click',()=>{
                  const matches = loc.dates.map((dd,i)=>({i,d:dd})).filter(o=> o.d.full===iso);
                  if(matches.length===1){ selectSession(matches[0].i); }
                  else if(matches.length>1){ showTimePopup(matches); }
                });
              } else {
                cell.classList.add('empty');
              }
              if(isToday(dateObj)) cell.classList.add('today');
            }
            grid.appendChild(cell);
          }
          monthEl.appendChild(grid);
          cal.appendChild(monthEl);
        }

        function buildCalendarShell(){
          if(!calendarEl) return;
          calendarEl.innerHTML='';
          cal = document.createElement('div');
          cal.className='calendar';
          calendarEl.appendChild(cal);
          calendarEl.addEventListener('click', e=> e.stopPropagation());
        }

        function finalizeCalendar(){
          markSelected();
        }

        function updateSessionOptionsList(){
          if(sessionOptions){
            sessionOptions.innerHTML = loc.dates.map((d,i)=> `<button data-index="${i}"><span class="session-date">${formatDate(d)}</span><span class="session-time">${d.time}</span></button>`).join('');
            if(sessMenu){
              sessMenu.scrollTop = 0;
            }
            if(sessionHasMultiple){
              if(sessionInfo) sessionInfo.innerHTML = defaultInfoHTML;
              if(sessBtn){ sessBtn.innerHTML = 'Select Session<span class="results-arrow" aria-hidden="true"></span>'; sessBtn.setAttribute('aria-expanded','false'); }
            } else if(loc.dates.length){
              selectSession(0);
            } else {
              if(sessionInfo) sessionInfo.innerHTML = defaultInfoHTML;
              if(sessBtn){ sessBtn.textContent = 'Select Session'; sessBtn.setAttribute('aria-expanded','false'); }
            }
            sessionOptions.querySelectorAll('button').forEach(btn=>{
              btn.addEventListener('click', ()=> selectSession(parseInt(btn.dataset.index,10)));
            });
          }
          setTimeout(()=>{
            if(map && typeof map.resize === 'function') map.resize();
          },0);
        }

        function attachSessionButtonHandler(){
          if(!sessBtn || !sessMenu) return;
          const handler = ()=>{
            const expanded = sessBtn.getAttribute('aria-expanded') === 'true';
            const opening = !expanded;
            sessBtn.setAttribute('aria-expanded', String(opening));
            if(opening){
              showMenu(sessMenu);
              if(selectedIndex !== null){
                const dt = loc.dates[selectedIndex];
                if(dt){
                  requestAnimationFrame(()=> scrollCalendarToMonth(dt));
                }
              }
            } else {
              hideMenu(sessMenu);
            }
          };
          if(sessBtn._sessionToggle){
            sessBtn.removeEventListener('click', sessBtn._sessionToggle);
          }
          sessBtn._sessionToggle = handler;
          sessBtn.addEventListener('click', handler);
        }

        ensureMapForVenue = async function(){
          if(!mapEl) return;

          const allLocations = Array.isArray(p.locations) ? p.locations.filter(item => item && Number.isFinite(item.lng) && Number.isFinite(item.lat)) : [];
          if(!allLocations.length){
            locationMarkers.forEach(({ marker }) => { try{ marker.remove(); }catch(e){} });
            locationMarkers = [];
            return;
          }

          const selectedIdx = Math.min(Math.max(currentVenueIndex, 0), allLocations.length - 1);
          const selectedLoc = allLocations[selectedIdx];
          const center = [selectedLoc.lng, selectedLoc.lat];
          const subId = subcategoryMarkerIds[p.subcategory] || slugify(p.subcategory);
          const markerUrl = subcategoryMarkers[subId];

          const assignDetailRef = ()=>{
            detailMapRef = detailMapRef || {};
            detailMapRef.map = map;
            detailMapRef.resizeHandler = resizeHandler;
            if(mapEl){
              mapEl._detailMap = detailMapRef;
              mapEl.__map = map;
            }
            if(el){
              el._detailMap = detailMapRef;
            }
            if(map){
              MapRegistry.register(map);
            }
          };

          const refreshMarkers = () => {
            if(!map) return;
            locationMarkers.forEach(({ marker }) => { try{ marker.remove(); }catch(e){} });
            locationMarkers = [];
            allLocations.forEach((location, idx) => {
              if(!Number.isFinite(location.lng) || !Number.isFinite(location.lat)){
                return;
              }
              let element;
              if(markerUrl){
                element = new Image();
                element.src = markerUrl;
                element.alt = '';
                element.decoding = 'async';
              } else {
                element = document.createElement('div');
                element.style.background = '#0f172a';
              }
              element.classList.add('post-location-marker');
              element.dataset.index = String(idx);
              element.tabIndex = 0;
              element.setAttribute('role', 'button');
              element.setAttribute('aria-pressed', 'false');
              element.setAttribute('aria-label', `${location.venue} (${location.address})`);
              element.addEventListener('click', () => {
                if(idx === currentVenueIndex) return;
                updateVenue(idx);
              });
              element.addEventListener('keydown', evt => {
                if(evt.key === 'Enter' || evt.key === ' ' || evt.key === 'Spacebar'){
                  evt.preventDefault();
                  element.click();
                }
              });
              const markerInstance = new mapboxgl.Marker({ element, anchor: 'center' }).setLngLat([location.lng, location.lat]).addTo(map);
              locationMarkers.push({ marker: markerInstance, element, index: idx });
            });
            updateDetailMarkerSelection(selectedIdx);
          };

          const fitToLocations = () => {
            if(!map || !allLocations.length){
              return;
            }
            const validPoints = allLocations.filter(location => Number.isFinite(location.lng) && Number.isFinite(location.lat));
            if(!validPoints.length){
              return;
            }
            if(validPoints.length === 1){
              try{
                map.setCenter([validPoints[0].lng, validPoints[0].lat]);
                map.setZoom(10);
              }catch(e){}
              return;
            }
            try{
              const bounds = validPoints.reduce((acc, location) => {
                if(acc){
                  acc.extend([location.lng, location.lat]);
                  return acc;
                }
                return new mapboxgl.LngLatBounds([location.lng, location.lat], [location.lng, location.lat]);
              }, null);
              if(bounds){
                map.fitBounds(bounds, { padding: 40, duration: 0, maxZoom: 10 });
              }
            }catch(e){}
          };

          if(!map){
            setTimeout(async () => {
              if(map) {
                refreshMarkers();
                fitToLocations();
                return;
              }

              await ensureMapboxCssFor(mapEl);

              if (mapEl && mapEl.__map && typeof mapEl.__map.remove === 'function') {
                try { mapEl.__map.remove(); } catch {}
                mapEl.__map = null;
              }
              locationMarkers.forEach(({ marker }) => { try{ marker.remove(); }catch(e){} });
              locationMarkers = [];

              map = new mapboxgl.Map({
                container: mapEl,
                style: mapStyle,
                center,
                zoom: 3,
                interactive: false
              });

              attachIconLoader(map);

              map.on('mousemove', (e) => {
                const has = !!(e.features && e.features.length);
                map.getCanvas().style.cursor = has ? 'pointer' : '';
              });

              armPointerOnSymbolLayers(map);

              const applyDetailStyleAdjustments = () => {
                applyNightSky(map);
                patchMapboxStyleArtifacts(map);
              };
              whenStyleReady(map, applyDetailStyleAdjustments);
              map.on('style.load', applyDetailStyleAdjustments);
              map.on('styledata', () => {
                if(map.isStyleLoaded && map.isStyleLoaded()){
                  patchMapboxStyleArtifacts(map);
                }
              });

              map.on('styleimagemissing', (e) => {
                if (map.hasImage(e.id)) return;

                const base = document.baseURI || window.location.href;
                const candidates = [
                  `assets/icons/subcategories/${e.id}.png`,
                  `assets/icons/${e.id}.png`,
                  `assets/images/icons/${e.id}.png`,
                  `assets/icons-30/${e.id}-30.webp`,
                  `assets/icons-30/multi-post-icon-30.webp`,
                  `assets/icons/multi-category-icon-blue.png`,
                  `assets/images/icons/multi-category-icon-blue.png`
                ].map(p => new URL(p, base).href);

                (function tryNext(i){
                  if (i >= candidates.length) return;
                  map.loadImage(candidates[i], (err, img) => {
                    if (err || !img) { tryNext(i+1); return; }
                    try { map.addImage(e.id, img, { sdf: true }); } catch {}
                  });
                })(0);
              });

              if(resizeHandler){
                window.removeEventListener('resize', resizeHandler);
              }
              resizeHandler = ()=>{ if(map) map.resize(); };
              window.addEventListener('resize', resizeHandler);

              const ready = () => {
                refreshMarkers();
                fitToLocations();
              };
              if(map.loaded()){
                ready();
              } else {
                map.once('load', ready);
              }

              assignDetailRef();

              setTimeout(()=>{ if(map && typeof map.resize === 'function') map.resize(); },0);
            }, 0);
          } else {
            refreshMarkers();
            fitToLocations();
            setTimeout(()=> map && map.resize(),0);
            assignDetailRef();
          }
        };
        window.ensureMapForVenue = ensureMapForVenue;

        const tasks = [];
        if(mapEl){
          tasks.push(()=> {
            window.callWhenDefined = window.callWhenDefined || function(name, cb, timeoutMs){
              const start = performance.now(), max = timeoutMs ?? 5000;
              (function check(){
                const fn = window[name];
                if (typeof fn === 'function') { try { cb(fn); } catch(e){} return; }
                if (performance.now() - start < max) requestAnimationFrame(check);
              })();
            };
            callWhenDefined('ensureMapForVenue', fn => fn());
          });
        }
        if(calendarEl){
          tasks.push(()=> buildCalendarShell());
          months.forEach(monthDate => tasks.push(()=> renderMonth(monthDate)));
          tasks.push(()=> finalizeCalendar());
        }
        tasks.push(()=> updateSessionOptionsList());
        tasks.push(()=> attachSessionButtonHandler());

        function runNext(){
          const task = tasks.shift();
          if(!task) return;
          const start = performance.now();
          try{ task(); }catch(err){}
          if(performance.now() - start > 6){
            setTimeout(runNext, 0);
          } else {
            runNext();
          }
        }
        runNext();
      }

      window.updateVenue = updateVenue;
      window.ensureMapForVenue = ensureMapForVenue;
      if(typeof window.__wrapForInputYield === 'function'){
        window.__wrapForInputYield('updateVenue');
        window.__wrapForInputYield('ensureMapForVenue');
      }

        if(mapEl){
          setTimeout(()=>{
            loadMapbox(()=>{
              updateVenue(0);
              if(venueMenu && venueBtn && venueOptions){
                venueOptions.querySelectorAll('button').forEach(btn=>{
                  if(btn.dataset.index==='0') btn.classList.add('selected');
                  btn.addEventListener('click', ()=>{
                    venueOptions.querySelectorAll('button').forEach(b=> b.classList.remove('selected'));
                    btn.classList.add('selected');
                    updateVenue(parseInt(btn.dataset.index,10));
                    if(venueCloseTimer){
                      clearTimeout(venueCloseTimer);
                    }
                    venueCloseTimer = setTimeout(()=>{
                    hideMenu(venueMenu);
                    venueBtn.setAttribute('aria-expanded','false');
                    venueCloseTimer = null;
                  }, 100);
                  });
                });
                venueBtn.addEventListener('click', ()=>{
                  const expanded = venueBtn.getAttribute('aria-expanded') === 'true';
                  const opening = !expanded;
                  venueBtn.setAttribute('aria-expanded', String(opening));
                  if(opening){
                    showMenu(venueMenu);
                  } else {
                    hideMenu(venueMenu);
                  }
                  if(opening){
                    setTimeout(()=>{ if(map && typeof map.resize === 'function') map.resize(); },0);
                  }
                });
                document.addEventListener('click', e=>{ if(venueDropdown && !venueDropdown.contains(e.target)){ hideMenu(venueMenu); venueBtn.setAttribute('aria-expanded','false'); } });
              }
              if(sessBtn && sessMenu){
                if(!sessDropdown._sessionOutsideHandler){
                  const outsideHandler = e=>{
                    if(sessDropdown && !sessDropdown.contains(e.target)){
                      hideMenu(sessMenu);
                      sessBtn.setAttribute('aria-expanded','false');
                    }
                  };
                  sessDropdown._sessionOutsideHandler = outsideHandler;
                  document.addEventListener('click', outsideHandler);
                }
              }
              if(map && typeof map.resize === 'function') map.resize();
            });
          },0);
        }
    }

    function inBounds(p){
      if(!postPanel) return true;
      return p.lng >= postPanel.getWest() && p.lng <= postPanel.getEast() &&
             p.lat >= postPanel.getSouth() && p.lat <= postPanel.getNorth();
    }
    function kwMatch(p){ const kw = $('#keyword-textbox').value.trim().toLowerCase(); if(!kw) return true; return (p.title+' '+p.city+' '+p.category+' '+p.subcategory).toLowerCase().includes(kw); }
    function dateMatch(p){
      const {start,end} = orderedRange();
      const expiredChk = $('#expiredToggle');
      if(!start && !end){
        if(expiredChk && expiredChk.checked){
          return true;
        }
        const today = new Date(); today.setHours(0,0,0,0);
        return p.dates.some(d => parseISODate(d) >= today);
      }
      return p.dates.some(d => {
        const dt = parseISODate(d);
        if(start && dt < start) return false;
        if(end && dt > end) return false;
        return true;
      });
    }
    function catMatch(p){
      const haveCategoryControllers = Object.keys(categoryControllers).length > 0;
      if(!haveCategoryControllers){
        return true;
      }
      if(selection.cats.size===0){
        return false;
      }
      const cOk = selection.cats.has(p.category);
      if(!cOk) return false;
      if(selection.subs.size===0){
        return false;
      }
      return selection.subs.has(p.category+'::'+p.subcategory);
    }

    function hideResultIndicators(){
      const resultCountEl = $('#resultCount');
      if(resultCountEl){
        resultCountEl.innerHTML = '';
        resultCountEl.style.display = 'none';
      }
      const summaryEl = $('#filterSummary');
      if(summaryEl){
        summaryEl.textContent = '';
      }
    }

    function updateFilterCounts(){
      if(spinning){
        hideResultIndicators();
        updateResetBtn();
        return;
      }
      if(!postsLoaded) return;
      filtered = posts.filter(p => (spinning || inBounds(p)) && kwMatch(p) && dateMatch(p) && catMatch(p));
      const today = new Date(); today.setHours(0,0,0,0);
      const total = posts.filter(p => (spinning || inBounds(p)) && p.dates.some(d => parseISODate(d) >= today)).length;
      const summary = $('#filterSummary');
      if(summary){ summary.textContent = `${filtered.length} results showing out of ${total} results in the area.`; }
      updateResetBtn();
    }

    function refreshMarkers(render = true){
      if(spinning) return;
      if(!postsLoaded) return;
      const newAdPosts = filtered.filter(p => p.sponsored);
      const ids = newAdPosts.map(p => p.id).join(',');
      if(adPanel && ids !== adIdsKey){
        adPanel.innerHTML = '';
        adIndex = -1;
        if(adTimer){ clearInterval(adTimer); }
        adPosts = newAdPosts;
        if(adPosts.length){
          showNextAd();
          adTimer = setInterval(showNextAd,20000);
        } else {
          const img = document.createElement('img');
          img.src = 'assets/welcome%20001.jpg';
          img.alt = 'Welcome';
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.objectFit = 'cover';
          adPanel.appendChild(img);
        }
        adIdsKey = ids;
      } else {
        adPosts = newAdPosts;
      }
      if(render) renderLists(filtered);
      if(map && map.getSource('posts')){ map.getSource('posts').setData(postsToGeoJSON(filtered)); }
      filtersInitialized = true;
    }

    function applyFilters(render = true){
      if(spinning){
        hideResultIndicators();
        return;
      }
      updateFilterCounts();
      refreshMarkers(render);
    }

    function showNextAd(){
      if(!adPanel || !adPosts.length) return;
      adIndex = (adIndex + 1) % adPosts.length;
      const p = adPosts[adIndex];
      const slide = document.createElement('a');
      slide.className = 'ad-slide';
      slide.dataset.id = p.id;
      slide.href = postUrl(p);
      const img = new Image();
      img.src = heroUrl(p);
      img.alt = '';
      img.decode().catch(()=>{}).then(()=>{
        slide.appendChild(img);
        const info = document.createElement('div');
        info.className = 'info';
        info.textContent = p.title;
        slide.appendChild(info);
        adPanel.appendChild(slide);
        requestAnimationFrame(()=> slide.classList.add('active'));
        const slides = adPanel.querySelectorAll('.ad-slide');
        if(slides.length > 1){
          const old = slides[0];
          old.classList.remove('active');
          setTimeout(()=> old.remove(),1500);
        }
      });
    }

    function initAdBoard(){
      adPanel = document.querySelector('.ad-panel');
      if(!adPanel) return;
      adPanel.addEventListener('click', e => {
        const slide = e.target.closest('.ad-slide');
        if(!slide) return;
        e.preventDefault();
        const id = slide.dataset.id;
        requestAnimationFrame(() => {
          callWhenDefined('openPost', (fn)=>{
            Promise.resolve(fn(id)).then(() => {
              requestAnimationFrame(() => {
                const openEl = document.querySelector(`.post-board .open-post[data-id="${id}"]`);
                if(openEl){
                  requestAnimationFrame(() => { openEl.scrollIntoView({behavior:'smooth', block:'start'}); });
                }
                document.querySelectorAll('.recents-card[aria-selected="true"]').forEach(el=>el.removeAttribute('aria-selected'));
                const quickCard = document.querySelector(`.recents-board .recents-card[data-id="${id}"]`);
                if(quickCard){
                  quickCard.setAttribute('aria-selected','true');
                  requestAnimationFrame(() => {
                    quickCard.scrollIntoView({behavior:'smooth', block:'nearest'});
                  });
                }
              });
            }).catch(err => console.error(err));
          });
        });
      }, { capture: true });
    }

    // applyFilters();
    setMode(mode);
    if(historyWasActive && mode === 'posts'){
      document.body.classList.add('show-history');
      adjustBoards();
    }
    window.addEventListener('beforeunload', () => {
      localStorage.setItem('mode', mode);
      localStorage.setItem('historyActive', document.body.classList.contains('show-history') ? 'true' : 'false');
    });
  })();
  
// 0577 helpers (safety)
function isPortrait(id){ let h=0; for(let i=0;i<id.length;i++){ h=(h<<5)-h+id.charCodeAt(i); h|=0; } return Math.abs(h)%2===0; }
function heroUrl(p){ const id = (typeof p==='string')? p : p.id; const port=isPortrait(id); return `https://picsum.photos/seed/${encodeURIComponent(id)}-t/${port?'800/1200':'1200/800'}`; }
function thumbUrl(p){ const id = (typeof p==='string')? p : p.id; const port=isPortrait(id); return `https://picsum.photos/seed/${encodeURIComponent(id)}-t/${port?'200/300':'300/200'}`; }
function getViewportHeight(){
  return window.innerHeight || document.documentElement.clientHeight || 0;
}
const panelStack = [];
function bringToTop(item){
  const idx = panelStack.indexOf(item);
  if(idx!==-1) panelStack.splice(idx,1);
  panelStack.push(item);
  panelStack.forEach((p,i)=>{
    if(p instanceof Element){ p.style.zIndex = 2000 + i; }
  });
}
function registerPopup(p){
  bringToTop(p);
  if(typeof p.on==='function'){
    p.on('close',()=>{
      const i = panelStack.indexOf(p);
      if(i!==-1) panelStack.splice(i,1);
    });
  }
  const el = p.getElement && p.getElement();
  if(el){
    el.addEventListener('mousedown', ()=> bringToTop(p));
  }
}
function savePanelState(m){
  if(!m || !m.id || m.id === 'welcome-modal') return;
  const content = m.querySelector('.panel-content');
  if(!content) return;
  const state = {
    left: content.style.left,
    top: content.style.top,
    width: content.style.width,
    height: content.style.height
  };
  localStorage.setItem(`panel-${m.id}`, JSON.stringify(state));
}
function loadPanelState(m){
  if(!m || !m.id) return false;
  const content = m.querySelector('.panel-content');
  if(!content) return false;
  const saved = JSON.parse(localStorage.getItem(`panel-${m.id}`) || 'null');
  if(saved){
    ['width','height','left','top'].forEach(prop=>{
      if(saved[prop]) content.style[prop] = saved[prop];
    });
    if(saved.left || saved.top) content.style.transform = 'none';
    return true;
  }
  return false;
}
const panelButtons = {
  filterPanel: 'filterBtn',
  memberPanel: 'memberBtn',
  adminPanel: 'adminBtn'
};
function schedulePanelEntrance(content, force=false){
  if(!content) return;
  if(force){
    content.classList.remove('panel-visible');
  }
  content.style.transform = '';
  if(force || !content.classList.contains('panel-visible')){
    requestAnimationFrame(()=>{
      if(!content.isConnected) return;
      content.classList.add('panel-visible');
    });
  }
}
function openPanel(m){
  const content = m.querySelector('.panel-content') || m.querySelector('.modal-content');
  if(content && m.id !== 'welcome-modal'){
    content.style.width = '';
    content.style.height = '';
  }
  let shouldScheduleEntrance = false;
  if(content){
    const rootStyles = getComputedStyle(document.documentElement);
    const headerH = parseFloat(rootStyles.getPropertyValue('--header-h')) || 0;
    const subH = parseFloat(rootStyles.getPropertyValue('--subheader-h')) || 0;
    const footerH = parseFloat(rootStyles.getPropertyValue('--footer-h')) || 0;
    const safeTop = parseFloat(rootStyles.getPropertyValue('--safe-top')) || 0;
    const viewportHeight = getViewportHeight();
    const innerWidth = window.innerWidth;
    if(m.id==='adminPanel' || m.id==='memberPanel'){
      const topPos = headerH + safeTop;
      const availableHeight = Math.max(0, viewportHeight - footerH - topPos);
      content.style.left='auto';
      content.style.right='0';
      content.style.top=`${topPos}px`;
      content.style.bottom=`${footerH}px`;
      content.style.maxHeight = availableHeight ? `${availableHeight}px` : '';
      content.dataset.side='right';
      if(!content.classList.contains('panel-visible')){
        content.classList.remove('panel-visible');
        shouldScheduleEntrance = true;
      }
    } else if(m.id==='filterPanel'){
      const topPos = headerH + subH + safeTop;
      if(innerWidth < 450){
        content.style.left='0';
        content.style.right='0';
        content.style.top=`${topPos}px`;
        content.style.bottom=`${footerH}px`;
        content.style.maxHeight='';
      } else {
        const availableHeight = Math.max(0, viewportHeight - footerH - topPos);
        content.style.left='0';
        content.style.right='';
        content.style.top=`${topPos}px`;
        content.style.bottom='';
        content.style.maxHeight = availableHeight ? `${availableHeight}px` : '';
      }
      content.dataset.side='left';
      if(!content.classList.contains('panel-visible')){
        content.classList.remove('panel-visible');
        shouldScheduleEntrance = true;
      }
    } else if(m.id==='welcome-modal'){
      const topPos = headerH + safeTop + 10;
      content.style.left='50%';
      content.style.top=`${topPos}px`;
      content.style.transform='translateX(-50%)';
    } else {
      content.style.left='50%';
      content.style.top='50%';
      content.style.transform='translate(-50%, -50%)';
      if(m.id !== 'welcome-modal' && !['adminPanel','memberPanel','filterPanel'].includes(m.id)){
        loadPanelState(m);
      }
    }
  }
  m.classList.add('show');
  m.removeAttribute('aria-hidden');
  m.removeAttribute('inert');
  if(m.id === 'welcome-modal'){
    const mc = document.querySelector('.map-controls-map');
    if(mc) mc.style.display = 'none';
  }
  const btnId = panelButtons[m && m.id];
  if(btnId){
    const btn = document.getElementById(btnId);
    btn && btn.setAttribute('aria-pressed','true');
  }
  localStorage.setItem(`panel-open-${m.id}`,'true');
  if(content && shouldScheduleEntrance){
    schedulePanelEntrance(content);
  }
  if(!m.__bringToTopAdded){
    m.addEventListener('mousedown', ()=> bringToTop(m));
    m.__bringToTopAdded = true;
  }
  bringToTop(m);
  if(map && typeof map.resize === 'function') setTimeout(()=> map.resize(),0);
  if(typeof window.adjustBoards === 'function') setTimeout(()=> window.adjustBoards(), 0);
}
function closePanel(m){
  const btnId = panelButtons[m && m.id];
  if(btnId){
    const btn = document.getElementById(btnId);
    btn && btn.setAttribute('aria-pressed','false');
  }
  const content = m.querySelector('.panel-content') || m.querySelector('.modal-content');
  const active = document.activeElement;
  if(active && m.contains(active)) active.blur();
  if(m.id === 'welcome-modal'){
    const mc = document.querySelector('.map-controls-map');
    if(mc) mc.style.display = '';
  }
  m.setAttribute('inert','');
  if(content && content.dataset.side){
    content.classList.remove('panel-visible');
    content.addEventListener('transitionend', function handler(){
      content.removeEventListener('transitionend', handler);
      m.classList.remove('show');
      m.setAttribute('aria-hidden','true');
      localStorage.setItem(`panel-open-${m.id}`,'false');
      const idx = panelStack.indexOf(m);
      if(idx!==-1) panelStack.splice(idx,1);
      if(map && typeof map.resize === 'function') setTimeout(()=> map.resize(),0);
      if(typeof window.adjustBoards === 'function') setTimeout(()=> window.adjustBoards(), 0);
    }, {once:true});
  } else {
    m.classList.remove('show');
    m.setAttribute('aria-hidden','true');
    localStorage.setItem(`panel-open-${m.id}`,'false');
    const idx = panelStack.indexOf(m);
    if(idx!==-1) panelStack.splice(idx,1);
    if(map && typeof map.resize === 'function') setTimeout(()=> map.resize(),0);
    if(typeof window.adjustBoards === 'function') setTimeout(()=> window.adjustBoards(), 0);
  }
}
const welcomeModalEl = document.getElementById('welcome-modal');
if(welcomeModalEl){
  const welcomeControls = welcomeModalEl.querySelector('.map-controls-welcome');
  welcomeModalEl.addEventListener('click', e => {
    if(welcomeControls && welcomeControls.contains(e.target)) return;
    closePanel(welcomeModalEl);
  });
  const welcomeContent = welcomeModalEl.querySelector('.modal-content');
  if(welcomeContent){
    welcomeContent.addEventListener('click', e => {
      if(welcomeControls && welcomeControls.contains(e.target)) return;
      closePanel(welcomeModalEl);
    });
  }
}
function requestClosePanel(m){
  closePanel(m);
}
function togglePanel(m){
  if(m.classList.contains('show')){
    requestClosePanel(m);
  } else {
    openPanel(m);
  }
}
function movePanelToEdge(panel, side){
  if(!panel) return;
  const content = panel.querySelector('.panel-content') || panel.querySelector('.modal-content');
  if(!content) return;
  const header = document.querySelector('.header');
  const topPos = header ? header.getBoundingClientRect().bottom : 0;
  content.style.top = `${topPos}px`;
  if(side === 'left'){
    content.dataset.side='left';
    content.style.left = '0';
    content.style.right = 'auto';
    schedulePanelEntrance(content, true);
  } else {
    content.dataset.side='right';
    content.style.left = 'auto';
    content.style.right = '0';
    schedulePanelEntrance(content, true);
  }
}
function repositionPanels(){
  ['adminPanel','memberPanel','filterPanel'].forEach(id=>{
    const panel = document.getElementById(id);
    if(panel && panel.classList.contains('show')){
      const content = panel.querySelector('.panel-content');
      if(!content) return;
      const w = content.style.width;
      const h = content.style.height;
      openPanel(panel);
      content.style.width = w;
      content.style.height = h;
    }
  });
}
function handleEsc(){
  const top = panelStack[panelStack.length-1];
  if(!top){
    const {container} = ensureImageModalReady();
    if(container && !container.classList.contains('hidden')){
      closeImageModal(container);
    }
    return;
  }
  if(top instanceof Element){
    if(top.id === 'adminPanel' && typeof window.saveAdminChanges === 'function'){
      window.saveAdminChanges();
    }
    if(top.id === 'post-modal-container'){
      closePostModal();
    } else {
      requestClosePanel(top);
    }
  } else if(typeof top.remove==='function'){
    panelStack.pop();
    top.remove();
  }
}
document.addEventListener('keydown', e=>{
  if(e.key==='Escape') handleEsc();
  else if(e.key==='ArrowLeft' || e.key==='ArrowRight'){
    const top = panelStack[panelStack.length-1];
    if(window.innerWidth >= 450 && top && (top.id==='adminPanel' || top.id==='memberPanel')){
      movePanelToEdge(top, e.key==='ArrowLeft' ? 'left' : 'right');
    }
  }
});

function handleDocInteract(e){
  if(e.target.closest('.image-modal-container')) return;
  if(logoEls.some(el => el.contains(e.target))) return;
  if(e.target.closest('#filterBtn')) return;
  const welcome = document.getElementById('welcome-modal');
  if(welcome && welcome.classList.contains('show')){
    const controls = welcome.querySelector('.map-controls-welcome');
    if(!controls || !controls.contains(e.target)){
      closePanel(welcome);
    }
  }
  const filterPanel = document.getElementById('filterPanel');
  if(filterPanel && filterPanel.classList.contains('show')){
    const content = filterPanel.querySelector('.panel-content');
    const pinBtn = filterPanel.querySelector('.pin-panel');
    const pinned = pinBtn && pinBtn.getAttribute('aria-pressed')==='true';
    if(content && !content.contains(e.target) && !pinned){
      closePanel(filterPanel);
    }
  }
}

document.addEventListener('click', handleDocInteract);
document.addEventListener('pointerdown', (e) => {
  const target = e.target;
  requestAnimationFrame(() => handleDocInteract({ target }));
});

// Panels and admin/member interactions
(function(){
  const memberBtn = document.getElementById('memberBtn');
  const adminBtn = document.getElementById('adminBtn');
  const filterBtn = document.getElementById('filterBtn');
  const memberPanel = document.getElementById('memberPanel');
  const adminPanel = document.getElementById('adminPanel');
  const filterPanel = document.getElementById('filterPanel');

  if(memberBtn && memberPanel){
    memberBtn.addEventListener('click', ()=> togglePanel(memberPanel));
  }
  if(adminBtn && adminPanel){
    adminBtn.addEventListener('click', ()=> togglePanel(adminPanel));
  }
  filterBtn && filterBtn.addEventListener('click', ()=> togglePanel(filterPanel));
  document.querySelectorAll('.panel .close-panel').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const panel = btn.closest('.panel');
      requestClosePanel(panel);
    });
  });
  document.querySelectorAll('.panel .move-left').forEach(btn=>{
    btn.addEventListener('click', e=>{
      e.stopPropagation();
      const panel = btn.closest('.panel');
      movePanelToEdge(panel, 'left');
    });
  });
  document.querySelectorAll('.panel .move-right').forEach(btn=>{
    btn.addEventListener('click', e=>{
      e.stopPropagation();
      const panel = btn.closest('.panel');
      movePanelToEdge(panel, 'right');
    });
  });

  document.querySelectorAll('#filterPanel .pin-panel').forEach(btn=>{
    btn.addEventListener('click', e=>{
      e.stopPropagation();
      const pressed = btn.getAttribute('aria-pressed')==='true';
      btn.setAttribute('aria-pressed', pressed ? 'false' : 'true');
      if(typeof window.adjustBoards === 'function') setTimeout(()=> window.adjustBoards(), 0);
    });
  });

  document.querySelectorAll('.panel .panel-header').forEach(header=>{
    header.addEventListener('mousedown', e=>{
      if(e.target.closest('button')) return;
      const panel = header.closest('.panel');
      const content = panel ? panel.querySelector('.panel-content') : null;
      if(!content) return;
      bringToTop(panel);
      const rect = content.getBoundingClientRect();
      const startX = e.clientX;
      const startLeft = rect.left;
      const onMove = (ev)=>{
        const dx = ev.clientX - startX;
        let newLeft = startLeft + dx;
        const maxLeft = window.innerWidth - rect.width;
        if(newLeft < 0) newLeft = 0;
        if(newLeft > maxLeft) newLeft = maxLeft;
        content.style.left = `${newLeft}px`;
        content.style.right = 'auto';
      };
      const throttledMove = rafThrottle(onMove);
      function onUp(){
        document.removeEventListener('mousemove', throttledMove);
        document.removeEventListener('mouseup', onUp);
      }
      document.addEventListener('mousemove', throttledMove);
      document.addEventListener('mouseup', onUp);
    });
  });

    const welcomeModal = document.getElementById('welcome-modal');
    [memberPanel, adminPanel, welcomeModal].forEach(m=>{
      if(m && localStorage.getItem(`panel-open-${m.id}`) === 'true'){
        openPanel(m);
      }
    });
    if(welcomeModal && !localStorage.getItem('welcome-seen')){
      openWelcome();
      localStorage.setItem('welcome-seen','true');
    }
    const shouldOpenFilter = window.innerWidth >= 1300 && localStorage.getItem('panel-open-filterPanel') === 'true';
    if(filterPanel && shouldOpenFilter){
      openPanel(filterPanel);
    }
  document.querySelectorAll('.panel').forEach(panel=>{
    const content = panel.querySelector('.panel-content');
    if(content){
      const defaultWidth = panel.id === 'filterPanel' ? '380px' : '440px';
      content.style.width = defaultWidth;
      content.style.maxWidth = defaultWidth;
      content.style.top = 'calc(var(--header-h) + var(--safe-top))';
      content.style.bottom = 'var(--footer-h)';
      content.style.height = 'calc(100vh - var(--header-h) - var(--safe-top) - var(--footer-h))';
      content.style.maxHeight = 'calc(100vh - var(--header-h) - var(--safe-top) - var(--footer-h))';
    }
  });

  const adminTabs = document.querySelectorAll('#adminPanel .tab-bar button');
  const adminPanels = document.querySelectorAll('#adminPanel .tab-panel');
  adminTabs.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      adminTabs.forEach(b=>b.setAttribute('aria-selected','false'));
      adminPanels.forEach(p=>p.classList.remove('active'));
      btn.setAttribute('aria-selected','true');
      const panel = document.getElementById(`tab-${btn.dataset.tab}`);
      panel && panel.classList.add('active');
    });
  });

  const colorAreas = [
    {key:'header', label:'Header', selectors:{bg:['.header'], text:['.header']}},
    {key:'body', label:'Body', selectors:{bg:['body'], border:[], hoverBorder:[], activeBorder:[]}},
    {key:'list', label:'List', selectors:{bg:['.quick-list-board'], text:['.quick-list-board'], title:['.quick-list-board .recents-card .t','.quick-list-board .recents-card .title'], btn:['.quick-list-board button','.quick-list-board .sq','.quick-list-board .tiny','.quick-list-board .btn'], btnText:['.quick-list-board button','.quick-list-board .sq','.quick-list-board .tiny','.quick-list-board .btn'], card:['.quick-list-board .recents-card']}},
    {key:'post-board', label:'Closed Posts', selectors:{bg:['.post-board'], text:['.post-board','.post-board .posts'], title:['.post-board .post-card .t','.post-board .post-card .title','.post-board .open-post .t','.post-board .open-post .title'], btn:['.post-board button'], btnText:['.post-board button'], card:['.post-board .post-card','.post-board .open-post']}},
    {key:'open-post', label:'Open Posts', selectors:{text:['.open-post','.open-post .venue-info','.open-post .session-info'], title:['.open-post .t','.open-post .title'], btn:['.open-post button'], btnText:['.open-post button'], card:['.open-post'], header:['.open-post .post-header'], image:['.open-post .image-box'], menu:['.open-post .venue-menu button','.open-post .session-menu button']}},
    {key:'map', label:'Map', selectors:{popupBg:['.mapboxgl-popup.map-card .mapboxgl-popup-content','.mapboxgl-popup.map-card .map-card','.mapboxgl-popup.map-card .chip','.mapboxgl-popup.map-card .chip-small','.mapboxgl-popup.map-card .map-card-list-item'], popupText:['.mapboxgl-popup.map-card .map-card','.mapboxgl-popup.map-card .map-card-title','.mapboxgl-popup.map-card .map-card-venue','.mapboxgl-popup.map-card .chip','.mapboxgl-popup.map-card .chip-small','.mapboxgl-popup.map-card .map-card-list-item'], title:['.mapboxgl-popup.map-card .map-card-title','.mapboxgl-popup.map-card .chip .t','.mapboxgl-popup.map-card .chip .title','.mapboxgl-popup.map-card .chip-small .t','.mapboxgl-popup.map-card .chip-small .title']}},
    {key:'filter', label:'Filter Panel', selectors:{bg:['#filterPanel .panel-content'], text:['#filterPanel .panel-content'], title:['#filterPanel .panel-content .t','#filterPanel .panel-content .title'], btn:['#filterPanel button:not([class*="mapboxgl-"])','#filterPanel .sq','#filterPanel .tiny'], btnText:['#filterPanel button:not([class*="mapboxgl-"])','#filterPanel .sq','#filterPanel .tiny']}},
    {key:'calendar', label:'Calendar', selectors:{bg:['.calendar'], text:['.calendar .day'], weekday:['.calendar .weekday'], title:['.calendar .calendar-header'], header:['.calendar .calendar-header']}},
  {key:'adminPanel', label:'Admin Panel', selectors:{bg:['#adminPanel .panel-content'], text:['#adminPanel .panel-content'], title:['#adminPanel .panel-content .t','#adminPanel .panel-content .title'], btn:['#adminPanel button','#adminPanel #spinType span'], btnText:['#adminPanel button','#adminPanel #spinType span']}},
  {key:'welcome-modal', label:'Welcome Modal', selectors:{bg:['#welcome-modal .modal-content'], text:['#welcome-modal .modal-content'], title:['#welcome-modal .modal-content .t','#welcome-modal .modal-content .title'], btn:['#welcome-modal button:not([class*"mapboxgl-"])'], btnText:['#welcome-modal button:not([class*"mapboxgl-"])']}},
  {key:'memberPanel', label:'Member Panel', selectors:{bg:['#memberPanel .panel-content'], text:['#memberPanel .panel-content'], title:['#memberPanel .panel-content .t','#memberPanel .panel-content .title'], btn:['#memberPanel button'], btnText:['#memberPanel button']}},
  {key:'imagePanel', label:'Image Modal', selectors:{bg:['.image-modal-container'], text:['.image-modal-container .image-modal']}}
];

  function storeTitleDefaults(){
    colorAreas.forEach(area=>{
      (area.selectors.title||[]).forEach(sel=>{
        document.querySelectorAll(sel).forEach(el=>{
          const cs = getComputedStyle(el);
          el.dataset.titleDefaultColor = cs.color;
          el.dataset.titleDefaultFont = cs.fontFamily;
          el.dataset.titleDefaultSize = cs.fontSize;
          el.dataset.titleDefaultWeight = cs.fontWeight;
          el.dataset.titleDefaultShadow = cs.textShadow;
        });
      });
    });
    const varMap = {'today-c':'--today', 'sessionAvailable-c':'--session-available', 'sessionSelected-c':'--session-selected'};
    Object.entries(varMap).forEach(([id,varName])=>{
      const el = document.getElementById(id);
      if(el){
        const val = getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
        if(val) el.value = val;
      }
    });
  }

  function restoreTitleDefaults(area){
    (area.selectors.title||[]).forEach(sel=>{
      document.querySelectorAll(sel).forEach(el=>{
        if(el.dataset.titleDefaultColor) el.style.color = el.dataset.titleDefaultColor;
        if(el.dataset.titleDefaultFont) el.style.fontFamily = el.dataset.titleDefaultFont;
        if(el.dataset.titleDefaultSize) el.style.fontSize = el.dataset.titleDefaultSize;
        if(el.dataset.titleDefaultWeight) el.style.fontWeight = el.dataset.titleDefaultWeight;
        if(el.dataset.titleDefaultShadow) el.style.textShadow = el.dataset.titleDefaultShadow;
      });
    });
  }

  storeTitleDefaults();

  const headerEl = document.querySelector('.header');
  if(headerEl && 'ResizeObserver' in window){
    const headerObserver = new ResizeObserver(()=>{
      updateLayoutVars();
    });
    headerObserver.observe(headerEl);
  }

  window.addEventListener('resize', updateLayoutVars);
  window.addEventListener('resize', updateStickyImages);
  window.addEventListener('load', updateLayoutVars);
  updateLayoutVars();
  if (typeof updateStickyImages === 'function') {
    updateStickyImages();
  }
  if(typeof window.__wrapForInputYield === 'function'){
    ['openPost','updateVenue','togglePanel','ensureMapForVenue'].forEach(name => window.__wrapForInputYield(name));
  }
})();
</script>

<div class="image-modal-container hidden">
  <div class="image-modal"></div>
</div>

<div id="post-modal-container" class="hidden">
  <div class="post-modal"></div>
</div>

<script>
  (function(){
    const ns = 'http://www.w3.org/2000/svg';
    const SHAPES = {
      circle(){ const c=document.createElementNS(ns,'circle'); c.setAttribute('cx','0'); c.setAttribute('cy','0'); c.setAttribute('r','50'); return c; },
      tallEllipse(){ const e=document.createElementNS(ns,'ellipse'); e.setAttribute('cx','0'); e.setAttribute('cy','0'); e.setAttribute('rx','40'); e.setAttribute('ry','55'); return e; },
      heart(){ const p=document.createElementNS(ns,'path'); p.setAttribute('d','M0,-30 C-30,-70 -70,-20 -35,15 Q0,55 35,15 C70,-20 30,-70 0,-30Z'); return p; },
      star(){ const p=document.createElementNS(ns,'path'); p.setAttribute('d','M0,-55 L14,-17 L47,-17 L23,5 L35,45 L0,25 L-35,45 L-23,5 L-47,-17 L-14,-17 Z'); return p; },
      triangle(){ const p=document.createElementNS(ns,'path'); p.setAttribute('d','M0,55 L50,-45 L-50,-45 Z'); return p; },
      rectangle(){ const r=document.createElementNS(ns,'rect'); r.setAttribute('x','-35'); r.setAttribute('y','-55'); r.setAttribute('width','70'); r.setAttribute('height','110'); r.setAttribute('rx','20'); r.setAttribute('ry','20'); return r; },
      square(){ const r=document.createElementNS(ns,'rect'); r.setAttribute('x','-45'); r.setAttribute('y','-45'); r.setAttribute('width','90'); r.setAttribute('height','90'); r.setAttribute('rx','20'); r.setAttribute('ry','20'); return r; },
      diamond(){ const p=document.createElementNS(ns,'path'); p.setAttribute('d','M0,-55 L45,0 0,55 -45,0 Z'); return p; },
      pentagon(){ const p=document.createElementNS(ns,'path'); p.setAttribute('d','M0,-55 L52,-17 L32,45 -32,45 -52,-17 Z'); return p; },
      hexagon(){ const p=document.createElementNS(ns,'path'); p.setAttribute('d','M0,-55 L47,-27 L47,27 0,55 -47,27 -47,-27 Z'); return p; }
    };

    function hslToHex(h, s, l){
      s/=100; l/=100;
      const k = n => (n + h/30) % 12;
      const a = s * Math.min(l, 1-l);
      const f = n => l - a * Math.max(-1, Math.min(k(n)-3, Math.min(9-k(n),1)));
      return '#' + [f(0),f(8),f(4)].map(x=>Math.round(x*255).toString(16).padStart(2,'0')).join('');
    }
    const COLORS = Array.from({length:100}, (_,i)=>hslToHex(i*3.6,100,50));

    function createBalloon(shapeName, color, size){
      const svg = document.createElementNS(ns,'svg');
      svg.setAttribute('viewBox','-60 -80 120 160');
      svg.setAttribute('width', size);
      svg.setAttribute('height', size);
      svg.dataset.color = color;
      svg.setAttribute('title', size + 'px ' + color);
      const body = SHAPES[shapeName]();
      body.setAttribute('fill', color);
      body.setAttribute('stroke', '#000');
      body.setAttribute('stroke-width', '1');
      svg.appendChild(body);
      const tie = document.createElementNS(ns,'path');
      tie.setAttribute('d','M-8,55 L0,60 L8,55 Z');
      tie.setAttribute('fill','#000');
      tie.setAttribute('stroke','#000');
      tie.setAttribute('stroke-width','1');
      svg.appendChild(tie);
      const string = document.createElementNS(ns,'line');
      string.setAttribute('x1','0'); string.setAttribute('y1','60');
      string.setAttribute('x2','0'); string.setAttribute('y2','80');
      string.setAttribute('stroke','#fff');
      string.setAttribute('stroke-width','2');
      svg.appendChild(string);
      const gleam = document.createElementNS(ns,'ellipse');
      gleam.setAttribute('cx','-20'); gleam.setAttribute('cy','-20');
      gleam.setAttribute('rx','10'); gleam.setAttribute('ry','6');
      gleam.setAttribute('fill','#fff');
      svg.appendChild(gleam);
      return svg;
    }

    window.SHAPES = SHAPES;
    window.COLORS = COLORS;
    window.createBalloon = createBalloon;

    const buttons = document.getElementById('balloonShapeButtons');
    const shapeMenuBtn = document.getElementById('shapeMenuBtn');
    const grid = document.getElementById('balloonGrid');
    const sizeSlider = document.getElementById('balloonSize');
    const sizeValue = document.getElementById('balloonSizeValue');
    const svgCode = document.getElementById('balloonSvgCode');
    const copyBtn = document.getElementById('copySvgCode');
    let currentTemplate = '';

    sizeValue.textContent = sizeSlider.value;
    copyBtn.addEventListener('click', ()=>{ navigator.clipboard.writeText(svgCode.value); });

    if(shapeMenuBtn){
      shapeMenuBtn.addEventListener('click', ()=>{
        const expanded = shapeMenuBtn.getAttribute('aria-expanded') === 'true';
        shapeMenuBtn.setAttribute('aria-expanded', String(!expanded));
        buttons.hidden = expanded;
      });
      document.addEventListener('click', e=>{
        if(!shapeMenuBtn.contains(e.target) && !buttons.contains(e.target)){
          buttons.hidden = true;
          shapeMenuBtn.setAttribute('aria-expanded','false');
        }
      });
    }

    sizeSlider.addEventListener('input', ()=>{
      sizeValue.textContent = sizeSlider.value;
      renderFromSvg(currentTemplate);
    });

    function selectSvg(svg){
      grid.querySelectorAll('svg').forEach(s=>s.classList.remove('selected'));
      svg.classList.add('selected');
      svgCode.value = svg.outerHTML;
      currentTemplate = svg.outerHTML;
      if(document.hasFocus()){
        try{
          navigator.clipboard.writeText(svg.outerHTML);
        }catch(e){
          console.error('clipboard write failed', e);
        }
      }
    }

    function renderFromSvg(template){
      if(!template){ return; }
      grid.innerHTML='';
      COLORS.forEach(color=>{
        const colored = template.replace(/fill="(?!#fff)[^"]*"/g, `fill="${color}"`);
        const doc = new DOMParser().parseFromString(colored,'image/svg+xml');
        const svg = doc.documentElement;
        svg.setAttribute('width', sizeSlider.value);
        svg.setAttribute('height', sizeSlider.value);
        svg.dataset.color = color;
        svg.setAttribute('title', sizeSlider.value + 'px ' + color);
        svg.addEventListener('click', ()=> selectSvg(svg));
        grid.appendChild(svg);
      });
      const first = grid.querySelector('svg');
      if(first){
        first.classList.add('selected');
        svgCode.value = first.outerHTML;
        currentTemplate = first.outerHTML;
      }
    }

    function render(name){
      grid.innerHTML='';
      COLORS.forEach(color=>{
        const svg = createBalloon(name, color, sizeSlider.value);
        svg.addEventListener('click', ()=> selectSvg(svg));
        grid.appendChild(svg);
      });
      const first = grid.querySelector('svg');
      if(first){
        first.classList.add('selected');
        svgCode.value = first.outerHTML;
        currentTemplate = first.outerHTML;
      }
    }

    svgCode.addEventListener('input', ()=>{
      currentTemplate = svgCode.value;
      renderFromSvg(currentTemplate);
    });

    const LABELS = {
      circle:'circle',
      tallEllipse:'tall ellipse',
      heart:'heart',
      star:'soft star',
      triangle:'soft triangle',
      rectangle:'tall rectangle',
      square:'square',
      diamond:'diamond',
      pentagon:'pentagon',
      hexagon:'hexagon'
    };

    Object.keys(SHAPES).forEach((name,idx)=>{
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'shape-button';
      btn.appendChild(createBalloon(name, '#000', 24));
      btn.appendChild(document.createTextNode(LABELS[name] || name));
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('#map-balloon-container .shape-button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        render(name);
        if(shapeMenuBtn){
          shapeMenuBtn.textContent = LABELS[name] || name;
          shapeMenuBtn.setAttribute('aria-expanded','false');
          buttons.hidden = true;
        }
      });
      if(idx===0) btn.classList.add('active');
      buttons.appendChild(btn);
    });

    const firstShape = Object.keys(SHAPES)[0];
    render(firstShape);
    if(shapeMenuBtn){ shapeMenuBtn.textContent = LABELS[firstShape] || firstShape; }
  })();
</script>
<script>
(function(){
  const ICON_BASE = window.ICON_BASE || {};
  const subcategoryIcons = window.subcategoryIcons || (window.subcategoryIcons = {});
  const subcategoryMarkers = window.subcategoryMarkers || (window.subcategoryMarkers = {});
  const subcategoryMarkerIds = window.subcategoryMarkerIds || (window.subcategoryMarkerIds = {});
  const categoryShapes = window.categoryShapes || (window.categoryShapes = {});
  const shapeList = Object.keys(window.SHAPES || {});
  let colorIdx = 0;
  const cats = window.categories || [];
  cats.forEach((cat, idx) => {
    const shape = shapeList[idx % shapeList.length];
    categoryShapes[cat.name] = shape;
    cat.subs.forEach(sub => {
      const color = window.COLOR_NAMES[colorIdx % window.COLOR_NAMES.length];
      colorIdx++;
      const slug = slugify(sub);
      const iconPrefix = ICON_BASE[cat.name];
      const icon30 = `assets/icons-30/${iconPrefix}-${color}-30.webp`;
      subcategoryIcons[sub] = `<img src="${icon30}" width="30" height="30" alt="">`;
      subcategoryMarkerIds[sub] = slug;
      subcategoryMarkers[slug] = icon30;
    });
  });
  const specialSubIconPaths = {
    'Other Events': 'assets/icons-30/whats-on-category-icon-red-30.webp',
    'Other Opportunities': 'assets/icons-30/opportunities-category-icon-red-30.webp',
    'Other Learning': 'assets/icons-30/learning-category-icon-red-30.webp'
  };
  Object.entries(specialSubIconPaths).forEach(([name, markerPath]) => {
    subcategoryIcons[name] = `<img src="${markerPath}" width="30" height="30" alt="">`;
    const slug = subcategoryMarkerIds[name] || slugify(name);
    subcategoryMarkers[slug] = markerPath;
    subcategoryMarkers[name] = markerPath;
  });
  document.dispatchEvent(new CustomEvent('subcategory-icons-ready'));
  if(window.postsLoaded) addPostSource();
})();
</script>
<script>
(function(){
  const ICONS = {
    circle:'<svg viewBox="0 0 20 20"><circle cx="10" cy="10" r="8" fill="#000"/></svg>',
    square:'<svg viewBox="0 0 20 20"><rect x="2" y="2" width="16" height="16" fill="#000"/></svg>',
    triangle:'<svg viewBox="0 0 20 20"><polygon points="10,2 18,18 2,18" fill="#000"/></svg>'
  };
  const FIELD_TYPES = ['Text','Number','Date','Color'];
  function createIconSelect(){
    const s=document.createElement('select');
    Object.keys(ICONS).forEach(k=>{
      const o=document.createElement('option');
      o.value=k;
      o.innerHTML=ICONS[k];
      s.appendChild(o);
    });
    return s;
  }
  function createFieldSelect(){
    const s=document.createElement('select');
    FIELD_TYPES.forEach(t=>{
      const o=document.createElement('option');
      o.value=t.toLowerCase();
      o.textContent=t;
      s.appendChild(o);
    });
    return s;
  }
  function addSubcategory(table){
    const iconRow=table.querySelector('.icon-row');
    const nameRow=table.querySelector('.name-row');
    const iconCell=document.createElement('td'); iconCell.appendChild(createIconSelect()); iconRow.appendChild(iconCell);
    const nameCell=document.createElement('td'); const inp=document.createElement('input'); nameCell.appendChild(inp); nameRow.appendChild(nameCell);
    table.querySelectorAll('.field-row').forEach(row=>{
      const cell=document.createElement('td'); cell.appendChild(createFieldSelect()); row.appendChild(cell);
    });
  }
  function addFieldRow(table){
    const cols=table.querySelector('.icon-row').children.length;
    const row=document.createElement('tr'); row.className='field-row';
    for(let i=0;i<cols;i++){ const cell=document.createElement('td'); cell.appendChild(createFieldSelect()); row.appendChild(cell); }
    table.appendChild(row);
  }
  function wireCategory(cat){
    const table=cat.querySelector('table');
    cat.querySelector('.delete-category').addEventListener('click',()=>cat.remove());
    cat.querySelector('.copy-category').addEventListener('click',()=>{const clone=cat.cloneNode(true); wireCategory(clone); cat.after(clone);});
    cat.querySelector('.add-subcategory').addEventListener('click',()=>addSubcategory(table));
    cat.querySelector('.add-field').addEventListener('click',()=>addFieldRow(table));
  }
  function createCategory(){
    const cat=document.createElement('div'); cat.className='form-category';
    const header=document.createElement('div'); header.className='category-header';
    const name=document.createElement('input'); name.type='text'; name.placeholder='Category name';
    const icon=createIconSelect();
    const color=document.createElement('input'); color.type='color'; color.value='#000000';
    const copy=document.createElement('button'); copy.type='button'; copy.className='copy-category'; copy.textContent='Copy';
    const del=document.createElement('button'); del.type='button'; del.className='delete-category'; del.textContent='Delete';
    header.append(name,icon,color,copy,del);
    cat.appendChild(header);
    const table=document.createElement('table'); table.className='subcategory-table';
    const iconRow=document.createElement('tr'); iconRow.className='icon-row';
    const nameRow=document.createElement('tr'); nameRow.className='name-row';
    table.append(iconRow,nameRow);
    cat.appendChild(table);
    const addSub=document.createElement('button'); addSub.type='button'; addSub.className='add-subcategory'; addSub.textContent='Add Subcategory';
    const addField=document.createElement('button'); addField.type='button'; addField.className='add-field'; addField.textContent='Add Field';
    cat.append(addSub,addField);
    addSubcategory(table);
    addFieldRow(table);
    wireCategory(cat);
    return cat;
  }
  document.getElementById('addCategory').addEventListener('click',()=>{
    const cat=createCategory();
    document.getElementById('formsCategories').appendChild(cat);
  });
})();
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const editor = document.getElementById('welcomeMessageEditor');
  const hidden = document.getElementById('welcomeMessage');
  if(editor && hidden){
    const placeholder = editor.getAttribute('data-placeholder') || '';
    hidden.value = hidden.value || placeholder;
    editor.innerHTML = hidden.value;
    editor.addEventListener('input', () => hidden.value = editor.innerHTML);
document.querySelectorAll('.wysiwyg-toolbar button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.execCommand(btn.dataset.command, false, null);
        editor.focus();
      });
    });
  }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('#adminPanel input[type="checkbox"]').forEach(cb => {
    if (cb.closest('.switch')) return;
    const wrapper = document.createElement('label');
    wrapper.className = 'switch';
    cb.parentNode.insertBefore(wrapper, cb);
    wrapper.appendChild(cb);
    const slider = document.createElement('span');
    slider.className = 'slider';
    cb.after(slider);
  });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const colorInput = document.getElementById('postModeBgColor');
  const opacityInput = document.getElementById('postModeBgOpacity');
  const opacityVal = document.getElementById('postModeBgOpacityVal');
  const root = document.documentElement;
  const settings = JSON.parse(localStorage.getItem('admin-settings-current') || '{}');
  function hexToRgb(hex){
    const r = parseInt(hex.slice(1,3),16);
    const g = parseInt(hex.slice(3,5),16);
    const b = parseInt(hex.slice(5,7),16);
    return `${r},${g},${b}`;
  }

  function apply(){
    const color = colorInput.value || '#000000';
    const opacity = opacityInput.value;
    root.style.setProperty('--post-mode-bg-color', hexToRgb(color));
    root.style.setProperty('--post-mode-bg-opacity', opacity);
    opacityVal.textContent = Number(opacity).toFixed(2);
  }

  if(colorInput && opacityInput && opacityVal){
    colorInput.value = settings.postModeBgColor || '#000000';
    opacityInput.value = settings.postModeBgOpacity ?? 0;
    apply();
    const save = () => {
      settings.postModeBgColor = colorInput.value;
      settings.postModeBgOpacity = opacityInput.value;
      localStorage.setItem('admin-settings-current', JSON.stringify(settings));
    };
    colorInput.addEventListener('input', () => { apply(); save(); });
    opacityInput.addEventListener('input', () => { apply(); save(); });
    const prev = window.saveAdminChanges;
    window.saveAdminChanges = () => { save(); if(typeof prev === 'function') prev(); };
  }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const vp = document.getElementById('viewport');
  const updateViewport = () => {
    if (!vp) return;
    if (window.innerWidth < 650) {
      vp.setAttribute('content','width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no');
    } else {
      vp.setAttribute('content','width=device-width, initial-scale=1');
    }
  };
  updateViewport();
  window.addEventListener('resize', updateViewport);
  window.addEventListener('orientationchange', updateViewport);

  const fsBtn = document.getElementById('fullscreenBtn');
  if (fsBtn) {
    const docEl = document.documentElement;
    const canFS = docEl.requestFullscreen || docEl.webkitRequestFullscreen || docEl.mozRequestFullScreen || docEl.msRequestFullscreen;
    const enabled = document.fullscreenEnabled || document.webkitFullscreenEnabled || document.mozFullScreenEnabled || document.msFullscreenEnabled;
    if (!canFS || enabled === false) {
      fsBtn.style.display = 'none';
    } else {
      const getFull = () => document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;
      const updateFsState = () => {
        fsBtn.setAttribute('aria-pressed', getFull() ? 'true' : 'false');
      };
      updateFsState();
      ['fullscreenchange','webkitfullscreenchange','mozfullscreenchange','MSFullscreenChange'].forEach(evt => {
        document.addEventListener(evt, updateFsState);
      });
      fsBtn.addEventListener('click', () => {
        const isFull = getFull();
        if (!isFull) {
          const req = docEl.requestFullscreen || docEl.webkitRequestFullscreen || docEl.mozRequestFullScreen || docEl.msRequestFullscreen;
          if (req) {
            try {
              const result = req.call(docEl);
              if (result && typeof result.catch === 'function') result.catch(() => {});
            } catch (err) {
              updateFsState();
            }
          }
        } else {
          const exit = document.exitFullscreen || document.webkitExitFullscreen || document.mozCancelFullScreen || document.msExitFullscreen;
          if (exit) {
            try {
              const result = exit.call(document);
              if (result && typeof result.catch === 'function') result.catch(() => {});
            } catch (err) {
              updateFsState();
            }
          }
        }
      });
    }
  }

  if (window.innerWidth >= 650) return;

  const posts = document.querySelector('.post-board');
  if (!posts) return;

  let defaultSize = parseFloat(getComputedStyle(posts).fontSize);
  let startDist = null;
  let enlarged = false;

  function distance(t1, t2){
    return Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
  }

  posts.addEventListener('touchstart', e => {
    if (e.target.tagName === 'IMG') return;
    if (e.touches.length === 2) {
      startDist = distance(e.touches[0], e.touches[1]);
    }
  });

  posts.addEventListener('touchmove', e => {
    if (e.target.tagName === 'IMG') return;
    if (e.touches.length === 2 && startDist) {
      const scale = distance(e.touches[0], e.touches[1]) / startDist;
      if (!enlarged && scale > 1.2) {
        posts.style.fontSize = (defaultSize * 1.2) + 'px';
        enlarged = true;
      } else if (enlarged && scale < 0.8) {
        posts.style.fontSize = defaultSize + 'px';
        enlarged = false;
      }
      e.preventDefault();
    }
  }, { passive: false });

  posts.addEventListener('touchend', e => {
    if (e.touches.length < 2) startDist = null;
  });

  posts.querySelectorAll('img').forEach(img => {
    img.addEventListener('click', e => { e.stopPropagation(); openImageModal(img.src, {origin: img}); });
    img.addEventListener('touchstart', e => {
      if (e.touches.length === 2) {
        e.preventDefault();
        e.stopPropagation();
        openImageModal(img.src, {origin: img});
      }
    }, { passive: false });
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('input[type="color"]').forEach(el => {
    if(!el.value) el.value = '#000000';
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  document.addEventListener('wheel', e => {
    if(e.target.closest('.post-board, .panel-content, .options-menu, .calendar-scroll')){
      e.stopPropagation();
    }
  });
  const postsPanel = document.querySelector('.post-board');
  const postsBg = document.querySelector('.post-mode-background');
  if(postsPanel){
    postsPanel.addEventListener('click', e => {
      if(e.target === postsPanel || e.target.classList.contains('posts')){
        e.stopPropagation();
      }
    });
  }
  if(postsBg){
    postsBg.addEventListener('click', e => e.stopPropagation());
  }
});
</script>
<script>
let boardAdjustCleanup = null;

function ensureImageModalReady(){
  const container = document.querySelector('.image-modal-container');
  if(!container) return {container:null, modal:null};
  const modal = container.querySelector('.image-modal');
  if(!container._listenerAdded){
    container.addEventListener('click', e => {
      if(e.target === container){
        closeImageModal(container);
      }
    });
    container._listenerAdded = true;
  }
  if(modal && !modal._closeListenerAdded){
    modal.addEventListener('click', e => {
      if(!e.target.closest('img')){
        closeImageModal(container);
      }
    });
    modal._closeListenerAdded = true;
  }
  return {container, modal};
}

function closeImageModal(container){
  const target = container || ensureImageModalReady().container;
  if(!target) return;
  const modal = target.querySelector('.image-modal');
  if(modal) modal.innerHTML = '';
  target.classList.add('hidden');
  if(target.dataset){
    delete target.dataset.activeSrc;
    delete target.dataset.activeIndex;
  }
  target._imageModalState = null;
  target._imageModalImg = null;
}

function advanceImageModal(container, modal, step=1){
  if(!container || !modal) return;
  const state = container._imageModalState;
  if(!state || !Array.isArray(state.images) || state.images.length <= 1) return;
  const len = state.images.length;
  state.index = ((state.index + step) % len + len) % len;
  renderImageModalImage(container, modal);
}

function renderImageModalImage(container, modal){
  if(!container || !modal) return;
  const state = container._imageModalState;
  if(!state || !Array.isArray(state.images) || !state.images.length) return;
  let img = container._imageModalImg;
  if(!img || img.parentNode !== modal){
    modal.innerHTML = '';
    img = document.createElement('img');
    img.addEventListener('click', e => {
      e.stopPropagation();
      advanceImageModal(container, modal, 1);
    });
    container._imageModalImg = img;
    modal.appendChild(img);
  }
  const src = state.images[state.index];
  if(img.getAttribute('src') !== src){
    img.src = src;
  }
  if(container.dataset){
    container.dataset.activeSrc = src;
    container.dataset.activeIndex = String(state.index);
  }
}

function normalizeImageModalSrc(value){
  if(!value) return '';
  try {
    return new URL(value, window.location.href).href;
  } catch(err){
    return String(value);
  }
}

function resolveImageModalContext(config){
  const result = {images: [], index: 0, gallery: null};
  if(!config) return result;
  const src = typeof config.src === 'string' ? config.src : '';
  const providedImages = Array.isArray(config.images) ? config.images.filter(Boolean) : null;
  const originEl = config.origin instanceof Element ? config.origin : null;
  let galleryRoot = config.gallery instanceof Element ? config.gallery : null;
  const findGalleryFrom = el => {
    if(!el) return null;
    const fromImageBox = el.closest && el.closest('.image-box');
    if(fromImageBox) return fromImageBox;
    const postImages = el.closest && el.closest('.post-images');
    if(postImages){
      const box = postImages.querySelector('.image-box');
      if(box) return box;
    }
    const openPost = el.closest && el.closest('.open-post');
    if(openPost){
      const box = openPost.querySelector('.image-box');
      if(box) return box;
    }
    return null;
  };
  if(!galleryRoot && originEl){
    galleryRoot = findGalleryFrom(originEl);
  }
  let images = providedImages && providedImages.length ? providedImages.slice() : null;
  if((!images || !images.length) && galleryRoot){
    if(Array.isArray(galleryRoot._modalImages) && galleryRoot._modalImages.length){
      images = galleryRoot._modalImages.slice();
    } else if(galleryRoot.dataset && galleryRoot.dataset.modalImages){
      try {
        const parsed = JSON.parse(galleryRoot.dataset.modalImages);
        if(Array.isArray(parsed) && parsed.length){
          images = parsed.slice();
        }
      } catch(err){}
    }
  }
  if((!images || !images.length) && galleryRoot){
    const trackImgs = Array.from(galleryRoot.querySelectorAll('.image-track img'));
    if(trackImgs.length){
      images = trackImgs.map(im => (im.dataset && im.dataset.full) ? im.dataset.full : im.src);
    }
  }
  if(!images || !images.length){
    images = src ? [src] : [];
  }
  let index = null;
  if(typeof config.startIndex === 'number' && Number.isFinite(config.startIndex)){
    index = config.startIndex;
  } else if(typeof config.startIndex === 'string'){
    const parsedStart = parseInt(config.startIndex, 10);
    if(Number.isFinite(parsedStart)){
      index = parsedStart;
    }
  }
  const originImg = originEl && originEl.tagName === 'IMG' ? originEl : (originEl && originEl.querySelector ? originEl.querySelector('img') : null);
  if(index === null && originImg && originImg.dataset && originImg.dataset.index){
    const parsed = parseInt(originImg.dataset.index, 10);
    if(Number.isFinite(parsed)){
      index = parsed;
    }
  }
  if(index === null && galleryRoot && galleryRoot.dataset && galleryRoot.dataset.index){
    const parsed = parseInt(galleryRoot.dataset.index, 10);
    if(Number.isFinite(parsed)){
      index = parsed;
    }
  }
  if(index === null && src){
    const found = images.indexOf(src);
    if(found !== -1){
      index = found;
    } else {
      const normalizedSrc = normalizeImageModalSrc(src);
      for(let i=0;i<images.length;i++){
        if(normalizeImageModalSrc(images[i]) === normalizedSrc){
          index = i;
          break;
        }
      }
    }
  }
  if(index === null){
    index = 0;
  }
  index = Math.max(0, Math.min(index, images.length ? images.length - 1 : 0));
  result.images = images;
  result.index = index;
  result.gallery = galleryRoot;
  return result;
}

function openImageModal(srcOrConfig, options){
  const base = (typeof srcOrConfig === 'object' && srcOrConfig !== null && !Array.isArray(srcOrConfig))
    ? Object.assign({}, srcOrConfig)
    : {src: srcOrConfig};
  if(options && typeof options === 'object'){
    Object.assign(base, options);
  }
  if(typeof base.src !== 'string' || !base.src){
    return;
  }
  const {container, modal} = ensureImageModalReady();
  if(!container || !modal) return;
  document.querySelectorAll('.image-modal-container').forEach(other => {
    if(other !== container && !other.classList.contains('hidden')){
      closeImageModal(other);
    }
  });
  const context = resolveImageModalContext(base);
  if(!context.images.length) return;
  container._imageModalState = {
    images: context.images.slice(),
    index: context.index,
    gallery: context.gallery || null
  };
  renderImageModalImage(container, modal);
  container.classList.remove('hidden');
}

function initPostLayout(board){
  if(typeof boardAdjustCleanup === 'function'){
    boardAdjustCleanup();
    boardAdjustCleanup = null;
  }
  const scheduleMapResize = mapInstance => {
    if(!mapInstance) return;
    if(typeof mapInstance.resize === 'function'){
      requestAnimationFrame(()=>{
        try { mapInstance.resize(); } catch(err){}
      });
    }
  };
  if(!(board instanceof Element)){
    document.documentElement.style.removeProperty('--post-header-h');
    if(typeof window.adjustBoards === 'function') window.adjustBoards();
    return;
  }
  const openPost = board.querySelector('.open-post');
  if(!openPost){
    document.body.classList.remove('detail-open');
    document.body.classList.remove('hide-map-calendar');
    document.documentElement.style.removeProperty('--post-header-h');
    if(typeof window.adjustBoards === 'function') window.adjustBoards();
    return;
  }
  document.body.classList.add('detail-open');
  document.body.classList.remove('hide-map-calendar');
  const postBody = openPost.querySelector('.post-body');
  const secondCol = postBody ? postBody.querySelector('.second-post-column') : null;
  if(secondCol){
    secondCol.removeAttribute('hidden');
    secondCol.classList.remove('is-visible');
    if(secondCol.dataset) delete secondCol.dataset.openPostId;
  }
  const triggerDetailMapResize = target => {
    if(!target) return;
    const mapNode = target.querySelector ? target.querySelector('.post-map') : null;
    const ref = target._detailMap || (mapNode && mapNode._detailMap) || null;
    const mapInstance = ref && ref.map;
    if(mapInstance && typeof mapInstance.resize === 'function'){
      scheduleMapResize(mapInstance);
    }
  };
  triggerDetailMapResize(secondCol);
  const thumbRow = postBody ? postBody.querySelector('.thumbnail-row') : null;
  const selectedImageBox = postBody ? postBody.querySelector('.selected-image, .image-box') : null;
  ensureImageModalReady();
  if(thumbRow){
    thumbRow.scrollLeft = 0;
  }
  if(thumbRow && !thumbRow._imageModalListener){
    thumbRow.addEventListener('dblclick', e => {
      const img = e.target.closest('img');
      if(img){
        e.preventDefault();
        e.stopPropagation();
        openImageModal(img.src, {origin: img});
      }
    });
    thumbRow._imageModalListener = true;
  }
  if(selectedImageBox && !selectedImageBox._imageModalListener){
    selectedImageBox.addEventListener('click', evt => {
      const currentTarget = (evt && evt.currentTarget instanceof Element)
        ? evt.currentTarget
        : selectedImageBox;
      const clickedImageBox = (evt && evt.target instanceof Element)
        ? evt.target.closest('.image-box')
        : null;
      if(clickedImageBox){
        return;
      }
      const parseIndex = value => {
        if(typeof value === 'undefined') return null;
        const parsed = parseInt(value, 10);
        return Number.isFinite(parsed) ? parsed : null;
      };
      let galleryRoot = null;
      if(currentTarget instanceof Element){
        if(currentTarget.classList.contains('image-box')){
          galleryRoot = currentTarget;
        } else {
          const postImages = typeof currentTarget.closest === 'function'
            ? currentTarget.closest('.post-images')
            : null;
          const parent = currentTarget.parentElement;
          const host = postImages || parent;
          if(host instanceof Element){
            galleryRoot = host.querySelector('.image-box');
          }
        }
      }
      const activeImg = galleryRoot ? galleryRoot.querySelector('.image-track img.active') : null;
      let img = activeImg || (currentTarget instanceof Element ? currentTarget.querySelector('img') : null);
      if(!img && galleryRoot){
        img = galleryRoot.querySelector('img');
      }
      if(!(img instanceof Element)){
        return;
      }
      if(evt && typeof evt.preventDefault === 'function') evt.preventDefault();
      if(evt && typeof evt.stopPropagation === 'function') evt.stopPropagation();
      let startIndex = null;
      if(activeImg && activeImg.dataset){
        startIndex = parseIndex(activeImg.dataset.index);
      }
      if(startIndex === null && galleryRoot && galleryRoot.dataset){
        startIndex = parseIndex(galleryRoot.dataset.index);
      }
      if(startIndex === null && img.dataset){
        startIndex = parseIndex(img.dataset.index);
      }
      const options = {origin: img};
      if(galleryRoot){
        options.gallery = galleryRoot;
      }
      if(startIndex !== null){
        options.startIndex = startIndex;
      }
      const src = (img.dataset && img.dataset.full) ? img.dataset.full : img.src;
      openImageModal(src, options);
    });
    selectedImageBox._imageModalListener = true;
  }
  if(typeof updateStickyImages === 'function'){
    updateStickyImages();
  }
  const updateMetrics = () => {
    if(typeof updateStickyImages === 'function'){
      updateStickyImages();
    }
    if(openPost){
      const header = openPost.querySelector('.post-header');
      if(header){
        document.documentElement.style.setProperty('--post-header-h', header.offsetHeight + 'px');
      } else {
        document.documentElement.style.removeProperty('--post-header-h');
      }
    }
    triggerDetailMapResize(secondCol);
    if(typeof window.adjustBoards === 'function') window.adjustBoards();
  };
  updateMetrics();
  window.addEventListener('resize', updateMetrics);
  window.addEventListener('load', updateMetrics);
  boardAdjustCleanup = () => {
    window.removeEventListener('resize', updateMetrics);
    window.removeEventListener('load', updateMetrics);
  };
}

document.addEventListener('DOMContentLoaded', () => {
  initPostLayout(document.querySelector('.post-board'));
});
</script>

<script>
// Wait helpers if your app exposes callWhenDefined; otherwise poll.
(function(){
  function whenDefined(name, cb){
    if (window.callWhenDefined) return window.callWhenDefined(name, cb);
    const iv = setInterval(() => {
      if (typeof window[name] === 'function') { clearInterval(iv); cb(window[name]); }
    }, 20);
  }

  // Debounce/guard in-flight jobs by name
  const _inflight = new Map();
  function guardOnce(name, fn){
    return async function guarded(...args){
      if (_inflight.get(name)) return; // drop duplicates
      _inflight.set(name, true);
      try { return await fn.apply(this, args); }
      finally { _inflight.delete(name); }
    };
  }

  const factories = new Map([
    ['hookDetailActions', (orig) => {
      const wrapped = rafThrottle(function(...args){
        scheduleIdle(() => orig.apply(this, args));
      });
      return guardOnce('hookDetailActions', wrapped);
    }],
    ['ensureMapForVenue', (orig) => {
      let token = 0;
      return guardOnce('ensureMapForVenue', function(...args){
        const myToken = ++token;
        // Defer heavy create to idle; newest call wins.
        scheduleIdle(async () => {
          if (myToken !== token) return;
          try { await orig.apply(this, args); } catch(e) { /* swallow */ }
        }, 300);
      });
    }]
  ]);

  function applyWrapper(name){
    const factory = factories.get(name);
    if (!factory) return;
    whenDefined(name, (orig) => {
      if (typeof orig !== 'function' || orig.__inputWrapped) return;
      const wrapped = factory(orig);
      if (typeof wrapped === 'function'){
        wrapped.__inputWrapped = true;
        window[name] = wrapped;
      }
    });
  }

  ['hookDetailActions','ensureMapForVenue'].forEach(applyWrapper);

  window.__wrapForInputYield = function(name){
    applyWrapper(name);
  };
})();
</script>
</body>
</html>
